---
uid: mvc/overview/older-versions-1/controllers-and-routing/improving-performance-with-output-caching-vb
title: 出力キャッシュを使用したパフォーマンスの向上 (VB) |Microsoft Docs
author: microsoft
description: このチュートリアルでは、出力キャッシュを利用して、ASP.NET MVC web アプリケーションのパフォーマンスを大幅に向上させる方法について説明します。 あなたが。。。
ms.author: riande
ms.date: 01/27/2009
ms.assetid: 0e7b4d85-2c46-4eaf-b6a8-6cd566a67334
msc.legacyurl: /mvc/overview/older-versions-1/controllers-and-routing/improving-performance-with-output-caching-vb
msc.type: authoredcontent
ms.openlocfilehash: b713b56e149f196794b3223ba88e3b41bf3e34c4
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78486652"
---
# <a name="improving-performance-with-output-caching-vb"></a>出力キャッシュでパフォーマンスを改善する (VB)

[Microsoft](https://github.com/microsoft)

> このチュートリアルでは、出力キャッシュを利用して、ASP.NET MVC web アプリケーションのパフォーマンスを大幅に向上させる方法について説明します。 新しいユーザーがアクションを呼び出すたびに同じコンテンツを作成する必要がないように、コントローラーアクションから返された結果をキャッシュする方法について説明します。

このチュートリアルの目的は、出力キャッシュを利用して、ASP.NET MVC アプリケーションのパフォーマンスを大幅に向上させる方法について説明することです。 出力キャッシュを使用すると、コントローラーアクションによって返されるコンテンツをキャッシュできます。 これにより、同じコントローラーアクションが呼び出されるたびに、同じコンテンツを生成する必要がなくなります。

たとえば、ASP.NET MVC アプリケーションで、インデックスという名前のビューにデータベースレコードの一覧が表示されているとします。 通常は、ユーザーがインデックスビューを返すコントローラーアクションを呼び出すたびに、データベースクエリを実行してデータベースからデータベースレコードのセットを取得する必要があります。

一方、出力キャッシュを利用する場合は、ユーザーが同じコントローラーアクションを呼び出すたびに、データベースクエリを実行しないようにすることができます。 ビューは、コントローラーアクションから再生成されるのではなく、キャッシュから取得できます。 キャッシュを使用すると、サーバー上で冗長な作業を実行することを回避できます。

#### <a name="enabling-output-caching"></a>出力キャッシュの有効化

出力キャッシュを有効にするには、個々のコントローラーアクションまたはコントローラークラス全体に &lt;OutputCache&gt; 属性を追加します。 たとえば、リスト1のコントローラーは、Index () という名前のアクションを公開します。 Index () アクションの出力は10秒間キャッシュされます。

**リスト1– Controllers\HomeController.vb**

[!code-vb[Main](improving-performance-with-output-caching-vb/samples/sample1.vb)]

ASP.NET MVC のベータ版では、出力キャッシュは[http://www.MySite.com/](http://www.mysite.com/)のような URL に対しては機能しません。 代わりに、 [http://www.MySite.com/Home/Index](http://www.mysite.com/Home/Index)のような URL を入力する必要があります。

リスト1では、Index () アクションの出力が10秒間キャッシュされます。 必要に応じて、キャッシュ期間をかなり長く指定することもできます。 たとえば、1日のコントローラーアクションの出力をキャッシュする場合は、キャッシュ期間として86400秒 (60 秒 \* 60 分 \* 24 時間) を指定できます。

指定した時間だけコンテンツがキャッシュされる保証はありません。 メモリリソースが不足すると、キャッシュによってコンテンツが自動的に再起動されます。

リスト1のホームコントローラーは、一覧2のインデックスビューを返します。 このビューには特別なことはありません。 インデックスビューには、現在の時刻が表示されます (図1を参照)。

**リスト2– Views\Home\Index.aspx**

[!code-aspx[Main](improving-performance-with-output-caching-vb/samples/sample2.aspx)]

**図 1: キャッシュされたインデックスビュー**

![clip_image002](improving-performance-with-output-caching-vb/_static/image1.jpg)

ブラウザーのアドレスバーに URL/Home/Index を入力し、ブラウザーの [更新]/[再読み込み] ボタンを繰り返し押すことによって Index () アクションを複数回呼び出すと、インデックスビューで表示される時間が10秒間変更されません。 ビューがキャッシュされているため、同じ時刻が表示されます。

アプリケーションにアクセスするすべてのユーザーに対して同じビューがキャッシュされていることを理解しておくことが重要です。 Index () アクションを呼び出すすべてのユーザーは、同じキャッシュされたバージョンのインデックスビューを取得します。 これは、インデックスビューを提供するために web サーバーが実行する必要がある作業量が大幅に減少することを意味します。

リスト2のビューは、非常に単純な処理を実行しています。 ビューには、現在の時刻だけが表示されます。 ただし、データベースレコードのセットを表示するビューを簡単にキャッシュすることもできます。 その場合は、データベースレコードのセットをデータベースから取得する必要はありません。また、ビューを返すコントローラーアクションが呼び出されるたびにデータベースレコードを取得する必要もありません。 キャッシュを使用すると、web サーバーとデータベースサーバーの両方で実行する必要がある作業量を減らすことができます。

MVC ビューでは、ページ &lt;% @ OutputCache%&gt; ディレクティブは使用しないでください。 このディレクティブは Web フォームからは漏れるため、ASP.NET MVC アプリケーションでは使用しないでください。 

#### <a name="where-content-is-cached"></a>コンテンツがキャッシュされる場所

既定では、&lt;OutputCache&gt; 属性を使用すると、コンテンツは web サーバー、プロキシサーバー、および web ブラウザーの3つの場所にキャッシュされます。 &lt;OutputCache&gt; 属性の Location プロパティを変更することで、コンテンツがキャッシュされる場所を正確に制御できます。

Location プロパティは、次のいずれかの値に設定できます。

> ·いつ
> 
> ·Client
> 
> ·ダウンストリーム
> 
> ·Server
> 
> ·存在
> 
> ·ServerAndClient

既定では、Location プロパティの値は Any です。 ただし、ブラウザーだけでキャッシュすることも、サーバー上でのみキャッシュすることもできます。 たとえば、ユーザーごとにカスタマイズされた情報をキャッシュする場合は、サーバー上の情報をキャッシュしないようにします。 ユーザーごとに異なる情報を表示する場合は、クライアントにのみ情報をキャッシュする必要があります。

たとえば、リスト3のコントローラーは、現在のユーザー名を返す、GetName () という名前のアクションを公開します。 Jack が web サイトにログインし、GetName () アクションを呼び出す場合、アクションは文字列 "Hi Jack" を返します。 その後、Jill が web サイトにログインし、GetName () アクションを呼び出すと、文字列 "Hi Jack" も取得されます。 文字列は、すべてのユーザーに対して web サーバーにキャッシュされます。これにより、ジャックは最初にコントローラーアクションを呼び出します。

**リスト3–コントローラー (& a)**

[!code-vb[Main](improving-performance-with-output-caching-vb/samples/sample3.vb)]

場合によっては、リスト3のコントローラーが希望どおりに機能しないことがあります。 Jill に "Hi Jack" というメッセージは表示しません。

パーソナライズされたコンテンツをサーバーキャッシュにキャッシュしないようにしてください。 ただし、パフォーマンスを向上させるために、パーソナライズされたコンテンツをブラウザーキャッシュにキャッシュすることもできます。 ブラウザーにコンテンツをキャッシュし、ユーザーが同じコントローラー操作を複数回呼び出す場合は、サーバーではなくブラウザーキャッシュからコンテンツを取得できます。

リスト4の変更されたコントローラーは、GetName () アクションの出力をキャッシュします。 ただし、コンテンツは、サーバー上ではなく、ブラウザーにのみキャッシュされます。 このようにして、複数のユーザーが GetName () メソッドを呼び出すと、各ユーザーは別のユーザー名ではなく、自分のユーザー名を取得します。

**リスト4–コントローラー (& 3)**

[!code-vb[Main](improving-performance-with-output-caching-vb/samples/sample4.vb)]

リスト4の &lt;OutputCache&gt; 属性には、"OutputCacheLocation. Client" という値に設定された Location プロパティが含まれることに注意してください。 &lt;OutputCache&gt; 属性には、NoStore プロパティも含まれています。 NoStore プロパティは、キャッシュされたコンテンツの永続的なコピーを格納しないようにプロキシサーバーとブラウザーに通知するために使用されます。

#### <a name="varying-the-output-cache"></a>出力キャッシュの変更

場合によっては、同じコンテンツの異なるキャッシュバージョンが必要になることがあります。 たとえば、マスター/詳細ページを作成しているとします。 マスターページには、ムービータイトルの一覧が表示されます。 タイトルをクリックすると、選択したムービーの詳細が表示されます。

詳細ページをキャッシュすると、クリックした映画に関係なく、同じムービーの詳細が表示されます。 最初のユーザーが選択した最初のムービーは、今後のすべてのユーザーに表示されます。

この問題を解決するには、&lt;OutputCache&gt; 属性の VaryByParam プロパティを利用します。 このプロパティを使用すると、フォームパラメーターまたはクエリ文字列パラメーターが異なる場合に、同じコンテンツの異なるキャッシュバージョンを作成できます。

たとえば、リスト5のコントローラーは、Master () と Details () という名前の2つのアクションを公開します。 マスター () アクションは、映画のタイトルの一覧を返し、Details () アクションは、選択されたムービーの詳細を返します。

**リスト5– Controllers\MoviesController.vb**

[!code-vb[Main](improving-performance-with-output-caching-vb/samples/sample5.vb)]

Master () アクションには、"none" という値を持つ VaryByParam プロパティが含まれています。 Master () アクションが呼び出されると、同じキャッシュされたバージョンのマスタービューが返されます。 任意のフォームパラメーターまたはクエリ文字列パラメーターは無視されます (図2を参照)。

**図2–/Movies/Master ビュー**

![clip_image004](improving-performance-with-output-caching-vb/_static/image2.jpg)

**図3–/Movies/Details ビュー**

![clip_image006](improving-performance-with-output-caching-vb/_static/image3.jpg)

Details () アクションには、値 "Id" を持つ VaryByParam プロパティが含まれています。 Id パラメーターの異なる値がコントローラーアクションに渡されると、詳細ビューの異なるキャッシュバージョンが生成されます。

VaryByParam プロパティを使用すると、より多くのキャッシュが得られることを理解しておくことが重要です。 Id パラメーターの異なるバージョンごとに、異なるキャッシュバージョンの詳細ビューが作成されます。

VaryByParam プロパティを次の値に設定できます。

> \* = フォームまたはクエリ文字列パラメーターが変化するたびに、別のキャッシュされたバージョンを作成します。
> 
> none = 異なるキャッシュバージョンを作成することはできません。
> 
> パラメーターのセミコロンの一覧 = リスト内のいずれかの形式またはクエリ文字列パラメーターが異なる場合は、キャッシュされた複数のバージョンを作成します。

#### <a name="creating-a-cache-profile"></a>キャッシュプロファイルの作成

&lt;OutputCache&gt; 属性のプロパティを変更して出力キャッシュプロパティを構成する代わりに、web 構成 (web.config) ファイルでキャッシュプロファイルを作成することもできます。 Web 構成ファイルでキャッシュプロファイルを作成することには、いくつかの重要な利点があります。

まず、web 構成ファイルで出力キャッシュを構成することにより、コントローラーアクションがコンテンツを1か所にキャッシュする方法を制御できます。 キャッシュプロファイルを1つ作成し、そのプロファイルを複数のコントローラーまたはコントローラーアクションに適用することができます。

2つ目は、アプリケーションを再コンパイルせずに、web 構成ファイルを変更する方法です。 実稼働環境に既に配置されているアプリケーションのキャッシュを無効にする必要がある場合は、web 構成ファイルで定義されているキャッシュプロファイルを変更するだけで済みます。 Web 構成ファイルへの変更は自動的に検出され、適用されます。

たとえば、リスト6の &lt;キャッシュ&gt; web 構成セクションには、Cache1Hour という名前のキャッシュプロファイルが定義されています。 &lt;キャッシュ&gt; セクションは、web 構成ファイルの &lt;system.web&gt; セクション内になければなりません。

**リスト6– web.config のキャッシュセクション**

[!code-xml[Main](improving-performance-with-output-caching-vb/samples/sample6.xml)]

リスト7のコントローラーは、&lt;OutputCache&gt; 属性を使用してコントローラーアクションに Cache1Hour プロファイルを適用する方法を示しています。

**リスト7– Controllers\ProfileController.vb**

[!code-vb[Main](improving-performance-with-output-caching-vb/samples/sample7.vb)]

リスト7でコントローラーによって公開されている Index () アクションを呼び出すと、1時間は同じ時刻が返されます。

#### <a name="summary"></a>まとめ

出力キャッシュは、ASP.NET MVC アプリケーションのパフォーマンスを大幅に向上させる非常に簡単な方法を提供します。 このチュートリアルでは、&lt;OutputCache&gt; 属性を使用してコントローラーアクションの出力をキャッシュする方法を学習しました。 また、Duration や VaryByParam プロパティなどの &lt;OutputCache&gt; 属性のプロパティを変更して、コンテンツのキャッシュ方法を変更する方法についても学習しました。 最後に、web 構成ファイルでキャッシュプロファイルを定義する方法を学習しました。

> [!div class="step-by-step"]
> [前へ](understanding-action-filters-vb.md)
> [次へ](adding-dynamic-content-to-a-cached-page-vb.md)
