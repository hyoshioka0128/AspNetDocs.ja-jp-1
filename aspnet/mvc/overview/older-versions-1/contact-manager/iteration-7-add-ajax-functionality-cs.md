---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
title: 'イテレーション #7 – Ajax 機能を追加C#する () |Microsoft Docs'
author: microsoft
description: 7番目のイテレーションでは、Ajax のサポートを追加することによって、アプリケーションの応答性とパフォーマンスを向上させます。
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f1b0809e-8909-444e-b6bb-a5cd1dea3f72
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
msc.type: authoredcontent
ms.openlocfilehash: 7c8eb3d3688674dd2c220b4bd1b5982f2610d0eb
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78437734"
---
# <a name="iteration-7--add-ajax-functionality-c"></a>イテレーション #7 – Ajax 機能を追加C#する ()

[Microsoft](https://github.com/microsoft)

[コードのダウンロード](iteration-7-add-ajax-functionality-cs/_static/contactmanager_7_cs1.zip)

> 7番目のイテレーションでは、Ajax のサポートを追加することによって、アプリケーションの応答性とパフォーマンスを向上させます。

## <a name="building-a-contact-management-aspnet-mvc-application-c"></a>Contact Management ASP.NET MVC アプリケーションの構築 (C#)

この一連のチュートリアルでは、最初から最後まで、連絡先管理アプリケーション全体を作成します。 連絡先マネージャーアプリケーションを使用すると、連絡先情報 (名前、電話番号、電子メールアドレスなど) をユーザーの一覧に格納できます。

複数のイテレーションに対してアプリケーションをビルドします。 各イテレーションで、アプリケーションを段階的に改善します。 この複数のイテレーションアプローチの目的は、各変更の理由を理解できるようにすることです。

- イテレーション #1-アプリケーションを作成します。 最初のイテレーションでは、最も簡単な方法で Contact Manager を作成します。 基本的なデータベース操作 (作成、読み取り、更新、削除) のサポートを追加します。

- イテレーション #2-アプリケーションの外観を良くします。 このイテレーションでは、既定の ASP.NET MVC ビューマスターページとカスケードスタイルシートを変更することによって、アプリケーションの外観を改善します。

- イテレーション #3-フォーム検証を追加します。 3番目のイテレーションでは、基本的なフォーム検証を追加します。 必要なフォームフィールドを完了しないで、フォームを送信できないようにします。 また、電子メールアドレスと電話番号も検証します。

- イテレーション #4-アプリケーションの疎結合を実現します。 この4回目のイテレーションでは、複数のソフトウェア設計パターンを利用して、連絡先マネージャーアプリケーションを簡単に管理および変更できるようにします。 たとえば、リポジトリパターンと依存関係の注入パターンを使用するようにアプリケーションをリファクターします。

- イテレーション #5-単体テストを作成します。 5番目のイテレーションでは、単体テストを追加することによって、アプリケーションの保守と変更を容易にします。 データモデルクラスをモック化し、コントローラーと検証ロジックの単体テストをビルドします。

- イテレーション #6-テスト駆動型開発を使用します。 この6番目のイテレーションでは、最初に単体テストを記述し、単体テストに対してコードを記述することによって、アプリケーションに新しい機能を追加します。 このイテレーションでは、連絡先グループを追加します。

- イテレーション #7-Ajax 機能を追加します。 7番目のイテレーションでは、Ajax のサポートを追加することによって、アプリケーションの応答性とパフォーマンスを向上させます。

## <a name="this-iteration"></a>このイテレーション

Contact Manager アプリケーションのこのイテレーションでは、Ajax を使用するようにアプリケーションをリファクターします。 Ajax を利用することで、アプリケーションの応答性を高めることができます。 ページ内の特定の領域のみを更新する必要がある場合は、ページ全体を表示しないようにすることができます。

他のユーザーが新しい連絡先グループを選択するたびにページ全体を再表示する必要がないように、インデックスビューをリファクターします。 代わりに、連絡先グループをクリックしたときに、連絡先の一覧を更新し、残りの部分のみをそのままにします。

また、削除リンクの動作方法も変更します。 別の確認ページを表示する代わりに、JavaScript の確認ダイアログを表示します。 連絡先を削除することを確認すると、サーバーに対して HTTP DELETE 操作が実行され、連絡先レコードがデータベースから削除されます。

さらに、jQuery を利用して、アニメーション効果をインデックスビューに追加します。 連絡先の新しいリストがサーバーからフェッチされるときにアニメーションを表示します。

最後に、ブラウザーの履歴を管理するための ASP.NET AJAX framework サポートを利用します。 連絡先リストを更新するために Ajax 呼び出しを実行するたびに、履歴ポイントを作成します。 これにより、ブラウザーの [戻る] ボタンと [進む] ボタンが機能します。

## <a name="why-use-ajax"></a>Ajax を使用する理由

Ajax の使用には多くの利点があります。 まず、Ajax 機能をアプリケーションに追加すると、ユーザーエクスペリエンスが向上します。 通常の web アプリケーションでは、ユーザーが操作を実行するたびに、ページ全体がサーバーにポストバックされる必要があります。 操作を実行するたびにブラウザーがロックされ、ユーザーはページ全体がフェッチされて再表示されるまで待機する必要があります。

これは、デスクトップアプリケーションの場合、許容できないエクスペリエンスです。 しかし、これまでは、web アプリケーションの場合にこのような不適切なユーザーエクスペリエンスを実現することができました。 私たちは web アプリケーションの制限であると考えましたが、実際には、私たちの夢見るの制限だけでした。

Ajax アプリケーションでは、ページを更新するだけで、ユーザーエクスペリエンスを停止させる必要はありません。 代わりに、バックグラウンドで非同期要求を実行してページを更新できます。 ページの一部が更新されるまで、ユーザーによる待機を強制しません。

Ajax を利用することで、アプリケーションのパフォーマンスを向上させることもできます。 ここでは、Ajax 機能を使用せずに Contact Manager アプリケーションがどのように機能するかを検討します。 連絡先グループをクリックすると、インデックスビュー全体を再表示する必要があります。 連絡先と連絡先グループの一覧は、データベースサーバーから取得する必要があります。 このデータはすべて、web サーバーから web ブラウザーにネットワーク経由で渡す必要があります。

ただし、Ajax 機能をアプリケーションに追加した後は、ユーザーが連絡先グループをクリックしたときにページ全体が再登録されないようにすることができます。 データベースから連絡先グループを取得する必要がなくなりました。 また、ネットワーク経由でインデックスビュー全体をプッシュする必要もありません。 Ajax を利用することで、データベースサーバーが実行する必要がある作業量を削減し、アプリケーションに必要なネットワークトラフィックの量を減らすことができます。

## <a name="don-t-be-afraid-of-ajax"></a>Ajax を使用しない

一部の開発者は、下位レベルのブラウザーについて心配するため、Ajax の使用を避けます。 これらのユーザーは、JavaScript をサポートしていないブラウザーによってアクセスされても、web アプリケーションが引き続き動作することを確認します。 Ajax は JavaScript に依存しているため、一部の開発者は Ajax の使用を避けます。

ただし、Ajax を実装する方法を慎重に検討している場合は、上位レベルとダウンレベルの両方のブラウザーで動作するアプリケーションを作成できます。 Contact Manager アプリケーションは、JavaScript をサポートするブラウザーと、そうでないブラウザーで動作します。

JavaScript をサポートするブラウザーで Contact Manager アプリケーションを使用すると、より優れたユーザーエクスペリエンスが得られます。 たとえば、連絡先グループをクリックすると、連絡先を表示するページの領域だけが更新されます。

一方、JavaScript をサポートしていない (または JavaScript が無効になっている) ブラウザーで Contact Manager アプリケーションを使用する場合は、ユーザーエクスペリエンスが若干低下します。 たとえば、連絡先グループをクリックすると、一致する連絡先の一覧を表示するために、インデックスビュー全体がブラウザーにポストバックされる必要があります。

## <a name="adding-the-required-javascript-files"></a>必要な JavaScript ファイルの追加

Ajax 機能をアプリケーションに追加するには、3つの JavaScript ファイルを使用する必要があります。 これら3つのファイルはすべて、新しい ASP.NET MVC アプリケーションの Scripts フォルダーに含まれています。

アプリケーションの複数のページで Ajax を使用する場合は、必要な JavaScript ファイルをアプリケーションのビューマスターページに含めることが理にかなっています。 そうすることで、JavaScript ファイルがアプリケーションのすべてのページに自動的に含まれるようになります。

ビューマスターページの &lt;head&gt; タグ内に次の JavaScript インクルードを追加します。

[!code-html[Main](iteration-7-add-ajax-functionality-cs/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Ajax を使用するためのインデックスビューのリファクタリング

まず、連絡先グループをクリックすると、連絡先を表示するビューの領域のみが更新されるように、インデックスビューを変更します。 図1の赤いボックスには、更新するリージョンが含まれています。

[連絡先のみを更新 ![](iteration-7-add-ajax-functionality-cs/_static/image1.jpg)](iteration-7-add-ajax-functionality-cs/_static/image1.png)

**図 01**: 連絡先のみを更新[する (クリックすると、フルサイズの画像が表示](iteration-7-add-ajax-functionality-cs/_static/image2.png)される)

最初の手順では、ビューの部分を、非同期的に更新する部分を別の部分 (ビューユーザーコントロール) に分割します。 連絡先のテーブルを表示するインデックスビューのセクションが、リスト1の部分に移動されました。

**リスト 1-Views\Contact\ContactList.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample2.aspx)]

リスト1の部分には、インデックスビューとは異なるモデルがあることに注意してください。 &lt;% @ Page%&gt; ディレクティブの*Inherits*属性は、この部分が viewusercontrol&lt;Group&gt; クラスから継承することを指定します。

更新されたインデックスビューは、リスト2に含まれています。

**リスト 2-Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample3.aspx)]

リスト2の更新されたビューについては、2つの点に注意する必要があります。 まず、部分的に移動されたすべてのコンテンツが、Html. RenderPartial () の呼び出しに置き換えられることに注意してください。 最初に連絡先のセットを表示するために、インデックスビューが最初に要求されたときに、Html の RenderPartial () メソッドが呼び出されます。

次に、連絡先グループの表示に使用される Html.actionlink () が Html.actionlink () に置き換えられていることに注意してください。 Html.actionlink () は、次のパラメーターを使用して呼び出されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample4.aspx)]

最初のパラメーターは、リンクに表示するテキストを表し、2番目のパラメーターはルート値を表し、3番目のパラメーターは Ajax オプションを表します。 この場合、UpdateTargetId Ajax オプションを使用して、Ajax 要求の完了後に更新する HTML &lt;div&gt; タグをポイントします。 &lt;div&gt; タグを新しい連絡先の一覧で更新します。

連絡先コントローラーの更新された Index () メソッドは、リスト3に含まれています。

**リスト 3-コントローラーの一覧表示 (Index メソッド)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample5.cs)]

更新された Index () アクションは、条件に応じて次の2つのいずれかを返します。 Index () アクションが Ajax 要求によって呼び出された場合、コントローラーは部分的なを返します。 それ以外の場合、Index () アクションはビュー全体を返します。

Ajax 要求によって呼び出されたときに、Index () アクションがデータを返す必要がないことに注意してください。 通常の要求のコンテキストでは、Index アクションは、すべての連絡先グループと選択された連絡先グループの一覧を返します。 Ajax 要求のコンテキストでは、Index () アクションは選択されたグループのみを返します。 Ajax は、データベースサーバーでの作業量が少ないことを意味します。

変更したインデックスビューは、上位レベルと下位レベルの両方のブラウザーの場合に機能します。 連絡先グループをクリックすると、ブラウザーが JavaScript をサポートしている場合は、連絡先の一覧を含むビューの領域だけが更新されます。 一方、ブラウザーが JavaScript をサポートしていない場合は、ビュー全体が更新されます。

更新されたインデックスビューには1つの問題があります。 連絡先グループをクリックしても、選択したグループは強調表示されません。 グループの一覧は Ajax 要求中に更新された領域の外側に表示されるため、適切なグループは強調表示されません。 この問題は、次のセクションで修正します。

## <a name="adding-jquery-animation-effects"></a>JQuery アニメーション効果の追加

通常、web ページ内のリンクをクリックすると、ブラウザーの進行状況バーを使用して、ブラウザーが更新されたコンテンツをアクティブにフェッチしているかどうかを検出できます。 一方、Ajax 要求を実行すると、ブラウザーの進行状況バーには進行状況が表示されません。 これにより、ユーザーの不安を実現できます。 ブラウザーがフリーズしているかどうかを確認するにはどうすればよいですか。

Ajax 要求の実行中に作業を実行することをユーザーに示すには、いくつかの方法があります。 1つの方法は、単純なアニメーションを表示することです。 たとえば、Ajax 要求が開始されたときに領域をフェードアウトし、要求が完了したときに領域をフェードさせることができます。

Microsoft ASP.NET MVC フレームワークに含まれている jQuery ライブラリを使用して、アニメーション効果を作成します。 更新されたインデックスビューは、リスト4に含まれています。

**リスト 4-Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample6.aspx)]

更新されたインデックスビューには、3つの新しい JavaScript 関数が含まれていることに注意してください。 最初の2つの関数は、jQuery を使用して、新しい連絡先グループをクリックしたときに連絡先の一覧をフェードアウトし、フェードアウトします。 3番目の関数は、Ajax 要求によってエラー (ネットワークのタイムアウトなど) が発生した場合にエラーメッセージを表示します。

最初の関数は、選択したグループの強調表示も行います。 クリックされた要素の親要素 (LI 要素) に class = selected 属性が追加されます。 ここでも、jQuery を使用すると、適切な要素を選択し、CSS クラスを追加することが簡単になります。

これらのスクリプトは、Html.actionlink () AjaxOptions パラメーターを使用してグループリンクに関連付けられています。 更新された Html.actionlink () メソッドの呼び出しは次のようになります。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>ブラウザー履歴サポートの追加

通常、リンクをクリックしてページを更新すると、ブラウザーの履歴が更新されます。 このようにして、ブラウザーの [戻る] ボタンをクリックすると、ページの前の状態に戻ることができます。 たとえば、[友人の連絡先] グループをクリックし、[ビジネス連絡先] グループをクリックした場合、[戻る] ボタンをクリックすると、[友人の連絡先] グループが選択されたときにページの状態に戻ることができます。

残念ながら Ajax 要求を実行しても、ブラウザーの履歴は自動的に更新されません。 連絡先グループをクリックしたときに、一致する連絡先の一覧が Ajax 要求で取得された場合、ブラウザーの履歴は更新されません。 新しい連絡先グループを選択した後、[ブラウザーの戻る] ボタンを使用して連絡先グループに戻ることはできません。

Ajax 要求の実行後に、ユーザーがブラウザーの [戻る] ボタンを使用できるようにするには、もう少し作業を行う必要があります。 ASP.NET AJAX フレームワークに組み込まれているブラウザーの履歴管理機能を活用する必要があります。

ASP.NET AJAX ブラウザーの履歴を作成するには、次の3つの操作を行う必要があります。

1. ブラウザーの履歴を有効にするには、enableBrowserHistory プロパティを true に設定します。
2. Addhistory Point () メソッドを呼び出して、ビューの状態が変更されたときに、履歴ポイントを保存します。
3. Navigate イベントが発生したときにビューの状態を再構築します。

更新されたインデックスビューは、リスト5に含まれています。

**リスト 5-Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample8.aspx)]

リスト5では、pageInit () 関数でブラウザーの履歴が有効になっています。 PageInit () 関数は、navigate イベントのイベントハンドラーを設定するためにも使用されます。 Navigate イベントは、ブラウザーの [進む] ボタンまたは [戻る] ボタンによってページの状態が変更されるたびに発生します。

BeginContactList () メソッドは、連絡先グループをクリックしたときに呼び出されます。 このメソッドは、Addhistory Point () メソッドを呼び出すことによって、新しい履歴ポイントを作成します。 クリックすると、連絡先グループの id が履歴に追加されます。

グループ id は、[連絡先グループ] リンクの expando 属性から取得されます。 次の Html.actionlink () の呼び出しでリンクが表示されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample9.aspx)]

Html.actionlink () に渡される最後のパラメーターでは、groupid という名前の expando 属性がリンクに追加されます (XHTML 互換の場合は小文字)。

ユーザーがブラウザーの [戻る] ボタンまたは [進む] ボタンにヒットすると、navigate イベントが発生し、navigate () メソッドが呼び出されます。 このメソッドは、ナビゲーションメソッドに渡されたブラウザーの履歴ポイントに対応するページの状態に合わせて、ページに表示される連絡先を更新します。

## <a name="performing-ajax-deletes"></a>Ajax 削除の実行

現在、連絡先を削除するには、[削除] リンクをクリックし、[削除の確認] ページに表示される削除ボタンをクリックする必要があります (図2を参照)。 これは、データベースレコードを削除するなど、簡単な処理を行うためのページ要求が多数あるように見えます。

[[削除の確認] ページ ![](iteration-7-add-ajax-functionality-cs/_static/image2.jpg)](iteration-7-add-ajax-functionality-cs/_static/image3.png)

**図 02**: 削除の確認ページ ([クリックすると、フルサイズの画像が表示](iteration-7-add-ajax-functionality-cs/_static/image4.png)されます)

削除の確認ページをスキップし、インデックスビューから直接連絡先を削除することをお勧めします。 この方法を採用すると、アプリケーションがセキュリティホールになるため、このようなことは避けてください。 一般に、web アプリケーションの状態を変更するアクションを呼び出すときに HTTP GET 操作を実行することは避けたいと思います。 削除を実行するときに、http の削除操作を実行することをお勧めします。

Delete リンクは ContactList 部分に含まれています。 ContactList 部分の更新バージョンは、リスト6に含まれています。

**リスト 6-Views\Contact\ContactList.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample10.aspx)]

Delete リンクは、ImageActionLink () メソッドの次の呼び出しで表示されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample11.aspx)]

> [!NOTE] 
> 
> ImageActionLink () は、ASP.NET MVC フレームワークの標準の一部ではありません。 ImageActionLink () は、Contact Manager プロジェクトに含まれるカスタムヘルパーメソッドです。

AjaxOptions パラメーターには、2つのプロパティがあります。 まず、Confirm プロパティを使用して、ポップアップ JavaScript 確認ダイアログを表示します。 次に、HttpMethod プロパティを使用して、HTTP 削除操作を実行します。

リスト7には、Contact コントローラーに追加された新しい AjaxDelete () アクションが含まれています。

**リスト 7-コントローラーの一覧 (AjaxDelete)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample12.cs)]

AjaxDelete () アクションは、AcceptVerbs 属性で修飾されています。 この属性は、HTTP 削除操作以外の HTTP 操作を除き、アクションが呼び出されないようにします。 特に、HTTP GET を使用してこのアクションを呼び出すことはできません。

データベースレコードを削除した後、削除されたレコードを含まない連絡先の更新された一覧を表示する必要があります。 AjaxDelete () メソッドは、ContactList の部分と更新された連絡先の一覧を返します。

## <a name="summary"></a>まとめ

このイテレーションでは、Contact Manager アプリケーションに Ajax 機能を追加しました。 Ajax を使用して、アプリケーションの応答性とパフォーマンスを向上させています。

まず、連絡先グループをクリックしてもビュー全体が更新されないように、インデックスビューをリファクタリングしています。 代わりに、連絡先グループをクリックすると、連絡先の一覧のみが更新されます。

次に、jQuery アニメーション効果を使用して、連絡先の一覧をフェードアウトし、フェードアウトします。 Ajax アプリケーションにアニメーションを追加すると、ブラウザーの進行状況バーと同等のアプリケーションをユーザーに提供できます。

また、Ajax アプリケーションにブラウザー履歴のサポートを追加しました。 ユーザーがブラウザーの [戻る] ボタンと [進む] ボタンをクリックして、インデックスビューの状態を変更できるようにしました。

最後に、HTTP 削除操作をサポートする削除リンクを作成しました。 Ajax の削除を実行することで、ユーザーが追加の削除確認ページを要求することなく、データベースレコードを削除できるようになります。

> [!div class="step-by-step"]
> [前へ](iteration-6-use-test-driven-development-cs.md)
> [次へ](iteration-1-create-the-application-vb.md)
