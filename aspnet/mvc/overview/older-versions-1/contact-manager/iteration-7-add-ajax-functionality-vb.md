---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-vb
title: 'イテレーション #7 – Ajax 機能の追加 (VB) |マイクロソフトドキュメント'
author: rick-anderson
description: 7 回目のイテレーションでは、Ajax のサポートを追加することで、アプリケーションの応答性とパフォーマンスを向上させます。
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f640e063-150e-453d-8cfc-7e54a6ce0f1e
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-vb
msc.type: authoredcontent
ms.openlocfilehash: 04eaaa129a56b765c090e64118ed528c65987b50
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2020
ms.locfileid: "81542301"
---
# <a name="iteration-7--add-ajax-functionality-vb"></a>繰り返し #7 – Ajax 機能を追加する (VB)

[マイクロソフト](https://github.com/microsoft)

[コードをダウンロード](iteration-7-add-ajax-functionality-vb/_static/contactmanager_7_vb1.zip)

> 7 回目のイテレーションでは、Ajax のサポートを追加することで、アプリケーションの応答性とパフォーマンスを向上させます。

## <a name="building-a-contact-management-aspnet-mvc-application-vb"></a>MVC アプリケーション (VB) ASP.NET連絡先管理の構築

この一連のチュートリアルでは、最初から最後まで連絡先管理アプリケーション全体を構築します。 連絡先マネージャー アプリケーションでは、連絡先の情報 (名前、電話番号、電子メール アドレス) を保存できます。

複数のイテレーションでアプリケーションをビルドします。 各反復処理で、アプリケーションを徐々に改善します。 この複数の反復アプローチの目的は、各変更の理由を理解できるようにすることです。

- イテレーション #1 - アプリケーションを作成します。 最初のイテレーションでは、できるだけ簡単な方法で連絡先マネージャーを作成します。 基本的なデータベース操作のサポートを追加: 作成、読み取り、更新、および削除 (CRUD) 。

- イテレーション #2 - アプリケーションを見栄えよくします。 このイテレーションでは、既定の ASP.NET MVC ビュー マスター ページとカスケード スタイル シートを変更することで、アプリケーションの外観を向上させます。

- イテレーション #3 - フォームの検証を追加します。 3 回目のイテレーションでは、基本的なフォーム検証を追加します。 必須のフォームフィールドに入力せずにフォームを送信できないようにします。 また、メールアドレスと電話番号も検証します。

- イテレーション #4 - アプリケーションを疎結合にします。 この 4 回目のイテレーションでは、いくつかのソフトウェア設計パターンを利用して、Contact Manager アプリケーションの保守と変更を容易にします。 たとえば、リポジトリ パターンと依存関係の挿入パターンを使用するようにアプリケーションをリファクタリングします。

- イテレーション #5 - 単体テストを作成します。 5 回目のイテレーションでは、単体テストを追加することで、アプリケーションの保守と変更を容易にします。 データ モデル クラスをモックし、コントローラーと検証ロジックの単体テストをビルドします。

- イテレーション #6 - テスト駆動型開発を使用します。 この 6 回目のイテレーションでは、単体テストを最初に記述し、単体テストに対してコードを記述することで、アプリケーションに新しい機能を追加します。 このイテレーションでは、連絡先グループを追加します。

- イテレーション #7 - Ajax 機能を追加します。 7 回目のイテレーションでは、Ajax のサポートを追加することで、アプリケーションの応答性とパフォーマンスを向上させます。

## <a name="this-iteration"></a>このイテレーション

連絡先マネージャー アプリケーションのこのイテレーションでは、Ajax を使用するためにアプリケーションをリファクタリングします。 Ajaxを利用することで、アプリケーションの応答性を高めます。 ページ内の特定の領域だけを更新する必要がある場合は、ページ全体のレンダリングを回避できます。

インデックス ビューをリファクタリングして、新しい連絡先グループを選択したときにページ全体を再表示する必要がないようにします。 代わりに、連絡先グループをクリックすると、連絡先の一覧が更新され、ページの残りの部分はそのままにしておきます。

また、削除リンクの動作方法も変更します。 別の確認ページを表示する代わりに、JavaScript の確認ダイアログが表示されます。 連絡先を削除することを確認した場合は、サーバーに対して HTTP DELETE 操作を実行して、データベースから連絡先レコードを削除します。

さらに、jQuery を利用して、インデックスビューにアニメーション効果を追加します。 新しい連絡先リストがサーバーから取得されるときにアニメーションを表示します。

最後に、ブラウザ履歴を管理するためのAJAXフレームワークのサポートASP.NETを活用します。 連絡先リストを更新する Ajax 呼び出しを実行するたびに、履歴ポイントを作成します。 これにより、ブラウザの後方および前方のボタンが機能します。

## <a name="why-use-ajax"></a>なぜアヤックスを使うのですか?

Ajax を使用すると、多くの利点があります。 まず、アプリケーションに Ajax 機能を追加すると、ユーザー エクスペリエンスが向上します。 通常の Web アプリケーションでは、ユーザーが操作を実行するたびに、ページ全体をサーバーにポストバックする必要があります。 アクションを実行するたびに、ブラウザはロックされ、ユーザーはページ全体がフェッチされて再表示されるまで待たなければなりません。

これは、デスクトップ アプリケーションの場合は、許容できないエクスペリエンスになります。 しかし、従来は、Webアプリケーションの場合、これ以上うまくやれるということは分からなかったので、この悪いユーザーエクスペリエンスを持っていました。 実際には、それは私たちの想像力の限界に過ぎないとき、それはWebアプリケーションの限界だと思っていました。

Ajax アプリケーションでは、ページを更新するためだけにユーザー エクスペリエンスを停止させる必要はありません。 代わりに、バックグラウンドで非同期要求を実行してページを更新できます。 ページの一部が更新されるまで、ユーザーに待機を強制しません。

Ajax を利用することで、アプリケーションのパフォーマンスを向上させることができます。 Ajax 機能を使用せずに、コンタクトマネージャーアプリケーションの動作を今すぐ検討してください。 連絡先グループをクリックすると、インデックス ビュー全体が再表示される必要があります。 連絡先の一覧と連絡先グループの一覧は、データベース サーバーから取得する必要があります。 このデータはすべて、Web サーバーから Web ブラウザーにネットワーク経由で渡す必要があります。

ただし、アプリケーションに Ajax 機能を追加した後、ユーザーが連絡先グループをクリックしたときにページ全体を再表示することを回避できます。 データベースから連絡先グループを取得する必要がなくなりました。 また、インデックスビュー全体をネットワーク全体にプッシュする必要はありません。 Ajaxを利用することで、データベースサーバが実行しなければならない作業量を削減し、アプリケーションに必要なネットワークトラフィックの量を削減します。

## <a name="don-t-be-afraid-of-ajax"></a>アヤックスを恐れてはいけない

開発者の中には、下位レベルのブラウザを心配するため、Ajax を使用しない開発者もいます。 JavaScript をサポートしていないブラウザからアクセスしても、Web アプリケーションが動作することを確認したいと考えています。 Ajax は JavaScript に依存しているため、一部の開発者は Ajax の使用を避けます。

ただし、Ajax の実装方法に注意を払えば、上位レベルと下位レベルの両方のブラウザで動作するアプリケーションを構築できます。 当社のコンタクトマネージャアプリケーションは、JavaScriptをサポートするブラウザとサポートしていないブラウザで動作します。

JavaScript をサポートするブラウザーで連絡先マネージャー アプリケーションを使用すると、より良いユーザー エクスペリエンスが得られます。 たとえば、連絡先グループをクリックすると、連絡先を表示するページの領域のみが更新されます。

一方、JavaScript をサポートしていない (または JavaScript が無効になっている) ブラウザーで連絡先マネージャー アプリケーションを使用する場合は、ユーザー エクスペリエンスが少し望ましくないことがあります。 たとえば、連絡先グループをクリックすると、連絡先の一致する一覧を表示するために、インデックス ビュー全体をブラウザにポストバックする必要があります。

## <a name="adding-the-required-javascript-files"></a>必要な JavaScript ファイルの追加

アプリケーションに Ajax 機能を追加するには、3 つの JavaScript ファイルを使用する必要があります。 これらの 3 つのファイルはすべて、新しい ASP.NET MVC アプリケーションの Scripts フォルダーに含まれています。

アプリケーションの複数のページで Ajax を使用する場合は、アプリケーションのビューマスターページに必要な JavaScript ファイルを含めるのが理にかなっています。 これにより、JavaScript ファイルはアプリケーションのすべてのページに自動的に含まれます。

ビューマスターページのヘッド&lt;&gt;タグ内に、次の JavaScript インクルードを追加します。

[!code-html[Main](iteration-7-add-ajax-functionality-vb/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Ajax を使用するためのインデックス ビューのリファクタリング

まず、連絡先グループをクリックすると、連絡先を表示するビューの領域だけが更新されるように、インデックス ビューを変更します。 図 1 の赤いボックスには、更新する領域が表示されます。

[![連絡先のみを更新する](iteration-7-add-ajax-functionality-vb/_static/image1.jpg)](iteration-7-add-ajax-functionality-vb/_static/image1.png)

**図 01**: 連絡先のみを更新する ([フルサイズの画像を表示する をクリック](iteration-7-add-ajax-functionality-vb/_static/image2.png))

最初の手順では、非同期的に更新するビューの部分を別の部分 (ビュー ユーザー コントロール) に分割します。 連絡先のテーブルを表示するインデックス ビューのセクションは、リスト 1 の部分に移動されました。

**リスト 1 - ビュー\連絡先\連絡先リスト.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample2.aspx)]

リスト 1 の部分は、インデックス ビューとは異なるモデルを持っていることに注意してください。 %@ ページ %&lt;&gt;ディレクティブの&lt;*継承*属性は、部分が ViewUserControl グループ&gt;クラスから継承することを指定します。

更新されたインデックス ビューは、リスト 2 に含まれています。

**リスト 2 - ビュー\連絡先\インデックス.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample3.aspx)]

リスト 2 の更新されたビューについて、2 つの点に注意する必要があります。 まず、部分に移動されたすべてのコンテンツが Html.RenderPartial() への呼び出しに置き換えられることに注意してください。 Html.RenderPartial() メソッドは、最初の連絡先セットを表示するためにインデックス ビューが最初に要求されたときに呼び出されます。

次に、連絡先グループの表示に使用される Html.ActionLink() が Ajax.ActionLink() に置き換えられていることに注目してください。 Ajax.ActionLink() は、次のパラメーターを使用して呼び出されます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample4.aspx)]

最初のパラメータはリンクに表示するテキストを表し、2 番目のパラメータはルート値を表し、3 番目のパラメータは Ajax オプションを表します。 この場合、UpdateTargetId Ajax オプションを使用して、Ajax&lt;要求&gt;が完了した後に更新する HTML div タグを指します。 div&lt;&gt;タグを新しい連絡先リストで更新します。

連絡先コントローラの更新された Index() メソッドは、リスト 3 に含まれています。

**リスト 3 - コント ローラー\連絡先コント ローラー.vb (インデックス メソッド)**

[!code-vb[Main](iteration-7-add-ajax-functionality-vb/samples/sample5.vb)]

更新された Index() アクションは、条件に応じて 2 つのうちいずれかを返します。 Index() アクションが Ajax 要求によって呼び出された場合、コントローラーは部分を戻します。 それ以外の場合、Index() アクションはビュー全体を返します。

Index() アクションは、Ajax リクエストによって呼び出されたときに、それほど多くのデータを返す必要はありません。 通常の要求のコンテキストでは、インデックス アクションは、すべての連絡先グループと選択した連絡先グループの一覧を返します。 Ajax リクエストのコンテキストでは、Index() アクションは選択したグループのみを返します。 Ajax は、データベース・サーバでの作業が少ないことを意味します。

変更されたインデックスビューは、上位レベルと下位レベルの両方のブラウザの場合に機能します。 連絡先グループをクリックし、ブラウザが JavaScript をサポートしている場合は、連絡先のリストを含むビューの領域のみが更新されます。 一方、ブラウザが JavaScript をサポートしていない場合は、ビュー全体が更新されます。

更新されたインデックスビューには 1 つの問題があります。 連絡先グループをクリックしても、選択したグループは強調表示されません。 グループのリストは、Ajax 要求中に更新される領域の外部に表示されるため、右側のグループは強調表示されません。 この問題は次のセクションで修正します。

## <a name="adding-jquery-animation-effects"></a>jQuery アニメーション効果の追加

通常、Web ページ内のリンクをクリックすると、ブラウザの進行状況バーを使用して、更新されたコンテンツがブラウザによってアクティブに取得されているかどうかを検出できます。 一方、Ajax リクエストを実行すると、ブラウザの進行状況バーに進行状況が表示されません。 これは、ユーザーを緊張させることができます. ブラウザがフリーズしたかどうかを確認するにはどうすればよいですか?

Ajax 要求の実行中に作業が実行されていることをユーザーに示す方法はいくつかあります。 1 つの方法は、単純なアニメーションを表示することです。 たとえば、Ajax リクエストが開始され、リクエストが完了したときに領域内でフェードアウトすると、リージョンをフェードアウトできます。

アニメーション効果を作成するには、マイクロソフト ASP.NET MVC フレームワークに含まれている jQuery ライブラリを使用します。 更新されたインデックス ビューは、リスト 4 に含まれています。

**リスト 4 - ビュー\連絡先\インデックス.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample6.aspx)]

更新されたインデックス ビューには、3 つの新しい JavaScript 関数が含まれていることに注意してください。 最初の 2 つの関数は、jQuery を使用して、新しい連絡先グループをクリックしたときに、連絡先のリストをフェードアウトしてフェードインします。 3 番目の関数は、Ajax 要求がエラー (ネットワークタイムアウトなど) を発生した場合にエラー・メッセージを表示します。

最初の関数は、選択したグループをハイライト表示します。 class= 選択した属性が、クリックされた要素の親要素 (LI 要素) に追加されます。 ここでも、jQuery は、適切な要素を選択して CSS クラスを追加することが容易になります。

これらのスクリプトは、Ajax.ActionLink() AjaxOptions パラメーターの助けを借りてグループ・リンクに関連付けられています。 更新された Ajax.ActionLink() メソッド呼び出しは次のようになります。

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>ブラウザ履歴のサポートの追加

通常、ページを更新するリンクをクリックすると、ブラウザーの履歴が更新されます。 この方法で、ブラウザの [戻る] ボタンをクリックして、ページの前の状態に戻すことができます。 たとえば、Friends 連絡先グループをクリックしてビジネス用連絡先グループをクリックした場合、ブラウザの [戻る] ボタンをクリックして、Friends 連絡先グループが選択されているページの状態に戻ることができます。

残念ながら、Ajax リクエストを実行してもブラウザの履歴は自動的に更新されません。 連絡先グループをクリックし、一致する連絡先のリストが Ajax リクエストで取得された場合、ブラウザーの履歴は更新されません。 新しい連絡先グループを選択した後、ブラウザの [戻る] ボタンを使用して連絡先グループに戻ることはできません。

Ajax リクエストを実行した後にブラウザの [戻る] ボタンを使用できるようにする場合は、もう少し作業を実行する必要があります。 ASP.NET AJAX フレームワークに組み込まれているブラウザー履歴管理機能を利用する必要があります。

AJAX ブラウザの履歴ASP.NET、次の 3 つの操作を行う必要があります。

1. [ブラウザーの履歴] プロパティを true に設定して、ブラウザーの履歴を有効にします。
2. addHistoryPoint() メソッドを呼び出してビューの状態が変更されたときに履歴ポイントを保存します。
3. navigate イベントが発生したときのビューの状態を再構築します。

更新されたインデックス ビューは、リスト 5 に含まれています。

**リスト 5 - ビュー\連絡先\インデックス.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample8.aspx)]

リスト 5 では、ブラウザー履歴は pageInit() 関数で有効になっています。 pageInit() 関数は、navigate イベントのイベント ハンドラーを設定するためにも使用されます。 ナビゲーション イベントは、ブラウザーの [進む] ボタンまたは [戻る] ボタンによってページの状態が変化するたびに発生します。

連絡先グループをクリックすると、beginContactList() メソッドが呼び出されます。 このメソッドは、addHistoryPoint() メソッドを呼び出して新しい履歴ポイントを作成します。 クリックした連絡先グループの ID が履歴に追加されます。

グループ ID は、連絡先グループ リンクの expando 属性から取得されます。 リンクは、Ajax.ActionLink() への次の呼び出しでレンダリングされます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample9.aspx)]

Ajax.ActionLink() に渡された最後のパラメーターは、groupid という名前の expando 属性をリンクに追加します (XHTML 互換性の小文字)。

ユーザーがブラウザの [戻る] ボタンまたは [進む] ボタンをクリックすると、navigate イベントが発生し、navigate() メソッドが呼び出されます。 このメソッドは、ページに表示される連絡先を、ナビゲーション メソッドに渡されたブラウザーの履歴ポイントに対応するページの状態に一致するように更新します。

## <a name="performing-ajax-deletes"></a>Ajax 削除の実行

現在、連絡先を削除するには、[削除] リンクをクリックし、削除確認ページに表示される [削除] ボタンをクリックする必要があります (図 2 参照)。 これは、データベースレコードを削除するような単純なことを行うための多くのページ要求のように思えます。

[![削除確認ページ](iteration-7-add-ajax-functionality-vb/_static/image2.jpg)](iteration-7-add-ajax-functionality-vb/_static/image3.png)

**図02**: 削除確認ページ ([フルサイズの画像を表示する をクリック](iteration-7-add-ajax-functionality-vb/_static/image4.png))

削除確認ページをスキップし、インデックスビューから直接連絡先を削除するのは魅力的です。 この方法を使用すると、アプリケーションがセキュリティ ホールに開かれるため、この誘惑を避ける必要があります。 一般に、Web アプリケーションの状態を変更するアクションを呼び出すときに、HTTP GET 操作を実行する必要はありません。 削除を実行する場合は、HTTP POST を実行するか、さらに HTTP DELETE 操作を実行します。

削除リンクは、連絡先リストの一部に含まれています。 リスト 6 には、ContactList の一部の更新バージョンが含まれています。

**リスト 6 - ビュー\連絡先\連絡先リスト.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample10.aspx)]

削除リンクは、Ajax.ImageActionLink() メソッドに対する次の呼び出しでレンダリングされます。

[!code-aspx[Main](iteration-7-add-ajax-functionality-vb/samples/sample11.aspx)]

> [!NOTE] 
> 
> ajax.ImageActionLink() は、ASP.NET MVC フレームワークの標準部分ではありません。 Ajax.ImageActionLink() は、連絡先マネージャー プロジェクトに含まれるカスタム ヘルパー メソッドです。

AjaxOptions パラメーターには 2 つのプロパティがあります。 まず、確認プロパティを使用して、ポップアップ JavaScript 確認ダイアログを表示します。 次に、HTTP メソッド プロパティを使用して、HTTP 削除操作を実行します。

リスト 7 には、連絡先コントローラーに追加された新しい AjaxDelete() アクションが含まれています。

**リスト 7 - コントローラー\コンタクトコントローラー.vb (AjaxDelete)**   

[!code-vb[Main](iteration-7-add-ajax-functionality-vb/samples/sample12.vb)]

アクションは、AcceptVerbs 属性で修飾されます。 この属性は、HTTP DELETE 操作以外の HTTP 操作以外の操作が呼び出されないようにします。 特に、HTTP GET を使用してこのアクションを呼び出すことはできません。

データベース レコードを削除した後、削除されたレコードが含まれていない連絡先の更新された一覧を表示する必要があります。 AjaxDelete() メソッドは、連絡先リストの一部と更新された連絡先のリストを返します。

## <a name="summary"></a>まとめ

このイテレーションでは、連絡先マネージャー アプリケーションに Ajax 機能を追加しました。 アプリケーションの応答性とパフォーマンスを向上させるために Ajax を使用しました。

まず、連絡先グループをクリックしてもビュー全体が更新されないように、インデックス ビューをリファクタリングしました。 代わりに、連絡先グループをクリックすると、連絡先の一覧のみが更新されます。

次に、jQuery アニメーション効果を使用して、連絡先のリストをフェードアウトしてフェードインしました。 Ajax アプリケーションにアニメーションを追加すると、ブラウザーの進行状況バーと同等のアプリケーションのユーザーを提供できます。

また、Ajax アプリケーションにブラウザ履歴のサポートを追加しました。 ユーザーがブラウザの [戻る] ボタンと [進む] ボタンをクリックして、インデックス ビューの状態を変更することを有効にしました。

最後に、HTTP DELETE 操作をサポートする削除リンクを作成しました。 Ajax 削除を実行することにより、ユーザーは追加の削除確認ページを要求することなく、データベースレコードを削除することができます。

> [!div class="step-by-step"]
> [前へ](iteration-6-use-test-driven-development-vb.md)
