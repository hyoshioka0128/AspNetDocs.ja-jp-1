---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: 'チュートリアル: ASP.NET MVC アプリで EF の移行を使用して Azure にデプロイする'
author: tdykstra
description: このチュートリアルでは、Code First の移行を有効にし、Azure のクラウドにアプリケーションをデプロイします。
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 989dd0f0e18b338be057b9c5657586eff996d8ea
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78499366"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a><span data-ttu-id="c275b-103">チュートリアル: ASP.NET MVC アプリで EF の移行を使用して Azure にデプロイする</span><span class="sxs-lookup"><span data-stu-id="c275b-103">Tutorial: Use EF Migrations in an ASP.NET MVC app and deploy to Azure</span></span>

<span data-ttu-id="c275b-104">これまで、Contoso 大学のサンプル web アプリケーションは、開発用コンピューターの IIS Express でローカルに実行されています。</span><span class="sxs-lookup"><span data-stu-id="c275b-104">So far the Contoso University sample web application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="c275b-105">実際のアプリケーションをインターネット経由で他のユーザーが使用できるようにするには、それを web ホスティングプロバイダーに展開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-105">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="c275b-106">このチュートリアルでは、Code First の移行を有効にし、Azure のクラウドにアプリケーションをデプロイします。</span><span class="sxs-lookup"><span data-stu-id="c275b-106">In this tutorial, you enable Code First migrations and deploy the application to the cloud in Azure:</span></span>

- <span data-ttu-id="c275b-107">Code First Migrations を有効にします。</span><span class="sxs-lookup"><span data-stu-id="c275b-107">Enable Code First Migrations.</span></span> <span data-ttu-id="c275b-108">移行機能を使用すると、データベースを削除して再作成しなくても、データベーススキーマを更新することで、データモデルを変更し、変更を運用環境に配置できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-108">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="c275b-109">Azure にデプロイします。</span><span class="sxs-lookup"><span data-stu-id="c275b-109">Deploy to Azure.</span></span> <span data-ttu-id="c275b-110">この手順は省略可能です。プロジェクトをデプロイしなくても、残りのチュートリアルに進むことができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-110">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="c275b-111">デプロイにはソース管理と継続的インテグレーションプロセスを使用することをお勧めしますが、このチュートリアルではこれらのトピックについては説明しません。</span><span class="sxs-lookup"><span data-stu-id="c275b-111">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="c275b-112">詳細については、「 [Azure を使用した実際のクラウドアプリの構築](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction)」の[ソース管理](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control)と[継続的インテグレーション](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery)に関する章を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-112">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

<span data-ttu-id="c275b-113">このチュートリアルでは、次のことを行いました。</span><span class="sxs-lookup"><span data-stu-id="c275b-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c275b-114">Code First 移行を有効にする</span><span class="sxs-lookup"><span data-stu-id="c275b-114">Enable Code First migrations</span></span>
> * <span data-ttu-id="c275b-115">Azure にアプリをデプロイする (省略可能)</span><span class="sxs-lookup"><span data-stu-id="c275b-115">Deploy the app in Azure (optional)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c275b-116">前提条件</span><span class="sxs-lookup"><span data-stu-id="c275b-116">Prerequisites</span></span>

- [<span data-ttu-id="c275b-117">接続復元性とコマンド傍受</span><span class="sxs-lookup"><span data-stu-id="c275b-117">Connection Resiliency and Command Interception</span></span>](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a><span data-ttu-id="c275b-118">Code First 移行を有効にする</span><span class="sxs-lookup"><span data-stu-id="c275b-118">Enable Code First migrations</span></span>

<span data-ttu-id="c275b-119">新しいアプリケーションを開発して、データ モデルが頻繁に変更される場合、モデルが変更されるたびに、モデルはデータベースと同期されなくなります。</span><span class="sxs-lookup"><span data-stu-id="c275b-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="c275b-120">データモデルを変更するたびに、データベースを自動的に削除して再作成するように Entity Framework を構成しました。</span><span class="sxs-lookup"><span data-stu-id="c275b-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="c275b-121">エンティティクラスを追加、削除、または変更したり、`DbContext` クラスを変更したりすると、次にアプリケーションを実行するときに、既存のデータベースが自動的に削除され、モデルに一致する新しいデータベースが作成されて、テストデータでシードされます。</span><span class="sxs-lookup"><span data-stu-id="c275b-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="c275b-122">このメソッドは、実稼働環境にアプリケーションを展開するまで、データベースとデータ モデルの同期の維持がうまく機能します。</span><span class="sxs-lookup"><span data-stu-id="c275b-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="c275b-123">アプリケーションが運用環境で実行されている場合、通常は保持するデータを格納し、新しい列の追加などの変更を行うたびにすべてのデータを失わないようにします。</span><span class="sxs-lookup"><span data-stu-id="c275b-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="c275b-124">[Code First Migrations](https://msdn.microsoft.com/data/jj591621)機能では、データベースを削除して再作成するのではなく、Code First でデータベーススキーマを更新できるようにすることで、この問題を解決します。</span><span class="sxs-lookup"><span data-stu-id="c275b-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="c275b-125">このチュートリアルでは、アプリケーションを展開し、移行を有効にする準備をします。</span><span class="sxs-lookup"><span data-stu-id="c275b-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="c275b-126">前の手順で設定した初期化子を無効にするには、アプリケーションの Web.config ファイルに追加した `contexts` 要素をコメントアウトするか削除します。</span><span class="sxs-lookup"><span data-stu-id="c275b-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="c275b-127">また、アプリケーションの*web.config*ファイルで、接続文字列内のデータベースの名前を ContosoUniversity2 に変更します。</span><span class="sxs-lookup"><span data-stu-id="c275b-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="c275b-128">この変更により、最初の移行で新しいデータベースが作成されるようにプロジェクトが設定されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="c275b-129">これは必須ではありませんが、後で推奨される理由がわかります。</span><span class="sxs-lookup"><span data-stu-id="c275b-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="c275b-130">**[ツール]** メニューで、 **[NuGet パッケージ マネージャー]**  >  **[パッケージ マネージャー コンソール]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="c275b-131">`PM>` プロンプトで、次のコマンドを入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    <span data-ttu-id="c275b-132">`enable-migrations` コマンドを実行すると、ContosoUniversity プロジェクトに*移行*フォルダーが作成され、そのフォルダーに*Configuration.cs*ファイルが配置されます。このファイルを編集して、移行を構成することができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-132">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="c275b-133">(データベース名を変更するように指示された手順を実行しなかった場合は、既存のデータベースが検索され、[`add-migration`] コマンドが自動的に実行されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-133">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="c275b-134">これは、データベースを配置する前に、移行コードのテストを実行しないことを意味するだけです。</span><span class="sxs-lookup"><span data-stu-id="c275b-134">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="c275b-135">後で `update-database` コマンドを実行すると、データベースが既に存在しているため、何も起こりません。)</span><span class="sxs-lookup"><span data-stu-id="c275b-135">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    <span data-ttu-id="c275b-136">*ContosoUniversity\Migrations\Configuration.cs*ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="c275b-136">Open the *ContosoUniversity\Migrations\Configuration.cs* file.</span></span> <span data-ttu-id="c275b-137">前に見た初期化子クラスと同様に、`Configuration` クラスには `Seed` メソッドが含まれています。</span><span class="sxs-lookup"><span data-stu-id="c275b-137">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="c275b-138">[Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)メソッドの目的は、データベースを作成または更新した後に、テストデータを挿入または更新 Code First できるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="c275b-138">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="c275b-139">メソッドは、データベースが作成されたときと、データモデルの変更後にデータベーススキーマが更新されるたびに呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-139">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="c275b-140">Seed メソッドを設定する</span><span class="sxs-lookup"><span data-stu-id="c275b-140">Set up the Seed method</span></span>

<span data-ttu-id="c275b-141">すべてのデータモデルの変更に対してデータベースを削除して再作成した場合は、初期化子クラスの `Seed` メソッドを使用してテストデータを挿入します。これは、すべてのモデルが変更された後、データベースが削除され、すべてのテストデータが失われるためです。</span><span class="sxs-lookup"><span data-stu-id="c275b-141">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="c275b-142">Code First Migrations を使用すると、データベースの変更後もテストデータが保持されるため、通常、 [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)メソッドにテストデータを含める必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c275b-142">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="c275b-143">実際、`Seed` 方法は運用環境で実行されるため、移行を使用してデータベースを運用環境に配置する場合は、`Seed` 方法でテストデータを挿入しないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-143">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="c275b-144">その場合は、`Seed` メソッドを使用して、運用環境で必要なデータのみをデータベースに挿入する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-144">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="c275b-145">たとえば、アプリケーションを運用環境で使用できるようになったときに、データベースに実際の部署名を `Department` テーブルに含めるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-145">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="c275b-146">このチュートリアルでは、配置のために移行を使用しますが、`Seed` 方法では、大量のデータを手動で挿入することなく、アプリケーションの機能がどのように動作するかを簡単に確認できるように、テストデータを挿入します。</span><span class="sxs-lookup"><span data-stu-id="c275b-146">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="c275b-147">*Configuration.cs*ファイルの内容を次のコードに置き換えます。これにより、テストデータが新しいデータベースに読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="c275b-147">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="c275b-148">[Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)メソッドは、データベースコンテキストオブジェクトを入力パラメーターとして受け取り、メソッドのコードはそのオブジェクトを使用して新しいエンティティをデータベースに追加します。</span><span class="sxs-lookup"><span data-stu-id="c275b-148">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="c275b-149">このコードは、エンティティ型ごとに新しいエンティティのコレクションを作成し、適切な[Dbset](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx)プロパティに追加して、変更をデータベースに保存します。</span><span class="sxs-lookup"><span data-stu-id="c275b-149">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="c275b-150">ここで行ったように、エンティティの各グループの後に[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)メソッドを呼び出す必要はありませんが、コードがデータベースに書き込んでいる間に例外が発生した場合に、問題の原因を特定するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="c275b-150">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="c275b-151">データを挿入するステートメントの中には、 [Addorupdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)メソッドを使用して "upsert" 操作を実行するものがあります。</span><span class="sxs-lookup"><span data-stu-id="c275b-151">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="c275b-152">`Seed` メソッドは、`update-database` コマンドを実行するたびに実行されるため、通常は、各移行の後に、追加しようとしている行が、データベースを最初に作成した移行の後に既に存在するため、データを挿入することはできません。</span><span class="sxs-lookup"><span data-stu-id="c275b-152">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="c275b-153">"Upsert" 操作は、既に存在する行を挿入しようとすると発生するエラーを防ぎますが、アプリケーションのテスト中に行われたデータの変更を***上書き***します。</span><span class="sxs-lookup"><span data-stu-id="c275b-153">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="c275b-154">一部のテーブルのテストデータでは、このような処理が不要な場合があります。テスト中にデータを変更し、データベースの更新後も変更を保持する場合があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-154">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="c275b-155">その場合は、条件付き挿入操作を実行します。行がまだ存在しない場合にのみ、行を挿入します。</span><span class="sxs-lookup"><span data-stu-id="c275b-155">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="c275b-156">Seed メソッドは、両方の方法を使用します。</span><span class="sxs-lookup"><span data-stu-id="c275b-156">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="c275b-157">[Addorupdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)メソッドに渡される最初のパラメーターは、行が既に存在するかどうかを確認するために使用するプロパティを指定します。</span><span class="sxs-lookup"><span data-stu-id="c275b-157">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="c275b-158">指定したテスト学生データに対しては、リスト内の各姓が一意であるため、この目的には `LastName` プロパティを使用できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-158">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="c275b-159">このコードは、姓が一意であることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="c275b-159">This code assumes that last names are unique.</span></span> <span data-ttu-id="c275b-160">姓が重複する学生を手動で追加すると、次に移行を実行したときに次の例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="c275b-160">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="c275b-161">**シーケンスに複数の要素が含まれています**</span><span class="sxs-lookup"><span data-stu-id="c275b-161">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="c275b-162">"アレクサンドロス Carson" という名前の2人の学生などの冗長データを処理する方法については、Rick Anderson のブログの「 [Entity Framework (EF) db のシード処理とデバッグ](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-162">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="c275b-163">`AddOrUpdate` 方法の詳細については、「ジュリー Lerman のブログの[EF 4.3 AddOrUpdate メソッドに](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)対処する」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-163">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="c275b-164">`Enrollment` エンティティを作成するコードは、コレクションを作成するコードでそのプロパティを設定していなくても、`students` コレクションのエンティティに `ID` 値があることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="c275b-164">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="c275b-165">ここでは、`ID` プロパティを使用できます。これは、`students` コレクションに対して `SaveChanges` を呼び出すときに `ID` 値が設定されるためです。</span><span class="sxs-lookup"><span data-stu-id="c275b-165">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="c275b-166">EF は、エンティティをデータベースに挿入するときに主キーの値を自動的に取得し、メモリ内のエンティティの `ID` プロパティを更新します。</span><span class="sxs-lookup"><span data-stu-id="c275b-166">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="c275b-167">各 `Enrollment` エンティティを `Enrollments` エンティティセットに追加するコードでは、`AddOrUpdate` メソッドは使用しません。</span><span class="sxs-lookup"><span data-stu-id="c275b-167">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="c275b-168">エンティティが既に存在するかどうかを確認し、エンティティが存在しない場合は挿入します。</span><span class="sxs-lookup"><span data-stu-id="c275b-168">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="c275b-169">この方法では、アプリケーション UI を使用して、登録グレードに加えた変更を保持します。</span><span class="sxs-lookup"><span data-stu-id="c275b-169">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="c275b-170">このコードでは、`Enrollment`[リスト](https://msdn.microsoft.com/library/6sh2ey19.aspx)の各メンバーをループ処理します。登録がデータベースに見つからない場合は、データベースに登録が追加されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-170">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="c275b-171">データベースを初めて更新すると、データベースは空になるため、各登録が追加されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-171">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="c275b-172">プロジェクトをビルドします。</span><span class="sxs-lookup"><span data-stu-id="c275b-172">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="c275b-173">最初の移行を実行する</span><span class="sxs-lookup"><span data-stu-id="c275b-173">Execute the first migration</span></span>

<span data-ttu-id="c275b-174">`add-migration` コマンドを実行すると、データベースを最初から作成するコードが移行によって生成されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-174">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="c275b-175">このコードは、[*移行*] フォルダー内の *&lt;timestamp&gt;\_InitialCreate.cs*という名前のファイルにもあります。</span><span class="sxs-lookup"><span data-stu-id="c275b-175">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="c275b-176">`InitialCreate` クラスの `Up` メソッドによって、データモデルのエンティティセットに対応するデータベーステーブルが作成され、`Down` メソッドによって削除されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-176">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="c275b-177">移行は、`Up` メソッドを呼び出して、移行のためのデータ モデルの変更を実装します。</span><span class="sxs-lookup"><span data-stu-id="c275b-177">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="c275b-178">更新をロールバックするためのコマンドを入力すると、移行が `Down` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="c275b-178">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="c275b-179">これは、`add-migration InitialCreate` コマンドを入力したときに作成された最初の移行です。</span><span class="sxs-lookup"><span data-stu-id="c275b-179">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="c275b-180">パラメーター (例では`InitialCreate`) はファイル名に使用され、任意の名前を指定できます。通常は、移行中に何が行われているかをまとめた単語または語句を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-180">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="c275b-181">たとえば、後で移行 &quot;AddDepartmentTable&quot;に名前を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-181">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="c275b-182">データベースが既に存在するときに、初期移行を作成した場合、データベースの作成コードが生成されますが、データベースは既にデータと一致しているため、作成コードを実行する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c275b-182">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="c275b-183">データベースがまだ存在しない別の環境にアプリを展開する場合、データベースを作成するために、このコードが実行されるため、最初にテストを行うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="c275b-183">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="c275b-184">そのため、以前に&mdash;接続文字列内のデータベースの名前を変更したので、移行時に新しいデータベースを作成できるようになりました。</span><span class="sxs-lookup"><span data-stu-id="c275b-184">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="c275b-185">**[パッケージ マネージャー コンソール]** ウィンドウで、次のコマンドを入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-185">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    <span data-ttu-id="c275b-186">`update-database` コマンドは、`Up` メソッドを実行してデータベースを作成し、`Seed` メソッドを実行してデータベースにデータを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="c275b-186">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="c275b-187">アプリケーションを展開した後、次のセクションに示すように、同じプロセスが運用環境で自動的に実行されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-187">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="c275b-188">最初のチュートリアルで行ったように、**サーバーエクスプローラー**を使用してデータベースを検査し、アプリケーションを実行して、すべてが以前と同じように動作することを確認します。</span><span class="sxs-lookup"><span data-stu-id="c275b-188">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="c275b-189">Deploy to Azure (Azure へのデプロイ)</span><span class="sxs-lookup"><span data-stu-id="c275b-189">Deploy to Azure</span></span>

<span data-ttu-id="c275b-190">これまでは、アプリケーションは開発用コンピューターの IIS Express でローカルに実行されていました。</span><span class="sxs-lookup"><span data-stu-id="c275b-190">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="c275b-191">他のユーザーがインターネット経由で使用できるようにするには、それを web ホスティングプロバイダーに展開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-191">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="c275b-192">チュートリアルのこのセクションでは、Azure にデプロイします。</span><span class="sxs-lookup"><span data-stu-id="c275b-192">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="c275b-193">このセクションは省略可能です。これをスキップして次のチュートリアルに進むことができます。また、このセクションの手順は、選択した別のホスティングプロバイダーに合わせて変更することもできます。</span><span class="sxs-lookup"><span data-stu-id="c275b-193">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="c275b-194">Code First の移行を使用してデータベースを展開する</span><span class="sxs-lookup"><span data-stu-id="c275b-194">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="c275b-195">データベースを配置するには、Code First Migrations を使用します。</span><span class="sxs-lookup"><span data-stu-id="c275b-195">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="c275b-196">Visual Studio からデプロイするための設定を構成するために使用する発行プロファイルを作成するときに、 **[データベースの更新]** というチェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="c275b-196">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="c275b-197">この設定により、配置プロセスでは、Code First が `MigrateDatabaseToLatestVersion` 初期化子クラスを使用するように、移行先サーバー上のアプリケーションの*web.config*ファイルが自動的に構成されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-197">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="c275b-198">プロジェクトを移行先サーバーにコピーしている間、Visual Studio は配置プロセス中にデータベースに対して何も実行しません。</span><span class="sxs-lookup"><span data-stu-id="c275b-198">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="c275b-199">配置後に配置されたアプリケーションを実行し、データベースに初めてアクセスすると、Code First データベースがデータモデルと一致するかどうかがチェックされます。</span><span class="sxs-lookup"><span data-stu-id="c275b-199">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="c275b-200">不一致がある場合、Code First によってデータベースが自動的に作成されます (まだ存在しない場合)。またはデータベーススキーマを最新バージョンに更新します (データベースが存在するがモデルに一致しない場合)。</span><span class="sxs-lookup"><span data-stu-id="c275b-200">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="c275b-201">アプリケーションが移行 `Seed` 方法を実装している場合、メソッドは、データベースが作成された後、またはスキーマが更新された後に実行されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-201">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="c275b-202">移行 `Seed` 方法によって、テストデータが挿入されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-202">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="c275b-203">運用環境に配置する場合は、実稼働データベースに挿入するデータのみが挿入されるように `Seed` 方法を変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-203">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="c275b-204">たとえば、現在のデータモデルでは、開発用データベースに架空のコースを作成することができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-204">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="c275b-205">`Seed` メソッドを作成して、両方の開発で読み込み、架空の学生をコメントアウトしてから、運用環境にデプロイすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-205">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="c275b-206">または、`Seed` メソッドを記述してコースのみを読み込み、アプリケーションの UI を使用して、テストデータベースに架空の学生を手動で入力することもできます。</span><span class="sxs-lookup"><span data-stu-id="c275b-206">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="c275b-207">Azure アカウントを取得する</span><span class="sxs-lookup"><span data-stu-id="c275b-207">Get an Azure account</span></span>

<span data-ttu-id="c275b-208">Azure アカウントが必要です。</span><span class="sxs-lookup"><span data-stu-id="c275b-208">You'll need an Azure account.</span></span> <span data-ttu-id="c275b-209">まだお持ちでない場合は、Visual Studio サブスクリプションをお持ちの場合は、[サブスクリプションの特典を有効](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
)にすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-209">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="c275b-210">それ以外の場合は、無料試用版アカウントを数分で作成できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-210">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="c275b-211">詳細については、「[Azure の無料試用版サイト](https://azure.microsoft.com/free/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-211">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="c275b-212">Azure で web サイトと SQL データベースを作成する</span><span class="sxs-lookup"><span data-stu-id="c275b-212">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="c275b-213">Azure の web アプリは共有ホスティング環境で実行されます。これは、他の Azure クライアントと共有されている仮想マシン (Vm) 上で動作することを意味します。</span><span class="sxs-lookup"><span data-stu-id="c275b-213">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="c275b-214">共有ホスティング環境は、クラウドでの使い始めるための低コストな方法です。</span><span class="sxs-lookup"><span data-stu-id="c275b-214">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="c275b-215">その後、web トラフィックが増加した場合は、専用の Vm でを実行することで、ニーズに合わせてアプリケーションを拡張できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-215">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="c275b-216">Azure App Service の価格オプションの詳細については、 [App Service 価格](https://azure.microsoft.com/pricing/details/app-service/)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-216">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="c275b-217">ここでは、Azure SQL database にデータベースをデプロイします。</span><span class="sxs-lookup"><span data-stu-id="c275b-217">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="c275b-218">SQL database は、SQL Server テクノロジに基づいて構築されたクラウドベースのリレーショナルデータベースサービスです。</span><span class="sxs-lookup"><span data-stu-id="c275b-218">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="c275b-219">SQL Server と連携するツールとアプリケーションは、SQL database でも動作します。</span><span class="sxs-lookup"><span data-stu-id="c275b-219">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="c275b-220">[Azure 管理ポータル](https://portal.azure.com)で、左側のタブにある **[リソースの作成]** を選択し、**新しい**ウィンドウ (または*ブレード*) で **[すべて表示]** を選択して、使用可能なすべてのリソースを表示します。</span><span class="sxs-lookup"><span data-stu-id="c275b-220">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="c275b-221">**[すべて]** ブレードの **[web]** セクションで **[web アプリ + SQL]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-221">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="c275b-222">最後に、 **[作成]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-222">Finally, choose **Create**.</span></span>

    ![Azure Portal でのリソースの作成](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="c275b-224">新しい**Web アプリ + SQL**リソースを作成するためのフォームが開きます。</span><span class="sxs-lookup"><span data-stu-id="c275b-224">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="c275b-225">アプリケーションの一意の URL として使用する文字列を **[アプリ名]** ボックスに入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-225">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="c275b-226">完全な URL は、ここで入力した内容と Azure アプリ Services (. azurewebsites.net) の既定のドメインで構成されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="c275b-227">**アプリ名**が既に取得されている場合は、*アプリケーション名が使用できない*ことを知らせるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-227">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="c275b-228">**アプリ名**が使用可能な場合は、緑色のチェックマークが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-228">If the **App name** is available, you see a green checkmark.</span></span>

3. <span data-ttu-id="c275b-229">**[サブスクリプション]** ボックスで、 **App Service**を配置する Azure サブスクリプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-229">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="c275b-230">**[リソースグループ]** テキストボックスで、リソースグループを選択するか、新しいリソースグループを作成します。</span><span class="sxs-lookup"><span data-stu-id="c275b-230">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="c275b-231">この設定では、web サイトが実行されるデータセンターを指定します。</span><span class="sxs-lookup"><span data-stu-id="c275b-231">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="c275b-232">リソースグループの詳細については、「[リソースグループ](/azure/azure-resource-manager/resource-group-overview#resource-groups)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-232">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="c275b-233">新しい**App Service プラン**を作成するには、[ *App Service] セクション*をクリックし、 **[新規作成]** をクリックして**App Service プラン**(App Service と同じ名前でもかまいません)、 **[場所]** 、および **[価格レベル]** を選択します (無料のオプションがあります)。</span><span class="sxs-lookup"><span data-stu-id="c275b-233">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="c275b-234">**SQL Database** をクリックし、**新しいデータベースの作成** または 既存のデータベースの選択 を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-234">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

7. <span data-ttu-id="c275b-235">**[名前]** ボックスに、データベースの名前を入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-235">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="c275b-236">**[対象サーバー]** ボックスをクリックし、 **[新しいサーバーの作成]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-236">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="c275b-237">または、サーバーを既に作成してある場合は、使用可能なサーバーの一覧からそのサーバーを選択できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-237">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="c275b-238">**[価格レベル]** セクションを選択し、[*無料*] を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-238">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="c275b-239">追加のリソースが必要な場合は、いつでもデータベースをスケールアップできます。</span><span class="sxs-lookup"><span data-stu-id="c275b-239">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="c275b-240">Azure SQL の料金の詳細については、 [Azure SQL Database の価格](https://azure.microsoft.com/pricing/details/sql-database/managed/)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-240">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="c275b-241">必要に応じて[照合順序](/sql/relational-databases/collations/collation-and-unicode-support)を変更します。</span><span class="sxs-lookup"><span data-stu-id="c275b-241">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="c275b-242">管理者の**Sql 管理者ユーザー名**と**Sql 管理者パスワード**を入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-242">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

    - <span data-ttu-id="c275b-243">**[新しい SQL Database サーバー]** を選択した場合は、後でデータベースにアクセスするときに使用する新しい名前とパスワードを定義します。</span><span class="sxs-lookup"><span data-stu-id="c275b-243">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
    - <span data-ttu-id="c275b-244">以前に作成したサーバーを選択した場合は、そのサーバーの資格情報を入力します。</span><span class="sxs-lookup"><span data-stu-id="c275b-244">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="c275b-245">テレメトリの収集は、Application Insights を使用して App Service に対して有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-245">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="c275b-246">構成が少ない場合、Application Insights は重要なイベント、例外、依存関係、要求、およびトレース情報を収集します。</span><span class="sxs-lookup"><span data-stu-id="c275b-246">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="c275b-247">Application Insights の詳細については、「 [Azure Monitor](https://azure.microsoft.com/services/monitor/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-247">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="c275b-248">下部にある **[作成]** をクリックして、完了したことを示します。</span><span class="sxs-lookup"><span data-stu-id="c275b-248">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="c275b-249">管理ポータルによって ダッシュボード ページに戻り、ページの上部にある **通知** 領域にサイトが作成されていることが示されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-249">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="c275b-250">しばらくすると (通常は1分未満)、デプロイが成功したことを示す通知があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-250">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="c275b-251">左側のナビゲーションバーの **[App Services]** セクションに新しい App Service が表示され、 **[sql]** データベース セクションに新しい sql データベースが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-251">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="c275b-252">Azure にアプリケーションをデプロイする</span><span class="sxs-lookup"><span data-stu-id="c275b-252">Deploy the app to Azure</span></span>

1. <span data-ttu-id="c275b-253">Visual Studio の**ソリューション エクスプローラー**で、プロジェクトを右クリックし、コンテキスト メニューの **[発行]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="c275b-253">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

2. <span data-ttu-id="c275b-254">**[発行先の選択]** ページで、 **[App Service** ] を選択し、[既存] を**選択**して、 **[発行]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-254">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![発行先の選択ページ](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="c275b-256">まだ Visual Studio で Azure サブスクリプションを追加していない場合は、画面で手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="c275b-256">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="c275b-257">これらの手順により、Visual Studio から Azure サブスクリプションに接続し、 **App Services**の一覧に web サイトが含まれるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-257">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="c275b-258">**[App Service]** ページで、App Service を追加した**サブスクリプション**を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-258">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="c275b-259">**[表示]** で、 **[リソースグループ]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-259">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="c275b-260">App Service 追加したリソースグループを展開し、App Service を選択します。</span><span class="sxs-lookup"><span data-stu-id="c275b-260">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="c275b-261">**[OK]** を選択してアプリを発行します。</span><span class="sxs-lookup"><span data-stu-id="c275b-261">Choose **OK** to publish the app.</span></span>

5. <span data-ttu-id="c275b-262">**出力** ウィンドウでは、実行されたデプロイ操作が表示され、デプロイが問題なく完了したことが報告されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-262">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

6. <span data-ttu-id="c275b-263">デプロイが成功すると、既定のブラウザーが自動的に開き、デプロイされた web サイトの URL が表示されます。</span><span class="sxs-lookup"><span data-stu-id="c275b-263">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="c275b-265">これで、アプリはクラウドで実行されています。</span><span class="sxs-lookup"><span data-stu-id="c275b-265">Your app is now running in the cloud.</span></span>

<span data-ttu-id="c275b-266">この時点で、 **[Code First Migrations の実行 (アプリの起動時に実行)]** を選択したため、Azure SQL Database に*schoolcontext.cs*データベースが作成されました。</span><span class="sxs-lookup"><span data-stu-id="c275b-266">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="c275b-267">デプロイされた web サイトの*web.config ファイルが*変更され、コードがデータベース内のデータの読み取りまたは書き込みを初めて実行するとき ( **[Students]** タブを選択したときに[発生しまし](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)た) に変わりました。</span><span class="sxs-lookup"><span data-stu-id="c275b-267">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Web.config ファイルの抜粋](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="c275b-269">また、配置プロセスでは、データベーススキーマの更新とデータベースのシード処理に使用する Code First Migrations 用の新しい接続文字列 *(schoolcontext.cs\_DatabasePublish*) も作成されています。</span><span class="sxs-lookup"><span data-stu-id="c275b-269">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Web.config ファイル内の接続文字列](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="c275b-271">配置された web.config ファイルのバージョンは、自分のコンピューターのユーザーのコンピューターに配置されていることがわかります。詳細については、 *「」を*参照してください。配置された*web.config*ファイル自体には、FTP を使用してアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="c275b-271">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="c275b-272">手順については、「 [ASP.NET Web Deployment Using Visual Studio: Code Update のデプロイ](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-272">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="c275b-273">「FTP ツールを使用するには」で始まる指示に従って、FTP URL、ユーザー名、およびパスワードの3つが必要になります。</span><span class="sxs-lookup"><span data-stu-id="c275b-273">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="c275b-274">Web アプリはセキュリティを実装していないので、URL を見つけたすべてのユーザーがデータを変更できます。</span><span class="sxs-lookup"><span data-stu-id="c275b-274">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="c275b-275">Web サイトをセキュリティで保護する方法については、「[メンバーシップ、OAuth、SQL database を使用した secure ASP.NET MVC アプリの Azure へのデプロイ](/aspnet/core/security/authorization/secure-data)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-275">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="c275b-276">Azure 管理ポータルまたは Visual Studio で**サーバーエクスプローラー**を使用してサービスを停止することで、他のユーザーがサイトを使用できないようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-276">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![App service メニュー項目の停止](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="c275b-278">高度な移行シナリオ</span><span class="sxs-lookup"><span data-stu-id="c275b-278">Advanced migrations scenarios</span></span>

<span data-ttu-id="c275b-279">このチュートリアルに示されているように、移行を自動的に実行してデータベースを配置し、複数のサーバーで実行される web サイトに配置する場合は、複数のサーバーが同時に移行を実行しようとする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="c275b-279">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="c275b-280">移行はアトミックであるため、2台のサーバーが同じ移行を実行しようとすると、1つが成功し、もう一方は失敗します (操作を2回実行することはできません)。</span><span class="sxs-lookup"><span data-stu-id="c275b-280">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="c275b-281">このような問題を回避する場合は、手動で移行を呼び出し、独自のコードを設定して1回だけ発生するようにします。</span><span class="sxs-lookup"><span data-stu-id="c275b-281">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="c275b-282">詳細については、「Rowan 明美のブログの[コードからの移行の実行とスクリプト作成](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/)」と「 [.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (コマンドラインからの移行の実行用)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-282">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="c275b-283">その他の移行シナリオの詳細については、「[スクリーンキャスト Series の移行](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-283">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="update-specific-migration"></a><span data-ttu-id="c275b-284">特定の移行の更新</span><span class="sxs-lookup"><span data-stu-id="c275b-284">Update specific migration</span></span>

`update-database -target MigrationName`

<span data-ttu-id="c275b-285">`update-database -target MigrationName` コマンドは、対象の移行を実行します。</span><span class="sxs-lookup"><span data-stu-id="c275b-285">The `update-database -target MigrationName` command runs the targeted migration.</span></span>

## <a name="ignore-migration-changes-to-database"></a><span data-ttu-id="c275b-286">データベースへの移行の変更を無視する</span><span class="sxs-lookup"><span data-stu-id="c275b-286">Ignore migration changes to database</span></span>

`Add-migration MigrationName -ignoreChanges`

<span data-ttu-id="c275b-287">`ignoreChanges` は、現在のモデルをスナップショットとして使用して、空の移行を作成します。</span><span class="sxs-lookup"><span data-stu-id="c275b-287">`ignoreChanges` creates an empty migration with the current model as a snapshot.</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="c275b-288">Code First 初期化子</span><span class="sxs-lookup"><span data-stu-id="c275b-288">Code First initializers</span></span>

<span data-ttu-id="c275b-289">[デプロイ] セクションでは、Migrateに使用されている、 [migrateの](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)ユーザー初期化子があることを確認しました。</span><span class="sxs-lookup"><span data-stu-id="c275b-289">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="c275b-290">Code First には、 [Createdatabaseifnotexists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (既定)、 [Dropcreatedatabaseifmodelchanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (前に使用したもの)、 [dropcreatedatabasealways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx)など、他の初期化子も用意されています。</span><span class="sxs-lookup"><span data-stu-id="c275b-290">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="c275b-291">`DropCreateAlways` 初期化子は、単体テストの条件を設定する場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="c275b-291">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="c275b-292">独自の初期化子を記述することもできます。また、アプリケーションがデータベースに対して読み取りまたは書き込みを行うまで待機しない場合は、初期化子を明示的に呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="c275b-292">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="c275b-293">初期化子の詳細については、「 [Entity Framework Code First でのデータベース初期化子](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm)について」および「書籍の[プログラミング Entity Framework:](http://shop.oreilly.com/product/0636920022220.do)ジュリー Lerman と rowan 明美による Code First」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-293">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="get-the-code"></a><span data-ttu-id="c275b-294">コードの入手</span><span class="sxs-lookup"><span data-stu-id="c275b-294">Get the code</span></span>

[<span data-ttu-id="c275b-295">完成したプロジェクトをダウンロードする</span><span class="sxs-lookup"><span data-stu-id="c275b-295">Download the Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="c275b-296">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="c275b-296">Additional resources</span></span>

<span data-ttu-id="c275b-297">その他の Entity Framework リソースへのリンクについては[、「ASP.NET Data Access-推奨リソース](xref:whitepapers/aspnet-data-access-content-map)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-297">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

## <a name="next-steps"></a><span data-ttu-id="c275b-298">次のステップ</span><span class="sxs-lookup"><span data-stu-id="c275b-298">Next steps</span></span>

<span data-ttu-id="c275b-299">このチュートリアルでは、次のことを行いました。</span><span class="sxs-lookup"><span data-stu-id="c275b-299">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c275b-300">Code First 移行を有効にする</span><span class="sxs-lookup"><span data-stu-id="c275b-300">Enabled Code First migrations</span></span>
> * <span data-ttu-id="c275b-301">Azure にアプリをデプロイしました (省略可能)</span><span class="sxs-lookup"><span data-stu-id="c275b-301">Deployed the app in Azure (optional)</span></span>

<span data-ttu-id="c275b-302">次の記事に進み、ASP.NET MVC アプリケーション用により複雑なデータモデルを作成する方法を学習してください。</span><span class="sxs-lookup"><span data-stu-id="c275b-302">Advance to the next article to learn how to create a more complex data model for an ASP.NET MVC Application.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="c275b-303">より複雑なデータモデルを作成する</span><span class="sxs-lookup"><span data-stu-id="c275b-303">Create a more complex data model</span></span>](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
