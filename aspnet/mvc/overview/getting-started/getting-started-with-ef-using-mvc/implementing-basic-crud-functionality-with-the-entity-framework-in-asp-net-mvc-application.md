---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: 'チュートリアル: ASP.NET MVC | の Entity Framework で CRUD 機能を実装するMicrosoft Docs'
description: MVC スキャフォールディングによってコントローラーとビューに自動的に作成される作成、読み取り、更新、削除 (CRUD) コードを確認し、カスタマイズします。
author: tdykstra
ms.author: riande
ms.date: 01/22/2019
ms.topic: tutorial
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 9ed388543dd54d209ff2a0b92df4f7659962582c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471148"
---
# <a name="tutorial-implement-crud-functionality-with-the-entity-framework-in-aspnet-mvc"></a><span data-ttu-id="b3553-103">チュートリアル: ASP.NET MVC での Entity Framework を使用した CRUD 機能の実装</span><span class="sxs-lookup"><span data-stu-id="b3553-103">Tutorial: Implement CRUD Functionality with the Entity Framework in ASP.NET MVC</span></span>

<span data-ttu-id="b3553-104">前の[チュートリアル](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)では、ENTITY FRAMEWORK (EF) 6 と SQL Server LocalDB を使用してデータを格納および表示する MVC アプリケーションを作成しました。</span><span class="sxs-lookup"><span data-stu-id="b3553-104">In the [previous tutorial](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md), you created an MVC application that stores and displays data using the Entity Framework (EF) 6 and SQL Server LocalDB.</span></span> <span data-ttu-id="b3553-105">このチュートリアルでは、MVC スキャフォールディングによってコントローラーとビューに自動的に作成される作成、読み取り、更新、削除 (CRUD) コードを確認し、カスタマイズします。</span><span class="sxs-lookup"><span data-stu-id="b3553-105">In this tutorial, you review and customize the create, read, update, delete (CRUD) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="b3553-106">コントローラーとデータ アクセス層の間に抽象化レイヤーを作成するためにリポジトリ パターンを実装することは、よく行われることです。</span><span class="sxs-lookup"><span data-stu-id="b3553-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="b3553-107">これらのチュートリアルを単純にし、EF 6 自体の使用方法を説明することに重点を置いて、リポジトリは使用しません。</span><span class="sxs-lookup"><span data-stu-id="b3553-107">To keep these tutorials simple and focused on teaching how to use EF 6 itself, they don't use repositories.</span></span> <span data-ttu-id="b3553-108">リポジトリを実装する方法の詳細については、「 [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-108">For info about how to implement repositories, see the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

<span data-ttu-id="b3553-109">作成する web ページの例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="b3553-109">Here are examples of the web pages you create:</span></span>

![学生の詳細ページのスクリーンショット。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![学生作成ページのスクリーンショット。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![学生の削除ページのスクリーンショット。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

<span data-ttu-id="b3553-113">このチュートリアルでは、次のことを行いました。</span><span class="sxs-lookup"><span data-stu-id="b3553-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="b3553-114">詳細ページを作成する</span><span class="sxs-lookup"><span data-stu-id="b3553-114">Create a Details page</span></span>
> * <span data-ttu-id="b3553-115">[作成] ページを更新する</span><span class="sxs-lookup"><span data-stu-id="b3553-115">Update the Create page</span></span>
> * <span data-ttu-id="b3553-116">HttpPost Edit メソッドを更新する</span><span class="sxs-lookup"><span data-stu-id="b3553-116">Update the HttpPost Edit method</span></span>
> * <span data-ttu-id="b3553-117">削除ページを更新する</span><span class="sxs-lookup"><span data-stu-id="b3553-117">Update the Delete page</span></span>
> * <span data-ttu-id="b3553-118">データベース接続を閉じる</span><span class="sxs-lookup"><span data-stu-id="b3553-118">Close database connections</span></span>
> * <span data-ttu-id="b3553-119">トランザクションを処理する</span><span class="sxs-lookup"><span data-stu-id="b3553-119">Handle transactions</span></span>

## <a name="prerequisites"></a><span data-ttu-id="b3553-120">前提条件</span><span class="sxs-lookup"><span data-stu-id="b3553-120">Prerequisites</span></span>

* [<span data-ttu-id="b3553-121">Entity Framework データモデルを作成する</span><span class="sxs-lookup"><span data-stu-id="b3553-121">Create the Entity Framework Data Model</span></span>](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)

## <a name="create-a-details-page"></a><span data-ttu-id="b3553-122">詳細ページを作成する</span><span class="sxs-lookup"><span data-stu-id="b3553-122">Create a Details page</span></span>

<span data-ttu-id="b3553-123">このプロパティにはコレクションが保持されているため、[Students `Index`] ページのスキャフォールディングコードは `Enrollments` プロパティの左側にあります。</span><span class="sxs-lookup"><span data-stu-id="b3553-123">The scaffolded code for the Students `Index` page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="b3553-124">[`Details`] ページには、コレクションの内容が HTML テーブルとして表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-124">In the `Details` page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="b3553-125">*Controllers\StudentController.cs*では、`Details` ビューのアクションメソッドは、 [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx)メソッドを使用して1つの `Student` エンティティを取得します。</span><span class="sxs-lookup"><span data-stu-id="b3553-125">In *Controllers\StudentController.cs*, the action method for the `Details` view uses the [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx) method to retrieve a single `Student` entity.</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="b3553-126">キー値は `id` パラメーターとしてメソッドに渡され、インデックスページの**詳細**ハイパーリンクの*ルートデータ*から取得されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-126">The key value is passed to the method as the `id` parameter and comes from *route data* in the **Details** hyperlink on the Index page.</span></span>

### <a name="tip-route-data"></a><span data-ttu-id="b3553-127">ヒント:**ルートデータ**</span><span class="sxs-lookup"><span data-stu-id="b3553-127">Tip: **Route data**</span></span>

<span data-ttu-id="b3553-128">Route data は、モデルバインダーがルーティングテーブルで指定された URL セグメントで見つかったデータです。</span><span class="sxs-lookup"><span data-stu-id="b3553-128">Route data is data that the model binder found in a URL segment specified in the routing table.</span></span> <span data-ttu-id="b3553-129">たとえば、既定のルートでは、`controller`、`action`、および `id` セグメントが指定されています。</span><span class="sxs-lookup"><span data-stu-id="b3553-129">For example, the default route specifies `controller`, `action`, and `id` segments:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

<span data-ttu-id="b3553-130">次の URL では、既定のルートは、`Instructor` を `controller`としてマップし、`Index` `action` として、1を `id`としてマップします。これらはルートデータ値です。</span><span class="sxs-lookup"><span data-stu-id="b3553-130">In the following URL, the default route maps `Instructor` as the `controller`, `Index` as the `action` and 1 as the `id`; these are route data values.</span></span>

`http://localhost:1230/Instructor/Index/1?courseID=2021`

<span data-ttu-id="b3553-131">`?courseID=2021` はクエリ文字列値です。</span><span class="sxs-lookup"><span data-stu-id="b3553-131">`?courseID=2021` is a query string value.</span></span> <span data-ttu-id="b3553-132">モデルバインダーは、`id` をクエリ文字列値として渡す場合にも機能します。</span><span class="sxs-lookup"><span data-stu-id="b3553-132">The model binder will also work if you pass the `id` as a query string value:</span></span>

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

<span data-ttu-id="b3553-133">Url は、Razor ビューの `ActionLink` ステートメントによって作成されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-133">The URLs are created by `ActionLink` statements in the Razor view.</span></span> <span data-ttu-id="b3553-134">次のコードでは、`id` パラメーターが既定のルートと一致するため、`id` がルートデータに追加されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-134">In the following code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

<span data-ttu-id="b3553-135">次のコードでは、`courseID` が既定のルートのパラメーターと一致しないため、クエリ文字列として追加されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-135">In the following code, `courseID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]

### <a name="to-create-the-details-page"></a><span data-ttu-id="b3553-136">詳細ページを作成するには</span><span class="sxs-lookup"><span data-stu-id="b3553-136">To create the Details page</span></span>

1. <span data-ttu-id="b3553-137">*Views\Student\Details.cshtml*を開きます。</span><span class="sxs-lookup"><span data-stu-id="b3553-137">Open *Views\Student\Details.cshtml*.</span></span>

   <span data-ttu-id="b3553-138">各フィールドは、次の例に示すように、`DisplayFor` ヘルパーを使用して表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-138">Each field is displayed using a `DisplayFor` helper, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]

2. <span data-ttu-id="b3553-139">`EnrollmentDate` フィールドの後、終了 `</dl>` タグの直前に、次の例に示すように、強調表示されているコードを追加して登録の一覧を表示します。</span><span class="sxs-lookup"><span data-stu-id="b3553-139">After the `EnrollmentDate` field and immediately before the closing `</dl>` tag, add the highlighted code to display a list of enrollments, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    <span data-ttu-id="b3553-140">コードを貼り付けた後でコードのインデントが正しくない場合は、 **ctrl**+**K**、 **ctrl**+**D**キーを押して書式設定します。</span><span class="sxs-lookup"><span data-stu-id="b3553-140">If code indentation is wrong after you paste the code, press **Ctrl**+**K**, **Ctrl**+**D** to format it.</span></span>

    <span data-ttu-id="b3553-141">このコードは、`Enrollments` ナビゲーション プロパティ内のエンティティをループ処理します。</span><span class="sxs-lookup"><span data-stu-id="b3553-141">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="b3553-142">プロパティ内の `Enrollment` エンティティごとに、コースタイトルとグレードが表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-142">For each `Enrollment` entity in the property, it displays the course title and the grade.</span></span> <span data-ttu-id="b3553-143">コースタイトルは、`Enrollments` エンティティの `Course` ナビゲーションプロパティに格納されている `Course` エンティティから取得されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-143">The course title is retrieved from the `Course` entity that's stored in the `Course` navigation property of the `Enrollments` entity.</span></span> <span data-ttu-id="b3553-144">必要に応じて、すべてのデータがデータベースから自動的に取得されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-144">All of this data is retrieved from the database automatically when it's needed.</span></span> <span data-ttu-id="b3553-145">つまり、ここで遅延読み込みを使用しているとします。</span><span class="sxs-lookup"><span data-stu-id="b3553-145">In other words, you are using lazy loading here.</span></span> <span data-ttu-id="b3553-146">`Courses` ナビゲーションプロパティの*一括読み込み*を指定しなかったので、学生を取得した同じクエリで登録を取得できませんでした。</span><span class="sxs-lookup"><span data-stu-id="b3553-146">You did not specify *eager loading* for the `Courses` navigation property, so the enrollments were not retrieved in the same query that got the students.</span></span> <span data-ttu-id="b3553-147">代わりに、`Enrollments` ナビゲーションプロパティに初めてアクセスしようとすると、データを取得するために新しいクエリがデータベースに送信されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-147">Instead, the first time you try to access the `Enrollments` navigation property, a new query is sent to the database to retrieve the data.</span></span> <span data-ttu-id="b3553-148">遅延読み込みと一括読み込みの詳細については、このシリーズの後の「[関連データの読み取り](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)」チュートリアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-148">You can read more about lazy loading and eager loading in the [Reading Related Data](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial later in this series.</span></span>

3. <span data-ttu-id="b3553-149">詳細 ページを開くには、プログラム (**Ctrl**+**F5**) を起動し、**Students** タブを選択して、アレクサンドロス Carson の  **details** リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="b3553-149">Open the Details page by starting the program (**Ctrl**+**F5**), selecting the **Students** tab, and then clicking the **Details** link for Alexander Carson.</span></span> <span data-ttu-id="b3553-150">(*詳細の cshtml*ファイルが開いている間に**Ctrl**+**F5**キーを押すと、HTTP 400 エラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-150">(If you press **Ctrl**+**F5** while the *Details.cshtml* file is open, you get an HTTP 400 error.</span></span> <span data-ttu-id="b3553-151">これは、Visual Studio が詳細ページを実行しようとしても、表示する学生を指定するリンクに達しなかったためです。</span><span class="sxs-lookup"><span data-stu-id="b3553-151">This is because Visual Studio tries to run the Details page, but it wasn't reached from a link that specifies the student to display.</span></span> <span data-ttu-id="b3553-152">そのような場合は、URL から "Student/Details" を削除してもう一度やり直してください。または、ブラウザーを閉じてプロジェクトを右クリックし、[**ブラウザーで**ビュー > 表示] を**クリックして**ください)。</span><span class="sxs-lookup"><span data-stu-id="b3553-152">If that happens, remove "Student/Details" from the URL and try again, or, close the browser, right-click the project, and click **View** > **View in Browser**.)</span></span>

    <span data-ttu-id="b3553-153">選択した学生のコースとグレードの一覧が表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-153">You see the list of courses and grades for the selected student.</span></span>

4. <span data-ttu-id="b3553-154">ブラウザーを閉じます。</span><span class="sxs-lookup"><span data-stu-id="b3553-154">Close the browser.</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="b3553-155">[作成] ページを更新する</span><span class="sxs-lookup"><span data-stu-id="b3553-155">Update the Create page</span></span>

1. <span data-ttu-id="b3553-156">*Controllers\StudentController.cs*で、<xref:System.Web.Mvc.HttpPostAttribute> `Create` アクションメソッドを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="b3553-156">In *Controllers\StudentController.cs*, replace the <xref:System.Web.Mvc.HttpPostAttribute> `Create` action method with the following code.</span></span> <span data-ttu-id="b3553-157">このコードは `try-catch` ブロックを追加し、スキャフォールディングメソッドの <xref:System.Web.Mvc.BindAttribute> 属性から `ID` を削除します。</span><span class="sxs-lookup"><span data-stu-id="b3553-157">This code adds a `try-catch` block and removes `ID` from the <xref:System.Web.Mvc.BindAttribute> attribute for the scaffolded method:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    <span data-ttu-id="b3553-158">このコードは、ASP.NET MVC モデルバインダーによって作成された `Student` エンティティを `Students` エンティティセットに追加し、変更をデータベースに保存します。</span><span class="sxs-lookup"><span data-stu-id="b3553-158">This code adds the `Student` entity created by the ASP.NET MVC model binder to the `Students` entity set and then saves the changes to the database.</span></span> <span data-ttu-id="b3553-159">*モデルバインダー*は、フォームによって送信されたデータを簡単に操作できるようにする ASP.NET MVC の機能を参照します。モデルバインダーは、ポストされたフォーム値を CLR 型に変換し、パラメーターのアクションメソッドに渡します。</span><span class="sxs-lookup"><span data-stu-id="b3553-159">*Model binder* refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="b3553-160">この場合、モデルバインダーは、`Form` コレクションのプロパティ値を使用して、`Student` エンティティをインスタンス化します。</span><span class="sxs-lookup"><span data-stu-id="b3553-160">In this case, the model binder instantiates a `Student` entity for you using property values from the `Form` collection.</span></span>

    <span data-ttu-id="b3553-161">バインド属性から `ID` を削除したのは、行が挿入されたときに SQL Server が自動的に設定する主キー値 `ID` であるためです。</span><span class="sxs-lookup"><span data-stu-id="b3553-161">You removed `ID` from the Bind attribute because `ID` is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="b3553-162">ユーザーからの入力に `ID` 値が設定されていません。</span><span class="sxs-lookup"><span data-stu-id="b3553-162">Input from the user does not set the `ID` value.</span></span>

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgery-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a><span data-ttu-id="b3553-163">セキュリティ警告-`ValidateAntiForgeryToken` 属性は、[クロスサイト要求偽造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻撃を防止するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="b3553-163">Security warning - The `ValidateAntiForgeryToken` attribute helps prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span> <span data-ttu-id="b3553-164">ビューには、対応する `Html.AntiForgeryToken()` ステートメントが必要です。これについては後で説明します。</span><span class="sxs-lookup"><span data-stu-id="b3553-164">It requires a corresponding `Html.AntiForgeryToken()` statement in the view, which you'll see later.</span></span>

    <span data-ttu-id="b3553-165">`Bind` 属性は、作成シナリオで*過剰な投稿*から保護するための1つの方法です。</span><span class="sxs-lookup"><span data-stu-id="b3553-165">The `Bind` attribute is one way to protect against *over-posting* in create scenarios.</span></span> <span data-ttu-id="b3553-166">たとえば、`Student` エンティティに、この web ページを設定したくない `Secret` のプロパティが含まれているとします。</span><span class="sxs-lookup"><span data-stu-id="b3553-166">For example, suppose the `Student` entity includes a `Secret` property that you don't want this web page to set.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    <span data-ttu-id="b3553-167">Web ページに `Secret` フィールドがない場合でも、ハッカーは[fiddler](http://fiddler2.com/home)などのツールを使用するか、一部の JavaScript を記述して `Secret` フォーム値をポストすることができます。</span><span class="sxs-lookup"><span data-stu-id="b3553-167">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as [fiddler](http://fiddler2.com/home), or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="b3553-168">モデルバインダーが `Student` インスタンスを作成するときに使用するフィールドを制限する <xref:System.Web.Mvc.BindAttribute> 属性がない場合<em>、</em>モデルバインダーは、その `Secret` フォーム値を取得し、それを使用して `Student` エンティティインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="b3553-168">Without the <xref:System.Web.Mvc.BindAttribute> attribute limiting the fields that the model binder uses when it creates a `Student` instance<em>,</em> the model binder would pick up that `Secret` form value and use it to create the `Student` entity instance.</span></span> <span data-ttu-id="b3553-169">その場合、`Secret` フォーム フィールドに対してハッカーが指定した値はすべて、データベースで更新されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-169">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="b3553-170">次の図は、ポストされたフォーム値に `Secret` フィールド (値 "OverPost") を追加する fiddler ツールを示しています。</span><span class="sxs-lookup"><span data-stu-id="b3553-170">The following image shows the fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)

    <span data-ttu-id="b3553-171">値 "OverPost" は挿入される行の `Secret` プロパティに正常に追加されますが、Web ページがそのプロパティを設定できることは意図したものではありません。</span><span class="sxs-lookup"><span data-stu-id="b3553-171">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

    <span data-ttu-id="b3553-172">`Include` パラメーターと `Bind` 属性を使用して、フィールドを*ホワイトリスト*に登録することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b3553-172">It's best to use the `Include` parameter with the `Bind` attribute to *whitelist* fields.</span></span> <span data-ttu-id="b3553-173">`Exclude` パラメーターを使用して、除外するフィールドを*ブラック*リストに追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="b3553-173">It's also possible to use the `Exclude` parameter to *blacklist* fields you want to exclude.</span></span> <span data-ttu-id="b3553-174">`Include` のセキュリティが強化されているのは、新しいプロパティをエンティティに追加したときに、新しいフィールドが `Exclude` の一覧によって自動的に保護されないことです。</span><span class="sxs-lookup"><span data-stu-id="b3553-174">The reason `Include` is more secure is that when you add a new property to the entity, the new field is not automatically protected by an `Exclude` list.</span></span>

    <span data-ttu-id="b3553-175">編集シナリオでの過剰な投稿を防ぐには、まずデータベースからエンティティを読み取り、次に `TryUpdateModel`を呼び出して、明示的に許可されているプロパティリストを渡します。</span><span class="sxs-lookup"><span data-stu-id="b3553-175">You can prevent overposting in edit scenarios is by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="b3553-176">これは、これらのチュートリアルで使用されている方法です。</span><span class="sxs-lookup"><span data-stu-id="b3553-176">That is the method used in these tutorials.</span></span>

    <span data-ttu-id="b3553-177">多くの開発者にとって優先される過剰なポスティングを防ぐ別の方法として、モデルバインドを持つエンティティクラスではなく、ビューモデルを使用する方法があります。</span><span class="sxs-lookup"><span data-stu-id="b3553-177">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="b3553-178">更新するプロパティのみをビュー モデルに含めます。</span><span class="sxs-lookup"><span data-stu-id="b3553-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="b3553-179">MVC モデルバインダーが終了したら、必要に応じて[Automapper](http://automapper.org/)などのツールを使用して、ビューモデルのプロパティをエンティティインスタンスにコピーします。</span><span class="sxs-lookup"><span data-stu-id="b3553-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as [AutoMapper](http://automapper.org/).</span></span> <span data-ttu-id="b3553-180">Db を使用します。エンティティインスタンスのエントリを変更して状態を Unchanged に設定し、プロパティ ("PropertyName") を設定します。IsModified は、ビューモデルに含まれる各エンティティプロパティで true に変更されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-180">Use db.Entry on the entity instance to set its state to Unchanged, and then set Property("PropertyName").IsModified to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="b3553-181">この方法は、編集シナリオと作成シナリオの両方で利用できます。</span><span class="sxs-lookup"><span data-stu-id="b3553-181">This method works in both edit and create scenarios.</span></span>

    <span data-ttu-id="b3553-182">`Bind` 属性以外は、スキャフォールディングコードに対して行った変更は `try-catch` ブロックだけです。</span><span class="sxs-lookup"><span data-stu-id="b3553-182">Other than the `Bind` attribute, the `try-catch` block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="b3553-183">変更を保存するときに、<xref:System.Data.DataException> から派生した例外がキャッチされた場合は、汎用的なエラー メッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-183">If an exception that derives from <xref:System.Data.DataException> is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="b3553-184"><xref:System.Data.DataException> 例外は、プログラミング エラーではなくアプリケーション外の何かが原因で発生する場合があるので、再試行することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b3553-184"><xref:System.Data.DataException> exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="b3553-185">このサンプルでは実装されていませんが、運用品質のアプリケーションでは例外をログに記録します。</span><span class="sxs-lookup"><span data-stu-id="b3553-185">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="b3553-186">詳細については、「**Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)** 」(監視とテレメトリ (Azure での実際のクラウド アプリの構築)) の「[Log for insight](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log)」(洞察のためのログ) セクションをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b3553-186">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).</span></span>

    <span data-ttu-id="b3553-187">Views\Student\Create.cshtml のコードは、「 」で*説明*したものと似ていますが、`DisplayFor`ではなく、各フィールドに対して `EditorFor` および `ValidationMessageFor` ヘルパーが使用されている点が異なります。</span><span class="sxs-lookup"><span data-stu-id="b3553-187">The code in *Views\Student\Create.cshtml* is similar to what you saw in *Details.cshtml*, except that `EditorFor` and `ValidationMessageFor` helpers are used for each field instead of `DisplayFor`.</span></span> <span data-ttu-id="b3553-188">関連するコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="b3553-188">Here is the relevant code:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    <span data-ttu-id="b3553-189">また、`@Html.AntiForgeryToken()`も含まれています *。* これは、[クロスサイト要求偽造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻撃を防ぐために、コントローラーの `ValidateAntiForgeryToken` 属性と連携します。</span><span class="sxs-lookup"><span data-stu-id="b3553-189">*Create.cshtml* also includes `@Html.AntiForgeryToken()`, which works with the `ValidateAntiForgeryToken` attribute in the controller to help prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span>

    <span data-ttu-id="b3553-190">*Create. cshtml*に変更は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="b3553-190">No changes are required in *Create.cshtml*.</span></span>

2. <span data-ttu-id="b3553-191">プログラムを起動し、 **[Students]** タブを選択し、 **[Create New]** をクリックして、ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="b3553-191">Run the page by starting the program, selecting the **Students** tab, and then clicking **Create New**.</span></span>

3. <span data-ttu-id="b3553-192">名前と無効な日付を入力し、 **[作成]** をクリックしてエラーメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="b3553-192">Enter names and an invalid date and click **Create** to see the error message.</span></span>

    <span data-ttu-id="b3553-193">これは、既定で取得するサーバー側の検証です。</span><span class="sxs-lookup"><span data-stu-id="b3553-193">This is server-side validation that you get by default.</span></span> <span data-ttu-id="b3553-194">後のチュートリアルでは、クライアント側の検証用のコードを生成する属性を追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="b3553-194">In a later tutorial, you'll see how to add attributes that generate code for client-side validation.</span></span> <span data-ttu-id="b3553-195">次の強調表示されたコードは、 **Create**メソッドでのモデル検証チェックを示しています。</span><span class="sxs-lookup"><span data-stu-id="b3553-195">The following highlighted code shows the model validation check in the **Create** method.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]

4. <span data-ttu-id="b3553-196">日付を有効な値に変更し、 **[Create]** をクリックして、新しい学生が **[Index]** ページに表示されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="b3553-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

5. <span data-ttu-id="b3553-197">ブラウザーを閉じます。</span><span class="sxs-lookup"><span data-stu-id="b3553-197">Close the browser.</span></span>

## <a name="update-httppost-edit-method"></a><span data-ttu-id="b3553-198">HttpPost Edit メソッドの更新</span><span class="sxs-lookup"><span data-stu-id="b3553-198">Update HttpPost Edit method</span></span>

1. <span data-ttu-id="b3553-199"><xref:System.Web.Mvc.HttpPostAttribute> `Edit` アクションメソッドを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="b3553-199">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Edit` action method with the following code:</span></span>

   [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

   > [!NOTE]
   > <span data-ttu-id="b3553-200">*Controllers\StudentController.cs*では、`HttpGet Edit` メソッド (`HttpPost` 属性のないメソッド) は、`Find` メソッドを使用して、選択された `Student` エンティティを取得します。これは、`Details` メソッドで見たとおりです。</span><span class="sxs-lookup"><span data-stu-id="b3553-200">In *Controllers\StudentController.cs*, the `HttpGet Edit` method (the one without the `HttpPost` attribute) uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="b3553-201">このメソッドを変更する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="b3553-201">You don't need to change this method.</span></span>

   <span data-ttu-id="b3553-202">これらの変更は、[過剰なポスティング](#overpost)を防ぐためにセキュリティのベストプラクティスを実装します。 scaffolder は、`Bind` 属性を生成し、モデルバインダーによって作成されたエンティティを、変更されたフラグを使用してエンティティセットに追加します。</span><span class="sxs-lookup"><span data-stu-id="b3553-202">These changes implement a security best practice to prevent [overposting](#overpost), The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a Modified flag.</span></span> <span data-ttu-id="b3553-203">このコードは、`Include` パラメーターに一覧表示されていないフィールド内の既存のデータを `Bind` 属性によってクリアするため、推奨されなくなりました。</span><span class="sxs-lookup"><span data-stu-id="b3553-203">That code is no longer recommended because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span> <span data-ttu-id="b3553-204">今後、MVC コントローラー scaffolder は、Edit メソッドの `Bind` 属性を生成しないように更新されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-204">In the future, the MVC controller scaffolder will be updated so that it doesn't generate `Bind` attributes for Edit methods.</span></span>

   <span data-ttu-id="b3553-205">新しいコードは、既存のエンティティを読み取り、<xref:System.Web.Mvc.Controller.TryUpdateModel%2A> を呼び出して、ポストされたフォームデータのユーザー入力からフィールドを更新します。</span><span class="sxs-lookup"><span data-stu-id="b3553-205">The new code reads the existing entity and calls <xref:System.Web.Mvc.Controller.TryUpdateModel%2A> to update fields from user input in the posted form data.</span></span> <span data-ttu-id="b3553-206">Entity Framework の自動変更追跡では、エンティティの[EntityState](<xref:System.Data.EntityState.Modified>)フラグが設定されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-206">The Entity Framework's automatic change tracking sets the [EntityState.Modified](<xref:System.Data.EntityState.Modified>) flag on the entity.</span></span> <span data-ttu-id="b3553-207">[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)メソッドが呼び出されると、<xref:System.Data.EntityState.Modified> フラグによって、Entity Framework はデータベース行を更新する SQL ステートメントを作成します。</span><span class="sxs-lookup"><span data-stu-id="b3553-207">When the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method is called, the <xref:System.Data.EntityState.Modified> flag causes the Entity Framework to create SQL statements to update the database row.</span></span> <span data-ttu-id="b3553-208">[同時実行の競合](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)は無視され、データベースの行のすべての列が更新されます。これには、ユーザーが変更していないものも含まれます。</span><span class="sxs-lookup"><span data-stu-id="b3553-208">[Concurrency conflicts](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) are ignored, and all columns of the database row are updated, including those that the user didn't change.</span></span> <span data-ttu-id="b3553-209">(後のチュートリアルでは、同時実行の競合を処理する方法について説明し[ます。](<xref:System.Data.EntityState.Unchanged>)また、データベース内で個々のフィールドを更新するだけの場合は、エンティティを EntityState に設定し、個々のフィールドを[EntityState](<xref:System.Data.EntityState.Modified>)に設定します)。</span><span class="sxs-lookup"><span data-stu-id="b3553-209">(A later tutorial shows how to handle concurrency conflicts, and if you only want individual fields to be updated in the database, you can set the entity to [EntityState.Unchanged](<xref:System.Data.EntityState.Unchanged>) and set individual fields to [EntityState.Modified](<xref:System.Data.EntityState.Modified>).)</span></span>

   <span data-ttu-id="b3553-210">過剰な投稿を防ぐために、[編集] ページで更新できるフィールドは、`TryUpdateModel` パラメーターにホワイトリストされています。</span><span class="sxs-lookup"><span data-stu-id="b3553-210">To prevent overposting, the fields that you want to be updateable by the Edit page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="b3553-211">現在、他に保護しているフィールドはありませんが、モデル バインダーでバインドしたいフィールドをリストに入れておくと、後でデータ モデルにフィールドを追加した場合に、ここでフィールドを明示的に追加するまで、自動的にフィールドを保護できます。</span><span class="sxs-lookup"><span data-stu-id="b3553-211">Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

   <span data-ttu-id="b3553-212">これらの変更の結果、HttpPost Edit メソッドのメソッドシグネチャは、HttpGet edit メソッドと同じになります。そのため、EditPost メソッドの名前を変更しました。</span><span class="sxs-lookup"><span data-stu-id="b3553-212">As a result of these changes, the method signature of the HttpPost Edit method is the same as the HttpGet edit method; therefore you've renamed the method EditPost.</span></span>

   > [!TIP]
   >
   > <span data-ttu-id="b3553-213">**エンティティの状態と Attach メソッドと SaveChanges メソッド**</span><span class="sxs-lookup"><span data-stu-id="b3553-213">**Entity States and the Attach and SaveChanges Methods**</span></span>
   >
   > <span data-ttu-id="b3553-214">データベース コンテキストは、メモリ内のエンティティがデータベースの対応する行と同期しているかどうかを追跡しており、この情報により、`SaveChanges` メソッドを呼び出したときの処理が決まります。</span><span class="sxs-lookup"><span data-stu-id="b3553-214">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="b3553-215">たとえば、 [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx)メソッドに新しいエンティティを渡すと、そのエンティティの状態が `Added`に設定されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-215">For example, when you pass a new entity to the [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx) method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="b3553-216">次に、 [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)メソッドを呼び出すと、データベースコンテキストによって SQL `INSERT` コマンドが発行されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-216">Then when you call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method, the database context issues a SQL `INSERT` command.</span></span>
   >
   > <span data-ttu-id="b3553-217">エンティティは、次のいずれかの[状態](xref:System.Data.EntityState)になることがあります。</span><span class="sxs-lookup"><span data-stu-id="b3553-217">An entity may be in one of the following [states](xref:System.Data.EntityState):</span></span>
   >
   > - <span data-ttu-id="b3553-218">[https://login.microsoftonline.com/consumers/](`Added`)</span><span class="sxs-lookup"><span data-stu-id="b3553-218">`Added`.</span></span> <span data-ttu-id="b3553-219">エンティティがデータベースにまだ存在しません。</span><span class="sxs-lookup"><span data-stu-id="b3553-219">The entity does not yet exist in the database.</span></span> <span data-ttu-id="b3553-220">`SaveChanges` メソッドは、`INSERT` ステートメントを発行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b3553-220">The `SaveChanges` method must issue an `INSERT` statement.</span></span>
   > - <span data-ttu-id="b3553-221">[https://login.microsoftonline.com/consumers/](`Unchanged`)</span><span class="sxs-lookup"><span data-stu-id="b3553-221">`Unchanged`.</span></span> <span data-ttu-id="b3553-222">`SaveChanges` メソッドはこのエンティティに対し何も行う必要はありません。</span><span class="sxs-lookup"><span data-stu-id="b3553-222">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="b3553-223">データベースからエンティティを読み取ると、エンティティはこの状態で開始します。</span><span class="sxs-lookup"><span data-stu-id="b3553-223">When you read an entity from the database, the entity starts out with this status.</span></span>
   > - <span data-ttu-id="b3553-224">[https://login.microsoftonline.com/consumers/](`Modified`)</span><span class="sxs-lookup"><span data-stu-id="b3553-224">`Modified`.</span></span> <span data-ttu-id="b3553-225">エンティティのプロパティ値の一部またはすべてが変更されています。</span><span class="sxs-lookup"><span data-stu-id="b3553-225">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="b3553-226">`SaveChanges` メソッドは、`UPDATE` ステートメントを発行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b3553-226">The `SaveChanges` method must issue an `UPDATE` statement.</span></span>
   > - <span data-ttu-id="b3553-227">[https://login.microsoftonline.com/consumers/](`Deleted`)</span><span class="sxs-lookup"><span data-stu-id="b3553-227">`Deleted`.</span></span> <span data-ttu-id="b3553-228">エンティティには削除のマークが付けられています。</span><span class="sxs-lookup"><span data-stu-id="b3553-228">The entity has been marked for deletion.</span></span> <span data-ttu-id="b3553-229">`SaveChanges` メソッドは、`DELETE` ステートメントを発行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b3553-229">The `SaveChanges` method must issue a `DELETE` statement.</span></span>
   > - <span data-ttu-id="b3553-230">[https://login.microsoftonline.com/consumers/](`Detached`)</span><span class="sxs-lookup"><span data-stu-id="b3553-230">`Detached`.</span></span> <span data-ttu-id="b3553-231">エンティティはデータベース コンテキストによって追跡されていません。</span><span class="sxs-lookup"><span data-stu-id="b3553-231">The entity isn't being tracked by the database context.</span></span>
   >
   > <span data-ttu-id="b3553-232">デスクトップ アプリケーションにおいて、通常、状態の変更は自動的に設定されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-232">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="b3553-233">デスクトップの種類のアプリケーションでは、エンティティを読み取り、そのプロパティ値の一部を変更します。</span><span class="sxs-lookup"><span data-stu-id="b3553-233">In a desktop type of application, you read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="b3553-234">そのエンティティの状態は自動的に `Modified` に変更されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-234">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="b3553-235">次に、`SaveChanges`を呼び出すと、変更した実際のプロパティのみを更新する SQL `UPDATE` ステートメントが Entity Framework によって生成されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-235">Then when you call `SaveChanges`, the Entity Framework generates a SQL `UPDATE` statement that updates only the actual properties that you changed.</span></span>
   >
   > <span data-ttu-id="b3553-236">Web apps の接続が切断されても、この連続シーケンスは許可されません。</span><span class="sxs-lookup"><span data-stu-id="b3553-236">The disconnected nature of web apps doesn't allow for this continuous sequence.</span></span> <span data-ttu-id="b3553-237">エンティティを読み取る[Dbcontext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)は、ページが表示された後に破棄されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-237">The [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) that reads an entity is disposed after a page is rendered.</span></span> <span data-ttu-id="b3553-238">`HttpPost` `Edit` アクションメソッドが呼び出されると、新しい要求が行われ、 [Dbcontext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)の新しいインスタンスが作成されます。そのため、エンティティの状態を手動で `Modified.` に設定する必要があります。これにより、`SaveChanges`を呼び出すと、変更したプロパティを確認する方法がないため、Entity Framework はデータベース行のすべての列を更新します。</span><span class="sxs-lookup"><span data-stu-id="b3553-238">When the `HttpPost` `Edit` action method is called, a new request is made and you have a new instance of the [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx), so you have to manually set the entity state to `Modified.` Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>
   >
   > <span data-ttu-id="b3553-239">SQL `Update` ステートメントで、ユーザーが実際に変更したフィールドのみを更新する場合は、元の値を何らかの方法 (非表示フィールドなど) に保存して、`HttpPost` `Edit` メソッドが呼び出されたときに使用できるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="b3553-239">If you want the SQL `Update` statement to update only the fields that the user actually changed, you can save the original values in some way (such as hidden fields) so that they are available when the `HttpPost` `Edit` method is called.</span></span> <span data-ttu-id="b3553-240">次に、元の値を使用して `Student` エンティティを作成し、エンティティの元のバージョンで `Attach` メソッドを呼び出して、エンティティの値を新しい値に更新してから `SaveChanges.` を呼び出します。詳細については、「[エンティティの状態と SaveChanges](/ef/ef6/saving/change-tracking/entity-state)および[ローカルデータ](/ef/ef6/querying/local-data)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-240">Then you can create a `Student` entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges.` For more information, see [Entity states and SaveChanges](/ef/ef6/saving/change-tracking/entity-state) and [Local Data](/ef/ef6/querying/local-data).</span></span>

   <span data-ttu-id="b3553-241">*Views\Student\Edit.cshtml*の HTML および Razor コードは、「 *cshtml*」で説明したものと似ていますが、変更は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="b3553-241">The HTML and Razor code in *Views\Student\Edit.cshtml* is similar to what you saw in *Create.cshtml*, and no changes are required.</span></span>

2. <span data-ttu-id="b3553-242">このページを実行するには、プログラムを起動し、 **[Students]** タブを選択してから、**編集**ハイパーリンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="b3553-242">Run the page by starting the program, selecting the **Students** tab, and then clicking an **Edit** hyperlink.</span></span>

3. <span data-ttu-id="b3553-243">データをいくつか変更し、 **[Save]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="b3553-243">Change some of the data and click **Save**.</span></span> <span data-ttu-id="b3553-244">変更したデータが [インデックス] ページに表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-244">You see the changed data in the Index page.</span></span>

4. <span data-ttu-id="b3553-245">ブラウザーを閉じます。</span><span class="sxs-lookup"><span data-stu-id="b3553-245">Close the browser.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="b3553-246">削除ページを更新する</span><span class="sxs-lookup"><span data-stu-id="b3553-246">Update the Delete page</span></span>

<span data-ttu-id="b3553-247">*Controllers\StudentController.cs*では、<xref:System.Web.Mvc.HttpGetAttribute> `Delete` メソッドのテンプレートコードは `Find` メソッドを使用して、選択した `Student` エンティティを取得します。これは、`Details` メソッドと `Edit` メソッドで見たとおりです。</span><span class="sxs-lookup"><span data-stu-id="b3553-247">In *Controllers\StudentController.cs*, the template code for the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` and `Edit` methods.</span></span> <span data-ttu-id="b3553-248">ただし、`SaveChanges` の呼び出しが失敗したときのカスタム エラー メッセージを実装するには、何らかの機能とその対応するビューをこのメソッドに追加します。</span><span class="sxs-lookup"><span data-stu-id="b3553-248">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="b3553-249">更新および作成操作で見たように、削除操作にも 2 つのアクション メソッドが必要です。</span><span class="sxs-lookup"><span data-stu-id="b3553-249">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="b3553-250">GET 要求への応答として呼び出されるメソッドは、ユーザーが削除操作を承認またはキャンセルする機会を提供するビューを表示します。</span><span class="sxs-lookup"><span data-stu-id="b3553-250">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="b3553-251">ユーザーが操作を承認すると、POST 要求が作成されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-251">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="b3553-252">この場合、`HttpPost` `Delete` メソッドが呼び出され、そのメソッドが実際に削除操作を実行します。</span><span class="sxs-lookup"><span data-stu-id="b3553-252">When that happens, the `HttpPost` `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="b3553-253"><xref:System.Web.Mvc.HttpPostAttribute> `Delete` メソッドに `try-catch` ブロックを追加して、データベースの更新時に発生する可能性のあるエラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="b3553-253">You'll add a `try-catch` block to the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="b3553-254">エラーが発生した場合、<xref:System.Web.Mvc.HttpPostAttribute> `Delete` メソッドは <xref:System.Web.Mvc.HttpGetAttribute> `Delete` メソッドを呼び出し、エラーが発生したことを示すパラメーターを渡します。</span><span class="sxs-lookup"><span data-stu-id="b3553-254">If an error occurs, the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method calls the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="b3553-255">その後、<xref:System.Web.Mvc.HttpGetAttribute> `Delete` メソッドによって、確認ページがエラーメッセージと共に再表示され、ユーザーはキャンセルまたは再試行することができます。</span><span class="sxs-lookup"><span data-stu-id="b3553-255">The <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

1. <span data-ttu-id="b3553-256"><xref:System.Web.Mvc.HttpGetAttribute> `Delete` アクションメソッドを、エラー報告を管理する次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="b3553-256">Replace the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` action method with the following code, which manages error reporting:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    <span data-ttu-id="b3553-257">このコードは、変更の保存に失敗した後にメソッドが呼び出されたかどうかを示す[省略可能なパラメーター](https://msdn.microsoft.com/library/dd264739.aspx)を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="b3553-257">This code accepts an [optional parameter](https://msdn.microsoft.com/library/dd264739.aspx) that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="b3553-258">このパラメーターは、前のエラーを発生させずに `HttpGet` `Delete` メソッドが呼び出されたときに `false` ます。</span><span class="sxs-lookup"><span data-stu-id="b3553-258">This parameter is `false` when the `HttpGet` `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="b3553-259">データベース更新エラーに応答して `HttpPost` `Delete` メソッドによって呼び出された場合、パラメーターは `true` され、エラーメッセージがビューに渡されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-259">When it is called by the `HttpPost` `Delete` method in response to a database update error, the parameter is `true` and an error message is passed to the view.</span></span>

2. <span data-ttu-id="b3553-260"><xref:System.Web.Mvc.HttpPostAttribute> `Delete` アクションメソッド (名前付き `DeleteConfirmed`) を次のコードに置き換えます。このコードは、実際の削除操作を実行し、データベースの更新エラーをキャッチします。</span><span class="sxs-lookup"><span data-stu-id="b3553-260">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    <span data-ttu-id="b3553-261">このコードは、選択したエンティティを取得し、 [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx)メソッドを呼び出して、エンティティの状態を `Deleted`に設定します。</span><span class="sxs-lookup"><span data-stu-id="b3553-261">This code retrieves the selected entity, then calls the [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="b3553-262">`SaveChanges` が呼び出されると、SQL `DELETE` コマンドが生成されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-262">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="b3553-263">また、アクション メソッドの名前を `DeleteConfirmed` から `Delete` に変更しています。</span><span class="sxs-lookup"><span data-stu-id="b3553-263">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="b3553-264">`HttpPost` `Delete` メソッドという名前のスキャフォールディングコードは、`HttpPost` メソッドに一意の署名を与える `DeleteConfirmed` ます。</span><span class="sxs-lookup"><span data-stu-id="b3553-264">The scaffolded code named the `HttpPost` `Delete` method `DeleteConfirmed` to give the `HttpPost` method a unique signature.</span></span> <span data-ttu-id="b3553-265">(CLR では、オーバーロードされたメソッドで異なるメソッドパラメーターを持つ必要があります)。署名が一意であるため、MVC 規則を使用して、`HttpPost` と `HttpGet` delete メソッドに同じ名前を使用することができます。</span><span class="sxs-lookup"><span data-stu-id="b3553-265">(The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the `HttpPost` and `HttpGet` delete methods.</span></span>

    <span data-ttu-id="b3553-266">大規模なアプリケーションのパフォーマンスを向上させることが優先される場合は、`Find` と `Remove` メソッドを呼び出すコード行を次のコードに置き換えることによって、不要な SQL クエリを使用して行を取得することを回避できます。</span><span class="sxs-lookup"><span data-stu-id="b3553-266">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query to retrieve the row by replacing the lines of code that call the `Find` and `Remove` methods with the following code:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    <span data-ttu-id="b3553-267">このコードは、主キーの値のみを使用して `Student` エンティティをインスタンス化し、エンティティの状態を `Deleted`に設定します。</span><span class="sxs-lookup"><span data-stu-id="b3553-267">This code instantiates a `Student` entity using only the primary key value and then sets the entity state to `Deleted`.</span></span> <span data-ttu-id="b3553-268">エンティティを削除するために Entity Framework に必要なものは主キーの値だけです</span><span class="sxs-lookup"><span data-stu-id="b3553-268">That's all that the Entity Framework needs in order to delete the entity.</span></span>

    <span data-ttu-id="b3553-269">前述のように、`HttpGet` `Delete` メソッドはデータを削除しません。</span><span class="sxs-lookup"><span data-stu-id="b3553-269">As noted, the `HttpGet` `Delete` method doesn't delete the data.</span></span> <span data-ttu-id="b3553-270">GET 要求に応答して削除操作を実行する (または、任意の編集操作、作成操作、またはデータを変更するその他の操作を実行する) と、セキュリティ上のリスクが生じます。</span><span class="sxs-lookup"><span data-stu-id="b3553-270">Performing a delete operation in response to a GET request (or for that matter, performing any edit operation, create operation, or any other operation that changes data) creates a security risk.</span></span> <span data-ttu-id="b3553-271">詳細については、「ASP.NET MVC Tip #46」を参照してください。 Stephen Walther のブログに[セキュリティホールが作成されるため、削除リンクは使用しない](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx)でください。</span><span class="sxs-lookup"><span data-stu-id="b3553-271">For more information, see [ASP.NET MVC Tip #46 — Don't use Delete Links because they create Security Holes](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) on Stephen Walther's blog.</span></span>

3. <span data-ttu-id="b3553-272">*Views\Student\Delete.cshtml*で、次の例に示すように、`h2` 見出しと `h3` 見出しの間にエラーメッセージを追加します。</span><span class="sxs-lookup"><span data-stu-id="b3553-272">In *Views\Student\Delete.cshtml*, add an error message between the `h2` heading and the `h3` heading, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

4. <span data-ttu-id="b3553-273">このページを実行するには、プログラムを起動し、 **[Students]** タブを選択し、 **[Delete]** hyperlink をクリックします。</span><span class="sxs-lookup"><span data-stu-id="b3553-273">Run the page by starting the program, selecting the **Students** tab, and then clicking a **Delete** hyperlink.</span></span>

5. <span data-ttu-id="b3553-274">ページで **[削除]** を選択します。これを削除します**か?**</span><span class="sxs-lookup"><span data-stu-id="b3553-274">Choose **Delete** on the page that says **Are you sure you want to delete this?**.</span></span>

    <span data-ttu-id="b3553-275">削除された学生を含まないインデックスページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-275">The Index page displays without the deleted student.</span></span> <span data-ttu-id="b3553-276">([同時実行のチュートリアル](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)で動作しているエラー処理コードの例については、「」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="b3553-276">(You'll see an example of the error handling code in action in the [concurrency tutorial](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="b3553-277">データベース接続を閉じる</span><span class="sxs-lookup"><span data-stu-id="b3553-277">Close database connections</span></span>

<span data-ttu-id="b3553-278">データベース接続を閉じて、できるだけ早く保持するリソースを解放するには、終了時にコンテキストインスタンスを破棄します。</span><span class="sxs-lookup"><span data-stu-id="b3553-278">To close database connections and free up the resources they hold as soon as possible, dispose the context instance when you are done with it.</span></span> <span data-ttu-id="b3553-279">このため、スキャフォールディングコードでは、次の例に示すように、 *StudentController.cs*の `StudentController` クラスの末尾に[Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx)メソッドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="b3553-279">That is why the scaffolded code provides a [Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx) method at the end of the `StudentController` class in *StudentController.cs*, as shown in the following example:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

<span data-ttu-id="b3553-280">基本 `Controller` クラスは、既に `IDisposable` インターフェイスを実装しているため、このコードは単にオーバーライドを `Dispose(bool)` メソッドに追加して、コンテキストインスタンスを明示的に破棄します。</span><span class="sxs-lookup"><span data-stu-id="b3553-280">The base `Controller` class already implements the `IDisposable` interface, so this code simply adds an override to the `Dispose(bool)` method to explicitly dispose the context instance.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="b3553-281">トランザクションを処理する</span><span class="sxs-lookup"><span data-stu-id="b3553-281">Handle transactions</span></span>

<span data-ttu-id="b3553-282">既定では、Entity Framework はトランザクションを暗黙的に実装します。</span><span class="sxs-lookup"><span data-stu-id="b3553-282">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="b3553-283">複数の行またはテーブルを変更してから `SaveChanges`を呼び出す場合、Entity Framework によって自動的にすべての変更が成功するか、すべて失敗するかが自動的に決定されます。</span><span class="sxs-lookup"><span data-stu-id="b3553-283">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or all fail.</span></span> <span data-ttu-id="b3553-284">一部の変更が完了した後でエラーが発生した場合、それらの変更は自動的にロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="b3553-284">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="b3553-285">より多くの制御&mdash;必要なシナリオ (トランザクションで Entity Framework の外部で行われた操作を含める場合など) については&mdash;「[トランザクションの使用](/ef/ef6/saving/transactions)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-285">For scenarios where you need more control&mdash;for example, if you want to include operations done outside of Entity Framework in a transaction&mdash;see [Working with Transactions](/ef/ef6/saving/transactions).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="b3553-286">コードの入手</span><span class="sxs-lookup"><span data-stu-id="b3553-286">Get the code</span></span>

[<span data-ttu-id="b3553-287">完成したプロジェクトのダウンロード</span><span class="sxs-lookup"><span data-stu-id="b3553-287">Download Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="b3553-288">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="b3553-288">Additional resources</span></span>

<span data-ttu-id="b3553-289">これで、`Student` エンティティに対して単純な CRUD 操作を実行する一連のページが完成しました。</span><span class="sxs-lookup"><span data-stu-id="b3553-289">You now have a complete set of pages that perform simple CRUD operations for `Student` entities.</span></span> <span data-ttu-id="b3553-290">MVC ヘルパーを使用して、データフィールドの UI 要素を生成した。</span><span class="sxs-lookup"><span data-stu-id="b3553-290">You used MVC helpers to generate UI elements for data fields.</span></span> <span data-ttu-id="b3553-291">MVC ヘルパーの詳細については、「 [HTML ヘルパーを使用したフォームのレンダリング](/previous-versions/aspnet/dd410596(v=vs.98))」を参照してください (mvc 3 向けの記事ですが、mvc 5 には引き続き関連します)。</span><span class="sxs-lookup"><span data-stu-id="b3553-291">For more info about MVC helpers, see [Rendering a Form Using HTML Helpers](/previous-versions/aspnet/dd410596(v=vs.98)) (the article is for MVC 3 but is still relevant for MVC 5).</span></span>

<span data-ttu-id="b3553-292">他の EF 6 リソースへのリンクについては、「 [ASP.NET Data Access-推奨リソース](../../../../whitepapers/aspnet-data-access-content-map.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-292">Links to other EF 6 resources can be found in [ASP.NET Data Access - Recommended Resources](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="b3553-293">次のステップ</span><span class="sxs-lookup"><span data-stu-id="b3553-293">Next steps</span></span>

<span data-ttu-id="b3553-294">このチュートリアルでは、次のことを行いました。</span><span class="sxs-lookup"><span data-stu-id="b3553-294">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="b3553-295">詳細ページを作成しました</span><span class="sxs-lookup"><span data-stu-id="b3553-295">Created a Details page</span></span>
> * <span data-ttu-id="b3553-296">Create ページを更新した</span><span class="sxs-lookup"><span data-stu-id="b3553-296">Updated the Create page</span></span>
> * <span data-ttu-id="b3553-297">HttpPost Edit メソッドを更新しました</span><span class="sxs-lookup"><span data-stu-id="b3553-297">Updated the HttpPost Edit method</span></span>
> * <span data-ttu-id="b3553-298">Delete ページを更新した</span><span class="sxs-lookup"><span data-stu-id="b3553-298">Updated the Delete page</span></span>
> * <span data-ttu-id="b3553-299">データベース接続を閉じた</span><span class="sxs-lookup"><span data-stu-id="b3553-299">Closed database connections</span></span>
> * <span data-ttu-id="b3553-300">処理されたトランザクション</span><span class="sxs-lookup"><span data-stu-id="b3553-300">Handled transactions</span></span>

<span data-ttu-id="b3553-301">次の記事に進み、並べ替え、フィルター処理、およびページングをプロジェクトに追加する方法を学習してください。</span><span class="sxs-lookup"><span data-stu-id="b3553-301">Advance to the next article to learn how to add sorting, filtering, and paging to the project.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="b3553-302">並べ替え、フィルター処理、ページング</span><span class="sxs-lookup"><span data-stu-id="b3553-302">Sorting, Filtering, and Paging</span></span>](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)
