---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/distributed-caching
title: 分散キャッシュ (Azure を使用した実際のクラウド アプリの構築) |マイクロソフトドキュメント
author: MikeWasson
description: Azure 電子書籍を使用したリアル ワールド クラウド アプリの構築は、スコット ガスリーが開発したプレゼンテーションに基づいています。 それは彼ができる13のパターンと実践を説明します.
ms.author: riande
ms.date: 07/20/2015
ms.assetid: 406518e9-3817-49ce-8b90-e82bc461e2c0
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/distributed-caching
msc.type: authoredcontent
ms.openlocfilehash: 87a7516415895e761d1589fd459b93e5c15c0f85
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675659"
---
# <a name="distributed-caching-building-real-world-cloud-apps-with-azure"></a>分散キャッシュ (Azure を使用した実際のクラウド アプリの構築)

[マイク・ワッソン](https://github.com/MikeWasson),[リック・アンダーソン](https://twitter.com/RickAndMSFT),[トム・ダイクストラ](https://github.com/tdykstra)

[修正イットプロジェクトをダウンロード](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)するか[、電子書籍をダウンロード](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)

> Azure 電子書籍**を使用したリアル ワールド クラウド アプリの構築**は、スコット ガスリーが開発したプレゼンテーションに基づいています。 クラウド向けの Web アプリの開発を成功させるために役立つ 13 のパターンとプラクティスについて説明します。 電子書籍の詳細については、[最初の章を](introduction.md)参照してください。

前の章では、一時的な障害処理について説明し、サーキット ブレーカー戦略としてキャッシュについて説明しました。 この章では、キャッシュの使用時期、使用する一般的なパターン、Azure での実装方法など、キャッシュの詳細について説明します。

## <a name="what-is-distributed-caching"></a>分散キャッシュとは

キャッシュは、データをメモリに格納することで、高スループット、一般的にアクセスされるアプリケーション データへの低遅延アクセスを提供します。 クラウド アプリの場合、最も有用な種類のキャッシュは分散キャッシュであり、データは個々の Web サーバーのメモリではなく他のクラウド リソースに格納され、キャッシュされたデータはアプリケーションのすべての Web サーバー (またはアプリケーションで使用されるその他のクラウド VM) で使用できるようになります。

![同じキャッシュ サーバーにアクセスする複数の Web サーバーを示す図](distributed-caching/_static/image1.png)

サーバーを追加または削除してアプリケーションを拡張したり、アップグレードや障害によってサーバーを置き換えたりした場合、キャッシュされたデータは、アプリケーションを実行するすべてのサーバーからアクセス可能です。

永続データ ストアの待機時間の長いデータ アクセスを回避することで、キャッシュを使用するとアプリケーションの応答性を大幅に向上させることができます。 たとえば、キャッシュからデータを取得する方が、リレーショナル データベースから取得する場合よりもはるかに高速です。

キャッシュの利点は、永続データ ストアへのトラフィックを減らすことで、永続データ ストアのデータ出力料金が発生した場合にコストが下がることがあります。

## <a name="when-to-use-distributed-caching"></a>分散キャッシュを使用する場合

キャッシュは、データの書き込みよりも多くの読み取りを行うアプリケーション ワークロード、およびデータ モデルがキャッシュ内のデータの格納と取得に使用するキー/値の編成をサポートする場合に最適です。 また、アプリケーション ユーザーが多くの共通データを共有する場合にも便利です。たとえば、各ユーザーが通常そのユーザーに固有のデータを取得する場合、キャッシュは多くの利点を提供しません。 キャッシュが非常に有益である可能性がある例は、データが頻繁に変更されることはないので、製品カタログであり、すべての顧客が同じデータを見ているためです。

永続データ ストアのスループット制限と遅延遅延がアプリケーション全体のパフォーマンスに対して制限を強められるようになるにつれて、キャッシュのメリットは、アプリケーションのスケールが大きくなるほど、ますます測定可能になります。 ただし、パフォーマンス以外の理由でキャッシュを実装する場合もあります。 ユーザーに表示されたときに完全に最新である必要のないデータの場合、キャッシュ アクセスは、永続データ ストアが応答しないか使用できない場合のサーキット ブレーカーとして機能します。

## <a name="popular-cache-population-strategies"></a>人気のキャッシュ作成戦略

キャッシュからデータを取得するには、まずそこにデータを格納する必要があります。 必要なデータをキャッシュに取り込むには、次のような方法があります。

- オンデマンド/キャッシュアサイド

    アプリケーションはキャッシュからデータを取得しようとし、キャッシュにデータがない場合 (「ミス」)、次回にデータを使用できるようにキャッシュに格納します。 次回アプリケーションが同じデータを取得しようとすると、キャッシュ内で探しているもの(「ヒット」)が見つかります。 データベースで変更されたキャッシュ されたデータをフェッチしないようにするには、データ ストアを変更するときにキャッシュを無効にします。
- バックグラウンドデータプッシュ

    バックグラウンド サービスは定期的にデータをキャッシュにプッシュし、アプリは常にキャッシュからプルします。 この方法は、常に最新のデータを返す必要のない高待機時間のデータ ソースで効果的です。
- サーキット ブレーカー

    アプリケーションは通常、永続データ ストアと直接通信しますが、永続データ ストアに可用性の問題がある場合、アプリケーションはキャッシュからデータを取得します。 キャッシュまたはバックグラウンド データ プッシュ戦略を使用して、データがキャッシュに格納されている可能性があります。 これは、パフォーマンス向上戦略ではなく、障害処理戦略です。

キャッシュ内のデータを最新の状態に保つために、アプリケーションでデータを作成、更新、または削除するときに、関連するキャッシュ エントリを削除できます。 アプリケーションが、少し古いデータを取得する場合は、構成可能な有効期限に依存して、古いキャッシュ データのサイズに制限を設定できます。

絶対有効期限 (キャッシュ項目が作成されてからの時間) またはスライディング有効期限 (キャッシュ項目が最後にアクセスされてからの時間) を構成できます。 絶対有効期限は、データが古くなりすぎないようにキャッシュの有効期限メカニズムに依存している場合に使用されます。 Fix It アプリでは、古いキャッシュ項目を手動で削除し、最新のデータをキャッシュに保持するために、スライディング有効期限を使用します。 選択した有効期限ポリシーに関係なく、キャッシュのメモリ制限に達すると、キャッシュは最も古い (最も古い (最も使用された最も古いまたは LRU) 項目を自動的に削除します。

## <a name="sample-cache-aside-code-for-fix-it-app"></a>Fix It アプリのキャッシュアサイド コードのサンプル

次のサンプル コードでは、Fix It タスクを取得するときに最初にキャッシュを確認します。 タスクがキャッシュ内で見つかった場合は、それを返します。見つからなかった場合は、データベースから取得し、キャッシュに格納します。 `FindTaskByIdAsync`メソッドにキャッシュを追加するために行う変更が強調表示されます。

[!code-csharp[Main](distributed-caching/samples/sample1.cs?highlight=5,9-11,13-15,19)]

修正タスクを更新または削除する場合、キャッシュされたタスクを無効にする (削除する) 必要があります。 それ以外の場合、そのタスクの読み取りを試みると、キャッシュから古いデータが引き続き取得されます。

[!code-csharp[Main](distributed-caching/samples/sample2.cs?highlight=7)]

これらは、単純なキャッシュ コードを示すサンプルです。キャッシュは、ダウンロード可能な Fix It プロジェクトに実装されていません。

## <a name="azure-caching-services"></a>Azure キャッシュ サービス

Azure では、次のキャッシュ サービスを提供しています: [Azure Redis キャッシュ](https://msdn.microsoft.com/library/dn690523.aspx)と Azure[マネージ キャッシュ](https://msdn.microsoft.com/library/dn386094.aspx)。 Azure Redis キャッシュは、一般的な[オープン ソース Redis Cache](http://redis.io/)に基づいており、ほとんどのキャッシュ シナリオで最初に選択されます。

<a id="sessionstate"></a>
## <a name="aspnet-session-state-using-a-cache-provider"></a>キャッシュ プロバイダーを使用したセッション状態のASP.NET

[Web 開発のベスト プラクティスの章](web-development-best-practices.md)で説明したように、セッション状態の使用を避けることをお勧めします。 アプリケーションでセッション状態が必要な場合、次のベスト プラクティスは、スケール アウト (Web サーバーの複数インスタンス) が有効にならないため、既定のメモリ内プロバイダーを使用しないようにすることです。 SQL Serversql Server セッション状態プロバイダASP.NETは、複数の Web サーバー上で実行されるサイトでセッション状態を使用できますが、メモリ内プロバイダと比較して待ち時間の長いコストが発生します。 セッション状態を使用する必要がある場合の最適な解決策は[、Azure Cache のセッション状態プロバイダー](https://msdn.microsoft.com/library/windowsazure/gg185668.aspx)などのキャッシュ プロバイダーを使用することです。

## <a name="summary"></a>まとめ

Fix It アプリでキャッシュを実装して応答時間とスケーラビリティを向上させ、データベースが利用できないときに読み取り操作に対してアプリが応答し続けることを確認しました。 次の[章](queue-centric-work-pattern.md)では、スケーラビリティをさらに向上させ、アプリが書き込み操作に対して応答し続ける方法を示します。

## <a name="resources"></a>リソース

キャッシュの詳細については、次のリソースを参照してください。

ドキュメント

- [Azure キャッシュ](https://msdn.microsoft.com/library/gg278356.aspx). Azure でのキャッシュに関する MSDN の公式ドキュメント。
- [マイクロソフトのパターンとプラクティス - Azure ガイダンス](https://msdn.microsoft.com/library/dn568099.aspx). 「キャッシュ ガイダンス」および「キャッシュ アサイド パターン」を参照してください。
- [フェールセーフ: 復元性のあるクラウド アーキテクチャのガイダンス](https://msdn.microsoft.com/library/windowsazure/jj853352.aspx): マルク・メルクリ、ウルリッヒ・ホーマン、アンドリュー・タウンヒルのホワイトペーパー。 キャッシュのセクションを参照してください。
- [Azure クラウド サービスでの大規模サービスの設計に関するベスト プラクティス](https://msdn.microsoft.com/library/windowsazure/jj717232.aspx) 西 マーク・シムズとマイケル・トマシーによるホワイトペーパー。 分散キャッシュのセクションを参照してください。
- [スケーラビリティへのパス上の分散キャッシュ](https://msdn.microsoft.com/magazine/dd942840.aspx): 古い (2009) MSDN マガジンの記事ですが、一般的に分散キャッシュの概要を明確に記述します。は、フェールセーフおよびベスト プラクティスのホワイト ペーパーのキャッシュ セクションよりも詳細に説明されています。

ビデオ

- [フェイルセーフ: スケーラブルで回復力のあるクラウド サービスの構築](https://channel9.msdn.com/Series/FailSafe) ウルリッヒ・ホーマン、マルク・メルクリ、マーク・シムズによる9部構成のシリーズ。 クラウド アプリの設計方法を 400 レベルで表示します。 このシリーズは理論と理由に焦点を当てています。詳細については、マーク・シムズの「ビルディング・ビッグ」シリーズを参照してください。 エピソード 3 の 1:24:14 以降のキャッシングに関する説明を参照してください。
- [大きな建物: Azure のお客様から学んだ教訓 - パート I](https://channel9.msdn.com/Events/Build/2012/3-029).サイモン・デイヴィスは、46:00から始まる分散キャッシュについて議論します。 フェイルセーフシリーズと同様ですが、より多くの方法の詳細に入ります。 プレゼンテーションは 2012 年 10 月 31 日に提供されましたが、2013 年に導入された Azure App Service の Web アプリのキャッシュ サービスは対象外です。

コード サンプル

- [Azure のクラウド サービスの基礎](https://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649). 分散キャッシュを実装するサンプル アプリケーション。 付属のブログ記事[「クラウド サービスの基礎 - キャッシュの基礎](https://blogs.msdn.com/b/windowsazure/archive/2013/10/03/cloud-service-fundamentals-caching-basics.aspx)」を参照してください。

> [!div class="step-by-step"]
> [前へ](transient-fault-handling.md)
> [次へ](queue-centric-work-pattern.md)
