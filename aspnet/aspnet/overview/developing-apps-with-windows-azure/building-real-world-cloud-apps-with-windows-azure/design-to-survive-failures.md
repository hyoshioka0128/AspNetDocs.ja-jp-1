---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/design-to-survive-failures
title: 障害に耐えられるように設計される (Azure を使用した実際のクラウドアプリの構築) |Microsoft Docs
author: MikeWasson
description: Azure 電子ブックを使用した実際のクラウドアプリの構築は、Scott Guthrie によって開発されたプレゼンテーションに基づいています。 13のパターンとベストプラクティスについて説明します。
ms.author: riande
ms.date: 06/12/2014
ms.assetid: 364ce84e-5af8-4e08-afc9-75a512b01f84
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/design-to-survive-failures
msc.type: authoredcontent
ms.openlocfilehash: 348232af531b5d53dc3cb46d6d2c7931d95a572d
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/19/2020
ms.locfileid: "77457129"
---
# <a name="design-to-survive-failures-building-real-world-cloud-apps-with-azure"></a>障害に耐えられるように設計する (Azure を使用した実際のクラウドアプリの構築)

[Mike Wasson](https://github.com/MikeWasson)、 [Rick Anderson](https://twitter.com/RickAndMSFT)、 [Tom Dykstra](https://github.com/tdykstra)

[修正 It プロジェクトをダウンロード](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)するか[、電子書籍をダウンロード](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)します

> Azure 電子ブック**を使用した実際のクラウドアプリの構築**は、Scott Guthrie によって開発されたプレゼンテーションに基づいています。 ここでは、クラウド用の web アプリの開発を成功させるのに役立つ13のパターンとプラクティスについて説明します。 電子書籍の詳細については、[最初の章](introduction.md)を参照してください。

どのような種類のアプリケーションを構築する場合でも、特に、多くの人がそのアプリケーションを使用する場合は、アプリを設計して、エラーを適切に処理し、次のように価値を提供することができます。得る. 十分な時間があれば、環境やソフトウェアシステムによっては問題が発生します。 アプリでこのような状況がどのように処理されるかによって、顧客がどのように問題を分析して解決する必要があるかが決まります。

## <a name="types-of-failures"></a>エラーの種類

処理するエラーには、次の2つの基本的なカテゴリがあります。

- 断続的なネットワーク接続の問題など、一時的な自己復旧エラー。
- 永続的による介入が必要なエラー。

一時的な障害については、再試行ポリシーを実装することで、アプリのほとんどの時間をすばやく自動的に復旧できます。 お客様は、応答時間が少し長くなることがありますが、それ以外の場合は影響を受けません。 これらのエラーを処理する方法については、「一時的なエラー処理」の[章](transient-fault-handling.md)を参照してください。

永続的の障害については、問題が発生したときにすぐに通知する監視機能とログ機能を実装して、根本原因の分析を容易にすることができます。 [監視とテレメトリ](monitoring-and-telemetry.md)に関する章で、この種のエラーを確認するためのいくつかの方法を紹介します。

## <a name="failure-scope"></a>エラーの範囲

また、障害の範囲 (1 台のコンピューターに影響があるかどうか、SQL Database やストレージなどのサービス全体、またはリージョン全体を考慮する必要があります。

![エラーの範囲](design-to-survive-failures/_static/image1.png)

### <a name="machine-failures"></a>コンピューターの障害

Azure では、障害が発生したサーバーは自動的に新しいものに置き換えられ、適切に設計されたクラウドアプリは、この種の障害から自動的に迅速に復旧します。 前述のように、ステートレスな web 層のスケーラビリティの利点は、状態のもう1つの利点として、障害が発生したサーバーからの回復が簡単です。 回復の容易さは、SQL Database や Azure App Service Web Apps など、サービスとしてのプラットフォーム (PaaS) 機能の利点の1つでもあります。 ハードウェア障害はめったに発生しませんが、これらのサービスが発生すると自動的に処理されます。これらのサービスのいずれかを使用しているときに、コンピューターの障害を処理するコードを記述する必要もありません。

### <a name="service-failures"></a>サービスエラー

クラウドアプリは、通常、複数のサービスを使用します。 たとえば、[It アプリの修正] を使用すると、SQL Database サービス、ストレージサービス、および web アプリが Azure App Service にデプロイされます。 依存しているサービスの1つが失敗した場合、アプリはどうなりますか。 サービスエラーによっては、"申し訳ございません。後でもう一度やり直してください" というメッセージが表示されることがあります。 しかし、多くのシナリオでは、パフォーマンスを向上させることができます。 たとえば、バックエンドのデータストアがダウンしている場合は、ユーザーの入力を受け入れ、"要求が受信されました" と表示して、入力場所を一時的に保存することができます。その後、必要なサービスが再び動作するようになったら、入力を取得して処理することができます。

[キュー中心の作業パターン](queue-centric-work-pattern.md)の章では、このシナリオを処理する1つの方法を示しています。 Fix It app は SQL Database にタスクを保存しますが、SQL Database がダウンしているときは作業を終了する必要はありません。 この章では、タスクのユーザー入力をキューに格納し、ワーカープロセスを使用してキューを読み取り、タスクを更新する方法について説明します。 SQL がダウンしても、修正プログラムの It タスクを作成する機能に影響はありません。SQL Database が使用可能な場合、ワーカープロセスは新しいタスクを待機して処理できます。

### <a name="region-failures"></a>リージョンの障害

リージョン全体で障害が発生する可能性があります。 自然災害によってデータセンターが破壊される可能性があります。これは、meteor によってフラット化される可能性があります。データセンターへのトランク回線は、farmer によって急増しています。アプリが stricken データセンターでホストされている場合は、どうすればよいでしょうか。 Azure でアプリを複数のリージョンで同時に実行するように設定することができます。これにより、障害が発生した場合でも、別のリージョンで実行し続けることができます。 このようなエラーは非常にまれであり、ほとんどのアプリは、この種の障害によってサービスが中断されないようにするために必要なやっかいを飛ばしません。 リージョンで障害が発生してもアプリを使用できるようにする方法については、章の最後の「リソース」セクションを参照してください。

Azure の目標は、このようなすべてのエラーをより簡単に処理できるようにすることです。次の章では、その方法の例をいくつか紹介します。

## <a name="slas"></a>SLA

多くの場合、クラウド環境でのサービスレベルアグリーメント (Sla) について話します。 基本的に、これらは、企業がサービスの信頼性を確保することを約束します。 99.9% の SLA は、サービスが正常に動作していることを、99.9% の時間において期待する必要があることを意味します。 これは SLA の非常に一般的な値であり、非常に高い数値のように聞こえますが、実際にどれだけダウンタイムが発生しているかわからない可能性があります。 次の表では、1年、1か月、および1週間にわたって、さまざまな SLA の割合がどの程度に増加しているかを示しています。

![SLA テーブル](design-to-survive-failures/_static/image2.png)

そのため、99.9% の SLA は、サービスが1年間または43.2 分のうちに8.76 時間ダウンする可能性があることを意味します。 これは、ほとんどの方よりもダウンタイムが高くなります。 開発者は、ある程度のダウンタイムが発生し、それを適切な方法で処理できることを知っておく必要があります。 ある時点で、だれかがアプリを使用しようとしていて、サービスが停止しているときに、顧客に対する悪影響を最小限に抑えたいと考えています。

SLA について理解しておくべき点の1つは、どのタイムフレームが参照するかということです。時計は毎週、毎月、または毎年リセットされますか。 Azure では、毎年の sla よりも月ごとに時計をリセットします。これは、毎年の SLA によって、一連の適切な月にその月がずれてしまう可能性があるためです。

もちろん、SLA よりも常に優れた目指しがあります。通常は、これよりもはるかに少なくなります。 約束は、ダウンタイムの最大値よりも長い時間が経過すると、返金を求めることができるということです。 返される金額は、超過したダウンタイムのビジネスへの影響を完全に補正することはできませんが、SLA の側面は実施ポリシーとして機能し、非常に真剣であることを知ることができます。

### <a name="composite-slas"></a>複合 SLA

Sla を検討する際に考慮すべき重要な点は、アプリで複数のサービスを使用することによる影響です。各サービスには個別の SLA があります。 たとえば、It アプリの修正プログラムでは、Web Apps、Azure Storage、および SQL Database Azure App Service 使用します。 次に示すのは、この電子書籍が2013年12月に作成された日からの SLA 番号です。

![SLA Web サイト、ストレージ、SQL Database](design-to-survive-failures/_static/image3.png)

これらのサービス Sla に基づいてアプリに期待される最大ダウンタイムは何ですか? ダウンタイムは、SLA の最低パーセント値、または99.9% の場合と同じであると考えられます。 これは、3つのサービスすべてが同時に失敗した場合にも当てはまりますが、実際には必ずしも失敗します。 各サービスは異なるタイミングで個別に失敗する可能性があるため、個々の SLA 番号を乗算して複合 SLA を計算する必要があります。

![複合 SLA](design-to-survive-failures/_static/image4.png)

そのため、アプリは1か月に43.2 分しかなく、1か月では108分、引き続き Azure SLA の制限内にある可能性があります。

この問題は、Azure に固有のものではありません。 実際には、利用可能なクラウドサービスの最高のクラウド Sla が提供されます。また、ベンダーのクラウドサービスを使用する場合は、同様の問題が発生します。 ここでは、顧客またはユーザーに影響が及ぶ可能性が高いため、不可避のサービスエラーを適切に処理するようにアプリを設計する方法を検討することが重要です。

### <a name="cloud-slas-compared-to-enterprise-down-time-experience"></a>エンタープライズのダウンタイムエクスペリエンスと比較したクラウド Sla

"私のエンタープライズアプリでは、これらの問題は発生しません" ということがあります。 月のどれだけのダウンタイムが発生したかを確認すると、通常は "それはときどき発生します。" と言います。 また、その頻度をたずねると、"新しいサーバーのバックアップまたはインストールやソフトウェアの更新が必要になることがあります" というメッセージが表示されます。 もちろん、これはダウンタイムとしてカウントされます。 特にミッションクリティカルでない限り、ほとんどのエンタープライズアプリは、サービスの Sla によって許容される時間を超えて実際にダウンします。 しかし、お客様のサーバーとインフラストラクチャがあり、it 担当者が責任を持っている場合、ダウンタイムについての判断が少なくなる傾向があります。 クラウド環境では、他のユーザーに依存しており、何が起こっているかがわかりません。そのため、心配が増える傾向があります。

企業は、クラウドの SLA から得られるよりも長い時間の割合を達成すると、ハードウェアに対してはるかに多くの費用をかけて処理を行います。 クラウドサービスはこれを行うことができますが、そのサービスに対してさらに多くの課金を行う必要があります。 代わりに、コスト効率に優れたサービスを利用し、ソフトウェアを設計して、避けられない障害によって顧客の中断が最小限に抑えられるようにします。 クラウドアプリデザイナーとしてのジョブは、障害を回避するためにはあまり多くありません。これは、ハードウェアではなく、ソフトウェアに焦点を当てることによって行われます。 エンタープライズアプリでは、障害が発生するまでの平均時間を最大化することに努めていますが、クラウドアプリは回復の平均時間を最小限に抑えるよう努めています

### <a name="not-all-cloud-services-have-slas"></a>すべてのクラウドサービスに Sla があるわけではありません

また、すべてのクラウドサービスに SLA があるわけではないことにも注意してください。 アプリがサービスに依存していて、時間の保証がない場合は、想像以上に長くなる可能性があります。 たとえば、Facebook や Twitter などのソーシャルプロバイダーを使用してサイトへのログインを有効にした場合は、サービスプロバイダーに確認して SLA があるかどうかを確認し、存在しないことを確認します。 ただし、認証サービスがダウンした場合、または認証サービスがスローした要求の量をサポートできない場合、顧客はアプリからロックアウトされます。 数日またはそれ以上の時間がかかる可能性があります。 1つの新しいアプリの作成者は、何百ものダウンロードを必要とし、Facebook 認証に依存していましたが、そのサービスに対する SLA がないということがわかったので、Facebook とは通信しませんでした。

### <a name="not-all-downtime-counts-toward-slas"></a>すべてのダウンタイムが Sla に対してカウントされない

一部のクラウドサービスは、アプリで過剰に使用されている場合にサービスを意図的に拒否することがあります。 これは "*調整*" と呼ばれます。 サービスに SLA が適用されている場合は、調整される可能性がある条件を指定する必要があります。また、アプリの設計では、これらの条件を回避し、発生した場合に調整に適切に対応する必要があります。 たとえば、1秒あたりに特定の数を超えたときにサービスへの要求が失敗し始めた場合、自動再試行が行われないようにして、調整が続行されるようにする必要があります。 [一時的なエラー処理の章](transient-fault-handling.md)では、スロットルについてさらに説明します。

## <a name="summary"></a>要約

この章では、障害を適切に維持するために、実際のクラウドアプリを設計する必要がある理由について説明しました。 [次の章](monitoring-and-telemetry.md)から、このシリーズの残りのパターンは、そのために使用できるいくつかの方法についてさらに詳しく説明します。

- 適切な[監視とテレメトリ](monitoring-and-telemetry.md)を用意することで、介入が必要な障害について迅速に把握し、問題を解決するのに十分な情報が得られます。
- インテリジェントな再試行ロジックを実装することによって[一時的なエラーを処理](transient-fault-handling.md)します。これにより、アプリは、できないときに自動的に復旧され、[サーキットブレーカー](transient-fault-handling.md#circuitbreakers)ロジックにフォールバックできます。
- [分散キャッシュ](distributed-caching.md)を使用すると、データベースアクセスのスループット、待機時間、および接続の問題を最小限に抑えることができます。
- [キュー中心の作業パターン](queue-centric-work-pattern.md)を介して疎結合を実装します。これにより、バックエンドがダウンしてもアプリのフロントエンドが引き続き動作するようになります。

## <a name="resources"></a>リソース

詳細については、この電子ブックの後の章と次のリソースを参照してください。

ドキュメント:

- [フェイルセーフ: 回復力のあるクラウドアーキテクチャに関するガイダンス](https://msdn.microsoft.com/library/windowsazure/jj853352.aspx)。 ホワイトペーパー (Marc Mercuri、Ulrich Homann、Andrew Townhill)。 フェールセーフビデオシリーズの Web ページバージョン。
- [Azure Cloud Services で大規模なサービスを設計するためのベストプラクティス](https://msdn.microsoft.com/library/windowsazure/jj717232.aspx)。 マーク Simm と Michael Thomassy によるホワイトペーパー。
- [Azure のビジネス継続性に関する技術ガイダンス](https://msdn.microsoft.com/library/windowsazure/hh873027.aspx)。 ホワイトペーパー (パトリック Wickline と Jason Roth)。
- [Azure アプリケーションのディザスターリカバリーと高可用性](https://msdn.microsoft.com/library/windowsazure/dn251004.aspx)。 Michael McKeown、Jason、Roth、およびその他のホワイトペーパー。
- [Microsoft のパターンとプラクティス-Azure のガイダンス](https://msdn.microsoft.com/library/dn568099.aspx)。 「マルチデータセンターのデプロイに関するガイダンス」、「サーキットブレーカーパターン」を参照してください。
- [Azure サポート-サービスレベルアグリーメント](https://azure.microsoft.com/support/legal/sla/)。
- [Azure SQL Database でのビジネス継続性](https://msdn.microsoft.com/library/windowsazure/hh852669.aspx)。 SQL Database の高可用性とディザスターリカバリーの機能について説明します。
- [Azure Virtual Machines での SQL Server の高可用性とディザスターリカバリー](https://msdn.microsoft.com/library/windowsazure/jj870962.aspx)。

ビデオ:

- [フェイルセーフ: スケーラブルで回復力のある Cloud Services を構築](https://channel9.msdn.com/Series/FailSafe)します。 Ulrich Homann、Marc Mercuri、Mark Simm による9パートシリーズ。 高度な概念とアーキテクチャの原則を、非常にアクセスしやすく興味深い方法で紹介します。実際の顧客との Microsoft カスタマーアドバイザリチーム (CAT) エクスペリエンスによってストーリーが描画されます。 エピソード1と8では、障害が発生しないようにクラウドアプリを設計する理由について詳しく取り上げています。 また、49:57 以降のエピソード2でのスロットルに関するフォローアップの説明、56:05 から始まるエピソード2の障害点と障害モードの説明、およびエピソード3の40:55 におけるサーキットブレーカーの説明も参照してください。
- [大規模な構築: Azure のお客様から学んだ教訓-パート II](https://channel9.msdn.com/Events/Build/2012/3-030)。 Simm マークは、エラーの設計とすべてのインストルメント化について話します。 フェイルセーフシリーズに似ていますが、さらに詳細な方法について説明します。

> [!div class="step-by-step"]
> [前へ](unstructured-blob-storage.md)
> [次へ](monitoring-and-telemetry.md)
