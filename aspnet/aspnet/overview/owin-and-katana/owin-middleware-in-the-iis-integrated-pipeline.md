---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: IIS 統合パイプラインの OWIN ミドルウェア |Microsoft Docs
author: Praburaj
description: この記事では、IIS 統合パイプラインで OWIN ミドルウェアコンポーネント (OMCs) を実行する方法と、OMCS を実行するパイプラインイベントを設定する方法について説明します。 ...
ms.author: riande
ms.date: 11/07/2013
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 7d157fb6bd9e2ae9b55af41ef06c1eb5e6310ce1
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456713"
---
# <a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="483ba-104">IIS 統合パイプラインの OWIN ミドルウェア</span><span class="sxs-lookup"><span data-stu-id="483ba-104">OWIN Middleware in the IIS integrated pipeline</span></span>

<span data-ttu-id="483ba-105">[Praburaj Thiagarajan](https://github.com/Praburaj)、 [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="483ba-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

> <span data-ttu-id="483ba-106">この記事では、IIS 統合パイプラインで OWIN ミドルウェアコンポーネント (OMCs) を実行する方法と、OMCS を実行するパイプラインイベントを設定する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="483ba-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="483ba-107">このチュートリアルを読む前に、Project Katana と[OWIN Startup クラスの検出](owin-startup-class-detection.md)[の概要](an-overview-of-project-katana.md)を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="483ba-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="483ba-108">このチュートリアルは、Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) )、Chris Ross、Praburaj Thiagarajan、Howard Dierking ( [@howard\_Dierking](https://twitter.com/howard_dierking) ) によって作成されました。</span><span class="sxs-lookup"><span data-stu-id="483ba-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>

<span data-ttu-id="483ba-109">[OWIN](an-overview-of-project-katana.md)ミドルウェアコンポーネント (omcs) は、主にサーバーに依存しないパイプラインで実行されるように設計されていますが、IIS 統合パイプラインで omcs を実行することもできます (**クラシックモードはサポートされて\*いません**\* )。</span><span class="sxs-lookup"><span data-stu-id="483ba-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="483ba-110">パッケージマネージャーコンソール (PMC) から次のパッケージをインストールすることによって、IIS 統合パイプラインで OMC を機能させることができます。</span><span class="sxs-lookup"><span data-stu-id="483ba-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="483ba-111">つまり、IIS と System.web の外部で実行できないアプリケーションフレームワークも含めて、既存の OWIN ミドルウェアコンポーネントの恩恵を受けることができます。</span><span class="sxs-lookup"><span data-stu-id="483ba-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="483ba-112">Visual Studio 2013 の新しい Id システムに付属するすべての `Microsoft.Owin.Security.*` パッケージ (たとえば、Cookie、Microsoft アカウント、Google、Facebook、Twitter、[ベアラートークン](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html)、OAuth、Authorization SERVER、JWT、Azure Active Directory、active directory フェデレーションサービスなど) は omcs として作成され、自己ホスト型および IIS ホスト型の両方のシナリオで使用できます。</span><span class="sxs-lookup"><span data-stu-id="483ba-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="483ba-113">IIS 統合パイプラインで OWIN ミドルウェアを実行する方法</span><span class="sxs-lookup"><span data-stu-id="483ba-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="483ba-114">OWIN コンソールアプリケーションでは、[スタートアップ構成](owin-startup-class-detection.md)を使用して構築されたアプリケーションパイプラインは、`IAppBuilder.Use` メソッドを使用して、コンポーネントが追加される順序によって設定されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="483ba-115">つまり、 [Katana](an-overview-of-project-katana.md)ランタイムの OWIN パイプラインは、`IAppBuilder.Use`を使用して登録された順序で omcs を処理します。</span><span class="sxs-lookup"><span data-stu-id="483ba-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="483ba-116">IIS 統合パイプラインでは、要求パイプラインは、 [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)、 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)、 [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)などのパイプラインイベントの定義済みセットをサブスクライブしている[HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx)で構成されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="483ba-117">OMC を ASP.NET 世界の[HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx)のものと比較する場合は、omc を適切な定義済みのパイプラインイベントに登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="483ba-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="483ba-118">たとえば、パイプラインの[AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)ステージに要求が送られたときに、HttpModule `MyModule` が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="483ba-119">OMC を同じイベントベースの実行順序に参加させるために、 [Katana](an-overview-of-project-katana.md)ランタイムコードは[スタートアップ構成](owin-startup-class-detection.md)をスキャンし、各ミドルウェアコンポーネントを統合パイプラインイベントにサブスクライブします。</span><span class="sxs-lookup"><span data-stu-id="483ba-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="483ba-120">たとえば、次の OMC と登録コードを使用すると、ミドルウェアコンポーネントの既定のイベント登録を確認できます。</span><span class="sxs-lookup"><span data-stu-id="483ba-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="483ba-121">(OWIN startup クラスを作成する方法の詳細については、「 [OWIN Startup クラスの検出](owin-startup-class-detection.md)」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="483ba-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="483ba-122">空の web アプリケーションプロジェクトを作成し、 **owin2**という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="483ba-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="483ba-123">パッケージマネージャーコンソール (PMC) から、次のコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="483ba-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="483ba-124">`OWIN Startup Class` を追加し、`Startup`という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="483ba-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="483ba-125">生成されたコードを次のコードに置き換えます (変更は強調表示されています)。</span><span class="sxs-lookup"><span data-stu-id="483ba-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="483ba-126">F5 キーを押してアプリを実行します。</span><span class="sxs-lookup"><span data-stu-id="483ba-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="483ba-127">スタートアップ構成では、3つのミドルウェアコンポーネント (最初の2つは診断情報を表示し、最後の2つは診断情報を表示します) を含むパイプラインを設定します。</span><span class="sxs-lookup"><span data-stu-id="483ba-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="483ba-128">`PrintCurrentIntegratedPipelineStage` メソッドは、このミドルウェアが呼び出された統合パイプラインイベントとメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="483ba-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="483ba-129">出力ウィンドウには次の内容が表示されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="483ba-130">Katana ランタイムは、OWIN ミドルウェアの各コンポーネントを既定で[Preexecuter](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)にマップします。これは、IIS パイプラインイベント[PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)に対応します。</span><span class="sxs-lookup"><span data-stu-id="483ba-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="483ba-131">ステージマーカー</span><span class="sxs-lookup"><span data-stu-id="483ba-131">Stage Markers</span></span>

<span data-ttu-id="483ba-132">`IAppBuilder UseStageMarker()` 拡張メソッドを使用して、OMCs をパイプラインの特定の段階で実行するようにマークすることができます。</span><span class="sxs-lookup"><span data-stu-id="483ba-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="483ba-133">特定のステージ中に一連のミドルウェアコンポーネントを実行するには、登録時に最後のコンポーネントが設定された直後にステージマーカーを挿入します。</span><span class="sxs-lookup"><span data-stu-id="483ba-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="483ba-134">ミドルウェアを実行できるパイプラインのステージと、命令コンポーネントを実行する必要があるパイプラインのルールがあります (ルールについては、このチュートリアルの後半で説明します)。</span><span class="sxs-lookup"><span data-stu-id="483ba-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="483ba-135">次に示すように、`UseStageMarker` メソッドを `Configuration` コードに追加します。</span><span class="sxs-lookup"><span data-stu-id="483ba-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="483ba-136">`app.UseStageMarker(PipelineStage.Authenticate)` の呼び出しによって、以前に登録されたすべてのミドルウェアコンポーネント (この場合は、2つの診断コンポーネント) がパイプラインの認証ステージで実行されるように構成されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="483ba-137">最後のミドルウェアコンポーネント (診断を表示して要求に応答) は、`ResolveCache` 段階 ( [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx)イベント) で実行されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="483ba-138">F5 キーを押してアプリを実行します。出力ウィンドウには次のように表示されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="483ba-139">ステージマーカーのルール</span><span class="sxs-lookup"><span data-stu-id="483ba-139">Stage Marker Rules</span></span>

<span data-ttu-id="483ba-140">Owin ミドルウェアコンポーネント (OMC) は、次の OWIN パイプラインステージイベントで実行するように構成できます。</span><span class="sxs-lookup"><span data-stu-id="483ba-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="483ba-141">既定では、OMCs は最後のイベント (`PreHandlerExecute`) で実行されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="483ba-142">このため、最初の例のコードは "PreExecuteRequestHandler" と表示されています。</span><span class="sxs-lookup"><span data-stu-id="483ba-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="483ba-143">`PipelineStage` 列挙型に示されている OWIN パイプラインの任意のステージで、`app.UseStageMarker` メソッドを使用して OMC を登録し、前に実行することができます。</span><span class="sxs-lookup"><span data-stu-id="483ba-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="483ba-144">OWIN パイプラインと IIS パイプラインが順序付けられているため、`app.UseStageMarker` への呼び出しは順番に行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="483ba-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="483ba-145">に登録されている最後のイベントの前にあるイベントにイベントハンドラーを設定することはできません `app.UseStageMarker`します。</span><span class="sxs-lookup"><span data-stu-id="483ba-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="483ba-146">たとえば、を呼び出し*た後*、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="483ba-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="483ba-147">`Authenticate` または `PostAuthenticate` を渡す `app.UseStageMarker` の呼び出しは受け入れられず、例外はスローされません。</span><span class="sxs-lookup"><span data-stu-id="483ba-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="483ba-148">OMCs は、既定では `PreHandlerExecute`である、最新のステージで実行されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="483ba-149">ステージマーカーは、前の手順で実行するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="483ba-150">ステージマーカーを順序どおりに指定しなかった場合は、前のマーカーに丸められます。</span><span class="sxs-lookup"><span data-stu-id="483ba-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="483ba-151">つまり、ステージマーカーを追加すると、"stage X より後に実行する" と表示されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="483ba-152">OMC は、OWIN パイプラインで追加された最初のステージマーカーの後に実行されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="483ba-153">`app.UseStageMarker` を呼び出すための最も早い段階では、が優先されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="483ba-154">たとえば、前の例の `app.UseStageMarker` 呼び出しの順序を切り替える場合は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="483ba-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="483ba-155">出力ウィンドウに次の内容が表示されます。</span><span class="sxs-lookup"><span data-stu-id="483ba-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="483ba-156">OMCs はすべて `AuthenticateRequest` ステージで実行されます。これは、`Authenticate` イベントに登録された最後の OMCS で、`Authenticate` イベントが他のすべてのイベントの前になるためです。</span><span class="sxs-lookup"><span data-stu-id="483ba-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
