---
uid: web-pages/overview/data/5-working-with-data
title: ASP.NET Web ページ (Razor) サイトでのデータベースの操作の概要 |Microsoft Docs
author: Rick-Anderson
description: この章では、ASP.NET Web ページを使用してデータベースのデータにアクセスし、そのデータを表示する方法について説明します。
ms.author: riande
ms.date: 02/18/2014
ms.assetid: 673d502f-2c16-4a6f-bb63-dbfd9a77ef47
msc.legacyurl: /web-pages/overview/data/5-working-with-data
msc.type: authoredcontent
ms.openlocfilehash: 45e988d037465e59ad352bb9444af2c69fd3cd70
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78474040"
---
# <a name="introduction-to-working-with-a-database-in-aspnet-web-pages-razor-sites"></a>ASP.NET Web ページ (Razor) サイトでのデータベースの操作の概要

[Tom FitzMacken](https://github.com/tfitzmac)

> この記事では、Microsoft WebMatrix ツールを使用して ASP.NET Web ページ (Razor) web サイトにデータベースを作成する方法と、データの表示、追加、編集、および削除を行うためのページの作成方法について説明します。
> 
> **学習内容:** 
> 
> - データベースを作成する方法。
> - データベースに接続する方法。
> - Web ページでデータを表示する方法。
> - データベースレコードを挿入、更新、および削除する方法。
> 
> この記事で紹介した機能は次のとおりです。
> 
> - Microsoft SQL Server Compact Edition データベースを操作する。
> - SQL クエリの操作
> - `Database` クラスです。
>   
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>このチュートリアルで使用されているソフトウェアのバージョン
> 
> 
> - ASP.NET Web ページ (Razor) 2
> - WebMatrix 2
>   
> 
> このチュートリアルでは、WebMatrix 3 も使用できます。 ASP.NET Web ページ3と Visual Studio 2013 (または、Web の場合は Visual Studio Express 2013) を使用できます。ただし、ユーザーインターフェイスは異なります。

## <a name="introduction-to-databases"></a>データベースの概要

一般的なアドレス帳を想像してください。 アドレス帳の各エントリ (つまり、各ユーザーについて) には、名、姓、住所、電子メールアドレス、電話番号など、いくつかの情報が含まれています。

このようなデータをピクチャする一般的な方法は、行と列を含むテーブルです。 データベース用語では、各行がレコードと呼ばれることがよくあります。 各列 (フィールドとも呼ばれます) には、各データ型の値 (名、姓、およびなど) が含まれています。

| **ID** | **FirstName** | **LastName** | **アドレス** | **電子メール** | **電話** |
| --- | --- | --- | --- | --- | --- |
| 1 | Jim | Abrus | 210 100th St SE Orcas WA 98031 | jim@contoso.com | 555 0100 |
| 2 | Terry | Adams | 1234メインセント Seattle WA 99011 | terry@cohowinery.com | 555 0101 |

ほとんどのデータベーステーブルでは、テーブルには、顧客番号や口座番号などの一意の識別子を含む列が必要です。これはテーブルの*主キー*と呼ばれ、テーブルの各行を識別するために使用します。 この例では、ID 列はアドレス帳の主キーです。

この基本的なデータベースの理解により、単純なデータベースを作成し、データの追加、変更、削除などの操作を実行する方法を学ぶことができます。

> [!TIP] 
> 
> **リレーショナル データベース**
> 
> テキストファイルやスプレッドシートなど、さまざまな方法でデータを格納できます。 ただし、ほとんどのビジネスでは、データはリレーショナルデータベースに格納されます。
> 
> この記事では、データベースについてあまり詳しく説明しません。 ただし、この点について理解しておくと役立つ場合があります。 リレーショナルデータベースでは、情報は論理的に個別のテーブルに分割されます。 たとえば、school のデータベースには、学生やクラスオファリング用に個別のテーブルが含まれている場合があります。 データベースソフトウェア (SQL Server など) では、テーブル間のリレーションシップを動的に確立できる強力なコマンドがサポートされています。 たとえば、リレーショナルデータベースを使用して、スケジュールを作成するために、学生とクラスの間に論理的な関係を確立することができます。 データを別のテーブルに格納すると、テーブル構造の複雑さが軽減され、テーブルに冗長なデータを保持する必要性が軽減されます。

## <a name="creating-a-database"></a>データベースを作成します。

この手順では、WebMatrix に含まれる SQL Server Compact データベースデザインツールを使用して、SmallBakery という名前のデータベースを作成する方法について説明します。 コードを使用してデータベースを作成することもできますが、WebMatrix などのデザインツールを使用してデータベーステーブルとデータベーステーブルを作成する方が一般的です。

1. WebMatrix を起動し、[クイックスタート] ページで、[**テンプレートからサイト**を] をクリックします。
2. **[空のサイト]** を選択し、 **[サイト名]** ボックスに「SmallBakery」と入力して、 **[OK]** をクリックします。 サイトが作成され、WebMatrix で表示されます。
3. 左側のウィンドウで、 **[データベース]** ワークスペースをクリックします。
4. リボンの **[新しいデータベース]** をクリックします。 空のデータベースは、サイトと同じ名前で作成されます。
5. 左側のウィンドウで、 **SmallBakery**ノードを展開し、 **[テーブル]** をクリックします。
6. リボンの **[新しいテーブル]** をクリックします。 WebMatrix によってテーブルデザイナーが開きます。

    ![[画像]](5-working-with-data/_static/image1.jpg)
7. **[名前]** 列をクリックし、&quot;Id&quot;を入力します。
8. **[データ型]** 列で、 **[int]** を選択します。
9. [**主キー**を**指定**しますか?] オプションを **[はい]** に設定します。

    名前が示すように、 **Is Primary Key は**、これがテーブルの主キーになることをデータベースに通知します。 Id は、新しいレコードごとに自動的に ID 番号が作成**さ**れ、次の連続番号 (1 から開始) が割り当てられるように、データベースに指示します。
10. 次の行をクリックします。 新しい列の定義が開始されます。
11. [名前] の値には &quot;名前&quot;を入力します。
12. **[データ型]** で &quot;nvarchar&quot; を選択し、長さを50に設定します。 `nvarchar` の*var*部分は、この列のデータがレコードごとにサイズが異なる可能性がある文字列であることをデータベースに伝えます。 ( *N*プレフィックスは*national*を表します。これは、任意のアルファベットを表す文字データや、フィールド&#8212;が Unicode データを保持していることを示す書記体系を持つことができることを示します)。
13. **[Null]** を許容 オプションを **[いいえ]** に設定します。 これにより、 *Name*列が空白のままにならないことが強制されます。
14. この同じプロセスを使用して、 *Description*という名前の列を作成します。 長さとして **[データ型]** を "nvarchar"、"50" に設定し、 **[null]** を許容 を false に設定します。
15. *Price*という名前の列を作成します。 **[データ型] を "money" に**設定し、[ **null**を許容] を false に設定します。
16. 上部にあるボックスに、テーブル &quot;Product&quot;という名前を指定します。

    完了すると、定義は次のようになります。

    ![[画像]](5-working-with-data/_static/image2.png)
17. Ctrl + S キーを押して、テーブルを保存します。

## <a name="adding-data-to-the-database"></a>データベースへのデータの追加

これで、記事の後半で使用するサンプルデータをデータベースに追加できます。

1. 左側のウィンドウで、 **SmallBakery**ノードを展開し、 **[テーブル]** をクリックします。
2. Product テーブルを右クリックし、 **[データ]** をクリックします。
3. [編集] ウィンドウで、次のレコードを入力します。

    | **名前** | **説明** | **標準** |
    | --- | --- | --- |
    | 階層 | 毎日新しく焼きます。 | 2.99 |
    | Strawberry の短いケーキ | この庭園から、有機いちごを使用しました。 | 9.99 |
    | Apple 円 | 2番目は、mom の円に対してのみです。 | 12.99 |
    | Pecan 円 | Pecans を希望する場合は、この方法をお勧めします。 | 10.99 |
    | レモン円 | 最高の lemons が世界中で作成されました。 | 11.99 |
    | カップケーキ | 子供と子供たちはこれらを気に入っています。 | 7.99 |

    *Id*列に何も入力する必要がないことに注意してください。 *Id*列を作成した場合**は**、[id] プロパティを [true] に設定します。これにより、自動的に入力されます。

    データの入力が完了すると、テーブルデザイナーは次のようになります。

    ![[画像]](5-working-with-data/_static/image3.jpg)
4. データベースデータを含むタブを閉じます。

## <a name="displaying-data-from-a-database"></a>データベースのデータの表示

データが含まれているデータベースがあれば、ASP.NET の web ページでデータを表示できます。 表示するテーブル行を選択するには、データベースに渡すコマンドである SQL ステートメントを使用します。

1. 左側のウィンドウで、 **[ファイル]** ワークスペースをクリックします。
2. Web サイトのルートで、 *Listproducts. cshtml*という名前の新しい cshtml ページを作成します。
3. 既存のマークアップを次のように置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample1.cshtml)]

    最初のコードブロックで、前に作成した*SmallBakery*ファイル (データベース) を開きます。 `Database.Open` メソッドは、 *.sdf*ファイルが web サイトの*アプリ\_Data*フォルダーにあることを前提としています。 ( *.Sdf*拡張子&#8212;を指定する必要がないことに注意してください。実行すると、`Open` メソッドは機能しません。)

    > [!NOTE]
    > *App\_data*フォルダーは、データファイルの格納に使用される ASP.NET の特別なフォルダーです。 詳細については、この記事で後述[する「データベースへの接続](#SB_ConnectingToADatabase)」を参照してください。

    次に、次の SQL `Select` ステートメントを使用して、データベースに対してクエリを実行するように要求します。

    [!code-sql[Main](5-working-with-data/samples/sample2.sql)]

    ステートメントでは、`Product` は、クエリを実行するテーブルを識別します。 `*` 文字は、クエリがテーブルからすべての列を返す必要があることを指定します。 (一部の列のみを表示する場合は、列をコンマで区切って個別に一覧表示することもできます)。`Order By` 句は、この場合、*名前*列を&#8212;使用してデータを並べ替える方法を示します。 つまり、各行の  *Name (名前*) 列の値に基づいてデータがアルファベット順に並べ替えられます。

    ページの本文では、マークアップによって、データの表示に使用される HTML テーブルが作成されます。 `<tbody>` 要素内では、クエリによって返される各データ行を個別に取得するために、`foreach` ループを使用します。 各データ行に対して、HTML テーブルの行 (`<tr>` 要素) を作成します。 次に、各列の HTML テーブルセル (`<td>` 要素) を作成します。 ループを進めるたびに、データベースから次に使用できる行が `row` 変数に含まれます (`foreach` ステートメントで設定します)。 行から個々の列を取得するには、`row.Name` または `row.Description` を使用するか、必要な列の名前を指定します。
4. ブラウザーでページを実行します。 (実行する前に、 **[ファイル]** ワークスペースでページが選択されていることを確認してください)。ページには、次のような一覧が表示されます。

    ![[画像]](5-working-with-data/_static/image4.jpg)

> [!TIP] 
> 
> **構造化照会言語 (SQL)**
> 
> SQL は、データベース内のデータを管理するためにほとんどのリレーショナルデータベースで使用される言語です。 これには、データを取得して更新するためのコマンドと、データベーステーブルの作成、変更、および管理を行うためのコマンドが含まれています。 Sql は、(WebMatrix で使用しているものと同様に) プログラミング言語とは異なります。 SQL では、データベースに必要なものを通知し、データを取得またはタスクを実行する方法を判断するためのデータベースのジョブです。 いくつかの SQL コマンドとその実行内容の例を次に示します。
> 
> `SELECT Id, Name, Price FROM Product WHERE Price > 10.00 ORDER BY Name`
> 
> *Price*の値が10を超える場合、これによって*Product*テーブルのレコードから*Id*、 *Name*、および*Price*列がフェッチされ、 *name*列の値に基づいてアルファベット順に結果が返されます。 このコマンドは、条件に一致するレコードを含む結果セットを返すか、レコードが一致しない場合は空のセットを返します。
> 
> `INSERT INTO Product (Name, Description, Price) VALUES ("Croissant", "A flaky delight", 1.99)`
> 
> これにより、 *Product*テーブルに新しいレコードが挿入され、 *Name*列が &quot;クロワッサン&quot;に、 *Description*列が不安定な満足させる&quot;&quot;、価格が1.99 に設定されます。
> 
> `DELETE FROM Product WHERE ExpirationDate < "01/01/2008"`
> 
> このコマンドは、有効期限の日付列が2008年1月1日より前の*製品*テーブル内のレコードを削除します。 (もちろん、 *Product*テーブルにはこのような列があることを前提としています)。日付は MM/DD/YYYY 形式で入力しますが、ロケールに使用する形式で入力する必要があります。
> 
> `Insert Into` と `Delete` のコマンドでは、結果セットは返されません。 代わりに、コマンドによって影響を受けたレコードの数を示す数値が返されます。
> 
> これらの操作 (レコードの挿入や削除など) の一部では、操作を要求しているプロセスがデータベース内で適切な権限を持っている必要があります。 このため、実稼働データベースでは、データベースに接続するときにユーザー名とパスワードを入力する必要があります。
> 
> SQL コマンドは多数ありますが、これらはすべて、次のようなパターンに従います。 SQL コマンドを使用して、データベーステーブルを作成したり、テーブル内のレコード数をカウントしたり、価格を計算したり、多くの操作を実行したりすることができます。

## <a name="inserting-data-in-a-database"></a>データベースへのデータの挿入

このセクションでは、ユーザーが*製品*データベーステーブルに新しい製品を追加できるページを作成する方法について説明します。 新しい製品レコードが挿入されると、前のセクションで作成した*Listproducts. cshtml*ページを使用して、更新されたテーブルがページに表示されます。

このページには、ユーザーが入力したデータがデータベースに対して有効であることを確認するための検証が含まれています。 たとえば、ページ内のコードは、すべての必須列に対して値が入力されていることを確認します。

1. Web サイトで、 *Insertproducts. cshtml*という名前の新しい cshtml ファイルを作成します。
2. 既存のマークアップを次のように置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample3.cshtml)]

    ページの本文には、ユーザーが名前、説明、および価格を入力できるようにする3つのテキストボックスを含む HTML フォームが含まれています。 ユーザーが **[挿入]** ボタンをクリックすると、ページ上部のコードによって*SmallBakery*データベースへの接続が開かれます。 次に、`Request` オブジェクトを使用してユーザーが送信した値を取得し、それらの値をローカル変数に代入します。

    ユーザーが各必須列に値を入力したことを検証するには、検証する各 `<input>` 要素を登録します。

    [!code-csharp[Main](5-working-with-data/samples/sample4.cs)]

    `Validation` ヘルパーは、登録した各フィールドに値があることを確認します。 `Validation.IsValid()`をチェックすることで、すべてのフィールドが検証に合格したかどうかをテストできます。通常は、ユーザーから取得した情報を処理する前に実行します。

    [!code-csharp[Main](5-working-with-data/samples/sample5.cs)]

    (`&&` 演算子は、とを意味します。このテストは、*これがフォーム送信であり、すべてのフィールドが検証に合格している場合*に行います)。

    すべての列が検証されている (空でない) 場合は、データを挿入する SQL ステートメントを作成し、次のように実行します。

    [!code-csharp[Main](5-working-with-data/samples/sample6.cs)]

    挿入する値には、パラメーターのプレースホルダー (`@0`、`@1`、`@2`) を含めます。

    > [!NOTE]
    > セキュリティ上の理由から、前の例で示したように、パラメーターを使用して、常に値を SQL ステートメントに渡します。 これにより、ユーザーのデータを検証できるだけでなく、悪意のあるコマンドをデータベースに送信しようとする試み (SQL インジェクション攻撃と呼ばれることもあります) を防ぐことができます。

    このクエリを実行するには、次のステートメントを使用して、プレースホルダーを置き換える値を含む変数を渡します。

    [!code-csharp[Main](5-working-with-data/samples/sample7.cs)]

    `Insert Into` ステートメントが実行された後、次の行を使用して製品の一覧を表示するページにユーザーを送信します。

    [!code-javascript[Main](5-working-with-data/samples/sample8.js)]

    検証が成功しなかった場合は、挿入をスキップします。 このページには、蓄積されたエラーメッセージを表示できるヘルパー (存在する場合) があります。

    [!code-cshtml[Main](5-working-with-data/samples/sample9.cshtml)]

    マークアップのスタイルブロックに `.validation-summary-errors`という名前の CSS クラス定義が含まれていることに注意してください。 これは、検証エラーを含む `<div>` 要素に既定で使用される CSS クラスの名前です。 この場合、CSS クラスは、検証の概要エラーを赤および太字で表示するように指定しますが、`.validation-summary-errors` クラスを定義して任意の書式を表示することができます。

### <a name="testing-the-insert-page"></a>挿入ページのテスト

1. ブラウザーでページを表示します。 ページには、次の図に示すようなフォームが表示されます。

    ![[画像]](5-working-with-data/_static/image5.jpg)
2. すべての列の値を入力しますが、[*価格*] 列は空白のままにしてください。
3. [挿入] をクリックします。 次の図に示すように、ページにエラーメッセージが表示されます。 (新しいレコードは作成されません)。

    ![[画像]](5-working-with-data/_static/image6.jpg)
4. フォーム全体を入力し、 **[挿入]** をクリックします。 今度は、 *Listproducts. cshtml*ページが表示され、新しいレコードが表示されます。

## <a name="updating-data-in-a-database"></a>データベース内のデータの更新

データがテーブルに入力されたら、更新が必要になる場合があります。 この手順では、前にデータを挿入するために作成したものと似た2つのページを作成する方法を示します。 最初のページには製品が表示され、ユーザーは変更する製品を選択できます。 2番目のページでは、ユーザーが実際に編集を行って保存することができます。

> [!NOTE] 
> 
> **重要**運用 web サイトでは、通常、データを変更できるユーザーを制限します。 メンバーシップの設定方法と、サイトでのタスクの実行をユーザーに承認する方法の詳細については、「 [ASP.NET Web ページサイトへのセキュリティとメンバーシップの追加](https://go.microsoft.com/fwlink/?LinkId=202904)」を参照してください。

1. Web サイトで、 *Editproducts. cshtml*という名前の新しい cshtml ファイルを作成します。
2. ファイルの既存のマークアップを次のように置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample10.cshtml)]

    このページと前の*Listproducts. cshtml*ページの唯一の違いは、このページの HTML テーブルには、**編集**リンクを表示する列が追加されていることです。 このリンクをクリックすると、選択したレコードを編集できる [ *Updateproducts. cshtml* ] ページ (次に作成します) に移動します。

    **編集**リンクを作成するコードを確認します。

    [!code-cshtml[Main](5-working-with-data/samples/sample11.cshtml)]

    これにより、`href` 属性が動的に設定される HTML `<a>` 要素が作成されます。 `href` 属性は、ユーザーがリンクをクリックしたときに表示されるページを指定します。 また、現在の行の `Id` 値がリンクに渡されます。 ページが実行されると、ページソースに次のようなリンクが含まれる場合があります。

    [!code-html[Main](5-working-with-data/samples/sample12.html)]

    `href` 属性が `UpdateProducts/n`に設定されていることに注意してください。ここで、 *n*は製品番号です。 ユーザーがこれらのリンクのいずれかをクリックすると、結果の URL は次のようになります。

    `http://localhost:18816/UpdateProducts/6`

    つまり、編集する製品番号は URL で渡されます。
3. ブラウザーでページを表示します。 ページには、次のような形式でデータが表示されます。

    ![[画像]](5-working-with-data/_static/image7.jpg)

    次に、ユーザーが実際にデータを更新できるページを作成します。 [更新] ページには、ユーザーが入力したデータを検証するための検証が含まれています。 たとえば、ページ内のコードは、すべての必須列に対して値が入力されていることを確認します。
4. Web サイトで、 *Updateproducts. cshtml*という名前の新しい cshtml ファイルを作成します。
5. ファイルの既存のマークアップを次のように置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample13.cshtml)]

    ページの本文には、製品が表示され、ユーザーが編集できる HTML フォームが含まれています。 表示する製品を取得するには、次の SQL ステートメントを使用します。

    [!code-sql[Main](5-working-with-data/samples/sample14.sql)]

    これにより、ID が `@0` パラメーターで渡された値と一致する製品が選択されます。 ( *Id*は主キーであるため、一意である必要があるため、この方法で選択できる製品レコードは1つだけです)。この `Select` ステートメントに渡す ID 値を取得するには、次の構文を使用して、URL の一部としてページに渡される値を読み取ることができます。

    [!code-csharp[Main](5-working-with-data/samples/sample15.cs)]

    実際に製品レコードをフェッチするには、`QuerySingle` メソッドを使用します。これにより、1つのレコードのみが返されます。

    [!code-csharp[Main](5-working-with-data/samples/sample16.cs)]

    単一行が `row` 変数に返されます。 各列からデータを取得し、次のようにローカル変数に割り当てることができます。

    [!code-csharp[Main](5-working-with-data/samples/sample17.cs)]

    フォームのマークアップでは、次のような埋め込みコードを使用して、これらの値が個々のテキストボックスに自動的に表示されます。

    [!code-html[Main](5-working-with-data/samples/sample18.html)]

    コードのその部分では、更新する製品レコードが表示されます。 レコードが表示されたら、ユーザーは個々の列を編集できます。

    ユーザーが **[更新]** ボタンをクリックしてフォームを送信すると、`if(IsPost)` ブロック内のコードが実行されます。 これにより、`Request` オブジェクトからユーザーの値を取得し、値を変数に格納して、各列に入力されたことを検証します。 検証が成功した場合、コードは次の SQL Update ステートメントを作成します。

    [!code-sql[Main](5-working-with-data/samples/sample19.sql)]

    SQL `Update` ステートメントでは、更新する各列と、それに設定する値を指定します。 このコードでは、パラメーターのプレースホルダー `@0`、`@1`、`@2`などを使用して値を指定します。 (前述のように、セキュリティのために、パラメーターを使用して、常に値を SQL ステートメントに渡す必要があります)。

    `db.Execute` メソッドを呼び出す場合は、次のように、SQL ステートメントのパラメーターに対応する順序で値を含む変数を渡します。

    [!code-csharp[Main](5-working-with-data/samples/sample20.cs)]

    `Update` ステートメントを実行した後、次のメソッドを呼び出して、ユーザーを編集ページにリダイレクトします。

    [!code-cshtml[Main](5-working-with-data/samples/sample21.cshtml)]

    結果として、ユーザーにはデータベース内のデータの更新された一覧が表示され、別の製品を編集できるようになります。
6. ページを保存します。
7. [更新] ページではなく [ *Editproducts. cshtml* ] ページを実行し、 **[編集]** をクリックして編集する製品を選択します。 *Updateproducts. cshtml*ページが表示され、選択したレコードが表示されます。

    ![[画像]](5-working-with-data/_static/image8.jpg)
8. 変更を行い、 **[更新]** をクリックします。 更新後のデータと共に、製品の一覧が表示されます。

## <a name="deleting-data-in-a-database"></a>データベース内のデータの削除

このセクションで*は、ユーザーが製品データベーステーブル*から製品を削除できるようにする方法について説明します。 この例は、2つのページで構成されています。 最初のページでは、削除するレコードをユーザーが選択します。 削除するレコードは、レコードを削除するかどうかを確認できる2番目のページに表示されます。

> [!NOTE] 
> 
> **重要**運用 web サイトでは、通常、データを変更できるユーザーを制限します。 メンバーシップを設定する方法と、サイトでのタスクの実行をユーザーに承認する方法については、「 [ASP.NET Web ページサイトへのセキュリティとメンバーシップの追加](https://go.microsoft.com/fwlink/?LinkId=202904)」を参照してください。

1. Web サイトで、 *List$ Fordelete. cshtml*という名前の新しい cshtml ファイルを作成します。
2. 既存のマークアップを次のように置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample22.cshtml)]

    このページは、前の「 *Editproducts. cshtml* 」ページに似ています。 ただし、各製品の**編集**リンクを表示するのではなく、 **[削除]** リンクが表示されます。 **削除**リンクは、マークアップ内の次の埋め込みコードを使用して作成されます。

    [!code-cshtml[Main](5-working-with-data/samples/sample23.cshtml)]

    これにより、ユーザーがリンクをクリックしたときに、次のような URL が作成されます。

    `http://<server>/DeleteProduct/4`

    URL は、 *deleteproduct. cshtml*という名前のページを呼び出し (次に作成します)、削除する製品の ID (ここでは 4) を渡します。
3. ファイルを保存しますが、開いたままにしておきます。
4. *Deleteproduct. cshtml*という名前の別の CHTML ファイルを作成します。 既存のコンテンツを次の内容に置き換えます。

    [!code-cshtml[Main](5-working-with-data/samples/sample24.cshtml)]

    このページは*listproduct Fordelete. cshtml*によって呼び出され、ユーザーが製品を削除することを確認できます。 削除する製品の一覧を表示するには、次のコードを使用して、URL から削除する製品の ID を取得します。

    [!code-csharp[Main](5-working-with-data/samples/sample25.cs)]

    このページでは、ユーザーに対して、レコードを実際に削除するボタンをクリックするように求められます。 これは重要なセキュリティ対策です。データの更新や削除など、web サイトで機密性の高い操作を実行する場合、これらの操作は常に、GET 操作ではなく POST 操作を使用して実行する必要があります。 GET 操作を使用して削除操作を実行できるようにサイトがセットアップされている場合、だれでも `http://<server>/DeleteProduct/4` のような URL を渡したり、データベースから必要なものを削除したりできます。 投稿を使用してのみ削除を実行できるように、確認を追加してページをコーディングすることで、サイトにセキュリティの測定単位を追加します。

    実際の削除操作は、次のコードを使用して実行されます。このコードは、最初にこれが post 操作であり、ID が空でないことを確認します。

    [!code-csharp[Main](5-working-with-data/samples/sample26.cs)]

    このコードは、指定されたレコードを削除する SQL ステートメントを実行し、ユーザーをリストページにリダイレクトします。
5. ブラウザーで*List$ Fordelete*を実行します。

    ![[画像]](5-working-with-data/_static/image9.jpg)
6. いずれかの製品の **[削除]** リンクをクリックします。 削除するレコードがあることを確認するために、 *Deleteproduct. cshtml*ページが表示されます。
7. **[削除]** ボタンをクリックします。 製品レコードが削除され、更新された製品一覧でページが更新されます。

> [!TIP]
> 
> <a id="SB_ConnectingToADatabase"></a>
> ### <a name="connecting-to-a-database"></a>データベースに接続する
> 
> データベースに接続するには、2つの方法があります。 1つ目は、`Database.Open` メソッドを使用して、データベースファイルの名前を指定することです (.sdf 拡張子は*ありません*)。
> 
> `var db = Database.Open("SmallBakery");`
> 
> `Open` メソッドは、がであることを前提としています。 *.sdf*ファイルは、web サイトの*App\_Data*フォルダーにあります。 このフォルダーは、データを保持するために特に設計されています。 たとえば、web サイトにデータの読み取りと書き込みを許可するための適切なアクセス許可があり、セキュリティ対策として、WebMatrix はこのフォルダーからのファイルへのアクセスを許可しません。
> 
> 2番目の方法は、接続文字列を使用することです。 データベースに接続する方法に関する情報が含まれる接続文字列。 これにはファイルパスを含めることができます。または、ローカルサーバーまたはリモートサーバー上の SQL Server データベースの名前と、そのサーバーに接続するためのユーザー名とパスワードを含めることができます。 (ホスティングプロバイダーのサイトなど、集中管理されているバージョンの SQL Server にデータを保持する場合は、常に接続文字列を使用してデータベース接続情報を指定します)。
> 
> WebMatrix では、通常、接続文字列は web.config という名前の XML ファイルに格納さ*れます。* 名前が示すように、 *web*サイトのルートにある web.config ファイルを使用して、サイトの構成情報 (サイトで必要となる可能性のある接続文字列など) を保存できます。 *Web.config ファイル内*の接続文字列の例は次のようになります。
> 
> [!code-xml[Main](5-working-with-data/samples/sample27.xml)]
> 
> この例では、接続文字列は、(ローカルの *.sdf*ファイルではなく) どこかのサーバーで実行されている SQL Server のインスタンス内のデータベースを指しています。 `myServer` と `myDatabase`に適切な名前を置き換え、`username` および `password`に SQL Server ログイン値を指定する必要があります。 (ユーザー名とパスワードの値は、必ずしも Windows 資格情報と同じであるとは限りません。また、ホスティングプロバイダーからサーバーにログインするために指定された値と同じでもありません。 必要な値については、管理者に確認してください。)
> 
> `Database.Open` メソッドは柔軟です。これにより、データベースの *.sdf*ファイルの名前、または*web.config ファイルに*格納されている接続文字列の名前のいずれかを渡すことができます。 次の例は、前の例で示した接続文字列を使用してデータベースに接続する方法を示しています。
> 
> [!code-cshtml[Main](5-working-with-data/samples/sample28.cshtml)]
> 
> 前述のように、`Database.Open` メソッドを使用すると、データベース名または接続文字列のいずれかを渡すことができます。 これは、web サイトをデプロイ (発行) するときに非常に便利です。 サイトの開発とテストを行う場合は、 *App\_Data*フォルダーにある *.sdf*ファイルを使用できます。 その後、サイトを実稼働サーバーに移動するときに、 *.sdf*ファイルと同じ名前を持つ*web.config ファイル内*の接続文字列を使用できますが、コードを変更しなくてもホスティングプロバイダー &#8212;のデータベースを参照します。
> 
> 最後に、接続文字列を直接操作する場合は、`Database.OpenConnectionString` メソッドを呼び出し*て、web.config ファイルに*ある名前だけではなく、実際の接続文字列を渡すことができます。 これは、ページが実行されるまで、何らかの理由で接続文字列 ( *.sdf*ファイル名などの値) にアクセスできない場合に便利です。 ただし、ほとんどのシナリオでは、この記事で説明されているように `Database.Open` を使用できます。

## <a name="additional-resources"></a>その他のリソース

- [SQL Server Compact](https://www.microsoft.com/sqlserver/2008/en/us/compact.aspx)
- [WebMatrix での SQL Server または MySQL データベースへの接続](https://go.microsoft.com/fwlink/?LinkId=208661)
- [ASP.NET Web ページにおけるユーザー入力の検証](https://go.microsoft.com/fwlink/?LinkId=253002)
