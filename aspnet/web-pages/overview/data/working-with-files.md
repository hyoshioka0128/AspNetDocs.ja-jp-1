---
uid: web-pages/overview/data/working-with-files
title: ASP.NET Web ページ (Razor) サイトでのファイルの操作 |Microsoft Docs
author: Rick-Anderson
description: この章では、ファイルの読み取り、書き込み、追加、削除、およびアップロードを行う方法について説明します。
ms.author: riande
ms.date: 02/20/2014
ms.assetid: eee916e4-ba4c-439a-a24e-68df7d45a569
msc.legacyurl: /web-pages/overview/data/working-with-files
msc.type: authoredcontent
ms.openlocfilehash: 684c47a8a8480dc040e5144144577c94c35d39e5
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78521884"
---
# <a name="working-with-files-in-an-aspnet-web-pages-razor-site"></a>ASP.NET Web ページ (Razor) サイトでのファイルの操作

[Tom FitzMacken](https://github.com/tfitzmac)

> この記事では、ASP.NET Web ページ (Razor) サイトでファイルの読み取り、書き込み、追加、削除、およびアップロードを行う方法について説明します。
> 
> > [!NOTE]
> > イメージをアップロードして操作する場合 (たとえば、画像を反転またはサイズ変更する場合) は、「 [ASP.NET Web ページサイトでのイメージの操作](/aspnet/web-pages/overview/ui-layouts-and-themes/9-working-with-images)」を参照してください。
> 
> 
> **学習内容:** 
> 
> - テキストファイルを作成してデータを書き込む方法。
> - 既存のファイルにデータを追加する方法。
> - ファイルを読み取り、そこから表示する方法。
> - Web サイトからファイルを削除する方法。
> - ユーザーが1つまたは複数のファイルをアップロードできるようにする方法。
> 
> この記事で紹介する ASP.NET プログラミング機能を次に示します。
> 
> - `File` オブジェクト。ファイルを管理する方法を提供します。
> - `FileUpload` ヘルパー。
> - `Path` オブジェクト。パスとファイル名を操作できるメソッドを提供します。
>   
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>このチュートリアルで使用されているソフトウェアのバージョン
> 
> 
> - ASP.NET Web ページ (Razor) 2
> - WebMatrix 2
>   
> 
> このチュートリアルでは、WebMatrix 3 も使用できます。

<a id="Creating_a_Text_File"></a>
## <a name="creating-a-text-file-and-writing-data-to-it"></a>テキストファイルの作成とデータの書き込み

Web サイトのデータベースを使用するだけでなく、ファイルを操作することもできます。 たとえば、サイトのデータを格納する簡単な方法として、テキストファイルを使用する場合があります。 (データを格納するために使用されるテキストファイルは、*フラットファイル*と呼ばれることもあります)。テキストファイルは、 *.txt*、 *.xml*、 *.csv* (コンマ区切りの値) など、異なる形式にすることができます。

データをテキストファイルに格納する場合は、`File.WriteAllText` メソッドを使用して、作成するファイルとそれに書き込むデータを指定します。 この手順では、3つの `input` 要素 (名、姓、電子メールアドレス) と **[送信]** ボタンを持つ単純なフォームを含むページを作成します。 ユーザーがフォームを送信すると、ユーザーの入力がテキストファイルに保存されます。

1. *App\_Data*という名前の新しいフォルダーがまだ存在しない場合は作成します。
2. Web サイトのルートで、 *UserData*という名前の新しいファイルを作成します。
3. 既存のコンテンツを次の内容に置き換えます。 

    [!code-cshtml[Main](working-with-files/samples/sample1.cshtml)]

    HTML マークアップによって、3つのテキストボックスを持つフォームが作成されます。 コードでは、`IsPost` プロパティを使用して、処理を開始する前にページが送信されたかどうかを判断します。

    最初のタスクでは、ユーザー入力を取得し、変数に割り当てます。 次に、別の変数の値を1つのコンマ区切りの文字列に連結します。この文字列は、別の変数に格納されます。 コンマ区切り記号は引用符 (",") に含まれている文字列であることに注意してください。これは、作成中の大きな文字列にコンマが埋め込まれているためです。 連結するデータの最後に、`Environment.NewLine`を追加します。 改行 (改行文字) が追加されます。 この連結をすべて使用して作成しているのは、次のような文字列です。

    [!code-css[Main](working-with-files/samples/sample2.css)]

    (末尾に非表示の改行があります)。

    次に、データを格納するファイルの場所と名前を含む変数 (`dataFile`) を作成します。 場所を設定するには、特別な処理が必要です。 Web サイトでは、web サーバー上のファイルの*C:\Folder\File.txt*などの絶対パスをコードで参照することは不適切です。 Web サイトが移動された場合、絶対パスは間違っています。 さらに、ホストされているサイト (自分のコンピューターではなく) では、通常、コードを記述する際に正しいパスを把握している必要はありません。

    ただし (現時点では、ファイルの書き込みのように) 完全なパスが必要になる場合があります。 解決策は、`Server` オブジェクトの `MapPath` メソッドを使用することです。 これにより、web サイトへの完全なパスが返されます。 Web サイトのルートのパスを取得するには、`~` 演算子 (サイトの仮想ルートを represen) を使用して `MapPath`します。 また、サブフォルダー名 (たとえば、*アプリ\_Data/* ) を渡して、そのサブフォルダーのパスを取得することもできます。その後、完全なパスを作成するために、メソッドから返されるものに追加情報を連結できます。 この例では、ファイル名を追加します。 (ファイルとフォルダーのパスを操作する方法の詳細については[、「Razor 構文を使用した ASP.NET Web ページプログラミングの概要」を](https://go.microsoft.com/fwlink/?LinkId=195205#ID_WorkingWithFileAndFolderPaths)参照してください)。

    ファイルは、 *App\_Data*フォルダーに保存されます。 このフォルダーは、「 [ASP.NET Web ページサイトでのデータベースの操作の概要](https://go.microsoft.com/fwlink/?LinkId=195209)」で説明されているように、データファイルの格納に使用される ASP.NET の特別なフォルダーです。

    `File` オブジェクトの `WriteAllText` メソッドによって、データがファイルに書き込まれます。 このメソッドは、書き込み先のファイルの名前 (パスを含む) と書き込み先の実際のデータの2つのパラメーターを受け取ります。 最初のパラメーターの名前にプレフィックスとして `@` 文字があることに注意してください。 これは、逐語的文字列リテラルを提供していること、および "/" のような文字を特別な方法では解釈できないことを ASP.NET に通知します。 (詳細については、「 [Razor 構文を使用した ASP.NET Web プログラミングの概要」を](https://go.microsoft.com/fwlink/?LinkId=195205#ID_WorkingWithFileAndFolderPaths)参照してください)。

    > [!NOTE]
    > コードで*App\_Data*フォルダーにファイルを保存するには、そのフォルダーに対する読み取り/書き込みアクセス許可がアプリケーションに必要です。 開発用コンピューターでは、これは通常は問題ではありません。 ただし、サイトをホスティングプロバイダーの web サーバーに発行する場合は、これらのアクセス許可を明示的に設定する必要がある場合があります。 このコードをホスティングプロバイダーのサーバーで実行し、エラーが発生した場合は、ホスティングプロバイダーに確認して、これらのアクセス許可を設定する方法を確認してください。

- ブラウザーでページを実行します。 

    ![](working-with-files/_static/image1.jpg)
- フィールドに値を入力し、 **[送信]** をクリックします。
- ブラウザーを閉じます。
- プロジェクトに戻り、ビューを更新します。
- *データ .txt*ファイルを開きます。 フォームに送信したデータは、ファイルにあります。 

    ![[画像]](working-with-files/_static/image2.jpg)
- *データ .txt*ファイルを閉じます。

<a id="Appending_Data"></a>
## <a name="appending-data-to-an-existing-file"></a>既存のファイルへのデータの追加

前の例では、`WriteAllText` を使用してテキストファイルを作成し、そこに1つのデータのみが含まれるようにしていました。 メソッドを再度呼び出して同じファイル名を渡すと、既存のファイルは完全に上書きされます。 ただし、ファイルを作成した後は、多くの場合、ファイルの末尾に新しいデータを追加する必要があります。 これは、`File` オブジェクトの `AppendAllText` メソッドを使用して行うことができます。

1. Web サイトで、 *UserData*ファイルのコピーを作成し、そのコピーに*UserDataMultiple*という名前を指定します。
2. 開始 `<!DOCTYPE html>` タグの前にあるコードブロックを次のコードブロックに置き換えます。 

    [!code-cshtml[Main](working-with-files/samples/sample3.cshtml)]

    このコードには、前の例の変更が1つあります。 `WriteAllText`を使用する代わりに、`the AppendAllText` メソッドを使用します。 メソッドは似ていますが、`AppendAllText` はファイルの末尾にデータを追加する点が異なります。 `WriteAllText`の場合と同様に、ファイルがまだ存在しない場合は `AppendAllText` によって作成されます。
3. ブラウザーでページを実行します。
4. フィールドの値を入力し、 **[送信]** をクリックします。
5. データをさらに追加し、フォームを再度送信します。
6. プロジェクトに戻り、プロジェクトフォルダーを右クリックして、[最新の状態に**更新**] をクリックします。
7. *データ .txt*ファイルを開きます。 これで、入力したばかりの新しいデータが表示されます。 

    ![[画像]](working-with-files/_static/image3.jpg)

<a id="Reading_and_Displaying_Data"></a>
## <a name="reading-and-displaying-data-from-a-file"></a>ファイルのデータの読み取りと表示

テキストファイルにデータを書き込む必要がない場合でも、場合によっては、データの読み取りが必要になることがあります。 これを行うには、`File` オブジェクトをもう一度使用します。 `File` オブジェクトを使用すると、各行を個別に (改行で区切って) 読み取ることも、個々の項目がどのように分離されているかにかかわらず読み取ることもできます。

この手順では、前の例で作成したデータを読み取り、表示する方法について説明します。

1. Web サイトのルートで、 *Displaydata. cshtml*という名前の新しいファイルを作成します。
2. 既存のコンテンツを次の内容に置き換えます。 

    [!code-cshtml[Main](working-with-files/samples/sample4.cshtml)]

    このコードは、次のメソッド呼び出しを使用して、前の例で作成したファイルを `userData`という名前の変数に読み取ります。

    [!code-css[Main](working-with-files/samples/sample5.css)]

    これを行うコードは、`if` ステートメントの内部にあります。 ファイルを読み取る場合は、`File.Exists` メソッドを使用して、ファイルが使用可能かどうかを最初に確認することをお勧めします。 このコードでは、ファイルが空かどうかも確認します。

    ページの本文には、2つの `foreach` ループが含まれており、その中に入れ子になっています。 外側の `foreach` ループは、データファイルから一度に1行を取得します。 この場合、行はファイル&#8212;内の改行によって定義されます。つまり、各データ項目はそれぞれの行にあります。 外側のループは、順序付けられたリスト (`<ol>` 要素) 内に新しい項目 (`<li>` 要素) を作成します。

    内側のループでは、区切り記号としてコンマを使用して、各データ行を項目 (フィールド) に分割します。 (前の例に基づいて、各行には、名、姓&#8212; 、電子メールアドレスという3つのフィールドが含まれており、それぞれがコンマで区切られています)。内側のループでは、`<ul>` リストも作成され、データ行のフィールドごとに1つのリスト項目が表示されます。

    このコードは、配列と `char` データ型の2つのデータ型を使用する方法を示しています。 `File.ReadAllLines` メソッドはデータを配列として返すため、配列が必要です。 `Split` メソッドは、各要素の型が `char`の `array` を返すため、`char` のデータ型が必要です。 (配列の詳細については、「 [Razor 構文を使用した ASP.NET Web プログラミングの概要](https://go.microsoft.com/fwlink/?LinkId=202890#ID_CollectionsAndObjects)」を参照してください)。
3. ブラウザーでページを実行します。 前の例で入力したデータが表示されます。 

    ![[画像]](working-with-files/_static/image4.jpg)

> [!TIP] 
> 
> **Microsoft Excel のコンマ区切りファイルからのデータの表示**
> 
> Microsoft Excel を使用して、スプレッドシートに含まれるデータをコンマ区切りファイル ( *.csv*ファイル) として保存できます。 この場合、ファイルは Excel 形式ではなく、プレーンテキストで保存されます。 スプレッドシート内の各行は、テキストファイル内の改行で区切られ、各データ項目はコンマで区切られます。 前の例に示したコードを使用して、コード内のデータファイルの名前を変更するだけで、Excel のコンマ区切りファイルを読み取ることができます。

<a id="Deleting_Files"></a>
## <a name="deleting-files"></a>ファイルの削除

Web サイトからファイルを削除するには、`File.Delete` メソッドを使用します。 この手順では、ファイルの名前がわかっている場合に、ユーザーが*images*フォルダーからイメージ ( *.jpg*ファイル) を削除できるようにする方法を示します。

> [!NOTE] 
> 
> **重要**運用 web サイトでは、通常、データを変更できるユーザーを制限します。 メンバーシップの設定方法と、サイトでのタスクの実行をユーザーに承認する方法の詳細については、「 [ASP.NET Web ページサイトへのセキュリティとメンバーシップの追加](https://go.microsoft.com/fwlink/?LinkId=202904)」を参照してください。

1. Web サイトで、 *images*という名前のサブフォルダーを作成します。
2. 1つまたは複数の *.jpg*ファイルを*images*フォルダーにコピーします。
3. Web サイトのルートで、 *FileDelete*という名前の新しいファイルを作成します。
4. 既存のコンテンツを次の内容に置き換えます。 

    [!code-cshtml[Main](working-with-files/samples/sample6.cshtml)]

    このページには、ユーザーがイメージファイルの名前を入力できるフォームが含まれています。 これらは、 *.jpg*ファイル名拡張子を入力しません。このようにファイル名を制限することで、ユーザーがサイト上の任意のファイルを削除できないようにすることができます。

    このコードは、ユーザーが入力したファイル名を読み取り、完全なパスを構築します。 パスを作成するために、コードは現在の web サイトのパス (`Server.MapPath` メソッドによって返される)、 *images*フォルダー名、ユーザーが指定した名前、および ".jpg" をリテラル文字列として使用します。

    このファイルを削除するには、コードで `File.Delete` メソッドを呼び出し、先ほど作成した完全なパスを渡します。 マークアップの最後に、ファイルが削除されたことを示す確認メッセージがコードによって表示されます。
5. ブラウザーでページを実行します。 

    ![[画像]](working-with-files/_static/image5.jpg)
6. 削除するファイルの名前を入力し、 **[送信]** をクリックします。 ファイルが削除されている場合は、ファイルの名前がページの下部に表示されます。

<a id="Letting_Users_Upload_a_File"></a>
## <a name="letting-users-upload-a-file"></a>ユーザーがファイルをアップロードできるようにする

`FileUpload` ヘルパーを使用すると、ユーザーは web サイトにファイルをアップロードできます。 次の手順は、ユーザーが1つのファイルをアップロードできるようにする方法を示しています。

1. 前に追加していない場合は、「 [ASP.NET Web ページサイトにヘルパーをインストール](https://go.microsoft.com/fwlink/?LinkId=252372)する」の説明に従って、ASP.NET Web ヘルパーライブラリを web サイトに追加します。
2. [ *App\_Data* ] フォルダーで、新しいフォルダーを作成し、 *UploadedFiles*という名前を指定します。
3. ルートで、 *FileUpload*という名前の新しいファイルを作成します。
4. ページ内の既存のコンテンツを次の内容に置き換えます。 

    [!code-cshtml[Main](working-with-files/samples/sample7.cshtml)]

    ページの本文部分では、`FileUpload` ヘルパーを使用して、よく知られているアップロードボックスとボタンを作成します。

    ![[画像]](working-with-files/_static/image6.jpg)

    `FileUpload` helper に設定したプロパティでは、ファイルの1つのボックスをアップロードするように指定し、[送信] ボタンで**アップロード**を読み取ります。 (この記事の後半で、さらに多くのボックスを追加します)。

    ユーザーが **[アップロード]** をクリックすると、ページ上部のコードによってファイルが取得され、保存されます。 フォームフィールドから値を取得するために通常使用する `Request` オブジェクトには、アップロードされたファイル (またはファイル) を格納する `Files` 配列もあります。 配列&#8212;内の特定の位置から個々のファイルを取得することができます。たとえば、最初にアップロードされたファイルを取得するために、`Request.Files[0]`を取得し、2番目のファイルを取得する、`Request.Files[1]`を取得するなどの方法があります。 (プログラミングでは、通常、カウントは0から始まります)。

    アップロードしたファイルをフェッチする場合は、そのファイルを操作できるように変数 (ここでは `uploadedFile`) に配置します。 アップロードされたファイルの名前を確認するには、その `FileName` プロパティを取得します。 ただし、ユーザーがファイルをアップロードすると、`FileName` には、パス全体を含むユーザーの元の名前が含まれます。 次のようになります。

    *C:\Users\Public\Sample.txt*

    ただし、これはユーザーのコンピューター上のパスであり、サーバーではないため、すべてのパス情報を必要としません。 実際のファイル名を必要とするだけです (*サンプル .txt*)。 次のように `Path.GetFileName` メソッドを使用して、パスからファイルのみを取り除くことができます。

    [!code-csharp[Main](working-with-files/samples/sample8.cs)]

    `Path` オブジェクトは、このような多数のメソッドを備えたユーティリティで、パスの削除やパスの結合などに使用できます。

    アップロードしたファイルの名前を入力したら、アップロードしたファイルを web サイトに保存する場所の新しいパスを作成できます。 この場合は、`Server.MapPath`、フォルダー名 (*App\_Data/UploadedFiles*)、および新しく削除されたファイル名を組み合わせて新しいパスを作成します。 アップロードしたファイルの `SaveAs` メソッドを呼び出して、実際にファイルを保存することができます。
5. ブラウザーでページを実行します。 

    ![[画像]](working-with-files/_static/image7.jpg)
6. **[参照]** をクリックし、アップロードするファイルを選択します。 

    ![[画像]](working-with-files/_static/image8.jpg)

    **[参照]** ボタンの横にあるテキストボックスに、パスとファイルの場所が表示されます。

    ![[画像]](working-with-files/_static/image9.jpg)
7. **[アップロード]** をクリックします。
8. Web サイトで、プロジェクトフォルダーを右クリックし、[最新の状態に**更新**] をクリックします。
9. *UploadedFiles*フォルダーを開きます。 アップロードしたファイルは、フォルダーにあります。 

    ![[画像]](working-with-files/_static/image10.jpg)

<a id="Letting_Users_Upload_Multiple_Files"></a>
## <a name="letting-users-upload-multiple-files"></a>ユーザーが複数のファイルをアップロードできるようにする

前の例では、ユーザーが1つのファイルをアップロードできるようにします。 ただし、`FileUpload` ヘルパーを使用して、一度に複数のファイルをアップロードすることができます。 これは、写真のアップロードなどのシナリオで便利です。一度に1つのファイルをアップロードすることは面倒です。 ( [ASP.NET Web ページサイトの画像を使用した](https://go.microsoft.com/fwlink/?LinkId=202897)写真のアップロードについては、「」を参照してください)。この例では、ユーザーが同時にアップロードできる方法を示していますが、同じ手法を使用して同時にアップロードすることもできます。

1. 「 [ASP.NET Web ページサイトにヘルパーをインストール](https://go.microsoft.com/fwlink/?LinkId=252372)する」の説明に従って、ASP.NET Web ヘルパーライブラリを web サイトに追加します (まだインストールしていない場合)。
2. *Fileuploadmultiple. cshtml*という名前の新しいページを作成します。
3. ページ内の既存のコンテンツを次の内容に置き換えます。  

    [!code-cshtml[Main](working-with-files/samples/sample9.cshtml)]

    この例では、ページの本文の `FileUpload` ヘルパーは、ユーザーが既定で2つのファイルをアップロードできるように構成されています。 `allowMoreFilesToBeAdded` が `true`に設定されているため、ヘルパーは、ユーザーが追加のアップロードボックスを追加できるリンクを表示します。

    ![[画像]](working-with-files/_static/image11.jpg)

    ユーザーがアップロードしたファイルを処理するために、前の例&#8212;で使用したのと同じ基本的な方法でコードを使用し、`Request.Files` からファイルを取得して保存します。 (正しいファイル名とパスを取得するために必要なさまざまな処理が含まれています)。今回のイノベーションは、ユーザーが複数のファイルをアップロードしていて、あまり多くのファイルを持っていない可能性があるということです。 確認するには、`Request.Files.Count`を取得します。

    この数を指定すると、`Request.Files`をループ処理し、各ファイルを順番にフェッチして保存できます。 コレクションを通じて既知の回数をループする場合は、次のように `for` ループを使用できます。

    [!code-csharp[Main](working-with-files/samples/sample10.cs)]

    変数 `i` は、ゼロから設定した上限に達するまでの一時的なカウンターにすぎません。 この場合、上限はファイル数です。 ただし、カウンターは0から開始されるため、ASP.NET のシナリオをカウントするのが一般的です。そのため、上限は実際にはファイルの数より1小さくなります。 (3 つのファイルがアップロードされた場合、カウントは0から2になります)。

    `uploadedCount` 変数は、正常にアップロードされて保存されたすべてのファイルの総数を示します。 このコードは、予期されたファイルをアップロードできない可能性を考慮しています。
4. ブラウザーでページを実行します。 ブラウザーには、ページとその2つのアップロードボックスが表示されます。
5. アップロードする2つのファイルを選択します。
6. **[別のファイルを追加]** をクリックします。 ページに新しいアップロードボックスが表示されます。 

    ![[画像]](working-with-files/_static/image12.jpg)
7. **[アップロード]** をクリックします。
8. Web サイトで、プロジェクトフォルダーを右クリックし、[最新の状態に**更新**] をクリックします。
9. *UploadedFiles*フォルダーを開き、正常にアップロードされたファイルを確認します。

<a id="Additional_Resources"></a>
## <a name="additional-resources"></a>その他のリソース

[ASP.NET Web ページサイトのイメージの操作](https://go.microsoft.com/fwlink/?LinkId=202897)

[CSV ファイルへのエクスポート](https://msdn.microsoft.com/library/ms155919.aspx)
