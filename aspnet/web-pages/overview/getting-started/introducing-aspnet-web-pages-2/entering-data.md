---
uid: web-pages/overview/getting-started/introducing-aspnet-web-pages-2/entering-data
title: ASP.NET Web ページの概要-Forms | を使用したデータベースデータの入力 |Microsoft Docs
author: Rick-Anderson
description: このチュートリアルでは、ASP.NET Web ページ (... を使用する場合に、入力フォームを作成し、フォームから取得したデータをデータベーステーブルに入力する方法について説明します。
ms.author: riande
ms.date: 05/28/2015
ms.assetid: d37c93fc-25fd-4e94-8671-0d437beef206
msc.legacyurl: /web-pages/overview/getting-started/introducing-aspnet-web-pages-2/entering-data
msc.type: authoredcontent
ms.openlocfilehash: b9354a7b97a7df9020a681f709e16a92650cfcf0
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78506602"
---
# <a name="introducing-aspnet-web-pages---entering-database-data-by-using-forms"></a>ASP.NET Web ページの概要-フォームを使用してデータベースデータを入力する

[Tom FitzMacken](https://github.com/tfitzmac)

> このチュートリアルでは、ASP.NET Web ページ (Razor) を使用するときに、入力フォームを作成し、フォームから取得したデータをデータベーステーブルに入力する方法について説明します。 [ASP.NET Web ページの HTML フォームの基本](https://go.microsoft.com/fwlink/?LinkId=251581)を通じてシリーズを完了していることを前提としています。
> 
> ここでは、次の内容について学習します。
> 
> - 入力フォームを処理する方法の詳細については、こちらを参照してください。
> - データベースにデータを追加 (挿入) する方法。
> - ユーザーがフォームに必須の値 (ユーザー入力の検証方法) を入力したことを確認する方法。
> - 検証エラーを表示する方法。
> - 現在のページから別のページに移動する方法。
>   
> 
> 説明する機能/テクノロジ:
> 
> - `Database.Execute` メソッド。
> - SQL `Insert Into` ステートメント
> - `Validation` ヘルパー。
> - `Response.Redirect` メソッド。

## <a name="what-youll-build"></a>作成するアプリケーション:

前のチュートリアルでは、データベースを作成する方法を説明しました。 WebMatrix でデータベースを直接編集してデータベースデータを入力し、**データベース**ワークスペースで作業していました。 ただし、ほとんどのアプリでは、データベースにデータを格納するのは実用的な方法ではありません。 このチュートリアルでは、web ベースのインターフェイスを作成して、ユーザーまたはユーザーがデータを入力してデータベースに保存できるようにします。

新しいムービーを入力できるページを作成します。 このページには、フィールド (テキストボックス) を含む入力フォームが含まれます。このフォームでは、ムービーのタイトル、ジャンル、および年を入力できます。 ページは次のようになります。

![ブラウザーでの [ムービーの追加] ページ](entering-data/_static/image1.png)

テキストボックスは、次のマークアップのように表示される HTML `<input>` 要素になります。

`<input type="text" name="genre" value="" />`

## <a name="creating-the-basic-entry-form"></a>基本的な入力フォームの作成

*Addmovie. cshtml*という名前のページを作成します。

ファイルの内容を次のマークアップに置き換えます。 すべてを上書きします。コードブロックは、すぐに先頭に追加します。

[!code-cshtml[Main](entering-data/samples/sample1.cshtml)]

この例は、フォームを作成するための一般的な HTML を示しています。 この例では、テキストボックスと [送信] ボタンに `<input>` 要素を使用しています。 テキストボックスのキャプションは、標準の `<label>` 要素を使用して作成されます。 `<fieldset>` 要素と `<legend>` 要素は、フォームの周囲に便利なボックスを配置します。

このページの `<form>` 要素では、`method` 属性の値として `post` が使用されていることに注意してください。 前のチュートリアルでは、`get` メソッドを使用するフォームを作成しました。 これは正しいことです。フォームがサーバーに値を送信しましたが、要求では何も変更されていません。 これまでは、さまざまな方法でデータをフェッチしました。 ただし、このページで*は*変更を行います。新しいデータベースレコードを追加します。 したがって、このフォームでは `post` メソッドを使用する必要があります。 (`GET` 操作と `POST` 操作の違いの詳細については、前のチュートリアルの「[GET、POST、および HTTP 動詞の安全性](https://go.microsoft.com/fwlink/?LinkId=251581#GET,_POST,_and_HTTP_Verb_Safety)に関する補足記事」を参照してください)。

各テキストボックスには `name` 要素 (`title`、`genre`、`year`) があることに注意してください。 前のチュートリアルで見たように、これらの名前は、後でユーザーの入力を取得できるようにする必要があるため、重要です。 任意の名前を使用できます。 意味のある名前を使用して、使用しているデータを思い出すのに役立ちます。

各 `<input>` 要素の `value` 属性には、いくつかの Razor コード (たとえば、`Request.Form["title"]`) が含まれています。 フォームが送信された後にテキストボックスに入力した値 (存在する場合) を保持するために、前のチュートリアルでこのトリックのバージョンを学習しました。

## <a name="getting-the-form-values"></a>フォーム値の取得

次に、フォームを処理するコードを追加します。 概要では、次の操作を行います。

1. ページが投稿されている (送信された) かどうかを確認します。 ユーザーがボタンをクリックしたときにのみコードを実行する場合は、ページが最初に実行されるときではなく、コードを実行します。
2. ユーザーがテキストボックスに入力した値を取得します。 この場合、フォームは `POST` 動詞を使用しているため、`Request.Form` コレクションからフォーム値を取得します。
3. 新しいレコードとして、*ムービー*データベーステーブルに値を挿入します。

ファイルの先頭に次のコードを追加します。

[!code-cshtml[Main](entering-data/samples/sample2.cshtml)]

最初の数行では、テキストボックスの値を保持するために、変数 (`title`、`genre`、および `year`) を作成します。 行 `if(IsPost)` は、ユーザーが **[ムービーの追加]** ボタンをクリックしたとき (つまり、フォームがポストされたとき) に*のみ*変数が設定されるようにします。

前のチュートリアルで見たように、`Request.Form["name"]`のような式を使用してテキストボックスの値を取得します。ここで、 *name*は `<input>` 要素の名前です。

変数の名前 (`title`、`genre`、および `year`) は任意です。 `<input>` 要素に割り当てる名前と同様に、任意の要素を呼び出すことができます。 (変数の名前は、フォームの `<input>` 要素の name 属性と一致する必要はありません)。ただし、`<input>` の要素と同様に、変数名に含まれるデータを反映する変数名を使用することをお勧めします。 コードを記述すると、一貫性のある名前を使用すると、使用しているデータを簡単に思い出すことができます。

## <a name="adding-data-to-the-database"></a>データベースへのデータの追加

追加したコードブロックで、`if` ブロックの右中かっこ (`}`) の*内側*に (コードブロックの内部だけではなく)、次のコードを追加します。

[!code-csharp[Main](entering-data/samples/sample3.cs)]

この例は、前のチュートリアルでデータをフェッチして表示するために使用したコードに似ています。 `db =` で始まる行は、前のようにデータベースを開き、次の行では前述のように SQL ステートメントを定義します。 ただし今回は、SQL `Insert Into` ステートメントを定義します。 次の例は、`Insert Into` ステートメントの一般的な構文を示しています。

`INSERT INTO table (column1, column2, column3, ...) VALUES (value1, value2, value3, ...)`

つまり、挿入するテーブルを指定し、挿入する列を一覧表示して、挿入する値を一覧表示します。 (前述のように、SQL では大文字と小文字は区別されませんが、コマンドを読みやすくするためにキーワードを大文字にすることがあります)。

挿入しようとしている列は、コマンドの `(Title, Genre, Year)`に既に表示されています。 興味深いのは、テキストボックスからコマンドの `VALUES` 部分に値を取得する方法です。 実際の値の代わりに、`@0`、`@1`、および `@2`が表示されます。これは当然のプレースホルダーです。 コマンド (`db.Execute` 行) を実行すると、テキストボックスから受け取った値が渡されます。

**重要!** SQL ステートメントでユーザーがオンラインで入力したデータを含める唯一の方法は、ここで説明するようにプレースホルダーを使用することです (`VALUES(@0, @1, @2)`)。 ユーザー入力を SQL ステートメントに連結する場合は、「 [ASP.NET Web ページの基本フォーム](https://go.microsoft.com/fwlink/?LinkId=251581)」 (前のチュートリアル) で説明されているように、sql インジェクション攻撃を受けます。

`if` ブロックの内部で、`db.Execute` 行の後に次の行を追加します。

[!code-css[Main](entering-data/samples/sample4.css)]

新しいムービーがデータベースに挿入された後、この行に移動して (リダイレクト) *、ムービーページに*移動します。これにより、先ほど入力したムービーが表示されます。 `~` 演算子は、"web サイトのルート" を意味します。 (`~` 演算子は、HTML ではなく ASP.NET ページでのみ機能します)。

完全なコードブロックは、次の例のようになります。

[!code-cshtml[Main](entering-data/samples/sample5.cshtml)]

## <a name="testing-the-insert-command-so-far"></a>挿入コマンドのテスト (これまで)

まだ完了していませんが、テストには時間がかかるようになりました。

WebMatrix のファイルのツリービューで、[ *Addmovie. cshtml* ] ページを右クリックし、 **[ブラウザーで起動]** をクリックします。

![ブラウザーでの [ムービーの追加] ページ](entering-data/_static/image2.png)

(ブラウザーに別のページが表示された場合は、URL が `http://localhost:nnnnn/AddMovie`) であることを確認してください *。ここで、"は、* 使用しているポート番号です。"

エラーページを表示しましたか? その場合は、それを注意深く読んで、コードが前に示したものと正確に一致していることを確認してください。

&mdash; の形式でムービーを入力します。たとえば、"Kane"、"ドラマ"、"1941" を使用します。 (または任意のもの) **[ムービーの追加]** をクリックします。

すべてうまくいくと、*ムービー*ページにリダイレクトされます。 新しいムービーが表示されていることを確認します。

![新しく追加されたムービーを示すムービーページ](entering-data/_static/image3.png)

## <a name="validating-user-input"></a>ユーザー入力の検証

*Addmovie*ページに戻り、もう一度実行します。 別のムービーを入力しますが、今回はタイトルだけを入力し &mdash; たとえば、雨に「Singin' と入力します。 **[ムービーの追加]** をクリックします。

もう一度*ムービー*ページにリダイレクトされます。 新しいムービーは検索できますが、完全ではありません。

![値が不足している新しいムービーを示すムービーページ](entering-data/_static/image4.png)

*ムービー*テーブルを作成したときに、どのフィールドも null にできないと明示的に言いました。 ここには新しい映画の入力フォームがあり、フィールドを空白のままにしています。 これはエラーです。

この場合、データベースはエラーを実際には発生 (または*スロー*) しませんでした。 ジャンルまたは年を指定していないため、 *Addmovie*ページのコードでは、これらの値がいわゆる*空の文字列*として扱われます。 SQL `Insert Into` コマンドの実行時に、ジャンルと年のフィールドには有用なデータが含まれていませんでしたが、これらは null ではありませんでした。

当然ながら、ユーザーが半空のムービー情報をデータベースに入力できないようにしたいと考えています。 解決策は、ユーザーの入力を検証することです。 最初に、検証では、ユーザーがすべてのフィールドに対して値を入力したことを確認します (つまり、すべてのフィールドに空の文字列が含まれているわけではありません)。

> [!TIP]
> 
> **Null および空の文字列**
> 
> プログラミングでは、"値なし" の異なる概念を区別しています。 一般に、値が何も設定または初期化されていない場合は、 *null*になります。 これに対し、文字データ (文字列) を必要とする変数は、*空の文字列*に設定できます。 この場合、値は null ではありません。長さが0の文字列に明示的に設定されているだけです。 次の2つのステートメントは、違いを示しています。
> 
> [!code-csharp[Main](entering-data/samples/sample6.cs)]
> 
> これは少し複雑ですが、重要な点は、`null` が未確定の状態を表すことです。
> 
> 次に、値が null で、空の文字列であるかを正確に理解しておくことが重要です。 [ *Addmovie* ] ページのコードでは、`Request.Form["title"]` を使用してテキストボックスの値を取得します。 ページが最初に実行されたとき (ボタンをクリックする前) に、`Request.Form["title"]` の値が null になります。 ただし、フォームを送信すると、`Request.Form["title"]` `title` テキストボックスの値が取得されます。 明らかではありませんが、空のテキストボックスは null ではありません。空の文字列が含まれているだけです。 そのため、ボタンクリックに応答してコードを実行すると、`Request.Form["title"]` に空の文字列が含まれます。
> 
> この区別が重要なのはなぜですか。 *ムービー*テーブルを作成したときに、どのフィールドも null にできないと明示的に言いました。 しかし、ここでは新しい映画の入力フォームがあり、フィールドを空白のままにしています。 ジャンルまたは年の値がない新しいムービーを保存しようとしたときに、データベースが文句を言います。 しかし、そのようなテキストボックスを空白のままにしても、値が null ではない場合でも、これは &mdash; です。これらは空の文字列です。 その結果、これらの列が null ではなく &mdash; 空で、データベースに新しいムービーを保存できるようになります。 &mdash; 値。 そのため、ユーザーが空の文字列を送信しないようにする必要があります。これは、ユーザーの入力を検証することによって行うことができます。

### <a name="the-validation-helper"></a>検証ヘルパー

ASP.NET Web ページには、ユーザーが要件を満たすデータを確実に入力できるようにするために使用できる、`Validation` helper &mdash; のヘルパー &mdash; が含まれています。 `Validation` helper は、ASP.NET Web ページに組み込まれているヘルパーの1つであるため、前のチュートリアルで Gravatar helper をインストールしたのと同じ方法で、NuGet を使用してパッケージとしてインストールする必要はありません。

ユーザーの入力を検証するには、次の操作を行います。

- コードを使用して、ページ上のテキストボックスに値を要求するように指定します。
- すべてが正しく検証された場合にのみムービー情報がデータベースに追加されるように、テストをコードに配置します。
- エラーメッセージを表示するコードをマークアップに追加します。

*Addmovie*ページのコードブロックで、変数宣言の前の上部にある、次のコードを追加します。

[!code-csharp[Main](entering-data/samples/sample7.cs)]

エントリを要求するフィールド (`<input>` 要素) ごとに `Validation.RequireField` を1回呼び出します。 ここに示すように、呼び出しごとにカスタムエラーメッセージを追加することもできます。 (ここでは、メッセージをさまざまな方法で表示するようにしています)。

問題が発生した場合は、新しいムービー情報がデータベースに挿入されないようにする必要があります。 `if(IsPost)` ブロックで `&&` (論理 AND) を使用して、`Validation.IsValid()`をテストする別の条件を追加します。 完了すると、`if(IsPost)` ブロック全体は次のようになります。

[!code-csharp[Main](entering-data/samples/sample8.cs)]

`Validation` helper を使用して登録したフィールドのいずれかに検証エラーがある場合、`Validation.IsValid` メソッドは false を返します。 その場合、そのブロック内のコードは実行されないため、無効なムービーエントリはデータベースに挿入されません。 もちろん、*映画*ページにリダイレクトされることはありません。

検証コードを含む完全なコードブロックは、次の例のようになります。

[!code-cshtml[Main](entering-data/samples/sample9.cshtml?highlight=10)]

## <a name="displaying-validation-errors"></a>検証エラーの表示

最後の手順では、エラーメッセージを表示します。 各検証エラーの個々のメッセージを表示することも、概要またはその両方を表示することもできます。 このチュートリアルでは、そのしくみを確認できるように、両方を実行します。

検証する各 `<input>` 要素の横に、`Html.ValidationMessage` メソッドを呼び出し、検証する `<input>` 要素の名前を渡します。 `Html.ValidationMessage` メソッドは、エラーメッセージを表示する場所に配置します。 ページが実行されると、`Html.ValidationMessage` メソッドは、検証エラーが発生する `<span>` 要素をレンダリングします。 (エラーがない場合は、`<span>` 要素がレンダリングされますが、テキストは表示されません)。

ページのマークアップを変更して、次の例のように、ページ上の3つの `<input>` 要素のそれぞれに `Html.ValidationMessage` メソッドを含めます。

[!code-cshtml[Main](entering-data/samples/sample10.cshtml?highlight=3,8,13)]

概要のしくみを確認するには、ページの `<h1>Add a Movie</h1>` 要素の直後に次のマークアップとコードを追加します。

[!code-cshtml[Main](entering-data/samples/sample11.cshtml)]

既定では、`Html.ValidationSummary` メソッドは、すべての検証メッセージをリスト (`<div>` 要素内にある `<ul>` 要素) に表示します。 `Html.ValidationMessage` メソッドと同様に、検証の概要のマークアップは常に表示されます。エラーがない場合は、リスト項目はレンダリングされません。

概要は、フィールド固有の各エラーを表示するために `Html.ValidationMessage` メソッドを使用する代わりに、検証メッセージを表示する別の方法にすることができます。 または、概要と詳細の両方を使用できます。 または、`Html.ValidationSummary` メソッドを使用して一般的なエラーを表示し、個々の `Html.ValidationMessage` 呼び出しを使用して詳細を表示することもできます。

完成したページは次の例のようになります。

[!code-cshtml[Main](entering-data/samples/sample12.cshtml)]

これで終了です。 これで、ムービーを追加して1つ以上のフィールドを残して、ページをテストできるようになりました。 この操作を行うと、次のようなエラーが表示されます。

![検証エラーメッセージが表示された [ムービーの追加] ページ](entering-data/_static/image5.png)

## <a name="styling-the-validation-error-messages"></a>検証エラーメッセージのスタイル設定

エラーメッセージがあることを確認できますが、非常に優れているわけではありません。 ただし、エラーメッセージのスタイルを簡単に行うことができます。

`Html.ValidationMessage`によって表示される個々のエラーメッセージのスタイルを指定するには、`field-validation-error`という名前の CSS スタイルクラスを作成します。 検証の概要の外観を定義するには、`validation-summary-errors`という名前の CSS スタイルクラスを作成します。

この手法の動作を確認するには、ページの `<head>` セクション内に `<style>` 要素を追加します。 次に、`field-validation-error` という名前のスタイルクラスと、次の規則を含む `validation-summary-errors` を定義します。

[!code-cshtml[Main](entering-data/samples/sample13.cshtml?highlight=4-17)]

通常、スタイル情報は別の *.css*ファイルに配置することをお勧めしますが、わかりやすくするために、これをページに配置することができます。 (このチュートリアルの後の方で、CSS ルールを別の *.css*ファイルに移動します)。

検証エラーが発生した場合、`Html.ValidationMessage` メソッドは `class="field-validation-error"`を含む `<span>` 要素をレンダリングします。 そのクラスのスタイル定義を追加することによって、どのようなメッセージが表示されるかを構成できます。 エラーが発生した場合、`ValidationSummary` メソッドは同様に、属性 `class="validation-summary-errors"`を動的に表示します。

もう一度ページを実行し、いくつかのフィールドを意図的に省略します。 エラーはさらに顕著になりました。 (実際には、何ができるかを説明するだけです)。

![スタイル設定された検証エラーを示す [ムービーの追加] ページ](entering-data/_static/image6.png)

## <a name="adding-a-link-to-the-movies-page"></a>[ムービー] ページへのリンクの追加

最後の手順の1つは、元のムービーリストから*Addmovie*ページにアクセスするのに便利なことです。

もう一度 [*ムービー* ] ページを開きます。 `WebGrid` ヘルパーの後に続く `</div>` タグの後に、次のマークアップを追加します。

[!code-cshtml[Main](entering-data/samples/sample14.cshtml)]

前述のように、ASP.NET は、`~` 演算子を web サイトのルートとして解釈します。 `~` 演算子を使用する必要はありません。マークアップ `<a href="./AddMovie">Add a movie</a>` またはその他の方法を使用して、HTML によって認識されるパスを定義できます。 ただし、`~` 演算子は、サイトの柔軟性が向上するため、Razor ページへのリンクを作成するときによく使用される一般的な方法です。現在のページをサブフォルダーに移動しても、リンクは*Addmovie*ページに移動します。 (`~` 演算子は、 *cshtml*ページでのみ機能することに注意してください。 ASP.NET はこれを理解していますが、標準の HTML ではありません)。

完了したら、[*ムービー* ] ページを実行します。 次のようなページが表示されます。

![[ムービーの追加] ページへのリンクを含むムービーページ](entering-data/_static/image7.png)

**[ムービーの追加]** リンクをクリックして、[ *addmovie* ] ページに移動することを確認します。

## <a name="coming-up-next"></a>次へ

次のチュートリアルでは、データベースに既に存在するデータをユーザーが編集できるようにする方法について説明します。

## <a name="complete-listing-for-addmovie-page"></a>AddMovie ページの完全な一覧

[!code-cshtml[Main](entering-data/samples/sample15.cshtml)]

## <a name="additional-resources"></a>その他のリソース

- [Razor 構文を使用した ASP.NET Web プログラミングの概要](https://go.microsoft.com/fwlink/?LinkID=202890)
- W3Schools サイトでの[SQL INSERT INTO ステートメント](http://www.w3schools.com/sql/sql_insert.asp)
- [ASP.NET Web ページサイトのユーザー入力を検証](https://go.microsoft.com/fwlink/?LinkId=253002)しています。 `Validation` ヘルパーの操作の詳細については、こちらを参照してください。

> [!div class="step-by-step"]
> [前へ](form-basics.md)
> [次へ](updating-data.md)
