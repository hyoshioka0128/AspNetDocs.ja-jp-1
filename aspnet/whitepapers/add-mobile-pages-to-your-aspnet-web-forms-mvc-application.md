---
uid: whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
title: '方法: モバイルページを ASP.NET Web フォーム/MVC アプリケーションに追加する |Microsoft Docs'
author: rick-anderson
description: ここでは、ASP.NET Web フォーム/MVC アプリケーションからモバイルデバイス用に最適化されたページを提供するさまざまな方法について説明し、アーキテクチャと...
ms.author: riande
ms.date: 01/20/2011
ms.assetid: 3124f28e-cc32-418a-afe3-519fa56f4c36
msc.legacyurl: /whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
msc.type: content
ms.openlocfilehash: 63c555358d06a9506bb5c8c993800c3307108192
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78462214"
---
# <a name="how-to-add-mobile-pages-to-your-aspnet-web-forms--mvc-application"></a>方法: ASP.NET Web フォームまたは MVC アプリケーションにモバイル ページを追加する

> **適用対象**
> 
> - ASP.NET Web フォームバージョン4.0
> - ASP.NET MVC バージョン3.0
> 
> **まとめ**
> 
> ここでは、ASP.NET Web フォーム/MVC アプリケーションからモバイルデバイス用に最適化されたページを提供するさまざまな方法について説明し、幅広いデバイスを対象とする場合に考慮する必要があるアーキテクチャと設計上の問題について説明します。 このドキュメントでは、ASP.NET 2.0 から3.5 への ASP.NET モバイルコントロールが互換性のために残されている理由についても説明し、いくつかの最新の代替手段について説明します。

## <a name="contents"></a>内容

- 概要
- アーキテクチャオプション
- ブラウザーとデバイスの検出
- ASP.NET Web Forms アプリケーションでモバイル専用ページを表示する方法
- ASP.NET MVC アプリケーションでモバイル専用ページを表示する方法
- その他のリソース

ASP.NET Web フォームと MVC の両方に関するこのホワイトペーパーの手法について説明したダウンロード可能なコードサンプルについては、「 [ASP.NET を使用したサイトの Mobile Apps &](https://docs.microsoft.com/aspnet/mobile/overview)」を参照してください。

## <a name="overview"></a>概要

モバイルデバイス–スマートフォン、機能フォン、タブレット– Web にアクセスする手段として、引き続き広く普及しています。 多くの web 開発者や web 指向企業にとって、このようなデバイスを使用する訪問者のための優れた閲覧エクスペリエンスを提供することがますます重要になっています。

### <a name="how-earlier-versions-of-aspnet-supported-mobile-browsers"></a>以前のバージョンの ASP.NET でサポートされているモバイルブラウザー

*ASP.NET Mobile Controls*に含まれる ASP.NET バージョン2.0 から3.5 に*は、* MobileControls 名前空間と名前空間にあるモバイルデバイスの一連のサーバーコントロールが含まれています。 アセンブリはまだ ASP.NET 4 に含まれていますが、非推奨とされます。 開発者は、このペーパーで説明されているような、より新しいアプローチに移行することをお勧めします。

ASP.NET モバイルコントロールが不使用とマークされている理由は、2005以前の共通の携帯電話を中心に設計されているためです。 これらのコントロールは、主に、その時代 (標準の HTML ではなく) WML または cHTML マークアップを、その時代 (年号) の WAP ブラウザー用にレンダリングするように設計されています。 しかし、多くのプロジェクトでは、ほとんどのプロジェクトに対して WAP、WML、および cHTML が関係していません。これは、HTML がモバイルブラウザーやデスクトップブラウザーのユビキタスマークアップ言語と同じになるようになったためです。

### <a name="the-challenges-of-supporting-mobile-devices-today"></a>現在、モバイルデバイスをサポートするための課題

モバイルブラウザーでは HTML がほぼ一般にサポートされていますが、優れたモバイルブラウズエクスペリエンスを作成するためには、多くの課題に直面しています。

- ***画面サイズ***-モバイルデバイスはフォームによって大きく異なり、多くの場合、画面はデスクトップモニターよりもはるかに小さくなります。 そのため、まったく異なるページレイアウトを設計する必要がある場合があります。
- ***入力方式***–一部のデバイスにはキーパッドがあり、styluses はありますが、タッチを使用します。 場合によっては、複数のナビゲーションメカニズムとデータ入力方法を検討する必要があります。
- ***標準への準拠***–多くのモバイルブラウザーでは、最新の HTML、CSS、または JavaScript の標準がサポートされていません。
- ***帯域幅***–携帯データネットワークのパフォーマンスは大きく異なります。また、一部のエンドユーザーは、メガバイト単位で課金される tariffs を使用しています。

オールインワンサイズのソリューションはありません。アプリケーションの外観と動作は、デバイスにアクセスするデバイスによって異なります。 必要なモバイルサポートのレベルによっては、これはデスクトップの "browser ウォーズ" よりも web 開発者にとって大きな課題になる可能性があります。

初めてモバイルブラウザーのサポートに近づいた開発者は、おそらく、最新のスマートフォン (Windows Phone 7、iPhone、Android など) をサポートすることが重要であると考えられています。ハードウェア. しかし、低価格の電話は依然として非常に人気があり、その所有者はこれらを使用して web を閲覧します。特に、携帯電話がブロードバンド接続よりも簡単に利用できる国では、 お客様のビジネスでは、顧客の可能性を考慮して、サポートするデバイスの範囲を決める必要があります。 非常に優れた正常性 spa のオンラインパンフレットを構築している場合は、高度なスマートフォンのみを対象とするビジネス上の意思決定を行うことができます。一方、映画のチケット予約システムを作成する場合は、あまり強力でない訪問者を考慮する必要があります。電話.

## <a name="architectural-options"></a>アーキテクチャオプション

ASP.NET Web フォームまたは MVC の特定の技術的な詳細に進む前に、一般的な web 開発者には、モバイルブラウザーをサポートするための主な3つのオプションが用意されています。

1. ***何もしない–*** 標準のデスクトップ指向 web アプリケーションを作成し、モバイルブラウザーに依存して、それを許容できるようにレンダリングするだけです。 

    - **利点**: 追加の作業を行わずに、実装して保守するための最もコストの高いオプションです。
    - **欠点**: 最も悪いエンドユーザーエクスペリエンスを提供します。 

        - 最新のスマートフォンでは、デスクトップブラウザーと同様に HTML がレンダリングされる場合がありますが、ユーザーは小さい画面でコンテンツを使用するために、水平方向および垂直方向にズームおよびスクロールすることが強制されます。 これは最適なものではありません。
        - 古いデバイスや機能の電話では、適切な方法でマークアップをレンダリングできない場合があります。
        - 最新のタブレットデバイス (画面がラップトップの画面ほど大きくなる可能性がある) でも、さまざまな相互作用ルールが適用されます。 タッチベースの入力は、より大きなボタンやリンクをさらに重ねることで最適に動作します。また、マウスカーソルをフライアウトメニュー上に置く方法もありません。
2. ***クライアント上の問題を解決*する–** CSS と[プログレッシブ拡張機能](http://en.wikipedia.org/wiki/Progressive_enhancement)を使用すると、マークアップ、スタイル、およびスクリプトを作成して、どのブラウザーで実行しているかに適合させることができます。 たとえば、 [CSS 3 メディアクエリ](http://www.w3.org/TR/2010/CR-css3-mediaqueries-20100727/)では、選択したしきい値よりも画面が狭いデバイスで1列のレイアウトに変換する複数列のレイアウトを作成できます。 

    - **利点**: 使用されている特定のデバイスのレンダリングを最適化します。これには、どのような画面と入力特性に従っても、将来のデバイスは不明です。
    - **利点**: すべてのデバイスの種類で、サーバー側のロジックを簡単に共有できます (コードの重複を最小限に抑えることができます)
    - **欠点**: モバイルデバイスはデスクトップデバイスとは異なるため、モバイルページはデスクトップページとはまったく別のものにして、さまざまな情報が表示されるようにすることをお勧めします。 このようなバリエーションは、CSS だけを通じて堅牢で実現するのは効率的ではありません。特に、古いデバイスが CSS ルールを解釈する際にどの程度一貫性がないかを検討 これは、特に CSS 3 の属性に当てはまります。
    - **短所**: さまざまなデバイスに対して、サーバー側のロジックとワークフローの違いをサポートしません。 たとえば、CSS だけを使用して、モバイルユーザー向けの簡単なショッピングカートのチェックアウトワークフローを実装することはできません。
    - **欠点**: 帯域幅の使用効率が低い。 対象のデバイスがその情報のサブセットのみを使用する場合でも、サーバーは、すべての可能なデバイスに適用されるマークアップとスタイルを送信する必要があります。
3. ***サーバー上の問題を解決し*** ます。サーバーがどのデバイスにアクセスしているかを認識している場合、またはそのデバイスの画面サイズと入力方法、モバイルデバイスかどうかなど、少なくともそのデバイスの特性をサーバーが認識している場合は、異なるロジックを実行して、異なる HTML マークアップを出力できます。 

    - **利点:** 最大限の柔軟性。 モバイルのサーバー側のロジックを変更したり、目的のデバイス固有のレイアウトに合わせてマークアップを最適化したりできる量に制限はありません。
    - **利点:** 効率的な帯域幅の使用。 ターゲットデバイスが使用するマークアップとスタイル設定情報を送信するだけです。
    - **欠点:** 場合によっては、労力やコードを強制的に繰り返す必要があります (たとえば、Web フォームページまたは MVC ビューの類似したコピーを作成することになります)。 可能な場合は、基になるレイヤーまたはサービスに共通のロジックを考慮しますが、UI コードまたはマークアップの一部は重複して並列に保持する必要があります。
    - **欠点:** デバイスの検出は簡単ではありません。 既知のデバイスの種類とその特性 (常に最新の状態ではない可能性があります) のリストまたはデータベースが必要であり、すべての受信要求が正確に一致するとは限りません。 このドキュメントでは、後でいくつかのオプションとその落とし穴について説明します。

最良の結果を得るには、ほとんどの開発者がオプション (2) と (3) を結合する必要があることを見つけます。 スタイルの微妙な違いについては、クライアントでは CSS または JavaScript を使用することをお勧めしますが、データ、ワークフロー、またはマークアップの大きな違いはサーバー側のコードで最も効果的に実装されます。

### <a name="this-paper-focuses-on-server-side-techniques"></a>このホワイトペーパーでは、サーバー側の手法に焦点を当てています。

ASP.NET Web フォームと MVC は両方ともサーバー側テクノロジであるため、このホワイトペーパーでは、モバイルブラウザー用にさまざまなマークアップとロジックを生成できるサーバー側の手法に焦点を当てます。 もちろん、これをクライアント側の手法 (CSS 3 メディアクエリ、プログレッシブ拡張 JavaScript など) と組み合わせることもできますが、これは ASP.NET 開発よりも web デザインの方が重要です。

## <a name="browser-and-device-detection"></a>ブラウザーとデバイスの検出

モバイルデバイスをサポートするためのすべてのサーバー側の手法に関する重要な前提条件は、ビジターが使用しているデバイスを把握することです。 実際には、デバイスの製造元とモデル番号を知るよりも、デバイスの*特性*がわかっていることがわかります。 次のような特性があります。

- モバイルデバイスですか。
- Input メソッド (マウス/キーボード、タッチ、キーボードボタン、ジョイスティック、...)
- 画面のサイズ (物理的およびピクセル単位)
- サポートされているメディアとデータ形式
- など

モデル番号よりも特性に基づいて決定することをお勧めします。これは、将来のデバイスをより適切に処理できるようになるためです。

### <a name="using-aspnets-built-in-browser-detection-support"></a>ASP を使用する。NET の組み込みのブラウザー検出のサポート

ASP.NET Web フォームと MVC 開発者は、*要求ブラウザー*オブジェクトのプロパティを調べることによって、閲覧ブラウザーの重要な特性をすぐに見つけることができます。 たとえば、「」を参照してください。

- Request.Browser.IsMobileDevice
- MobileDeviceManufacturer、MobileDeviceModel を要求します。
- Request.Browser.ScreenPixelsWidth
- Request.Browser.SupportsXmlHttp
- ...参照できます他の多くのユーザー

バックグラウンドでは、ASP.NET プラットフォームは、一連のブラウザー定義 XML ファイル内の正規表現との受信*ユーザーエージェント*(UA) HTTP ヘッダーを照合します。 既定では、プラットフォームに多くの一般的なモバイルデバイスの定義が含まれています。また、認識したい他のユーザーに対してカスタムブラウザー定義ファイルを追加することもできます。 詳細については、MSDN ページ[ASP.NET Web サーバーコントロールとブラウザー機能](https://msdn.microsoft.com/library/x3k2ssx2.aspx)に関するページを参照してください。

### <a name="using-the-wurfl-device-database-via-51degreesmobi-foundation"></a>51Degrees.mobi Foundation による WURFL デバイスデータベースの使用

ASP で実行します。多くのアプリケーションでは、NET の組み込みのブラウザー検出サポートで十分ですが、大きなケースは2つあります。

- ***最新のデバイスを認識する***(ブラウザー定義ファイルを手動で作成する必要はありません)。 .NET 4 のブラウザー定義ファイルは、Windows Phone 7、Android フォン、Opera モバイルブラウザー、または Apple Ipad を認識するのに十分な最新ではないことに注意してください。
- ***デバイスの機能の詳細については、***「」を参照してください。 場合によっては、デバイスの入力方法 (タッチ vs パッドなど)、またはブラウザーがサポートするオーディオ形式について知る必要があります。 この情報は、標準のブラウザー定義ファイルでは使用できません。

[*ワイヤレスユニバーサルリソースファイル*(wurfl) プロジェクト](http://wurfl.sourceforge.net/)は、現在使用されているモバイルデバイスに関する最新の詳細情報を保持します。

.NET 開発者向けのすばらしいニュースは、その ASP です。NET のブラウザー検出機能は拡張可能であるため、これらの問題を克服するために拡張することができます。 たとえば、オープンソースの[*51Degrees.mobi Foundation*](https://github.com/51Degrees/dotNET-Device-Detection)ライブラリをプロジェクトに追加できます。 これは、WURFL データを直接読み取り、ASP にフックする ASP.NET IHttpModule またはブラウザー機能プロバイダーです (Web フォームと MVC アプリケーションの両方で使用できます)。NET の組み込みのブラウザー検出メカニズム。 モジュールをインストールすると、要求されたブラウザーには、より正確で詳細な情報が表示され*ます。* 前述の多くのデバイスが正しく認識され、機能 (入力方式などの追加機能を含む) が表示されます。 詳細については、プロジェクトのドキュメントを参照してください。

## <a name="how-web-forms-applications-can-present-mobile-specific-pages"></a>Web フォームアプリケーションでモバイル専用ページを表示する方法

既定では、次のように、一般的なモバイルデバイスに新しい Web フォームアプリケーションが表示されます。

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image1.png)

どちらのレイアウトも、非常にモバイルに適しているとは言えません。このページは、縦向きの小さな画面ではなく、大規模な横向きのモニター向けに設計されています。 では、どうすればよいでしょうか。

このドキュメントで既に説明したように、モバイルデバイス用にページを調整する方法は多数あります。 一部の手法はサーバーベースであり、他の方法はクライアント上で実行されます。

### <a name="creating-a-mobile-specific-master-page"></a>モバイル専用マスターページの作成

要件に応じて、すべての訪問者に同じ Web フォームを使用できますが、2つの独立したマスターページがあります。1つはデスクトップ訪問者用、もう1つはモバイル訪問者用です。 これにより、ページロジックを強制的に複製しなくても、CSS スタイルシートまたは最上位レベルの HTML マークアップをモバイルデバイスに合わせて変更できる柔軟性が得られます。

これは簡単に行うことができます。 たとえば、Web フォームに次のような PreInit ハンドラーを追加できます。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample1.cs)]

次に、アプリケーションの最上位フォルダーに、Mobile という名前のマスターページを作成します。これは、モバイルデバイスが検出されたときに使用されます。 モバイルマスターページは、必要に応じてモバイル固有の CSS スタイルシートを参照できます。 デスクトップの訪問者には、モバイルデバイスではなく、既定のマスターページが表示されます。

### <a name="creating-independent-mobile-specific-web-forms"></a>モバイル専用の独立した Web フォームを作成する

柔軟性を最大限に高めるために、さまざまな種類のデバイスに個別のマスターページを用意するだけでなく、さらに多くのことを行うことができます。 一連の*Web フォームページ*(デスクトップブラウザー用に1セット、モバイル用に別のセット) をそれぞれ実装できます。 これは、モバイル訪問者に対して非常に異なる情報やワークフローを提示する場合に最適です。 このセクションの残りの部分では、この方法について詳しく説明します。

デスクトップブラウザー用にデザインされた Web フォームアプリケーションが既に存在する場合、最も簡単な方法は、プロジェクト内に "Mobile" というサブフォルダーを作成し、そこにモバイルページを作成することです。 他の Web フォームアプリケーションで使用するのと同じ手法を使用して、独自のマスターページ、スタイルシート、およびページを含むサブサイト全体を構築できます。 必ずしもデスクトップサイト内の*すべて*のページに対して同等のモバイルを作成する必要はありません。モバイル訪問者にとって意味のある機能のサブセットを選択できます。

モバイルページは、必要に応じて、一般的な静的リソース (画像、JavaScript、CSS ファイルなど) を通常のページと共有できます。 "Mobile" フォルダーは、IIS でホストされている場合は個別のアプリケーションとしてマークされ*ない*ため (Web フォームページの単純なサブフォルダー)、デスクトップページと同じ構成、セッションデータ、およびその他のインフラストラクチャもすべて共有されます。

> [!NOTE]
> 通常、この方法にはコードの重複が含まれます (モバイルページはデスクトップページと類似点を共有する可能性があります)。一般的なビジネスロジックやデータアクセスコードを、共有されている基になるレイヤーまたはサービスに分割することが重要です。 それ以外の場合は、アプリケーションの作成と保守を2倍にする必要があります。

#### <a name="redirecting-mobile-visitors-to-your-mobile-pages"></a>モバイルページへのモバイルユーザーのリダイレクト

多くの場合、モバイルユーザーを参照セッション (セッションのすべての要求ではありません) の*最初*の要求でのみモバイルページにリダイレクトすると便利です。

- そうすれば、モバイル訪問者はデスクトップページに "デスクトップバージョン" に移動するだけで簡単にアクセスできるようになります。 訪問者は、セッションの最初の要求ではなくなったため、モバイルページにリダイレクトされません。
- サイトのデスクトップとモバイルの部分で共有されている動的リソース (たとえば、サイトのデスクトップとモバイルの両方の部分が IFRAME に表示される共通の Web フォームがある場合や、特定の Ajax ハンドラー) に対する要求を妨げるリスクを回避します。

これを行うには、**セッション\_開始**メソッドにリダイレクトロジックを配置します。 たとえば、次のメソッドを Global.asax.cs ファイルに追加します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample2.cs)]

#### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a>モバイルページを対象としたフォーム認証の構成

フォーム認証では、認証プロセス中および認証後に訪問者をリダイレクトできる場所について、特定の前提条件を使用します。

- ユーザーを認証する必要がある場合、フォーム認証では、デスクトップとモバイルユーザーのどちらであるかに関係なく、ユーザーがデスクトップのログインページにリダイレクトされます。これは、 *1 つ*のログイン URL の概念しか持たないためです。 モバイルログインページのスタイルを別にする場合は、モバイルユーザーを別のモバイルログインページにリダイレクトするように、デスクトップのログインページを拡張する必要があります。 たとえば、次のコードを**デスクトップ**ログインページの分離コードに追加します。 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample3.cs)]
- ユーザーがログインに成功すると、既定ではフォーム認証によって、既定のページが*1 つ*だけになるため、既定でデスクトップのホームページにリダイレクトされます。 ログインが成功した後にモバイルホームページにリダイレクトされるように、モバイルログインページを拡張する必要があります。 たとえば、**モバイル**ログインページの分離コードに次のコードを追加します。 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample4.cs)]
  
  このコードは、既定のプロジェクトテンプレートのように、ページに LoginUser というログインサーバーコントロールがあることを前提としています。

### <a name="working-with-output-caching"></a>出力キャッシュの操作

出力キャッシュを使用している場合は、既定では、デスクトップユーザーが特定の URL にアクセスし、その後、モバイルユーザーがキャッシュされたデスクトップ出力を受け取る可能性があることに注意してください。 この警告は、デバイスの種類ごとにマスターページを変更するか、デバイスの種類ごとに Web フォームをまったく個別に実装するかによって適用されます。

この問題を回避するには、ビジターがモバイルデバイスを使用しているかどうかに応じて、キャッシュエントリを変更するように ASP.NET に指示します。 次のように、VaryByCustom パラメーターをページの OutputCache 宣言に追加します。

[!code-aspx[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample5.aspx)]

次に、Global.asax.cs ファイルに次のメソッドオーバーライドを追加して、 *isMobileDevice*をカスタムキャッシュパラメーターとして定義します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample6.cs)]

これにより、ページへのモバイル訪問者は、以前にデスクトップ訪問者によってキャッシュに格納された出力を受信しなくなります。

### <a name="a-working-example"></a>実際の例

これらの手法を実際に確認するには、[このホワイトペーパーのコードサンプル](https://docs.microsoft.com/aspnet/mobile/overview)をダウンロードしてください。 Web フォームサンプルアプリケーションは、モバイルユーザーをモバイルと呼ばれるサブフォルダー内の一連のモバイル固有ページに自動的にリダイレクトします。 これらのページのマークアップとスタイル設定は、次のスクリーンショットからわかるように、モバイルブラウザー向けに最適化されています。

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image2.png)

モバイルブラウザー用にマークアップと CSS を最適化する方法の詳細については、このドキュメントの後半の「モバイルブラウザーのモバイルページのスタイル設定」を参照してください。

## <a name="how-aspnet-mvc-applications-can-present-mobile-specific-pages"></a>ASP.NET MVC アプリケーションでモバイル専用ページを表示する方法

モデルビューコントローラーのパターンでは、アプリケーションロジック (コントローラー内) とプレゼンテーションロジック (ビュー内) を分離するため、次のいずれかの方法を選択して、サーバー側コードでモバイルサポートを処理できます。

1. ***デスクトップとモバイルの両方のブラウザーで同じコントローラーとビューを使用しますが、デバイスの種類 * に応じて、さまざまな Razor レイアウトでビューをレンダリングします。** このオプションは、すべてのデバイスで同一のデータを表示していても、別の CSS スタイルシートを提供したり、モバイルのいくつかのトップレベル HTML 要素を変更したりする場合に最適です。
2. ***デスクトップとモバイルの両方のブラウザーで同じコントローラーを使用しますが、デバイスの種類によって異なるビューをレンダリング***します。 このオプションは、ほぼ同じデータを表示し、エンドユーザーに対して同じワークフローを提供しているが、使用されているデバイスに合わせてまったく異なる HTML マークアップを表示する場合に最適です。
3. **デスクトップとモバイルのブラウザー用に個別の領域を作成し、各 * の独立したコントローラーとビューを実装 *ます。** このオプションは、さまざまな情報を含む非常に異なる画面を表示し、デバイスの種類に合わせて最適化されたさまざまなワークフローを使用してユーザーを指導する場合に最適です。 これはコードの繰り返しを意味する場合がありますが、共通のロジックを基になるレイヤーまたはサービスに分解することによって、これを最小限に抑えることができます。

**最初**のオプションを使用して、デバイスの種類ごとに Razor レイアウトのみを変更する場合は、非常に簡単です。 \_ViewStart. cshtml ファイルを次のように変更します。

[!code-cshtml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample7.cshtml)]

これで、ページ構造とモバイルデバイス用に最適化された CSS ルールを使用して、\_LayoutMobile. cshtml という名前のモバイル固有のレイアウトを作成できるようになりました。

**2 番目**のオプションを使用して、ビジターのデバイスの種類に応じてまったく異なるビューを表示する場合は、 [Scott マン selman のブログ](http://www.hanselman.com/blog/ABetterASPNETMVCMobileDeviceCapabilitiesViewEngine.aspx)記事を参照してください。

このホワイトペーパーの残りの部分では、 **3 番目**のオプションである [モバイルデバイス用に個別のコントローラー*と*ビューを作成する] を中心に説明します。これにより、モバイル訪問者に提供される機能のサブセットを正確に制御できます。

### <a name="setting-up-a-mobile-area-within-your-aspnet-mvc-application"></a>ASP.NET MVC アプリケーション内でのモバイルエリアの設定

通常の方法で、既存の ASP.NET MVC アプリケーションに "Mobile" という名前の領域を追加できます。ソリューションエクスプローラーでプロジェクト名を右クリックし、[追加] を選択します。 その後、ASP.NET MVC アプリケーション内の他の領域の場合と同様に、コントローラーとビューを追加できます。 たとえば、モバイルユーザーのホームページとして機能する HomeController という新しいコントローラーをモバイルエリアに追加します。

### <a name="ensuring-the-url-mobile-reaches-the-mobile-homepage"></a>URL/モバイルがモバイルホームページに到達することを確認する

URL/モバイルでモバイルエリア内の HomeController のインデックスアクションに接続する場合は、ルーティング構成に2つの小さな変更を加える必要があります。 まず、次のコードに示すように、MobileAreaRegistration クラスを更新して、HomeController がモバイル領域の既定のコントローラーになるようにします。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample8.cs)]

つまり、モバイルホームページは、/Mobile/Home ではなく、/mobile に配置されるようになりました。これは、"Home" がモバイルページの既定のコントローラー名として暗黙的に使用されるためです。

次に、アプリケーションに2つ目の HomeController (つまり、既存のデスクトップに加えて) を追加すると、通常のデスクトップホームページが破損していることに注意してください。 "*ホーム" という名前のコントローラーと一致する "複数の種類が見つかりまし*た" というエラーが表示され、失敗します。 これを解決するには、最上位レベルのルーティング構成 (Global.asax.cs) を更新して、あいまいさがあるときにデスクトップ HomeController が優先されるように指定します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample9.cs)]

これでエラーが解消されます。 URL http:\/\/*サイト*にアクセスします。また、サイト/mobile/がデスクトップのホームページにアクセスし、http:\/\/*サイト*のホームページに移動します。

### <a name="redirecting-mobile-visitors-to-your-mobile-area"></a>モバイルユーザーをモバイルエリアにリダイレクトする

多くのさまざまな機能拡張ポイントがある ASP.NET MVC で可能なリダイレクト ロジックを挿入する方法はたくさんありますので。 便利なオプションの1つは、次の条件が満たされた場合にリダイレクトを実行するフィルター属性 [RedirectMobileDevicesToMobileArea] を作成することです。

1. これは、ユーザーのセッションでの最初の要求 (つまり、セッションは true に等しい) です。
2. 要求はモバイルブラウザーから取得されます (つまり、IsMobileDevice が true に等しい)
3. ユーザーが既にモバイルエリアにリソースを要求していない (つまり、URL の*パス*部分が/mobile で始まらない)

このホワイトペーパーに含まれているダウンロード可能なサンプルには、このロジックの実装が含まれています。 AuthorizeAttribute から派生した承認フィルターとして実装されます。これは、出力キャッシュを使用している場合でも正常に動作することを意味します (それ以外の場合、デスクトップのビジターが特定の URL にアクセスすると、デスクトップの出力がキャッシュされ、次のように処理される可能性があります)。その後のモバイル訪問者)。

フィルターとして、特定のコントローラーとアクションに適用するかどうかを選択できます。たとえば、

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample10.cs)]

... また、Global.asax.cs ファイル内のすべてのコントローラーとアクションに MVC 3*グローバルフィルター*として適用することもできます。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample11.cs)]

ダウンロード可能なサンプルでは、モバイル領域内の特定の場所にリダイレクトするこの属性のサブクラスを作成する方法も示しています。 つまり、たとえば、次のようなことが可能です。

- 既定でモバイルホームページにモバイル訪問者を送信するように、上記のようにグローバルフィルターを登録します。
- また、特別な [RedirectMobileDevicesToMobileProductPage] フィルターを "view product" アクションに適用して、モバイルユーザーが要求したすべての製品ページのモバイルバージョンにモバイル訪問者を与えます。
- また、フィルターの他の特殊なサブクラスも特定のアクションに適用し、モバイル訪問者を同等のモバイルページにリダイレクトします。

### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a>モバイルページを対象としたフォーム認証の構成

フォーム認証を使用している場合は、ユーザーがログインする必要があるときに、ユーザーが1つの特定の "ログオン" URL に自動的にリダイレクトされることに注意してください。これは既定では、 **/Account/LogOn**です。 これは、モバイルユーザーがデスクトップの "ログオン" アクションにリダイレクトされる可能性があることを意味します。

この問題を回避するには、デスクトップの [ログオン] アクションにロジックを追加して、モバイルユーザーをモバイルの "ログオン" アクションに再リダイレクトするようにします。 既定の ASP.NET MVC アプリケーションテンプレートを使用している場合は、AccountController のログオンアクションを次のように更新します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample12.cs)]

... 次に、モバイル領域で AccountController というコントローラーに対して、適切なモバイル固有の "ログオン" アクションを実装します。

### <a name="working-with-output-caching"></a>出力キャッシュの操作

[OutputCache] フィルターを使用している場合は、デバイスの種類に応じてキャッシュエントリを強制的に変更する必要があります。 たとえば、次のように記述します。

[!code-javascript[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample13.js)]

次に、Global.asax.cs ファイルに次のメソッドを追加します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample14.cs)]

これにより、ページへのモバイル訪問者は、以前にデスクトップ訪問者によってキャッシュに格納された出力を受信しなくなります。

### <a name="a-working-example"></a>実際の例

これらの手法を実際に確認するには、[このホワイトペーパーのコードに関連するサンプル](https://docs.microsoft.com/aspnet/mobile/overview)をダウンロードしてください。 このサンプルには、前に説明した方法を使用してモバイルデバイスをサポートするための ASP.NET MVC 3 (リリース候補) アプリケーションが含まれています。

## <a name="further-guidance-and-suggestions"></a>その他のガイダンスと提案

次の説明は、このドキュメントで説明されている手法を使用する Web フォームと MVC 開発者の両方に適用されます。

### <a name="enhancing-your-redirection-logic-using-51degreesmobi-foundation"></a>51Degrees.mobi Foundation を使用してリダイレクトロジックを拡張する

このドキュメントに示されているリダイレクトロジックは、アプリケーションに対して十分であると考えられますが、セッションを無効にする必要がある場合、または cookie を拒否するモバイルブラウザー (セッションがない場合) では、指定された要求があるかどうかがわからないため、機能しません。そのビジターの最初のものです。

ここでは、オープンソースの 51Degrees.mobi Foundation が ASP の精度を向上させる方法について学習しました。NET のブラウザーの検出。 また、web.config に構成されている特定の場所にモバイルユーザーをリダイレクトする機能も備えています。訪問者の HTTP ヘッダーと IP アドレスのハッシュの一時的なログを保存することで、ASP.NET セッション (および cookie) に依存することなく作業できます。そのため、各要求が特定の vistor の最初の要求であるかどうかを認識します。

Web.config ファイルの fiftyOne セクションに追加された次の要素によって、検出されたモバイルデバイスからページに最初の要求がリダイレクトされます ~/Mobile/Default.aspx. モバイルフォルダーの下にあるページへの要求は、デバイスの種類に関係なくリダイレクトされ*ません*。 モバイルデバイスが20分以上非アクティブになっている場合、デバイスは忘れられ、その後の要求はリダイレクトのために新しい要求として扱われます。

[!code-xml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample15.xml)]

詳細については、 [51Degrees.mobi Foundation のドキュメント](https://github.com/51Degrees/dotNET-Device-Detection)を参照してください。

> [!NOTE]
> ASP.NET MVC アプリケーションでは、51Degrees.mobi Foundation のリダイレクト機能を使用*できます*が、ルーティングパラメーターやアクションに MVC フィルターを配置することではなく、プレーンな url の観点からリダイレクト構成を定義する必要があります。 これは、(書き込み時に) 51Degrees.mobi Foundation がフィルターやルーティングを認識しないためです。

### <a name="disabling-transcoders-and-proxy-servers"></a>Tricaster とプロキシサーバーの無効化

モバイルネットワークオペレーターは、モバイルインターネットへのアプローチに2つの広範な目標を持ちます。

1. 可能な限り関連性のあるコンテンツを提供する
2. 限られた無線ネットワーク帯域幅を共有できる顧客の数を最大にする

ほとんどの web ページは大規模なデスクトップサイズの画面と高速の固定ラインブロードバンド接続向けに設計されているため、多くのオペレーターは、web コンテンツを動的に変更する*tricaster*または*プロキシサーバー*を使用しています。 これにより、HTML マークアップまたは CSS が小さな画面に合わせて変更される可能性があります (特に、複雑なレイアウトを処理する処理能力がない "機能フォン" の場合)。また、ページ配信速度を向上させるために、イメージを再圧縮する (品質を大幅に下げる) ことがあります。

ただし、モバイルで最適化されたバージョンのサイトを作成するための作業を行ったことがある場合は、ネットワークオペレーターがそれ以上のことを妨げないようにすることをお勧めします。 次の行をページに追加するには、任意の ASP.NET Web フォームに\_Load イベントを追加します。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample16.cs)]

または、ASP.NET MVC コントローラーの場合、次のメソッドオーバーライドを追加して、そのコントローラーのすべてのアクションに適用されるようにすることもできます。

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample17.cs)]

生成された HTTP メッセージは、W3C 準拠の tricaster とプロキシがコンテンツを変更することを通知しません。 もちろん、モバイルネットワークオペレーターがこのメッセージを尊重する保証はありません。

### <a name="styling-mobile-pages-for-mobile-browsers"></a>モバイルブラウザーのモバイルページのスタイル設定

このドキュメントでは、適切に動作する HTML マークアップの種類、または特定のデバイスでの操作性を最大化する web デザイン手法について詳しく説明しています。 信頼性の低い HTML や CSS の配置を使用せずに、モバイルサイズの画面用に最適化された、十分にシンプルなレイアウトを見つけることができます。 ただし、注目すべき重要な手法の1つは、*ビューポートのメタタグ*です。

一部の最新のモバイルブラウザーでは、デスクトップモニター用の web ページを表示します。また、"ビューポート" とも呼ばれる仮想キャンバスでページをレンダリングします (たとえば、仮想ビューは iPhone では980ピクセル、既定では850ピクセル幅、Opera Mobile では、既定ではピクセル)。画面の物理的なピクセルに合わせて結果を縮小します。 ユーザーは、そのビューポートを拡大してパンできます。 これには、ブラウザーが目的のレイアウトでページを表示できるという利点がありますが、ユーザーにとって不便なズームとパンが強制されるという欠点もあります。 モバイル向けに設計している場合は、ズームや水平スクロールが不要になるように、狭い画面をデザインすることをお勧めします。

モバイルブラウザーにビューポートの幅を指定する方法は、非標準の*ビューポート*のメタタグを使用することです。 たとえば、ページの HEAD セクションに次のコードを追加するとします。

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample18.html)]

... スマートフォンブラウザーをサポートすると、480ピクセル幅の仮想キャンバス上にページがレイアウトされます。 これは、HTML 要素の幅がパーセンテージで定義されている場合、既定のビューポートの幅ではなく、この480ピクセルの幅に対してパーセンテージが解釈されることを意味します。 その結果、ユーザーは水平方向にズームしてパンする必要が少なくなり、モバイルブラウズエクスペリエンスが大幅に向上します。

ビューポートの幅がデバイスの物理ピクセルと一致するようにするには、次のように指定します。

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample19.html)]

これが正しく機能するためには、要素の幅を明示的に超えないように明示する必要があります ( *width*属性または CSS プロパティを使用するなど)。そうしないと、ブラウザーはに関係なく、より大きなビューポートを使用するように強制されます。 関連項目:[非標準のビューポートの詳細については、](https://developer.apple.com/library/safari/#documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html)「」を参照してください。

最新のスマートフォンは、*両面の向き*をサポートしています。これは、縦モードまたは横モードで保持できます。 そのため、画面の幅をピクセル単位で推測しないことが重要です。 画面の幅が固定されていることを想定しないでください。ユーザーが自分のデバイスをページ上に再表示できるためです。

古い Windows Mobile および Blackberry デバイスでは、ページヘッダーに次のメタタグを使用して、コンテンツがモバイル用に最適化されているため、変換できないことを通知することもできます。

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample20.html)]

## <a name="additional-resources"></a>その他のリソース

Mobile ASP.NET web アプリケーションをテストするために使用できるモバイルデバイスエミュレーターとシミュレーターの一覧については、「[テスト用の一般的なモバイルデバイスのシミュレート](../mobile/device-simulators.md)」ページを参照してください。

## <a name="credits"></a>謝辞

- プライマリ作成者: 秋山 Sanderson
- レビュー担当者/追加のコンテンツライター: James Rosewell、Mikael Söderström、Scott マン Selman、Scott Hunter
