---
uid: web-forms/overview/moving-to-aspnet-20/data-source-controls
title: データ ソース コントロール |マイクロソフトドキュメント
author: rick-anderson
description: 1.x の DataGrid コントロールは ASP.NET、Web アプリケーションのデータ アクセスの大幅な向上を示しています。 しかし、それはユーザーフレンドリーではありませんでした.
ms.author: riande
ms.date: 02/20/2005
ms.assetid: 78fd0e92-f9c6-4e96-a5e9-0375b307a828
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/data-source-controls
msc.type: authoredcontent
ms.openlocfilehash: 2b4302b509af57dc5d9db9de9ee824df767d0737
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540221"
---
# <a name="data-source-controls"></a>データ ソース コントロール

[マイクロソフト](https://github.com/microsoft)

> 1.x の DataGrid コントロールは ASP.NET、Web アプリケーションのデータ アクセスの大幅な向上を示しています。 しかし、それはユーザーフレンドリーではありませんでした。 それでも、多くの有用な機能を取得するには、かなりの量のコードが必要でした。 これは、1.xのすべてのデータアクセスの試みにおけるモデルです。

1.x の DataGrid コントロールは ASP.NET、Web アプリケーションのデータ アクセスの大幅な向上を示しています。 しかし、それはユーザーフレンドリーではありませんでした。 それでも、多くの有用な機能を取得するには、かなりの量のコードが必要でした。 これは、1.xのすべてのデータアクセスの試みにおけるモデルです。

ASP.NET 2.0 では、データ ソース コントロールを使用してこれに対処しています。 ASP.NET 2.0 のデータ ソース コントロールは、データの取得、データの表示、およびデータの編集を行うための宣言型モデルを開発者に提供します。 データ ソース コントロールの目的は、データのソースに関係なく、データ バインド コントロールに一貫性のあるデータ表現を提供することです。 ASP.NET 2.0 のデータ ソース コントロールの中心にあるのは、DataSourceControl 抽象クラスです。 クラスは、IDataSource インターフェイスと IListSource インターフェイスの基本実装を提供し、後者ではデータ ソース コントロールをデータ バインド コントロールのデータ ソースとして割り当て (後で説明する新しい DataSourceId プロパティを使用)、その中にデータをリストとして公開できます。 データ ソース コントロールのデータの各リストは、DataSourceView オブジェクトとして公開されます。 インスタンスへのアクセスは、IDataSource インターフェイスによって提供されます。 たとえば、特定のデータ ソース コントロールに関連付けられているデータ ソース ビューを列挙することを可能にする ICollection メソッドを返すメソッドを使用して、特定の DataSourceView インスタンスに名前でアクセスできます。

データ ソース コントロールにはユーザー インターフェイスがありません。 これらは、宣言構文をサポートできるようにサーバー コントロールとして実装され、必要に応じてページ状態にアクセスできるようにします。 データ ソース コントロールは、クライアントに HTML マークアップを表示しません。

> [!NOTE]
> 後で説明したように、データ ソース コントロールを使用して得られるキャッシュの利点もあります。

## <a name="storing-connection-strings"></a>接続文字列の格納

データ ソース コントロールの構成方法を確認する前に、接続文字列に関する ASP.NET 2.0 の新機能について説明します。 ASP.NET 2.0 では、実行時に動的に読み取ることができる接続文字列を簡単に格納できる構成ファイルの新しいセクションが導入されています。 接続文字列&lt;&gt;セクションを使用すると、接続文字列を簡単に格納できます。

次のスニペットは、新しい接続文字列を追加します。

[!code-xml[Main](data-source-controls/samples/sample1.xml)]

> [!NOTE]
> &lt;appSettings&gt;セクションと同様に、構成&lt;&gt;ファイルの system.web&gt; &lt;セクションの外側に接続文字列セクションが表示されます。

この接続文字列を使用するには、サーバー コントロールの接続文字列属性を設定するときに、次の構文を使用できます。

[!code-aspx[Main](data-source-controls/samples/sample2.aspx)]

&lt;また、接続文字列&gt;セクションを暗号化して、機密情報が公開しないようにすることもできます。 その能力については、後のモジュールで説明します。

## <a name="caching-data-sources"></a>データ ソースのキャッシュ

各データ ソース コントロールには、キャッシュを構成するための 4 つのプロパティが用意されています。キャッシュ、キャッシュ期間、キャッシュ有効期限ポリシー、およびキャッシュキー依存関係を有効にします。

## <a name="enablecaching"></a>キャッシュを有効にする

EnableCaching は、データ ソース コントロールのキャッシュが有効かどうかを決定するブール型プロパティです。

## <a name="cacheduration-property"></a>プロパティ

CacheDuration プロパティは、キャッシュが有効な状態を維持する秒数を設定します。 このプロパティを**0**に設定すると、明示的に無効になるまでキャッシュは有効なままになります。

## <a name="cacheexpirationpolicy-property"></a>プロパティ

プロパティは、**絶対**または**スライド**のいずれかに設定できます。 絶対値に設定すると、データがキャッシュされる最大時間は、CacheDuration プロパティで指定された秒数になります。 スライディングに設定すると、各操作が実行されると有効期限がリセットされます。

## <a name="cachekeydependency-property"></a>プロパティ

CacheKeyDependency プロパティに文字列値が指定されている場合、ASP.NETは、その文字列に基づいて新しいキャッシュ依存関係を設定します。 これにより、CacheKeyDependency を変更または削除するだけで、キャッシュを明示的に無効にすることができます。

**重要**: 偽装が有効で、データ ソースやデータのコンテンツへのアクセスがクライアント ID に基づいている場合は、EnableCaching を False に設定してキャッシュを無効にすることをお勧めします。 このシナリオでキャッシュが有効になっており、データを最初に要求したユーザー以外のユーザーが要求を発行した場合、データ ソースへの承認は強制されません。 データはキャッシュから提供されるだけです。

## <a name="the-sqldatasource-control"></a>コントロール

SqlDataSource コントロールを使用すると、開発者は、ADO.NETをサポートするリレーショナル データベースに格納されているデータにアクセスできます。 プロバイダーを使用して、SQL Server データベース、システム.データ.OleDb プロバイダー、システム.データ.Odbc プロバイダー、またはシステム.Data.OracleClient プロバイダーにアクセスして Oracle にアクセスできます。 したがって、SqlDataSource は確かに SQL Server データベース内のデータにアクセスするためだけに使用されるわけではありません。

SqlDataSource を使用するには、接続文字列プロパティの値を指定し、SQL コマンドまたはストアド プロシージャを指定するだけです。 コントロールは、基になるADO.NETアーキテクチャを処理します。 接続を開き、データ ソースを照会するか、ストアド プロシージャを実行し、データを返して、接続を閉じます。

> [!NOTE]
> クラスは自動的に接続を閉じるため、データベース接続のリークによって発生する顧客呼び出しの数を減らす必要があります。

次のコード スニペットは、上に示すように構成ファイルに格納されている接続文字列を使用して、SqlDataSource コントロールに DropDownList コントロールをバインドします。

[!code-aspx[Main](data-source-controls/samples/sample3.aspx)]

上に示したように、SqlDataSource のプロパティは、データ ソースのモードを指定します。 上の例では、データ ソース モードがデータ リーダーに設定されています。 その場合、SqlDataSource は前方専用の読み取り専用カーソルを使用して IDataReader オブジェクトを返します。 返されるオブジェクトの指定された型は、使用されるプロバイダーによって制御されます。 この場合、私は web.config ファイルの&lt;接続文字列&gt;セクションで指定されているように、System.Data.SqlClient プロバイダーを使用しています。 したがって、返されるオブジェクトは、型 SqlDataReader になります。 DataSourceMode 値を指定することで、データをサーバーの DataSet に格納できます。 このモードでは、並べ替え、ページングなどの機能を追加できます。私はグリッドビューコントロールにSqlDataSourceデータバインディングしていた場合、私はデータセットモードを選択していたでしょう。 ただし、ドロップダウン リストの場合は、データ リーダー モードが正しい選択です。

> [!NOTE]
> をキャッシュする場合、またはアクセスデータ ソース、データ ソース モードプロパティを設定する必要があります。 データ リーダーのデータ ソース モードでキャッシュを有効にすると、例外が発生します。

## <a name="sqldatasource-properties"></a>プロパティ

コントロールのプロパティの一部を次に示します。

### <a name="cancelselectonnullparameter"></a>パラメーターを選択します。

パラメーターの 1 つが null の場合に選択コマンドを取り消すかどうかを指定するブール値。 既定では true です。

### <a name="conflictdetection"></a>競合検出

複数のユーザーが同時にデータ ソースを更新する可能性がある場合は、競合検出プロパティは、SqlDataSource コントロールの動作を決定します。 このプロパティは、競合オプション列挙体の値の 1 つに評価されます。 これらの値は、**すべての値と****上書き変更です**。 OverwriteChanges に設定すると、データ ソースにデータを最後に書き込むユーザーが、以前の変更を上書きします。 ただし、競合検出プロパティが [すべての値を比較] に設定されている場合、パラメーターは SelectCommand によって返される列に対して作成され、パラメーターも作成され、各列の元の値を保持して、SqlDataSource が SelectCommand の実行後に値が変更されたかどうかを判断できるようにします。

### <a name="deletecommand"></a>コマンドの削除

データベースから行を削除するときに使用する SQL 文字列を設定または取得します。 SQL クエリまたはストアド プロシージャ名を指定できます。

### <a name="deletecommandtype"></a>コマンドの種類を削除します。

SQL クエリ (テキスト) またはストアド プロシージャ (ストアドプロシージャ) のいずれかの削除コマンドの種類を設定または取得します。

### <a name="deleteparameters"></a>パラメーターの削除

コントロールに関連付けられているオブジェクトの削除コマンドによって使用されるパラメーターを返します。

### <a name="oldvaluesparameterformatstring"></a>文字列を指定します。

このプロパティは、競合検出プロパティが比較AllValuesに設定されている場合に元の値パラメーターの形式を指定するために使用されます。 デフォルトでは、{0}元の値パラメーターは元のパラメーターと同じ名前を取ります。 つまり、フィールド名が EmployeeID の場合、元の値パラメーターは@EmployeeIDです。

### <a name="selectcommand"></a>SelectCommand

データベースからデータを取得するために使用される SQL 文字列を設定または取得します。 SQL クエリまたはストアド プロシージャ名を指定できます。

### <a name="selectcommandtype"></a>コマンドタイプの選択

SQL クエリ (テキスト) またはストアド プロシージャ (ストアドプロシージャ) のいずれかの選択コマンドの種類を設定または取得します。

### <a name="selectparameters"></a>パラメータの選択

コントロールに関連付けられているオブジェクトの選択コマンドによって使用されるパラメーターを返します。

### <a name="sortparametername"></a>パラメーター名の並べ替え

データ ソース コントロールによって取得されたデータを並べ替えるときに使用されるストアド プロシージャ パラメーターの名前を取得または設定します。 [プロシージャ] に設定されている場合にのみ有効です。

### <a name="sqlcachedependency"></a>キャッシュ依存関係

SQL Server キャッシュの依存関係で使用されるデータベースとテーブルを指定するセミコロン区切りの文字列。 (SQL キャッシュの依存関係については、後のモジュールで説明します)。

### <a name="updatecommand"></a>コマンドを更新します。

データベース内のデータを更新するときに使用される SQL 文字列を設定または取得します。 SQL クエリまたはストアド プロシージャ名を指定できます。

### <a name="updatecommandtype"></a>コマンドの種類を更新します。

SQL クエリ (テキスト) またはストアド プロシージャ (ストアド プロシージャ) のいずれかの更新コマンドの種類を設定または取得します。

### <a name="updateparameters"></a>パラメーターの更新

コントロールに関連付けられているオブジェクトの更新コマンドによって使用されるパラメーターを返します。

## <a name="the-accessdatasource-control"></a>コントロールのアクセスデータ ソース

コントロールは、クラスから派生し、Access データベースへのデータ バインドに使用されます。 コントロールの接続文字列プロパティは、読み取り専用プロパティです。 プロパティを使用する代わりに、DataFile プロパティは、次に示すように、アクセス データベースを指すために使用されます。

[!code-aspx[Main](data-source-controls/samples/sample4.aspx)]

AccessDataSource は常に基本 SqlDataSource のプロバイダー名を System.Data.OleDb に設定し、Ole DB プロバイダーを使用してデータベースに接続します。 AccessDataSource コントロールを使用して、パスワードで保護された Access データベースに接続することはできません。 パスワードで保護されたデータベースに接続する必要がある場合は、SqlDataSource コントロールを使用する必要があります。

> [!NOTE]
> Web サイト内に格納されている Access データベースは、\_アプリ データ ディレクトリに配置する必要があります。 ASP.NETでは、このディレクトリ内のファイルを参照できません。 Access データベースを使用する場合は、プロセス アカウントに、アプリケーション\_データ ディレクトリに対する読み取りおよび書き込みのアクセス許可を付与する必要があります。

## <a name="the-xmldatasource-control"></a>コントロール

XmlDataSource は、XML データをデータ バインド コントロールにデータ バインドするために使用されます。 プロパティを使用して XML ファイルにバインドするか、Data プロパティを使用して XML 文字列にバインドできます。 XML 属性をバインド可能なフィールドとして公開します。 属性として表されない値にバインドする必要がある場合は、XSL 変換を使用する必要があります。 XPath 式を使用して XML データをフィルターすることもできます。

次の XML ファイルを検討してください。

[!code-xml[Main](data-source-controls/samples/sample5.xml)]

XmlDataSource は、ユーザー&gt; /人物ノードのみをフィルター処理するために *、ユーザー/人物*の XPath&lt;プロパティを使用することに注意してください。 その後、DropDownList は、DataTextField プロパティを使用して LastName 属性にデータバインドします。

XmlDataSource コントロールは、主に読み取り専用の XML データにデータバインドするために使用されますが、XML データ ファイルを編集できます。 このような場合、XML ファイル内の情報の自動挿入、更新、および削除は、他のデータ ソース コントロールと同様に自動的には行われません。 代わりに、XmlDataSource コントロールの次のメソッドを使用して、データを手動で編集するコードを記述する必要があります。

### <a name="getxmldocument"></a>ドキュメント

によって取得された XML コードを含む XmlDocument オブジェクトを取得します。

### <a name="save"></a>保存

メモリ内の XmlDocument をデータ ソースに保存します。

Save メソッドは、次の 2 つの条件が満たされた場合にのみ機能することを認識することが重要です。

1. XmlDataSource は、メモリ内の XML データにバインドする Data プロパティの代わりに、Xml ファイルにバインドする DataFile プロパティを使用しています。
2. 変換は、変換または変換ファイルプロパティを使用して指定されていません。

また、複数のユーザーが同時に呼び出すと、Save メソッドが予期しない結果を引き起こす可能性があることにも注意してください。

## <a name="the-objectdatasource-control"></a>コントロール

ここまで説明してきたデータ ソース コントロールは、データ ソース コントロールがデータ ストアに直接通信する 2 層アプリケーションに最適な選択肢です。 ただし、多くの実世界アプリケーションは、データ ソース コントロールがビジネス オブジェクトと通信する必要がある多層アプリケーションであり、データ層と通信します。 このような状況では、ObjectDataSource は、うまく法案を埋めます。 オブジェクトデータ ソースは、ソース オブジェクトと連携して動作します。 ObjectDataSource コントロールは、ソース オブジェクトのインスタンスを作成し、指定されたメソッドを呼び出し、オブジェクトに静的メソッドではなくインスタンス メソッドがある場合は、1 つの要求のスコープ内でオブジェクト インスタンスをすべて破棄します (Visual Basic では Shared)。 したがって、オブジェクトはステートレスでなければなりません。 つまり、オブジェクトは、1 つの要求の範囲内で必要なすべてのリソースを取得して解放する必要があります。 オブジェクトの作成イベントを処理して、ソース オブジェクトを作成する方法を制御できます、 ObjectDataSourceコントロールです。 ソース オブジェクトのインスタンスを作成し、そのインスタンスにクラスの ObjectInstance プロパティを設定できます。 コントロールは、独自にインスタンスを作成する代わりに、ObjectCreating イベントで作成されたインスタンスを使用します。

ObjectDataSource コントロールのソース オブジェクトが、データの取得と変更を行うために呼び出すことができるパブリック静的メソッド (Visual Basic で共有) を公開している場合、ObjectDataSource コントロールはそれらのメソッドを直接呼び出します。 ObjectDataSource コントロールがメソッド呼び出しを行うためにソース オブジェクトのインスタンスを作成する必要がある場合、オブジェクトにはパラメーターを受け取らないパブリック コンストラクターが含まれている必要があります。 ObjectDataSource コントロールは、ソース オブジェクトの新しいインスタンスを作成するときに、このコンストラクターを呼び出します。

ソース オブジェクトにパラメーターのないパブリック コンストラクターが含まれていない場合は、ObjectDataSource イベントで ObjectDataSource コントロールで使用されるソース オブジェクトのインスタンスを作成できます。

## <a name="specifying-object-methods"></a>オブジェクト メソッドの指定

ObjectDataSource コントロールのソース オブジェクトには、データの選択、挿入、更新、または削除に使用されるメソッドをいくつでも含めることができます。 これらのメソッドは、オブジェクトデータ ソース コントロールのプロパティを使用して識別されるように、メソッドの名前に基づいて ObjectDataSource コントロールによって呼び出されます。 ソース オブジェクトには、データ ソースのオブジェクトの合計数のカウントを返すプロパティを使用して ObjectDataSource コントロールによって識別されるオプションの SelectCount メソッドを含めることもできます。 コントロールは、Select メソッドが呼び出された後に SelectCount メソッドを呼び出して、ページング時に使用するデータ ソースのレコードの総数を取得します。

## <a name="lab-using-data-source-controls"></a>データ ソース コントロールの使用ラボ

## <a name="exercise-1---displaying-data-with-the-sqldatasource-control"></a>演習 1 - SqlDataSource コントロールを使用したデータの表示

次の練習では、コントロールを使用してノースウィンド データベースに接続します。 SQL Server 2000 インスタンスのノースウィンド データベースにアクセスできる場合を想定しています。

1. 新しい ASP.NET Web サイトの作成
2. 新しい web.config ファイルを追加します。

    1. ソリューション エクスプローラーでプロジェクトを右クリックし、[新しい項目の追加] をクリックします。
    2. テンプレートのリストから [Web 構成ファイル] を選択し、[追加] をクリックします。
3. 次のように&lt;接続文字列&gt;セクションを編集します。 

    [!code-aspx[Main](data-source-controls/samples/sample6.aspx)]
4. コード ビューに切り替えて、次のように、接続文字列属性と SelectCommand 属性を&lt;&gt; asp:SqlDataSource コントロールに追加します。 

    [!code-aspx[Main](data-source-controls/samples/sample7.aspx)]
5. デザイン ビューから、新しい GridView コントロールを追加します。
6. グリッドビュー タスク メニューの [データ ソースの選択] ドロップダウンから、[SqlDataSource1] を選択します。
7. Default.aspx を右クリックし、メニューから [ブラウザーで表示] を選択します。 保存するかどうかを確認するメッセージが表示されたら、[はい] をクリックします。
8. GridView には、製品テーブルからのデータが表示されます。

## <a name="exercise-2---editing-data-with-the-sqldatasource-control"></a>演習 2 - SqlDataSource コントロールを使用したデータの編集

次の演習では、宣言構文を使用して DropDownList コントロールをデータ バインドする方法を示し、DropDownList コントロールに表示されるデータを編集できるようにします。

1. デザイン ビューで、既定の .aspx から GridView コントロールを削除します。 

    **重要**: ページ上にコントロールを残します。
2. コントロールを既定の .aspx に追加します。
3. ソース ビューに切り替えます。
4. 次のように、asp:DropDownList&lt;&gt;コントロールにデータソース ID、データテキスト フィールド、およびデータ値フィールド属性を追加します。 

    [!code-aspx[Main](data-source-controls/samples/sample8.aspx)]
5. Default.aspx を保存し、ブラウザーで表示します。 ドロップダウン リストには、ノースウィンド データベースからのすべての製品が含まれていることに注意してください。
6. ブラウザーを閉じます。
7. Default.aspx のソース ビューで、ドロップダウン リスト コントロールの下に新しいテキスト ボックス コントロールを追加します。 テキスト ボックスの ID プロパティを txtProductName に変更します。
8. TextBox コントロールの下に、新しいボタン コントロールを追加します。 ボタンの ID プロパティを btnUpdate に変更し、Text プロパティを **[製品名の更新]** に変更します。
9. Default.aspx のソース ビューで、次のように、プロパティと 2 つの新しい更新パラメーターを SqlDataSource タグに追加します。 

    [!code-aspx[Main](data-source-controls/samples/sample9.aspx)]

    > [!NOTE]
    > このコードには、2 つの更新パラメータ (製品名と商品コード) が追加されています。 これらのパラメーターは、テキスト プロパティにマップされます、 テキストのテキストのテキストのテキストボックスと、ddlProducts ドロップダウン リストの選択値プロパティです。
10. デザイン ビューに切り替え、Button コントロールをダブルクリックしてイベント ハンドラーを追加します。
11. 次のコードを btnUpdate\_クリック コードに追加します。 

    [!code-csharp[Main](data-source-controls/samples/sample10.cs)]
12. Default.aspx を右クリックし、ブラウザーで表示することを選択します。 すべての変更を保存するかどうかを確認するメッセージが表示されたら、[はい] をクリックします。
13. ASP.NET 2.0 部分クラスでは、実行時にコンパイルが可能です。 コードの変更を有効にするために、アプリケーションをビルドする必要はありません。
14. ドロップダウン リストから製品を選択します。
15. 選択した製品の新しい名前をテキスト ボックスに入力し、[更新] ボタンをクリックします。
16. 製品名がデータベース内で更新されます。

## <a name="exercise-3-using-the-objectdatasource-control"></a>練習 3 オブジェクトデータ ソース コントロールの使用

この演習では、ObjectDataSource コントロールとソース オブジェクトを使用して Northwind データベースと対話する方法を示します。

1. ソリューション エクスプローラーでプロジェクトを右クリックし、[新しい項目の追加] をクリックします。
2. テンプレートの一覧で [Web フォーム] を選択します。 名前を object.aspx に変更し、[追加] をクリックします。
3. ソリューション エクスプローラーでプロジェクトを右クリックし、[新しい項目の追加] をクリックします。
4. テンプレートの一覧で [クラス] を選択します。 クラスの名前をNorthwindData.csに変更し、[追加] をクリックします。
5. クラスを [アプリ\_コード] フォルダーに追加するかどうかを確認するメッセージが表示されたら、[はい] をクリックします。
6. NorthwindData.cs ファイルに次のコードを追加します。 

    [!code-csharp[Main](data-source-controls/samples/sample11.cs)]
7. object.aspx のソース ビューに次のコードを追加します。 

    [!code-aspx[Main](data-source-controls/samples/sample12.aspx)]
8. すべてのファイルを保存し、object.aspx を参照します。
9. 詳細の表示、従業員の編集、従業員の追加、および従業員の削除を行って、インターフェイスを操作します。
