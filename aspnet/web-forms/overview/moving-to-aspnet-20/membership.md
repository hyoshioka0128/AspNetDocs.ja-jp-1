---
uid: web-forms/overview/moving-to-aspnet-20/membership
title: 会員登録 |マイクロソフトドキュメント
author: rick-anderson
description: ASP.NET メンバーシップは、フォーム認証モデルが成功した場合、ASP.NET 1.x から成ります。 フォーム認証ASP.NET、incorp..
ms.author: riande
ms.date: 02/20/2005
ms.assetid: f2339485-5d78-4c5e-8c0a-dc9b8a315345
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/membership
msc.type: authoredcontent
ms.openlocfilehash: ed48c11cbd483de088239bad7c2452b7fc60a1cf
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2020
ms.locfileid: "81543770"
---
# <a name="membership"></a>Membership

[マイクロソフト](https://github.com/microsoft)

> ASP.NET メンバーシップは、フォーム認証モデルが成功した場合、ASP.NET 1.x から成ります。 ASP.NET フォーム認証を使用すると、ログイン フォームをASP.NET アプリケーションに組み込み、データベースやその他のデータ ストアに対してユーザーを検証できます。

ASP.NET メンバーシップは、フォーム認証モデルが成功した場合、ASP.NET 1.x から成ります。 ASP.NET フォーム認証を使用すると、ログイン フォームをASP.NET アプリケーションに組み込み、データベースやその他のデータ ストアに対してユーザーを検証できます。 FormsAuthentication クラスのメンバーは、認証のためのクッキーの処理、有効なログインの確認、ユーザーのログアウトなどを可能にします。ただし、ASP.NET 1.x アプリケーションでフォーム認証を実装するには、かなりの量のコードが必要になる場合があります。

ASP.NET 2.0 のメンバーシップは、フォーム認証を単独で使用する上で大きく進歩しています。 (メンバーシップは、フォーム認証と組み合わせると最も堅牢ですが、フォーム認証を使用することは必須ではありません)。すぐにわかるように、ASP.NETメンバーシップとログインコントロールASP.NET2.0で使用して、コードをまったく書かずに強力なメンバーシップシステムを実装することができます。

## <a name="implementing-membership-in-aspnet-20"></a>ASP.NET 2.0 でメンバーシップを実装する

メンバーシップは、次の 4 つの手順で実装されます。 多くのサブステップが含まれるだけでなく、実装可能なオプションの構成も含まれます。 これらの手順は、メンバーシップの構成の全体像を示すために使用されます。

1. メンバーシップ データベースを作成します (SQL Server がメンバーシップ ストアとして使用されている場合)。
2. アプリケーション構成ファイルでメンバーシップ オプションを指定します。 (メンバーシップは既定で有効になっています)。
3. 使用するメンバーシップ ストアの種類を決定します。 オプション: 

    - SQL サーバー (バージョン 7.0 以降)
    - アクティブ ディレクトリ ストア
    - カスタム メンバーシップ プロバイダー
4. フォーム認証をASP.NETするアプリケーションを構成します。 もう一度、メンバーシップはフォーム認証を利用するように設計されていますが、フォーム認証を使用する必要はありません。
5. 必要に応じて、メンバーシップのユーザー アカウントを定義し、ロールを構成します。

## <a name="creating-the-membership-database"></a>メンバーシップ データベースの作成

SQL Server 7.0 以降をメンバーシップ ストアとして使用している場合は、aspnet\_regsql ユーティリティ (Visual Studio .NET 2005 コマンド プロンプトから最も簡単に使用できます) を使用してデータベースを構成できます。 aspnet\_regsql ユーティリティは、コマンド プロンプト ツールとして、または GUI ウィザードを使用して使用できます。 ウィザードの方法は、データベースを構成する最も簡単な方法です。 ウィザードにアクセスするには、次のコマンドを実行します。

`aspnet_regsql W`

このコマンドを実行すると、次に示すように、ASP.NET SQL Server セットアップ ウィザードが表示されます。

![](membership/_static/image1.jpg)

**図 1**

SQL Server セットアップ ウィザードASP.NET、ウィザードで指定したインスタンスに Web サイトが作成されます。 ただし、ASP.NETは、machine.config ファイル内の接続文字列を使用してデータベースに接続します。 既定では、この接続文字列は SQL Server 2005 インスタンスを指すため、SQL Server 2000 または SQL Server 7.0 のインスタンスを使用している場合は、machine.config ファイル内の接続文字列を変更する必要があります。 接続文字列は次の場所に配置できます。

[!code-xml[Main](membership/samples/sample1.xml)]

接続文字列を変更しない場合、ASP.NETは説明的なエラーを示しません。 データベースを作成していないと言って文句を言い続けるでしょう。 上記の場合、ローカル SQL Server 2000 インスタンスを指す接続文字列を変更しました。

## <a name="specifying-configuration-and-adding-users-and-roles"></a>構成の指定とユーザーとロールの追加

メンバーシップを構成する次の手順は、アプリケーションの web.config ファイルに必要な情報を追加することです。 ASP.NET 1.x では、小文字の CamelCase の使用とインテッリセンスの欠如により、web.config ファイルの変更が困難な場合がありました。 Visual Studio .NET 2005 では、構成ファイルの Intellisense を使用すると作業が大幅に簡略化されますが、ASP.NET 2.0 は構成ファイルを編集するための Web インターフェイスを提供することで、さらに一歩進みます。

Web インターフェイスを起動するには、次に示すように、ソリューション エクスプローラーのツール バーの [ASP.NET構成] ボタンをクリックします。 また、ログイン コントロールが挿入されたときに表示されるポップアップを介して Web インターフェイスを起動することもできます。

![](membership/_static/image2.jpg)

**図 2**

これにより、以下に示す ASP.NET Web サイト管理ツールが起動します。 ASP.NET Web サイト管理は、アプリケーション設定を簡単に管理できる 4 つのタブを備えたインターフェイスです。 次のタブを使用できます。

- **ホーム**
- **セキュリティ**ユーザー、ロール、およびアクセスを構成します。
- **アプリケーション**アプリケーション設定を構成します。
- **プロバイダ**アプリケーションメンバーシップ プロバイダを構成してテストします。

Web サイト管理ツールを使用すると、新しいユーザーの作成、新しいロールの作成、およびユーザーとロールの管理を簡単に行うことができます。 この機能は、Windows インターフェイスでは使用できません。 Windows インターフェイスを使用すると、Web サイト管理ツールにはない、認証設定の定義、およびプロバイダの追加、削除、および管理を簡単に行うことができます。

Windows インターフェイスを起動するには、インターネット インフォメーション サービス スナップインを開き、アプリケーションを右クリックして、[プロパティ] を選択します。 [ASP.NET] タブをクリックし、[構成の編集] ボタンをクリックします。 ([構成の編集] ボタンを有効にするには、アプリケーションが ASP.NET 2.0 で実行されている必要があります。 ASP.NETダイアログでもASP.NETバージョンを設定できます。[ASP.NET構成設定] ダイアログボックスが次のように表示されます。

![](membership/_static/image3.jpg)

**図 3**

[全般] タブに、接続文字列とアプリケーション設定が一覧表示されます。 斜体の設定は親構成ファイル (machine.config または上位レベルの web.config) で定義され、斜体に含まれていない設定はアプリケーション構成ファイルから定義されます。 設定がアプリケーション レベルで追加、削除、または編集されると、ASP.NETは、設定を継承元の構成ファイルから削除するのではなく、アプリケーション レベルの web.config で設定を追加、削除、または変更します。

[認証] タブは以下に示します。 ここでメンバーシップ設定を構成します。 フォーム認証設定、メンバーシップ プロバイダー、ロール プロバイダーは、ここで構成できます。

![](membership/_static/image4.jpg)

**図 4**

## <a name="implementing-membership-in-your-application"></a>アプリケーションへのメンバーシップの実装

アプリケーションに ASP.NET 2.0 メンバーシップを実装する最も簡単な方法は、提供されている Logon コントロールを使用することです。 このメソッドを使用すると、コードをまったく記述せずに、2.0 メンバーシップASP.NET基本を実装できます。

ASP.NET 2.0 では、次のログオン コントロールを使用できます。

## <a name="login-control"></a>ログインコントロール

Login コントロールは、ユーザーがメンバーシップ システムにログインするためのインターフェイスを提供します。 ユーザー名とパスワードのテキストボックスとログインボタンを提供します。 まだ登録していない人に登録するためのリンク、その後の訪問で自動的にログインできるチェックボックス、パスワードリマインダー用のリンクなど、他の多くの一般的な機能。Login コントロールのすべての機能は、コントロールのプロパティを使用してカスタマイズできます。

ASP.NET 1.x では、開発者はフォーム認証を使用するときに検索を行うためにかなりの量のコードを記述する必要がありました。 ASP.NET 2.0 メンバーシップを使用すると、コードをまったく記述せずにユーザーを検証できます。 ASP.NETは自動的にユーザーの検索を行います。 (ASP.NETメンバーシップを使用せずに Login コントロールを使用している場合は **、OnAuthenticate**メソッドを使用してユーザーを検証できます)。

## <a name="loginview-control"></a>LoginView コントロール

LoginView コントロールは、既定で 2 つのテンプレートを提供するテンプレート コントロールです。をクリックします。 表示されるテンプレートは、ユーザーがメンバーシップ システムにログインしているかどうかによって決まります。 このコントロールは通常、ユーザーがまだログインしていない場合に Login コントロールを表示するために使用され、ユーザーがログインしたときに LoginStatus コントロールや他のログイン コントロールを表示します。 ASP.NET アプリケーションでロール管理を使用している場合、LoginView コントロールはユーザー ロールに基づいて特定のテンプレートを表示できます。 (役割管理ASP.NET詳細については後述します。

## <a name="passwordrecovery-control"></a>パスワード回復制御

PasswordRecovery コントロールを使用すると、ユーザーは現在のパスワードを使用して電子メールを受信したり、パスワードをリセットしたりできます。 クリアテキストと暗号化されたパスワードは、ユーザーに回復して電子メールで送信できます。 パスワードがハッシュされている場合、回復できません。 代わりに、ユーザーはパスワードのリセットを実行する必要があります。

## <a name="loginstatus-control"></a>ログインステータスコントロール

LoginStatus コントロールは、ログインしていないユーザーにログイン インジケータを表示し、現在ログインしているユーザーにログアウト インジケータを表示するために使用されます。 プロパティは、表示するインジケーターを決定するために使用されます。 LoginStatus コントロールによって表示されるインジケータは、テキスト (**ログインテキスト**プロパティと**ログ出力テキスト**プロパティを介して実装) またはイメージ **(LoginImageUrl**および**LogoutImageUrl**プロパティを介して実装) することができます。

ユーザーが LoginStatus コントロールを使用してログアウトすると、そのユーザーは**LogoutPageUrl**プロパティで指定された URL にリダイレクトされます。 このプロパティが設定されていない場合、現在のページが更新されます。 サイトはフォーム認証によって保護されている可能性があるため、現在のページを更新すると、ユーザーはサイトのログイン ページにリダイレクトされます。

## <a name="loginname-control"></a>ログイン名コントロール

LoginName コントロールは、現在サイトにログインしているユーザーのユーザー名を表示します。

## <a name="createuserwizard-control"></a>ユーザー ウィザード コントロールの作成

CreateUserWizard コントロールを使用すると、ユーザーはメンバーシップ システムに登録できます。 以下に示すインターフェイスを使用して、(WizardSteps のコレクションとして実装された)ステップを追加できます。

![](membership/_static/image5.jpg)

**図 5**

CreateUserWizard は、ウィザード クラスから派生したテンプレート コントロールであり、次のテンプレートを提供します。

- **ヘッダーテンプレート**このテンプレートは、ウィザードのヘッダーの外観を制御します。
- **サイドバーテンプレート**このテンプレートは、ウィザードのサイドバーの外観をコントロールします。
- **スタートナビゲーションテンプレート**このテンプレートは、ウィザードのナビゲーションの外観をコントロールします。
- **ステップナビゲーションテンプレート**このテンプレートは、開始または終了ステップに含まれていない場合のナビゲーション領域の外観を制御します。
- **完了ナビゲーションテンプレート**このテンプレートは、完了ステップでのナビゲーション領域の外観を制御します。

さらに、ウィザードに追加する各手順に対して、ASP.NETは、そのステップのコンテンツ テンプレートとカスタム ナビゲーション テンプレートの両方を含むカスタム テンプレートを作成します。 CreateUserWizard のカスタマイズの詳細については、VS.NET 2005 のドキュメントを参照してください。

## <a name="changepassword-control"></a>パスワードの変更コントロール

ChangePassword コントロールを使用すると、ユーザーはパスワードを変更できます。 DisplayUserName プロパティが true の場合 (既定では false)、ユーザーはログインしていないときにパスワードを変更できます。 *ユーザーが*既にログインしていて、DisplayUserName プロパティが true の場合、ユーザーはログインしていない別のユーザーのパスワードを変更できます。

ユーザーがログインしなくてもパスワードを変更できるようにする場合は、ChangePassword コントロールが表示されるページで匿名アクセスが許可されていることを確認する必要があります。 明らかに、ユーザーは自分のパスワードを変更するために古いパスワードを提供する必要があります。

## <a name="role-management"></a>ロール管理

役割管理を使用すると、ユーザーを特定のロールに割り当て、そのロールに基づいて特定のファイルまたはフォルダへのアクセスを制限できます。 また、ロール管理は API を提供し、プログラムによって誰かのロールを決定したり、特定のロールのすべてのユーザーを特定して対応したりできるようにしています。

ロール管理は、ASP.NETメンバーシップの要件ではなく、ロール管理を使用するためのメンバーシップ要件でもありません。 しかし, 2 つはうまくお互いを補完し、開発者は互いに連動してそれらを使用する可能性が高い.

アプリケーションでロール管理を有効にするには、web.config ファイルで次の変更を行います。

[!code-xml[Main](membership/samples/sample2.xml)]

**属性**が true に設定されている場合、ASP.NETはクライアントの cookie にユーザー ロール メンバーシップをキャッシュします。 これにより、ロール参照を RoleProvider に呼び出さずに行うことができます。 この属性を使用する場合、開発者は**cookieProtection**属性が All に設定されていることを確認することをお勧めします。 (これは既定の設定です)。これにより、Cookie データが暗号化され、Cookie の内容が変更されていないことを確認できます。 ロールは、Web サイト管理ツールを使用して追加できます。 ロールを簡単に定義し、それらのロールに基づいてサイトの一部へのアクセスを構成し、ユーザーをロールに割り当てることができます。

![](membership/_static/image6.jpg)

**図 6**

上に示したように、ロールの名前を入力して [ロールの追加] をクリックするだけで、新しいロールを追加できます。 既存のロールのリストで適切なリンクをクリックすると、既存のロールを管理または削除できます。

ロールを管理する場合、以下に示すようにユーザーを追加または削除できます。

![](membership/_static/image7.jpg)

**図 7**

[ユーザーがロールに含まれる] チェックボックスをオンにすると、特定のロールにユーザーを簡単に追加できます。 ASP.NETは、適切なエントリでメンバーシップ データベースを自動的に更新します。 また、アプリケーションのアクセス ルールを構成する必要があります。 ASP.NET 1.x 開発者は、web.config &lt;&gt;ファイルの認証要素を使用してこれを行うことに精通しており、そのオプションは ASP.NET 2.0 で引き続き使用できます。 ただし、以下に示すように、Web サイト管理ツールを使用してアクセス ルールを管理しやすくなります。

![](membership/_static/image8.jpg)

**図 8**

この場合、管理フォルダが強調表示され (ツールが淡いグレーで強調表示されるため、そのフォルダは見えにくくなります)、管理者の役割にアクセス権が付与されています。 他のすべてのユーザーは拒否されます。 先頭のアイコンをクリックしてルールを選択し、[上へ移動] ボタンと [下へ移動] ボタンを使用してルールを配置できます。 ASP.NET&lt;承認&gt;要素と同様に、ルールは表示順に処理されます。 つまり、上記のショットのルールの順序が逆の場合、ASP.NET最初に遭遇するルールはフォルダに対して全員を拒否するルールになるので、誰も管理フォルダにアクセスできません。

ASP.NET 2.0 は、アクセス ルールを指定するフォルダーに web.config ファイルを追加します。 アクセス ルールは、構成ファイルまたは Web サイト管理ツールを使用して編集できます。 つまり、Web サイト管理ツールは、ユーザーフレンドリな環境で構成ファイルを編集できるインターフェイスです。

## <a name="using-roles-in-code"></a>コードでのロールの使用

ロール管理用の API はバージョン 1.x 以降変更されていません。 **IsInRole**メソッドは、ユーザーが特定のロールに含まれるかどうかを判断するために使用されます。

[!code-csharp[Main](membership/samples/sample3.cs)]

ASP.NET、現在のコンテキストのメンバーとして RolePrincipal インスタンスも作成します。 RolePrincipal オブジェクトを使用すると、ユーザーが属するすべてのロールを次のように取得できます。

[!code-csharp[Main](membership/samples/sample4.cs)]

## <a name="using-rolegroups-with-the-loginview-control"></a>ロール グループを LoginView コントロールで使用する

ロール管理とメンバーシップについて理解できたので、LoginView コントロールが ASP.NET 2.0 でこの機能を利用する方法について簡単に説明します。 前述したように、LoginView コントロールは、既定で 2 つのテンプレートを含むテンプレート コントロールです。をクリックします。 [LoginView タスク] ダイアログボックスには、ロールグループを編集するためのリンク (以下を参照) があります。

![](membership/_static/image9.jpg)

**図 9**

各 RoleGroup オブジェクトには、ロール グループが適用されるロールを定義する文字列の配列が含まれています。 新しい役割グループを LoginView コントロールに追加するには、[役割グループの編集] リンクをクリックします。 上の図では、管理者用の新しい役割グループが追加されていることがわかります。 [ビュー] ドロップダウンからその役割グループ (RoleGroup[0]) を選択すると、管理者ロールのメンバーにのみ表示されるテンプレートを構成できます。 下の図では、営業ロールと配布ロールのメンバーに適用される新しい RoleGroup を追加しました。 これにより、[LoginView タスク] ダイアログの [ビュー] ドロップダウンに 2 つ目の RoleGroup が追加され、そのテンプレートに追加された内容は、営業または販売のロールのいずれかのユーザーに表示されます。

![](membership/_static/image10.jpg)

**図 10**

## <a name="overriding-the-existing-membership-provider"></a>既存のメンバーシップ プロバイダーのオーバーライド

メンバーシップの機能を拡張する方法は、ASP.NETいくつかあります。 まず、クラスから継承してそのメソッドをオーバーライドすることで、SqlMembershipProvider クラスの既存の機能を変更できます。 たとえば、ユーザーの作成時に独自の機能を実装する場合は、次のように SqlMembershipProvider から継承する独自のクラスを作成できます。

[!code-csharp[Main](membership/samples/sample5.cs)]

一方、メンバーシップ情報を Access データベースに格納する独自のプロバイダを作成する場合は、独自のプロバイダを作成できます。

## <a name="creating-your-own-membership-provider"></a>独自のメンバーシップ プロバイダの作成

独自のメンバーシップ プロバイダーを作成するには、最初に、メンバーシップ プロバイダー クラスから継承するクラスを作成する必要があります。 VB.NETを使用している場合、Visual Studio 2005 はオーバーライドする必要があるすべてのメソッドのスタブを追加します。 C# を使用している場合は、スタブを追加できます。

次の項目をオーバーライドする必要があります。

- プロパティ
- 変更パスワード関数
- 関数の質問と回答を変更します。
- ユーザー関数の作成
- ユーザーの削除機能
- プロパティを有効にします。
- プロパティを有効にします。
- 関数によってユーザーを検索します。
- 関数を検索します。
- 関数を取得します。
- 関数を取得します。
- 関数を取得します。
- 関数を取得します。
- 関数によってユーザー名を取得します。
- プロパティを指定します。
- プロパティは必須です。
- プロパティ
- プロパティ
- パスワードフォーマットプロパティ
- プロパティ
- 必要な質問と回答のプロパティ
- プロパティが必要です。
- リセットパスワード関数
- ユーザー機能のロック解除
- ユーザー関数を更新します。
- ユーザー関数を検証する

これは、C# 開発者として実装する一覧です。 実装を行わずにVB.NETでクラスを作成し、.NET Reflector または同様のツールを使用してコードを C# に変換する方が簡単です。

接続文字列およびその他のプロパティは、Initialize メソッドで既定値に設定する必要があります。 (Initialize メソッドは、実行時にプロバイダーが読み込まれるときに起動されます)。初期化メソッドの 2 番目のパラメーターは、型 System.Collections.Specializeed.NameValueCollection であり、web.config ファイル内の&lt;カスタム プロバイダーに関連付けられている追加&gt;要素への参照です。 このエントリは次のようになります。

[!code-xml[Main](membership/samples/sample6.xml)]

次に、Initialize メソッドの例を示します。

[!code-csharp[Main](membership/samples/sample7.cs)]

ユーザーがログイン フォームを送信するときにユーザーを検証するには、ValidateUser メソッドを使用する必要があります。 このメソッドは、ユーザーが Login コントロールのログイン ボタンをクリックしたときに起動します。 このメソッドでは、ユーザールックアップを実行するコードを配置します。

ご覧のとおり、独自のメンバーシップ プロバイダを作成することは難しくはないし、ASP.NET 2.0 のこの強力な機能を拡張することができます。
