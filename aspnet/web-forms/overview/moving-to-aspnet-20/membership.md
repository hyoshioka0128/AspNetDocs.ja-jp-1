---
uid: web-forms/overview/moving-to-aspnet-20/membership
title: メンバーシップ |Microsoft Docs
author: microsoft
description: ASP.NET メンバーシップは、ASP.NET 1.x からのフォーム認証モデルが成功したときに構築されます。 ASP.NET フォーム認証を使用すると便利です。
ms.author: riande
ms.date: 02/20/2005
ms.assetid: f2339485-5d78-4c5e-8c0a-dc9b8a315345
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/membership
msc.type: authoredcontent
ms.openlocfilehash: da6fc205bd852a818d65425586cec38fdb08d310
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78521704"
---
# <a name="membership"></a>Membership

[Microsoft](https://github.com/microsoft)

> ASP.NET メンバーシップは、ASP.NET 1.x からのフォーム認証モデルが成功したときに構築されます。 ASP.NET フォーム認証は、ASP.NET アプリケーションにログインフォームを組み込み、データベースやその他のデータストアに対してユーザーを検証する便利な方法を提供します。

ASP.NET メンバーシップは、ASP.NET 1.x からのフォーム認証モデルが成功したときに構築されます。 ASP.NET フォーム認証は、ASP.NET アプリケーションにログインフォームを組み込み、データベースやその他のデータストアに対してユーザーを検証する便利な方法を提供します。 FormsAuthentication クラスのメンバーを使用すると、認証用の cookie の処理、有効なログインの確認、ユーザーのログアウトなどを行うことができます。ただし、ASP.NET 1.x アプリケーションでフォーム認証を実装するには、かなりの量のコードが必要になることがあります。

ASP.NET 2.0 のメンバーシップは、フォーム認証のみを使用することに対する大きな進歩です。 (フォーム認証と組み合わせた場合、メンバーシップは最も堅牢ですが、フォーム認証を使用する必要はありません)。すぐにわかるように、ASP.NET メンバーシップと ASP.NET 2.0 のログインコントロールを使用して、大量のコードを記述しなくても強力なメンバーシップシステムを実装できます。

## <a name="implementing-membership-in-aspnet-20"></a>ASP.NET 2.0 でのメンバーシップの実装

メンバーシップは、次の4つの手順によって実装されます。 関連するサブステップは多数あり、オプションの構成も実装できることに注意してください。 これらの手順は、メンバーシップの構成の全体像を示すことを目的としています。

1. メンバーシップデータベースを作成します (メンバーシップストアとして SQL Server が使用されている場合)。
2. アプリケーションの構成ファイルでメンバーシップのオプションを指定します。 (メンバーシップは既定で有効になっています)。
3. 使用するメンバーシップストアの種類を決定します。 オプション: 

    - Microsoft SQL Server (バージョン7.0 以降)
    - Active Directory ストア
    - カスタムメンバーシッププロバイダー
4. ASP.NET フォーム認証用にアプリケーションを構成します。 この場合も、メンバーシップはフォーム認証を利用するように設計されていますが、フォーム認証の使用は必須ではありません。
5. メンバーシップのユーザーアカウントを定義し、必要に応じてロールを構成します。

## <a name="creating-the-membership-database"></a>メンバーシップデータベースの作成

メンバーシップストアとして SQL Server 7.0 以降を使用している場合は、aspnet\_regsql ユーティリティ (Visual Studio .NET 2005 コマンドプロンプトから最も簡単に利用可能) を使用してデータベースを構成できます。 Aspnet\_regsql ユーティリティは、コマンドプロンプトツールとして、または GUI ウィザードを使用して使用できます。 ウィザードの方法は、データベースを構成する最も簡単な方法です。 ウィザードにアクセスするには、次のコマンドを実行します。

`aspnet_regsql W`

このコマンドを実行すると、次のように ASP.NET SQL Server セットアップウィザードが表示されます。

![](membership/_static/image1.jpg)

**図 1**

ASP.NET SQL Server セットアップウィザードでは、ウィザードで指定したインスタンスに Web サイトが作成されます。 ただし、ASP.NET は machine.config ファイルの接続文字列を使用してデータベースに接続します。 既定では、この接続文字列は SQL Server 2005 インスタンスを指しているため、SQL Server 2000 または SQL Server 7.0 インスタンスを使用している場合は、machine.config ファイル内の接続文字列を変更する必要があります。 この接続文字列は次の場所にあります。

[!code-xml[Main](membership/samples/sample1.xml)]

残念ながら、接続文字列を変更しないと、ASP.NET では説明的なエラーは表示されません。 データベースが作成されていないことを示すようになります。 上記の例では、ローカル SQL Server 2000 インスタンスを指すように接続文字列を変更しました。

## <a name="specifying-configuration-and-adding-users-and-roles"></a>構成の指定およびユーザーとロールの追加

メンバーシップを構成する次の手順では、アプリケーションの web.config ファイルに必要な情報を追加します。 ASP.NET 1.x では、lowerCamelCase と Intellisense の欠如が使用されているため、web.config ファイルを変更することが困難な場合がありました。 Visual Studio .NET 2005 では、構成ファイルの Intellisense によってタスクが大幅に簡略化されますが、ASP.NET 2.0 は、構成ファイルを編集するための Web インターフェイスを提供することで、さらに一歩進めます。

Web インターフェイスを起動するには、次に示すように、ソリューションエクスプローラーツールバーの [ASP.NET 構成] ボタンをクリックします。 また、ログインコントロールが挿入されたときに表示されるポップアップを使用して、Web インターフェイスを起動することもできます。

![](membership/_static/image2.jpg)

**図 2**

これにより、次に示す ASP.NET Web サイト管理ツールが起動します。 ASP.NET Web サイトの管理は、4つのタブからなるインターフェイスであり、アプリケーションの設定を簡単に管理できます。 次のタブを使用できます。

- **ホーム**
- **セキュリティ**ユーザー、ロール、およびアクセスを構成します。
- **アプリケーション**アプリケーション設定を構成します。
- **プロバイダー**アプリケーションのメンバーシッププロバイダーを構成してテストします。

Web サイト管理ツールを使用すると、新しいユーザーの作成、新しいロールの作成、およびユーザーとロールの管理を簡単に行うことができます。 この機能は、Windows インターフェイスでは使用できません。 Windows インターフェイスを使用すると、承認設定を簡単に定義したり、Web サイト管理ツールに含まれていないプロバイダーや機能を追加、削除、および管理したりすることができます。

Windows インターフェイスを起動するには、インターネットインフォメーションサービススナップインを開き、アプリケーションを右クリックして、[プロパティ] を選択します。 [ASP.NET] タブをクリックし、[構成の編集] ボタンをクリックします。 ([構成の編集] ボタンを有効にするには、アプリケーションが ASP.NET 2.0 で実行されている必要があります。 ASP.NET のバージョンは、[ASP.NET] ダイアログでも構成できます)。次に示すように、[ASP.NET の構成設定] ダイアログが表示されます。

![](membership/_static/image3.jpg)

**図 3**

[全般] タブには、接続文字列とアプリケーション設定が表示されます。 斜体の設定はすべて、親構成ファイル (つまり、より高いレベルの machine.config または web.config) で定義されており、斜体以外の設定は、アプリケーション構成ファイルに含まれています。 アプリケーションレベルで設定が追加、削除、または編集された場合、ASP.NET は、継承元の構成ファイルから設定を削除するのではなく、アプリケーションレベルの web.config で設定を追加、削除、または変更します。

[認証] タブを次に示します。 ここで、メンバーシップの設定を構成します。 フォーム認証設定、メンバーシッププロバイダー、およびロールプロバイダーは、ここで構成できます。

![](membership/_static/image4.jpg)

**図 4**

## <a name="implementing-membership-in-your-application"></a>アプリケーションへのメンバーシップの実装

アプリケーションに ASP.NET 2.0 メンバーシップを実装する最も簡単な方法は、指定されたログオンコントロールを使用することです。 このメソッドを使用すると、コードを記述することなく、ASP.NET 2.0 メンバーシップの基本を実装できます。

ASP.NET 2.0 では、次のログオンコントロールを使用できます。

## <a name="login-control"></a>ログイン制御

ログインコントロールには、メンバーシップシステムにログインするためのインターフェイスが用意されています。 ユーザー名とパスワードのテキストボックスとログインボタンが表示されます。 まだ登録していないユーザーを登録するためのリンクなどの他の多くの一般的な機能、ユーザーが以降の訪問で自動的にログインできるようにするチェックボックス、パスワードリマインダーのリンクなどがあります。ログインコントロールのすべての機能は、コントロールのプロパティを使用してカスタマイズできます。

ASP.NET 1.x では、開発者はフォーム認証を使用するときに、検索を実行するためのコードをかなり大量に記述する必要がありました。 ASP.NET 2.0 メンバーシップを使用すると、コードを記述しなくてもユーザーを検証できます。 ASP.NET は、ユーザーの検索を自動的に実行します。 (ASP.NET メンバーシップを使用せずに Login コントロールを使用している場合は、 **Onauthenticate**メソッドを使用してユーザーを検証できます)。

## <a name="loginview-control"></a>LoginView コントロール

LoginView コントロールは、既定で2つのテンプレートを提供する、テンプレート化されたコントロールです。AnonymousTemplate と LoggedInTemplate です。 表示されるテンプレートは、ユーザーがメンバーシップシステムにログインしているかどうかによって決まります。 通常、このコントロールは、ユーザーがまだログインしていないときにログインコントロールを表示するために使用されます。また、ユーザーがログインしたときの LoginStatus コントロールやその他のログインコントロールを表示します。 ASP.NET アプリケーションでロール管理を使用している場合、LoginView コントロールでは、ユーザーロールに基づいて特定のテンプレートを表示できます。 (ASP.NET ロール管理の詳細については、後で説明します)。

## <a name="passwordrecovery-control"></a>PasswordRecovery コントロール

PasswordRecovery コントロールを使用すると、ユーザーは現在のパスワードを使用して電子メールを受信したり、パスワードをリセットしたりできます。 クリアテキストと暗号化されたパスワードは、回復してユーザーに電子メールで送信できます。 パスワードがハッシュされている場合は、復元できません。 代わりに、ユーザーはパスワードのリセットを実行する必要があります。

## <a name="loginstatus-control"></a>LoginStatus コントロール

LoginStatus コントロールは、ログインしていないユーザーにログインインジケーターを表示し、現在ログインしているユーザーにログアウトインジケーターを表示するために使用されます。 要求の IsAuthenticated プロパティは、表示するインジケーターを決定するために使用されます。 LoginStatus コントロールによって表示されるインジケーターは、テキスト ( **Logintext**プロパティおよび**logouttext**プロパティを使用して実装されます) またはイメージ ( **logintext**プロパティと**LogoutImageUrl**プロパティを使用して実装されます) にすることができます。

ユーザーが LoginStatus コントロールを使用してログアウトすると、 **Logoutpageurl**プロパティによって指定された url にリダイレクトされます。 このプロパティが設定されていない場合は、現在のページが更新されます。 サイトはフォーム認証によって保護されている可能性があるため、現在のページを更新すると、そのユーザーがサイトのログインページにリダイレクトされます。

## <a name="loginname-control"></a>ログインコントロール

[ログイン] コントロールには、サイトに現在ログインしているユーザーのユーザー名が表示されます。

## <a name="createuserwizard-control"></a>CreateUserWizard コントロール

CreateUserWizard コントロールを使用すると、メンバーシップシステムに登録するための便利な方法をユーザーに提供できます。 次に示すインターフェイスを使用して、(WizardSteps のコレクションとして実装された) ステップを追加できます。

![](membership/_static/image5.jpg)

**図5**

CreateUserWizard は、ウィザードクラスから派生し、次のテンプレートを提供する、テンプレート化されたコントロールです。

- **System.windows.controls.headereditemscontrol.headertemplate**このテンプレートは、ウィザードのヘッダーの外観を制御します。
- **Sidebartemplate**このテンプレートは、ウィザードのサイドバーの外観を制御します。
- **Startnavigationtemplate**このテンプレートは、開始ステップでのウィザードのナビゲーションの外観を制御します。
- **Stepnavigationtemplate**このテンプレートは、[開始] または [終了] の手順で、ナビゲーション領域の外観を制御します。
- **ナビゲーションテンプレート**の終了このテンプレートは、[完了] ステップでのナビゲーション領域の外観を制御します。

さらに、ウィザードに追加する各ステップに対して、ASP.NET は、その手順の System.windows.controls.contentcontrol.contenttemplate と CustomNavigationTemplate の両方を含むカスタムテンプレートを作成します。 CreateUserWizard のカスタマイズの詳細については、VS.NET 2005 のドキュメントを参照してください。

## <a name="changepassword-control"></a>ChangePassword コントロール

ChangePassword コントロールを使用すると、ユーザーは自分のパスワードを変更できます。 DisplayUserName プロパティが true (既定では false) の場合、ユーザーはログインしていないときに自分のパスワードを変更できます。 ユーザーが既にログインし*ていて*displayusername プロパティが true の場合、ユーザーは、ログインしていない別のユーザーのパスワードを変更して、そのユーザーのユーザー ID を知らせることができます。

ログインしなくてもユーザーがパスワードを変更できるようにするには、[ChangePassword] コントロールが表示されているページで匿名アクセスを許可する必要があることに注意してください。 当然ながら、パスワードを変更するには、ユーザーが古いパスワードを入力する必要があります。

## <a name="role-management"></a>ロール管理

ロール管理を使用すると、特定のロールにユーザーを割り当てて、そのロールに基づいて特定のファイルまたはフォルダーへのアクセスを制限することができます。 ロール管理には API も用意されています。これにより、プログラムによってロールを特定し、特定のロールのすべてのユーザーを特定し、それに応じて応答することができます。

ロール管理は、ASP.NET メンバーシップでは必須ではなく、ロール管理を使用するための要件のメンバーシップでもありません。 ただし、2つの補足はうまくいき、開発者が相互に組み合わせて使用する可能性が高くなります。

アプリケーションでロール管理を有効にするには、web.config ファイルで次の変更を行います。

[!code-xml[Main](membership/samples/sample2.xml)]

**Cacherolesincookie**属性が true に設定されている場合、ASP.NET は、クライアントの cookie にユーザーロールのメンバーシップをキャッシュします。 これにより、RoleProvider を呼び出すことなく、ロールの参照を行うことができます。 この属性を使用する場合、開発者は、 **Cookieprotection**属性が All に設定されていることを確認することをお勧めします。 (これが既定の設定です。)これにより、cookie データが確実に暗号化され、cookie の内容が改ざんされないようにすることができます。 ロールは、Web サイト管理ツールを使用して追加できます。 これにより、ロールを定義し、それらのロールに基づいてサイトの一部へのアクセスを構成し、ユーザーをロールに割り当てることができます。

![](membership/_static/image6.jpg)

**図6**

上に示すように、役割の名前を入力し、[役割の追加] をクリックするだけで、新しい役割を追加できます。 既存のロールの一覧で適切なリンクをクリックすると、既存のロールを管理または削除できます。

ロールを管理するときは、次に示すように、ユーザーを追加または削除できます。

![](membership/_static/image7.jpg)

**図7**

[ユーザーがロール内にある] チェックボックスをオンにすると、特定のロールにユーザーを簡単に追加できます。 ASP.NET は、適切なエントリでメンバーシップデータベースを自動的に更新します。 また、アプリケーションのアクセス規則を構成する必要があります。 ASP.NET 1.x の開発者は、web.config ファイルの &lt;authorization&gt; 要素を使用してこれを行うことに慣れていますが、このオプションは ASP.NET 2.0 で引き続き使用できます。 ただし、次のように Web サイト管理ツールを使用すると、アクセス規則を管理しやすくなります。

![](membership/_static/image8.jpg)

**図8**

この場合、管理フォルダーは強調表示されています (このツールでは薄い灰色で強調表示されています)。管理者ロールにはアクセス権が付与されています。 他のすべてのユーザーは拒否されます。 ルールを選択し、上へ移動し、下へ移動 ボタンを使用してルールを並べ替えますヘッドのアイコンをクリックすることができます。 ASP.NET &lt;authorization&gt; 要素と同様に、ルールは出現順に処理されます。 つまり、上のショットのルールの順序が逆になった場合、管理フォルダーにアクセスできるのは誰もありません。これは、ASP.NET が遭遇する最初のルールが、すべてのユーザーをフォルダーに拒否するルールであるためです。

ASP.NET 2.0 は、アクセス規則を指定しているフォルダーに web.config ファイルを追加します。 アクセス規則を編集するには、構成ファイルを使用するか、Web サイト管理ツールを使用します。 言い換えると、Web サイト管理ツールは、ユーザーフレンドリな環境で構成ファイルを編集するためのインターフェイスにすぎません。

## <a name="using-roles-in-code"></a>コードでのロールの使用

バージョン1.x 以降、ロール管理用の API は変更されていません。 **IsInRole**メソッドは、ユーザーが特定のロールに含まれているかどうかを判断するために使用されます。

[!code-csharp[Main](membership/samples/sample3.cs)]

また、ASP.NET は、現在のコンテキストのメンバーとして RolePrincipal インスタンスを作成します。 RolePrincipal オブジェクトは、次のように、ユーザーが属するすべてのロールを取得するために使用できます。

[!code-csharp[Main](membership/samples/sample4.cs)]

## <a name="using-rolegroups-with-the-loginview-control"></a>LoginView コントロールでの RoleGroups の使用

これで、ロール管理とメンバーシップについて理解できました。次は、LoginView コントロールが ASP.NET 2.0 でこの機能を利用する方法について簡単に説明します。 既に説明したように、LoginView コントロールは、既定で2つのテンプレートを含むテンプレートコントロールです。AnonymousTemplate と LoggedInTemplate です。 内の LoginView タスク ダイアログ (下図参照) のリンクは、RoleGroups を編集することができます。

![](membership/_static/image9.jpg)

**図9**

各 RoleGroup オブジェクトには、RoleGroup が適用されるロールを定義する文字列の配列が含まれています。 LoginView コントロールに新しい RoleGroup を追加するには、[Rolegroup の編集] リンクをクリックします。 上の図では、管理者用に新しい RoleGroup を追加したことがわかります。 [ビュー] ドロップダウンからこの RoleGroup (RoleGroup [0]) を選択すると、管理者ロールのメンバーにのみ表示されるテンプレートを構成できます。 次の図では、Sales ロールのメンバーと配布ロールのメンバーに適用される新しい RoleGroup を追加しました。 これにより、[LoginView Tasks] ダイアログボックスの [Views] ドロップダウンに2番目の RoleGroup が追加され、そのテンプレートに追加されたすべてのものが、販売ロールまたは配布ロールのいずれかのユーザーが表示できるようになります。

![](membership/_static/image10.jpg)

**図10**

## <a name="overriding-the-existing-membership-provider"></a>既存のメンバーシッププロバイダーのオーバーライド

ASP.NET メンバーシップの機能を拡張するには、いくつかの方法があります。 まず、SqlMembershipProvider クラスから継承し、そのメソッドをオーバーライドすることによって、既存の機能を変更することができます。 たとえば、ユーザーの作成時に独自の機能を実装する場合は、次のように SqlMembershipProvider から継承する独自のクラスを作成できます。

[!code-csharp[Main](membership/samples/sample5.cs)]

一方、独自のプロバイダーを作成する必要がある場合は (たとえば、アクセスデータベースにメンバーシップ情報を格納するため)、独自のプロバイダーを作成できます。

## <a name="creating-your-own-membership-provider"></a>独自のメンバーシッププロバイダーを作成する

独自のメンバーシッププロバイダーを作成するには、まず、MembershipProvider クラスを継承するクラスを作成する必要があります。 VB.NET を使用している場合は、オーバーライドする必要があるすべてのメソッドのスタブが Visual Studio 2005 によって追加されます。 を使用してC#いる場合は、スタブを追加する必要があります。

次のものをオーバーライドする必要があります。

- ApplicationName プロパティ
- ChangePassword 関数
- ChangePasswordQuestionAndAnswer 関数
- CreateUser 関数
- DeleteUser 関数
- EnablePasswordReset プロパティ
- EnablePasswordRetrieval 取得プロパティ
- Findの Byemail 関数
- FindUsersByName 関数
- GetAllUsers 関数
- Getnumberofのオンライン関数
- GetPassword 関数
- GetUser 関数
- GetUserNameByEmail 関数
- MaxInvalidPasswordAttempts プロパティ
- MinRequiredNonAlphanumericCharacters プロパティ
- MinRequiredPasswordLength プロパティ
- PasswordAttemptWindow プロパティ
- PasswordFormat プロパティ
- PasswordStrengthRegularExpression プロパティ
- RequiresQuestionAndAnswer プロパティ
- RequiresUniqueEmail プロパティ
- ResetPassword 関数
- ユーザー関数のロック解除
- UpdateUser 関数
- ValidateUser 関数

拡張子は、 C#開発者として実装するためのリストをかなり持っています。 実装せずに VB.NET でクラスを作成する方が簡単な場合があります。その後、.NET リフレクターまたは同様のC#ツールを使用して、コードをに変換します。

Initialize メソッドでは、接続文字列とその他のプロパティを既定値に設定する必要があります。 (初期化メソッドは、実行時にプロバイダーが読み込まれるときに発生します。)Initialize メソッドの2番目のパラメーターは NameValueCollection 型で、web.config ファイル内のカスタムプロバイダーに関連付けられた&gt; 要素を追加 &lt;への参照です。 このエントリは次のようになります。

[!code-xml[Main](membership/samples/sample6.xml)]

Initialize メソッドの例を次に示します。

[!code-csharp[Main](membership/samples/sample7.cs)]

ユーザーがログインフォームを送信したときにユーザーを検証するには、ValidateUser メソッドを使用する必要があります。 このメソッドは、ユーザーがログインコントロールの [ログイン] ボタンをクリックしたときに発生します。 ユーザーが参照するコードをこのメソッドに配置します。

ご覧のように、独自のメンバーシッププロバイダーを作成するのは困難ではなく、ASP.NET 2.0 の強力な機能を拡張することができます。
