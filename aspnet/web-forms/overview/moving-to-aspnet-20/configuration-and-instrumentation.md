---
uid: web-forms/overview/moving-to-aspnet-20/configuration-and-instrumentation
title: 構成とインストルメンテーション |マイクロソフトドキュメント
author: rick-anderson
description: ASP.NET 2.0 では、構成とインストルメンテーションに大きな変更があります。 新しいASP.NET構成 API を使用すると、構成の変更を行うことができます。
ms.author: riande
ms.date: 02/20/2005
ms.assetid: 21ebbaee-7ed8-45ae-b6c1-c27c88342e48
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/configuration-and-instrumentation
msc.type: authoredcontent
ms.openlocfilehash: 30ea2ffd3d055c5373a33615bc19a8f68fb568ab
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2020
ms.locfileid: "81543055"
---
# <a name="configuration-and-instrumentation"></a>構成とインストルメンテーション

[マイクロソフト](https://github.com/microsoft)

> ASP.NET 2.0 では、構成とインストルメンテーションに大きな変更があります。 新しいASP.NET構成 API を使用すると、プログラムで構成の変更を行うことができます。 さらに、新しい構成設定が多数存在し、新しい構成とインストルメンテーションを実現できます。

ASP.NET 2.0 では、構成とインストルメンテーションに大きな変更があります。 新しいASP.NET構成 API を使用すると、プログラムで構成の変更を行うことができます。 さらに、新しい構成設定が多数存在し、新しい構成とインストルメンテーションを実現できます。

このモジュールでは、構成ファイルの読み取りと書き込みに関連する構成 API ASP.NETについて説明し、ASP.NET ASP.NETインストルメンテーションについても説明します。 また、ASP.NETトレースで利用可能な新機能についても説明します。

## <a name="aspnet-configuration-api"></a>ASP.NET構成 API

ASP.NET構成 API を使用すると、単一のプログラミング・インターフェースを使用して、アプリケーション構成データの開発、デプロイ、および管理を行うことができます。 構成 API を使用すると、構成ファイル内の XML を直接編集しなくても、プログラムで完全なASP.NET構成を開発および変更できます。 さらに、構成 API は、開発したコンソール アプリケーションとスクリプト、Web ベースの管理ツール、および Microsoft 管理コンソール (MMC) スナップインで使用できます。

次の 2 つの構成管理ツールは、構成 API を使用し、.NET Framework バージョン 2.0 に含まれています。

- ASP.NET MMC スナップインは、構成 API を使用して管理タスクを簡略化し、構成階層のすべてのレベルのローカル構成データを統合表示します。
- Web サイト管理ツール: ホストされたサイトを含む、ローカル およびリモート アプリケーションの構成設定を管理できます。

ASP.NET構成 API は、Web サイトおよびアプリケーションをプログラムで構成するために使用できるASP.NET管理オブジェクトのセットで構成されます。 管理オブジェクトは、.NET Framework クラス ライブラリとして実装されます。 構成 API プログラミング モデルは、コンパイル時にデータ型を適用することで、コードの一貫性と信頼性を確保するのに役立ちます。 アプリケーション構成の管理を容易にするために、構成 API では、データを別々の構成ファイルから別々のコレクションとして表示するのではなく、構成階層内のすべてのポイントからマージされたデータを単一のコレクションとして表示できます。 さらに、構成 API を使用すると、構成ファイル内の XML を直接編集することなく、アプリケーション構成全体を操作できます。 最後に、この API は Web サイト管理ツールなどの管理ツールをサポートすることで構成タスクを簡素化します。 構成 API は、コンピューター上で構成ファイルの作成をサポートし、複数のコンピューターで構成スクリプトを実行することで、デプロイを簡素化します。

> [!NOTE]
> 構成 API は IIS アプリケーションの作成をサポートしていません。

## <a name="working-with-local-and-remote-configuration-settings"></a>ローカルおよびリモートの構成設定を使用する

Configuration オブジェクトは、コンピューターなどの特定の物理エンティティ、またはアプリケーションや Web サイトなどの論理エンティティに適用される構成設定のマージされたビューを表します。 指定された論理エンティティは、ローカル コンピューターまたはリモート サーバーに存在できます。 指定したエンティティに構成ファイルが存在しない場合、構成オブジェクトは Machine.config ファイルで定義されている既定の構成設定を表します。

次のクラスのオープン構成メソッドのいずれかを使用して Configuration オブジェクトを取得できます。

1. エンティティがクライアント アプリケーションの場合は、ConfigurationManager クラス。
2. エンティティが Web アプリケーションの場合は、クラス。

これらのメソッドは Configuration オブジェクトを返し、基になる構成ファイルを処理するために必要なメソッドとプロパティを提供します。 これらのファイルには、読み取りまたは書き込み用にアクセスできます。

### <a name="reading"></a>読書

構成情報を読み取るのには、GetSection メソッドまたは GetSectionGroup メソッドを使用します。 読み取るユーザーまたはプロセスは、階層内のすべての構成ファイルに対する読み取りアクセス許可を持っている必要があります。

> [!NOTE]
> パス パラメーターを受け取る静的な GetSection メソッドを使用する場合、path パラメーターは、コードが実行されているアプリケーションを参照する必要があります。 それ以外の場合、パラメーターは無視され、現在実行中のアプリケーションの構成情報が返されます。

### <a name="writing"></a>書き込み

構成情報を書き込むには、Save メソッドのいずれかを使用します。 書き込むユーザーまたはプロセスは、現在の構成階層レベルでの構成ファイルおよびディレクトリに対する書き込みアクセス許可と、階層内のすべての構成ファイルに対する読み取り権限を持っている必要があります。

指定したエンティティの継承された構成設定を表す構成ファイルを生成するには、次のいずれかの保存構成方法を使用します。

1. Save メソッドを使用して、新しい構成ファイルを作成します。
2. SaveAs メソッドを使用して、別の場所に新しい構成ファイルを生成します。

## <a name="configuration-classes-and-namespaces"></a>構成クラスと名前空間

多くの構成クラスとメソッドは、互いに類似しています。 次の表は、最も一般的に使用される構成クラスと名前空間を示しています。

| **構成クラスまたは名前空間** | **説明** |
| --- | --- |
| [構成](https://msdn.microsoft.com/library/system.configuration.aspx)名前空間 | すべての .NET Framework アプリケーションの主要な構成クラスを格納します。 セクション ハンドラー クラスは、GetSection や GetSectionGroup などのメソッドからセクションの構成データを取得するために使用されます。 これら 2 つのメソッドは非静的です。 |
| 構成クラス | コンピューター、アプリケーション、Web ディレクトリ、またはその他のリソースの構成データのセットを表します。 このクラスには、構成設定を更新し、セクションとセクション グループへの参照を取得するための便利なメソッド (GetSection や GetSectionGroup など) が含まれています。 このクラスは、デザイン時の構成データを取得するメソッド (Web 構成マネージャー クラスや構成マネージャー クラスのメソッドなど) の戻り値の型として使用されます。 |
| 構成名前空間 | ASP.NET[の構成設定](https://msdn.microsoft.com/library/b5ysx397.aspx)で定義されているASP.NET構成セクションのセクション ハンドラ クラスが含まれています。 セクション ハンドラー クラスは、GetSection や GetSectionGroup などのメソッドからセクションの構成データを取得するために使用されます。 |
| クラス | 実行時およびデザイン時の構成設定への参照を取得するための便利なメソッドを提供します。 これらのメソッドは、戻り値の型として System.Configuration.Configuration クラスを使用します。 このクラスの静的 GetSection メソッドまたは System.Configuration.ConfigurationManager クラスの非静的な GetSection メソッドを同じ意味で使用できます。 Web アプリケーション構成の場合は、クラスの代わりにクラスを推奨します。 |
| [プロバイダー](https://msdn.microsoft.com/library/system.configuration.provider.aspx)名前空間 | 構成プロバイダーをカスタマイズおよび拡張する方法を提供します。 これは、構成システム内のすべてのプロバイダー クラスの基本クラスです。 |
| [名前空間](https://msdn.microsoft.com/library/system.web.management.aspx) | Web アプリケーションの状態を管理および監視するためのクラスとインターフェイスが含まれています。 厳密に言えば、この名前空間は構成 API の一部とは見なされません。 たとえば、トレースとイベントの発生は、この名前空間のクラスによって実行されます。 |
| [インストルメンテーション](https://msdn.microsoft.com/library/system.management.instrumentation.aspx)名前空間 | アプリケーションのインストルメンテーションが、Windows 管理インストルメンテーション (WMI) を通じて管理情報とイベントを潜在的なコンシューマに公開するために必要なクラスを提供します。 ASP.NET状態監視では、WMI を使用してイベントを配信します。 厳密に言えば、この名前空間は構成 API の一部とは見なされません。 |

## <a name="reading-from-aspnet-configuration-files"></a>ASP.NET構成ファイルからの読み取り

クラスは、ASP.NET構成ファイルから読み取るためのコア クラスです。 構成ファイルの読み取りには、基本的に次の 3 つの手順ASP.NET。

1. メソッドを使用して構成オブジェクトを取得します。
2. 構成ファイル内の目的のセクションへの参照を取得します。
3. 構成ファイルから必要な情報を読み取ります。

Configuration オブジェクトは、特定の構成ファイルを表すものではありません。 代わりに、コンピュータ、アプリケーション、または Web サイトの構成をマージしたビューを表します。 次のコード サンプルは *、ProductInfo*という Web アプリケーションの構成を表す Configuration オブジェクトをインスタンス化します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample1.cs)]

> [!NOTE]
> /ProductInfo パスが存在しない場合、上記のコードは machine.config ファイルで指定されている既定の構成を返します。

構成オブジェクトを取得したら、GetSection メソッドまたは GetSectionGroup メソッドを使用して構成設定をドリルダウンできます。 次の例では、上記の ProductInfo アプリケーションの偽装設定への参照を取得します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample2.cs)]

## <a name="writing-to-aspnet-configuration-files"></a>構成ファイルASP.NET書き込み

構成ファイルからの読み取りと同様に、WebConfigurationManager クラスは、Asp.NET構成ファイルに書き込むコアです。 構成ファイルに書き込むには、3 つの手順ASP.NETもあります。

1. メソッドを使用して構成オブジェクトを取得します。
2. 構成ファイル内の目的のセクションへの参照を取得します。
3. Save メソッドまたは SaveAs メソッドを使用して、構成ファイルから必要な情報を書き込みます。

次のコードは、コンパイル&gt;要素の**デバッグ**属性を&lt;false に変更します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample3.cs)]

このコードが実行されると&lt;*、webApp*アプリケーションの&gt;web.config ファイルのコンパイル要素の**デバッグ**属性が false に設定されます。

## <a name="systemwebmanagement-namespace"></a>名前空間

System.Web.Management 名前空間には、ASP.NETアプリケーションの正常性を管理および監視するためのクラスとインターフェイスが用意されています。

ログ記録は、イベントをプロバイダに関連付けるルールを定義することによって行われます。 ルールは、プロバイダーに送信されるイベントの種類を定義します。 ログには、次の基本イベントを使用できます。

| **ウェブイベント** | すべてのイベントの基本イベント クラス。 イベント コード、イベント詳細コード、イベントが発生した日時、シーケンス番号、イベント メッセージ、イベントの詳細など、すべてのイベントに必要なプロパティが含まれます。 |
| --- | --- |
| **イベント** | アプリケーションの有効期間、要求、エラー、監査イベントなどの管理イベントの基本イベント クラス。 |
| **イベント** | アプリケーションによって定期的に生成され、便利なランタイム状態情報を取得するイベント。 |
| **イベント** | セキュリティ監査イベントの基本クラスで、認証エラーや復号化の失敗などの条件をマークするために使用されます *。* |
| **イベント** | すべての情報要求イベントの基本クラス。 |
| **イベント** | エラー条件を示すすべてのイベントの基本クラス。 |

利用可能なプロバイダの種類を使用すると、イベント ビューア、SQL Server、Windows 管理インストルメンテーション (WMI)、および電子メールにイベント出力を送信できます。 事前に構成されたプロバイダーとイベント マッピングにより、イベント出力をログ出力するために必要な作業量が削減されます。

ASP.NET 2.0 では、イベント ログ プロバイダを使用して、アプリケーション ドメインの開始と停止に基づいてイベントをログに記録し、未処理の例外をログに記録します。 これは、いくつかの基本的なシナリオをカバーするのに役立ちます。 たとえば、アプリケーションが例外をスローしても、ユーザーがエラーを保存せず、再現できない場合を考えてみましょう。 既定のイベント ログ ルールを使用すると、例外とスタック情報を収集して、発生したエラーの種類を把握できます。 アプリケーションがセッション状態を失っている場合は、別の例が適用されます。 その場合は、イベント ログを調べて、アプリケーション ドメインがリサイクルされているかどうか、およびアプリケーション ドメインが最初に停止した理由を確認できます。

また、正常性監視システムは拡張可能です。 たとえば、カスタム Web イベントを定義し、アプリケーション内でイベントを発生させ、イベント情報を電子メールなどのプロバイダーに送信するルールを定義できます。 これにより、インストルメンテーションを正常性監視プロバイダーに簡単に結び付けることができます。 別の例として、注文が処理されるたびにイベントを発生させ、各イベントを SQL Server データベースに送信するルールを設定できます。 また、ユーザーが連続して複数回ログオンできなかった場合にイベントを発生させ、電子メール ベースのプロバイダーを使用するようにイベントを設定することもできます。

既定のプロバイダーとイベントの構成は、グローバルな Web.config ファイルに格納されます。 グローバル Web.config ファイルには、Machine.config ファイルに格納されたすべての Web ベースの設定が ASP.NET 1x に格納されます。 グローバル Web.config ファイルは、次のディレクトリにあります。

`%windir%\Microsoft.Net\Framework\v2.0.*\config\Web.config`

グローバル&lt;な&gt;Web.config ファイルの正常性監視セクションには、既定の構成設定が用意されています。 これらの設定をオーバーライドしたり、アプリケーションの&lt;Web.config ファイルに&gt;healthMonitoring セクションを実装して独自の設定を構成したりできます。

グローバル&lt;Web.config ファイルの正常性監視&gt;セクションには、次の項目が含まれています。

| **providers** | イベント ビューア、WMI、および SQL Server 用にセットアップされたプロバイダが含まれています。 |
| --- | --- |
| **イベントマッピング** | さまざまな WebBase クラスのマッピングが含まれています。 独自のイベント クラスを生成する場合は、このリストを拡張できます。 独自のイベント クラスを生成すると、情報を送信するプロバイダーに対して細かく粒度を高めます。 たとえば、独自のカスタム イベントを電子メールに送信するときに、ハンドルされない例外を SQL Server に送信するように構成できます。 |
| **ルール** | イベント マッピングをプロバイダーにリンクします。 |
| **バッファリング** | SQL Server および電子メール プロバイダーで、イベントをプロバイダにフラッシュする頻度を決定するために使用します。 |

以下は、グローバルな Web.config ファイルのコード例です。

[!code-xml[Main](configuration-and-instrumentation/samples/sample4.xml)]

## <a name="how-to-store-events-to-event-viewer"></a>イベント ビューアにイベントを格納する方法

前述したように、イベント ビューアーでイベントをログに記録するためのプロバイダーは、グローバルな Web.config ファイルで構成されます。 既定では **、Web ベースエラーイベント**と Web**失敗監査イベント**に基づくすべてのイベントがログに記録されます。 イベント ログに追加情報を記録するルールを追加できます。 たとえば、すべてのイベント **(WebBaseEvent**に基づくすべてのイベント) をログに記録する場合*は、次*のルールを Web.config ファイルに追加できます。

[!code-xml[Main](configuration-and-instrumentation/samples/sample5.xml)]

このルールは、**すべてのイベント イベント**マップをイベント ログ プロバイダにリンクします。 イベント マッピングとプロバイダーの両方が、グローバル Web.config ファイルに含まれます。

## <a name="how-to-store-events-to-sql-server"></a>イベントを SQL Server に格納する方法

このメソッドは **、ASPNET** regsql.exe ツールによって生成される\_ASPNETDB データベースを使用します。 既定のプロバイダーは、アプリケーション\_データ フォルダー内のファイル ベースのデータベースまたは SQL Server のローカル SQLExpress インスタンスを使用する LocalSqlServer 接続文字列を使用します。 接続文字列と Sql プロバイダーの両方がグローバル Web.config ファイルで構成されます。

グローバルな Web.config ファイル内のローカル SqlServer 接続文字列は次のようになります。

[!code-xml[Main](configuration-and-instrumentation/samples/sample6.xml)]

別の SQL Server インスタンスを使用する場合は、%windir%\Microsoft.Net\Framework\v2.0 にある Aspnet\_regsql.exe ツールを使用する必要があります。\*フォルダー。 Aspnet\_regsql.exe ツールを使用して、SQL Server インスタンス上にカスタム**ASPNETDB**データベースを生成し、接続文字列をアプリケーション構成ファイルに追加し、新しい接続文字列を使用してプロバイダーを追加します。 **ASPNETDB**データベースを作成したら、イベントマッピングを sqlProvider にリンクするルールを設定する必要があります。

既定の SqlProvider を使用するか、独自のプロバイダーを構成する場合でも、プロバイダーをイベント マップにリンクするルールを追加する必要があります。 次のルールは、上記で作成した新しいプロバイダーを **[すべてのイベント]** イベント マップにリンクします。 このルールは **、Web ベースイベント**に基づいてすべてのイベントをログに記録し、MYASPNETDB 接続文字列を使用する MySqlWebEventProvider に送信します。 次のコードは、プロバイダーをイベント マップにリンクするルールを追加します。

[!code-xml[Main](configuration-and-instrumentation/samples/sample7.xml)]

SQL Server にエラーだけを送信する場合は、次のルールを追加できます。

[!code-xml[Main](configuration-and-instrumentation/samples/sample8.xml)]

## <a name="how-to-forward-events-to-wmi"></a>WMI にイベントを転送する方法

イベントを WMI に転送することもできます。 WMI プロバイダーは、既定でグローバルな Web.config ファイルで構成されます。

次のコード例では、イベントを WMI に転送するルールを追加します。

[!code-xml[Main](configuration-and-instrumentation/samples/sample9.xml)]

イベントマッピングをプロバイダに関連付けるルールと、イベントをリッスンする WMI リスナー アプリケーションを追加する必要があります。 次のコード例では、WMI プロバイダーを**すべてのイベント**イベント マップにリンクするルールを追加します。

[!code-xml[Main](configuration-and-instrumentation/samples/sample10.xml)]

## <a name="how-to-forward-events-to-email"></a>イベントをメールに転送する方法

イベントをメールに転送することもできます。 SQL Server やイベント ログに適した情報を誤って送信する可能性があるため、電子メール プロバイダにマップするイベント ルールに注意してください。 2 つの電子メール プロバイダーがあります。を指定します。 それぞれが同じ構成属性を持っていますが、「テンプレート」属性と「詳細テンプレートエラー」属性を除いて、どちらもTemplatedMailWebEventProviderでのみ使用できます。

> [!NOTE]
> これらの電子メール プロバイダーはどちらも構成されていません。 Web.config ファイルに追加する必要があります。

これらの 2 つの電子メール プロバイダーの主な違いは、変更できない汎用テンプレートで電子メールを送信することです。 サンプルの Web.config ファイルは、次の規則を使用して、構成済みのプロバイダーの一覧にこの電子メール プロバイダーを追加します。

[!code-xml[Main](configuration-and-instrumentation/samples/sample11.xml)]

また、電子メール プロバイダーを**すべてのイベント イベント**マップに関連付けるには、次のルールも追加されます。

[!code-xml[Main](configuration-and-instrumentation/samples/sample12.xml)]

## <a name="aspnet-20-tracing"></a>ASP.NET 2.0 トレース

ASP.NET 2.0 では、トレースに関する 3 つの主要な機能強化があります。

1. 統合されたトレース機能
2. トレース メッセージへのプログラムによるアクセス
3. アプリケーション レベルのトレースの向上

## <a name="integrated-tracing-functionality"></a>統合されたトレーシング機能

System.Diagnostics.Trace クラスによって生成されたメッセージをルーティングしてトレース出力をASP.NETし、トレースによって生成されたメッセージASP.NET System.Diagnostics.Trace にルーティングできるようになりました。 また、ASP.NETインストルメンテーション イベントを System.Diagnostics.Trace に転送することもできます。 この機能は、トレース&gt;要素の新しい**writeToDiagnosticsTrace**属性によって提供されます&lt;。 このブール値が true の場合、トレース メッセージASP.NET、トレース メッセージを表示するために登録されているすべてのリスナーが使用する System.Diagnostics トレース インフラストラクチャに転送されます。

## <a name="programmatic-access-to-trace-messages"></a>トレース メッセージへのプログラムによるアクセス

ASP.NET 2.0 では **、TraceContextRecord**クラスとトレース**レコード**コレクションを使用して、すべてのトレース メッセージにプログラムでアクセスできます。 トレース メッセージにアクセスする最も効率的な方法は、新しい**TraceFinished**イベントを処理するために **、TraceContextEventHandler**デリゲート (ASP.NET 2.0 でも新しい) を登録することです。 その後、必要に応じてトレース メッセージをループ処理できます。

次のコード サンプルで、このことを示します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample13.cs)]

上記の例では、TraceRecords コレクションをループ処理し、各メッセージを応答ストリームに書き込みます。

## <a name="improved-application-level-tracing"></a>アプリケーション レベルのトレースの改善

アプリケーション レベルのトレースは、トレース&gt;要素の新しい**最新**属性の導入によって&lt;改善されます。 この属性は、最新のアプリケーション レベルのトレース出力を表示するかどうか、および requestLimit で示された制限を超えた古いトレース データを破棄するかどうかを指定します。 false の場合、requestLimit 属性に到達するまで、要求のトレース データが表示されます。

## <a name="aspnet-command-line-tools"></a>ASP.NET コマンド ライン ツール

ASP.NETの設定に役立つコマンドライン ツールがいくつかあります。 ASP.NET開発者は aspnet\_regiis.exe ツールに精通している必要があります。 ASP.NET 2.0 には、構成を支援する他の 3 つのコマンド ライン ツールが用意されています。

次のコマンド ライン ツールを使用できます。

| **ツール** | **用途** |
| --- | --- |
| **aspnet\_regiis.exe** | IIS にASP.NETを登録できるようにします。 このツールには、ASP.NET 32 ビット システム (Framework フォルダー内) と 64 ビット システム用 (Framework64 フォルダー内) の 2 つのバージョンがあります。64 ビットバージョンは 32 ビット OS にはインストールされません。 |
| **aspnet\_regsql.exe** | ASP.NET SQL Server 登録ツールは、ASP.NETの SQL Server プロバイダが使用する Microsoft SQL Server データベースを作成したり、既存のデータベースに対してオプションを追加または削除したりするために使用します。 Aspnet\_regsql.exe ファイルは、Web サーバー上の [ドライブ:]\WINDOWS\Windows\Net\フレームワーク\バージョン番号 フォルダーにあります。 |
| **aspnet\_レジストリブラウザ.exe** | ASP.NET ブラウザー登録ツールは、システム全体のブラウザー定義をすべて解析してコンパイルしてアセンブリに格納し、そのアセンブリをグローバル アセンブリ キャッシュにインストールします。 ツールは、ブラウザー定義ファイル (..NET Framework ブラウザー サブディレクトリからブラウザー ファイル)。 このツールは、%システムルート%\マイクロソフト.NET\フレームワーク\バージョン\ディレクトリにあります。 |
| **aspnet\_コンパイラ.exe** | ASP.NET コンパイル ツールを使用すると、ASP.NET Web アプリケーションを、インプレースでコンパイルしたり、運用サーバーなどのターゲットの場所に配置したりできます。 インプレース コンパイルは、アプリケーションのコンパイル中に、アプリケーションへの最初の要求でエンド ユーザーが遅延を検出しないため、アプリケーションのパフォーマンスを向上させます。 |

aspnet\_regiis.exe ツールは ASP.NET 2.0 の新機能ではないため、ここでは説明しません。

## <a name="aspnet-sql-server-registration-tool---aspnet_regsqlexe"></a>SQL サーバー登録ツールをASP.NET\_- aspnet regsql.exe

SQL Server 登録ツールを使用して、いくつかの種類のオプションASP.NET設定できます。 SQL 接続を指定したり、SQL Server を使用して情報を管理するASP.NETアプリケーション サービスを指定したり、SQL キャッシュの依存関係に使用するデータベースまたはテーブルを指定したり、SQL Server を使用してプロシージャとセッション状態を格納するためのサポートを追加または削除したりできます。

いくつかのASP.NETアプリケーション サービスは、データ ソースからのデータの格納と取得を管理するために、プロバイダに依存しています。 各プロバイダーは、データ ソースに固有です。 ASP.NETには、次のASP.NET機能用の SQL Server プロバイダが含まれています。

- クラスを[クラス](https://msdn.microsoft.com/library/system.web.security.sqlmembershipprovider.aspx)します。
- ロール管理 (クラス[)。](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx)
- クラスを[プロファイルします](https://msdn.microsoft.com/library/system.web.profile.sqlprofileprovider.aspx)。
- Web パーツのパーソナル化 (クラス[)。](https://msdn.microsoft.com/library/system.web.ui.webcontrols.webparts.sqlpersonalizationprovider.aspx)
- Web イベント (クラス[)。](https://msdn.microsoft.com/library/system.web.management.sqlwebeventprovider.aspx)

ASP.NETをインストールすると、サーバーの Machine.config ファイルには、プロバイダーに依存する各ASP.NET機能の SQL Server プロバイダーを指定する構成要素が含まれます。 これらのプロバイダは、既定では SQL Server Express 2005 のローカル ユーザー インスタンスに接続するように構成されています。 プロバイダが使用する既定の接続文字列を変更する場合は、コンピュータ構成で構成されているASP.NET機能を使用する前に、Aspnet\_regsql.exe を使用して SQL Server データベースと選択した機能のデータベース要素をインストールする必要があります。 SQL 登録ツールで指定したデータベースが存在しない場合 (コマンド ラインで指定されていない場合は aspnetdb が既定のデータベースになります)、現在のユーザーは SQL Server でデータベースを作成する権限と、データベース内にスキーマ要素を作成する権限を持っている必要があります。

### <a name="sql-cache-dependency"></a>SQL キャッシュ依存関係

出力キャッシュの高度な機能ASP.NET SQL キャッシュ依存です。 SQL キャッシュ依存関係は、テーブル ポーリングのASP.NET実装を使用するモードと、SQL Server 2005 のクエリ通知機能を使用する 2 つのモードをサポートします。 SQL 登録ツールを使用して、テーブルポーリング操作モードを構成できます。

### <a name="session-state"></a>セッションの状態

既定では、セッション状態の値と情報は、ASP.NET プロセス内のメモリに格納されます。 または、セッション データを SQL Server データベースに格納し、複数の Web サーバーで共有することもできます。 SQL 登録ツールでセッション状態に指定したデータベースがまだ存在しない場合、現在のユーザーは SQL Server でデータベースを作成する権限と、データベース内にスキーマ要素を作成する権限を持っている必要があります。 データベースが存在する場合、現在のユーザーは既存のデータベースにスキーマ要素を作成する権限を持っている必要があります。

SQL Server にセッション状態データベースをインストールするには、Aspnet\_regsql.exe ツールを実行し、コマンドを使用して次の情報を指定します。

- **-S**オプションを使用した SQL Server インスタンスの名前。
- SQL Server を実行しているコンピュータ上でデータベースを作成する権限を持つアカウントのログオン資格情報。 現在ログオンしているユーザーを使用するには **-E**オプションを使用するか **、-U**オプションを使用して **-P**オプションと共にユーザー ID を指定してパスワードを指定します。
- セッション状態データベースを追加するための **-ssadd**コマンド ライン オプション。

既定では、ASPnet\_regsql.exe ツールを使用して、SQL Server 2005 Express Edition を実行しているコンピュータにセッション状態データベースをインストールすることはできません。

### <a name="the-aspnet-browser-registration-tool---aspnet_regbrowsersexe"></a>ASP.NETブラウザ登録ツール - aspnet\_regbrowsers.exe

ASP.NET バージョン 1.1 では、Machine.config ファイルに&lt;"browserCaps"&gt;というセクションが含まれていました。 このセクションには、正規表現に基づいてさまざまなブラウザーの構成を定義する一連の XML エントリが含まれています。 ASP.NET バージョン 2.0 の場合は、新しい .ブラウザファイルは、XMLエントリを使用して、特定のブラウザのパラメータを定義します。 新しいブラウザに情報を追加するには、新しい を追加します。システム上の %SystemRoot%\Microsoft.NET\Framework\バージョン\CONFIG\ブラウザにあるフォルダへのブラウザ ファイル。

アプリケーションは、ブラウザ情報が必要な場合に.config ファイルを読み取るわけではないので、新しい .ブラウザー ファイルを実行し\_、Aspnet regbrowsers.exe を実行して、必要な変更をアセンブリに追加します。 これにより、サーバーは新しいブラウザ情報にすぐにアクセスできるため、情報を受け取るためにアプリケーションをシャットダウンする必要はありません。 アプリケーションは、現在の HttpRequest のブラウザー プロパティを使用してブラウザー機能にアクセスできます。

aspnet\_regbrowser.exe を実行する場合は、次のオプションを使用できます。

| **オプション** | **説明** |
| --- | --- |
| **-?** | コマンド ウィンドウに\_Aspnet regbbrowsers.exe ヘルプ テキストを表示します。 |
| **-i** | ランタイム ブラウザー機能アセンブリを作成し、グローバル アセンブリ キャッシュにインストールします。 |
| **-u** | ランタイム ブラウザー機能アセンブリをグローバル アセンブリ キャッシュからアンインストールします。 |

## <a name="the-aspnet-compilation-tool---aspnet_compilerexe"></a>ASP.NET コンパイル ツール -\_aspnet コンパイラ.exe

ASP.NET コンパイル ツールは、一般的な 2 つの方法で使用できます: インプレース コンパイルと、ターゲット出力ディレクトリが指定されている配置のコンパイル。

### <a name="compiling-an-application-in-place"></a>[アプリケーションをインプレースでコンパイルする](https://msdn.microsoft.com/library/ms229863.aspx)

ASP.NET コンパイル ツールは、アプリケーションを所定の位置にコンパイルできます。 プリコンパイルされたサイトのユーザーは、最初の要求でページをコンパイルすることによって発生する遅延は発生しません。

サイトをプリコンパイルする場合、次の項目が適用されます。

- サイトは、そのファイルとディレクトリ構造を保持します。
- サーバー上のサイトで使用されるすべてのプログラミング言語のコンパイラが必要です。
- ファイルのコンパイルに失敗した場合、サイト全体のコンパイルが失敗します。

新しいソース ファイルを追加した後で、アプリケーションを再コンパイルすることもできます。 **c**オプションを指定しない限り、このツールは新規または変更されたファイルのみをコンパイルします。

> [!NOTE]
> 入れ子になったアプリケーションを含むアプリケーションのコンパイルでは、入れ子になったアプリケーションはコンパイルされません。 入れ子になったアプリケーションは、個別にコンパイルする必要があります。

### <a name="compiling-an-application-for-deployment"></a>[配置用のアプリケーションのコンパイル](https://msdn.microsoft.com/library/ms229863.aspx)

targetDir パラメーターを指定して、アプリケーションを配置 (ターゲットの場所にコンパイル) 用にコンパイルします。 targetDir は、Web アプリケーションの最終的な場所にすることも、コンパイルされたアプリケーションをさらにデプロイすることもできます。 **u**オプションを使用すると、アプリケーションをコンパイルして、コンパイル済みアプリケーション内の特定のファイルを再コンパイルせずに変更できます。 Aspnet\_compiler.exe は、静的ファイルと動的ファイルの種類を区別し、結果として生成されるアプリケーションを作成するときに、それらを異なる方法で処理します。

- 静的ファイルの種類は、.css、.gif、.htm、.html、.jpg、.js などの拡張子を持つファイルなど、コンパイラやビルド プロバイダが関連付けられていないファイルです。 これらのファイルは、単純にターゲットの場所にコピーされ、ディレクトリ構造内の相対位置は保持されます。
- 動的ファイルの種類は、.asax、.ascx、.ashx、.aspx、.browser、.master などのASP.NET固有のファイル名拡張子を持つファイルを含む、関連付けられたコンパイラまたはビルド プロバイダーを持つものです。 ASP.NET コンパイル ツールは、これらのファイルからアセンブリを生成します。 **u**オプションを省略すると、ファイル名拡張子を持つファイルも作成されます。元のソース ファイルをアセンブリにマップする COMPILED。 アプリケーション ソースのディレクトリ構造が保持されるように、ツールはターゲット アプリケーションの対応する場所にプレースホルダー ファイルを生成します。

コンパイル済みアプリケーションの内容を変更できることを示すには **、-u**オプションを使用する必要があります。 それ以外の場合、それ以降の変更は無視されるか、実行時エラーが発生します。

次の表は **、-u**オプションが含まれている場合に、ASP.NET コンパイル ツールがさまざまなファイルの種類を処理する方法を示しています。

| **ファイルの種類** | **コンパイラアクション** |
| --- | --- |
| .ascx、.aspx、.master | これらのファイルはマークアップとソース コードに分割され、分離コード ファイルとスクリプト runat="server"&lt;&gt;要素で囲まれたコードの両方が含まれます。 ソース コードは、ハッシュ アルゴリズムから派生した名前を持つアセンブリにコンパイルされ、アセンブリは Bin ディレクトリに配置されます。 インライン コード、つまり、角**&lt;** かっこと**%** かっこの間に囲まれたコードは、マークアップに含まれ、コンパイルされません。 ソース ファイルと同じ名前の新しいファイルが作成され、マークアップが含まれ、対応する出力ディレクトリに配置されます。 |
| .アシュ、.asmx | これらのファイルはコンパイルされず、出力ディレクトリにこの形式で移動され、コンパイルされません。 ハンドラー コードをコンパイルする場合は、App\_Code ディレクトリのソース コード ファイルにコードを配置します。 |
| .cs、.vb、.jsl、.cpp (上記のファイルの種類の分離コード ファイルは含まれません) | これらのファイルはコンパイルされ、それらを参照するアセンブリにリソースとして含まれます。 ソース ファイルは出力ディレクトリにコピーされません。 コード ファイルが参照されていない場合、コンパイルされません。 |
| カスタム ファイルの種類 | これらのファイルはコンパイルされません。 これらのファイルは、対応する出力ディレクトリにコピーされます。 |
| App\_Code サブディレクトリ内のソース コード ファイル | これらのファイルはアセンブリにコンパイルされ、Bin ディレクトリに配置されます。 |
| アプリ\_グローバルリソースサブディレクトリ内の .resx ファイルと .resource ファイル | これらのファイルはアセンブリにコンパイルされ、Bin ディレクトリに配置されます。 メイン出力\_ディレクトリの下にアプリケーション GlobalResources サブディレクトリが作成されず、ソース ディレクトリに配置された .resx ファイルまたは .resources ファイルは出力ディレクトリにコピーされません。 |
| アプリ\_ローカルリソースサブディレクトリ内の .resx ファイルと .resource ファイル | これらのファイルはコンパイルされず、対応する出力ディレクトリにコピーされます。 |
| アプリケーション\_テーマサブディレクトリ内の .skin ファイル | .skin ファイルと静的テーマ ファイルはコンパイルされず、対応する出力ディレクトリにコピーされます。 |
| .browser Web.config 静的ファイルの種類 アセンブリは既に Bin ディレクトリに存在します | これらのファイルは、出力ディレクトリにコピーされます。 |

次の表は **、-u**オプションを省略すると、ASP.NETコンパイル ツールがさまざまなファイルの種類を処理する方法を示しています。

| **ファイルの種類** | **コンパイラアクション** |
| --- | --- |
| .aspx, .asmx, .ashx, .master | これらのファイルはマークアップとソース コードに分割され、分離コード ファイルとスクリプト runat="server"&lt;&gt;要素で囲まれたコードの両方が含まれます。 ソース コードは、ハッシュ アルゴリズムから派生した名前を使用してアセンブリにコンパイルされます。 結果のアセンブリは Bin ディレクトリに配置されます。 インライン コード、つまり、角**&lt;** かっこと**%** かっこの間に囲まれたコードは、マークアップに含まれ、コンパイルされません。 コンパイラは、ソース ファイルと同じ名前のマークアップを含む新しいファイルを作成します。 これらの結果のファイルは Bin ディレクトリに配置されます。 コンパイラは、ソース ファイルと同じ名前のファイルを作成しますが、拡張子は .マッピング情報を含む COMPILED。 .COMPILED ファイルは、ソース ファイルの元の場所に対応する出力ディレクトリに配置されます。 |
| .ascx | これらのファイルは、マークアップとソース コードに分割されます。 ソース コードはアセンブリにコンパイルされ、Bin ディレクトリに格納され、ハッシュ アルゴリズムから派生した名前が付きます。 マークアップ ファイルは生成されません。 |
| .cs、.vb、.jsl、.cpp (上記のファイルの種類の分離コード ファイルは含まれません) | .ascx、.ashx、または .aspx ファイルから生成されたアセンブリによって参照されるソース コードは、アセンブリにコンパイルされ、Bin ディレクトリに配置されます。 ソース ファイルはコピーされません。 |
| カスタム ファイルの種類 | これらのファイルは動的ファイルのようにコンパイルされます。 基となるファイルの種類に応じて、コンパイラは出力ディレクトリにマッピング ファイルを配置できます。 |
| アプリケーション\_コード サブディレクトリ内のファイル | このサブディレクトリのソース コード ファイルは、アセンブリにコンパイルされ、Bin ディレクトリに配置されます。 |
| アプリケーション\_グローバルリソースサブディレクトリ内のファイル | これらのファイルはアセンブリにコンパイルされ、Bin ディレクトリに配置されます。 メイン出力\_ディレクトリの下に、アプリケーショングローバルリソースサブディレクトリは作成されません。 構成ファイルが、 に指定されている場合は、.resx ファイルと .resources ファイルが出力ディレクトリにコピーされます。 これらのファイルは[、ビルド プロバイダ](https://msdn.microsoft.com/library/system.web.configuration.buildprovider.aspx)によって参照されている場合はコピーされません。 |
| アプリ\_ローカルリソースサブディレクトリ内の .resx ファイルと .resource ファイル | これらのファイルは、一意の名前を持つアセンブリにコンパイルされ、Bin ディレクトリに配置されます。 出力ディレクトリに .resx ファイルまたは .resource ファイルはコピーされません。 |
| アプリケーション\_テーマサブディレクトリ内の .skin ファイル | テーマはアセンブリにコンパイルされ、Bin ディレクトリに配置されます。 スタブ ファイルは .skin ファイル用に作成され、対応する出力ディレクトリに配置されます。 静的ファイル (.css など) が出力ディレクトリにコピーされます。 |
| .browser Web.config 静的ファイルの種類 アセンブリは既に Bin ディレクトリに存在します | これらのファイルは、出力ディレクトリにコピーされます。 |

### <a name="fixed-assembly-names"></a>[固定アセンブリ名](https://msdn.microsoft.com/library/ms229863.aspx##)

MSI Windows インストーラを使用した Web アプリケーションの展開など、一部のシナリオでは、一貫性のあるファイル名と内容を使用する必要があり、アセンブリや更新の構成設定を識別するために一貫したディレクトリ構造を使用する必要があります。 このような場合は、複数のページをアセンブリにコンパイルする代わりに、ASP.NET コンパイル ツールで各ソース ファイルのアセンブリをコンパイルするように指定するには **、-fixednames**オプションを使用できます。 これにより多数のアセンブリが作成される可能性があるため、スケーラビリティに関心がある場合は、このオプションを慎重に使用する必要があります。

### <a name="strong-name-compilation"></a>[厳密な名前のコンパイル](https://msdn.microsoft.com/library/ms229863.aspx##)

**Aptca** **、-delaysign、-keycontainer、** および **-keycontainer** **-keyfile**オプションが用意されており、Aspnet\_compiler.exe を使用して厳密な[名前](https://msdn.microsoft.com/library/k5b5tt23.aspx)のアセンブリを作成できます。 これらのオプションは、それぞれ一致して **、部分的に信頼された呼び出し元属性**、**アセンブリディレイサイン属性**、**アセンブリ キー名属性**、および**アセンブリ キー ファイル属性**に対応します。

これらの属性の説明は、このコースの範囲外です。

## <a name="labs"></a>ラボ

次の各実習は、前の実習に基づいています。 あなたは順番にそれらを行う必要があります。

## <a name="lab-1-using-the-configuration-api"></a>ラボ 1: 構成 API の使用

1. *mod9lab*という新しい Web サイトを作成します。
2. 新しい Web 構成ファイルをサイトに追加します。
3. web.config ファイルに次の項目を追加します。

[!code-xml[Main](configuration-and-instrumentation/samples/sample14.xml)]

これにより、web.config ファイルに対する変更を保存する権限が与えられます。

1. 新しいラベル コントロールを Default.aspx に追加し、ID を**lblDebugStatus**に変更します。
2. 新しいボタン コントロールを Default.aspx に追加します。
3. ボタン コントロールの ID を**btnToggleDebug**に変更し、テキストを **[デバッグ 状態の切り替え]** に変更します。
4. Default.aspx の分離コード ファイルのコード ビューを開き **、System.Web.Configuration**の**using**ステートメントを次のように追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample15.cs)]

1. 次に示すように、クラスに 2\_つのプライベート変数と Page Init メソッドを追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample16.cs)]

1. 次のコードをページ読\_み込みに追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample17.cs)]

1. 保存して、default.aspx を参照します。 Label コントロールに現在のデバッグステータスが表示されます。
2. デザイナーで Button コントロールをダブルクリックし、Button コントロールの Click イベントに次のコードを追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample18.cs)]

1. 保存して default.aspx を参照し、ボタンをクリックします。
2. 各ボタンをクリックした後に web.config ファイル**debug**を開き、&lt;コンパイル&gt;セクションでデバッグ属性を確認します。

## <a name="lab-2-logging-application-restarts"></a>演習 2: アプリケーションの再起動のログ記録

この演習では、イベント ビューアでアプリケーションのシャットダウン、起動、および再コンパイルのログ出力を切り替えられるコードを作成します。

1. ドロップダウン リストを default.aspx に追加し、ID を ddlLogAppEvents に変更します。
2. ドロップダウン リストの **[オートポストバック**] プロパティを**true**に設定します。
3. ドロップダウン リストの Items コレクションに 3 つの項目を追加します。 最初の項目の**テキスト**を *[値を選択]* と値-1にします。 2 番目の項目の**テキスト**と**値**を**True**にし、3 番目の項目の**テキスト**と**値**を**False**にします。
4. 新しいラベルを default.aspx に追加します。 ID を**lblLogAppEvents**に変更します。
5. default.aspx の分離コード ビューを開き、次に示すように、HealthMonitoringSection 型の変数に対する新しい宣言を追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample19.cs)]

1. ページ\_Init の既存のコードに次のコードを追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample20.cs)]

1. ドロップダウン リストをダブルクリックし、次のコードを SelectedIndexChanged イベントに追加します。

[!code-csharp[Main](configuration-and-instrumentation/samples/sample21.cs)]

1. 既定の.aspx を参照します。
2. ドロップダウンを **[False]** に設定します。
3. イベント ビューアでアプリケーション ログをクリアします。
4. ボタンをクリックして、アプリケーションの Debug 属性を変更します。
5. イベント ビューアでアプリケーション ログを更新します。 

    1. イベントは記録されましたか?
    2. なぜですか、なぜですか?
6. ドロップダウンを True に設定**します。**
7. ボタンをクリックして、アプリケーションの Debug 属性を切り替えます。
8. イベント ビューアのアプリケーション ログインを更新します。 

    1. イベントは記録されましたか?
    2. アプリのシャットダウンの理由は何でしたか?
9. ログ記録のオンとオフを試し、web.config ファイルに加えられた変更を確認します。

## <a name="more-information"></a>詳細情報:

ASP.NET 2.0 の Provider モデルでは、アプリケーションインストルメンテーションだけでなく、メンバーシップ、プロファイルなどの他の多くの用途に対して独自のプロバイダを作成できます。アプリケーション イベントをテキスト ファイルに記録するカスタム プロバイダの記述の詳細については、[こちらのリンク](https://msdn.microsoft.com/library/default.asp?url=/library/dnaspp/html/ASPNETProvMod_Prt6.asp)を参照してください。
