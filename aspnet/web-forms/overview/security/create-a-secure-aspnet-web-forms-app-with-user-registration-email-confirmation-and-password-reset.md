---
uid: web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
title: ユーザー登録、電子メール確認、パスワードリセット (C#) を使用して、Secure ASP.NET Web フォームアプリを作成します。Microsoft Docs
author: Erikre
description: このチュートリアルでは、ASP.NET Identity メンバーを使用して、ユーザー登録、電子メール確認、パスワードリセットを使用して ASP.NET Web フォームアプリを構築する方法について説明します。
ms.author: riande
ms.date: 10/02/2014
ms.assetid: 0a8d6044-5fab-4213-82d6-5618d5601358
msc.legacyurl: /web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
msc.type: authoredcontent
ms.openlocfilehash: af3653bc164810126bc3bf8f1b1794d75642d807
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78507130"
---
# <a name="create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset-c"></a><span data-ttu-id="24933-103">ユーザー登録、電子メール確認、パスワード リセットを利用し、安全な ASP.NET Web フォームを作成する (C#)</span><span class="sxs-lookup"><span data-stu-id="24933-103">Create a secure ASP.NET Web Forms app with user registration, email confirmation and password reset (C#)</span></span>

<span data-ttu-id="24933-104">[Erik Reitan](https://github.com/Erikre)</span><span class="sxs-lookup"><span data-stu-id="24933-104">by [Erik Reitan](https://github.com/Erikre)</span></span>

> <span data-ttu-id="24933-105">このチュートリアルでは、ASP.NET Identity メンバーシップシステムを使用して、ユーザー登録、電子メール確認、パスワードリセットを使用して ASP.NET Web フォームアプリを構築する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="24933-105">This tutorial shows you how to build an ASP.NET Web Forms app with user registration, email confirmation and password reset using the ASP.NET Identity membership system.</span></span> <span data-ttu-id="24933-106">このチュートリアルは、Rick Anderson の[MVC チュートリアル](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)に基づいています。</span><span class="sxs-lookup"><span data-stu-id="24933-106">This tutorial was based on Rick Anderson's [MVC tutorial](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span>

## <a name="introduction"></a><span data-ttu-id="24933-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="24933-107">Introduction</span></span>

<span data-ttu-id="24933-108">このチュートリアルでは、Visual Studio と ASP.NET 4.5 を使用して ASP.NET Web フォームアプリケーションを作成し、ユーザー登録、電子メール確認、パスワードリセットを使用してセキュリティで保護された Web フォームアプリを作成するために必要な手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="24933-108">This tutorial guides you through the steps required to create an ASP.NET Web Forms application using Visual Studio and ASP.NET 4.5 to create a secure Web Forms app with user registration, email confirmation and password reset.</span></span>

### <a name="tutorial-tasks-and-information"></a><span data-ttu-id="24933-109">チュートリアルのタスクと情報:</span><span class="sxs-lookup"><span data-stu-id="24933-109">Tutorial Tasks and Information:</span></span>

- [<span data-ttu-id="24933-110">ASP.NET Web フォームアプリを作成する</span><span class="sxs-lookup"><span data-stu-id="24933-110">Create an ASP.NET Web Forms app</span></span>](#createWebForms)
- [<span data-ttu-id="24933-111">SendGrid をフックする</span><span class="sxs-lookup"><span data-stu-id="24933-111">Hook Up SendGrid</span></span>](#SG)
- [<span data-ttu-id="24933-112">ログインする前に電子メールの確認を要求する</span><span class="sxs-lookup"><span data-stu-id="24933-112">Require Email Confirmation Before Log In</span></span>](#require)
- [<span data-ttu-id="24933-113">パスワードの回復とリセット</span><span class="sxs-lookup"><span data-stu-id="24933-113">Password Recovery and Reset</span></span>](#reset)
- [<span data-ttu-id="24933-114">電子メールの再送信の確認リンク</span><span class="sxs-lookup"><span data-stu-id="24933-114">Resend Email Confirmation Link</span></span>](#rsend)
- [<span data-ttu-id="24933-115">アプリのトラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="24933-115">Troubleshooting the App</span></span>](#dbg)
- [<span data-ttu-id="24933-116">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="24933-116">Additional Resources</span></span>](#addRes)

<a id="createWebForms"></a>
## <a name="create-an-aspnet-web-forms-app"></a><span data-ttu-id="24933-117">ASP.NET Web フォームアプリを作成する</span><span class="sxs-lookup"><span data-stu-id="24933-117">Create an ASP.NET Web Forms App</span></span>

<span data-ttu-id="24933-118">まず、Web または[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)[用の Visual Studio Express 2013 を](https://go.microsoft.com/fwlink/?LinkId=299058)インストールして実行します。</span><span class="sxs-lookup"><span data-stu-id="24933-118">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="24933-119">[Visual Studio 2013 Update 3](https://go.microsoft.com/fwlink/?LinkId=390465)以降もインストールします。</span><span class="sxs-lookup"><span data-stu-id="24933-119">Install [Visual Studio 2013 Update 3](https://go.microsoft.com/fwlink/?LinkId=390465) or higher as well.</span></span>

> [!NOTE]
> <span data-ttu-id="24933-120">警告: このチュートリアルを完了するには、 [Visual Studio 2013 Update 3](https://go.microsoft.com/fwlink/?LinkId=390465)以降をインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="24933-120">Warning: You must install [Visual Studio 2013 Update 3](https://go.microsoft.com/fwlink/?LinkId=390465) or higher to complete this tutorial.</span></span>

1. <span data-ttu-id="24933-121">新しいプロジェクト (**ファイル** -&gt;**新しいプロジェクト**) を作成し、 **[新しいプロジェクト]** ダイアログボックスで**ASP.NET Web アプリケーション**テンプレートと最新の .NET Framework バージョンを選択します。</span><span class="sxs-lookup"><span data-stu-id="24933-121">Create a new project (**File** -&gt; **New Project**) and select the **ASP.NET Web Application** template and the latest .NET Framework version from the **New Project** dialog box.</span></span>
2. <span data-ttu-id="24933-122">**[New ASP.NET プロジェクト]** ダイアログボックスで、 **[Web フォーム]** テンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="24933-122">From the **New ASP.NET Project** dialog box, select the **Web Forms** template.</span></span> <span data-ttu-id="24933-123">既定の認証は、**個々のユーザーアカウント**として残しておきます。</span><span class="sxs-lookup"><span data-stu-id="24933-123">Leave the default authentication as **Individual User Accounts**.</span></span> <span data-ttu-id="24933-124">Azure でアプリをホストする場合は、[**クラウドにホスト**する] チェックボックスをオンのままにします。</span><span class="sxs-lookup"><span data-stu-id="24933-124">If you'd like to host the app in Azure, leave the **Host in the cloud** check box checked.</span></span>   
 <span data-ttu-id="24933-125">次に、[ **OK]** をクリックして、新しいプロジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="24933-125">Then, click **OK** to create the new project.</span></span>  
    <span data-ttu-id="24933-126">![[新しい ASP.NET プロジェクト] ダイアログ ボックス](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="24933-126">![New ASP.NET Project dialog box](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image1.png)</span></span>
3. <span data-ttu-id="24933-127">プロジェクトの Secure Sockets Layer (SSL) を有効にします。</span><span class="sxs-lookup"><span data-stu-id="24933-127">Enable Secure Sockets Layer (SSL) for the project.</span></span> <span data-ttu-id="24933-128">「 [Web フォームチュートリアルシリーズを使用したはじめに](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms)」の「**プロジェクトに対して SSL を有効にする**」セクションで説明されている手順に従います。</span><span class="sxs-lookup"><span data-stu-id="24933-128">Follow the steps available in the **Enable SSL for the Project** section of the [Getting Started with Web Forms tutorial series](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms).</span></span>
4. <span data-ttu-id="24933-129">アプリを実行し、 **[登録]** リンクをクリックして、新しいユーザーを登録します。</span><span class="sxs-lookup"><span data-stu-id="24933-129">Run the app, click the **Register** link and register a new user.</span></span> <span data-ttu-id="24933-130">この時点で、電子メールの検証は、電子メールアドレスが整形式であることを確認するために、 [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性に基づいています。</span><span class="sxs-lookup"><span data-stu-id="24933-130">At this point, the only validation on the email is based on the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute to ensure the email address is well-formed.</span></span> <span data-ttu-id="24933-131">電子メールの確認を追加するようにコードを変更します。</span><span class="sxs-lookup"><span data-stu-id="24933-131">You will modify the code to add email confirmation.</span></span> <span data-ttu-id="24933-132">ブラウザー ウィンドウを閉じます。</span><span class="sxs-lookup"><span data-stu-id="24933-132">Close the browser window.</span></span>
5. <span data-ttu-id="24933-133">Visual Studio の**サーバーエクスプローラー** ( -&gt;**サーバーエクスプローラー**の**表示**) で、 **Data Connections\DefaultConnection\Tables\AspNetUsers**に移動し、右クリックして、 **[テーブル定義を開く]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="24933-133">In **Server Explorer** of Visual Studio (**View** -&gt; **Server Explorer**), navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span> 

    <span data-ttu-id="24933-134">次の図は、`AspNetUsers` テーブルスキーマを示しています。</span><span class="sxs-lookup"><span data-stu-id="24933-134">The following image shows the `AspNetUsers` table schema:</span></span>

    ![AspNetUsers テーブルスキーマ](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image2.png)
6. <span data-ttu-id="24933-136">**サーバーエクスプローラー**で、 **AspNetUsers**テーブルを右クリックし、 **[テーブルデータの表示]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="24933-136">In **Server Explorer**, right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![AspNetUsers テーブルデータ](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image3.png)  
 <span data-ttu-id="24933-138">この時点で、登録済みユーザーの電子メールは確認されていません。</span><span class="sxs-lookup"><span data-stu-id="24933-138">At this point the email for the registered user has not been confirmed.</span></span>
7. <span data-ttu-id="24933-139">行をクリックし、[削除] を選択してユーザーを削除します。</span><span class="sxs-lookup"><span data-stu-id="24933-139">Click on the row and select delete to delete the user.</span></span> <span data-ttu-id="24933-140">次の手順でもう一度このメールを追加し、電子メールアドレスに確認メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="24933-140">You'll add this email again in the next step and send a confirmation message to the email address.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="24933-141">電子メールの確認</span><span class="sxs-lookup"><span data-stu-id="24933-141">Email Confirmation</span></span>

<span data-ttu-id="24933-142">新しいユーザーの登録時に電子メールを確認して、他のユーザーが偽装していないこと (つまり、他のユーザーの電子メールに登録されていないこと) を確認することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="24933-142">It's a best practice to confirm the email during the registration of a new user to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="24933-143">ディスカッションフォーラムがあるとしたら、`"bob@cpandl.com"` が `"joe@contoso.com"`として登録されないようにしたいと考えています。</span><span class="sxs-lookup"><span data-stu-id="24933-143">Suppose you had a discussion forum, you would want to prevent `"bob@cpandl.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="24933-144">電子メールを確認しないと、`"joe@contoso.com"` アプリから不要な電子メールを受け取る可能性があります。</span><span class="sxs-lookup"><span data-stu-id="24933-144">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="24933-145">Bob が誤って `"bib@cpandl.com"` として登録されていて気付かないとしても、アプリには正しい電子メールがないため、パスワードの回復を使用することはできません。</span><span class="sxs-lookup"><span data-stu-id="24933-145">Suppose Bob accidentally registered as `"bib@cpandl.com"` and hadn't noticed it, he wouldn't be able to use password recovery because the app doesn't have his correct email.</span></span> <span data-ttu-id="24933-146">電子メールの確認では、bot からの保護のみが制限されており、特定のスパム送信者からの保護は提供されません。</span><span class="sxs-lookup"><span data-stu-id="24933-146">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers.</span></span>

<span data-ttu-id="24933-147">通常は、電子メール、SMS テキストメッセージ、または別のメカニズムによって確認される前に、新しいユーザーが web サイトにデータを投稿できないようにします。</span><span class="sxs-lookup"><span data-stu-id="24933-147">You generally want to prevent new users from posting any data to your website before they have been confirmed by either email, an SMS text message or another mechanism.</span></span> <span data-ttu-id="24933-148">以下のセクションでは、電子メールの確認を有効にし、コードを変更して、新しく登録されたユーザーが電子メールを確認するまでログインできないようにします。</span><span class="sxs-lookup"><span data-stu-id="24933-148">In the sections below, we will enable email confirmation and modify the code to prevent newly registered users from logging in until their email has been confirmed.</span></span> <span data-ttu-id="24933-149">このチュートリアルでは、電子メールサービス SendGrid を使用します。</span><span class="sxs-lookup"><span data-stu-id="24933-149">You'll use the email service SendGrid in this tutorial.</span></span>

<a id="SG"></a>
## <a name="hook-up-sendgrid"></a><span data-ttu-id="24933-150">SendGrid をフックする</span><span class="sxs-lookup"><span data-stu-id="24933-150">Hook up SendGrid</span></span>

<span data-ttu-id="24933-151">このチュートリアルが記述されているため、SendGrid によって API が変更されました。</span><span class="sxs-lookup"><span data-stu-id="24933-151">SendGrid has changed it's API since this tutorial was written.</span></span> <span data-ttu-id="24933-152">現在の SendGrid の手順については、「 [sendgrid](http://sendgrid.com/) 」または「[アカウント確認とパスワードの回復を有効にする](xref:security/authentication/accconfirm#enable-account-confirmation-and-password-recovery)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="24933-152">For current SendGrid instructions, see [SendGrid](http://sendgrid.com/) or [Enable account confirmation and password recovery](xref:security/authentication/accconfirm#enable-account-confirmation-and-password-recovery).</span></span>

<span data-ttu-id="24933-153">このチュートリアルでは、 [Sendgrid](http://sendgrid.com/)を使用して電子メール通知を追加する方法のみを説明していますが、SMTP などのメカニズムを使用[して電子](#addRes)メールを送信することもできます。</span><span class="sxs-lookup"><span data-stu-id="24933-153">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms (see [additional resources](#addRes)).</span></span>

1. <span data-ttu-id="24933-154">Visual Studio で、**パッケージマネージャーコンソール**([**ツール** -&gt; **NuGet パッケージ**マネージャー] -&gt;**パッケージマネージャーコンソール**) を開き、次のコマンドを入力します。</span><span class="sxs-lookup"><span data-stu-id="24933-154">In Visual Studio, open the **Package Manager Console** (**Tools** -&gt; **NuGet Package Manger** -&gt; **Package Manager Console**), and enter the following command:</span></span>  
    `Install-Package SendGrid`
2. <span data-ttu-id="24933-155">[Azure SendGrid のサインアップページ](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)にアクセスし、無料の sendgrid アカウントを登録します。</span><span class="sxs-lookup"><span data-stu-id="24933-155">Go to the [Azure SendGrid sign-up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free SendGrid account.</span></span> <span data-ttu-id="24933-156">[Sendgrid のサイト](http://www.sendgrid.com)で、無料の sendgrid アカウントに直接サインアップすることもできます。</span><span class="sxs-lookup"><span data-stu-id="24933-156">You can also sign-up for a free SendGrid account directly on [SendGrid's site](http://www.sendgrid.com).</span></span>
3. <span data-ttu-id="24933-157">**ソリューションエクスプローラー**で、*アプリ\_スタート*フォルダーの*IdentityConfig.cs*ファイルを開き、黄色で強調表示されている次のコードを `EmailService` クラスに追加して、 **sendgrid**を構成します。</span><span class="sxs-lookup"><span data-stu-id="24933-157">From **Solution Explorer** open the *IdentityConfig.cs* file in the *App\_Start* folder and add the following code highlighted in yellow to the `EmailService` class to configure **SendGrid**:</span></span>

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample1.cs?highlight=3,5,8-37)]
4. <span data-ttu-id="24933-158">また、 *IdentityConfig.cs*ファイルの先頭に次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="24933-158">Also, add the following `using` statements to the beginning of the *IdentityConfig.cs* file:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample2.cs?highlight=1-4)]
5. <span data-ttu-id="24933-159">このサンプルを簡単に保つために、電子メールサービスアカウントの値を web.config ファイルの `appSettings` セクションに保存*します。*</span><span class="sxs-lookup"><span data-stu-id="24933-159">To keep this sample simple, you'll store the email service account values in the `appSettings` section of the *web.config* file.</span></span> <span data-ttu-id="24933-160">次の XML を、黄色で強調表示されているプロジェクトのルートにある*web.config ファイルに*追加します。</span><span class="sxs-lookup"><span data-stu-id="24933-160">Add the following XML highlighted in yellow to the *web.config* file at the root of your project:</span></span>

    [!code-xml[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample3.xml?highlight=2-5)]

    > [!WARNING]
    > <span data-ttu-id="24933-161">セキュリティ-機密データをソースコードに格納しません。</span><span class="sxs-lookup"><span data-stu-id="24933-161">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="24933-162">この例では、アカウントと資格情報は、 *web.config ファイルの* **appSetting**セクションに格納されています。</span><span class="sxs-lookup"><span data-stu-id="24933-162">In this example, the account and credentials are stored in the **appSetting** section of the *Web.config* file.</span></span> <span data-ttu-id="24933-163">Azure では、これらの値を Azure portal の [ **[構成](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** ] タブに安全に格納できます。</span><span class="sxs-lookup"><span data-stu-id="24933-163">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="24933-164">関連情報については、Rick Anderson のトピック「[パスワードやその他の機密データを ASP.NET と Azure にデプロイするためのベストプラクティス](https://go.microsoft.com/fwlink/?LinkId=513141)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="24933-164">For related information see Rick Anderson's topic titled [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](https://go.microsoft.com/fwlink/?LinkId=513141).</span></span>
6. <span data-ttu-id="24933-165">アプリから電子メールを正常に送信できるように、SendGrid 認証値 (ユーザー名とパスワード) を反映するために、電子メールサービスの値を追加します。</span><span class="sxs-lookup"><span data-stu-id="24933-165">Add the email service values to reflect your SendGrid authentication values (User Name and Password) so that you can successful send email from your app.</span></span> <span data-ttu-id="24933-166">Sendgrid を指定した電子メールアドレスではなく、SendGrid アカウント名を使用してください。</span><span class="sxs-lookup"><span data-stu-id="24933-166">Be sure to use your SendGrid account name rather than the email address you provided SendGrid.</span></span>

### <a name="enable-email-confirmation"></a><span data-ttu-id="24933-167">電子メールの確認を有効にする</span><span class="sxs-lookup"><span data-stu-id="24933-167">Enable Email Confirmation</span></span>

 <span data-ttu-id="24933-168">電子メールの確認を有効にするには、次の手順に従って登録コードを変更します。</span><span class="sxs-lookup"><span data-stu-id="24933-168">To enable email confirmation, you'll modify the registration code using the following steps.</span></span>  

1. <span data-ttu-id="24933-169">*Account*フォルダーで*Register.aspx.cs*分離コードを開き、次の強調表示された変更を有効にするために `CreateUser_Click` メソッドを更新します。</span><span class="sxs-lookup"><span data-stu-id="24933-169">In the *Account* folder, open the *Register.aspx.cs* code-behind and update the `CreateUser_Click` method to enable the following highlighted changes:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample4.cs?highlight=9-11)]
2. <span data-ttu-id="24933-170">**ソリューションエクスプローラー**で、 *default.aspx*を右クリックし、 **[スタートページとして設定]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="24933-170">In **Solution Explorer**, right-click *Default.aspx* and select **Set As Start Page**.</span></span>
3. <span data-ttu-id="24933-171">F5 キーを押してアプリを実行し**ます。**</span><span class="sxs-lookup"><span data-stu-id="24933-171">Run the app by pressing **F5.**</span></span> <span data-ttu-id="24933-172">ページが表示されたら、 **[登録]** リンクをクリックして登録ページを表示します。</span><span class="sxs-lookup"><span data-stu-id="24933-172">After the page is displayed, click the **Register** link to display the Register page.</span></span>
4. <span data-ttu-id="24933-173">電子メールとパスワードを入力し、 **[登録]** ボタンをクリックして、sendgrid 経由で電子メールメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="24933-173">Enter your email and password, then click the **Register** button to send an email message via SendGrid.</span></span>  
   <span data-ttu-id="24933-174">プロジェクトとコードの現在の状態により、ユーザーは、アカウントが確認されていなくても、登録フォームの完了後にログインできるようになります。</span><span class="sxs-lookup"><span data-stu-id="24933-174">The current state of your project and code will allow the user to log in once they complete the registration form, even though they haven't confirmed their account.</span></span>
5. <span data-ttu-id="24933-175">電子メールアカウントを確認し、リンクをクリックして電子メールを確認します。</span><span class="sxs-lookup"><span data-stu-id="24933-175">Check your email account and click on the link to confirm your email.</span></span>  
   <span data-ttu-id="24933-176">登録フォームを送信すると、ログインされます。</span><span class="sxs-lookup"><span data-stu-id="24933-176">Once you submit the registration form, you will be logged in.</span></span>  
    ![サンプル Web サイト-サインイン済み](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image4.png)

<a id="require"></a>
## <a name="require-email-confirmation-before-log-in"></a><span data-ttu-id="24933-178">ログインする前に電子メールの確認を要求する</span><span class="sxs-lookup"><span data-stu-id="24933-178">Require Email Confirmation Before Log In</span></span>

<span data-ttu-id="24933-179">電子メールアカウントを確認しましたが、この時点で、完全にサインインするには、確認の電子メールに含まれているリンクをクリックする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="24933-179">Although you have confirmed the email account, at this point you would not need to click on the link contained in the verification email to be fully signed-in.</span></span> <span data-ttu-id="24933-180">次のセクションでは、新しいユーザーがログイン (認証) される前に確認済みの電子メールを持っている必要のあるコードを変更します。</span><span class="sxs-lookup"><span data-stu-id="24933-180">In the following section, you will modify the code requiring new users to have a confirmed email before they are logged in (authenticated).</span></span>

1. <span data-ttu-id="24933-181">Visual Studio の**ソリューションエクスプローラー**で、次の強調表示された変更を使用して、 *Accounts*フォルダーに含まれている*Register.aspx.cs*分離コードの `CreateUser_Click` イベントを更新します。</span><span class="sxs-lookup"><span data-stu-id="24933-181">In **Solution Explorer** of Visual Studio, update the `CreateUser_Click` event in the *Register.aspx.cs* code-behind contained in the *Accounts* folder with the following highlighted changes:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample5.cs?highlight=13-14,17-21)]
2. <span data-ttu-id="24933-182">次の強調表示された変更を使用して、 *Login.aspx.cs*の分離コードの `LogIn` メソッドを更新します。</span><span class="sxs-lookup"><span data-stu-id="24933-182">Update the `LogIn` method in the *Login.aspx.cs* code-behind with the following highlighted changes:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample6.cs?highlight=9-19,45-46)]

### <a name="run-the-application"></a><span data-ttu-id="24933-183">アプリケーションの実行</span><span class="sxs-lookup"><span data-stu-id="24933-183">Run the Application</span></span>

 <span data-ttu-id="24933-184">これで、ユーザーの電子メールアドレスが確認されているかどうかを確認するコードを実装できました。次は、**登録**ページと**ログイン**ページの両方で機能を確認します。</span><span class="sxs-lookup"><span data-stu-id="24933-184">Now that you have implemented the code to check whether a user's email address has been confirmed, you can check the functionality on both the **Register** and **Login** pages.</span></span> 

1. <span data-ttu-id="24933-185">テストする電子メールエイリアスが含まれている**AspNetUsers**テーブル内のすべてのアカウントを削除します。</span><span class="sxs-lookup"><span data-stu-id="24933-185">Delete any accounts in the **AspNetUsers** table that contain the email alias you wish to test.</span></span>
2. <span data-ttu-id="24933-186">**F5 キー**を押してアプリを実行し、電子メールアドレスが確認されるまでユーザーとして登録できないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="24933-186">Run the app (**F5**) and verify you cannot register as a user until you have confirmed your email address.</span></span>
3. <span data-ttu-id="24933-187">送信した電子メールで新しいアカウントを確認する前に、新しいアカウントでログインします。</span><span class="sxs-lookup"><span data-stu-id="24933-187">Before confirming your new account via the email that was just sent, attempt to log in with the new account.</span></span>  
 <span data-ttu-id="24933-188">ログインできないことと、確認済みの電子メールアカウントが必要であることがわかります。</span><span class="sxs-lookup"><span data-stu-id="24933-188">You'll see that you are unable to log in and that you must have a confirmed email account.</span></span>
4. <span data-ttu-id="24933-189">電子メールアドレスを確認したら、アプリにログインします。</span><span class="sxs-lookup"><span data-stu-id="24933-189">Once you confirm your email address, log in to the app.</span></span>

<a id="reset"></a>
## <a name="password-recovery-and-reset"></a><span data-ttu-id="24933-190">パスワードの回復とリセット</span><span class="sxs-lookup"><span data-stu-id="24933-190">Password Recovery and Reset</span></span>

1. <span data-ttu-id="24933-191">Visual Studio で、 *Account*フォルダーに格納されている*Forgot.aspx.cs*の分離コードの `Forgot` メソッドからコメント文字を削除して、メソッドが次のように表示されるようにします。</span><span class="sxs-lookup"><span data-stu-id="24933-191">In Visual Studio, remove the comment characters from the `Forgot` method in the *Forgot.aspx.cs* code-behind contained in the *Account* folder, so that the method appears as follows:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample7.cs?highlight=16-18)]
2. <span data-ttu-id="24933-192">*Login.aspx*ページを開きます。</span><span class="sxs-lookup"><span data-stu-id="24933-192">Open the *Login.aspx* page.</span></span> <span data-ttu-id="24933-193">次に強調表示されているように、 **Loginform**セクションの末尾付近にあるマークアップを置き換えます。</span><span class="sxs-lookup"><span data-stu-id="24933-193">Replace the markup near the end of the **loginForm** section as highlighted below:</span></span> 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample8.aspx?highlight=52-53)]
3. <span data-ttu-id="24933-194">*Login.aspx.cs*の分離コードを開き、`Page_Load` イベントハンドラーから黄色で強調表示されている次のコード行をコメント解除します。</span><span class="sxs-lookup"><span data-stu-id="24933-194">Open the *Login.aspx.cs* code-behind and uncomment the following line of code highlighted in yellow from the `Page_Load` event handler:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample9.cs?highlight=5)]
4. <span data-ttu-id="24933-195">F5 キーを押してアプリを実行し**ます。**</span><span class="sxs-lookup"><span data-stu-id="24933-195">Run the app by pressing **F5.**</span></span> <span data-ttu-id="24933-196">ページが表示されたら、 **[ログイン]** リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="24933-196">After the page is displayed, click the **Log in** link.</span></span>
5. <span data-ttu-id="24933-197">[**パスワードを忘れ**た場合] リンクをクリックして、[パスワードを**忘れ**た場合] ページを表示します。</span><span class="sxs-lookup"><span data-stu-id="24933-197">Click the **Forgot your password?** link to display the **Forgot Password** page.</span></span>
6. <span data-ttu-id="24933-198">メールアドレスを入力し、 **[Submit]** \ (送信 \) ボタンをクリックして、自分のアドレスに電子メールを送信します。これにより、パスワードをリセットできます。</span><span class="sxs-lookup"><span data-stu-id="24933-198">Enter your email address and click the **Submit** button to send an email to your address which will allow you to reset your password.</span></span>   
   <span data-ttu-id="24933-199">電子メールアカウントを確認し、リンクをクリックして **[パスワードのリセット]** ページを表示します。</span><span class="sxs-lookup"><span data-stu-id="24933-199">Check your email account and click on the link to display the **Reset Password** page.</span></span>
7. <span data-ttu-id="24933-200">**[パスワードのリセット]** ページで、電子メール、パスワード、確認用のパスワードを入力します。</span><span class="sxs-lookup"><span data-stu-id="24933-200">On the **Reset Password** page, enter your email, password, and confirmed password.</span></span> <span data-ttu-id="24933-201">次に、 **[リセット]** ボタンを押します。</span><span class="sxs-lookup"><span data-stu-id="24933-201">Then, press the **Reset** button.</span></span>  
   <span data-ttu-id="24933-202">パスワードが正常にリセットされると、 **[パスワードの変更]** ページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="24933-202">When you successfully reset your password, the **Password Changed** page will be displayed.</span></span> <span data-ttu-id="24933-203">これで、新しいパスワードでログインできるようになりました。</span><span class="sxs-lookup"><span data-stu-id="24933-203">Now you can log in with your new password.</span></span>

<a id="rsend"></a>
## <a name="resend-email-confirmation-link"></a><span data-ttu-id="24933-204">電子メールの再送信の確認リンク</span><span class="sxs-lookup"><span data-stu-id="24933-204">Resend Email Confirmation Link</span></span>

<span data-ttu-id="24933-205">ユーザーは、新しいローカルアカウントを作成すると、ログオンする前に使用する必要がある確認のリンクを電子メールで送信します。</span><span class="sxs-lookup"><span data-stu-id="24933-205">Once a user creates a new local account, they are emailed a confirmation link they are required to use before they can log on.</span></span> <span data-ttu-id="24933-206">ユーザーが誤って確認メールを削除した場合、または電子メールが届いていない場合は、確認リンクを再度送信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="24933-206">If the user accidentally deletes the confirmation email, or the email never arrives, they will need the confirmation link sent again.</span></span> <span data-ttu-id="24933-207">次のコード変更は、これを有効にする方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="24933-207">The following code changes show how to enable this.</span></span>

1. <span data-ttu-id="24933-208">Visual Studio で、 **Login.aspx.cs**分離コードを開き、`LogIn` イベントハンドラーの後に次のイベントハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="24933-208">In Visual Studio, open the **Login.aspx.cs** code-behind and add the following event handler after the `LogIn` event handler:</span></span>   

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample10.cs)]
2. <span data-ttu-id="24933-209">次のように、黄色で強調表示されているコードを変更して、 *Login.aspx.cs*の分離コードで `LogIn` イベントハンドラーを変更します。</span><span class="sxs-lookup"><span data-stu-id="24933-209">Modify the `LogIn` event handler in the *Login.aspx.cs* code-behind by changing the code highlighted in yellow as follows:</span></span> 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample11.cs?highlight=15-17)]
3. <span data-ttu-id="24933-210">次のように、黄色で強調表示されているコードを追加して、 *login.aspx*ページを更新します。</span><span class="sxs-lookup"><span data-stu-id="24933-210">Update the *Login.aspx* page by adding the code highlighted in yellow as follows:</span></span> 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample12.aspx?highlight=45-46)]
4. <span data-ttu-id="24933-211">テストする電子メールエイリアスが含まれている**AspNetUsers**テーブル内のすべてのアカウントを削除します。</span><span class="sxs-lookup"><span data-stu-id="24933-211">Delete any accounts in the **AspNetUsers** table that contain the email alias you wish to test.</span></span>
5. <span data-ttu-id="24933-212">**F5 キー**を押してアプリを実行し、電子メールアドレスを登録します。</span><span class="sxs-lookup"><span data-stu-id="24933-212">Run the app (**F5**) and register your email address.</span></span>
6. <span data-ttu-id="24933-213">送信した電子メールで新しいアカウントを確認する前に、新しいアカウントでログインします。</span><span class="sxs-lookup"><span data-stu-id="24933-213">Before confirming your new account via the email that was just sent, attempt to log in with the new account.</span></span>  
   <span data-ttu-id="24933-214">ログインできないことと、確認済みの電子メールアカウントが必要であることがわかります。</span><span class="sxs-lookup"><span data-stu-id="24933-214">You'll see that you are unable to log in and that you must have a confirmed email account.</span></span> <span data-ttu-id="24933-215">さらに、確認メッセージを電子メールアカウントに再送信できるようになりました。</span><span class="sxs-lookup"><span data-stu-id="24933-215">In addition, you can now resend a confirmation message to your email account.</span></span>
7. <span data-ttu-id="24933-216">電子メールアドレスとパスワードを入力し、[**再送信] 確認**ボタンを押します。</span><span class="sxs-lookup"><span data-stu-id="24933-216">Enter your email address and password, then press the **Resend confirmation** button.</span></span>
8. <span data-ttu-id="24933-217">新しく送信された電子メールメッセージに基づいて電子メールアドレスを確認したら、アプリにログインします。</span><span class="sxs-lookup"><span data-stu-id="24933-217">Once you confirm your email address based on the newly sent email message, log in to the app.</span></span>

<a id="dbg"></a>
## <a name="troubleshooting-the-app"></a><span data-ttu-id="24933-218">アプリのトラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="24933-218">Troubleshooting the App</span></span>

<span data-ttu-id="24933-219">資格情報を確認するためのリンクが記載された電子メールが届かない場合は、次のようにします。</span><span class="sxs-lookup"><span data-stu-id="24933-219">If you don't receive an email containing the link to verify your credentials:</span></span>

- <span data-ttu-id="24933-220">迷惑メールまたは迷惑メールフォルダーを確認します。</span><span class="sxs-lookup"><span data-stu-id="24933-220">Check your junk or spam folder.</span></span>
- <span data-ttu-id="24933-221">SendGrid アカウントにログインし、[ [Email Activity] リンク](https://sendgrid.com/logs/index)をクリックします。</span><span class="sxs-lookup"><span data-stu-id="24933-221">Log into your SendGrid account and click on the [Email Activity link](https://sendgrid.com/logs/index).</span></span>
- <span data-ttu-id="24933-222">Sendgrid のユーザーアカウント名は、SendGrid アカウントの電子メールアドレスでは*なく、web.config 値と*して使用していることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="24933-222">Be certain you used your SendGrid user account name as a *Web.config* value rather than your SendGrid account email address.</span></span>

<a id="addRes"></a>
## <a name="additional-resources"></a><span data-ttu-id="24933-223">その他のリソース</span><span class="sxs-lookup"><span data-stu-id="24933-223">Additional Resources</span></span>

- [<span data-ttu-id="24933-224">推奨されるリソースへのリンク ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="24933-224">Links to ASP.NET Identity Recommended Resources</span></span>](../../../identity/overview/getting-started/aspnet-identity-recommended-resources.md)
- [<span data-ttu-id="24933-225">ASP.NET Identity を使用したアカウントの確認とパスワードの回復</span><span class="sxs-lookup"><span data-stu-id="24933-225">Account Confirmation and Password Recovery with ASP.NET Identity</span></span>](../../../identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity.md)
- [<span data-ttu-id="24933-226">ASP.NET Web Forms チュートリアルシリーズ-OAuth 2.0 プロバイダーの追加</span><span class="sxs-lookup"><span data-stu-id="24933-226">ASP.NET Web Forms tutorial series - Add an OAuth 2.0 Provider</span></span>](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#OAuthWebForms)
- [<span data-ttu-id="24933-227">メンバーシップ、OAuth、SQL Database を持つ Secure ASP.NET Web フォームアプリを Azure App Service にデプロイする</span><span class="sxs-lookup"><span data-stu-id="24933-227">Deploy a Secure ASP.NET Web Forms App with Membership, OAuth, and SQL Database to Azure App Service</span></span>](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)
- [<span data-ttu-id="24933-228">ASP.NET Web フォームチュートリアルシリーズ-プロジェクトの SSL を有効にする</span><span class="sxs-lookup"><span data-stu-id="24933-228">ASP.NET Web Forms tutorial series - Enable SSL for the Project</span></span>](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms)
