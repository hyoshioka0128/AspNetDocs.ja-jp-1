---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
title: Web 配置を使用して Web アプリケーションをオフラインにする |Microsoft Docs
author: jrjlee
description: このトピックでは、インターネットインフォメーションサービス (IIS) Web 展開を使用して、自動展開の間に web アプリケーションをオフラインにする方法について説明します。
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 3e9f6e7d-8967-4586-94d5-d3a122f12529
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
msc.type: authoredcontent
ms.openlocfilehash: ba60664a0c3daa0650cd7e7cfc4ab9da08df3440
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78422212"
---
# <a name="taking-web-applications-offline-with-web-deploy"></a><span data-ttu-id="662d2-103">Web 配置の際、Web アプリをオフラインにする</span><span class="sxs-lookup"><span data-stu-id="662d2-103">Taking Web Applications Offline with Web Deploy</span></span>

<span data-ttu-id="662d2-104">[Jason Lee](https://github.com/jrjlee)</span><span class="sxs-lookup"><span data-stu-id="662d2-104">by [Jason Lee](https://github.com/jrjlee)</span></span>

<span data-ttu-id="662d2-105">[[Download PDF]\(PDF をダウンロード\)](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)</span><span class="sxs-lookup"><span data-stu-id="662d2-105">[Download PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)</span></span>

> <span data-ttu-id="662d2-106">このトピックでは、インターネットインフォメーションサービス (IIS) Web 配置ツール (Web 配置) を使用して、自動展開の間に web アプリケーションをオフラインにする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-106">This topic describes how to take a web application offline for the duration of an automated deployment using the Internet Information Services (IIS) Web Deployment Tool (Web Deploy).</span></span> <span data-ttu-id="662d2-107">Web アプリケーションを参照するユーザーは、デプロイが完了するまで、*オフライン .htm ファイル\_アプリ*にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="662d2-107">Users who browse to the web application are redirected to an *App\_offline.htm* file until the deployment is complete.</span></span>

<span data-ttu-id="662d2-108">このトピックでは、Fabrikam, Inc. という架空の企業のエンタープライズ展開要件に基づいて、一連のチュートリアルの一部を説明します。このチュートリアルシリーズでは、&#x2014; [Contact Manager ソリューション](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;のサンプルソリューションを使用して、ASP.NET MVC 3 アプリケーション、Windows Communication Foundation (WCF) サービス、データベースプロジェクトなど、現実的なレベルの複雑さを持つ web アプリケーションを表します。</span><span class="sxs-lookup"><span data-stu-id="662d2-108">This topic forms part of a series of tutorials based around the enterprise deployment requirements of a fictional company named Fabrikam, Inc. This tutorial series uses a sample solution&#x2014;the [Contact Manager solution](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;to represent a web application with a realistic level of complexity, including an ASP.NET MVC 3 application, a Windows Communication Foundation (WCF) service, and a database project.</span></span>

<span data-ttu-id="662d2-109">これらのチュートリアルの中核となる配置方法は、「[プロジェクトファイルについ](../web-deployment-in-the-enterprise/understanding-the-project-file.md)て」で説明されている分割プロジェクトファイルアプローチに基づいています。この&#x2014;プロジェクトファイルには、ビルドプロセスは、すべての変換先環境に適用されるビルド命令を含む2つのプロジェクトファイルと、環境固有のビルドおよび配置設定を含んでいます。</span><span class="sxs-lookup"><span data-stu-id="662d2-109">The deployment method at the heart of these tutorials is based on the split project file approach described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md), in which the build process is controlled by two project files&#x2014;one containing build instructions that apply to every destination environment, and one containing environment-specific build and deployment settings.</span></span> <span data-ttu-id="662d2-110">ビルド時に、環境固有のプロジェクトファイルが環境に依存しないプロジェクトファイルにマージされ、ビルド命令の完全なセットが形成されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-110">At build time, the environment-specific project file is merged into the environment-agnostic project file to form a complete set of build instructions.</span></span>

## <a name="task-overview"></a><span data-ttu-id="662d2-111">タスクの概要</span><span class="sxs-lookup"><span data-stu-id="662d2-111">Task Overview</span></span>

<span data-ttu-id="662d2-112">さまざまなシナリオでは、データベースや web サービスなどの関連コンポーネントに変更を加えるときに、web アプリケーションをオフラインにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-112">In a lot of scenarios, you'll want to take a web application offline while you make changes to related components, like databases or web services.</span></span> <span data-ttu-id="662d2-113">通常、IIS と ASP.NET では、 *App\_* という名前のファイルを iis web サイトまたは web アプリケーションのルートフォルダーに配置することによってこれを実現します。</span><span class="sxs-lookup"><span data-stu-id="662d2-113">Typically, in IIS and ASP.NET, you accomplish this by placing a file named *App\_offline.htm* in the root folder of the IIS website or web application.</span></span> <span data-ttu-id="662d2-114">*\_のオフライン .htm*ファイルは標準の HTML ファイルであり、通常、メンテナンスのためにサイトが一時的に使用できないことを通知する単純なメッセージが含まれています。</span><span class="sxs-lookup"><span data-stu-id="662d2-114">The *App\_offline.htm* file is a standard HTML file and will usually contain a simple message advising the user that the site is temporarily unavailable due to maintenance.</span></span> <span data-ttu-id="662d2-115">*アプリ\_オフライン .htm*ファイルが web サイトのルートフォルダーに存在している間、IIS は自動的にすべての要求をファイルにリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="662d2-115">While the *App\_offline.htm* file exists in the root folder of the website, IIS will automatically redirect any requests to the file.</span></span> <span data-ttu-id="662d2-116">更新が完了したら、*アプリ\_offline .htm*ファイルを削除すると、web サイトは通常どおりに要求の処理を再開します。</span><span class="sxs-lookup"><span data-stu-id="662d2-116">When you've finished making updates, you remove the *App\_offline.htm* file and the website resumes serving requests as usual.</span></span>

<span data-ttu-id="662d2-117">Web 配置を使用して、対象の環境に対して自動または単一ステップの配置を実行する場合は、*アプリ\_のオフライン .htm*ファイルの追加と削除を展開プロセスに組み込むことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="662d2-117">When you use Web Deploy to perform automated or single-step deployments to a target environment, you may want to incorporate adding and removing the *App\_offline.htm* file into your deployment process.</span></span> <span data-ttu-id="662d2-118">これを行うには、次のような高レベルのタスクを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-118">To do this, you'll need to complete these high-level tasks:</span></span>

- <span data-ttu-id="662d2-119">配置プロセスの制御に使用する Microsoft Build Engine (MSBuild) プロジェクトファイルで、配置タスクを開始する前に、移行先サーバーに*アプリ\_オフライン .htm*ファイルをコピーする MSBuild ターゲットを作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-119">In the Microsoft Build Engine (MSBuild) project file that you use to control the deployment process, create an MSBuild target that copies an *App\_offline.htm* file to the destination server before any deployment tasks begin.</span></span>
- <span data-ttu-id="662d2-120">すべての展開タスクが完了したら、移行先サーバーから*アプリ\_offline .htm*ファイルを削除する別の MSBuild ターゲットを追加します。</span><span class="sxs-lookup"><span data-stu-id="662d2-120">Add another MSBuild target that removes the *App\_offline.htm* file from the destination server when all deployment tasks are complete.</span></span>
- <span data-ttu-id="662d2-121">Web アプリケーションプロジェクトで、Web 配置が呼び出されたときに、*アプリ\_オフライン .htm*ファイルが配置パッケージに追加されるようにするための、 *.targets*ファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-121">In the web application project, create a *.wpp.targets* file that ensures that an *App\_offline.htm* file is added to the deployment package when Web Deploy is invoked.</span></span>

<span data-ttu-id="662d2-122">このトピックでは、これらの手順を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-122">This topic will show you how to perform these procedures.</span></span> <span data-ttu-id="662d2-123">このトピックのタスクとチュートリアルでは、少なくとも1つの web アプリケーションプロジェクトを含むソリューションが既に作成されていることを前提としています。また、「[エンタープライズでの Web 配置](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md)」で説明されているように、カスタムプロジェクトファイルを使用してデプロイプロセスを制御します。</span><span class="sxs-lookup"><span data-stu-id="662d2-123">The tasks and walkthroughs in this topic assume that you've already created a solution that contains at least one web application project, and that you use a custom project file to control the deployment process as described in [Web Deployment in the Enterprise](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md).</span></span> <span data-ttu-id="662d2-124">または、 [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)サンプルソリューションを使用して、「」の例に従ってください。</span><span class="sxs-lookup"><span data-stu-id="662d2-124">Alternatively, you can use the [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) sample solution to follow the examples in the topic.</span></span>

## <a name="adding-an-app_offline-file-to-a-web-application-project"></a><span data-ttu-id="662d2-125">アプリ\_オフラインファイルを Web アプリケーションプロジェクトに追加する</span><span class="sxs-lookup"><span data-stu-id="662d2-125">Adding an App\_Offline File to a Web Application Project</span></span>

<span data-ttu-id="662d2-126">最初に完了する必要がある作業は、*アプリ\_オフライン*ファイルを web アプリケーションプロジェクトに追加することです。</span><span class="sxs-lookup"><span data-stu-id="662d2-126">The first task you need to complete is to add an *App\_offline* file to your web application project:</span></span>

- <span data-ttu-id="662d2-127">ファイルが開発プロセスに干渉しないようにするには (アプリケーションを完全にオフラインにしないようにする場合)、 *App\_offline. .htm*以外のものを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-127">To prevent the file from interfering with the development process (you don't want your application to be permanently offline), you should call it something other than *App\_offline.htm*.</span></span> <span data-ttu-id="662d2-128">たとえば、ファイルに*offline-template\_* という名前を指定できます。</span><span class="sxs-lookup"><span data-stu-id="662d2-128">For example, you could name the file *App\_offline-template.htm*.</span></span>
- <span data-ttu-id="662d2-129">ファイルがそのように配置されないようにするには、[ビルド] アクションを **[なし**] に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-129">To prevent the file from being deployed as-is, you should set the build action to **None**.</span></span>

<span data-ttu-id="662d2-130">**アプリ\_オフラインファイルを web アプリケーションプロジェクトに追加するには**</span><span class="sxs-lookup"><span data-stu-id="662d2-130">**To add an App\_offline file to a web application project**</span></span>

1. <span data-ttu-id="662d2-131">Visual Studio 2010 でソリューションを開きます。</span><span class="sxs-lookup"><span data-stu-id="662d2-131">Open your solution in Visual Studio 2010.</span></span>
2. <span data-ttu-id="662d2-132">**[ソリューションエクスプローラー]** ウィンドウで、web アプリケーションプロジェクトを右クリックし、 **[追加]** をポイントして、 **[新しい項目]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="662d2-132">In the **Solution Explorer** window, right-click your web application project, point to **Add**, and then click **New Item**.</span></span>
3. <span data-ttu-id="662d2-133">**[新しい項目の追加]** ダイアログボックスで、 **[HTML ページ]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="662d2-133">In the **Add New Item** dialog box, select **HTML Page**.</span></span>
4. <span data-ttu-id="662d2-134">**[名前]** ボックスに「 **App\_offline-template**」と入力し、 **[追加]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="662d2-134">In the **Name** box, type **App\_offline-template.htm**, and then click **Add**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image1.png)
5. <span data-ttu-id="662d2-135">単純な HTML を追加して、アプリケーションが使用できないことをユーザーに通知し、ファイルを保存します。</span><span class="sxs-lookup"><span data-stu-id="662d2-135">Add some simple HTML to inform users that the application is unavailable, and then save the file.</span></span> <span data-ttu-id="662d2-136">サーバー側のタグを含めないでください (たとえば、"asp:" というプレフィックスが付いたタグなど)。</span><span class="sxs-lookup"><span data-stu-id="662d2-136">Do not include any server-side tags (for example, any tags that are prefixed with "asp:").</span></span> 

    ![](taking-web-applications-offline-with-web-deploy/_static/image2.png)
6. <span data-ttu-id="662d2-137">**[ソリューションエクスプローラー]** ウィンドウで、新しいファイルを右クリックし、 **[プロパティ]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="662d2-137">In the **Solution Explorer** window, right-click the new file, and then click **Properties**.</span></span>
7. <span data-ttu-id="662d2-138">**[プロパティ]** ウィンドウの **[ビルドアクション]** 行で、 **[なし]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="662d2-138">In the **Properties** window, in the **Build Action** row, select **None**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image3.png)

## <a name="deploying-and-deleting-an-app_offline-file"></a><span data-ttu-id="662d2-139">アプリ\_オフラインファイルの展開と削除</span><span class="sxs-lookup"><span data-stu-id="662d2-139">Deploying and Deleting an App\_Offline File</span></span>

<span data-ttu-id="662d2-140">次の手順では、デプロイロジックを変更して、デプロイプロセスの開始時に移行先サーバーにファイルをコピーし、最後にファイルを削除します。</span><span class="sxs-lookup"><span data-stu-id="662d2-140">The next step is to modify your deployment logic to copy the file to the destination server at the start of the deployment process and remove it at the end.</span></span>

> [!NOTE]
> <span data-ttu-id="662d2-141">次の手順では、「[プロジェクトファイルについ](../web-deployment-in-the-enterprise/understanding-the-project-file.md)て」で説明されているように、カスタム MSBuild プロジェクトファイルを使用して配置プロセスを制御していることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="662d2-141">The next procedure assumes that you're using a custom MSBuild project file to control your deployment process, as described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md).</span></span> <span data-ttu-id="662d2-142">Visual Studio から直接デプロイする場合は、別の方法を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-142">If you're deploying direct from Visual Studio, you'll need to use a different approach.</span></span> <span data-ttu-id="662d2-143">作成者は、[発行中に Web アプリをオフラインにする方法](http://sedodream.com/2012/01/08/HowToTakeYourWebAppOfflineDuringPublishing.aspx)について説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-143">Sayed Ibrahim Hashimi describes one such approach in [How to Take Your Web App Offline During Publishing](http://sedodream.com/2012/01/08/HowToTakeYourWebAppOfflineDuringPublishing.aspx).</span></span>

<span data-ttu-id="662d2-144">*アプリ\_オフライン*ファイルを移行先の IIS web サイトに展開するには、 [Web 配置**contentpath**プロバイダー](https://technet.microsoft.com/library/dd569034(WS.10).aspx)を使用して msdeploy.exe を呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-144">To deploy an *App\_offline* file to a destination IIS website, you need to invoke MSDeploy.exe using the [Web Deploy **contentPath** provider](https://technet.microsoft.com/library/dd569034(WS.10).aspx).</span></span> <span data-ttu-id="662d2-145">**Contentpath**プロバイダーは、物理ディレクトリパスと iis web サイトまたはアプリケーションパスの両方をサポートしています。これにより、Visual Studio プロジェクトフォルダーと iis web アプリケーションの間でファイルを同期するための最適な選択肢となります。</span><span class="sxs-lookup"><span data-stu-id="662d2-145">The **contentPath** provider supports both physical directory paths and IIS website or application paths, which makes it the ideal choice for synchronizing a file between a Visual Studio project folder and an IIS web application.</span></span> <span data-ttu-id="662d2-146">ファイルを配置するために、Msdeploy.exe コマンドは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="662d2-146">To deploy the file, your MSDeploy command should resemble this:</span></span>

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample1.cmd)]

<span data-ttu-id="662d2-147">デプロイプロセスの最後に、転送先サイトからファイルを削除するために、Msdeploy.exe コマンドは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="662d2-147">To remove the file from the destination site at the end of the deployment process, your MSDeploy command should resemble this:</span></span>

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample2.cmd)]

<span data-ttu-id="662d2-148">ビルドと配置のプロセスの一部としてこれらのコマンドを自動化するには、それらをカスタム MSBuild プロジェクトファイルに統合する必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-148">To automate these commands as part of a build and deployment process, you need to integrate them into your custom MSBuild project file.</span></span> <span data-ttu-id="662d2-149">次の手順では、これを行う方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-149">The next procedure describes how to do this.</span></span>

<span data-ttu-id="662d2-150">**オフラインファイル\_アプリを展開および削除するには**</span><span class="sxs-lookup"><span data-stu-id="662d2-150">**To deploy and delete an App\_offline file**</span></span>

1. <span data-ttu-id="662d2-151">Visual Studio 2010 で、配置プロセスを制御する MSBuild プロジェクトファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="662d2-151">In Visual Studio 2010, open the MSBuild project file that controls your deployment process.</span></span> <span data-ttu-id="662d2-152">[Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)サンプルソリューションでは、これは、 *Publish*ファイルです。</span><span class="sxs-lookup"><span data-stu-id="662d2-152">In the [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) sample solution, this is the *Publish.proj* file.</span></span>
2. <span data-ttu-id="662d2-153">ルート**プロジェクト**要素に、*アプリ\_のオフライン*展開の変数を格納する新しい**PropertyGroup**要素を作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-153">In the root **Project** element, create a new **PropertyGroup** element to store variables for the *App\_offline* deployment:</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample3.xml)]
3. <span data-ttu-id="662d2-154">**SourceRoot**プロパティは、 *Publish*ファイル内の他の場所で定義されています。</span><span class="sxs-lookup"><span data-stu-id="662d2-154">The **SourceRoot** property is defined elsewhere in the *Publish.proj* file.</span></span> <span data-ttu-id="662d2-155">これは、ソースコンテンツのルートフォルダーの場所を、現在のパス&#x2014;を基準とした、 *Publish. proj*ファイルの場所を基準とした相対的な位置を示します。</span><span class="sxs-lookup"><span data-stu-id="662d2-155">It indicates the location of the root folder for the source content relative to the current path&#x2014;in other words, relative to the location of the *Publish.proj* file.</span></span>
4. <span data-ttu-id="662d2-156">**Contentpath**プロバイダーは、相対ファイルパスを受け入れません。そのため、ソースファイルの絶対パスを取得してから、デプロイする必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-156">The **contentPath** provider will not accept relative file paths, so you need to get an absolute path to your source file before you can deploy it.</span></span> <span data-ttu-id="662d2-157">これを行うには、 [ConvertToAbsolutePath](https://msdn.microsoft.com/library/bb882668.aspx)タスクを使用します。</span><span class="sxs-lookup"><span data-stu-id="662d2-157">You can use the [ConvertToAbsolutePath](https://msdn.microsoft.com/library/bb882668.aspx) task to do this.</span></span>
5. <span data-ttu-id="662d2-158">**GetAppOfflineAbsolutePath**という名前の新しい**Target**要素を追加します。</span><span class="sxs-lookup"><span data-stu-id="662d2-158">Add a new **Target** element named **GetAppOfflineAbsolutePath**.</span></span> <span data-ttu-id="662d2-159">このターゲット内で、 **ConvertToAbsolutePath**タスクを使用して、プロジェクトフォルダー内の*アプリ\_オフラインテンプレート*ファイルへの絶対パスを取得します。</span><span class="sxs-lookup"><span data-stu-id="662d2-159">Within this target, use the **ConvertToAbsolutePath** task to get an absolute path to the *App\_offline-template* file in your project folder.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample4.xml)]
6. <span data-ttu-id="662d2-160">このターゲットは、プロジェクトフォルダー内の*アプリ\_オフラインテンプレート*ファイルへの相対パスを取得し、絶対ファイルパスとして新しいプロパティに保存します。</span><span class="sxs-lookup"><span data-stu-id="662d2-160">This target takes the relative path to the *App\_offline-template* file in your project folder and saves it to a new property as an absolute file path.</span></span> <span data-ttu-id="662d2-161">**Beforetargets**属性は、このターゲットを**DeployAppOffline**ターゲットの前に実行することを指定します。これは、次の手順で作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-161">The **BeforeTargets** attribute specifies that you want this target to execute before the **DeployAppOffline** target, which you'll create in the next step.</span></span>
7. <span data-ttu-id="662d2-162">**DeployAppOffline**という名前の新しいターゲットを追加します。</span><span class="sxs-lookup"><span data-stu-id="662d2-162">Add a new target named **DeployAppOffline**.</span></span> <span data-ttu-id="662d2-163">このターゲット内で、アプリを移行先の web サーバーに *\_オフライン*ファイルをデプロイする msdeploy.exe コマンドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="662d2-163">Within this target, invoke the MSDeploy.exe command that deploys your *App\_offline* file to the destination web server.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample5.xml)]
8. <span data-ttu-id="662d2-164">この例では、 **ContactManagerIisPath**プロパティはプロジェクトファイル内の他の場所で定義されています。</span><span class="sxs-lookup"><span data-stu-id="662d2-164">In this example, the **ContactManagerIisPath** property is defined elsewhere in the project file.</span></span> <span data-ttu-id="662d2-165">これは、単に *[Iis Web サイト名]/[アプリケーション名]* という形式の iis アプリケーションパスです。</span><span class="sxs-lookup"><span data-stu-id="662d2-165">This is simply an IIS application path, in the form *[IIS Website Name]/[Application Name]*.</span></span> <span data-ttu-id="662d2-166">ターゲットに条件を含めることで、ユーザーはプロパティ値を変更するかコマンドラインパラメーターを指定することによって、*アプリ\_オフライン*展開のオンとオフを切り替えることができます。</span><span class="sxs-lookup"><span data-stu-id="662d2-166">Including a condition in the target enables users to switch the *App\_offline* deployment on or off by changing a property value or providing a command-line parameter.</span></span>
9. <span data-ttu-id="662d2-167">**DeleteAppOffline**という名前の新しいターゲットを追加します。</span><span class="sxs-lookup"><span data-stu-id="662d2-167">Add a new target named **DeleteAppOffline**.</span></span> <span data-ttu-id="662d2-168">このターゲット内で、保存先の web サーバーから*アプリ\_オフライン*ファイルを削除する msdeploy.exe コマンドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="662d2-168">Within this target, invoke the MSDeploy.exe command that removes your *App\_offline* file from the destination web server.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample6.xml)]
10. <span data-ttu-id="662d2-169">最後のタスクは、プロジェクトファイルの実行中に、これらの新しいターゲットを適切な時点で呼び出します。</span><span class="sxs-lookup"><span data-stu-id="662d2-169">The final task is to invoke these new targets at appropriate points during the execution of your project file.</span></span> <span data-ttu-id="662d2-170">これはさまざまな方法で行うことができます。</span><span class="sxs-lookup"><span data-stu-id="662d2-170">You can do this in various ways.</span></span> <span data-ttu-id="662d2-171">たとえば、 **FullPublishDependsOn**プロパティでは、 **fullpublish**の既定のターゲットが呼び出されたときに実行する必要があるターゲットのリストを指定し*ます*。</span><span class="sxs-lookup"><span data-stu-id="662d2-171">For example, in the *Publish.proj* file, the **FullPublishDependsOn** property specifies a list of targets that must be executed in order when the **FullPublish** default target is invoked.</span></span>
11. <span data-ttu-id="662d2-172">MSBuild プロジェクトファイルを変更して、発行プロセスの適切なポイントで**DeployAppOffline**および**DeleteAppOffline**ターゲットを呼び出すようにします。</span><span class="sxs-lookup"><span data-stu-id="662d2-172">Modify your MSBuild project file to invoke the **DeployAppOffline** and **DeleteAppOffline** targets at appropriate points in the publishing process.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample7.xml)]

<span data-ttu-id="662d2-173">カスタム MSBuild プロジェクトファイルを実行すると、ビルドが正常に完了した直後に、*アプリ\_オフライン*ファイルがサーバーに配置されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-173">When you run your custom MSBuild project file, the *App\_offline* file will be deployed to the server immediately after a successful build.</span></span> <span data-ttu-id="662d2-174">その後、すべてのデプロイタスクが完了すると、サーバーから削除されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-174">It will then be deleted from the server once all the deployment tasks are complete.</span></span>

## <a name="adding-an-app_offline-file-to-deployment-packages"></a><span data-ttu-id="662d2-175">アプリ\_オフラインファイルを展開パッケージに追加する</span><span class="sxs-lookup"><span data-stu-id="662d2-175">Adding an App\_Offline File to Deployment Packages</span></span>

<span data-ttu-id="662d2-176">展開を構成する方法によっては、移行先に web パッケージを配置&#x2014;するときに、*アプリ\_オフライン .htm*ファイル&#x2014;のように、移行先 IIS web アプリケーションの既存のコンテンツが自動的に削除されることがあります。</span><span class="sxs-lookup"><span data-stu-id="662d2-176">Depending on how you configure your deployment, any existing content at the destination IIS web application&#x2014;like the *App\_offline.htm* file&#x2014;may be deleted automatically when you deploy a web package to the destination.</span></span> <span data-ttu-id="662d2-177">デプロイ中に*アプリ\_オフライン .htm*ファイルが配置されるようにするには、デプロイプロセスの開始時に直接ファイルを配置するだけでなく、web 配置パッケージ内にファイルを含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-177">To ensure that the *App\_offline.htm* file remains in place for the duration of the deployment, you need to include the file within the web deployment package itself in addition to deploying the file directly at the start of the deployment process.</span></span>

- <span data-ttu-id="662d2-178">このトピックの前のタスクを実行したことがある場合は、*アプリ\_オフライン .htm*ファイルを別のファイル名 (*アプリ\_offline-template*を使用しました) の下に web アプリケーションプロジェクトに追加し、ビルドアクションを **[なし**] に設定します。</span><span class="sxs-lookup"><span data-stu-id="662d2-178">If you've followed the previous tasks in this topic, you'll have added the *App\_offline.htm* file to your web application project under a different filename (we used *App\_offline-template.htm*) and you'll have set the build action to **None**.</span></span> <span data-ttu-id="662d2-179">これらの変更は、ファイルが開発やデバッグに干渉するのを防ぐために必要です。</span><span class="sxs-lookup"><span data-stu-id="662d2-179">These changes are necessary to prevent the file from interfering with development and debugging.</span></span> <span data-ttu-id="662d2-180">そのため、パッケージ化プロセスをカスタマイズして、*アプリ\_オフライン .htm*ファイルが web 配置パッケージに含まれるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-180">As a result, you need to customize the packaging process to ensure that the *App\_offline.htm* file is included in the web deployment package.</span></span>

<span data-ttu-id="662d2-181">Web 発行パイプライン (WPP) は、 **Filesforの Ingfromproject**という名前の項目リストを使用して、web 配置パッケージに含める必要があるファイルのリストを作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-181">The Web Publishing Pipeline (WPP) uses an item list named **FilesForPackagingFromProject** to build a list of files that should be included in the web deployment package.</span></span> <span data-ttu-id="662d2-182">独自の項目をこの一覧に追加することで、web パッケージの内容をカスタマイズできます。</span><span class="sxs-lookup"><span data-stu-id="662d2-182">You can customize the contents of your web packages by adding your own items to this list.</span></span> <span data-ttu-id="662d2-183">これを行うには、次の大まかな手順を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-183">To do this, you need to complete these high-level steps:</span></span>

1. <span data-ttu-id="662d2-184">プロジェクトファイルと同じフォルダーに、 *[project name] wpp*という名前のカスタムプロジェクトファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-184">Create a custom project file named *[project name].wpp.targets* in the same folder as your project file.</span></span>

    > [!NOTE]
    > <span data-ttu-id="662d2-185">*.Targets*ファイルは、web アプリケーションプロジェクトファイル&#x2014;と同じフォルダーに配置する必要があります。たとえば、ビルドと配置のプロセスを制御するために使用するカスタムプロジェクトファイルと同じフォルダーではなく、 *contactmanager. .csproj*&#x2014;というフォルダーにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="662d2-185">The *.wpp.targets* file needs to go in the same folder as your web application project file&#x2014;for example, *ContactManager.Mvc.csproj*&#x2014;rather than in the same folder as any custom project files you use to control the build and deployment process.</span></span>
2. <span data-ttu-id="662d2-186">*Wpp*ファイルで、 **CopyAllFilesToSingleFolderForPackage**ターゲットの*前に*実行する新しい MSBuild ターゲットを作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-186">In the *.wpp.targets* file, create a new MSBuild target that executes *before* the **CopyAllFilesToSingleFolderForPackage** target.</span></span> <span data-ttu-id="662d2-187">これは、パッケージに含める項目の一覧を作成する WPP ターゲットです。</span><span class="sxs-lookup"><span data-stu-id="662d2-187">This is the WPP target that builds a list of things to include in the package.</span></span>
3. <span data-ttu-id="662d2-188">新しいターゲットで、 **ItemGroup**要素を作成します。</span><span class="sxs-lookup"><span data-stu-id="662d2-188">In the new target, create an **ItemGroup** element.</span></span>
4. <span data-ttu-id="662d2-189">**ItemGroup**要素で、 **Filesfor ingfromプロジェクト**項目を追加し、 *\_アプリをオフライン .htm*ファイルとして指定します。</span><span class="sxs-lookup"><span data-stu-id="662d2-189">In the **ItemGroup** element, add a **FilesForPackagingFromProject** item and specify the *App\_offline.htm* file.</span></span>

<span data-ttu-id="662d2-190">*. .Targets*ファイルは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="662d2-190">The *.wpp.targets* file should resemble this:</span></span>

[!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample8.xml)]

<span data-ttu-id="662d2-191">この例の重要な点を次に示します。</span><span class="sxs-lookup"><span data-stu-id="662d2-191">These are the key points of note in this example:</span></span>

- <span data-ttu-id="662d2-192">**Beforetargets**属性は、 **CopyAllFilesToSingleFolderForPackage**ターゲットの直前に実行されることを指定することによって、このターゲットを WPP に挿入します。</span><span class="sxs-lookup"><span data-stu-id="662d2-192">The **BeforeTargets** attribute inserts this target into the WPP by specifying that it should be executed immediately before the **CopyAllFilesToSingleFolderForPackage** target.</span></span>
- <span data-ttu-id="662d2-193">**FilesforDestinationRelativePath Ingfromproject**項目では、ファイルの名前を*app\_offline-template*から*app\_* に変更するために、リストに追加されたときに、このメタデータ値を使用します。</span><span class="sxs-lookup"><span data-stu-id="662d2-193">The **FilesForPackagingFromProject** item uses the **DestinationRelativePath** metadata value to rename the file from *App\_offline-template.htm* to *App\_offline.htm* as it's added to the list.</span></span>

<span data-ttu-id="662d2-194">次の手順では、この*wpp*ファイルを web アプリケーションプロジェクトに追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-194">The next procedure shows you how to add this *.wpp.targets* file to a web application project.</span></span>

<span data-ttu-id="662d2-195">**Web 配置パッケージに wpp ファイルを追加するには**</span><span class="sxs-lookup"><span data-stu-id="662d2-195">**To add a .wpp.targets file to a web deployment package**</span></span>

1. <span data-ttu-id="662d2-196">Visual Studio 2010 でソリューションを開きます。</span><span class="sxs-lookup"><span data-stu-id="662d2-196">Open your solution in Visual Studio 2010.</span></span>
2. <span data-ttu-id="662d2-197">**[ソリューションエクスプローラー]** ウィンドウで、web アプリケーションプロジェクトノード ( **contactmanager**など) を右クリックし、 **[追加]** をポイントして、 **[新しい項目]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="662d2-197">In the **Solution Explorer** window, right-click your web application project node (for example, **ContactManager.Mvc**), point to **Add**, and then click **New Item**.</span></span>
3. <span data-ttu-id="662d2-198">**[新しい項目の追加]** ダイアログボックスで、 **[XML ファイル]** テンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="662d2-198">In the **Add New Item** dialog box, select the **XML File** template.</span></span>
4. <span data-ttu-id="662d2-199">**[名前]** ボックスに「 \*[project Name] \* \* \*\* を使用します。」と入力し (たとえば、 **contactmanager. Mvc. wpp**)、 **[追加]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="662d2-199">In the **Name** box, type *[project name]\*\*\*.wpp.targets*\* (for example, **ContactManager.Mvc.wpp.targets**), and then click **Add**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image4.png)

    > [!NOTE]
    > <span data-ttu-id="662d2-200">プロジェクトのルートノードに新しい項目を追加すると、そのファイルはプロジェクトファイルと同じフォルダーに作成されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-200">If you add a new item to the root node of a project, the file is created in the same folder as the project file.</span></span> <span data-ttu-id="662d2-201">これを確認するには、エクスプローラーでフォルダーを開きます。</span><span class="sxs-lookup"><span data-stu-id="662d2-201">You can verify this by opening the folder in Windows Explorer.</span></span>
5. <span data-ttu-id="662d2-202">ファイルで、前に説明した MSBuild マークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="662d2-202">In the file, add the MSBuild markup described previously.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample9.xml)]
6. <span data-ttu-id="662d2-203">*[Project name]. wpp. .targets*ファイルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="662d2-203">Save and close the *[project name].wpp.targets* file.</span></span>

<span data-ttu-id="662d2-204">次に web アプリケーションプロジェクトをビルドしてパッケージ化すると、WPP によって自動的に*wpp*ファイルが検出されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-204">The next time you build and package your web application project, the WPP will automatically detect the *.wpp.targets* file.</span></span> <span data-ttu-id="662d2-205">アプリ *\_offline-template*ファイルは、*アプリ\_offline. .htm*として生成される web 展開パッケージに含まれます。</span><span class="sxs-lookup"><span data-stu-id="662d2-205">The *App\_offline-template.htm* file will be included in the resulting web deployment package as *App\_offline.htm*.</span></span>

> [!NOTE]
> <span data-ttu-id="662d2-206">配置に失敗した場合、*アプリ\_オフライン .htm*ファイルはそのまま残り、アプリケーションはオフラインのままになります。</span><span class="sxs-lookup"><span data-stu-id="662d2-206">If your deployment fails, the *App\_offline.htm* file will remain in place and your application will remain offline.</span></span> <span data-ttu-id="662d2-207">これは通常、望ましい動作です。</span><span class="sxs-lookup"><span data-stu-id="662d2-207">This is typically the desired behavior.</span></span> <span data-ttu-id="662d2-208">アプリケーションをオンラインに戻すには、web サーバーから*オフラインの .htm ファイル\_アプリ*を削除します。</span><span class="sxs-lookup"><span data-stu-id="662d2-208">To bring your application back online, you can delete the *App\_offline.htm* file from your web server.</span></span> <span data-ttu-id="662d2-209">または、エラーを修正して正常な配置を実行すると、*アプリ\_のオフライン .htm*ファイルが削除されます。</span><span class="sxs-lookup"><span data-stu-id="662d2-209">Alternatively, if you correct any errors and run a successful deployment, the *App\_offline.htm* file will be removed.</span></span>

## <a name="conclusion"></a><span data-ttu-id="662d2-210">まとめ</span><span class="sxs-lookup"><span data-stu-id="662d2-210">Conclusion</span></span>

<span data-ttu-id="662d2-211">このトピックでは、デプロイ中に web アプリケーションをオフラインにする方法について説明します。そのためには、展開プロセスの開始時に移行先サーバーに*アプリ\_オフライン .htm*ファイルを発行し、最後にそのサーバーを削除します。</span><span class="sxs-lookup"><span data-stu-id="662d2-211">This topic described how to take a web application offline for the duration of a deployment, by publishing an *App\_offline.htm* file to the destination server at the start of the deployment process and removing it at the end.</span></span> <span data-ttu-id="662d2-212">また、web 配置パッケージに*アプリ\_offline .htm*ファイルを組み込む方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="662d2-212">It also covered how to include an *App\_offline.htm* file in a web deployment package.</span></span>

## <a name="further-reading"></a><span data-ttu-id="662d2-213">参考資料</span><span class="sxs-lookup"><span data-stu-id="662d2-213">Further Reading</span></span>

<span data-ttu-id="662d2-214">パッケージ化と配置のプロセスの詳細については、「 [Web アプリケーションプロジェクトのビルドとパッケージ化](../web-deployment-in-the-enterprise/building-and-packaging-web-application-projects.md)」、「Web[パッケージ配置のパラメーターの構成](../web-deployment-in-the-enterprise/configuring-parameters-for-web-package-deployment.md)」、および「 [web パッケージの配置](../web-deployment-in-the-enterprise/deploying-web-packages.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="662d2-214">For more information on the packaging and deployment process, see [Building and Packaging Web Application Projects](../web-deployment-in-the-enterprise/building-and-packaging-web-application-projects.md), [Configuring Parameters for Web Package Deployment](../web-deployment-in-the-enterprise/configuring-parameters-for-web-package-deployment.md), and [Deploying Web Packages](../web-deployment-in-the-enterprise/deploying-web-packages.md).</span></span>

<span data-ttu-id="662d2-215">Web アプリケーションを Visual Studio から直接発行する場合は、これらのチュートリアルで説明されているカスタム MSBuild プロジェクトファイルの方法を使用するのではなく、発行中にアプリケーションをオフラインにするために、若干異なる方法を使用する必要があります。process.</span><span class="sxs-lookup"><span data-stu-id="662d2-215">If you publish your web applications directly from Visual Studio, rather than using the custom MSBuild project file approach described in these tutorials, you'll need to use a slightly different approach to take your application offline during the publishing process.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="662d2-216">[前へ](excluding-files-and-folders-from-deployment.md)
> [次へ](running-windows-powershell-scripts-from-msbuild-project-files.md)</span><span class="sxs-lookup"><span data-stu-id="662d2-216">[Previous](excluding-files-and-folders-from-deployment.md)
[Next](running-windows-powershell-scripts-from-msbuild-project-files.md)</span></span>
