---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/strategies-for-database-development-and-deployment-vb
title: データベース開発および配置のための戦略 (VB) |Microsoft Docs
author: rick-anderson
description: データドリブンアプリケーションを初めて配置する場合は、開発環境内のデータベースを実稼働環境に無条件でコピーできます。 B...
ms.author: riande
ms.date: 04/23/2009
ms.assetid: 07b8905d-78ac-4252-97fb-8675b3fb0bbf
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/strategies-for-database-development-and-deployment-vb
msc.type: authoredcontent
ms.openlocfilehash: 1ea4ade32fb05b9e69647ece7d1a4c400fe9fb21
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74616120"
---
# <a name="strategies-for-database-development-and-deployment-vb"></a>データベースの開発と配置のための戦略 (VB)

[Scott Mitchell](https://twitter.com/ScottOnWriting)

[PDF のダウンロード](https://download.microsoft.com/download/C/3/9/C391A649-B357-4A7B-BAA4-48C96871FEA6/aspnet_tutorial10_DBDevel_vb.pdf)

> データドリブンアプリケーションを初めて配置する場合は、開発環境内のデータベースを実稼働環境に無条件でコピーできます。 ただし、その後の配置でブラインドコピーを実行すると、運用データベースに入力されたすべてのデータが上書きされます。 その代わりに、データベースを配置するには、運用データベースへの最後の配置以降に開発データベースに加えられた変更を適用する必要があります。 このチュートリアルでは、これらの課題について考察し、最後の配置以降にデータベースに加えられた変更を chronicling して適用するためのさまざまな戦略を提供します。

## <a name="introduction"></a>はじめに

前のチュートリアルで説明したように、ASP.NET アプリケーションを配置するには、開発環境から運用環境に関連するコンテンツをコピーすることが伴います。 デプロイは1回限りのイベントではなく、新しいバージョンのソフトウェアがリリースされるたび、またはバグやセキュリティ上の懸念事項が特定され、対処されたときに発生するものです。 ASP.NET のページ、イメージ、JavaScript ファイル、その他のファイルを運用環境にコピーする場合は、最後の配置以降にこれらのファイルがどのように変更されたかについて気にする必要はありません。 ファイルを実稼働環境にコピーし、既存のコンテンツを上書きすることができます。 残念ながら、この簡単な方法は、データベースの配置には適用されません。

データドリブンアプリケーションを初めて配置する場合は、開発環境内のデータベースを実稼働環境に無条件でコピーできます。 ただし、その後の配置でブラインドコピーを実行すると、運用データベースに入力されたすべてのデータが上書きされます。 その代わりに、データベースを配置するには、運用データベースへの最後の配置以降に開発データベースに加えられた*変更*を適用する必要があります。 このチュートリアルでは、これらの課題について考察し、最後の配置以降にデータベースに加えられた変更を chronicling して適用するためのさまざまな戦略を提供します。

## <a name="the-challenges-of-deploying-a-database"></a>データベースの配置に関する課題

データドリブンアプリケーションを初めて配置する前に、データベースが1つだけ存在します。つまり、開発環境にデータベースが1つだけ存在します。これは、データドリブンアプリケーションを初めて配置するときに、データベースを開発環境を運用環境に展開します。 しかし、アプリケーションをデプロイした後は、データベースのコピーが2つあります。1つは開発中で、もう1つは運用環境です。

デプロイ間では、開発データベースと運用データベースが同期されなくなる可能性があります。実稼働データベース s スキーマは変更されませんが、新しい機能が追加されると、開発データベース s スキーマが変更される可能性があります。 列、テーブル、ビュー、またはストアドプロシージャを追加または削除することができます。 また、開発データベースに追加される重要なデータがある場合もあります。 多くのデータドリブンアプリケーションには、ハードコーディングされた、ユーザーが編集できないアプリケーション固有のデータを含む参照テーブルが含まれています。 たとえば、オークションの web サイトには、auctioned されている項目の条件を説明するドロップダウンリストがあります。これには、new、Good、公正などがあります。 これらのオプションをドロップダウンリストで直接ハードコーディングするのではなく、通常はデータベーステーブルに配置することをお勧めします。 開発中に、"不十分" という名前の新しい条件がテーブルに追加された場合は、アプリケーションを配置するときに、この同じレコードを実稼働データベースのルックアップテーブルに追加する必要があります。

データベースを配置する場合は、開発環境から運用環境にデータベースをコピーするのが理想的です。 ただし、アプリケーションをデプロイして開発を再開した後は、実稼働データベースに実際のユーザーからの実際のデータが入力されていることに注意してください。 そのため、次の配置時に単に開発環境から運用環境にデータベースをコピーする場合は、実稼働データベースを上書きして、既存のデータを失うことになります。 最終的には、データベースを配置すると、前回の配置以降に開発データベースに加えられた変更を適用することになります。

データベースを配置するには、スキーマの変更と、場合によっては前回の配置以降のデータを適用する必要があるため、変更の履歴を保持する (または、デプロイ時に決定する) 必要があります。これにより、変更を運用環境に適用できるようになります。 データモデルに対する変更を管理および適用するには、さまざまな方法があります。

### <a name="defining-the-baseline"></a>ベースラインの定義

アプリケーションのデータベースへの変更を維持するには、開始状態 (変更が適用されるベースライン) が必要です。 1つの極端な開始状態は、テーブル、ビュー、またはストアドプロシージャがない空のデータベースである可能性があります。 このようなベースラインでは、最初の配置後に加えられたすべての変更と共に、すべてのデータベースのテーブル、ビュー、およびストアドプロシージャの作成が含まれている必要があるため、大きな変更ログが生成されます。 この範囲のもう一方の端には、最初に運用環境に配置されたデータベースのバージョンとしてベースラインを設定できます。 このオプションを選択すると、最初の配置後にデータベースに加えられた変更のみが含まれるため、変更ログが大幅に小さくなります。 これが望ましい方法です。 もちろん、より大きな道路アプローチを選択して、データベースを最初に作成してからデータベースを最初に配置するまでの時点としてベースラインを定義することもできます。

ベースラインを選択したら、ベースラインバージョンを再作成するために実行できる SQL スクリプトを生成することを検討してください。 このようなスクリプトを使用すると、データベースのベースラインバージョンをすばやく再作成できます。 この機能は、プロジェクトで作業している開発者が複数いる場合や、テストやステージングなどの追加の環境で、それぞれが独自のデータベースコピーを必要とする大規模なプロジェクトで特に便利です。

ベースラインバージョンの SQL スクリプトを生成するためのさまざまなツールが用意されています。 SQL Server Management Studio (SSMS) で、データベースを右クリックし、[タスク] サブメニューにアクセスして、[スクリプトの生成] オプションを選択します。 これにより、スクリプトウィザードが起動します。このウィザードでは、データベース s オブジェクトを作成するための SQL コマンドを含むファイルを生成するように指示できます。 もう1つのオプションとして、データベースのパブリッシュウィザードがあります。このウィザードでは、データベーススキーマだけでなく、データベーステーブル内のデータも作成できるように、SQL コマンドを生成できます。 データベース発行ウィザードの詳細については、「*データベースの配置*」チュートリアルをご覧ください。 使用するツールに関係なく、最終的には、データベースのベースラインバージョンを再作成するために使用できるスクリプトファイルが必要になります。

## <a name="documenting-the-database-changes-in-prose"></a>Prose でのデータベースの変更のドキュメント化

開発フェーズ中にデータモデルに対する変更のログを保持する最も簡単な方法は、変更を prose に記録することです。 たとえば、既に配置されたアプリケーションの開発時に、`Employees` テーブルに新しい列を追加し、`Orders` テーブルから列を削除し、新しいテーブル (`ProductCategories`) を追加する場合は、次の履歴を使用してテキストファイルまたは Microsoft Word 文書を保持します。

<a id="0.8_table01"></a>

| **日付の変更** | **変更の詳細** |
| --- | --- |
| 2009-02-03: | `Employees` テーブルに列 `DepartmentID` (NULL ではない`int`) を追加しました。 `Departments.DepartmentID` から `Employees.DepartmentID`への外部キー制約が追加されました。 |
| 2009-02-05: | `Orders` テーブルから列 `TotalWeight` を削除しました。 関連する `OrderDetails` レコードに既にキャプチャされたデータ。 |
| 2009-02-12: | `ProductCategories` テーブルを作成しました。 列には、`ProductCategoryID` (`int`、`IDENTITY`、`NOT NULL`)、`CategoryName` (`nvarchar(50)`、`NOT NULL`)、`Active` (`bit`、`NOT NULL`) の3つの列があります。 `ProductCategoryID`に primary key 制約を追加し、既定値1を `Active`に追加しました。 |

このアプローチにはいくつかの欠点があります。 手始めとして、automation については期待していません。 アプリケーションが配置されたときなど、これらの変更をデータベースに適用する必要がある場合、開発者は各変更を1つずつ手動で実装する必要があります。 さらに、変更ログを使用してベースラインから特定のバージョンのデータベースを再構築する必要がある場合は、ログのサイズが大きくなるほど時間がかかります。 この方法のもう1つの欠点は、各変更ログエントリの明確さと詳細レベルが、変更を記録しているユーザーに残されていることです。 複数の開発者がいるチームでは、他のユーザーよりも詳細で読みやすく、より正確なエントリを作成することがあります。 また、誤字やその他の人間に関連するデータ入力エラーが発生する可能性もあります。

Prose でデータベースの変更を文書化する主な利点は簡単です。 データベースオブジェクトを作成および変更するための SQL 構文に関する知識は必要ありません。 代わりに、prose で変更を記録し、SQL Server Management Studio s グラフィカルユーザーインターフェイスを使用して実装することができます。

Prose で変更ログを保持することは、非常に洗練されているわけではなく、特定のプロジェクトでは適切に機能しません。たとえば、スコープが大きくなっているものや、データモデルが頻繁に変更されている場合、複数の開発者が関与している場合などです。 しかし、このアプローチは、データモデルが頻繁に変更されていて、データベースオブジェクトを作成および変更するための SQL 構文において、ソロ開発者が強力な背景を持たない小規模な1人のプロジェクトで非常にうまく機能していることがわかりました。

> [!NOTE]
> 変更ログの情報は、技術的には展開時まで必要ですが、変更の履歴を保持することをお勧めします。 ただし、1つの拡張した変更ログファイルを保持するのではなく、データベースのバージョンごとに異なる変更ログファイルを使用することを検討してください。 通常は、配置されるたびにデータベースのバージョンを作成します。 変更ログのログを保持するには、ベースラインから開始し、バージョン1以降の変更ログスクリプトを実行してデータベースバージョンを再作成し、再作成する必要があるバージョンに達するまで続行します。

## <a name="recording-the-sql-change-statements"></a>SQL 変更ステートメントの記録

Prose の変更ログを維持するための主な欠点は、自動化が欠如していることです。 理想的には、配置時にデータベースの変更を実稼働データベースに実装することは、手順の一覧を手動で実行するのではなく、スクリプトを実行するボタンをクリックするだけで簡単に行うことができます。 このような自動化は、データモデルの変更に使用する SQL コマンドを含む変更ログを保持することによって可能です。

SQL 構文には、さまざまなデータベースオブジェクトを作成および変更するための多数のステートメントが含まれています。 たとえば、 [*CREATE TABLE ステートメント*](https://msdn.microsoft.com/library/ms174979.aspx)を実行すると、指定した列と制約を持つ新しいテーブルが作成されます。 [*ALTER TABLE ステートメント*](https://msdn.microsoft.com/library/ms190273.aspx)は、既存のテーブルを変更し、その列または制約を追加、削除、または変更します。 また、インデックス、ビュー、ユーザー定義関数、ストアドプロシージャ、トリガー、およびその他のデータベースオブジェクトを作成、変更、および削除するためのステートメントも用意されています。

前の例に戻ると、既に配置されたアプリケーションの開発時に、`Employees` テーブルに新しい列を追加し、`Orders` テーブルから列を削除し、新しいテーブル (`ProductCategories`) を追加します。 このような操作を行うと、次の SQL コマンドを使用して変更ログファイルが生成されます。

[!code-sql[Main](strategies-for-database-development-and-deployment-vb/samples/sample1.sql)]

配置時にこれらの変更を実稼働データベースにプッシュするには、ワンクリック操作があります。 SQL Server Management Studio を開き、実稼働データベースに接続して、新しいクエリウィンドウを開き、変更ログの内容を貼り付けて、[実行] をクリックしてスクリプトを実行します。

## <a name="using-a-comparison-tool-to-synchronize-the-data-models"></a>比較ツールを使用したデータモデルの同期

Prose でのデータベースの変更のドキュメントの作成は簡単ですが、変更を実装するには、開発者が運用データベースを1つずつ変更する必要があります。変更 SQL コマンドをドキュメント化することで、ボタンをクリックするのと同じように、これらの変更を実稼働データベースに簡単かつ迅速に実装できますが、データベースオブジェクトを作成および変更するための SQL ステートメントや構文の学習とマスタリングが必要になります。 データベース比較ツールは、両方のアプローチから最適な方法を採用し、最悪のことを破棄します。

データベース比較ツールは、2つのデータベースのスキーマまたはデータを比較し、データベースがどのように異なるかを示す概要レポートを表示します。 次に、ボタンをクリックすると、1つまたは複数のデータベースオブジェクトを同期するための SQL コマンドを生成できます。 簡単に言うと、データベース比較ツールを使用して、配置時に開発データベースと実稼働データベースを比較し、実行された SQL コマンドを含むファイルを生成します。これにより、変更が運用データベースのスキーマに適用されます。開発データベース s スキーマをミラー化します。

さまざまなベンダーによって提供されるさまざまなサードパーティ製のデータベース比較ツールがあります。 このような例の1つは、 [*Red Gate Software*](http://www.red-gate.com/)による[*SQL Compare*](http://www.red-gate.com/products/SQL_Compare/)です。 SQL Compare を使用して、開発データベーススキーマと実稼働データベーススキーマを比較し、同期するプロセスについて説明します。

> [!NOTE]
> このドキュメントの執筆時点では、SQL Compare の現在のバージョンは、Standard Edition のコスト $395 を使用したバージョン7.1 でした。 14日間の無料試用版をダウンロードすることによって、次の操作を行うことができます。

SQL 比較が開始されると、[比較プロジェクト] ダイアログボックスが開き、保存された SQL 比較プロジェクトが表示されます。 新しいプロジェクトを作成します。 これにより、プロジェクト構成ウィザードが起動し、比較するデータベースに関する情報の入力が求められます (図1を参照)。 開発環境および運用環境のデータベースの情報を入力します。

[開発データベースと運用データベースを比較 ![には](strategies-for-database-development-and-deployment-vb/_static/image2.jpg)](strategies-for-database-development-and-deployment-vb/_static/image1.jpg)

**図 1**: 開発データベースと運用データベースを比較[する (クリックすると、フルサイズの画像が表示](strategies-for-database-development-and-deployment-vb/_static/image3.jpg)されます)

> [!NOTE]
> 開発環境のデータベースが web サイトの `App_Data` フォルダー内の SQL Express Edition データベースファイルである場合は、図1のようにダイアログボックスから選択するために、データベースを SQL Server Express データベースサーバーに登録する必要があります。 これを実現する最も簡単な方法は、SQL Server Management Studio (SSMS) を開き、SQL Server Express データベースサーバーに接続して、データベースをアタッチすることです。 コンピューターに SSMS がインストールされていない場合は、無料の[*SQL Server 2008 Management Studio Basic バージョン*](https://www.microsoft.com/downloads/details.aspx?FamilyId=7522A683-4CB2-454E-B908-E805E9BD4E28&amp;displaylang=en)をダウンロードしてインストールすることができます。

比較するデータベースを選択するだけでなく、[オプション] タブでさまざまな比較設定を指定することもできます。有効にするオプションの1つとして、"制約とインデックス名の無視" があります。 前のチュートリアルでは、アプリケーションサービスデータベースオブジェクトを開発データベースと運用データベースに追加しました。 `aspnet_regsql.exe` ツールを使用して実稼働データベースでこれらのオブジェクトを作成した場合は、主キーと一意の制約名が開発データベースと実稼働データベースで異なっていることがわかります。 その結果、SQL Compare によって、すべてのアプリケーションサービステーブルが異なるというフラグが付けられます。 [制約とインデックス名を無視する] をオフのままにして、制約名を同期するか、これらの違いを無視するように SQL Compare に指示できます。

比較するデータベースを選択し、比較オプションを確認したら、[今すぐ比較] ボタンをクリックして比較を開始します。 次の数秒で、SQL 比較は2つのデータベースのスキーマを調べ、それらがどのように異なるかを示すレポートを生成します。 このような不一致が SQL Compare インターフェイスにどのように記載されているかを示すために、開発データベースに何らかの変更を加えました。 図2に示すように、`Authors` テーブルに `BirthDate` 列を追加し、`Books` テーブルから `ISBN` 列を削除した後、新しい `Ratings`テーブルを追加しました。これは、ユーザーがレビュー対象のブックをサイトにアクセスできるようにするためのものです。

> [!NOTE]
> このチュートリアルで行ったデータモデルの変更は、データベース比較ツールの使用方法を示すために行われました。 これらの変更は、今後のチュートリアルではデータベースにはありません。

[![SQL 比較では、開発データベースと運用データベースの違いを示します。](strategies-for-database-development-and-deployment-vb/_static/image5.jpg)](strategies-for-database-development-and-deployment-vb/_static/image4.jpg)

**図 2**: SQL 比較では、開発データベースと実稼働データベースの違いを示します ([クリックすると、フルサイズの画像が表示](strategies-for-database-development-and-deployment-vb/_static/image6.jpg)されます)

SQL 比較では、データベースオブジェクトがグループに分割され、両方のデータベースに存在するオブジェクトはどれか、データベースには存在していても他方には存在しないオブジェクト、および同一のオブジェクトが表示されます。 ご覧のように、両方のデータベースに存在するオブジェクトは2つありますが、列が追加された `Authors` テーブルと `Books` テーブルが削除されています。 開発データベース、つまり新しく作成された `Ratings` テーブルにのみ存在するオブジェクトが1つあります。 また、両方のデータベースに同一の117オブジェクトがあります。

データベースオブジェクトを選択すると、[SQL の相違点] ウィンドウが表示され、これらのオブジェクトがどのように異なるかが示されます。 図2の下部に表示される [SQL の相違点] ウィンドウでは、開発データベースの `Authors` テーブルに `BirthDate` 列があることが強調表示されています。これは、実稼働データベースの `Authors` テーブルにはありません。

相違点を確認し、同期するオブジェクトを選択したら、次に、開発データベースに一致するように実稼働データベース s スキーマを更新するために必要な SQL コマンドを生成します。 これは、同期ウィザードを使用して行います。 同期ウィザードは、同期するオブジェクトとアクションプランの概要を確認します (図3を参照)。 データベースをすぐに同期することも、必要に応じて実行できる SQL コマンドを使用してスクリプトを生成することもできます。

[同期ウィザードを使用してデータベーススキーマを同期 ![には](strategies-for-database-development-and-deployment-vb/_static/image8.jpg)](strategies-for-database-development-and-deployment-vb/_static/image7.jpg)

**図 3**: 同期ウィザードを使用してデータベーススキーマを同期する ([クリックすると、フルサイズの画像が表示](strategies-for-database-development-and-deployment-vb/_static/image9.jpg)されます)

Red Gate Software s SQL Compare などのデータベース比較ツールを使用すると、開発データベーススキーマへの変更を、ポイントアンドクリックで簡単に運用データベースに適用することができます。

> [!NOTE]
> SQL 比較では、2つのデータベース*スキーマ*を比較して同期します。 残念ながら、2つのデータベーステーブル内のデータを比較して同期することはありません。 Red Gate ソフトウェアには、2つのデータベース間でデータを比較して同期する[*Sql データ比較*](http://www.red-gate.com/products/SQL_Data_Compare/)という製品が用意されていますが、Sql の比較と、別の $395 のコストの別の製品です。

## <a name="taking-the-application-offline-during-deployment"></a>デプロイ中にアプリケーションをオフラインにする

これらのチュートリアル全体で見てきたように、デプロイは、ASP.NET ページ、マスターページ、CSS ファイル、JavaScript ファイル、画像、およびその他の必要なコンテンツを開発環境から運用環境にコピーするという複数の手順を伴うプロセスです。environment必要に応じて、運用環境固有の構成情報をコピーします。最後の配置以降にデータモデルに変更を適用します。 ファイルの数やデータベースの複雑さによっては、これらの手順が完了するまで数秒から数分かかることがあります。 このウィンドウでは、web アプリケーションが流動的で、サイトにアクセスしているユーザーがエラーまたは予期しない動作をする場合があります。

Web サイトをデプロイする場合は、デプロイが完了するまで web アプリケーションを "オフライン" にすることをお勧めします。 アプリケーションをオフラインにし (展開プロセスが完了した後でバックアップを復元する)、ファイルをアップロードしてから削除するのと同じように簡単です。 ASP.NET 2.0 以降では、アプリケーションのルートディレクトリに `app_offline.htm` という名前のファイルが存在するだけでは、web サイト全体が "オフライン" になります。 そのサイトの ASP.NET ページに対するすべての要求は、`app_offline.htm` ファイルの内容で自動的に応答します。 ファイルが削除されると、アプリケーションはオンラインに戻ります。

デプロイ中にアプリケーションをオフラインにすると、デプロイが完了すると、展開プロセスを開始する前に `app_offline.htm` ファイルを実稼働環境のルートディレクトリにアップロードするのと同じように簡単に行うことができます。 この手法の詳細については、John Peterson の記事「 [*ASP.NET アプリケーションをオフライン*](http://www.15seconds.com/issue/061207.htm)にする」を参照してください。

## <a name="summary"></a>要約

データドリブンアプリケーションを配置する際の主な課題は、データベースの配置に関するものです。 2つのバージョンのデータベース (開発環境に1つ、運用環境に存在する) があるため、開発時に新機能が追加されると、これら2つのデータベーススキーマは同期しなくなる可能性があります。 さらに、実稼働データベースは実際のユーザーからの実際のデータを使用して作成されているため、アプリケーションを構成するファイルを配置するときのように、変更された開発データベースで運用データベースを上書きすることはできません (ASP.NET ページ、画像ファイルなど)。 その代わりに、データベースを配置するには、前回の配置以降に運用データベースで開発データベースに加えられた変更の正確なセットを実装することが伴います。

このチュートリアルでは、データベースの変更のログを保持して適用するための3つの方法について説明しました。 最も簡単な方法は、prose で変更を記録することです。 これにより、これらの変更を実稼働データベースに手動で実装できるようになりますが、データベースオブジェクトを作成および変更するための SQL コマンドに関する知識は必要ありません。 より高度なアプローチと、複数の開発者を持つ大規模なプロジェクトまたはプロジェクトのつながりがはるかに多い場合は、変更を一連の SQL コマンドとして記録することをお勧めします。 これにより、これらの変更をターゲットデータベースにロールアウトすることが大幅に hastens されます。 どちらの方法も、Red Gate Software s SQL Compare などのデータベース比較ツールを使用して実現できます。

このチュートリアルでは、データドリブンアプリケーションの配置について説明します。 次の一連のチュートリアルでは、運用環境でのエラーに対応する方法について説明します。 ここでは、黄色い画面ではなく、わかりやすいエラーページを表示する方法について説明します。 エラーの詳細をログに記録する方法と、そのようなエラーが発生したときにアラートを通知する方法について説明します。

プログラミングを楽しんでください。

> [!div class="step-by-step"]
> [前へ](configuring-a-website-that-uses-application-services-vb.md)
> [次へ](displaying-a-custom-error-page-vb.md)
