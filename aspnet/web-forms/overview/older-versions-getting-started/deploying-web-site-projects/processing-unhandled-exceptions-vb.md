---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb
title: 未処理の例外の処理 (VB) |Microsoft Docs
author: rick-anderson
description: 運用環境の web アプリケーションでランタイムエラーが発生した場合は、開発者に通知し、エラーをログに記録して、la で診断できるようにすることが重要です。
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 051296f0-9519-4e78-835c-d868da13b0a0
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb
msc.type: authoredcontent
ms.openlocfilehash: 8d2e12af29bd95ce9898fa6a5e81be8b7a761f76
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78473638"
---
# <a name="processing-unhandled-exceptions-vb"></a><span data-ttu-id="c2957-103">未処理の例外を処理する (VB)</span><span class="sxs-lookup"><span data-stu-id="c2957-103">Processing Unhandled Exceptions (VB)</span></span>

<span data-ttu-id="c2957-104">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c2957-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c2957-105">[サンプル コードを表示またはダウンロード](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb/samples)します ([ダウンロード方法](/aspnet/core/tutorials/index#how-to-download-a-sample))。</span><span class="sxs-lookup"><span data-stu-id="c2957-105">[View or download sample code](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb/samples) ([how to download](/aspnet/core/tutorials/index#how-to-download-a-sample))</span></span>

> <span data-ttu-id="c2957-106">運用環境の web アプリケーションでランタイムエラーが発生した場合、開発者に通知し、後で診断できるようにエラーをログに記録することが重要です。</span><span class="sxs-lookup"><span data-stu-id="c2957-106">When a runtime error occurs on a web application in production it is important to notify a developer and to log the error so that it may be diagnosed at a later point in time.</span></span> <span data-ttu-id="c2957-107">このチュートリアルでは、ASP.NET が実行時エラーを処理し、未処理の例外が ASP.NET ランタイムにバブルアップするたびにカスタムコードを実行する方法の概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="c2957-107">This tutorial provides an overview of how ASP.NET processes runtime errors and looks at one way to have custom code execute whenever an unhandled exception bubbles up to the ASP.NET runtime.</span></span>

## <a name="introduction"></a><span data-ttu-id="c2957-108">はじめに</span><span class="sxs-lookup"><span data-stu-id="c2957-108">Introduction</span></span>

<span data-ttu-id="c2957-109">ASP.NET アプリケーションでハンドルされない例外が発生すると、ASP.NET ランタイムにバブルアップします。これにより、`Error` イベントが発生し、適切なエラーページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-109">When an unhandled exception occurs in an ASP.NET application, it bubbles up to the ASP.NET runtime, which raises the `Error` event and displays the appropriate error page.</span></span> <span data-ttu-id="c2957-110">エラーページには、次の3種類があります。ランタイムエラーの黄色い画面 (YSOD)例外の詳細 YSOD;およびカスタムエラーページ。</span><span class="sxs-lookup"><span data-stu-id="c2957-110">There are three different types of error pages: the Runtime Error Yellow Screen of Death (YSOD); the Exception Details YSOD; and custom error pages.</span></span> <span data-ttu-id="c2957-111">前の[チュートリアル](displaying-a-custom-error-page-vb.md)では、リモートユーザーのカスタムエラーページを使用するようにアプリケーションを構成し、ローカルにアクセスするユーザーの例外の詳細を YSOD しました。</span><span class="sxs-lookup"><span data-stu-id="c2957-111">In the [preceding tutorial](displaying-a-custom-error-page-vb.md) we configured the application to use a custom error page for remote users and the Exception Details YSOD for users visiting locally.</span></span>

<span data-ttu-id="c2957-112">サイトのルックアンドフィールと一致するユーザーフレンドリなカスタムエラーページを使用することをお勧めしますが、既定のランタイムエラー YSOD を使用することをお勧めします。ただし、カスタムエラーページを表示するのは、包括的なエラー処理ソリューションの一部にすぎません。</span><span class="sxs-lookup"><span data-stu-id="c2957-112">Using a human-friendly custom error page that matches the look and feel of the site is preferred to the default Runtime Error YSOD, but displaying a custom error page is only one part of a comprehensive error handling solution.</span></span> <span data-ttu-id="c2957-113">運用環境のアプリケーションでエラーが発生した場合は、例外の原因を解決して対処できるように、開発者にエラーの通知を受け取ることが重要です。</span><span class="sxs-lookup"><span data-stu-id="c2957-113">When an error occurs in an application in production, it is important that the developers are notified of the error so that they can unearth the cause of the exception and address it.</span></span> <span data-ttu-id="c2957-114">さらに、エラーの詳細をログに記録し、後でエラーを調査して診断できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-114">Furthermore, the error's details should be logged so that the error can be examined and diagnosed at a later point in time.</span></span>

<span data-ttu-id="c2957-115">このチュートリアルでは、未処理の例外の詳細にアクセスして、ログに記録し、開発者に通知できるようにする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="c2957-115">This tutorial shows how to access the details of an unhandled exception so that they can be logged and a developer notified.</span></span> <span data-ttu-id="c2957-116">この後の2つのチュートリアルでは、エラーログライブラリについて説明します。このライブラリでは、構成の少し後に、ランタイムエラーを開発者に自動的に通知し、その詳細をログに記録します。</span><span class="sxs-lookup"><span data-stu-id="c2957-116">The two tutorials following this one explore error logging libraries that, after a bit of configuration, will automatically notify developers of runtime errors and log their details.</span></span>

> [!NOTE]
> <span data-ttu-id="c2957-117">このチュートリアルでは、何らかの独自の方法で未処理の例外を処理する必要がある場合に、最も役立ちます。</span><span class="sxs-lookup"><span data-stu-id="c2957-117">The information examined in this tutorial is most useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="c2957-118">例外をログに記録するだけで、開発者に通知する必要がある場合は、エラーログライブラリを使用する方法があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-118">In cases where you only need to log the exception and notify a developer, using an error logging library is the way to go.</span></span> <span data-ttu-id="c2957-119">次の2つのチュートリアルでは、このような2つのライブラリの概要を説明します。</span><span class="sxs-lookup"><span data-stu-id="c2957-119">The next two tutorials provide an overview of two such libraries.</span></span>

## <a name="executing-code-when-theerrorevent-is-raised"></a><span data-ttu-id="c2957-120">`Error`イベントが発生したときのコードの実行</span><span class="sxs-lookup"><span data-stu-id="c2957-120">Executing Code When The`Error`Event Is Raised</span></span>

<span data-ttu-id="c2957-121">イベントは、興味深い問題が発生したことを通知するためのメカニズムと、応答でコードを実行するための別のオブジェクトを提供します。</span><span class="sxs-lookup"><span data-stu-id="c2957-121">Events provide an object a mechanism for signaling that something interesting has occurred, and for another object to execute code in response.</span></span> <span data-ttu-id="c2957-122">ASP.NET の開発者は、イベントの観点から考えることに慣れています。</span><span class="sxs-lookup"><span data-stu-id="c2957-122">As an ASP.NET developer you are accustomed to thinking in terms of events.</span></span> <span data-ttu-id="c2957-123">ビジターが特定のボタンをクリックしたときにコードを実行する場合は、そのボタンの `Click` イベントのイベントハンドラーを作成し、そこにコードを配置します。</span><span class="sxs-lookup"><span data-stu-id="c2957-123">If you want to run some code when the visitor clicks a particular Button, you create an event handler for that Button's `Click` event and put your code there.</span></span> <span data-ttu-id="c2957-124">未処理の例外が発生するたびに ASP.NET ランタイムが[`Error` イベント](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx)を発生させると、エラーの詳細をログに記録するためのコードがイベントハンドラーで発生することになります。</span><span class="sxs-lookup"><span data-stu-id="c2957-124">Given that the ASP.NET runtime raises its [`Error` event](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx) whenever an unhandled exception occurs, it follows that the code for logging the error's details would go in an event handler.</span></span> <span data-ttu-id="c2957-125">しかし、`Error` イベントのイベントハンドラーを作成するにはどうすればよいでしょうか。</span><span class="sxs-lookup"><span data-stu-id="c2957-125">But how do you create an event handler for the `Error` event?</span></span>

<span data-ttu-id="c2957-126">`Error` イベントは、要求の有効期間中に HTTP パイプラインの特定のステージで発生する、 [`HttpApplication` クラス](https://msdn.microsoft.com/library/system.web.httpapplication.aspx)の多くのイベントの1つです。</span><span class="sxs-lookup"><span data-stu-id="c2957-126">The `Error` event is one of many events in the [`HttpApplication` class](https://msdn.microsoft.com/library/system.web.httpapplication.aspx) that are raised at certain stages in the HTTP pipeline during the lifetime of a request.</span></span> <span data-ttu-id="c2957-127">たとえば、`HttpApplication` クラスの[`BeginRequest` イベント](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)は、すべての要求の開始時に発生します。この[`AuthenticateRequest` イベント](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)は、セキュリティモジュールによって要求元が識別されたときに発生します。</span><span class="sxs-lookup"><span data-stu-id="c2957-127">For example, the `HttpApplication` class's [`BeginRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx) is raised at the start of every request; its [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) is raised when a security module has identified the requestor.</span></span> <span data-ttu-id="c2957-128">これらの `HttpApplication` イベントは、ページ開発者が、要求の有効期間中のさまざまなポイントでカスタムロジックを実行する手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="c2957-128">These `HttpApplication` events give the page developer a means to execute custom logic at the various points in the lifetime of a request.</span></span>

<span data-ttu-id="c2957-129">`HttpApplication` イベントのイベントハンドラーは、`Global.asax`という名前の特殊なファイルに配置できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-129">Event handlers for the `HttpApplication` events can be placed in a special file named `Global.asax`.</span></span> <span data-ttu-id="c2957-130">このファイルを web サイトに作成するには、`Global.asax`という名前のグローバルアプリケーションクラステンプレートを使用して、web サイトのルートに新しい項目を追加します。</span><span class="sxs-lookup"><span data-stu-id="c2957-130">To create this file in your website, add a new item to the root of your website using the Global Application Class template with the name `Global.asax`.</span></span>

[![](processing-unhandled-exceptions-vb/_static/image2.png)](processing-unhandled-exceptions-vb/_static/image1.png)

<span data-ttu-id="c2957-131">**図 1**: Web アプリケーションに `Global.asax` を追加する</span><span class="sxs-lookup"><span data-stu-id="c2957-131">**Figure 1**: Add `Global.asax` To Your Web Application</span></span>  
 <span data-ttu-id="c2957-132">([クリックすると、フルサイズの画像が表示](processing-unhandled-exceptions-vb/_static/image3.png)される)</span><span class="sxs-lookup"><span data-stu-id="c2957-132">([Click to view full-size image](processing-unhandled-exceptions-vb/_static/image3.png))</span></span>

<span data-ttu-id="c2957-133">Visual Studio によって作成された `Global.asax` ファイルの内容と構造は、Web アプリケーションプロジェクト (WAP) と Web サイトプロジェクト (WSP) のどちらを使用しているかによって若干異なります。</span><span class="sxs-lookup"><span data-stu-id="c2957-133">The contents and structure of the `Global.asax` file created by Visual Studio differ slightly based on whether you are using a Web Application Project (WAP) or Web Site Project (WSP).</span></span> <span data-ttu-id="c2957-134">WAP を使用すると、`Global.asax` は `Global.asax` と `Global.asax.vb`という2つの個別のファイルとして実装されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-134">With a WAP, the `Global.asax` is implemented as two separate files - `Global.asax` and `Global.asax.vb`.</span></span> <span data-ttu-id="c2957-135">`Global.asax` ファイルには、`.vb` ファイルを参照する `@Application` ディレクティブは含まれていません。対象のイベントハンドラーは、`Global.asax.vb` ファイルで定義されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-135">The `Global.asax` file contains nothing but an `@Application` directive that references the `.vb` file; the event handlers of interest are defined in the `Global.asax.vb` file.</span></span> <span data-ttu-id="c2957-136">WSPs の場合、1つのファイルのみが作成され、`Global.asax`、およびイベントハンドラーが `<script runat="server">` ブロックで定義されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-136">For WSPs, only a single file is created, `Global.asax`, and the event handlers are defined in a `<script runat="server">` block.</span></span>

<span data-ttu-id="c2957-137">Visual Studio のグローバルアプリケーションクラステンプレートによって WAP に作成された `Global.asax` ファイルには、`Application_BeginRequest`、`Application_AuthenticateRequest`、および `Application_Error`という名前のイベントハンドラーが含まれています。これは、それぞれ `HttpApplication` イベント `BeginRequest`、`AuthenticateRequest`、および `Error`のイベントハンドラーです。</span><span class="sxs-lookup"><span data-stu-id="c2957-137">The `Global.asax` file created in a WAP by Visual Studio's Global Application Class template includes event handlers named `Application_BeginRequest`, `Application_AuthenticateRequest`, and `Application_Error`, which are event handlers for the `HttpApplication` events `BeginRequest`, `AuthenticateRequest`, and `Error`, respectively.</span></span> <span data-ttu-id="c2957-138">`Application_Start`、`Session_Start`、`Application_End`、および `Session_End`という名前のイベントハンドラーもあります。これは、web アプリケーションの起動時、新しいセッションが開始されたとき、アプリケーションが終了したとき、およびセッションが終了したときに起動するイベントハンドラーです。</span><span class="sxs-lookup"><span data-stu-id="c2957-138">There are also event handlers named `Application_Start`, `Session_Start`, `Application_End`, and `Session_End`, which are event handlers that fire when the web application starts, when a new session starts, when the application ends, and when a session ends, respectively.</span></span> <span data-ttu-id="c2957-139">WSP で Visual Studio によって作成された `Global.asax` ファイルには、`Application_Error`、`Application_Start`、`Session_Start`、`Application_End`、および `Session_End` のイベントハンドラーだけが含まれています。</span><span class="sxs-lookup"><span data-stu-id="c2957-139">The `Global.asax` file created in a WSP by Visual Studio contains just the `Application_Error`, `Application_Start`, `Session_Start`, `Application_End`, and `Session_End` event handlers.</span></span>

> [!NOTE]
> <span data-ttu-id="c2957-140">ASP.NET アプリケーションを展開する場合は、`Global.asax` ファイルを運用環境にコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-140">When deploying the ASP.NET application you need to copy the `Global.asax` file to the production environment.</span></span> <span data-ttu-id="c2957-141">このコードはプロジェクトのアセンブリにコンパイルされるため、WAP で作成された `Global.asax.vb` ファイルを運用環境にコピーする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c2957-141">The `Global.asax.vb` file, which is created in the WAP, does not need to be copied to production because this code is compiled into the project's assembly.</span></span>

<span data-ttu-id="c2957-142">Visual Studio のグローバルアプリケーションクラステンプレートによって作成されたイベントハンドラーは完全ではありません。</span><span class="sxs-lookup"><span data-stu-id="c2957-142">The event handlers created by Visual Studio's Global Application Class template are not exhaustive.</span></span> <span data-ttu-id="c2957-143">イベントハンドラー `Application_EventName`に名前を付けることで、任意の `HttpApplication` イベントのイベントハンドラーを追加できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-143">You can add an event handler for any `HttpApplication` event by naming the event handler `Application_EventName`.</span></span> <span data-ttu-id="c2957-144">たとえば、次のコードを `Global.asax` ファイルに追加して、 [`AuthorizeRequest` イベント](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)のイベントハンドラーを作成することができます。</span><span class="sxs-lookup"><span data-stu-id="c2957-144">For example, you could add the following code to the `Global.asax` file to create an event handler for the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx):</span></span>

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample1.vb)]

<span data-ttu-id="c2957-145">同様に、グローバルアプリケーションクラステンプレートによって作成されたイベントハンドラーは不要ですが、削除できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-145">Likewise, you can remove any event handlers created by the Global Application Class template that are not needed.</span></span> <span data-ttu-id="c2957-146">このチュートリアルでは、`Error` イベントのイベントハンドラーのみが必要です。`Global.asax` ファイルから他のイベントハンドラーを削除してもかまいません。</span><span class="sxs-lookup"><span data-stu-id="c2957-146">For this tutorial we only require an event handler for the `Error` event; feel free to remove the other event handlers from the `Global.asax` file.</span></span>

> [!NOTE]
> <span data-ttu-id="c2957-147">*HTTP モジュール*は、`HttpApplication` イベントのイベントハンドラーを定義する別の方法を提供します。</span><span class="sxs-lookup"><span data-stu-id="c2957-147">*HTTP Modules* offer another way to define event handlers for `HttpApplication` events.</span></span> <span data-ttu-id="c2957-148">HTTP モジュールはクラスファイルとして作成されます。これは、web アプリケーションプロジェクト内に直接配置することも、別のクラスライブラリに分割することもできます。</span><span class="sxs-lookup"><span data-stu-id="c2957-148">HTTP Modules are created as a class file that can be placed directly within the web application project or separated out into a separate class library.</span></span> <span data-ttu-id="c2957-149">HTTP モジュールはクラスライブラリに分けることができるため、`HttpApplication` のイベントハンドラーを作成するために、より柔軟で再利用可能なモデルを提供します。</span><span class="sxs-lookup"><span data-stu-id="c2957-149">Because they can be separated out into a class library, HTTP Modules offer a more flexible and reusable model for creating `HttpApplication` event handlers.</span></span> <span data-ttu-id="c2957-150">`Global.asax` ファイルは、そのファイルが存在する web アプリケーションに固有のものですが、http モジュールをアセンブリにコンパイルすることができます。この時点で、web サイトに HTTP モジュールを追加するのは、`Bin` フォルダー内のアセンブリを削除し `Web.config`にモジュールを登録するのと同じです。</span><span class="sxs-lookup"><span data-stu-id="c2957-150">Whereas the `Global.asax` file is specific to the web application where it resides, HTTP Modules can be compiled into assemblies, at which point adding the HTTP Module to a website is as simple as dropping the assembly in the `Bin` folder and registering the Module in `Web.config`.</span></span> <span data-ttu-id="c2957-151">このチュートリアルでは、HTTP モジュールの作成と使用については説明しませんが、次の2つのチュートリアルで使用される2つのエラーログライブラリは、HTTP モジュールとして実装されています。</span><span class="sxs-lookup"><span data-stu-id="c2957-151">This tutorial does not look at creating and using HTTP Modules, but the two error logging libraries used in the following two tutorials are implemented as HTTP Modules.</span></span> <span data-ttu-id="c2957-152">HTTP モジュールの利点の背景については、 [「Http モジュールとハンドラーを使用したプラグ可能な ASP.NET コンポーネントの作成](https://msdn.microsoft.com/library/aa479332.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c2957-152">For more background on the benefits of HTTP Modules refer to [Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components](https://msdn.microsoft.com/library/aa479332.aspx).</span></span>

## <a name="retrieving-information-about-the-unhandled-exception"></a><span data-ttu-id="c2957-153">未処理の例外に関する情報の取得</span><span class="sxs-lookup"><span data-stu-id="c2957-153">Retrieving Information About the Unhandled Exception</span></span>

<span data-ttu-id="c2957-154">この時点で、`Application_Error` イベントハンドラーを含む global.asax ファイルがあります。</span><span class="sxs-lookup"><span data-stu-id="c2957-154">At this point we have a Global.asax file with an `Application_Error` event handler.</span></span> <span data-ttu-id="c2957-155">このイベントハンドラーが実行されるときに、エラーを開発者に通知し、その詳細をログに記録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-155">When this event handler executes we need to notify a developer of the error and log its details.</span></span> <span data-ttu-id="c2957-156">これらのタスクを実行するには、最初に発生した例外の詳細を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-156">To accomplish these tasks we first need to determine the details of the exception that was raised.</span></span> <span data-ttu-id="c2957-157">サーバーオブジェクトの[`GetLastError` メソッド](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx)を使用して、`Error` イベントの発生原因となった未処理の例外の詳細を取得します。</span><span class="sxs-lookup"><span data-stu-id="c2957-157">Use the Server object's [`GetLastError` method](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx) to retrieve details of the unhandled exception that caused the `Error` event to fire.</span></span>

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample2.vb)]

<span data-ttu-id="c2957-158">`GetLastError` メソッドは、`Exception`型のオブジェクトを返します。これは、.NET Framework 内のすべての例外の基本型です。</span><span class="sxs-lookup"><span data-stu-id="c2957-158">The `GetLastError` method returns an object of type `Exception`, which is the base type for all exceptions in the .NET Framework.</span></span> <span data-ttu-id="c2957-159">ただし、上記のコードでは、`GetLastError` によって返された例外オブジェクトを `HttpException` オブジェクトにキャストしています。</span><span class="sxs-lookup"><span data-stu-id="c2957-159">However, in the code above I am casting the Exception object returned by `GetLastError` into an `HttpException` object.</span></span> <span data-ttu-id="c2957-160">ASP.NET リソースの処理中に例外がスローされたために `Error` イベントが発生している場合は、スローされた例外が `HttpException`内にラップされます。</span><span class="sxs-lookup"><span data-stu-id="c2957-160">If the `Error` event is being fired because an exception was thrown during the processing of an ASP.NET resource then the exception that was thrown is wrapped within an `HttpException`.</span></span> <span data-ttu-id="c2957-161">エラーイベントをよりする実際の例外を取得するには、`InnerException` プロパティを使用します。</span><span class="sxs-lookup"><span data-stu-id="c2957-161">To get the actual exception that precipitated the Error event use the `InnerException` property.</span></span> <span data-ttu-id="c2957-162">存在しないページの要求など、HTTP ベースの例外が原因で `Error` イベントが発生した場合、`HttpException` がスローされますが、内部例外はありません。</span><span class="sxs-lookup"><span data-stu-id="c2957-162">If the `Error` event was raised because of an HTTP-based exception, such as a request for a non-existent page, an `HttpException` is thrown, but it does not have an inner exception.</span></span>

<span data-ttu-id="c2957-163">次のコードでは、`GetLastErrormessage` を使用して、`Error` イベントをトリガーした例外に関する情報を取得し、`lastErrorWrapper`という名前の変数に `HttpException` を格納します。</span><span class="sxs-lookup"><span data-stu-id="c2957-163">The following code uses the `GetLastErrormessage` to retrieve information about the exception that triggered the `Error` event, storing the `HttpException` in a variable named `lastErrorWrapper`.</span></span> <span data-ttu-id="c2957-164">次に、元の例外の型、メッセージ、およびスタックトレースを3つの文字列変数に格納し、`lastErrorWrapper` が `Error` イベントをトリガーした実際の例外 (HTTP ベースの例外の場合) であるかどうか、または要求の処理中にスローされた例外の単なるラッパーであるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="c2957-164">It then stores the type, message, and stack trace of the originating exception in three string variables, checking to see if the `lastErrorWrapper` is the actual exception that triggered the `Error` event (in the case of HTTP-based exceptions) or if it's merely a wrapper for an exception that was thrown while processing the request.</span></span>

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample3.vb)]

<span data-ttu-id="c2957-165">この時点で、例外の詳細をデータベーステーブルに記録するコードを記述するために必要なすべての情報が用意されています。</span><span class="sxs-lookup"><span data-stu-id="c2957-165">At this point you have all the information you need to write code that will log the exception's details to a database table.</span></span> <span data-ttu-id="c2957-166">目的のエラー詳細 (型、メッセージ、スタックトレースなど) と、その他の有用な情報 (要求されたページの URL、現在ログオンしているユーザーの名前など) に対応した列を含むデータベーステーブルを作成できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-166">You could create a database table with columns for each of the error details of interest - the type, the message, the stack trace, and so on - along with other useful pieces of information, such as the URL of the requested page and the name of the currently logged on user.</span></span> <span data-ttu-id="c2957-167">次に、`Application_Error` イベントハンドラーで、データベースに接続し、テーブルにレコードを挿入します。</span><span class="sxs-lookup"><span data-stu-id="c2957-167">In the `Application_Error` event handler you would then connect to the database and insert a record into the table.</span></span> <span data-ttu-id="c2957-168">同様に、エラーの開発者に電子メールで通知するコードを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="c2957-168">Likewise, you could add code to alert a developer of the error via email.</span></span>

<span data-ttu-id="c2957-169">次の2つのチュートリアルで調査されているエラーログライブラリは、そのような機能を備えていないため、このエラーログと通知を自分で作成する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c2957-169">The error logging libraries examined in the next two tutorials provide such functionality out of the box, so there's no need to build this error logging and notification yourself.</span></span> <span data-ttu-id="c2957-170">ただし、`Error` イベントが発生していることと、`Application_Error` イベントハンドラーを使用してエラーの詳細をログに記録し、開発者に通知できることを示すために、エラーが発生したときに開発者に通知するコードを追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="c2957-170">However, to illustrate that the `Error` event is being raised and that the `Application_Error` event handler can be used to log error details and notify a developer, let's add code that notifies a developer when an error occurs.</span></span>

## <a name="notifying-a-developer-when-an-unhandled-exception-occurs"></a><span data-ttu-id="c2957-171">未処理の例外が発生したときに開発者に通知する</span><span class="sxs-lookup"><span data-stu-id="c2957-171">Notifying a Developer When an Unhandled Exception Occurs</span></span>

<span data-ttu-id="c2957-172">運用環境でハンドルされない例外が発生した場合は、開発チームに警告して、エラーを評価し、実行する必要があるアクションを決定できるようにすることが重要です。</span><span class="sxs-lookup"><span data-stu-id="c2957-172">When an unhandled exception occurs in the production environment it is important to alert the development team so that they can assess the error and determine what actions need to be taken.</span></span> <span data-ttu-id="c2957-173">たとえば、データベースへの接続中にエラーが発生した場合は、接続文字列をもう一度確認し、web ホスティング会社でサポートチケットを開く必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-173">For example, if there is an error in connecting to the database then you'll need to double check your connection string and, perhaps, open a support ticket with your web hosting company.</span></span> <span data-ttu-id="c2957-174">プログラミングエラーが原因で例外が発生した場合は、今後このようなエラーを防ぐために、追加のコードまたは検証ロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-174">If the exception occurred because of a programming error, additional code or validation logic may need to be added to prevent such errors in the future.</span></span>

<span data-ttu-id="c2957-175">[`System.Net.Mail` 名前空間](https://msdn.microsoft.com/library/system.net.mail.aspx)の .NET Framework クラスを使用すると、簡単に電子メールを送信できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-175">The .NET Framework classes in the [`System.Net.Mail` namespace](https://msdn.microsoft.com/library/system.net.mail.aspx) make it easy to send an email.</span></span> <span data-ttu-id="c2957-176">[`MailMessage` クラス](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)は、電子メールメッセージを表し、`To`、`From`、`Subject`、`Body`、`Attachments`のようなプロパティを持ちます。</span><span class="sxs-lookup"><span data-stu-id="c2957-176">The [`MailMessage` class](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) represents an email message and has properties like `To`, `From`, `Subject`, `Body`, and `Attachments`.</span></span> <span data-ttu-id="c2957-177">`SmtpClass` は、指定された SMTP サーバーを使用して `MailMessage` オブジェクトを送信するために使用されます。SMTP サーバーの設定は、プログラムで指定することも、`Web.config file`の[`<system.net>` 要素](https://msdn.microsoft.com/library/6484zdc1.aspx)で宣言して指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="c2957-177">The `SmtpClass` is used to send a `MailMessage` object using a specified SMTP server; the SMTP server settings can be specified programmatically or declaratively in the [`<system.net>` element](https://msdn.microsoft.com/library/6484zdc1.aspx) in the `Web.config file`.</span></span> <span data-ttu-id="c2957-178">ASP.NET アプリケーションで電子メールメッセージを送信する方法の詳細については、記事「 [ASP.NET で電子メールを送信](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)する」および「 [System .NET メールの FAQ](http://systemnetmail.com/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c2957-178">For more information on sending email messages in an ASP.NET application check out my article, [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx), and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>

> [!NOTE]
> <span data-ttu-id="c2957-179">`<system.net>` 要素には、電子メールの送信時に `SmtpClient` クラスによって使用される SMTP サーバー設定が含まれます。</span><span class="sxs-lookup"><span data-stu-id="c2957-179">The `<system.net>` element contains the SMTP server settings used by the `SmtpClient` class when sending an email.</span></span> <span data-ttu-id="c2957-180">Web ホスティング会社には、アプリケーションから電子メールを送信するために使用できる SMTP サーバーがある可能性があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-180">Your web hosting company likely has an SMTP server that you can use to send email from your application.</span></span> <span data-ttu-id="c2957-181">Web アプリケーションで使用する SMTP サーバーの設定については、web ホストのサポートセクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="c2957-181">Consult your web host's support section for information on the SMTP server settings you should use in your web application.</span></span>

<span data-ttu-id="c2957-182">次のコードを `Application_Error` イベントハンドラーに追加して、エラーが発生したときに開発者に電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="c2957-182">Add the following code to the `Application_Error` event handler to send a developer an email when an error occurs:</span></span>

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample4.vb)]

<span data-ttu-id="c2957-183">上記のコードは非常に時間がかかりますが、多くの場合、開発者に送信される電子メールに表示される HTML が作成されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-183">While the above code is quite lengthy, the bulk of it creates the HTML that appears in the email sent to the developer.</span></span> <span data-ttu-id="c2957-184">このコードは、`GetLastError` メソッド (`lastErrorWrapper`) によって返される `HttpException` を参照することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-184">The code starts by referencing the `HttpException` returned by the `GetLastError` method (`lastErrorWrapper`).</span></span> <span data-ttu-id="c2957-185">要求によって発生した実際の例外は `lastErrorWrapper.InnerException` を通じて取得され、`lastError`変数に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="c2957-185">The actual exception that was raised by the request is retrieved via `lastErrorWrapper.InnerException` and is assigned to the variable `lastError`.</span></span> <span data-ttu-id="c2957-186">型、メッセージ、およびスタックトレース情報は `lastError` から取得され、3つの文字列変数に格納されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-186">The type, message, and stack trace information is retrieved from `lastError` and stored in three string variables.</span></span>

<span data-ttu-id="c2957-187">次に、`mm` という名前の `MailMessage` オブジェクトが作成されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-187">Next, a `MailMessage` object named `mm` is created.</span></span> <span data-ttu-id="c2957-188">電子メールの本文は HTML 形式で、要求されたページの URL、現在ログオンしているユーザーの名前、例外に関する情報 (種類、メッセージ、スタックトレース) が表示されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-188">The email body is HTML formatted and displays the URL of the requested page, the name of the currently logged on user, and information about the exception (the type, message, and stack trace).</span></span> <span data-ttu-id="c2957-189">`HttpException` クラスの優れた点の1つは、 [GetHtmlErrorMessage メソッド](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx)を呼び出すことによって、例外の詳細を作成するために使用する HTML (YSOD) を生成できることです。</span><span class="sxs-lookup"><span data-stu-id="c2957-189">One of the cool things about the `HttpException` class is that you can generate the HTML used to create the Exception Details Yellow Screen of Death (YSOD) by calling the [GetHtmlErrorMessage method](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx).</span></span> <span data-ttu-id="c2957-190">ここでは、このメソッドを使用して例外の詳細を取得し、YSOD マークアップを添付ファイルとして電子メールに追加します。</span><span class="sxs-lookup"><span data-stu-id="c2957-190">This method is used here to retrieve the Exception Details YSOD markup and add it to the email as an attachment.</span></span> <span data-ttu-id="c2957-191">注意点の1つとして、`Error` イベントをトリガーした例外が HTTP ベースの例外 (存在しないページの要求など) だった場合、`GetHtmlErrorMessage` メソッドは `null`を返します。</span><span class="sxs-lookup"><span data-stu-id="c2957-191">One word of caution: if the exception that triggered the `Error` event was an HTTP-based exception (such as a request for a non-existent page) then the `GetHtmlErrorMessage` method will return `null`.</span></span>

<span data-ttu-id="c2957-192">最後の手順では、`MailMessage`を送信します。</span><span class="sxs-lookup"><span data-stu-id="c2957-192">The final step is to send the `MailMessage`.</span></span> <span data-ttu-id="c2957-193">これを行うには、新しい `SmtpClient` メソッドを作成し、その `Send` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="c2957-193">This is done by creating a new `SmtpClient` method and calling its `Send` method.</span></span>

> [!NOTE]
> <span data-ttu-id="c2957-194">このコードを web アプリケーションで使用する前に、`ToAddress` および `FromAddress` 定数の値を support@example.com から、エラー通知電子メールの送信先と送信元の電子メールアドレスに変更します。</span><span class="sxs-lookup"><span data-stu-id="c2957-194">Before using this code in your web application you'll want to change the values in the `ToAddress` and `FromAddress` constants from support@example.com to whatever email address the error notification email should be sent to and originate from.</span></span> <span data-ttu-id="c2957-195">また、`Web.config`の [`<system.net>`] セクションで、SMTP サーバー設定を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-195">You'll also need to specify SMTP server settings in the `<system.net>` section in `Web.config`.</span></span> <span data-ttu-id="c2957-196">使用する SMTP サーバーの設定を確認するには、web ホストプロバイダーに問い合わせてください。</span><span class="sxs-lookup"><span data-stu-id="c2957-196">Consult your web host provider to determine the SMTP server settings to use.</span></span>

<span data-ttu-id="c2957-197">このコードは、エラーが発生すると、エラーの概要と YSOD を含む電子メールメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="c2957-197">With this code in place anytime there's an error the developer is sent an email message that summarizes the error and includes the YSOD.</span></span> <span data-ttu-id="c2957-198">前のチュートリアルでは、Genre .aspx にアクセスして、`Genre.aspx?ID=foo`のようなクエリ文字列を使用して無効な `ID` 値を渡すことで、ランタイムエラーを例示しています。</span><span class="sxs-lookup"><span data-stu-id="c2957-198">In the preceding tutorial we demonstrated a runtime error by visiting Genre.aspx and passing in an invalid `ID` value through the querystring, like `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="c2957-199">`Global.asax` ファイルが配置されているページにアクセスすると、前のチュートリアルと同じユーザーエクスペリエンスが得られます。開発環境では、[例外の詳細] の黄色い画面が引き続き表示されます。運用環境では、カスタムエラーページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-199">Visiting the page with the `Global.asax` file in place produces the same user experience as in the preceding tutorial - in the development environment you'll continue to see the Exception Details Yellow Screen of Death, while in the production environment you'll see the custom error page.</span></span> <span data-ttu-id="c2957-200">この既存の動作に加えて、開発者に電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-200">In addition to this existing behavior, the developer is sent an email.</span></span>

<span data-ttu-id="c2957-201">**図 2**は、`Genre.aspx?ID=foo`にアクセスしたときに受信した電子メールを示しています。</span><span class="sxs-lookup"><span data-stu-id="c2957-201">**Figure 2** shows the email received when visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="c2957-202">電子メールの本文に例外情報がまとめられ、`YSOD.htm` 添付ファイルには、例外の詳細 YSOD に表示される内容が表示されます (**図 3**を参照)。</span><span class="sxs-lookup"><span data-stu-id="c2957-202">The email body summarizes the exception information, while the `YSOD.htm` attachment displays the content that is shown in the Exception Details YSOD (see **Figure 3**).</span></span>

[![](processing-unhandled-exceptions-vb/_static/image5.png)](processing-unhandled-exceptions-vb/_static/image4.png)

<span data-ttu-id="c2957-203">**図 2**: 未処理の例外が発生するたびに、開発者に電子メール通知が送信される</span><span class="sxs-lookup"><span data-stu-id="c2957-203">**Figure 2**: The Developer Is Sent An Email Notification Whenever There's An Unhandled Exception</span></span>  
 <span data-ttu-id="c2957-204">([クリックすると、フルサイズの画像が表示](processing-unhandled-exceptions-vb/_static/image6.png)される)</span><span class="sxs-lookup"><span data-stu-id="c2957-204">([Click to view full-size image](processing-unhandled-exceptions-vb/_static/image6.png))</span></span>

[![](processing-unhandled-exceptions-vb/_static/image8.png)](processing-unhandled-exceptions-vb/_static/image7.png)

<span data-ttu-id="c2957-205">**図 3**: 電子メール通知に、添付ファイルとしての例外の詳細 YSOD が含まれている</span><span class="sxs-lookup"><span data-stu-id="c2957-205">**Figure 3**: The Email Notification Includes the Exception Details YSOD As An Attachment</span></span>  
 <span data-ttu-id="c2957-206">([クリックすると、フルサイズの画像が表示](processing-unhandled-exceptions-vb/_static/image9.png)される)</span><span class="sxs-lookup"><span data-stu-id="c2957-206">([Click to view full-size image](processing-unhandled-exceptions-vb/_static/image9.png))</span></span>

## <a name="what-about-using-the-custom-error-page"></a><span data-ttu-id="c2957-207">カスタムエラーページを使用するにはどうすればよいですか。</span><span class="sxs-lookup"><span data-stu-id="c2957-207">What About Using the Custom Error Page?</span></span>

<span data-ttu-id="c2957-208">このチュートリアルでは、`Global.asax` と `Application_Error` イベントハンドラーを使用して、ハンドルされない例外が発生したときにコードを実行する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="c2957-208">This tutorial showed how to use `Global.asax` and the `Application_Error` event handler to execute code when an unhandled exception occurs.</span></span> <span data-ttu-id="c2957-209">具体的には、このイベントハンドラーを使用して、開発者にエラーを通知します。さらに、エラーの詳細をデータベースに記録するように拡張することもできます。</span><span class="sxs-lookup"><span data-stu-id="c2957-209">Specifically, we used this event handler to notify a developer of an error; we could extend it to also log the error details in a database.</span></span> <span data-ttu-id="c2957-210">`Application_Error` イベントハンドラーが存在しても、エンドユーザーのエクスペリエンスには影響しません。</span><span class="sxs-lookup"><span data-stu-id="c2957-210">The presence of the `Application_Error` event handler does not affect the end user's experience.</span></span> <span data-ttu-id="c2957-211">構成されたエラーページは、エラーの詳細 YSOD、ランタイムエラー YSOD、またはカスタムエラーページで確認できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-211">They still see the configured error page, be it the Error Details YSOD, the Runtime Error YSOD, or the custom error page.</span></span>

<span data-ttu-id="c2957-212">カスタムエラーページを使用する場合は、`Global.asax` ファイルと `Application_Error` イベントが必要かどうかを気にするのが自然です。</span><span class="sxs-lookup"><span data-stu-id="c2957-212">It's natural to wonder whether the `Global.asax` file and `Application_Error` event is necessary when using a custom error page.</span></span> <span data-ttu-id="c2957-213">エラーが発生すると、ユーザーにはカスタムエラーページが表示されるので、開発者に通知するコードを配置して、エラーの詳細をカスタムエラーページの分離コードクラスに記録することはできません。</span><span class="sxs-lookup"><span data-stu-id="c2957-213">When an error occurs the user is shown the custom error page so why can't we put the code to notify the developer and log the error details into the code-behind class of the custom error page?</span></span> <span data-ttu-id="c2957-214">カスタムエラーページの分離コードクラスにコードを追加することはできますが、前のチュートリアルで説明した手法を使用すると、`Error` イベントをトリガーした例外の詳細にアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="c2957-214">While you can certainly add code to the custom error page's code-behind class you do not have access to the details of the exception that triggered the `Error` event when using the technique we explored in the preceding tutorial.</span></span> <span data-ttu-id="c2957-215">カスタムエラーページから `GetLastError` メソッドを呼び出すと、`Nothing`が返されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-215">Calling the `GetLastError` method from the custom error page returns `Nothing`.</span></span>

<span data-ttu-id="c2957-216">この動作が発生する理由は、リダイレクトを使用してカスタムエラーページに到達したためです。</span><span class="sxs-lookup"><span data-stu-id="c2957-216">The reason for this behavior is because the custom error page is reached via a redirect.</span></span> <span data-ttu-id="c2957-217">未処理の例外が ASP.NET ランタイムに到達すると、ASP.NET エンジンはその `Error` イベント (`Application_Error` イベントハンドラーを実行) を発生させ、`Response.Redirect(customErrorPageUrl)`を発行して、ユーザーをカスタムエラーページに*リダイレクト*します。</span><span class="sxs-lookup"><span data-stu-id="c2957-217">When an unhandled exception reaches the ASP.NET runtime the ASP.NET engine raises its `Error` event (which executes the `Application_Error` event handler) and then *redirects* the user to the custom error page by issuing a `Response.Redirect(customErrorPageUrl)`.</span></span> <span data-ttu-id="c2957-218">`Response.Redirect` メソッドは、HTTP 302 ステータスコードを使用してクライアントに応答を送信し、ブラウザーに新しい URL を要求するよう指示します。具体的には、カスタムエラーページを使用します。</span><span class="sxs-lookup"><span data-stu-id="c2957-218">The `Response.Redirect` method sends a response to the client with an HTTP 302 status code, instructing the browser to request a new URL, namely the custom error page.</span></span> <span data-ttu-id="c2957-219">ブラウザーは、この新しいページを自動的に要求します。</span><span class="sxs-lookup"><span data-stu-id="c2957-219">The browser then automatically requests this new page.</span></span> <span data-ttu-id="c2957-220">カスタムエラーページは、ブラウザーのアドレスバーがカスタムエラーページの URL に変更されるため、エラーが発生したページとは別に要求されていることがわかります (**図 4**を参照)。</span><span class="sxs-lookup"><span data-stu-id="c2957-220">You can tell that the custom error page was requested separately from the page where the error originated because the browser's Address bar changes to the custom error page URL (see **Figure 4**).</span></span>

[![](processing-unhandled-exceptions-vb/_static/image11.png)](processing-unhandled-exceptions-vb/_static/image10.png)

<span data-ttu-id="c2957-221">**図 4**: エラーが発生すると、ブラウザーはカスタムエラーページの URL にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="c2957-221">**Figure 4**: When an Error Occurs the Browser Gets Redirected to the Custom Error Page URL</span></span>  
 <span data-ttu-id="c2957-222">([クリックすると、フルサイズの画像が表示](processing-unhandled-exceptions-vb/_static/image12.png)される)</span><span class="sxs-lookup"><span data-stu-id="c2957-222">([Click to view full-size image](processing-unhandled-exceptions-vb/_static/image12.png))</span></span>

<span data-ttu-id="c2957-223">実質的な効果は、サーバーが HTTP 302 リダイレクトで応答すると、ハンドルされない例外が発生した要求が終了することです。</span><span class="sxs-lookup"><span data-stu-id="c2957-223">The net effect is that the request where the unhandled exception occurred ends when the server responds with the HTTP 302 redirect.</span></span> <span data-ttu-id="c2957-224">カスタムエラーページへの後続の要求は、新しい要求です。この時点までに、ASP.NET エンジンはエラー情報を破棄し、さらに、前の要求のハンドルされない例外を、カスタムエラーページの新しい要求と関連付けることができません。</span><span class="sxs-lookup"><span data-stu-id="c2957-224">The subsequent request to the custom error page is a brand new request; by this point the ASP.NET engine has discarded the error information and, moreover, has no way to associate the unhandled exception in the previous request with the new request for the custom error page.</span></span> <span data-ttu-id="c2957-225">このため、カスタムエラーページから呼び出されたときに `GetLastError` `null` 返されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-225">This is why `GetLastError` returns `null` when called from the custom error page.</span></span>

<span data-ttu-id="c2957-226">ただし、エラーの原因となった同じ要求でカスタムエラーページを実行することもできます。</span><span class="sxs-lookup"><span data-stu-id="c2957-226">However, it is possible to have the custom error page executed during the same request that caused the error.</span></span> <span data-ttu-id="c2957-227">[`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx)メソッドは、指定された URL に実行を転送し、同じ要求内でそれを処理します。</span><span class="sxs-lookup"><span data-stu-id="c2957-227">The [`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx) method transfers execution to the specified URL and processes it within the same request.</span></span> <span data-ttu-id="c2957-228">`Application_Error` イベントハンドラー内のコードをカスタムエラーページの分離コードクラスに移動し、`Global.asax` 内のコードを次のコードに置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="c2957-228">You could move the code in the `Application_Error` event handler to the custom error page's code-behind class, replacing it in `Global.asax` with the following code:</span></span>

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample5.vb)]

<span data-ttu-id="c2957-229">ハンドルされない例外が発生すると、`Application_Error` イベントハンドラーは、HTTP 状態コードに基づいて、適切なカスタムエラーページに制御を転送します。</span><span class="sxs-lookup"><span data-stu-id="c2957-229">Now when an unhandled exception occurs the `Application_Error` event handler transfers control to the appropriate custom error page based on the HTTP status code.</span></span> <span data-ttu-id="c2957-230">コントロールが転送されたため、カスタムエラーページは `Server.GetLastError` 経由でハンドルされない例外情報にアクセスできるようになり、エラーを開発者に通知し、その詳細をログに記録できます。</span><span class="sxs-lookup"><span data-stu-id="c2957-230">Because control was transferred, the custom error page has access to the unhandled exception information via `Server.GetLastError` and can notify a developer of the error and log its details.</span></span> <span data-ttu-id="c2957-231">`Server.Transfer` の呼び出しでは、ASP.NET エンジンによって、ユーザーがカスタムエラーページにリダイレクトされるのを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="c2957-231">The `Server.Transfer` call stops the ASP.NET engine from redirecting the user to the custom error page.</span></span> <span data-ttu-id="c2957-232">代わりに、カスタムエラーページのコンテンツが、エラーを生成したページへの応答として返されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-232">Instead, the custom error page's content is returned as the response to the page that generated the error.</span></span>

## <a name="summary"></a><span data-ttu-id="c2957-233">まとめ</span><span class="sxs-lookup"><span data-stu-id="c2957-233">Summary</span></span>

<span data-ttu-id="c2957-234">ASP.NET web アプリケーションでハンドルされない例外が発生すると、ASP.NET ランタイムによって `Error` イベントが発生し、構成されたエラーページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c2957-234">When an unhandled exception occurs in an ASP.NET web application the ASP.NET runtime raises the `Error` event and displays the configured error page.</span></span> <span data-ttu-id="c2957-235">エラーイベントのイベントハンドラーを作成することによって、エラーを開発者に通知したり、その詳細をログに記録したり、他の方法で処理したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="c2957-235">We can notify the developer of the error, log its details, or process it in some other fashion, by creating an event handler for the Error event.</span></span> <span data-ttu-id="c2957-236">`Global.asax` ファイルまたは HTTP モジュールから `Error`のような `HttpApplication` イベントのイベントハンドラーを作成するには、次の2つの方法があります。</span><span class="sxs-lookup"><span data-stu-id="c2957-236">There are two ways to create an event handler for `HttpApplication` events like `Error`: in the `Global.asax` file or from an HTTP Module.</span></span> <span data-ttu-id="c2957-237">このチュートリアルでは、`Global.asax` ファイルに `Error` イベントハンドラーを作成して、電子メールメッセージを使ってエラーを開発者に通知する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="c2957-237">This tutorial showed how to create an `Error` event handler in the `Global.asax` file that notifies developers of an error by means of an email message.</span></span>

<span data-ttu-id="c2957-238">`Error` イベントハンドラーの作成は、何らかの独自の方法で未処理の例外を処理する必要がある場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="c2957-238">Creating an `Error` event handler is useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="c2957-239">ただし、例外をログに記録したり開発者に通知したりするために独自の `Error` イベントハンドラーを作成することは、時間をできるだけ効率的に使用することではありません。既に存在していて、数分でも設定できるエラーログライブラリが既に存在しているためです。</span><span class="sxs-lookup"><span data-stu-id="c2957-239">However, creating your own `Error` event handler to log the exception or to notify a developer is not the most efficient use of your time as there already exist free and easy to use error logging libraries that can be setup in a matter of minutes.</span></span> <span data-ttu-id="c2957-240">次の2つのチュートリアルでは、2つのライブラリを確認します。</span><span class="sxs-lookup"><span data-stu-id="c2957-240">The next two tutorials examine two such libraries.</span></span>

<span data-ttu-id="c2957-241">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="c2957-241">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="c2957-242">参考資料</span><span class="sxs-lookup"><span data-stu-id="c2957-242">Further Reading</span></span>

<span data-ttu-id="c2957-243">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="c2957-243">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="c2957-244">ASP.NET HTTP モジュールと HTTP ハンドラーの概要</span><span class="sxs-lookup"><span data-stu-id="c2957-244">ASP.NET HTTP Modules and HTTP Handlers Overview</span></span>](https://support.microsoft.com/kb/307985)
- [<span data-ttu-id="c2957-245">未処理の例外への適切な応答-未処理の例外の処理</span><span class="sxs-lookup"><span data-stu-id="c2957-245">Gracefully Responding to Unhandled Exceptions - Processing Unhandled Exceptions</span></span>](http://aspnet.4guysfromrolla.com/articles/091306-1.aspx)
- [<span data-ttu-id="c2957-246">`HttpApplication` クラスと ASP.NET Application オブジェクト</span><span class="sxs-lookup"><span data-stu-id="c2957-246">`HttpApplication` Class and the ASP.NET Application Object</span></span>](http://www.eggheadcafe.com/articles/20030211.asp)
- [<span data-ttu-id="c2957-247">ASP.NET の HTTP ハンドラーと HTTP モジュール</span><span class="sxs-lookup"><span data-stu-id="c2957-247">HTTP Handlers and HTTP Modules in ASP.NET</span></span>](http://www.15seconds.com/Issue/020417.htm)
- [<span data-ttu-id="c2957-248">ASP.NET で電子メールを送信しています</span><span class="sxs-lookup"><span data-stu-id="c2957-248">Sending Email in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [<span data-ttu-id="c2957-249">`Global.asax` ファイルについて</span><span class="sxs-lookup"><span data-stu-id="c2957-249">Understanding the `Global.asax` File</span></span>](http://aspalliance.com/1114_Understanding_the_Globalasax_file.all)
- [<span data-ttu-id="c2957-250">HTTP モジュールとハンドラーを使用してプラグ可能な ASP.NET コンポーネントを作成する</span><span class="sxs-lookup"><span data-stu-id="c2957-250">Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components</span></span>](https://msdn.microsoft.com/library/aa479332.aspx)
- [<span data-ttu-id="c2957-251">ASP.NET `Global.asax` ファイルの操作</span><span class="sxs-lookup"><span data-stu-id="c2957-251">Working with the ASP.NET `Global.asax` File</span></span>](http://articles.techrepublic.com.com/5100-10878_11-5771721.html)
- [<span data-ttu-id="c2957-252">`HttpApplication` インスタンスの操作</span><span class="sxs-lookup"><span data-stu-id="c2957-252">Working with `HttpApplication` Instances</span></span>](https://msdn.microsoft.com/library/a0xez8f2.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="c2957-253">[前へ](displaying-a-custom-error-page-vb.md)
> [次へ](logging-error-details-with-asp-net-health-monitoring-vb.md)</span><span class="sxs-lookup"><span data-stu-id="c2957-253">[Previous](displaying-a-custom-error-page-vb.md)
[Next](logging-error-details-with-asp-net-health-monitoring-vb.md)</span></span>
