---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/deploying-a-database-cs
title: データベースの配置 (C#) |Microsoft Docs
author: rick-anderson
description: ASP.NET web アプリケーションを配置するには、開発環境から運用環境に必要なファイルとリソースを取得する必要があります。 Da の場合...
ms.author: riande
ms.date: 04/23/2009
ms.assetid: ff537a10-9f1f-43fe-9bcb-3dda161ba8f5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/deploying-a-database-cs
msc.type: authoredcontent
ms.openlocfilehash: 83657be794e1ea31f6ad2f2b4adc274724d60cf2
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78518320"
---
# <a name="deploying-a-database-c"></a>データベースを配置する (C#)

[Scott Mitchell](https://twitter.com/ScottOnWriting)

[コードのダウンロード](https://download.microsoft.com/download/E/6/F/E6FE3A1F-EE3A-4119-989A-33D1A9F6F6DD/ASPNET_Hosting_Tutorial_07_CS.zip)または[PDF のダウンロード](https://download.microsoft.com/download/C/3/9/C391A649-B357-4A7B-BAA4-48C96871FEA6/aspnet_tutorial07_DeployDB_cs.pdf)

> ASP.NET web アプリケーションを配置するには、開発環境から運用環境に必要なファイルとリソースを取得する必要があります。 データドリブン web アプリケーションの場合、これにはデータベーススキーマとデータが含まれます。 このチュートリアルは、開発環境から実稼働環境にデータベースを正常に配置するために必要な手順を説明するシリーズの最初のものです。

## <a name="introduction"></a>はじめに

ASP.NET web アプリケーションを配置するには、開発環境から運用環境に必要なファイルとリソースを取得する必要があります。 これまでに説明した6つのチュートリアルの中で、単純な書籍レビュー web アプリケーションをデプロイしました。 このデモサイトは、多くのサーバー側リソース (ASP.NET ページ、構成ファイル、`Web.sitemap` ファイルなど) で構成されており、イメージや CSS ファイルなどのクライアント側のリソースと共に使用されていました。 しかし、データドリブンの web アプリケーションはどうでしょうか。 データベースを使用する web アプリケーションをデプロイするには、追加の手順を実行する必要がありますか。

次のいくつかのチュートリアルでは、データドリブン web アプリケーションを配置するために必要な手順について説明します。 このチュートリアルでは、まず、データベースのスキーマとコンテンツを開発環境から運用環境に取得する方法について説明します。次のチュートリアルでは、必要な構成変更について説明します。 ここでは、アプリケーションサービス (メンバーシップ、ロール、プロファイルなど) を使用するデータベースを配置する際の課題について説明します。

## <a name="examining-the-updated-book-reviews-web-application"></a>更新された書籍レビュー Web アプリケーションを調べる

データドリブン web アプリケーションのデプロイをデモンストレーションするために、ブックレビュー web アプリケーションを単純な静的な web サイトからデータドリブンの web サイトに更新しました。 前と同様に、このチュートリアルのダウンロードには、Web アプリケーションプロジェクトモデルを使用するアプリケーションと、Web サイトプロジェクトモデルを使用するアプリケーションの2つのバージョンがあります。

更新された書籍レビュー web アプリケーションでは、 [SQL Server 2008 Express Edition](https://www.microsoft.com/express/sql/default.aspx)データベースが使用されています。このデータベースは、サイト `App_Data` フォルダー (`~/App_Data/Reviews.mdf`) に格納されています。 コンピューターに SQL Server 2008 がインストールされている場合は、エラーなしでデモを実行する必要があります。 以前のバージョンの SQL Server がある場合は、free SQL Server 2008 Express Edition をインストールするか、このチュートリアルのダウンロードで入手可能なデータベーススクリプトを使用してデータベースを自分で作成することができます。

`Reviews.mdf` データベースには、次の4つのテーブルが含まれています。

- `Genres`-各ジャンルのレコード (テクノロジ、架空、ビジネスなど) が含まれます。
- `Books`-各レビューのレコードと、`Title`、`GenreId`、`ReviewDate`、`Review`などの列が含まれます。
- `Authors`-レビューされた本を投稿した各作成者に関する情報が含まれています。
- `BooksAuthors`-作成者がどのブックを記述したかを指定する多対多の結合テーブル。

図1は、これら4つのテーブルの ER 図を示しています。

[書籍レビュー Web アプリケーション s データベースは、4つのテーブルで構成されて ![ます。](deploying-a-database-cs/_static/image2.jpg)](deploying-a-database-cs/_static/image1.jpg) 

**図 1**: 書籍レビュー Web アプリケーション s データベースは4つのテーブルで構成されています ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image3.jpg)されます)

以前のバージョンの書籍レビュー web サイトには、書籍ごとに個別の ASP.NET ページがありました。 たとえば、`~/Tech/TYASP35.aspx` という名前のページがありました。このページには、 *24 時間で ASP.NET 3.5 を教える*ためのレビューが含まれていました。 この新しいデータドリブンバージョンの web サイトには、データベースに保存されているレビューと1つの ASP.NET ページがあります。*これには*、指定された書籍のレビューが表示されます。 同様に、指定したジャンルのレビュー対象のブックを一覧表示する Genre. .aspx? ID =*Genreid*ページがあります。

図2と図3は、`Genre.aspx` と `Review.aspx` のページが動作していることを示しています。 各ページのアドレスバーの URL に注意してください。 図2では、Genre. .aspx? ID = 85d164ba-112347 c47-82a0-c8ec75de7e0e です。 85d164ba112347 c47-82a0-c8ec75de7e0e はテクノロジのジャンルの `GenreId` 値であるため、ページの見出しは "テクノロジレビュー" を読み取り、箇条書きリストは、このジャンルに分類されているサイト上のレビューを列挙します。

[[テクノロジのジャンル] ページ ![](deploying-a-database-cs/_static/image5.jpg)](deploying-a-database-cs/_static/image4.jpg) 

**図 2**: [テクノロジのジャンル] ページ ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image6.jpg)されます)

[ASP.NET 3.5 のレビューを24時間で ![](deploying-a-database-cs/_static/image8.jpg)](deploying-a-database-cs/_static/image7.jpg) 

**図 3**: *24 時間で3.5 を ASP.NET*していることを確認[する (クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image9.jpg)されます)

また、書籍レビュー web アプリケーションには、管理者がジャンル、レビュー、および作成者情報の追加、編集、削除を行うことができる管理セクションも含まれています。 現在、すべての訪問者は、[管理] セクションにアクセスできます。 今後のチュートリアルでは、ユーザーアカウントのサポートを追加し、管理ページへの承認されたユーザーのみを許可します。

Book review アプリケーションをダウンロードする場合は、その目的はデータドリブンアプリケーションの配置を示すことを念頭に置いてください。 アプリケーションの設計に関しては、ベストプラクティスは示されていません。 たとえば、個別のデータアクセス層 (DAL) はありません。ASP.NET ページは、分離コードクラスの SqlDataSource コントロールまたは ADO.NET コードを使用して、データベースと直接通信します。 階層型アーキテクチャを使用したデータドリブンアプリケーションの作成の詳細については、「 [*データチュートリアルの*](../../data-access/index.md)使用」を参照してください。

## <a name="databases-on-development-versus-production"></a>開発中のデータベースと運用環境

データドリブン web アプリケーションで開発を開始する場合は、データベース接続文字列を指定する必要があります。これにより、データベースへの接続方法に関するアプリケーションの詳細が提供されます。 この接続文字列は、特にデータベースサーバー、データベース名、およびセキュリティ情報を指定します。 多くの場合、開発中にアプリケーションで使用されるデータベースは、実稼働環境で使用されるデータベースとは異なります。 開発と運用のために異なるデータベースを使用することには多くの利点があります。 開発中のデータベースが異なると、ライブデータの変更や削除について心配する必要がなくなります。 また、運用環境でのアプリケーションへの影響について心配することなく、ダミーのテストデータを作成したり、データモデルに重大な変更を加えたりすることができます。 開発環境と運用環境で異なるデータベースを使用する場合の欠点は、アプリケーションがデータベースに配置され、データベースのスキーマまたはデータに対する関連する変更もデプロイする必要があることです。

最初の配置の前に、データベースのインスタンスは1つだけで、そのインスタンスは開発環境に存在します。 アプリケーションを初めて運用環境にデプロイする場合、必要なサーバー側とクライアント側のファイルをコピーするだけでなく、開発環境から運用環境にデータベースをコピーすることも必要です。 ここでは、書籍レビュー web アプリケーションをご利用いただけます。データベースは開発環境の `App_Data` フォルダーにありますが、運用環境にはまだプッシュされていません。

アプリケーションが配置されると、データベースのコピーが2つ存在します。 アプリケーションが成熟するにつれて、新しい機能が追加され、データモデルに変更が必要になることがあります (既存のテーブルに新しい列を追加したり、既存の列に変更を加えたり、新しいテーブルを追加したりするなど)。 Web アプリケーションが次に配置されるときに、前回の配置以降に開発環境でデータベースに適用された変更を運用データベースに適用する必要があります。 このプロセスを管理するためのいくつかの戦略については、今後のチュートリアルで説明します。 このチュートリアルでは、データベース全体を開発環境から運用環境に配置する方法について説明します。

## <a name="deploying-the-database-to-the-production-environment"></a>実稼働環境へのデータベースの配置

このチュートリアルの残りの部分では、開発環境から運用環境にデータベースを配置する方法について説明します。 に従っている場合は、web ホストプロバイダーのアカウントに Microsoft SQL Server データベースのサポートが含まれていることを確認する必要があります。 また、データベースサーバー名、データベース名、データベースへの接続に使用するユーザー名とパスワードなど、いくつかの情報が必要です。

このチュートリアルで前述したように、書籍のレビュー用 web サイトのデータベースは、`App_Data` フォルダーに格納されている SQL Server 2008 Express Edition データベースです。 このようなデータベースの配置は、開発環境から運用環境に `App_Data` フォルダーをコピーするのと同じように簡単に行うことができます。 ただし、ほとんどの web ホストプロバイダーでは、セキュリティ上の理由により、`App_Data` フォルダー内のデータベースのホスティングはサポートされていません。 代わりに、web ホストは、環境内の SQL Server データベースサーバーにアカウントを提供します。 開発環境から運用環境にデータベースを配置するには、web ホスト s データベースサーバーにデータベースを登録する必要があります。

では、開発環境から運用環境にデータベースを取得するにはどうすればよいでしょうか。 これを実現するには、web ホストが提供するサービスに応じていくつかの方法があります。 DiscountASP.NET などの一部のホストでは、データベースまたは実際の `.mdf` ファイルのバックアップを web サイトに FTP 接続してから、コントロールパネルからバックアップファイルを復元するか、`.mdf` ファイルを SQL Server データベースサーバーにアタッチすることができます。 このようなツールを使用すると、`App_Data` フォルダーを実稼働環境にコピーしてから、コントロールパネルでアタッチするだけで、簡単にデータベースを配置できます。 これは、データベースを初めてパブリッシュする最も簡単かつ迅速な方法です。

別の方法として、データベース公開ウィザードを使用することもできます。 データベース発行ウィザードは、データベースのスキーマ (テーブル、ストアドプロシージャ、ビュー、ユーザー定義関数など) を作成するための SQL コマンドを生成する Windows デスクトップアプリケーションです。また、必要に応じて、テーブル内のデータを生成することもできます。 その後、SQL Server Management Studio を使用して web ホストプロバイダー s データベースサーバーに接続し、このスクリプトを実行して実稼働環境でデータベースを複製できます。 さらに、web ホストプロバイダーが Microsoft の[データベース公開サービス](http://www.codeplex.com/sqlhost/Wiki/View.aspx?title=Database%20Publishing%20Services&amp;referringTitle=Home)をサポートしている場合は、データベース発行ウィザードによって生成されたスクリプトをデータベースサーバーで自動的に実行することもできます。 データベース発行ウィザードでは、データベースのスキーマとデータを作成するスクリプトが生成されるため、web ホストプロバイダーがアップロードされた `.mdf` ファイルのアタッチなどの機能を提供するかどうかに関係なく機能します。

### <a name="generating-the-sql-commands-to-create-the-database-schema-and-data-using-the-database-publishing-wizard"></a>データベース発行ウィザードを使用してデータベーススキーマとデータを作成するための SQL コマンドを生成する

データベース公開ウィザードを使用して、ブックレビューデータベースを運用環境に配置する手順を説明します。 Visual Studio 2008 以降を使用している場合は、データベース発行ウィザードが既にインストールされています。 Visual Studio 2005 を使用している場合は、最初にウィザードを[ダウンロードしてインストール](https://www.microsoft.com/downloads/details.aspx?familyid=56E5B1C5-BF17-42E0-A410-371A838E570A&amp;displaylang=en)する必要があります。

Visual Studio を開き、`Reviews.mdf` データベースに移動します。 Visual Web Developer を使用している場合は、データベースエクスプローラーにアクセスします。Visual Studio を使用している場合は、サーバーエクスプローラーを使用します。 図4は、Visual Web Developer のデータベースエクスプローラーの `Reviews.mdf` データベースを示しています。 図4に示すように、`Reviews.mdf` データベースは4つのテーブル、3つのストアドプロシージャ、およびユーザー定義関数で構成されています。

[![データベースエクスプローラーまたはサーバーエクスプローラーでデータベースを検索します。](deploying-a-database-cs/_static/image11.jpg)](deploying-a-database-cs/_static/image10.jpg) 

**図 4**: データベースエクスプローラーまたはサーバーエクスプローラーでデータベースを検索[する (クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image12.jpg)されます)

データベース名を右クリックし、コンテキストメニューから [プロバイダーに発行] オプションを選択します。 これにより、データベース発行ウィザードが起動します (図5を参照)。 [次へ] をクリックして、スプラッシュスクリーンの前に進みます。

[データベース発行ウィザードのスプラッシュスクリーンの ![](deploying-a-database-cs/_static/image14.jpg)](deploying-a-database-cs/_static/image13.jpg) 

**図 5**: データベース発行ウィザードのスプラッシュスクリーン ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image15.jpg)されます)

ウィザードの2番目の画面には、データベース発行ウィザードからアクセスできるデータベースが一覧表示され、選択したデータベース内のすべてのオブジェクトをスクリプト化するか、スクリプトを作成するオブジェクトを選択できます。 適切なデータベースを選択し、[選択したデータベースのすべてのオブジェクトをスクリプト化する] オプションをオンのままにします。

> [!NOTE]
> 図6に示されている画面で [次へ] をクリックしたときに "データベース*databaseName*に、このウィザードでスクリプト化されたオブジェクトがありません" というエラーが表示される場合は、データベースファイルへのパスが長すぎないことを確認してください。 このエラーは、データベースファイルへのパスが長すぎる場合に発生する可能性があることが検出されました。

[データベース発行ウィザードのスプラッシュスクリーンの ![](deploying-a-database-cs/_static/image17.jpg)](deploying-a-database-cs/_static/image16.jpg) 

**図 6**: データベース発行ウィザードのスプラッシュスクリーン ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image18.jpg)されます)

次の画面では、スクリプトファイルを生成することができます。また、web ホストでサポートされている場合は、web ホストプロバイダー s データベースサーバーにデータベースを直接パブリッシュすることもできます。 図7に示すように、スクリプトは `C:\REVIEWS.MDF.sql`ファイルに書き込まれています。

[データベースをファイルにスクリプト化 ![か、Web ホストプロバイダーに直接パブリッシュします。](deploying-a-database-cs/_static/image20.jpg)](deploying-a-database-cs/_static/image19.jpg) 

**図 7**: データベースをファイルにスクリプト化するか、Web ホストプロバイダーに直接発行する ([クリックすると、フルサイズのイメージが表示](deploying-a-database-cs/_static/image21.jpg)されます)

後続の画面では、さまざまなスクリプト作成オプションを入力するように求められます。 これらの既存のオブジェクトを削除するために、スクリプトに drop ステートメントを含めるかどうかを指定できます。 これは既定で True に設定されています。初めてデータベースを配置する場合は問題ありません。 また、ターゲットデータベースが2000、SQL Server 2005、SQL Server 2008 のいずれである SQL Server かを指定することもできます。 最後に、スキーマとデータの両方、データのみ、またはスキーマだけをスクリプトに含めるかどうかを指定できます。 スキーマは、データベースオブジェクト、テーブル、ストアドプロシージャ、ビューなどのコレクションです。 データは、テーブルに存在する情報です。

図8に示すように、既存のデータベースオブジェクトを削除し、SQL Server 2008 データベースのスクリプトを生成し、スキーマとデータの両方をパブリッシュするようにウィザードを構成しました。

[パブリッシングオプションを指定 ![には](deploying-a-database-cs/_static/image23.jpg)](deploying-a-database-cs/_static/image22.jpg) 

**図 8**: 発行オプションを指定[する (クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image24.jpg)されます)

最後の2つの画面には、実行されようとしている操作がまとめられ、スクリプトの状態が表示されます。 ウィザードを実行した結果、実稼働環境でデータベースを作成し、開発時と同じデータを設定するために必要な SQL コマンドを含むスクリプトファイルが作成されます。

### <a name="executing-the-sql-commands-on-the-production-environment-database"></a>運用環境データベースでの SQL コマンドの実行

これで、データベースとそのデータを作成するための SQL コマンドを含むスクリプトが完成したので、実稼働データベースでスクリプトを実行できます。 一部の web ホストプロバイダーでは、コントロールパネルにテキストボックスが用意されており、データベースで実行する SQL コマンドを入力できます。 非常に大きなスクリプトファイルがある場合、このオプションは機能しない可能性があります (たとえば、`REVIEWS.MDF.sql` スクリプトファイルのサイズが 425 KB を超えています)。

より優れたアプローチは、SQL Server Management Studio (SSMS) を使用して実稼働データベースサーバーに直接接続することです。 Express Edition 以外の SQL Server がコンピューターにインストールされている場合は、既に SSMS がインストールされている可能性があります。 それ以外の場合は、SQL Server Management Studio Express Edition の無料コピーを[ダウンロードしてインストール](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en)することができます。

SSMS を起動し、web ホストプロバイダーから提供された情報を使用して、web ホスト s データベースサーバーに接続します。

[Web ホストプロバイダー s データベースサーバーに接続 ![](deploying-a-database-cs/_static/image26.jpg)](deploying-a-database-cs/_static/image25.jpg) 

**図 9**: Web ホストプロバイダー s データベースサーバーに接続する ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image27.jpg)される)

[データベース] タブを展開し、データベースを見つけます。 ツールバーの左上隅にある [新しいクエリ] ボタンをクリックし、データベース発行ウィザードによって作成されたスクリプトファイルから SQL コマンドを貼り付けます。次に、[実行] ボタンをクリックして、運用データベースサーバーでこれらのコマンドを実行します。 スクリプトファイルが特に大きい場合は、コマンドの実行に数分かかることがあります。

[Web ホストプロバイダー s データベースサーバーに接続 ![](deploying-a-database-cs/_static/image29.jpg)](deploying-a-database-cs/_static/image28.jpg) 

**図 10**: Web ホストプロバイダー s データベースサーバーに接続する ([クリックすると、フルサイズの画像が表示](deploying-a-database-cs/_static/image30.jpg)される)

これで完了です。 この時点で、開発データベースが運用環境に複製されました。 SSMS でデータベースを更新すると、新しいデータベースオブジェクトが表示されます。 図11は、実稼働データベースのテーブル、ストアドプロシージャ、およびユーザー定義関数を示しています。これらの関数は、開発データベース上でそれらをミラー化します。 また、データをパブリッシュするようにデータベース発行ウィザードに指示したので、実稼働データベースのテーブルのデータは、ウィザードの実行時に開発データベースのテーブルと同じになります。 図12に、実稼働データベースの `Books` テーブルのデータを示します。

[データベースオブジェクトが実稼働データベースで複製された ![](deploying-a-database-cs/_static/image32.jpg)](deploying-a-database-cs/_static/image31.jpg) 

**図 11**: データベースオブジェクトが実稼働データベースで複製されている ([クリックしてフルサイズの画像を表示する](deploying-a-database-cs/_static/image33.jpg))

[実稼働データベースに開発データベースと同じデータが含まれて ![](deploying-a-database-cs/_static/image35.jpg)](deploying-a-database-cs/_static/image34.jpg) 

**図 12**: 運用データベースに開発データベースと同じデータが含まれている ([クリックしてフルサイズの画像を表示する](deploying-a-database-cs/_static/image36.jpg))

この時点で、開発データベースは運用環境にのみデプロイされています。 Web アプリケーション自体のデプロイ、または運用環境でアプリケーションが運用データベースを使用するために必要な構成変更を確認していません。 これらの問題については、次のチュートリアルで説明します。

## <a name="summary"></a>まとめ

データドリブン web アプリケーションを配置するには、開発時に使用したデータベースを運用環境にコピーする必要があります。 多くの web ホストプロバイダーには、データベースの配置プロセスを簡略化するツールが用意されています。 たとえば、DiscountASP.NET を使用すると、データベース `.mdf` ファイル (またはバックアップ) に FTP 接続してから、コントロールパネルからデータベースサーバーにデータベースをアタッチすることができます。 Web ホストプロバイダーが提供する機能に関係なく機能するもう1つのオプションは、Microsoft のデータベース発行ウィザードツールです。これにより、開発用データベースのスキーマとデータを作成するための SQL コマンドのスクリプトが生成されます。 このスクリプトが生成されたら、実稼働データベースで実行できます。

この書籍では、web アプリケーション s データベースが運用環境にあることを確認したので、アプリケーションをデプロイできます。 ただし、web アプリケーションの構成情報によってデータベースへの接続文字列が指定され、その接続文字列によって開発データベースが参照されます。 この接続文字列情報は、サイトを運用環境に展開するときに更新する必要があります。 次のチュートリアルでは、これらの構成の違いについて説明し、データドリブンブックレビューサイトを運用環境に発行するために必要な手順について説明します。

プログラミングを楽しんでください。

#### <a name="further-reading"></a>参考資料

このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。

- [Microsoft SQL Server Database Publishing Wizard 1.1 をダウンロードします。](https://www.microsoft.com/downloads/details.aspx?familyid=56E5B1C5-BF17-42E0-A410-371A838E570A&amp;displaylang=en)
- [Microsoft SQL Server Management Studio Express Edition のダウンロード](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en)

> [!div class="step-by-step"]
> [前へ](core-differences-between-iis-and-the-asp-net-development-server-cs.md)
> [次へ](configuring-the-production-web-application-to-use-the-production-database-cs.md)
