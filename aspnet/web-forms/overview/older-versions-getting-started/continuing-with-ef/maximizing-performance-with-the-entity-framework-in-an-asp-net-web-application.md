---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
title: ASP.NET 4 Web アプリケーションでの Entity Framework 4.0 を使用したパフォーマンスの最大化 |Microsoft Docs
author: tdykstra
description: このチュートリアルシリーズは、Entity Framework 4.0 チュートリアルシリーズを使用してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。 ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 4e43455e-dfa1-42db-83cb-c987703f04b5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 5630200a1ad1d30f6d89b38e15179f15b699fa9f
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78439264"
---
# <a name="maximizing-performance-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="6db42-104">ASP.NET 4 Web アプリケーションでの Entity Framework 4.0 を使用したパフォーマンスの最大化</span><span class="sxs-lookup"><span data-stu-id="6db42-104">Maximizing Performance with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="6db42-105">[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="6db42-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="6db42-106">このチュートリアルシリーズは、 [Entity Framework 4.0 チュートリアルシリーズを使用](https://asp.net/entity-framework/tutorials#Getting%20Started)してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。</span><span class="sxs-lookup"><span data-stu-id="6db42-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="6db42-107">前のチュートリアルを完了していない場合は、このチュートリアルの開始点として、作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="6db42-108">チュートリアルシリーズ全体で作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)することもできます。</span><span class="sxs-lookup"><span data-stu-id="6db42-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="6db42-109">チュートリアルについてご質問がある場合は、 [ASP.NET Entity Framework フォーラム](https://forums.asp.net/1227.aspx)に投稿することができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="6db42-110">前のチュートリアルでは、同時実行の競合を処理する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="6db42-110">In the previous tutorial, you saw how to handle concurrency conflicts.</span></span> <span data-ttu-id="6db42-111">このチュートリアルでは、Entity Framework を使用する ASP.NET web アプリケーションのパフォーマンスを向上させるためのオプションについて説明します。</span><span class="sxs-lookup"><span data-stu-id="6db42-111">This tutorial shows options for improving the performance of an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="6db42-112">パフォーマンスを最大化したり、パフォーマンスの問題を診断したりするためのいくつかの方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="6db42-112">You'll learn several methods for maximizing performance or for diagnosing performance problems.</span></span>

<span data-ttu-id="6db42-113">以下のセクションに記載されている情報は、さまざまなシナリオで役に立つ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-113">Information presented in the following sections is likely to be useful in a broad variety of scenarios:</span></span>

- <span data-ttu-id="6db42-114">関連データを効率的に読み込みます。</span><span class="sxs-lookup"><span data-stu-id="6db42-114">Efficiently load related data.</span></span>
- <span data-ttu-id="6db42-115">ビューステートを管理します。</span><span class="sxs-lookup"><span data-stu-id="6db42-115">Manage view state.</span></span>

<span data-ttu-id="6db42-116">以下のセクションに記載されている情報は、パフォーマンスの問題が発生する個々のクエリがある場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="6db42-116">Information presented in the following sections might be useful if you have individual queries that present performance problems:</span></span>

- <span data-ttu-id="6db42-117">`NoTracking` merge オプションを使用します。</span><span class="sxs-lookup"><span data-stu-id="6db42-117">Use the `NoTracking` merge option.</span></span>
- <span data-ttu-id="6db42-118">LINQ クエリをプリコンパイルします。</span><span class="sxs-lookup"><span data-stu-id="6db42-118">Pre-compile LINQ queries.</span></span>
- <span data-ttu-id="6db42-119">データベースに送信されたクエリコマンドを確認します。</span><span class="sxs-lookup"><span data-stu-id="6db42-119">Examine query commands sent to the database.</span></span>

<span data-ttu-id="6db42-120">次のセクションで説明する情報は、非常に大きなデータモデルを持つアプリケーションに役立つ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-120">Information presented in the following section is potentially useful for applications that have extremely large data models:</span></span>

- <span data-ttu-id="6db42-121">ビューを事前に生成します。</span><span class="sxs-lookup"><span data-stu-id="6db42-121">Pre-generate views.</span></span>

> [!NOTE]
> <span data-ttu-id="6db42-122">Web アプリケーションのパフォーマンスは多くの要因の影響を受けます。これには、要求と応答のデータのサイズ、データベースクエリの速度、サーバーがキューに入れられる要求の数、サーバーがキューに入れられる要求の数、サービスの効率、クライアントスクリプトライブラリを使用している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-122">Web application performance is affected by many factors, including things like the size of request and response data, the speed of database queries, how many requests the server can queue and how quickly it can service them, and even the efficiency of any client-script libraries you might be using.</span></span> <span data-ttu-id="6db42-123">アプリケーションでパフォーマンスが重要な場合、またはテストまたは経験によってアプリケーションのパフォーマンスが不十分であることが示された場合は、パフォーマンスチューニングのために通常のプロトコルに従う必要があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-123">If performance is critical in your application, or if testing or experience shows that application performance isn't satisfactory, you should follow normal protocol for performance tuning.</span></span> <span data-ttu-id="6db42-124">パフォーマンスのボトルネックが発生している場所を判断し、アプリケーション全体のパフォーマンスに最大の影響を与える領域に対処します。</span><span class="sxs-lookup"><span data-stu-id="6db42-124">Measure to determine where performance bottlenecks are occurring, and then address the areas that will have the greatest impact on overall application performance.</span></span>
> 
> <span data-ttu-id="6db42-125">このトピックでは、主に ASP.NET の Entity Framework のパフォーマンスを向上させる方法に焦点を当てています。</span><span class="sxs-lookup"><span data-stu-id="6db42-125">This topic focuses mainly on ways in which you can potentially improve the performance specifically of the Entity Framework in ASP.NET.</span></span> <span data-ttu-id="6db42-126">ここでの推奨事項は、データアクセスがアプリケーションのパフォーマンスボトルネックの1つであると判断した場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="6db42-126">The suggestions here are useful if you determine that data access is one of the performance bottlenecks in your application.</span></span> <span data-ttu-id="6db42-127">ただし、前述のように、ここで説明する方法は、一般的&quot; のベストプラクティス &quot;とは見なされません。その多くは、例外的な状況にのみ適しています。また、非常に具体的なパフォーマンスのボトルネックに対処するためにも適しています。</span><span class="sxs-lookup"><span data-stu-id="6db42-127">Except as noted, the methods explained here shouldn't be considered &quot;best practices&quot; in general — many of them are appropriate only in exceptional situations or to address very specific kinds of performance bottlenecks.</span></span>

<span data-ttu-id="6db42-128">チュートリアルを開始するには、Visual Studio を起動し、前のチュートリアルで使用していた Contoso 大学 web アプリケーションを開きます。</span><span class="sxs-lookup"><span data-stu-id="6db42-128">To start the tutorial, start Visual Studio and open the Contoso University web application that you were working with in the previous tutorial.</span></span>

## <a name="efficiently-loading-related-data"></a><span data-ttu-id="6db42-129">関連データの効率的な読み込み</span><span class="sxs-lookup"><span data-stu-id="6db42-129">Efficiently Loading Related Data</span></span>

<span data-ttu-id="6db42-130">Entity Framework がエンティティのナビゲーションプロパティに関連データを読み込むには、いくつかの方法があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-130">There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</span></span>

- <span data-ttu-id="6db42-131">*遅延読み込み*。</span><span class="sxs-lookup"><span data-stu-id="6db42-131">*Lazy loading*.</span></span> <span data-ttu-id="6db42-132">エンティティが最初に読み込まれるときに、関連データは取得されません。</span><span class="sxs-lookup"><span data-stu-id="6db42-132">When the entity is first read, related data isn't retrieved.</span></span> <span data-ttu-id="6db42-133">ただし、ナビゲーション プロパティに初めてアクセスしようとすると、そのナビゲーション プロパティに必要なデータが自動的に取得されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-133">However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved.</span></span> <span data-ttu-id="6db42-134">この結果、複数のクエリがデータベースに送信されます。1つはエンティティ自体に対して、もう1つはエンティティの関連データを取得する必要があるときです。</span><span class="sxs-lookup"><span data-stu-id="6db42-134">This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved.</span></span> 

    <span data-ttu-id="6db42-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="6db42-136">*一括読み込み*。</span><span class="sxs-lookup"><span data-stu-id="6db42-136">*Eager loading*.</span></span> <span data-ttu-id="6db42-137">エンティティが読み取られるときに、関連データがエンティティと共に取得されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-137">When the entity is read, related data is retrieved along with it.</span></span> <span data-ttu-id="6db42-138">これは通常、必要なデータをすべて取得する 1 つの結合クエリになります。</span><span class="sxs-lookup"><span data-stu-id="6db42-138">This typically results in a single join query that retrieves all of the data that's needed.</span></span> <span data-ttu-id="6db42-139">このチュートリアルで既に説明したように、`Include` メソッドを使用して一括読み込みを指定します。</span><span class="sxs-lookup"><span data-stu-id="6db42-139">You specify eager loading by using the `Include` method, as you've seen already in these tutorials.</span></span>

<span data-ttu-id="6db42-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

- <span data-ttu-id="6db42-141">*明示的読み込み*。</span><span class="sxs-lookup"><span data-stu-id="6db42-141">*Explicit loading*.</span></span> <span data-ttu-id="6db42-142">これは、コード内の関連データを明示的に取得する点を除いて、遅延読み込みに似ています。ナビゲーションプロパティにアクセスしても、自動的には発生しません。</span><span class="sxs-lookup"><span data-stu-id="6db42-142">This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn't happen automatically when you access a navigation property.</span></span> <span data-ttu-id="6db42-143">関連データは、コレクションのナビゲーションプロパティの `Load` メソッドを使用して手動で読み込むか、または1つのオブジェクトを保持するプロパティの reference プロパティの `Load` メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="6db42-143">You load related data manually using the `Load` method of the navigation property for collections, or you use the `Load` method of the reference property for properties that hold a single object.</span></span> <span data-ttu-id="6db42-144">(たとえば、`PersonReference.Load` メソッドを呼び出して、`Department` エンティティの `Person` ナビゲーションプロパティを読み込みます)。</span><span class="sxs-lookup"><span data-stu-id="6db42-144">(For example, you call the `PersonReference.Load` method to load the `Person` navigation property of a `Department` entity.)</span></span>

    <span data-ttu-id="6db42-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="6db42-146">遅延読み込みと明示的な読み込みは、すぐにプロパティ値を取得しないため、*遅延読み込み*とも呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="6db42-146">Because they don't immediately retrieve the property values, lazy loading and explicit loading are also both known as *deferred loading*.</span></span>

<span data-ttu-id="6db42-147">遅延読み込みは、デザイナーによって生成されたオブジェクトコンテキストの既定の動作です。</span><span class="sxs-lookup"><span data-stu-id="6db42-147">Lazy loading is the default behavior for an object context that has been generated by the designer.</span></span> <span data-ttu-id="6db42-148">オブジェクトコンテキストクラスを定義する*SchoolModel.Designer.cs*ファイルを開くと、3つのコンストラクターメソッドが見つかり、それぞれに次のステートメントが含まれています。</span><span class="sxs-lookup"><span data-stu-id="6db42-148">If you open the *SchoolModel.Designer.cs* file that defines the object context class, you'll find three constructor methods, and each of them includes the following statement:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="6db42-149">一般に、取得したすべてのエンティティに関連データが必要であることがわかっている場合は、一括読み込みで最高のパフォーマンスが得られます。これは、データベースに送信される単一のクエリは、通常、取得されたエンティティごとに個別のクエリよりも効率的であるためです。</span><span class="sxs-lookup"><span data-stu-id="6db42-149">In general, if you know you need related data for every entity retrieved, eager loading offers the best performance, because a single query sent to the database is typically more efficient than separate queries for each entity retrieved.</span></span> <span data-ttu-id="6db42-150">一方、エンティティのナビゲーションプロパティにアクセスする頻度が低い場合、または少数のエンティティセットに対してのみアクセスする必要がある場合は、一括読み込みで必要以上のデータが取得されるため、遅延読み込みまたは明示的な読み込みの方が効率的です。</span><span class="sxs-lookup"><span data-stu-id="6db42-150">On the other hand, if you need to access an entity's navigation properties only infrequently or only for a small set of the entities, lazy loading or explicit loading may be more efficient, because eager loading would retrieve more data than you need.</span></span>

<span data-ttu-id="6db42-151">Web アプリケーションでは、関連するデータのニーズに影響を与えるユーザー操作がブラウザーで実行されるため、遅延読み込みの値が比較的小さくなることがあります。これは、ページをレンダリングしたオブジェクトコンテキストへの接続がないためです。</span><span class="sxs-lookup"><span data-stu-id="6db42-151">In a web application, lazy loading may be of relatively little value anyway, because user actions that affect the need for related data take place in the browser, which has no connection to the object context that rendered the page.</span></span> <span data-ttu-id="6db42-152">一方、コントロールをデータバインドする場合は、通常、必要なデータを把握しているため、通常は、各シナリオに適した方法に基づいて、一括読み込みまたは遅延読み込みを選択することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="6db42-152">On the other hand, when you databind a control, you typically know what data you need, and so it's generally best to choose eager loading or deferred loading based on what's appropriate in each scenario.</span></span>

<span data-ttu-id="6db42-153">また、オブジェクトコンテキストが破棄された後で、データバインドコントロールでエンティティオブジェクトを使用する場合もあります。</span><span class="sxs-lookup"><span data-stu-id="6db42-153">In addition, a databound control might use an entity object after the object context is disposed.</span></span> <span data-ttu-id="6db42-154">その場合、ナビゲーションプロパティの遅延読み込みの試行は失敗します。</span><span class="sxs-lookup"><span data-stu-id="6db42-154">In that case, an attempt to lazy-load a navigation property would fail.</span></span> <span data-ttu-id="6db42-155">次のエラーメッセージが表示されます。 &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span><span class="sxs-lookup"><span data-stu-id="6db42-155">The error message you receive is clear: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span></span>

<span data-ttu-id="6db42-156">`EntityDataSource` コントロールは、既定で遅延読み込みを無効にします。</span><span class="sxs-lookup"><span data-stu-id="6db42-156">The `EntityDataSource` control disables lazy loading by default.</span></span> <span data-ttu-id="6db42-157">現在のチュートリアルで使用している `ObjectDataSource` コントロール (またはページコードからオブジェクトコンテキストにアクセスする場合) では、遅延読み込みを既定で無効にする方法がいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="6db42-157">For the `ObjectDataSource` control that you're using for the current tutorial (or if you access the object context from page code), there are several ways you can make lazy loading disabled by default.</span></span> <span data-ttu-id="6db42-158">オブジェクトコンテキストをインスタンス化するときに無効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-158">You can disable it when you instantiate an object context.</span></span> <span data-ttu-id="6db42-159">たとえば、次の行を `SchoolRepository` クラスのコンストラクターメソッドに追加できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-159">For example, you can add the following line to the constructor method of the `SchoolRepository` class:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="6db42-160">Contoso 大学アプリケーションでは、コンテキストがインスタンス化されるたびにこのプロパティを設定する必要がないように、オブジェクトコンテキストによって遅延読み込みが自動的に無効になります。</span><span class="sxs-lookup"><span data-stu-id="6db42-160">For the Contoso University application, you'll make the object context automatically disable lazy loading so that this property doesn't have to be set whenever a context is instantiated.</span></span>

<span data-ttu-id="6db42-161">*SchoolModel*データモデルを開き、デザイン画面をクリックします。次に、[プロパティ] ペインで、[**遅延読み込みを有効**にする] プロパティを `False`に設定します。</span><span class="sxs-lookup"><span data-stu-id="6db42-161">Open the *SchoolModel.edmx* data model, click the design surface, and then in the properties pane set the **Lazy Loading Enabled** property to `False`.</span></span> <span data-ttu-id="6db42-162">データモデルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="6db42-162">Save and close the data model.</span></span>

<span data-ttu-id="6db42-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

## <a name="managing-view-state"></a><span data-ttu-id="6db42-164">ビューステートの管理</span><span class="sxs-lookup"><span data-stu-id="6db42-164">Managing View State</span></span>

<span data-ttu-id="6db42-165">更新機能を提供するために、ページを表示するときに、ASP.NET web ページにエンティティの元のプロパティ値を格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-165">In order to provide update functionality, an ASP.NET web page must store the original property values of an entity when a page is rendered.</span></span> <span data-ttu-id="6db42-166">ポストバック処理中に、コントロールはエンティティの元の状態を再作成し、変更を適用して `SaveChanges` メソッドを呼び出す前に、エンティティの `Attach` メソッドを呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-166">During postback processing the control can re-create the original state of the entity and call the entity's `Attach` method before applying changes and calling the `SaveChanges` method.</span></span> <span data-ttu-id="6db42-167">既定では、ASP.NET Web フォームデータコントロールは、ビューステートを使用して元の値を格納します。</span><span class="sxs-lookup"><span data-stu-id="6db42-167">By default, ASP.NET Web Forms data controls use view state to store the original values.</span></span> <span data-ttu-id="6db42-168">ただし、ビューステートは、ブラウザーとの間で送受信されるページのサイズを大幅に増やすことができる非表示フィールドに格納されているため、パフォーマンスに影響する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-168">However, view state can affect performance, because it's stored in hidden fields that can substantially increase the size of the page that's sent to and from the browser.</span></span>

<span data-ttu-id="6db42-169">ビューステートを管理する方法、またはセッション状態などの代替手段は Entity Framework に固有のものではないため、このチュートリアルでは詳しく説明しません。</span><span class="sxs-lookup"><span data-stu-id="6db42-169">Techniques for managing view state, or alternatives such as session state, aren't unique to the Entity Framework, so this tutorial doesn't go into this topic in detail.</span></span> <span data-ttu-id="6db42-170">詳細については、チュートリアルの最後にあるリンクを参照してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-170">For more information see the links at the end of the tutorial.</span></span>

<span data-ttu-id="6db42-171">ただし、ASP.NET のバージョン4では、Web フォームアプリケーションのすべての ASP.NET 開発者が認識する必要がある、ビューステートを操作する新しい方法が提供されます。これは、`ViewStateMode` プロパティです。</span><span class="sxs-lookup"><span data-stu-id="6db42-171">However, version 4 of ASP.NET provides a new way of working with view state that every ASP.NET developer of Web Forms applications should be aware of: the `ViewStateMode` property.</span></span> <span data-ttu-id="6db42-172">この新しいプロパティは、ページレベルまたはコントロールレベルで設定できます。また、ページのビューステートを既定で無効にし、それを必要とするコントロールに対してのみ有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-172">This new property can be set at the page or control level, and it enables you to disable view state by default for a page and enable it only for controls that need it.</span></span>

<span data-ttu-id="6db42-173">パフォーマンスが重要なアプリケーションの場合は、常にページレベルでビューステートを無効にし、それを必要とするコントロールに対してのみ有効にすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="6db42-173">For applications where performance is critical, a good practice is to always disable view state at the page level and enable it only for controls that require it.</span></span> <span data-ttu-id="6db42-174">Contoso 大学のページのビューステートのサイズは、この方法によって大幅に減少することはありませんが、そのしくみを確認するために、*教員の .aspx*ページに対して行います。</span><span class="sxs-lookup"><span data-stu-id="6db42-174">The size of view state in the Contoso University pages wouldn't be substantially decreased by this method, but to see how it works, you'll do it for the *Instructors.aspx* page.</span></span> <span data-ttu-id="6db42-175">このページには、ビューステートが無効になっている `Label` コントロールなど、多くのコントロールが含まれています。</span><span class="sxs-lookup"><span data-stu-id="6db42-175">That page contains many controls, including a `Label` control that has view state disabled.</span></span> <span data-ttu-id="6db42-176">このページのコントロールでは、実際にはビューステートを有効にする必要がありません。</span><span class="sxs-lookup"><span data-stu-id="6db42-176">None of the controls on this page actually need to have view state enabled.</span></span> <span data-ttu-id="6db42-177">(`GridView` コントロールの `DataKeyNames` プロパティは、ポストバック間で管理する必要がある状態を指定しますが、これらの値は `ViewStateMode` プロパティの影響を受けないコントロールの状態で保持されます)。</span><span class="sxs-lookup"><span data-stu-id="6db42-177">(The `DataKeyNames` property of the `GridView` control specifies state that must be maintained between postbacks, but these values are kept in control state, which isn't affected by the `ViewStateMode` property.)</span></span>

<span data-ttu-id="6db42-178">現在、`Page` ディレクティブと `Label` コントロールのマークアップは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="6db42-178">The `Page` directive and `Label` control markup currently resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="6db42-179">次の変更を行います。</span><span class="sxs-lookup"><span data-stu-id="6db42-179">Make the following changes:</span></span>

- <span data-ttu-id="6db42-180">`Page` ディレクティブに `ViewStateMode="Disabled"` を追加します。</span><span class="sxs-lookup"><span data-stu-id="6db42-180">Add `ViewStateMode="Disabled"` to the `Page` directive.</span></span>
- <span data-ttu-id="6db42-181">`Label` コントロールから `ViewStateMode="Disabled"` を削除します。</span><span class="sxs-lookup"><span data-stu-id="6db42-181">Remove `ViewStateMode="Disabled"` from the `Label` control.</span></span>

<span data-ttu-id="6db42-182">このマークアップは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="6db42-182">The markup now resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="6db42-183">すべてのコントロールでビューステートが無効になりました。</span><span class="sxs-lookup"><span data-stu-id="6db42-183">View state is now disabled for all controls.</span></span> <span data-ttu-id="6db42-184">ビューステートを使用する必要があるコントロールを後で追加する場合は、そのコントロールの `ViewStateMode="Enabled"` 属性を含めるだけで済みます。</span><span class="sxs-lookup"><span data-stu-id="6db42-184">If you later add a control that does need to use view state, all you need to do is include the `ViewStateMode="Enabled"` attribute for that control.</span></span>

## <a name="using-the-notracking-merge-option"></a><span data-ttu-id="6db42-185">NoTracking マージオプションの使用</span><span class="sxs-lookup"><span data-stu-id="6db42-185">Using The NoTracking Merge Option</span></span>

<span data-ttu-id="6db42-186">オブジェクトコンテキストがデータベース行を取得し、それらを表すエンティティオブジェクトを作成すると、既定では、オブジェクト状態マネージャーを使用してそれらのエンティティオブジェクトも追跡されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-186">When an object context retrieves database rows and creates entity objects that represent them, by default it also tracks those entity objects using its object state manager.</span></span> <span data-ttu-id="6db42-187">この追跡データはキャッシュとして機能し、エンティティを更新するときに使用されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-187">This tracking data acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="6db42-188">通常、web アプリケーションには有効期間が短いオブジェクトコンテキストインスタンスがあるため、クエリは、読み取られる必要のないデータを返すことがよくあります。これは、読み取られたすべてのエンティティが再度使用されるか、または更新される前に、それらを読み取るオブジェクトコンテキストが破棄されるためです。</span><span class="sxs-lookup"><span data-stu-id="6db42-188">Because a web application typically has short-lived object context instances, queries often return data that doesn't need to be tracked, because the object context that reads them will be disposed before any of the entities it reads are used again or updated.</span></span>

<span data-ttu-id="6db42-189">Entity Framework では、*マージオプション*を設定することによって、オブジェクトコンテキストでエンティティオブジェクトを追跡するかどうかを指定できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-189">In the Entity Framework, you can specify whether the object context tracks entity objects by setting a *merge option*.</span></span> <span data-ttu-id="6db42-190">マージオプションは、個々のクエリまたはエンティティセットに対して設定できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-190">You can set the merge option for individual queries or for entity sets.</span></span> <span data-ttu-id="6db42-191">エンティティセットに対して設定した場合、そのエンティティセットに対して作成されるすべてのクエリに対して、既定のマージオプションを設定することになります。</span><span class="sxs-lookup"><span data-stu-id="6db42-191">If you set it for an entity set, that means that you're setting the default merge option for all queries that are created for that entity set.</span></span>

<span data-ttu-id="6db42-192">Contoso 大学アプリケーションでは、リポジトリからアクセスするエンティティセットの追跡は必要ありません。そのため、リポジトリクラスでオブジェクトコンテキストをインスタンス化するときに、これらのエンティティセットの `NoTracking` にマージオプションを設定できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-192">For the Contoso University application, tracking isn't needed for any of the entity sets that you access from the repository, so you can set the merge option to `NoTracking` for those entity sets when you instantiate the object context in the repository class.</span></span> <span data-ttu-id="6db42-193">(このチュートリアルでは、merge オプションを設定しても、アプリケーションのパフォーマンスに大きな影響はありません。</span><span class="sxs-lookup"><span data-stu-id="6db42-193">(Note that in this tutorial, setting the merge option won't have a noticeable effect on the application's performance.</span></span> <span data-ttu-id="6db42-194">`NoTracking` オプションは、データ量の多い特定のシナリオでのみ監視可能なパフォーマンス向上を実現する可能性があります)。</span><span class="sxs-lookup"><span data-stu-id="6db42-194">The `NoTracking` option is likely to make an observable performance improvement only in certain high-data-volume scenarios.)</span></span>

<span data-ttu-id="6db42-195">DAL フォルダーで、 *SchoolRepository.cs*ファイルを開き、リポジトリがアクセスするエンティティセットのマージオプションを設定するコンストラクターメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="6db42-195">In the DAL folder, open the *SchoolRepository.cs* file and add a constructor method that sets the merge option for the entity sets that the repository accesses:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

## <a name="pre-compiling-linq-queries"></a><span data-ttu-id="6db42-196">LINQ クエリのプリコンパイル</span><span class="sxs-lookup"><span data-stu-id="6db42-196">Pre-Compiling LINQ Queries</span></span>

<span data-ttu-id="6db42-197">Entity Framework が、指定された `ObjectContext` インスタンスの有効期間内に Entity SQL クエリを初めて実行するときは、クエリのコンパイルに多少の時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="6db42-197">The first time that the Entity Framework executes an Entity SQL query within the life of a given `ObjectContext` instance, it takes some time to compile the query.</span></span> <span data-ttu-id="6db42-198">コンパイルの結果がキャッシュされます。これは、クエリの後続の実行がはるかに高速になることを意味します。</span><span class="sxs-lookup"><span data-stu-id="6db42-198">The result of compilation is cached, which means that subsequent executions of the query are much quicker.</span></span> <span data-ttu-id="6db42-199">LINQ クエリは同様のパターンに従います。ただし、クエリをコンパイルするために必要な作業の一部は、クエリが実行されるたびに実行されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-199">LINQ queries follow a similar pattern, except that some of the work required to compile the query is done every time the query is executed.</span></span> <span data-ttu-id="6db42-200">つまり、LINQ クエリの場合、既定では、コンパイルのすべての結果がキャッシュされるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="6db42-200">In other words, for LINQ queries, by default not all of the results of compilation are cached.</span></span>

<span data-ttu-id="6db42-201">オブジェクトコンテキストの有効期間内に繰り返し実行することが予想される LINQ クエリがある場合は、LINQ クエリを初めて実行するときにコンパイルのすべての結果がキャッシュされるようにするコードを記述できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-201">If you have a LINQ query that you expect to run repeatedly in the life of an object context, you can write code that causes all of the results of compilation to be cached the first time the LINQ query is run.</span></span>

<span data-ttu-id="6db42-202">図として、`SchoolRepository` クラスの2つの `Get` メソッドに対してこれを実行します。1つはパラメーター (`GetInstructorNames` メソッド) を取らず、もう1つはパラメーター (`GetDepartmentsByAdministrator` メソッド) を必要とします。</span><span class="sxs-lookup"><span data-stu-id="6db42-202">As an illustration, you'll do this for two `Get` methods in the `SchoolRepository` class, one of which doesn't take any parameters (the `GetInstructorNames` method), and one that does require a parameter (the `GetDepartmentsByAdministrator` method).</span></span> <span data-ttu-id="6db42-203">これらのメソッドは、LINQ クエリではないため、実際にコンパイルする必要がなくなりました。</span><span class="sxs-lookup"><span data-stu-id="6db42-203">These methods as they stand now actually don't need to be compiled because they aren't LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

<span data-ttu-id="6db42-204">ただし、コンパイル済みのクエリを試すことができるように、次の LINQ クエリとして記述されているかのように続行します。</span><span class="sxs-lookup"><span data-stu-id="6db42-204">However, so that you can try out compiled queries, you'll proceed as if these had been written as the following LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="6db42-205">これらのメソッドのコードを上記のように変更し、アプリケーションを実行して、続行する前に動作することを確認できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-205">You could change the code in these methods to what's shown above and run the application to verify that it works before continuing.</span></span> <span data-ttu-id="6db42-206">ただし、次の手順は、事前にコンパイルされたバージョンを作成することに直接対応しています。</span><span class="sxs-lookup"><span data-stu-id="6db42-206">But the following instructions jump right into creating pre-compiled versions of them.</span></span>

<span data-ttu-id="6db42-207">*DAL*フォルダーにクラスファイルを作成し、 *SchoolEntities.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="6db42-207">Create a class file in the *DAL* folder, name it *SchoolEntities.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="6db42-208">このコードは、自動的に生成されたオブジェクトコンテキストクラスを拡張する部分クラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="6db42-208">This code creates a partial class that extends the automatically generated object context class.</span></span> <span data-ttu-id="6db42-209">部分クラスには、`CompiledQuery` クラスの `Compile` メソッドを使用する2つのコンパイル済み LINQ クエリが含まれています。</span><span class="sxs-lookup"><span data-stu-id="6db42-209">The partial class includes two compiled LINQ queries using the `Compile` method of the `CompiledQuery` class.</span></span> <span data-ttu-id="6db42-210">また、クエリを呼び出すために使用できるメソッドも作成します。</span><span class="sxs-lookup"><span data-stu-id="6db42-210">It also creates methods that you can use to call the queries.</span></span> <span data-ttu-id="6db42-211">このファイルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="6db42-211">Save and close this file.</span></span>

<span data-ttu-id="6db42-212">次に、 *SchoolRepository.cs*で、コンパイルされたクエリを呼び出すように、リポジトリクラスの既存の `GetInstructorNames` および `GetDepartmentsByAdministrator` メソッドを変更します。</span><span class="sxs-lookup"><span data-stu-id="6db42-212">Next, in *SchoolRepository.cs*, change the existing `GetInstructorNames` and `GetDepartmentsByAdministrator` methods in the repository class so that they call the compiled queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

<span data-ttu-id="6db42-213">Department *.aspx*ページを実行して、以前と同じように動作することを確認します。</span><span class="sxs-lookup"><span data-stu-id="6db42-213">Run the *Departments.aspx* page to verify that it works as it did before.</span></span> <span data-ttu-id="6db42-214">`GetInstructorNames` メソッドは、管理者 ドロップダウンリストを設定するために呼び出されます。 **更新** をクリックすると、複数の部門の管理者であるインストラクターがいないことを確認するために、`GetDepartmentsByAdministrator` メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-214">The `GetInstructorNames` method is called in order to populate the administrator drop-down list, and the `GetDepartmentsByAdministrator` method is called when you click **Update** in order to verify that no instructor is an administrator of more than one department.</span></span>

<span data-ttu-id="6db42-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

<span data-ttu-id="6db42-216">Contoso 大学アプリケーションで事前にコンパイルされたクエリは、その方法を確認するためにのみ使用できます。これは、パフォーマンスがある程度までになるためです。</span><span class="sxs-lookup"><span data-stu-id="6db42-216">You've pre-compiled queries in the Contoso University application only to see how to do it, not because it would measurably improve performance.</span></span> <span data-ttu-id="6db42-217">LINQ クエリをプリコンパイルすると、コードに複雑さのレベルが追加されるため、アプリケーションのパフォーマンスのボトルネックを実際に表すクエリに対してのみ実行してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-217">Pre-compiling LINQ queries does add a level of complexity to your code, so make sure you do it only for queries that actually represent performance bottlenecks in your application.</span></span>

## <a name="examining-queries-sent-to-the-database"></a><span data-ttu-id="6db42-218">データベースに送信されたクエリの調査</span><span class="sxs-lookup"><span data-stu-id="6db42-218">Examining Queries Sent to the Database</span></span>

<span data-ttu-id="6db42-219">パフォーマンスの問題を調査しているときに、Entity Framework がデータベースに送信している SQL コマンドを正確に把握しておくと役立つ場合があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-219">When you're investigating performance issues, sometimes it's helpful to know the exact SQL commands that the Entity Framework is sending to the database.</span></span> <span data-ttu-id="6db42-220">`IQueryable` オブジェクトを使用している場合は、`ToTraceString` メソッドを使用する方法があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-220">If you're working with an `IQueryable` object, one way to do this is to use the `ToTraceString` method.</span></span>

<span data-ttu-id="6db42-221">*SchoolRepository.cs*で、次の例に一致するように `GetDepartmentsByName` メソッドのコードを変更します。</span><span class="sxs-lookup"><span data-stu-id="6db42-221">In *SchoolRepository.cs*, change the code in the `GetDepartmentsByName` method to match the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.cs)]

<span data-ttu-id="6db42-222">`departments` 変数は、前の行の末尾にある `Where` メソッドによって `IQueryable` オブジェクトが作成されるため、`ObjectQuery` 型にのみキャストする必要があります。`Where` メソッドを使用しない場合、キャストは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="6db42-222">The `departments` variable must be cast to an `ObjectQuery` type only because the `Where` method at the end of the preceding line creates an `IQueryable` object; without the `Where` method, the cast would not be necessary.</span></span>

<span data-ttu-id="6db42-223">`return` 行にブレークポイントを設定し、デバッガーで department *.aspx*ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="6db42-223">Set a breakpoint on the `return` line, and then run the *Departments.aspx* page in the debugger.</span></span> <span data-ttu-id="6db42-224">ブレークポイントにヒットしたら、 **[ローカル]** ウィンドウで `commandText` 変数を調べ、テキストビジュアライザー ( **[値]** 列の虫眼鏡) を使用して、 **[テキストビジュアライザー]** ウィンドウに値を表示します。</span><span class="sxs-lookup"><span data-stu-id="6db42-224">When you hit the breakpoint, examine the `commandText` variable in the **Locals** window and use the text visualizer (the magnifying glass in the **Value** column) to display its value in the **Text Visualizer** window.</span></span> <span data-ttu-id="6db42-225">次のコードから結果として得られた SQL コマンド全体を確認できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-225">You can see the entire SQL command that results from this code:</span></span>

<span data-ttu-id="6db42-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="6db42-227">別の方法として、Visual Studio Ultimate の IntelliTrace 機能を使用すると、Entity Framework によって生成された SQL コマンドを表示して、コードを変更したり、ブレークポイントを設定したりする必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="6db42-227">As an alternative, the IntelliTrace feature in Visual Studio Ultimate provides a way to view SQL commands generated by the Entity Framework that doesn't require you to change your code or even set a breakpoint.</span></span>

> [!NOTE]
> <span data-ttu-id="6db42-228">次の手順は、Visual Studio Ultimate がある場合にのみ実行できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-228">You can perform the following procedures only if you have Visual Studio Ultimate.</span></span>

<span data-ttu-id="6db42-229">`GetDepartmentsByName` メソッドで元のコードを復元した後、デバッガーで department *.aspx*ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="6db42-229">Restore the original code in the `GetDepartmentsByName` method, and then run the *Departments.aspx* page in the debugger.</span></span>

<span data-ttu-id="6db42-230">Visual Studio で、 **[デバッグ]** メニュー、 **[intellitrace]** 、 **[intellitrace イベント]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="6db42-230">In Visual Studio, select the **Debug** menu, then **IntelliTrace**, and then **IntelliTrace Events**.</span></span>

<span data-ttu-id="6db42-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="6db42-232">**[IntelliTrace]** ウィンドウで、 **[すべて中断]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="6db42-232">In the **IntelliTrace** window, click **Break All**.</span></span>

<span data-ttu-id="6db42-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="6db42-234">**[IntelliTrace]** ウィンドウには、最近のイベントの一覧が表示されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-234">The **IntelliTrace** window displays a list of recent events:</span></span>

<span data-ttu-id="6db42-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="6db42-236">**[ADO.NET]** 行をクリックします。</span><span class="sxs-lookup"><span data-stu-id="6db42-236">Click the **ADO.NET** line.</span></span> <span data-ttu-id="6db42-237">展開すると、コマンドテキストが表示されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-237">It expands to show you the command text:</span></span>

<span data-ttu-id="6db42-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="6db42-239">コマンドテキスト文字列全体をクリップボードにコピーするには、 **[ローカル]** ウィンドウを使用します。</span><span class="sxs-lookup"><span data-stu-id="6db42-239">You can copy the entire command text string to the clipboard from the **Locals** window.</span></span>

<span data-ttu-id="6db42-240">単純な `School` データベースよりも多くのテーブル、リレーションシップ、および列を含むデータベースを操作しているとします。</span><span class="sxs-lookup"><span data-stu-id="6db42-240">Suppose you were working with a database with more tables, relationships, and columns than the simple `School` database.</span></span> <span data-ttu-id="6db42-241">複数の `Join` 句を含む1つの `Select` ステートメントで必要なすべての情報を収集するクエリが複雑すぎるため、効率的に作業できなくなる場合があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-241">You might find that a query that gathers all the information you need in a single `Select` statement containing multiple `Join` clauses becomes too complex to work efficiently.</span></span> <span data-ttu-id="6db42-242">その場合は、一括読み込みから明示的な読み込みに切り替えて、クエリを簡略化することができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-242">In that case you can switch from eager loading to explicit loading to simplify the query.</span></span>

<span data-ttu-id="6db42-243">たとえば、 *SchoolRepository.cs*の `GetDepartmentsByName` メソッドでコードを変更してみてください。</span><span class="sxs-lookup"><span data-stu-id="6db42-243">For example, try changing the code in the `GetDepartmentsByName` method in *SchoolRepository.cs*.</span></span> <span data-ttu-id="6db42-244">現在、このメソッドには、`Person` と `Courses` ナビゲーションプロパティの `Include` メソッドを持つオブジェクトクエリがあります。</span><span class="sxs-lookup"><span data-stu-id="6db42-244">Currently in that method you have an object query that has `Include` methods for the `Person` and `Courses` navigation properties.</span></span> <span data-ttu-id="6db42-245">次の例に示すように、`return` ステートメントを明示的な読み込みを実行するコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="6db42-245">Replace the `return` statement with code that performs explicit loading, as shown in the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="6db42-246">デバッガーで学科の *.aspx*ページを実行し、前と同じように **[IntelliTrace]** ウィンドウをもう一度確認します。</span><span class="sxs-lookup"><span data-stu-id="6db42-246">Run the *Departments.aspx* page in the debugger and check the **IntelliTrace** window again as you did before.</span></span> <span data-ttu-id="6db42-247">ここでは、1つのクエリがあったところで、長いシーケンスが表示されています。</span><span class="sxs-lookup"><span data-stu-id="6db42-247">Now, where there was a single query before, you see a long sequence of them.</span></span>

<span data-ttu-id="6db42-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="6db42-249">最初の **[ADO.NET]** 行をクリックして、前に表示した複雑なクエリに何が起こったかを確認します。</span><span class="sxs-lookup"><span data-stu-id="6db42-249">Click the first **ADO.NET** line to see what has happened to the complex query you viewed earlier.</span></span>

<span data-ttu-id="6db42-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

<span data-ttu-id="6db42-251">部門からのクエリは、`Join` 句を使用しない単純な `Select` クエリになっていますが、その後に、元のクエリによって返された部門ごとに2つのクエリのセットを使用して、関連するコースと管理者を取得する個別のクエリが続きます。</span><span class="sxs-lookup"><span data-stu-id="6db42-251">The query from Departments has become a simple `Select` query with no `Join` clause, but it's followed by separate queries that retrieve related courses and an administrator, using a set of two queries for each department returned by the original query.</span></span>

> [!NOTE]
> <span data-ttu-id="6db42-252">遅延読み込みを有効にしたままにした場合、ここに表示されるパターンは、同じクエリが何度も繰り返されるため、遅延読み込みによって発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="6db42-252">If you leave lazy loading enabled, the pattern you see here, with the same query repeated many times, might result from lazy loading.</span></span> <span data-ttu-id="6db42-253">一般的に回避するパターンは、プライマリテーブルのすべての行について、遅延読み込み関連データです。</span><span class="sxs-lookup"><span data-stu-id="6db42-253">A pattern that you typically want to avoid is lazy-loading related data for every row of the primary table.</span></span> <span data-ttu-id="6db42-254">1つの結合クエリが複雑すぎて効率的に処理できないことを確認していない場合は、通常、一括読み込みを使用するようにプライマリクエリを変更することで、パフォーマンスを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-254">Unless you've verified that a single join query is too complex to be efficient, you'd typically be able to improve performance in such cases by changing the primary query to use eager loading.</span></span>

## <a name="pre-generating-views"></a><span data-ttu-id="6db42-255">生成前のビュー</span><span class="sxs-lookup"><span data-stu-id="6db42-255">Pre-Generating Views</span></span>

<span data-ttu-id="6db42-256">`ObjectContext` オブジェクトが新しいアプリケーションドメインに最初に作成されると、Entity Framework によって、データベースへのアクセスに使用するクラスのセットが生成されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-256">When an `ObjectContext` object is first created in a new application domain, the Entity Framework generates a set of classes that it uses to access the database.</span></span> <span data-ttu-id="6db42-257">これらのクラスは*ビュー*と呼ばれ、非常に大きなデータモデルがある場合、これらのビューを生成すると、新しいアプリケーションドメインの初期化後にページの最初の要求に対して web サイトの応答が遅れることがあります。</span><span class="sxs-lookup"><span data-stu-id="6db42-257">These classes are called *views*, and if you have a very large data model, generating these views can delay the web site's response to the first request for a page after a new application domain is initialized.</span></span> <span data-ttu-id="6db42-258">実行時ではなく、コンパイル時にビューを作成することによって、この最初の要求の遅延を減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="6db42-258">You can reduce this first-request delay by creating the views at compile time rather than at run time.</span></span>

> [!NOTE]
> <span data-ttu-id="6db42-259">アプリケーションに非常に大きなデータモデルがない場合、またはデータモデルが大規模な場合に、IIS を再利用した後の最初のページ要求のみに影響するパフォーマンス上の問題を懸念していない場合は、このセクションをスキップできます。</span><span class="sxs-lookup"><span data-stu-id="6db42-259">If your application doesn't have an extremely large data model, or if it does have a large data model but you aren't concerned about a performance problem that affects only the very first page request after IIS is recycled, you can skip this section.</span></span> <span data-ttu-id="6db42-260">ビューはアプリケーションドメインにキャッシュされるため、`ObjectContext` オブジェクトをインスタンス化するたびにビューの作成は行われません。</span><span class="sxs-lookup"><span data-stu-id="6db42-260">View creation doesn't happen every time you instantiate an `ObjectContext` object, because the views are cached in the application domain.</span></span> <span data-ttu-id="6db42-261">そのため、IIS でアプリケーションを頻繁にリサイクルしていない限り、事前に生成されたビューを使用すると、ページ要求の数が非常に少なくなります。</span><span class="sxs-lookup"><span data-stu-id="6db42-261">Therefore, unless you're frequently recycling your application in IIS, very few page requests would benefit from pre-generated views.</span></span>

<span data-ttu-id="6db42-262">*Edmgen.exe*コマンドラインツールを使用するか、*テキストテンプレート変換ツールキット*(T4) テンプレートを使用して、ビューを事前に生成できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-262">You can pre-generate views using the *EdmGen.exe* command-line tool or by using a *Text Template Transformation Toolkit* (T4) template.</span></span> <span data-ttu-id="6db42-263">このチュートリアルでは、T4 テンプレートを使用します。</span><span class="sxs-lookup"><span data-stu-id="6db42-263">In this tutorial you'll use a T4 template.</span></span>

<span data-ttu-id="6db42-264">*DAL*フォルダーで、**テキストテンプレート**テンプレート ( **[インストールされたテンプレート]** の一覧の **[全般]** ノードの下にあります) を使用してファイルを追加し、 *SchoolModel.Views.tt*という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="6db42-264">In the *DAL* folder, add a file using the **Text Template** template (it's under the **General** node in the **Installed Templates** list), and name it *SchoolModel.Views.tt*.</span></span> <span data-ttu-id="6db42-265">ファイル内の既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="6db42-265">Replace the existing code in the file with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

<span data-ttu-id="6db42-266">このコードは、テンプレートと同じフォルダーに配置され、テンプレートファイルと同じ名前を持つ *.edmx*ファイルのビューを生成します。</span><span class="sxs-lookup"><span data-stu-id="6db42-266">This code generates views for an *.edmx* file that's located in the same folder as the template and that has the same name as the template file.</span></span> <span data-ttu-id="6db42-267">たとえば、テンプレートファイルの名前が*SchoolModel.Views.tt*の場合、 *SchoolModel*という名前のデータモデルファイルが検索されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-267">For example, if your template file is named *SchoolModel.Views.tt*, it will look for a data model file named *SchoolModel.edmx*.</span></span>

<span data-ttu-id="6db42-268">ファイルを保存し、**ソリューションエクスプローラー**でファイルを右クリックして、 **[カスタムツールの実行]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="6db42-268">Save the file, then right-click the file in **Solution Explorer** and select **Run Custom Tool**.</span></span>

<span data-ttu-id="6db42-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="6db42-270">Visual Studio では、テンプレートに基づいて*SchoolModel.Views.cs*という名前のビューを作成するコードファイルが生成されます。</span><span class="sxs-lookup"><span data-stu-id="6db42-270">Visual Studio generates a code file that creates the views, which is named *SchoolModel.Views.cs* based on the template.</span></span> <span data-ttu-id="6db42-271">(テンプレートファイルを保存するとすぐに **[カスタムツールの実行]** を選択する前に、コードファイルが生成されていることに気付きます)。</span><span class="sxs-lookup"><span data-stu-id="6db42-271">(You might have noticed that the code file is generated even before you select **Run Custom Tool**, as soon as you save the template file.)</span></span>

<span data-ttu-id="6db42-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="6db42-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="6db42-273">これで、アプリケーションを実行し、以前と同じように動作することを確認できます。</span><span class="sxs-lookup"><span data-stu-id="6db42-273">You can now run the application and verify that it works as it did before.</span></span>

<span data-ttu-id="6db42-274">事前に生成されたビューの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-274">For more information about pre-generated views, see the following resources:</span></span>

- <span data-ttu-id="6db42-275">[方法: ビューを事前に生成してクエリのパフォーマンスを向上](https://msdn.microsoft.com/library/bb896240.aspx)させるには、MSDN web サイトを参照してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-275">[How to: Pre-Generate Views to Improve Query Performance](https://msdn.microsoft.com/library/bb896240.aspx) on the MSDN web site.</span></span> <span data-ttu-id="6db42-276">`EdmGen.exe` コマンドラインツールを使用して、ビューを事前に生成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="6db42-276">Explains how to use the `EdmGen.exe` command-line tool to pre-generate views.</span></span>
- <span data-ttu-id="6db42-277">Windows Server AppFabric カスタマーアドバイザリチームブログの[Entity Framework 4 で、プリコンパイル済み/生成済みのビューを使用してパフォーマンスを分離](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="6db42-277">[Isolating Performance with Precompiled/Pre-generated Views in the Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) on the Windows Server AppFabric Customer Advisory Team blog.</span></span>

<span data-ttu-id="6db42-278">このチュートリアルでは、Entity Framework を使用する ASP.NET web アプリケーションでのパフォーマンス向上の概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="6db42-278">This completes the introduction to improving performance in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="6db42-279">詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-279">For more information, see the following resources:</span></span>

- <span data-ttu-id="6db42-280">MSDN web サイトの[パフォーマンスに関する考慮事項 (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="6db42-280">[Performance Considerations (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) on the MSDN web site.</span></span>
- <span data-ttu-id="6db42-281">[Entity Framework チームブログのパフォーマンス関連の投稿](https://blogs.msdn.com/b/adonet/archive/tags/performance/)。</span><span class="sxs-lookup"><span data-stu-id="6db42-281">[Performance-related posts on the Entity Framework Team blog](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span></span>
- <span data-ttu-id="6db42-282">[EF のマージオプションとコンパイル](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx)されたクエリ。</span><span class="sxs-lookup"><span data-stu-id="6db42-282">[EF Merge Options and Compiled Queries](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span></span> <span data-ttu-id="6db42-283">コンパイル済みクエリの予期しない動作と、`NoTracking`などのマージオプションについて説明するブログ記事。</span><span class="sxs-lookup"><span data-stu-id="6db42-283">Blog post that explains unexpected behaviors of compiled queries and merge options such as `NoTracking`.</span></span> <span data-ttu-id="6db42-284">コンパイル済みのクエリを使用する場合、またはアプリケーションでマージオプションの設定を操作する場合は、まずこれを参照してください。</span><span class="sxs-lookup"><span data-stu-id="6db42-284">If you plan to use compiled queries or manipulate merge option settings in your application, read this first.</span></span>
- <span data-ttu-id="6db42-285">[データとモデリングのカスタマーアドバイザリチームブログの Entity Framework 関連の投稿](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/)。</span><span class="sxs-lookup"><span data-stu-id="6db42-285">[Entity Framework-related posts in the Data and Modeling Customer Advisory Team blog](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span></span> <span data-ttu-id="6db42-286">コンパイルされたクエリに関する投稿を含み、Visual Studio 2010 Profiler を使用してパフォーマンスの問題を検出します。</span><span class="sxs-lookup"><span data-stu-id="6db42-286">Includes posts on compiled queries and using the Visual Studio 2010 Profiler to discover performance issues.</span></span>
- <span data-ttu-id="6db42-287">[非常に複雑なクエリのパフォーマンス向上に関するアドバイスを含むフォーラムスレッド Entity Framework](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6)ます。</span><span class="sxs-lookup"><span data-stu-id="6db42-287">[Entity Framework forum thread with advice on improving performance of highly complex queries](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span></span>
- <span data-ttu-id="6db42-288">[ASP.NET 状態管理に関する推奨事項](https://msdn.microsoft.com/library/z1hkazw7.aspx)。</span><span class="sxs-lookup"><span data-stu-id="6db42-288">[ASP.NET State Management Recommendations](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span></span>
- <span data-ttu-id="6db42-289">[Entity Framework と ObjectDataSource: カスタムページングを使用](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="6db42-289">[Using the Entity Framework and the ObjectDataSource: Custom Paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span></span> <span data-ttu-id="6db42-290">これらのチュートリアルで作成した ContosoUniversity アプリケーションを基にしたブログ投稿では、department*ページで*ページングを実装する方法を説明しています。</span><span class="sxs-lookup"><span data-stu-id="6db42-290">Blog post that builds on the ContosoUniversity application created in these tutorials to explain how to implement paging in the *Departments.aspx* page.</span></span>

<span data-ttu-id="6db42-291">次のチュートリアルでは、バージョン4の新機能である Entity Framework のいくつかの重要な機能強化について確認します。</span><span class="sxs-lookup"><span data-stu-id="6db42-291">The next tutorial reviews some of the important enhancements to the Entity Framework that are new in version 4.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="6db42-292">[前へ](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
> [次へ](what-s-new-in-the-entity-framework-4.md)</span><span class="sxs-lookup"><span data-stu-id="6db42-292">[Previous](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
[Next](what-s-new-in-the-entity-framework-4.md)</span></span>
