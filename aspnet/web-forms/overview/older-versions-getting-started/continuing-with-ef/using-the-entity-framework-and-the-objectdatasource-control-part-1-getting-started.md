---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
title: 'Entity Framework 4.0 と ObjectDataSource コントロールを使用して、パート 1: はじめに |Microsoft Docs'
author: tdykstra
description: このチュートリアルシリーズは、Entity Framework チュートリアルシリーズを使用してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。 If...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 244278c1-fec8-4255-8a8a-13bde491c4f5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
msc.type: authoredcontent
ms.openlocfilehash: 2f14707eb058d438495dd2bc4c17b976c471fc97
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78440404"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-1-getting-started"></a><span data-ttu-id="36a45-104">Entity Framework 4.0 と ObjectDataSource コントロールを使用して、パート 1: はじめに</span><span class="sxs-lookup"><span data-stu-id="36a45-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 1: Getting Started</span></span>

<span data-ttu-id="36a45-105">[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="36a45-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="36a45-106">このチュートリアルシリーズは、 [Entity Framework 4.0 チュートリアルシリーズを使用](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。</span><span class="sxs-lookup"><span data-stu-id="36a45-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series.</span></span> <span data-ttu-id="36a45-107">前のチュートリアルを完了していない場合は、このチュートリアルの開始点として、作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)できます。</span><span class="sxs-lookup"><span data-stu-id="36a45-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="36a45-108">チュートリアルシリーズ全体で作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)することもできます。</span><span class="sxs-lookup"><span data-stu-id="36a45-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span>
> 
> <span data-ttu-id="36a45-109">Contoso 大学のサンプル web アプリケーションは、Entity Framework 4.0 と Visual Studio 2010 を使用して ASP.NET Web フォームアプリケーションを作成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="36a45-109">The Contoso University sample web application demonstrates how to create ASP.NET Web Forms applications using the Entity Framework 4.0 and Visual Studio 2010.</span></span> <span data-ttu-id="36a45-110">サンプルアプリケーションは、架空の Contoso 大学の web サイトです。</span><span class="sxs-lookup"><span data-stu-id="36a45-110">The sample application is a website for a fictional Contoso University.</span></span> <span data-ttu-id="36a45-111">学生の受け付け、講座の作成、講師の割り当てなどの機能が含まれています。</span><span class="sxs-lookup"><span data-stu-id="36a45-111">It includes functionality such as student admission, course creation, and instructor assignments.</span></span>
> 
> <span data-ttu-id="36a45-112">このチュートリアルでは、 C#の例を示します。</span><span class="sxs-lookup"><span data-stu-id="36a45-112">The tutorial shows examples in C#.</span></span> <span data-ttu-id="36a45-113">ダウンロード可能な[サンプル](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)には、 C#と Visual Basic の両方のコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="36a45-113">The [downloadable sample](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contains code in both C# and Visual Basic.</span></span>
> 
> ## <a name="database-first"></a><span data-ttu-id="36a45-114">Database First</span><span class="sxs-lookup"><span data-stu-id="36a45-114">Database First</span></span>
> 
> <span data-ttu-id="36a45-115">Entity Framework のデータを操作するには、 *Database First*、 *Model First*、および*Code First*の3つの方法があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-115">There are three ways you can work with data in the Entity Framework: *Database First*, *Model First*, and *Code First*.</span></span> <span data-ttu-id="36a45-116">このチュートリアルは Database First を対象としています。</span><span class="sxs-lookup"><span data-stu-id="36a45-116">This tutorial is for Database First.</span></span> <span data-ttu-id="36a45-117">これらのワークフローの違いと、シナリオに最適なワークフローを選択する方法については、「 [Entity Framework 開発ワークフロー](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-117">For information about the differences between these workflows and guidance on how to choose the best one for your scenario, see [Entity Framework Development Workflows](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span></span>
> 
> ## <a name="web-forms"></a><span data-ttu-id="36a45-118">Web フォーム</span><span class="sxs-lookup"><span data-stu-id="36a45-118">Web Forms</span></span>
> 
> <span data-ttu-id="36a45-119">はじめにシリーズと同様に、このチュートリアルシリーズでは ASP.NET Web フォームモデルを使用しており、Visual Studio で ASP.NET Web フォームを操作する方法を理解していることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="36a45-119">Like the Getting Started series, this tutorial series uses the ASP.NET Web Forms model and assumes you know how to work with ASP.NET Web Forms in Visual Studio.</span></span> <span data-ttu-id="36a45-120">そうでない場合は、「[はじめにと ASP.NET 4.5 Web フォーム](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-120">If you don't, see [Getting Started with ASP.NET 4.5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span></span> <span data-ttu-id="36a45-121">ASP.NET MVC フレームワークを使用する場合は、「 [ASP.NET mvc を使用した Entity Framework でのはじめに](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-121">If you prefer to work with the ASP.NET MVC framework, see [Getting Started with the Entity Framework using ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>
> 
> ## <a name="software-versions"></a><span data-ttu-id="36a45-122">ソフトウェアのバージョン</span><span class="sxs-lookup"><span data-stu-id="36a45-122">Software versions</span></span>
> 
> | <span data-ttu-id="36a45-123">**チュートリアルに表示されます。**</span><span class="sxs-lookup"><span data-stu-id="36a45-123">**Shown in the tutorial**</span></span> | <span data-ttu-id="36a45-124">**でも動作します。**</span><span class="sxs-lookup"><span data-stu-id="36a45-124">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="36a45-125">Windows 7</span><span class="sxs-lookup"><span data-stu-id="36a45-125">Windows 7</span></span> | <span data-ttu-id="36a45-126">Windows 8</span><span class="sxs-lookup"><span data-stu-id="36a45-126">Windows 8</span></span> |
> | <span data-ttu-id="36a45-127">Visual Studio 2010</span><span class="sxs-lookup"><span data-stu-id="36a45-127">Visual Studio 2010</span></span> | <span data-ttu-id="36a45-128">Visual Studio 2010 Express for Web。</span><span class="sxs-lookup"><span data-stu-id="36a45-128">Visual Studio 2010 Express for Web.</span></span> <span data-ttu-id="36a45-129">このチュートリアルは、以降のバージョンの Visual Studio ではテストされていません。</span><span class="sxs-lookup"><span data-stu-id="36a45-129">The tutorial has not been tested with later versions of Visual Studio.</span></span> <span data-ttu-id="36a45-130">メニューの選択、ダイアログボックス、テンプレートにはさまざまな違いがあります。</span><span class="sxs-lookup"><span data-stu-id="36a45-130">There are many differences in menu selections, dialog boxes, and templates.</span></span> |
> | <span data-ttu-id="36a45-131">.NET 4</span><span class="sxs-lookup"><span data-stu-id="36a45-131">.NET 4</span></span> | <span data-ttu-id="36a45-132">.Net 4.5 は .NET 4 と下位互換性がありますが、このチュートリアルは .NET 4.5 ではテストされていません。</span><span class="sxs-lookup"><span data-stu-id="36a45-132">.NET 4.5 is backward compatible with .NET 4, but the tutorial has not been tested with .NET 4.5.</span></span> |
> | <span data-ttu-id="36a45-133">Entity Framework 4</span><span class="sxs-lookup"><span data-stu-id="36a45-133">Entity Framework 4</span></span> | <span data-ttu-id="36a45-134">このチュートリアルは、以降のバージョンの Entity Framework ではテストされていません。</span><span class="sxs-lookup"><span data-stu-id="36a45-134">The tutorial has not been tested with later versions of Entity Framework.</span></span> <span data-ttu-id="36a45-135">Entity Framework 5 以降では、ef 4.1 で導入された `DbContext API` が既定で使用されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-135">Starting with Entity Framework 5, EF uses by default the `DbContext API` that was introduced with EF 4.1.</span></span> <span data-ttu-id="36a45-136">EntityDataSource コントロールは、`ObjectContext` API を使用するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="36a45-136">The EntityDataSource control was designed to use the `ObjectContext` API.</span></span> <span data-ttu-id="36a45-137">`DbContext` API で EntityDataSource コントロールを使用する方法の詳細については、[このブログ投稿](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-137">For information about how to use the EntityDataSource control with the `DbContext` API, see [this blog post](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span></span> |
> 
> ## <a name="questions"></a><span data-ttu-id="36a45-138">疑問がある場合</span><span class="sxs-lookup"><span data-stu-id="36a45-138">Questions</span></span>
> 
> <span data-ttu-id="36a45-139">チュートリアルに直接関係のない質問がある場合は、 [ASP.NET Entity Framework フォーラム](https://forums.asp.net/1227.aspx)、 [Entity Framework と LINQ to Entities フォーラム](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/)、または[StackOverflow.com](http://stackoverflow.com/)に投稿できます。</span><span class="sxs-lookup"><span data-stu-id="36a45-139">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx), the [Entity Framework and LINQ to Entities forum](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), or [StackOverflow.com](http://stackoverflow.com/).</span></span>

<span data-ttu-id="36a45-140">`EntityDataSource` コントロールを使用すると、アプリケーションを非常に短時間で作成できますが、通常は、 *.aspx*ページで大量のビジネスロジックとデータアクセスロジックを保持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-140">The `EntityDataSource` control enables you to create an application very quickly, but it typically requires you to keep a significant amount of business logic and data-access logic in your *.aspx* pages.</span></span> <span data-ttu-id="36a45-141">アプリケーションが複雑さを増し、継続的なメンテナンスを必要とする場合は、より保守しやすい*n 層* *または複数層の*アプリケーション構造を作成するために、より多くの開発時間を事前に投資することができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-141">If you expect your application to grow in complexity and to require ongoing maintenance, you can invest more development time up front in order to create an *n-tier* or *layered* application structure that's more maintainable.</span></span> <span data-ttu-id="36a45-142">このアーキテクチャを実装するには、プレゼンテーション層をビジネスロジック層 (BLL) とデータアクセス層 (DAL) から分離します。</span><span class="sxs-lookup"><span data-stu-id="36a45-142">To implement this architecture, you separate the presentation layer from the business logic layer (BLL) and the data access layer (DAL).</span></span> <span data-ttu-id="36a45-143">この構造体を実装する方法の1つは、`EntityDataSource` コントロールではなく、`ObjectDataSource` コントロールを使用することです。</span><span class="sxs-lookup"><span data-stu-id="36a45-143">One way to implement this structure is to use the `ObjectDataSource` control instead of the `EntityDataSource` control.</span></span> <span data-ttu-id="36a45-144">`ObjectDataSource` コントロールを使用する場合は、独自のデータアクセスコードを実装し、他のデータソースコントロールと同じ機能の多くを持つコントロールを使用して *.aspx*ページで呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-144">When you use the `ObjectDataSource` control, you implement your own data-access code and then invoke it in *.aspx* pages using a control that has many of the same features as other data-source controls.</span></span> <span data-ttu-id="36a45-145">これにより、データアクセスに Web フォームコントロールを使用する利点と比較して、n 層アプローチの利点を組み合わせることができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-145">This lets you combine the advantages of an n-tier approach with the benefits of using a Web Forms control for data access.</span></span>

<span data-ttu-id="36a45-146">`ObjectDataSource` コントロールを使用すると、他の方法でも柔軟性を高めることができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-146">The `ObjectDataSource` control gives you more flexibility in other ways as well.</span></span> <span data-ttu-id="36a45-147">独自のデータアクセスコードを記述するので、特定のエンティティ型を読み取り、挿入、更新、または削除するだけでなく、`EntityDataSource` コントロールが実行するように設計されたタスクでも、より簡単に行うことができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-147">Because you write your own data-access code, it's easier to do more than just read, insert, update, or delete a specific entity type, which are the tasks that the `EntityDataSource` control is designed to perform.</span></span> <span data-ttu-id="36a45-148">たとえば、エンティティが更新されるたびにログ記録を実行したり、エンティティが削除されるたびにデータをアーカイブしたり、外部キー値を持つ行を挿入するときに必要に応じて関連データを自動的にチェックおよび更新したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="36a45-148">For example, you can perform logging every time an entity is updated, archive data whenever an entity is deleted, or automatically check and update related data as needed when inserting a row with a foreign key value.</span></span>

## <a name="business-logic-and-repository-classes"></a><span data-ttu-id="36a45-149">ビジネスロジックとリポジトリクラス</span><span class="sxs-lookup"><span data-stu-id="36a45-149">Business Logic and Repository Classes</span></span>

<span data-ttu-id="36a45-150">`ObjectDataSource` コントロールは、作成したクラスを呼び出すことによって機能します。</span><span class="sxs-lookup"><span data-stu-id="36a45-150">An `ObjectDataSource` control works by invoking a class that you create.</span></span> <span data-ttu-id="36a45-151">クラスには、データを取得および更新するメソッドが含まれています。また、これらのメソッドの名前をマークアップの `ObjectDataSource` コントロールに指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-151">The class includes methods that retrieve and update data, and you provide the names of those methods to the `ObjectDataSource` control in markup.</span></span> <span data-ttu-id="36a45-152">レンダリングまたはポストバック処理中に、`ObjectDataSource` は指定したメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="36a45-152">During rendering or postback processing, the `ObjectDataSource` calls the methods that you've specified.</span></span>

<span data-ttu-id="36a45-153">基本的な CRUD 操作に加えて、`ObjectDataSource` コントロールで使用するために作成するクラスは、`ObjectDataSource` がデータを読み取りまたは更新するときにビジネスロジックを実行することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-153">Besides basic CRUD operations, the class that you create to use with the `ObjectDataSource` control might need to execute business logic when the `ObjectDataSource` reads or updates data.</span></span> <span data-ttu-id="36a45-154">たとえば、部門を更新するときに、1人のユーザーが複数の部門の管理者になることができないため、他の部署が同じ管理者を持っていないことを検証する必要がある場合があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-154">For example, when you update a department, you might need to validate that no other departments have the same administrator because one person cannot be administrator of more than one department.</span></span>

<span data-ttu-id="36a45-155">[ObjectDataSource クラスの概要](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx)など、一部の `ObjectDataSource` ドキュメントでは、コントロールはビジネスロジックとデータアクセスロジックの両方を含む*ビジネスオブジェクト*と呼ばれるクラスを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="36a45-155">In some `ObjectDataSource` documentation, such as the [ObjectDataSource Class overview](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), the control calls a class referred to as a *business object* that includes both business logic and data-access logic.</span></span> <span data-ttu-id="36a45-156">このチュートリアルでは、ビジネスロジックとデータアクセスロジックに個別のクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-156">In this tutorial you will create separate classes for business logic and for data-access logic.</span></span> <span data-ttu-id="36a45-157">データアクセスロジックをカプセル化するクラスは、*リポジトリ*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="36a45-157">The class that encapsulates data-access logic is called a *repository*.</span></span> <span data-ttu-id="36a45-158">ビジネスロジッククラスには、ビジネスロジックメソッドとデータアクセスメソッドの両方が含まれていますが、データアクセスメソッドはリポジトリを呼び出してデータアクセスタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="36a45-158">The business logic class includes both business-logic methods and data-access methods, but the data-access methods call the repository to perform data-access tasks.</span></span>

<span data-ttu-id="36a45-159">また、bll の自動単体テストを容易にする、BLL と DAL の間に抽象レイヤーを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-159">You will also create an abstraction layer between your BLL and DAL that facilitates automated unit testing of the BLL.</span></span> <span data-ttu-id="36a45-160">この抽象化レイヤーは、ビジネスロジッククラスでリポジトリをインスタンス化するときに、インターフェイスを作成し、インターフェイスを使用することによって実装されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-160">This abstraction layer is implemented by creating an interface and using the interface when you instantiate the repository in the business-logic class.</span></span> <span data-ttu-id="36a45-161">これにより、リポジトリインターフェイスを実装するオブジェクトへの参照をビジネスロジッククラスに提供できるようになります。</span><span class="sxs-lookup"><span data-stu-id="36a45-161">This makes it possible for you to provide the business-logic class with a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="36a45-162">通常の操作では、Entity Framework と連携するリポジトリオブジェクトを指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-162">For normal operation, you provide a repository object that works with the Entity Framework.</span></span> <span data-ttu-id="36a45-163">テストでは、コレクションとして定義されているクラス変数など、簡単に操作できる方法で格納されたデータを処理するリポジトリオブジェクトを提供します。</span><span class="sxs-lookup"><span data-stu-id="36a45-163">For testing, you provide a repository object that works with data stored in a way that you can easily manipulate, such as class variables defined as collections.</span></span>

<span data-ttu-id="36a45-164">次の図は、リポジトリを使用しないデータアクセスロジックとリポジトリを使用するビジネスロジッククラスの違いを示しています。</span><span class="sxs-lookup"><span data-stu-id="36a45-164">The following illustration shows the difference between a business-logic class that includes data-access logic without a repository and one that uses a repository.</span></span>

<span data-ttu-id="36a45-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span></span>

<span data-ttu-id="36a45-166">まず、基本的なデータアクセスタスクのみを実行するため、`ObjectDataSource` コントロールがリポジトリに直接バインドされている web ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-166">You will begin by creating web pages in which the `ObjectDataSource` control is bound directly to a repository because it only performs basic data-access tasks.</span></span> <span data-ttu-id="36a45-167">次のチュートリアルでは、検証ロジックを使用してビジネスロジッククラスを作成し、リポジトリクラスではなく、そのクラスに `ObjectDataSource` コントロールをバインドします。</span><span class="sxs-lookup"><span data-stu-id="36a45-167">In the next tutorial you will create a business logic class with validation logic and bind the `ObjectDataSource` control to that class instead of to the repository class.</span></span> <span data-ttu-id="36a45-168">また、検証ロジックの単体テストも作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-168">You will also create unit tests for the validation logic.</span></span> <span data-ttu-id="36a45-169">このシリーズの3番目のチュートリアルでは、アプリケーションに並べ替えとフィルター処理の機能を追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-169">In the third tutorial in this series you will add sorting and filtering functionality to the application.</span></span>

<span data-ttu-id="36a45-170">このチュートリアルで作成するページは、[はじめにチュートリアルシリーズ](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)で作成したデータモデルの `Departments` エンティティセットに対応しています。</span><span class="sxs-lookup"><span data-stu-id="36a45-170">The pages you create in this tutorial work with the `Departments` entity set of the data model that you created in the [Getting Started tutorial series](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span></span>

<span data-ttu-id="36a45-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span></span>

<span data-ttu-id="36a45-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span></span>

## <a name="updating-the-database-and-the-data-model"></a><span data-ttu-id="36a45-173">データベースとデータモデルの更新</span><span class="sxs-lookup"><span data-stu-id="36a45-173">Updating the Database and the Data Model</span></span>

<span data-ttu-id="36a45-174">このチュートリアルを開始するには、データベースに2つの変更を加えます。どちらも、 [Entity Framework および Web フォームのチュートリアルではじめに](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)で作成したデータモデルに対応する変更を必要とします。</span><span class="sxs-lookup"><span data-stu-id="36a45-174">You will begin this tutorial by making two changes to the database, both of which require corresponding changes to the data model that you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorials.</span></span> <span data-ttu-id="36a45-175">これらのチュートリアルでは、データベースが変更された後に、デザイナーで手動で変更を行って、データモデルをデータベースと同期させました。</span><span class="sxs-lookup"><span data-stu-id="36a45-175">In one of those tutorials, you made changes in the designer manually to synchronize the data model with the database after a database change.</span></span> <span data-ttu-id="36a45-176">このチュートリアルでは、データベースツールのデザイナーの**更新モデル**を使用して、データモデルを自動的に更新します。</span><span class="sxs-lookup"><span data-stu-id="36a45-176">In this tutorial, you will use the designer's **Update Model From Database** tool to update the data model automatically.</span></span>

### <a name="adding-a-relationship-to-the-database"></a><span data-ttu-id="36a45-177">データベースへのリレーションシップの追加</span><span class="sxs-lookup"><span data-stu-id="36a45-177">Adding a Relationship to the Database</span></span>

<span data-ttu-id="36a45-178">Visual Studio で、 [Entity Framework および Web フォーム](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)チュートリアルシリーズを使用してはじめにで作成した Contoso 大学 web アプリケーションを開き、`SchoolDiagram` データベースダイアグラムを開きます。</span><span class="sxs-lookup"><span data-stu-id="36a45-178">In Visual Studio, open the Contoso University web application you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series, and then open the `SchoolDiagram` database diagram.</span></span>

<span data-ttu-id="36a45-179">データベースダイアグラムの `Department` テーブルを見ると、`Administrator` 列があることがわかります。</span><span class="sxs-lookup"><span data-stu-id="36a45-179">If you look at the `Department` table in the database diagram, you will see that it has an `Administrator` column.</span></span> <span data-ttu-id="36a45-180">この列は `Person` テーブルに対する外部キーですが、データベースに外部キーリレーションシップが定義されていません。</span><span class="sxs-lookup"><span data-stu-id="36a45-180">This column is a foreign key to the `Person` table, but no foreign key relationship is defined in the database.</span></span> <span data-ttu-id="36a45-181">リレーションシップを作成し、データモデルを更新して、Entity Framework がこのリレーションシップを自動的に処理できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-181">You need to create the relationship and update the data model so that the Entity Framework can automatically handle this relationship.</span></span>

<span data-ttu-id="36a45-182">データベースダイアグラムで、`Department` テーブルを右クリックし、 **[リレーションシップ]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-182">In the database diagram, right-click the `Department` table, and select **Relationships**.</span></span>

<span data-ttu-id="36a45-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span></span>

<span data-ttu-id="36a45-184">**[外部キーのリレーションシップ]** ボックスで **[追加]** をクリックし、 **[テーブルと列の指定]** の省略記号をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-184">In the **Foreign Key Relationships** box click **Add**, then click the ellipsis for **Tables and Columns Specification**.</span></span>

<span data-ttu-id="36a45-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span></span>

<span data-ttu-id="36a45-186">**[テーブルと列]** ダイアログボックスで、主キーのテーブルとフィールドを `Person` と `PersonID`に設定し、外部キーのテーブルとフィールドを `Department` および `Administrator`に設定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-186">In the **Tables and Columns** dialog box, set the primary key table and field to `Person` and `PersonID`, and set the foreign key table and field to `Department` and `Administrator`.</span></span> <span data-ttu-id="36a45-187">(これを行うと、リレーションシップ名が `FK_Department_Department` から `FK_Department_Person`に変わります)。</span><span class="sxs-lookup"><span data-stu-id="36a45-187">(When you do this, the relationship name will change from `FK_Department_Department` to `FK_Department_Person`.)</span></span>

<span data-ttu-id="36a45-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span></span>

<span data-ttu-id="36a45-189">**[テーブルと列]** ボックスの **[OK]** をクリックし、 **[外部キーのリレーションシップ]** ボックスの **[閉じる]** をクリックして、変更を保存します。</span><span class="sxs-lookup"><span data-stu-id="36a45-189">Click **OK** in the **Tables and Columns** box, click **Close** in the **Foreign Key Relationships** box, and save the changes.</span></span> <span data-ttu-id="36a45-190">`Person` テーブルと `Department` テーブルを保存するかどうかを確認するメッセージが表示されたら、 **[はい]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-190">If you're asked if you want to save the `Person` and `Department` tables, click **Yes**.</span></span>

> [!NOTE]
> <span data-ttu-id="36a45-191">`Administrator` 列に既に存在するデータに対応する `Person` 行を削除した場合、この変更を保存することはできません。</span><span class="sxs-lookup"><span data-stu-id="36a45-191">If you've deleted `Person` rows that correspond to data that's already in the `Administrator` column, you will not be able to save this change.</span></span> <span data-ttu-id="36a45-192">その場合は、**サーバーエクスプローラー**のテーブルエディターを使用して、すべての `Department` 行の `Administrator` 値に、`Person` テーブルに実際に存在するレコードの ID が含まれていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-192">In that case, use the table editor in **Server Explorer** to make sure that the `Administrator` value in every `Department` row contains the ID of a record that actually exists in the `Person` table.</span></span>
> 
> <span data-ttu-id="36a45-193">変更を保存した後、そのユーザーが部門の管理者である場合、`Person` テーブルから行を削除することはできません。</span><span class="sxs-lookup"><span data-stu-id="36a45-193">After you save the change, you will not be able to delete a row from the `Person` table if that person is a department administrator.</span></span> <span data-ttu-id="36a45-194">実稼働アプリケーションでは、データベースの制約によって削除が禁止されている場合、または連鎖削除を指定した場合に、特定のエラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-194">In a production application, you would provide a specific error message when a database constraint prevents a deletion, or you would specify a cascading delete.</span></span> <span data-ttu-id="36a45-195">連鎖削除を指定する方法の例については、「 [Entity Framework と ASP.NET –はじめにパート 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-195">For an example of how to specify a cascading delete, see [The Entity Framework and ASP.NET – Getting Started Part 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span></span>

### <a name="adding-a-view-to-the-database"></a><span data-ttu-id="36a45-196">データベースへのビューの追加</span><span class="sxs-lookup"><span data-stu-id="36a45-196">Adding a View to the Database</span></span>

<span data-ttu-id="36a45-197">作成*する新しい department*ページで、ユーザーが部門管理者を選択できるように、講師のドロップダウンリストを "last, first" の形式で入力します。</span><span class="sxs-lookup"><span data-stu-id="36a45-197">In the new *Departments.aspx* page that you will be creating, you want to provide a drop-down list of instructors, with names in "last, first" format so that users can select department administrators.</span></span> <span data-ttu-id="36a45-198">この操作を簡単に行うには、データベースにビューを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-198">To make it easier to do that, you will create a view in the database.</span></span> <span data-ttu-id="36a45-199">ビューは、ドロップダウンリストに必要なデータのみで構成されます。完全な名前 (正しい形式) とレコードキーです。</span><span class="sxs-lookup"><span data-stu-id="36a45-199">The view will consist of just the data needed by the drop-down list: the full name (properly formatted) and the record key.</span></span>

<span data-ttu-id="36a45-200">**サーバーエクスプローラー**で、[ *School .mdf*] を展開し、 **[ビュー]** フォルダーを右クリックして、 **[新しいビューの追加]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="36a45-200">In **Server Explorer**, expand *School.mdf*, right-click the **Views** folder, and select **Add New View**.</span></span>

<span data-ttu-id="36a45-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span></span>

<span data-ttu-id="36a45-202">**[テーブルの追加]** ダイアログボックスが表示されたら **[閉じる]** をクリックし、sql ペインに次の sql ステートメントを貼り付けます。</span><span class="sxs-lookup"><span data-stu-id="36a45-202">Click **Close** when the **Add Table** dialog box appears, and paste the following SQL statement into the SQL pane:</span></span>

[!code-sql[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample1.sql)]

<span data-ttu-id="36a45-203">ビューを `vInstructorName`として保存します。</span><span class="sxs-lookup"><span data-stu-id="36a45-203">Save the view as `vInstructorName`.</span></span>

### <a name="updating-the-data-model"></a><span data-ttu-id="36a45-204">データモデルの更新</span><span class="sxs-lookup"><span data-stu-id="36a45-204">Updating the Data Model</span></span>

<span data-ttu-id="36a45-205">*DAL*フォルダーで、 *SchoolModel*ファイルを開き、デザイン画面を右クリックして、 **[データベースからモデルを更新]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="36a45-205">In the *DAL* folder, open the *SchoolModel.edmx* file, right-click the design surface, and select **Update Model from Database**.</span></span>

<span data-ttu-id="36a45-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span></span>

<span data-ttu-id="36a45-207">**[データベースオブジェクトの選択]** ダイアログボックスで、 **[追加]** タブを選択し、先ほど作成したビューを選択します。</span><span class="sxs-lookup"><span data-stu-id="36a45-207">In the **Choose Your Database Objects** dialog box, select the **Add** tab and select the view you just created.</span></span>

<span data-ttu-id="36a45-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span></span>

<span data-ttu-id="36a45-209">**[完了]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-209">Click **Finish**.</span></span>

<span data-ttu-id="36a45-210">デザイナーでは、このツールによって、`vInstructorName` エンティティと、`Department` エンティティと `Person` エンティティの間の新しいアソシエーションが作成されたことがわかります。</span><span class="sxs-lookup"><span data-stu-id="36a45-210">In the designer, you see that the tool created a `vInstructorName` entity and a new association between the `Department` and `Person` entities.</span></span>

<span data-ttu-id="36a45-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span></span>

> [!NOTE]
> <span data-ttu-id="36a45-212">**[出力]** ウィンドウと **[エラー一覧]** ウィンドウに、ツールによって新しい `vInstructorName` ビューの主キーが自動的に作成されたことを知らせる警告メッセージが表示される場合があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-212">In the **Output** and **Error List** windows you might see a warning message informing you that the tool automatically created a primary key for the new `vInstructorName` view.</span></span> <span data-ttu-id="36a45-213">これは正しい動作です。</span><span class="sxs-lookup"><span data-stu-id="36a45-213">This is expected behavior.</span></span>

<span data-ttu-id="36a45-214">コードで新しい `vInstructorName` エンティティを参照する場合、小文字の "v" にプレフィックスとして付けるデータベース規則を使用しないことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="36a45-214">When you refer to the new `vInstructorName` entity in code, you don't want to use the database convention of prefixing a lower-case "v" to it.</span></span> <span data-ttu-id="36a45-215">そのため、モデル内のエンティティとエンティティセットの名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="36a45-215">Therefore, you will rename the entity and entity set in the model.</span></span>

<span data-ttu-id="36a45-216">**モデルブラウザー**を開きます。</span><span class="sxs-lookup"><span data-stu-id="36a45-216">Open the **Model Browser**.</span></span> <span data-ttu-id="36a45-217">エンティティ型とビュー `vInstructorName` 表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-217">You see `vInstructorName` listed as an entity type and a view.</span></span>

<span data-ttu-id="36a45-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span></span>

<span data-ttu-id="36a45-219">[ **SchoolModel** ( **SchoolModel**)] で、 **[vInstructorName]** を右クリックし、 **[プロパティ]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="36a45-219">Under **SchoolModel** (not **SchoolModel.Store**), right-click **vInstructorName** and select **Properties**.</span></span> <span data-ttu-id="36a45-220">**[プロパティ]** ウィンドウで、 **[名前]** プロパティを "InstructorName" に変更し、 **[エンティティセット名]** プロパティを "InstructorNames" に変更します。</span><span class="sxs-lookup"><span data-stu-id="36a45-220">In the **Properties** window, change the **Name** property to "InstructorName" and change the **Entity Set Name** property to "InstructorNames".</span></span>

<span data-ttu-id="36a45-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span></span>

<span data-ttu-id="36a45-222">データモデルを保存して閉じてから、プロジェクトをリビルドします。</span><span class="sxs-lookup"><span data-stu-id="36a45-222">Save and close the data model, and then rebuild the project.</span></span>

## <a name="using-a-repository-class-and-an-objectdatasource-control"></a><span data-ttu-id="36a45-223">リポジトリクラスと ObjectDataSource コントロールの使用</span><span class="sxs-lookup"><span data-stu-id="36a45-223">Using a Repository Class and an ObjectDataSource Control</span></span>

<span data-ttu-id="36a45-224">*DAL*フォルダーに新しいクラスファイルを作成し、 *SchoolRepository.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="36a45-224">Create a new class file in the *DAL* folder, name it *SchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample2.cs)]

<span data-ttu-id="36a45-225">このコードは、`Departments` エンティティセット内のすべてのエンティティを返す1つの `GetDepartments` メソッドを提供します。</span><span class="sxs-lookup"><span data-stu-id="36a45-225">This code provides a single `GetDepartments` method that returns all of the entities in the `Departments` entity set.</span></span> <span data-ttu-id="36a45-226">返されるすべての行の `Person` ナビゲーションプロパティにアクセスすることがわかっているので、`Include` メソッドを使用して、そのプロパティの一括読み込みを指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-226">Because you know that you will be accessing the `Person` navigation property for every row returned, you specify eager loading for that property by using the `Include` method.</span></span> <span data-ttu-id="36a45-227">また、クラスは、オブジェクトが破棄されたときにデータベース接続が解放されるように、`IDisposable` インターフェイスも実装します。</span><span class="sxs-lookup"><span data-stu-id="36a45-227">The class also implements the `IDisposable` interface to ensure that the database connection is released when the object is disposed.</span></span>

> [!NOTE]
> <span data-ttu-id="36a45-228">一般的な方法は、エンティティ型ごとにリポジトリクラスを作成することです。</span><span class="sxs-lookup"><span data-stu-id="36a45-228">A common practice is to create a repository class for each entity type.</span></span> <span data-ttu-id="36a45-229">このチュートリアルでは、複数のエンティティ型に対して1つのリポジトリクラスを使用します。</span><span class="sxs-lookup"><span data-stu-id="36a45-229">In this tutorial, one repository class for multiple entity types is used.</span></span> <span data-ttu-id="36a45-230">リポジトリパターンの詳細については、 [Entity Framework チームのブログ](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx)と[ジュリー Lerman のブログ](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/)で投稿を参照してください。</span><span class="sxs-lookup"><span data-stu-id="36a45-230">For more information about the repository pattern, see the posts in [the Entity Framework team's blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) and [Julie Lerman's blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span></span>

<span data-ttu-id="36a45-231">`GetDepartments` メソッドは、リポジトリオブジェクト自体が破棄された後でも返されたコレクションが使用可能であることを確認するために、`IQueryable` オブジェクトではなく `IEnumerable` オブジェクトを返します。</span><span class="sxs-lookup"><span data-stu-id="36a45-231">The `GetDepartments` method returns an `IEnumerable` object rather than an `IQueryable` object in order to ensure that the returned collection is usable even after the repository object itself is disposed.</span></span> <span data-ttu-id="36a45-232">`IQueryable` オブジェクトは、アクセスされるたびにデータベースへのアクセスが発生する可能性がありますが、データの表示を試みたときにリポジトリオブジェクトが破棄される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-232">An `IQueryable` object can cause database access whenever it's accessed, but the repository object might be disposed by the time a databound control attempts to render the data.</span></span> <span data-ttu-id="36a45-233">`IEnumerable` オブジェクトではなく、`IList` オブジェクトなど、別のコレクション型を返すこともできます。</span><span class="sxs-lookup"><span data-stu-id="36a45-233">You could return another collection type, such as an `IList` object instead of an `IEnumerable` object.</span></span> <span data-ttu-id="36a45-234">ただし、`IEnumerable` オブジェクトを返すと、`foreach` ループや LINQ クエリなどの一般的な読み取り専用のリスト処理タスクを実行できますが、コレクション内のアイテムを追加したり削除したりすることはできません。このような変更がデータベースに保存される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-234">However, returning an `IEnumerable` object ensures that you can perform typical read-only list processing tasks such as `foreach` loops and LINQ queries, but you cannot add to or remove items in the collection, which might imply that such changes would be persisted to the database.</span></span>

<span data-ttu-id="36a45-235">*.Master*マスターページを使用する department *.aspx*ページを作成し、`Content2`という名前の `Content` コントロールに次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-235">Create a *Departments.aspx* page that uses the *Site.Master* master page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample3.aspx)]

<span data-ttu-id="36a45-236">このマークアップは、先ほど作成したリポジトリクラスを使用する `ObjectDataSource` コントロールと、データを表示するための `GridView` コントロールを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-236">This markup creates an `ObjectDataSource` control that uses the repository class you just created, and a `GridView` control to display the data.</span></span> <span data-ttu-id="36a45-237">`GridView` コントロールでは、 **Edit**コマンドと**Delete**コマンドが指定されていますが、まだサポートするためのコードは追加されていません。</span><span class="sxs-lookup"><span data-stu-id="36a45-237">The `GridView` control specifies **Edit** and **Delete** commands, but you haven't added code to support them yet.</span></span>

<span data-ttu-id="36a45-238">いくつかの列では、データの自動書式設定と検証機能を利用できるように `DynamicField` コントロールを使用しています。</span><span class="sxs-lookup"><span data-stu-id="36a45-238">Several columns use `DynamicField` controls so that you can take advantage of automatic data formatting and validation functionality.</span></span> <span data-ttu-id="36a45-239">これらの機能を使用するには、`Page_Init` イベントハンドラーで `EnableDynamicData` メソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-239">For these to work, you will have to call the `EnableDynamicData` method in the `Page_Init` event handler.</span></span> <span data-ttu-id="36a45-240">(`DynamicControl` コントロールは、ナビゲーションプロパティでは機能しないため、[`Administrator`] フィールドでは使用されません)。</span><span class="sxs-lookup"><span data-stu-id="36a45-240">(`DynamicControl` controls are not used in the `Administrator` field because they don't work with navigation properties.)</span></span>

<span data-ttu-id="36a45-241">入れ子になった `GridView` コントロールを持つ列をグリッドに追加すると、後で `Vertical-Align="Top"` 属性が重要になります。</span><span class="sxs-lookup"><span data-stu-id="36a45-241">The `Vertical-Align="Top"` attributes will become important later when you add a column that has a nested `GridView` control to the grid.</span></span>

<span data-ttu-id="36a45-242">*Departments.aspx.cs*ファイルを開き、次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-242">Open the *Departments.aspx.cs* file and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample4.cs)]

<span data-ttu-id="36a45-243">次に、ページの `Init` イベントに対して次のハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-243">Then add the following handler for the page's `Init` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample5.cs)]

<span data-ttu-id="36a45-244">*DAL*フォルダーで、 *Department.cs*という名前の新しいクラスファイルを作成し、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="36a45-244">In the *DAL* folder, create a new class file named *Department.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample6.cs)]

<span data-ttu-id="36a45-245">このコードでは、メタデータをデータモデルに追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-245">This code adds metadata to the data model.</span></span> <span data-ttu-id="36a45-246">これは、`Department` エンティティの [`Budget`] プロパティが実際には通貨を表すことを指定しますが、そのデータ型は `Decimal`、0から $1000000.00 の間の値である必要があることを指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-246">It specifies that the `Budget` property of the `Department` entity actually represents currency although its data type is `Decimal`, and it specifies that the value must be between 0 and $1,000,000.00.</span></span> <span data-ttu-id="36a45-247">また、`StartDate` プロパティを mm/dd/yyyy の形式で日付として書式設定するように指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-247">It also specifies that the `StartDate` property should be formatted as a date in the format mm/dd/yyyy.</span></span>

<span data-ttu-id="36a45-248">Department *. .aspx*ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="36a45-248">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="36a45-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span></span>

<span data-ttu-id="36a45-250">Department ページマークアップでは、**予算**または**開始日**の列の書式設定文字列を指定していませんが、 *Department.cs*ファイルで指定したメタデータを使用して、`DynamicField` コントロールによって既定の通貨と日付の書式設定が適用されていることに注意して*ください。*</span><span class="sxs-lookup"><span data-stu-id="36a45-250">Notice that although you did not specify a format string in the *Departments.aspx* page markup for the **Budget** or **Start Date** columns, default currency and date formatting has been applied to them by the `DynamicField` controls, using the metadata that you supplied in the *Department.cs* file.</span></span>

## <a name="adding-insert-and-delete-functionality"></a><span data-ttu-id="36a45-251">挿入機能と削除機能の追加</span><span class="sxs-lookup"><span data-stu-id="36a45-251">Adding Insert and Delete Functionality</span></span>

<span data-ttu-id="36a45-252">*SchoolRepository.cs*を開き、`Insert` メソッドと `Delete` メソッドを作成するために次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-252">Open *SchoolRepository.cs*, add the following code in order to create an `Insert` method and a `Delete` method.</span></span> <span data-ttu-id="36a45-253">このコードには、`Insert` メソッドで使用するために使用できる次のレコードキー値を計算する `GenerateDepartmentID` という名前のメソッドも含まれています。</span><span class="sxs-lookup"><span data-stu-id="36a45-253">The code also includes a method named `GenerateDepartmentID` that calculates the next available record key value for use by the `Insert` method.</span></span> <span data-ttu-id="36a45-254">この設定が必要なのは、データベースが `Department` テーブルに対して自動的に計算するように構成されていないためです。</span><span class="sxs-lookup"><span data-stu-id="36a45-254">This is required because the database is not configured to calculate this automatically for the `Department` table.</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample7.cs)]

### <a name="the-attach-method"></a><span data-ttu-id="36a45-255">Attach メソッド</span><span class="sxs-lookup"><span data-stu-id="36a45-255">The Attach Method</span></span>

<span data-ttu-id="36a45-256">`DeleteDepartment` メソッドは、メモリ内のエンティティとそれが表すデータベース行との間で、オブジェクトコンテキストのオブジェクト状態マネージャーに保持されているリンクを再確立するために、`Attach` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="36a45-256">The `DeleteDepartment` method calls the `Attach` method in order to re-establish the link that's maintained in the object context's object state manager between the entity in memory and the database row it represents.</span></span> <span data-ttu-id="36a45-257">これは、メソッドが `SaveChanges` メソッドを呼び出す前に行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-257">This must occur before the method calls the `SaveChanges` method.</span></span>

<span data-ttu-id="36a45-258">*オブジェクトコンテキスト*という用語は、エンティティセットとエンティティにアクセスするために使用する `ObjectContext` クラスから派生した Entity Framework クラスを指します。</span><span class="sxs-lookup"><span data-stu-id="36a45-258">The term *object context* refers to the Entity Framework class that derives from the `ObjectContext` class that you use to access your entity sets and entities.</span></span> <span data-ttu-id="36a45-259">このプロジェクトのコードでは、クラスには `SchoolEntities`という名前が付けられ、のインスタンスには常に `context`という名前が付けられます。</span><span class="sxs-lookup"><span data-stu-id="36a45-259">In the code for this project, the class is named `SchoolEntities`, and an instance of it is always named `context`.</span></span> <span data-ttu-id="36a45-260">オブジェクトコンテキストの*オブジェクト状態マネージャー*は、`ObjectStateManager` クラスから派生するクラスです。</span><span class="sxs-lookup"><span data-stu-id="36a45-260">The object context's *object state manager* is a class that derives from the `ObjectStateManager` class.</span></span> <span data-ttu-id="36a45-261">オブジェクトの連絡先は、オブジェクト状態マネージャーを使用してエンティティオブジェクトを格納し、それぞれがデータベース内の対応するテーブル行と同期しているかどうかを追跡します。</span><span class="sxs-lookup"><span data-stu-id="36a45-261">The object contact uses the object state manager to store entity objects and to keep track of whether each one is in sync with its corresponding table row or rows in the database.</span></span>

<span data-ttu-id="36a45-262">エンティティを読み取ると、オブジェクトコンテキストはオブジェクトをオブジェクト状態マネージャーに格納し、オブジェクトの表現がデータベースと同期されているかどうかを追跡します。</span><span class="sxs-lookup"><span data-stu-id="36a45-262">When you read an entity, the object context stores it in the object state manager and keeps track of whether that representation of the object is in sync with the database.</span></span> <span data-ttu-id="36a45-263">たとえば、プロパティ値を変更すると、変更したプロパティがデータベースと同期されなくなったことを示すフラグが設定されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-263">For example, if you change a property value, a flag is set to indicate that the property you changed is no longer in sync with the database.</span></span> <span data-ttu-id="36a45-264">その後、`SaveChanges` メソッドを呼び出すと、オブジェクトの状態マネージャーは、エンティティの現在の状態とデータベースの状態との間で何が異なるのかを認識しているので、データベースで何を行うのかがオブジェクトのコンテキストに認識されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-264">Then when you call the `SaveChanges` method, the object context knows what to do in the database because the object state manager knows exactly what's different between the current state of the entity and the state of the database.</span></span>

<span data-ttu-id="36a45-265">ただし、このプロセスは通常、web アプリケーションでは機能しません。これは、エンティティを読み取るオブジェクトコンテキストインスタンスとそのオブジェクト状態マネージャーのすべての要素が、ページのレンダリング後に破棄されるためです。</span><span class="sxs-lookup"><span data-stu-id="36a45-265">However, this process typically does not work in a web application, because the object context instance that reads an entity, along with everything in its object state manager, is disposed after a page is rendered.</span></span> <span data-ttu-id="36a45-266">変更を適用する必要があるオブジェクトコンテキストインスタンスは、ポストバック処理用にインスタンス化された新しいインスタンスです。</span><span class="sxs-lookup"><span data-stu-id="36a45-266">The object context instance that must apply changes is a new one that's instantiated for postback processing.</span></span> <span data-ttu-id="36a45-267">`DeleteDepartment` 方法の場合、`ObjectDataSource` コントロールは、ビューステートの値から元のエンティティのエンティティを再作成しますが、この再作成された `Department` エンティティはオブジェクト状態マネージャーに存在しません。</span><span class="sxs-lookup"><span data-stu-id="36a45-267">In the case of the `DeleteDepartment` method, the `ObjectDataSource` control re-creates the original version of the entity for you from values in view state, but this re-created `Department` entity does not exist in the object state manager.</span></span> <span data-ttu-id="36a45-268">この再作成されたエンティティで `DeleteObject` メソッドを呼び出した場合、エンティティがデータベースと同期されているかどうかがオブジェクトコンテキストで認識されないため、呼び出しは失敗します。</span><span class="sxs-lookup"><span data-stu-id="36a45-268">If you called the `DeleteObject` method on this re-created entity, the call would fail because the object context does not know whether the entity is in sync with the database.</span></span> <span data-ttu-id="36a45-269">ただし、`Attach` メソッドを呼び出すと、再作成されたエンティティと、オブジェクトコンテキストの以前のインスタンスでエンティティが読み取られたときに、最初に自動的に実行されたデータベース内の値との間で同じ追跡が再確立されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-269">However, calling the `Attach` method re-establishes the same tracking between the re-created entity and the values in the database that was originally done automatically when the entity was read in an earlier instance of the object context.</span></span>

<span data-ttu-id="36a45-270">オブジェクトコンテキストがオブジェクト状態マネージャーのエンティティを追跡しないようにする場合があります。また、この処理が行われないようにフラグを設定することもできます。</span><span class="sxs-lookup"><span data-stu-id="36a45-270">There are times when you don't want the object context to track entities in the object state manager, and you can set flags to prevent it from doing that.</span></span> <span data-ttu-id="36a45-271">この例については、このシリーズの後のチュートリアルで説明します。</span><span class="sxs-lookup"><span data-stu-id="36a45-271">Examples of this are shown in later tutorials in this series.</span></span>

### <a name="the-savechanges-method"></a><span data-ttu-id="36a45-272">SaveChanges メソッド</span><span class="sxs-lookup"><span data-stu-id="36a45-272">The SaveChanges Method</span></span>

<span data-ttu-id="36a45-273">この単純なリポジトリクラスは、CRUD 操作を実行する方法の基本的な原則を示しています。</span><span class="sxs-lookup"><span data-stu-id="36a45-273">This simple repository class illustrates basic principles of how to perform CRUD operations.</span></span> <span data-ttu-id="36a45-274">この例では、`SaveChanges` メソッドが各更新の直後に呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-274">In this example, the `SaveChanges` method is called immediately after each update.</span></span> <span data-ttu-id="36a45-275">実稼働アプリケーションでは、別のメソッドから `SaveChanges` メソッドを呼び出すことによって、データベースをいつ更新するかをより細かく制御できます。</span><span class="sxs-lookup"><span data-stu-id="36a45-275">In a production application you might want to call the `SaveChanges` method from a separate method to give you more control over when the database is updated.</span></span> <span data-ttu-id="36a45-276">(次のチュートリアルの最後に、関連する更新プログラムを調整するための1つの方法である、作業単位パターンについて説明したホワイトペーパーへのリンクがあります)。この例では、`DeleteDepartment` メソッドに、同時実行の競合を処理するコードが含まれていないことにも注意してください。そのためのコードは、このシリーズの後のチュートリアルで追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-276">(At the end of the next tutorial you will find a link to a white paper that discusses the unit of work pattern which is one approach to coordinating related updates.) Notice also that in the example, the `DeleteDepartment` method does not include code for handling concurrency conflicts; code to do that will be added in a later tutorial in this series.</span></span>

### <a name="retrieving-instructor-names-to-select-when-inserting"></a><span data-ttu-id="36a45-277">挿入時に選択するインストラクター名を取得しています</span><span class="sxs-lookup"><span data-stu-id="36a45-277">Retrieving Instructor Names to Select When Inserting</span></span>

<span data-ttu-id="36a45-278">ユーザーは、新しい部門を作成するときに、ドロップダウンリストでインストラクターの一覧から管理者を選択できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="36a45-278">Users must be able to select an administrator from a list of instructors in a drop-down list when creating new departments.</span></span> <span data-ttu-id="36a45-279">したがって、次のコードを*SchoolRepository.cs*に追加して、前に作成したビューを使用してインストラクターの一覧を取得するメソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-279">Therefore, add the following code to *SchoolRepository.cs* to create a method to retrieve the list of instructors using the view that you created earlier:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample8.cs)]

### <a name="creating-a-page-for-inserting-departments"></a><span data-ttu-id="36a45-280">部署を挿入するためのページの作成</span><span class="sxs-lookup"><span data-stu-id="36a45-280">Creating a Page for Inserting Departments</span></span>

<span data-ttu-id="36a45-281">*DepartmentsAdd*ページを使用するページを作成し、`Content2`という*名前の `Content`* コントロールに次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-281">Create a *DepartmentsAdd.aspx* page that uses the *Site.Master* page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample9.aspx)]

<span data-ttu-id="36a45-282">このマークアップでは、2つの `ObjectDataSource` コントロールが作成されます。1つは新しい `Department` エンティティを挿入するためのコントロールで、もう1つは部門管理者の選択に使用される `DropDownList` コントロールのインストラクター名を取得するためのものです。</span><span class="sxs-lookup"><span data-stu-id="36a45-282">This markup creates two `ObjectDataSource` controls, one for inserting new `Department` entities and one for retrieving instructor names for the `DropDownList` control that's used for selecting department administrators.</span></span> <span data-ttu-id="36a45-283">マークアップは、新しい部署を入力するための `DetailsView` コントロールを作成し、`Administrator` 外部キーの値を設定できるように、コントロールの `ItemInserting` イベントのハンドラーを指定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-283">The markup creates a `DetailsView` control for entering new departments, and it specifies a handler for the control's `ItemInserting` event so that you can set the `Administrator` foreign key value.</span></span> <span data-ttu-id="36a45-284">は、エラーメッセージを表示するための `ValidationSummary` コントロールです。</span><span class="sxs-lookup"><span data-stu-id="36a45-284">At the end is a `ValidationSummary` control to display error messages.</span></span>

<span data-ttu-id="36a45-285">*DepartmentsAdd.aspx.cs*を開き、次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-285">Open *DepartmentsAdd.aspx.cs* and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample10.cs)]

<span data-ttu-id="36a45-286">次のクラス変数とメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-286">Add the following class variable and methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample11.cs)]

<span data-ttu-id="36a45-287">`Page_Init` メソッドを使用すると、動的データ機能が有効になります。</span><span class="sxs-lookup"><span data-stu-id="36a45-287">The `Page_Init` method enables Dynamic Data functionality.</span></span> <span data-ttu-id="36a45-288">`DropDownList` コントロールの `Init` イベントのハンドラーは、コントロールへの参照を保存します。また、`DetailsView` コントロールの `Inserting` イベントのハンドラーは、その参照を使用して、選択されたインストラクターの `PersonID` 値を取得し、`Administrator` エンティティの `Department` 外部キープロパティを更新します。</span><span class="sxs-lookup"><span data-stu-id="36a45-288">The handler for the `DropDownList` control's `Init` event saves a reference to the control, and the handler for the `DetailsView` control's `Inserting` event uses that reference to get the `PersonID` value of the selected instructor and update the `Administrator` foreign key property of the `Department` entity.</span></span>

<span data-ttu-id="36a45-289">ページを実行し、新しい部署の情報を追加して、 **[挿入]** リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-289">Run the page, add information for a new department, and then click the **Insert** link.</span></span>

<span data-ttu-id="36a45-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span></span>

<span data-ttu-id="36a45-291">別の新しい部門の値を入力します。</span><span class="sxs-lookup"><span data-stu-id="36a45-291">Enter values for another new department.</span></span> <span data-ttu-id="36a45-292">**[予算]** フィールドに1000000.00 より大きい数値を入力し、tab キーを押して次のフィールドに入力します。</span><span class="sxs-lookup"><span data-stu-id="36a45-292">Enter a number greater than 1,000,000.00 in the **Budget** field and tab to the next field.</span></span> <span data-ttu-id="36a45-293">フィールドにアスタリスクが表示され、その上にマウスポインターを置くと、そのフィールドのメタデータに入力したエラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-293">An asterisk appears in the field, and if you hold the mouse pointer over it, you can see the error message that you entered in the metadata for that field.</span></span>

<span data-ttu-id="36a45-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span></span>

<span data-ttu-id="36a45-295">**[挿入]** をクリックすると、ページの下部にある `ValidationSummary` コントロールによって表示されるエラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-295">Click **Insert**, and you see the error message displayed by the `ValidationSummary` control at the bottom of the page.</span></span>

<span data-ttu-id="36a45-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span></span>

<span data-ttu-id="36a45-297">次に、ブラウザーを閉じて、department *.aspx*ページを開きます。</span><span class="sxs-lookup"><span data-stu-id="36a45-297">Next, close the browser and open the *Departments.aspx* page.</span></span> <span data-ttu-id="36a45-298">`ObjectDataSource` コントロールに `DeleteMethod` 属性を追加し、`GridView` コントロールに `DataKeyNames` 属性を追加して、department ページに削除機能を追加*します。*</span><span class="sxs-lookup"><span data-stu-id="36a45-298">Add delete capability to the *Departments.aspx* page by adding a `DeleteMethod` attribute to the `ObjectDataSource` control, and a `DataKeyNames` attribute to the `GridView` control.</span></span> <span data-ttu-id="36a45-299">これらのコントロールの開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="36a45-299">The opening tags for these controls will now resemble the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample12.aspx)]

<span data-ttu-id="36a45-300">ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="36a45-300">Run the page.</span></span>

<span data-ttu-id="36a45-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span></span>

<span data-ttu-id="36a45-302">*DepartmentsAdd*ページを実行したときに追加した部署を削除します。</span><span class="sxs-lookup"><span data-stu-id="36a45-302">Delete the department you added when you ran the *DepartmentsAdd.aspx* page.</span></span>

## <a name="adding-update-functionality"></a><span data-ttu-id="36a45-303">更新機能の追加</span><span class="sxs-lookup"><span data-stu-id="36a45-303">Adding Update Functionality</span></span>

<span data-ttu-id="36a45-304">*SchoolRepository.cs*を開き、次の `Update` メソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-304">Open *SchoolRepository.cs* and add the following `Update` method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample13.cs)]

<span data-ttu-id="36a45-305">Department ページで **[更新]** をクリックすると、`ObjectDataSource` コントロールによって、`UpdateDepartment` メソッドに渡す2つの `Department` エンティティが作成され*ます。*</span><span class="sxs-lookup"><span data-stu-id="36a45-305">When you click **Update** in the *Departments.aspx* page, the `ObjectDataSource` control creates two `Department` entities to pass to the `UpdateDepartment` method.</span></span> <span data-ttu-id="36a45-306">一方には、ビューステートに格納されている元の値が含まれ、もう1つは、`GridView` コントロールに入力された新しい値を格納します。</span><span class="sxs-lookup"><span data-stu-id="36a45-306">One contains the original values that have been stored in view state, and the other contains the new values that were entered in the `GridView` control.</span></span> <span data-ttu-id="36a45-307">`UpdateDepartment` メソッドのコードは、元の値を持つ `Department` エンティティを `Attach` メソッドに渡して、エンティティとデータベース内のデータの間の追跡を確立します。</span><span class="sxs-lookup"><span data-stu-id="36a45-307">The code in the `UpdateDepartment` method passes the `Department` entity that has the original values to the `Attach` method in order to establish the tracking between the entity and what's in the database.</span></span> <span data-ttu-id="36a45-308">次に、新しい値を持つ `Department` エンティティを `ApplyCurrentValues` メソッドに渡します。</span><span class="sxs-lookup"><span data-stu-id="36a45-308">Then the code passes the `Department` entity that has the new values to the `ApplyCurrentValues` method.</span></span> <span data-ttu-id="36a45-309">オブジェクトコンテキストは、古い値と新しい値を比較します。</span><span class="sxs-lookup"><span data-stu-id="36a45-309">The object context compares the old and new values.</span></span> <span data-ttu-id="36a45-310">新しい値が古い値と異なる場合は、オブジェクトコンテキストによってプロパティ値が変更されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-310">If a new value is different from an old value, the object context changes the property value.</span></span> <span data-ttu-id="36a45-311">`SaveChanges` メソッドは、データベース内の変更された列のみを更新します。</span><span class="sxs-lookup"><span data-stu-id="36a45-311">The `SaveChanges` method then updates only the changed columns in the database.</span></span> <span data-ttu-id="36a45-312">(ただし、このエンティティの update 関数がストアドプロシージャにマップされていた場合、どの列が変更されたかにかかわらず、行全体が更新されます)。</span><span class="sxs-lookup"><span data-stu-id="36a45-312">(However, if the update function for this entity were mapped to a stored procedure, the entire row would be updated regardless of which columns were changed.)</span></span>

<span data-ttu-id="36a45-313">学科の *.aspx*ファイルを開き、次の属性を `DepartmentsObjectDataSource` コントロールに追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-313">Open the *Departments.aspx* file and add the following attributes to the `DepartmentsObjectDataSource` control:</span></span>

- `UpdateMethod="UpdateDepartment"`
- `ConflictDetection="CompareAllValues"`   
 <span data-ttu-id="36a45-314">これにより、古い値が `Update` メソッドの新しい値と比較できるように、古い値がビューステートに格納されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-314">This causes old values to be stored in view state so that they can be compared with the new values in the `Update` method.</span></span>
- `OldValuesParameterFormatString="orig{0}"`   
 <span data-ttu-id="36a45-315">これにより、元の values パラメーターの名前が `origDepartment` であることがコントロールに通知されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-315">This informs the control that the name of the original values parameter is `origDepartment` .</span></span>

<span data-ttu-id="36a45-316">`ObjectDataSource` コントロールの開始タグのマークアップは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="36a45-316">The markup for the opening tag of the `ObjectDataSource` control now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample14.aspx)]

<span data-ttu-id="36a45-317">`GridView` コントロールに `OnRowUpdating="DepartmentsGridView_RowUpdating"` 属性を追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-317">Add an `OnRowUpdating="DepartmentsGridView_RowUpdating"` attribute to the `GridView` control.</span></span> <span data-ttu-id="36a45-318">このプロパティを使用して、ユーザーがドロップダウンリストで選択した行に基づいて、`Administrator` プロパティの値を設定します。</span><span class="sxs-lookup"><span data-stu-id="36a45-318">You will use this to set the `Administrator` property value based on the row the user selects in a drop-down list.</span></span> <span data-ttu-id="36a45-319">`GridView` の開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="36a45-319">The `GridView` opening tag now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample15.aspx)]

<span data-ttu-id="36a45-320">`Administrator` 列の `EditItemTemplate` コントロールを `GridView` コントロールに追加します。その際、その列の `ItemTemplate` コントロールの直後に追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-320">Add an `EditItemTemplate` control for the `Administrator` column to the `GridView` control, immediately after the `ItemTemplate` control for that column:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample16.aspx)]

<span data-ttu-id="36a45-321">この `EditItemTemplate` コントロールは、 *DepartmentsAdd*ページの `InsertItemTemplate` コントロールに似ています。</span><span class="sxs-lookup"><span data-stu-id="36a45-321">This `EditItemTemplate` control is similar to the `InsertItemTemplate` control in the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="36a45-322">違いは、コントロールの初期値が `SelectedValue` 属性を使用して設定されていることです。</span><span class="sxs-lookup"><span data-stu-id="36a45-322">The difference is that the initial value of the control is set using the `SelectedValue` attribute.</span></span>

<span data-ttu-id="36a45-323">`GridView` コントロールの前に、 *DepartmentsAdd*ページで行ったように `ValidationSummary` コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-323">Before the `GridView` control, add a `ValidationSummary` control as you did in the *DepartmentsAdd.aspx* page.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample17.aspx)]

<span data-ttu-id="36a45-324">*Departments.aspx.cs*を開き、部分クラス宣言の直後に、次のコードを追加して、`DropDownList` コントロールを参照するプライベートフィールドを作成します。</span><span class="sxs-lookup"><span data-stu-id="36a45-324">Open *Departments.aspx.cs* and immediately after the partial-class declaration, add the following code to create a private field to reference the `DropDownList` control:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample18.cs)]

<span data-ttu-id="36a45-325">次に、`DropDownList` コントロールの `Init` イベントと `GridView` コントロールの `RowUpdating` イベントのハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="36a45-325">Then add handlers for the `DropDownList` control's `Init` event and the `GridView` control's `RowUpdating` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample19.cs)]

<span data-ttu-id="36a45-326">`Init` イベントのハンドラーは、クラスフィールドに `DropDownList` コントロールへの参照を保存します。</span><span class="sxs-lookup"><span data-stu-id="36a45-326">The handler for the `Init` event saves a reference to the `DropDownList` control in the class field.</span></span> <span data-ttu-id="36a45-327">`RowUpdating` イベントのハンドラーは、参照を使用してユーザーが入力した値を取得し、それを `Department` エンティティの `Administrator` プロパティに適用します。</span><span class="sxs-lookup"><span data-stu-id="36a45-327">The handler for the `RowUpdating` event uses the reference to get the value the user entered and apply it to the `Administrator` property of the `Department` entity.</span></span>

<span data-ttu-id="36a45-328">*DepartmentsAdd*ページを使用して新しい部署を追加し、次に department *.aspx*ページを実行して、追加した行の **[編集]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-328">Use the *DepartmentsAdd.aspx* page to add a new department, then run the *Departments.aspx* page and click **Edit** on the row that you added.</span></span>

> [!NOTE]
> <span data-ttu-id="36a45-329">データベース内のデータが無効なため、追加していない行 (つまり、データベースに既に存在していた行) を編集することはできません。データベースで作成された行の管理者は、students です。</span><span class="sxs-lookup"><span data-stu-id="36a45-329">You will not be able to edit rows that you did not add (that is, that were already in the database), because of invalid data in the database; the administrators for the rows that were created with the database are students.</span></span> <span data-ttu-id="36a45-330">これらのいずれかを編集しようとすると、次のようなエラーを報告するエラーページが表示され `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span><span class="sxs-lookup"><span data-stu-id="36a45-330">If you try to edit one of them, you will get an error page that reports an error like `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span></span>

<span data-ttu-id="36a45-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span></span>

<span data-ttu-id="36a45-332">無効な**予算**金額を入力して **[更新]** をクリックすると、[department *] ページで*確認したのと同じアスタリスクとエラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-332">If you enter an invalid **Budget** amount and then click **Update**, you see the same asterisk and error message that you saw in the *Departments.aspx* page.</span></span>

<span data-ttu-id="36a45-333">フィールド値を変更するか、別の管理者を選択して **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="36a45-333">Change a field value or select a different administrator and click **Update**.</span></span> <span data-ttu-id="36a45-334">変更が表示されます。</span><span class="sxs-lookup"><span data-stu-id="36a45-334">The change is displayed.</span></span>

<span data-ttu-id="36a45-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="36a45-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span></span>

<span data-ttu-id="36a45-336">このチュートリアルでは、Entity Framework で基本的な CRUD (作成、読み取り、更新、削除) 操作に `ObjectDataSource` コントロールを使用する方法の概要を説明します。</span><span class="sxs-lookup"><span data-stu-id="36a45-336">This completes the introduction to using the `ObjectDataSource` control for basic CRUD (create, read, update, delete) operations with the Entity Framework.</span></span> <span data-ttu-id="36a45-337">単純な n 層アプリケーションを構築しましたが、ビジネスロジック層はデータアクセス層と緊密に結合されているため、自動単体テストが複雑になります。</span><span class="sxs-lookup"><span data-stu-id="36a45-337">You've built a simple n-tier application, but the business-logic layer is still tightly coupled to the data-access layer, which complicates automated unit testing.</span></span> <span data-ttu-id="36a45-338">次のチュートリアルでは、単体テストを容易にするリポジトリパターンを実装する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="36a45-338">In the following tutorial you'll see how to implement the repository pattern to facilitate unit testing.</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="36a45-339">Next</span><span class="sxs-lookup"><span data-stu-id="36a45-339">Next</span></span>](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests.md)
