---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: ASP.NET 4 Web アプリケーションでの Entity Framework 4.0 での同時実行の処理Microsoft Docs
author: tdykstra
description: このチュートリアルシリーズは、Entity Framework 4.0 チュートリアルシリーズを使用してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。 ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78513502"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="71d52-104">ASP.NET 4 Web アプリケーションでの Entity Framework 4.0 での同時実行の処理</span><span class="sxs-lookup"><span data-stu-id="71d52-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="71d52-105">[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="71d52-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="71d52-106">このチュートリアルシリーズは、 [Entity Framework 4.0 チュートリアルシリーズを使用](https://asp.net/entity-framework/tutorials#Getting%20Started)してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。</span><span class="sxs-lookup"><span data-stu-id="71d52-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="71d52-107">前のチュートリアルを完了していない場合は、このチュートリアルの開始点として、作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="71d52-108">チュートリアルシリーズ全体で作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)することもできます。</span><span class="sxs-lookup"><span data-stu-id="71d52-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="71d52-109">チュートリアルについてご質問がある場合は、 [ASP.NET Entity Framework フォーラム](https://forums.asp.net/1227.aspx)に投稿することができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="71d52-110">前のチュートリアルでは、`ObjectDataSource` コントロールと Entity Framework を使用してデータの並べ替えとフィルター処理を行う方法について学習しました。</span><span class="sxs-lookup"><span data-stu-id="71d52-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="71d52-111">このチュートリアルでは、Entity Framework を使用する ASP.NET web アプリケーションで同時実行を処理するためのオプションについて説明します。</span><span class="sxs-lookup"><span data-stu-id="71d52-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="71d52-112">講師のオフィスの割り当てを更新するための専用の新しい web ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="71d52-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="71d52-113">このページと、前に作成した部門ページで同時実行の問題を処理します。</span><span class="sxs-lookup"><span data-stu-id="71d52-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="71d52-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="71d52-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="71d52-116">コンカレンシーの競合</span><span class="sxs-lookup"><span data-stu-id="71d52-116">Concurrency Conflicts</span></span>

<span data-ttu-id="71d52-117">同時実行の競合は、1人のユーザーがレコードを編集したときに、最初のユーザーの変更がデータベースに書き込まれる前に別のユーザーが同じレコードを編集したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="71d52-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="71d52-118">このような競合を検出するように Entity Framework を設定しなかった場合、最後にデータベースを更新すると、その他のユーザーの変更が上書きされます。</span><span class="sxs-lookup"><span data-stu-id="71d52-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="71d52-119">多くのアプリケーションでは、このリスクが許容されるため、同時実行の競合を処理するようにアプリケーションを構成する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="71d52-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="71d52-120">(ユーザー数が少ない場合、または更新プログラムがほとんどない場合、または一部の変更が上書きされても本当に重要でない場合は、同時実行のプログラミングのコストが利点を上回る可能性があります)。同時実行の競合について心配する必要がない場合は、このチュートリアルをスキップできます。このシリーズの残りの2つのチュートリアルは、この記事で作成したものに依存していません。</span><span class="sxs-lookup"><span data-stu-id="71d52-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="71d52-121">ペシミスティック同時実行 (ロック)</span><span class="sxs-lookup"><span data-stu-id="71d52-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="71d52-122">コンカレンシーで偶発的にデータが失われる事態をアプリケーションで回避する必要があれば、その方法としてデータベース ロックがあります。</span><span class="sxs-lookup"><span data-stu-id="71d52-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="71d52-123">これは、*ペシミスティック同時実行制御*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="71d52-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="71d52-124">たとえば、データベースから行を読む前に、読み取り専用か更新アクセスでロックを要求します。</span><span class="sxs-lookup"><span data-stu-id="71d52-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="71d52-125">更新アクセスで行をロックすると、他のユーザーはその行を読み取り専用または更新アクセスでロックできなくなります。変更中のデータのコピーが与えられるためです。</span><span class="sxs-lookup"><span data-stu-id="71d52-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="71d52-126">読み取り専用で行をロックすると、他のユーザーはその行を読み取り専用でロックできますが、更新アクセスではロックできません。</span><span class="sxs-lookup"><span data-stu-id="71d52-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="71d52-127">ロックの管理にはいくつかの欠点があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="71d52-128">プログラムが複雑になります。</span><span class="sxs-lookup"><span data-stu-id="71d52-128">It can be complex to program.</span></span> <span data-ttu-id="71d52-129">多くのデータベース管理リソースが必要であり、アプリケーションのユーザー数が増えるにつれてパフォーマンスの問題が発生する可能性があります (つまり、スケールが適切ではありません)。</span><span class="sxs-lookup"><span data-stu-id="71d52-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="71d52-130">そのような理由から、一部のデータベース管理システムはペシミスティック コンカレンシーに対応していません。</span><span class="sxs-lookup"><span data-stu-id="71d52-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="71d52-131">Entity Framework には、組み込みのサポートはありません。このチュートリアルでは、実装方法については説明しません。</span><span class="sxs-lookup"><span data-stu-id="71d52-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="71d52-132">オプティミスティック コンカレンシー</span><span class="sxs-lookup"><span data-stu-id="71d52-132">Optimistic Concurrency</span></span>

<span data-ttu-id="71d52-133">ペシミスティック同時実行制御の代替として、*オプティミスティック同時実行制御*があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="71d52-134">オプティミスティック コンカレンシーでは、コンカレンシーの競合の発生を許し、発生したら適切に対処します。</span><span class="sxs-lookup"><span data-stu-id="71d52-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="71d52-135">たとえば、John は、*学科の .aspx*ページを実行し、履歴部門の **[編集]** リンクをクリックして、**予算**の金額を $1000000.00 から $125000.00 に減らします。</span><span class="sxs-lookup"><span data-stu-id="71d52-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="71d52-136">(John は競争部門を管理しており、自分の部署の資金を解放する必要があります)。</span><span class="sxs-lookup"><span data-stu-id="71d52-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="71d52-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="71d52-138">John が**Update**をクリックする前に、加藤さんは同じページを実行し、履歴部門の **[編集]** リンクをクリックして、 **[開始日]** フィールドを1/10/2011 から1/1/1999 に変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="71d52-139">(加藤さんは履歴部門を管理しており、より多くの勤続を提供したいと考えています)。</span><span class="sxs-lookup"><span data-stu-id="71d52-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="71d52-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="71d52-141">最初に **[update]** をクリックし、加藤さんは **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="71d52-142">Jane のブラウザーでは、**予算**の金額が $1000000.00 と表示されるようになりましたが、この金額は John から $125000.00 に変更されているため、正しくありません。</span><span class="sxs-lookup"><span data-stu-id="71d52-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="71d52-143">このシナリオで実行できる操作には、次のようなものがあります。</span><span class="sxs-lookup"><span data-stu-id="71d52-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="71d52-144">ユーザーが変更したプロパティを追跡記録し、それに該当する列だけをデータベースで更新できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="71d52-145">例のシナリオでは、2 人のユーザーが異なるプロパティを更新したため、データは失われません。</span><span class="sxs-lookup"><span data-stu-id="71d52-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="71d52-146">次にだれかが履歴部門を参照したときに、1/1/1999 と $125000.00 が表示されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="71d52-147">これは Entity Framework の既定の動作であり、データの損失につながる可能性がある競合の数を大幅に減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="71d52-148">ただし、この動作は、エンティティの同じプロパティに対して競合する変更が行われた場合に、データの損失を回避するものではありません。</span><span class="sxs-lookup"><span data-stu-id="71d52-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="71d52-149">また、この動作は常に可能であるとは限りません。ストアドプロシージャをエンティティ型にマップすると、エンティティに対する変更がデータベースで行われたときに、エンティティのすべてのプロパティが更新されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="71d52-150">加藤さんの変更によって John の変更が上書きされるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="71d52-151">加藤さんが**Update**をクリックすると、**予算**の金額は $1000000.00 に戻ります。</span><span class="sxs-lookup"><span data-stu-id="71d52-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="71d52-152">これは *Client Wins* (クライアント側に合わせる) シナリオまたは *Last in Wins* (最終書き込み者優先) シナリオと呼ばれています。</span><span class="sxs-lookup"><span data-stu-id="71d52-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="71d52-153">(クライアントの値は、データストアの内容よりも優先されます)。</span><span class="sxs-lookup"><span data-stu-id="71d52-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="71d52-154">Jane の変更がデータベースで更新されないようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="71d52-155">通常は、エラーメッセージを表示して、データの現在の状態を表示し、それでも変更したい場合は自分の変更を再入力できるようにします。</span><span class="sxs-lookup"><span data-stu-id="71d52-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="71d52-156">さらに、入力を保存し、再入力することなく再適用する機会を与えることで、プロセスを自動化できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="71d52-157">これは *Store Wins* (ストア側に合わせる) シナリオと呼ばれています。</span><span class="sxs-lookup"><span data-stu-id="71d52-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="71d52-158">(クライアントが送信した値よりデータストアの値が優先されます。)</span><span class="sxs-lookup"><span data-stu-id="71d52-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="71d52-159">同時実行の競合の検出</span><span class="sxs-lookup"><span data-stu-id="71d52-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="71d52-160">Entity Framework では、Entity Framework がスローする `OptimisticConcurrencyException` 例外を処理することで、競合を解決できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="71d52-161">このような例外がスローされるタイミングを認識する目的で、Entity Framework は競合を検出できなければなりません。</span><span class="sxs-lookup"><span data-stu-id="71d52-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="71d52-162">そのため、データベースとデータ モデルを適宜構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="71d52-163">競合検出を有効にするためのオプションには次のようなものがあります。</span><span class="sxs-lookup"><span data-stu-id="71d52-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="71d52-164">データベースで、行がいつ変更されたかを判断するために使用できるテーブル列を含めます。</span><span class="sxs-lookup"><span data-stu-id="71d52-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="71d52-165">次に、SQL `Update` または `Delete` コマンドの `Where` 句にその列を含めるように Entity Framework を構成できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="71d52-166">これは、`OfficeAssignment` テーブルの `Timestamp` 列の目的です。</span><span class="sxs-lookup"><span data-stu-id="71d52-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="71d52-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="71d52-168">`Timestamp` 列のデータ型は `Timestamp`とも呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="71d52-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="71d52-169">ただし、列には実際には日付または時刻の値が含まれていません。</span><span class="sxs-lookup"><span data-stu-id="71d52-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="71d52-170">この値は、行が更新されるたびにインクリメントされる連続番号です。</span><span class="sxs-lookup"><span data-stu-id="71d52-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="71d52-171">`Update` または `Delete` コマンドでは、`Where` 句に元の `Timestamp` 値が含まれます。</span><span class="sxs-lookup"><span data-stu-id="71d52-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="71d52-172">更新対象の行が別のユーザーによって変更されている場合、`Timestamp` の値は元の値とは異なるため、`Where` 句は更新する行を返しません。</span><span class="sxs-lookup"><span data-stu-id="71d52-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="71d52-173">現在の `Update` または `Delete` コマンドによって更新された行がないことを Entity Framework が検出した場合 (つまり、影響を受ける行の数が0の場合)、同時実行の競合として解釈されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="71d52-174">Entity Framework を構成して、テーブル内のすべての列の元の値を、`Update` および `Delete` コマンドの `Where` 句に含めます。</span><span class="sxs-lookup"><span data-stu-id="71d52-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="71d52-175">最初のオプションと同様に、行の最初の読み取り以降に行の内容が変更された場合、`Where` 句は更新する行を返しません。この場合、Entity Framework は同時実行の競合として解釈されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="71d52-176">このメソッドは `Timestamp` フィールドを使用するのと同じように有効ですが、非効率的になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="71d52-177">多数の列を含むデータベーステーブルの場合は、非常に大きな `Where` 句になることがあります。また、web アプリケーションでは、大量の状態を維持することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="71d52-178">大量の状態を維持すると、アプリケーションのパフォーマンスに影響を与える可能性があります。これは、サーバーリソース (セッション状態など) が必要であるか、web ページ自体に含まれる必要がある (たとえば、ビューステート) 必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="71d52-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="71d52-179">このチュートリアルでは、追跡プロパティ (`Department` エンティティ) と、追跡プロパティ (`OfficeAssignment` エンティティ) を持つエンティティのオプティミスティック同時実行の競合に対するエラー処理を追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="71d52-180">追跡プロパティを使用せずにオプティミスティック同時実行制御を処理する</span><span class="sxs-lookup"><span data-stu-id="71d52-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="71d52-181">追跡 (`Timestamp`) プロパティを持たない `Department` エンティティに対してオプティミスティック同時実行制御を実装するには、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="71d52-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="71d52-182">`Department` エンティティの同時実行の追跡を有効にするようにデータモデルを変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="71d52-183">`SchoolRepository` クラスで、`SaveChanges` メソッドの同時実行例外を処理します。</span><span class="sxs-lookup"><span data-stu-id="71d52-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="71d52-184">Department ページで、試行された変更が失敗したことを示すメッセージをユーザーに表示して、同時実行例外を処理*します。*</span><span class="sxs-lookup"><span data-stu-id="71d52-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="71d52-185">ユーザーは現在の値を確認し、必要に応じて変更を再試行することができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="71d52-186">データモデルでの同時実行追跡の有効化</span><span class="sxs-lookup"><span data-stu-id="71d52-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="71d52-187">Visual Studio で、このシリーズの前のチュートリアルで使用していた Contoso 大学 web アプリケーションを開きます。</span><span class="sxs-lookup"><span data-stu-id="71d52-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="71d52-188">*SchoolModel*を開き、データモデルデザイナーで `Department` エンティティ内の `Name` プロパティを右クリックし、 **[プロパティ]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="71d52-189">**プロパティ** ウィンドウで、`ConcurrencyMode` プロパティを `Fixed`に変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="71d52-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="71d52-191">その他の非主キースカラープロパティ (`Budget`、`StartDate`、および `Administrator`に対しても同じ操作を行います。(ナビゲーションプロパティに対してこれを行うことはできません)。これにより、Entity Framework が `Update` または `Delete` SQL コマンドを生成してデータベースの `Department` エンティティを更新するときに、これらの列 (元の値を含む) を `Where` 句に含める必要があることを指定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="71d52-192">`Update` または `Delete` コマンドの実行時に行が見つからない場合、Entity Framework はオプティミスティック同時実行例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="71d52-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="71d52-193">データモデルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="71d52-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="71d52-194">DAL での同時実行例外の処理</span><span class="sxs-lookup"><span data-stu-id="71d52-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="71d52-195">*SchoolRepository.cs*を開き、`System.Data` 名前空間に対して次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="71d52-196">オプティミスティック同時実行例外を処理する次の新しい `SaveChanges` メソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="71d52-197">このメソッドが呼び出されたときに同時実行エラーが発生した場合、メモリ内のエンティティのプロパティ値は、現在データベース内にある値に置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="71d52-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="71d52-198">Web ページが処理できるように、同時実行の例外が再スローされます。</span><span class="sxs-lookup"><span data-stu-id="71d52-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="71d52-199">`DeleteDepartment` メソッドと `UpdateDepartment` メソッドで、新しいメソッドを呼び出すために、`context.SaveChanges()` の既存の呼び出しを `SaveChanges()` への呼び出しに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="71d52-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="71d52-200">プレゼンテーション層での同時実行例外の処理</span><span class="sxs-lookup"><span data-stu-id="71d52-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="71d52-201">Department *.aspx*を開き、`OnDeleted="DepartmentsObjectDataSource_Deleted"` 属性を `DepartmentsObjectDataSource` コントロールに追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="71d52-202">コントロールの開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="71d52-203">次の例に示すように、`DepartmentsGridView` コントロールで、`DataKeyNames` 属性のすべてのテーブル列を指定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="71d52-204">これにより、非常に大きなビューステートフィールドが作成されることに注意してください。これは、通常、追跡フィールドを使用して同時実行の競合を追跡する方法として推奨される理由の1つです。</span><span class="sxs-lookup"><span data-stu-id="71d52-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="71d52-205">*Departments.aspx.cs*を開き、`System.Data` 名前空間に対して次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="71d52-206">次の新しいメソッドを追加します。このメソッドは、データソースコントロールの `Updated` から呼び出され、同時実行例外を処理するためのイベントハンドラーを `Deleted` します。</span><span class="sxs-lookup"><span data-stu-id="71d52-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="71d52-207">このコードは、例外の種類を確認します。同時実行例外の場合、コードは動的に `CustomValidator` コントロールを作成し、`ValidationSummary` コントロールにメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="71d52-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="71d52-208">先ほど追加した `Updated` イベントハンドラーから新しいメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="71d52-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="71d52-209">また、同じメソッドを呼び出す新しい `Deleted` イベントハンドラーを作成します (それ以外は何も実行しません)。</span><span class="sxs-lookup"><span data-stu-id="71d52-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="71d52-210">[部門] ページでオプティミスティック同時実行制御をテストする</span><span class="sxs-lookup"><span data-stu-id="71d52-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="71d52-211">Department *. .aspx*ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="71d52-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="71d52-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="71d52-213">行の **[編集]** をクリックし、 **[予算]** 列の値を変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="71d52-214">(既存の `School` データベースレコードに無効なデータが含まれているため、このチュートリアルで作成したレコードのみを編集できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="71d52-215">経済部門のレコードは、試してみるのに安全です。)</span><span class="sxs-lookup"><span data-stu-id="71d52-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="71d52-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="71d52-217">新しいブラウザーウィンドウを開き、再度ページを実行します (最初のブラウザーウィンドウの [アドレス] ボックスから2番目のブラウザーウィンドウに URL をコピーします)。</span><span class="sxs-lookup"><span data-stu-id="71d52-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="71d52-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="71d52-219">前に編集したものと同じ行の **[編集]** をクリックし、**予算**の値を別の値に変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="71d52-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="71d52-221">2番目のブラウザーウィンドウで、 **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="71d52-222">**予算**金額は、この新しい値に正常に変更されました。</span><span class="sxs-lookup"><span data-stu-id="71d52-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="71d52-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="71d52-224">最初のブラウザーウィンドウで、 **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="71d52-225">更新は失敗します。</span><span class="sxs-lookup"><span data-stu-id="71d52-225">The update fails.</span></span> <span data-ttu-id="71d52-226">2番目のブラウザーウィンドウで設定した値を使用して**予算**金額が再表示され、エラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="71d52-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="71d52-228">追跡プロパティを使用したオプティミスティック同時実行制御の処理</span><span class="sxs-lookup"><span data-stu-id="71d52-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="71d52-229">Tracking プロパティを持つエンティティのオプティミスティック同時実行制御を処理するには、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="71d52-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="71d52-230">`OfficeAssignment` エンティティを管理するためのストアドプロシージャをデータモデルに追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="71d52-231">(追跡のプロパティとストアドプロシージャを一緒に使用する必要はありません。これらは、ここでは説明のためにグループ化されています)。</span><span class="sxs-lookup"><span data-stu-id="71d52-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="71d52-232">Dal に CRUD メソッドを追加し、DAL でオプティミスティック同時実行例外を処理するコードを含む `OfficeAssignment` エンティティの BLL を追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="71d52-233">Office の割り当て web ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="71d52-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="71d52-234">新しい web ページでオプティミスティック同時実行制御をテストします。</span><span class="sxs-lookup"><span data-stu-id="71d52-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="71d52-235">データモデルへの OfficeAssignment ストアドプロシージャの追加</span><span class="sxs-lookup"><span data-stu-id="71d52-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="71d52-236">モデルデザイナーで*SchoolModel*ファイルを開き、デザイン画面を右クリックして、 **[データベースからモデルを更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="71d52-237">**[データベースオブジェクトの選択]** ダイアログボックスの **[追加]** タブで、 **[ストアドプロシージャ]** を展開し、3つの `OfficeAssignment` ストアドプロシージャ (次のスクリーンショットを参照) を選択して、 **[完了]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="71d52-238">(これらのストアドプロシージャは、スクリプトを使用してダウンロードまたは作成したときにデータベースに既に存在していました)。</span><span class="sxs-lookup"><span data-stu-id="71d52-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="71d52-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="71d52-240">`OfficeAssignment` エンティティを右クリックし、 **[ストアドプロシージャマッピング]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="71d52-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="71d52-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="71d52-242">対応するストアドプロシージャを使用するように、 **Insert**、 **Update**、および**Delete**の各関数を設定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="71d52-243">`Update` 関数の `OrigTimestamp` パラメーターについては、**プロパティ**を `Timestamp` に設定し、[**元の値を使用**する] オプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="71d52-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="71d52-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="71d52-245">Entity Framework が `UpdateOfficeAssignment` ストアドプロシージャを呼び出すと、`OrigTimestamp` パラメーターの `Timestamp` 列の元の値が渡されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="71d52-246">ストアドプロシージャは、`Where` 句でこのパラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="71d52-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="71d52-247">また、このストアドプロシージャでは、更新後の `Timestamp` 列の新しい値も選択されるため、Entity Framework はメモリ内の `OfficeAssignment` エンティティを対応するデータベース行と同期させることができます。</span><span class="sxs-lookup"><span data-stu-id="71d52-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="71d52-248">(オフィスの割り当てを削除するストアドプロシージャには、`OrigTimestamp` パラメーターがありません。</span><span class="sxs-lookup"><span data-stu-id="71d52-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="71d52-249">このため、Entity Framework でエンティティが変更されていないことを確認してから削除することはできません)。</span><span class="sxs-lookup"><span data-stu-id="71d52-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="71d52-250">データモデルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="71d52-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="71d52-251">DAL に OfficeAssignment メソッドを追加する</span><span class="sxs-lookup"><span data-stu-id="71d52-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="71d52-252">*ISchoolRepository.cs*を開き、`OfficeAssignment` エンティティセットに対して次の CRUD メソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="71d52-253">次の新しいメソッドを*SchoolRepository.cs*に追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="71d52-254">`UpdateOfficeAssignment` メソッドでは、`context.SaveChanges`ではなく、ローカルの `SaveChanges` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="71d52-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="71d52-255">テストプロジェクトで*MockSchoolRepository.cs*を開き、次の `OfficeAssignment` collection メソッドと CRUD メソッドをそれに追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="71d52-256">(モックリポジトリは、リポジトリインターフェイスを実装する必要があります。そうでない場合、ソリューションはコンパイルされません)。</span><span class="sxs-lookup"><span data-stu-id="71d52-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="71d52-257">BLL に OfficeAssignment メソッドを追加する</span><span class="sxs-lookup"><span data-stu-id="71d52-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="71d52-258">メインプロジェクトで*SchoolBL.cs*を開き、`OfficeAssignment` エンティティセットに対して次の CRUD メソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="71d52-259">OfficeAssignments Web ページの作成</span><span class="sxs-lookup"><span data-stu-id="71d52-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="71d52-260">*.Master*マスターページを使用する新しい web ページを作成し、「 *officeassignments*」という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="71d52-261">`Content2`という名前の `Content` コントロールに次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="71d52-262">`DataKeyNames` 属性では、マークアップによって、`Timestamp` プロパティとレコードキー (`InstructorID`) が指定されていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="71d52-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="71d52-263">`DataKeyNames` 属性でプロパティを指定すると、コントロールはコントロールの状態 (ビューステートに似ています) に保存します。これにより、ポストバック処理中に元の値を使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="71d52-264">`Timestamp` の値を保存していない場合、Entity Framework では、SQL `Update` コマンドの `Where` 句の値は使用できません。</span><span class="sxs-lookup"><span data-stu-id="71d52-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="71d52-265">そのため、何も更新する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="71d52-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="71d52-266">その結果、`OfficeAssignment` エンティティが更新されるたびに、Entity Framework はオプティミスティック同時実行例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="71d52-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="71d52-267">*OfficeAssignments.aspx.cs*を開き、データアクセス層の次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="71d52-268">次の `Page_Init` メソッドを追加します。これにより、動的データ機能が有効になります。</span><span class="sxs-lookup"><span data-stu-id="71d52-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="71d52-269">同時実行エラーを確認するために、`ObjectDataSource` コントロールの `Updated` イベントの次のハンドラーも追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="71d52-270">[OfficeAssignments] ページでオプティミスティック同時実行制御をテストする</span><span class="sxs-lookup"><span data-stu-id="71d52-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="71d52-271">*Officeassignments .aspx*ページを実行します。</span><span class="sxs-lookup"><span data-stu-id="71d52-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="71d52-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="71d52-273">行の **[編集]** をクリックし、 **[場所]** 列の値を変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="71d52-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="71d52-275">新しいブラウザーウィンドウを開き、再度ページを実行します (最初のブラウザーウィンドウから2番目のブラウザーウィンドウに URL をコピーします)。</span><span class="sxs-lookup"><span data-stu-id="71d52-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="71d52-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="71d52-277">前に編集した同じ行の **[編集]** をクリックし、 **[場所]** の値を別の値に変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="71d52-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="71d52-279">2番目のブラウザーウィンドウで、 **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="71d52-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="71d52-281">最初のブラウザーウィンドウに切り替えて、 **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="71d52-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="71d52-283">エラーメッセージが表示され、 **[場所]** の値が更新され、2番目のブラウザーウィンドウで変更した値が表示されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="71d52-284">EntityDataSource コントロールでの同時実行の処理</span><span class="sxs-lookup"><span data-stu-id="71d52-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="71d52-285">`EntityDataSource` コントロールには、データモデルの同時実行設定を認識し、それに応じて更新操作と削除操作を処理する組み込みのロジックが含まれています。</span><span class="sxs-lookup"><span data-stu-id="71d52-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="71d52-286">ただし、すべての例外と同様に、ユーザーにわかりやすいエラーメッセージを提供するために、`OptimisticConcurrencyException` 例外を自分で処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="71d52-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="71d52-287">次に、更新操作と削除操作を許可し、同時実行の競合が発生した場合にエラーメッセージを表示するために、(`EntityDataSource` コントロールを使用する) *course ページを*構成します。</span><span class="sxs-lookup"><span data-stu-id="71d52-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="71d52-288">`Course` エンティティには、同時実行追跡列がないため、`Department` エンティティで行ったのと同じメソッドを使用します。すべての非キープロパティの値を追跡します。</span><span class="sxs-lookup"><span data-stu-id="71d52-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="71d52-289">*SchoolModel*ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="71d52-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="71d52-290">`Course` エンティティ (`Title`、`Credits`、および `DepartmentID`) の非キープロパティについては、 **Concurrency Mode**プロパティを `Fixed`に設定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="71d52-291">次に、データモデルを保存して閉じます。</span><span class="sxs-lookup"><span data-stu-id="71d52-291">Then save and close the data model.</span></span>

<span data-ttu-id="71d52-292">[Course *] ページを開き*、次のように変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="71d52-293">`CoursesEntityDataSource` コントロールで、`EnableUpdate="true"` 属性と `EnableDelete="true"` 属性を追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="71d52-294">そのコントロールの開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="71d52-295">`CoursesGridView` コントロールで、`DataKeyNames` 属性の値を `"CourseID,Title,Credits,DepartmentID"`に変更します。</span><span class="sxs-lookup"><span data-stu-id="71d52-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="71d52-296">次に、 **[編集]** ボタンと **[削除]** ボタン (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`) を表示する `Columns` 要素に `CommandField` 要素を追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="71d52-297">`GridView` コントロールは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="71d52-298">ページを実行し、[部門] ページで行ったのと同じように競合状態を作成します。</span><span class="sxs-lookup"><span data-stu-id="71d52-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="71d52-299">2つのブラウザーウィンドウでページを実行し、各ウィンドウで同じ行の **[編集]** をクリックして、それぞれに異なる変更を加えます。</span><span class="sxs-lookup"><span data-stu-id="71d52-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="71d52-300">1つのウィンドウで **[更新]** をクリックし、その他のウィンドウで **[更新]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="71d52-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="71d52-301">**[更新]** をクリックすると、未処理の同時実行例外の結果として発生するエラーページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="71d52-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="71d52-303">このエラーは、`ObjectDataSource` コントロールの処理方法と非常によく似た方法で処理されます。</span><span class="sxs-lookup"><span data-stu-id="71d52-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="71d52-304">*[Course] ページを*開き、`CoursesEntityDataSource` コントロールで、`Deleted` イベントと `Updated` イベントのハンドラーを指定します。</span><span class="sxs-lookup"><span data-stu-id="71d52-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="71d52-305">コントロールの開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="71d52-306">`CoursesGridView` コントロールの前に、次の `ValidationSummary` コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="71d52-307">*Courses.aspx.cs*で、`System.Data` 名前空間の `using` ステートメントを追加し、同時実行例外をチェックするメソッドを追加して、`EntityDataSource` コントロールの `Updated` および `Deleted` ハンドラーのハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="71d52-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="71d52-308">コードは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="71d52-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="71d52-309">このコードと `ObjectDataSource` コントロールの唯一の違いは、この場合の同時実行例外は、その例外の `InnerException` プロパティではなく、イベント引数オブジェクトの `Exception` プロパティにあるという点です。</span><span class="sxs-lookup"><span data-stu-id="71d52-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="71d52-310">ページを実行し、同時実行の競合を再度作成します。</span><span class="sxs-lookup"><span data-stu-id="71d52-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="71d52-311">今度は、次のエラーメッセージが表示できます。</span><span class="sxs-lookup"><span data-stu-id="71d52-311">This time you see an error message:</span></span>

<span data-ttu-id="71d52-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="71d52-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="71d52-313">コンカレンシーの競合処理の入門編はこれで終わりです。</span><span class="sxs-lookup"><span data-stu-id="71d52-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="71d52-314">次のチュートリアルでは、Entity Framework を使用する web アプリケーションのパフォーマンスを向上させる方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="71d52-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="71d52-315">[前へ](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [次へ](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="71d52-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
