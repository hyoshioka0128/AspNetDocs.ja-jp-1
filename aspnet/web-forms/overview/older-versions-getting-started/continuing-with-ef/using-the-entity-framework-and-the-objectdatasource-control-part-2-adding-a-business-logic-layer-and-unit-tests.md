---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Entity Framework 4.0 と ObjectDataSource コントロールの使用、パート 2: ビジネスロジック層と単体テストの追加 |Microsoft Docs'
author: tdykstra
description: このチュートリアルシリーズは、Entity Framework 4.0 チュートリアルシリーズを使用してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。 ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 24344cc33d7c26d7c408db26c0530ef2c708a7d3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78439954"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="0f636-104">Entity Framework 4.0 と ObjectDataSource コントロールの使用、パート 2: ビジネスロジック層と単体テストの追加</span><span class="sxs-lookup"><span data-stu-id="0f636-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="0f636-105">[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="0f636-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="0f636-106">このチュートリアルシリーズは、 [Entity Framework 4.0 チュートリアルシリーズを使用](https://asp.net/entity-framework/tutorials#Getting%20Started)してはじめにによって作成された Contoso 大学 web アプリケーションに基づいています。</span><span class="sxs-lookup"><span data-stu-id="0f636-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="0f636-107">前のチュートリアルを完了していない場合は、このチュートリアルの開始点として、作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="0f636-108">チュートリアルシリーズ全体で作成した[アプリケーションをダウンロード](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)することもできます。</span><span class="sxs-lookup"><span data-stu-id="0f636-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="0f636-109">チュートリアルについてご質問がある場合は、 [ASP.NET Entity Framework フォーラム](https://forums.asp.net/1227.aspx)に投稿することができます。</span><span class="sxs-lookup"><span data-stu-id="0f636-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="0f636-110">前のチュートリアルでは、Entity Framework と `ObjectDataSource` コントロールを使用して n 層 web アプリケーションを作成しました。</span><span class="sxs-lookup"><span data-stu-id="0f636-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="0f636-111">このチュートリアルでは、ビジネスロジック層 (BLL) とデータアクセス層 (DAL) を分離した状態でビジネスロジックを追加する方法について説明します。また、BLL 用の自動化された単体テストを作成する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="0f636-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="0f636-112">このチュートリアルでは、次のタスクを実行します。</span><span class="sxs-lookup"><span data-stu-id="0f636-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="0f636-113">必要なデータアクセスメソッドを宣言するリポジトリインターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="0f636-114">リポジトリクラスにリポジトリインターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="0f636-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="0f636-115">リポジトリクラスを呼び出してデータアクセス関数を実行するビジネスロジッククラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="0f636-116">`ObjectDataSource` コントロールを、リポジトリクラスではなくビジネスロジッククラスに接続します。</span><span class="sxs-lookup"><span data-stu-id="0f636-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="0f636-117">単体テストプロジェクトと、そのデータストアのメモリ内コレクションを使用するリポジトリクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="0f636-118">ビジネスロジッククラスに追加するビジネスロジックの単体テストを作成し、テストを実行して失敗したことを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="0f636-119">ビジネスロジッククラスにビジネスロジックを実装し、単体テストを再実行して、合格したことを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="0f636-120">前のチュートリアルで作成した department および*DepartmentsAdd*ページを操作し*ます。*</span><span class="sxs-lookup"><span data-stu-id="0f636-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="0f636-121">リポジトリインターフェイスの作成</span><span class="sxs-lookup"><span data-stu-id="0f636-121">Creating a Repository Interface</span></span>

<span data-ttu-id="0f636-122">まず、リポジトリインターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="0f636-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="0f636-124">*DAL*フォルダーで、新しいクラスファイルを作成し、 *ISchoolRepository.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="0f636-125">このインターフェイスは、repository クラスで作成した CRUD (作成、読み取り、更新、削除) の各メソッドに対して1つのメソッドを定義します。</span><span class="sxs-lookup"><span data-stu-id="0f636-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="0f636-126">*SchoolRepository.cs*の `SchoolRepository` クラスで、このクラスが `ISchoolRepository` インターフェイスを実装することを示します。</span><span class="sxs-lookup"><span data-stu-id="0f636-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="0f636-127">ビジネスロジッククラスの作成</span><span class="sxs-lookup"><span data-stu-id="0f636-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="0f636-128">次に、ビジネスロジッククラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="0f636-129">これにより、`ObjectDataSource` コントロールによって実行されるビジネスロジックを追加できるようになります。ただし、これはまだ行われません。</span><span class="sxs-lookup"><span data-stu-id="0f636-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="0f636-130">現時点では、新しいビジネスロジッククラスは、リポジトリと同じ CRUD 操作のみを実行します。</span><span class="sxs-lookup"><span data-stu-id="0f636-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="0f636-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="0f636-132">新しいフォルダーを作成し、 *BLL*という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="0f636-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="0f636-133">(実際のアプリケーションでは、ビジネスロジック層は通常、独立したプロジェクトであるクラスライブラリとして実装されますが、このチュートリアルを単純にするために、BLL クラスはプロジェクトフォルダーに保持されます)。</span><span class="sxs-lookup"><span data-stu-id="0f636-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="0f636-134">[ *BLL* ] フォルダーで、新しいクラスファイルを作成し、 *SchoolBL.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="0f636-135">このコードは、前にリポジトリクラスで見たものと同じ CRUD メソッドを作成しますが、Entity Framework メソッドに直接アクセスするのではなく、リポジトリクラスのメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="0f636-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="0f636-136">リポジトリクラスへの参照を保持するクラス変数は、インターフェイス型として定義され、リポジトリクラスをインスタンス化するコードは2つのコンストラクターに含まれています。</span><span class="sxs-lookup"><span data-stu-id="0f636-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="0f636-137">パラメーターなしのコンストラクターは、`ObjectDataSource` コントロールによって使用されます。</span><span class="sxs-lookup"><span data-stu-id="0f636-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="0f636-138">これにより、前に作成した `SchoolRepository` クラスのインスタンスが作成されます。</span><span class="sxs-lookup"><span data-stu-id="0f636-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="0f636-139">もう1つのコンストラクターは、ビジネスロジッククラスをインスタンス化するすべてのコードが、リポジトリインターフェイスを実装する任意のオブジェクトに渡すことを許可します。</span><span class="sxs-lookup"><span data-stu-id="0f636-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="0f636-140">Repository クラスと2つのコンストラクターを呼び出す CRUD メソッドにより、選択した任意のバックエンドデータストアでビジネスロジッククラスを使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="0f636-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="0f636-141">ビジネスロジッククラスは、呼び出し元のクラスがデータを永続化する方法を認識する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="0f636-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="0f636-142">(これは、"*永続化無視*" と呼ばれることがよくあります)。これにより、単体テストが容易になります。これは、データを格納するためのメモリ内 `List` コレクションと同様に単純なものを使用するリポジトリ実装にビジネスロジッククラスを接続できるためです。</span><span class="sxs-lookup"><span data-stu-id="0f636-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="0f636-143">技術的には、エンティティオブジェクトは、Entity Framework の `EntityObject` クラスを継承するクラスからインスタンス化されるため、永続化非依存とは見なされません。</span><span class="sxs-lookup"><span data-stu-id="0f636-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="0f636-144">完全な永続化の無視では、`EntityObject` クラスを継承するオブジェクトの代わりに、 *plain OLD CLR オブジェクト*または*pocos*を使用できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="0f636-145">POCOs の使用は、このチュートリアルの範囲を超えています。</span><span class="sxs-lookup"><span data-stu-id="0f636-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="0f636-146">詳細については、MSDN web サイトの「[テストの容易性と Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) 」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="0f636-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>

<span data-ttu-id="0f636-147">これで、リポジトリではなくビジネスロジッククラスに `ObjectDataSource` コントロールを接続し、すべてが以前と同じように動作することを確認できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="0f636-148">Department および*DepartmentsAdd*で、各 `TypeName="ContosoUniversity.DAL.SchoolRepository"` が `TypeName="ContosoUniversity.BLL.SchoolBL` *"に変更*されます。</span><span class="sxs-lookup"><span data-stu-id="0f636-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="0f636-149">(すべてに4つのインスタンスがあります)。</span><span class="sxs-lookup"><span data-stu-id="0f636-149">(There are four instances in all.)</span></span>

<span data-ttu-id="0f636-150">Department *.aspx*と*DepartmentsAdd*ページを実行して、以前と同じように動作することを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="0f636-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="0f636-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="0f636-153">単体テストプロジェクトとリポジトリの実装の作成</span><span class="sxs-lookup"><span data-stu-id="0f636-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="0f636-154">**テストプロジェクト**テンプレートを使用してソリューションに新しいプロジェクトを追加し、`ContosoUniversity.Tests`という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="0f636-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="0f636-155">テストプロジェクトで、`System.Data.Entity` への参照を追加し、`ContosoUniversity` プロジェクトにプロジェクト参照を追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="0f636-156">これで、単体テストで使用するリポジトリクラスを作成できるようになりました。</span><span class="sxs-lookup"><span data-stu-id="0f636-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="0f636-157">このリポジトリのデータストアは、クラス内にあります。</span><span class="sxs-lookup"><span data-stu-id="0f636-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="0f636-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="0f636-159">テストプロジェクトで、新しいクラスファイルを作成し、 *MockSchoolRepository.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="0f636-160">このリポジトリクラスには、Entity Framework に直接アクセスするものと同じ CRUD メソッドがありますが、データベースではなくメモリ内の `List` コレクションを使用します。</span><span class="sxs-lookup"><span data-stu-id="0f636-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="0f636-161">これにより、テストクラスはビジネスロジッククラスの単体テストを簡単に設定および検証できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="0f636-162">単体テストの作成</span><span class="sxs-lookup"><span data-stu-id="0f636-162">Creating Unit Tests</span></span>

<span data-ttu-id="0f636-163">**テスト**プロジェクトテンプレートによってスタブ単体テストクラスが作成されました。次のタスクでは、ビジネスロジッククラスに追加するビジネスロジックに対して単体テストメソッドを追加することによって、このクラスを変更します。</span><span class="sxs-lookup"><span data-stu-id="0f636-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="0f636-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="0f636-165">Contoso 大学では、個々のインストラクターは1つの部門の管理者にしかできません。このルールを適用するには、ビジネスロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f636-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="0f636-166">まず、テストを追加し、テストを実行して失敗したことを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="0f636-167">次に、コードを追加し、テストを再実行します。成功したかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="0f636-168">*UnitTest1.cs*ファイルを開き、ContosoUniversity プロジェクトで作成したビジネスロジックとデータアクセス層の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="0f636-169">`TestMethod1` メソッドを次のメソッドに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="0f636-170">`CreateSchoolBL` メソッドは、単体テストプロジェクト用に作成したリポジトリクラスのインスタンスを作成し、そのインスタンスをビジネスロジッククラスの新しいインスタンスに渡します。</span><span class="sxs-lookup"><span data-stu-id="0f636-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="0f636-171">次に、メソッドはビジネスロジッククラスを使用して、テストメソッドで使用できる3つの部門を挿入します。</span><span class="sxs-lookup"><span data-stu-id="0f636-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="0f636-172">テストメソッドは、他のユーザーが既存の部署と同じ管理者を持つ新しい部署を挿入しようとした場合、または他のユーザーが自分の ID に設定して部門の管理者を更新しようとした場合に、ビジネスロジッククラスが例外をスローすることを確認します。既に別の部門の管理者であるユーザー。</span><span class="sxs-lookup"><span data-stu-id="0f636-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="0f636-173">例外クラスをまだ作成していないため、このコードはコンパイルされません。</span><span class="sxs-lookup"><span data-stu-id="0f636-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="0f636-174">コンパイルするには、`DuplicateAdministratorException` を右クリックし、**生成**、**クラス** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="0f636-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="0f636-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="0f636-176">これにより、テストプロジェクトにクラスが作成されます。このクラスは、メインプロジェクトで例外クラスを作成した後に削除できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="0f636-177">とは、ビジネスロジックを実装したものです。</span><span class="sxs-lookup"><span data-stu-id="0f636-177">and implemented the business logic.</span></span>

<span data-ttu-id="0f636-178">テストプロジェクトを実行します。</span><span class="sxs-lookup"><span data-stu-id="0f636-178">Run the test project.</span></span> <span data-ttu-id="0f636-179">予想どおり、テストは失敗します。</span><span class="sxs-lookup"><span data-stu-id="0f636-179">As expected, the tests fail.</span></span>

<span data-ttu-id="0f636-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="0f636-181">テストパスを作成するためのビジネスロジックの追加</span><span class="sxs-lookup"><span data-stu-id="0f636-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="0f636-182">次に、別の部門の管理者である部署の管理者として設定できないビジネスロジックを実装します。</span><span class="sxs-lookup"><span data-stu-id="0f636-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="0f636-183">ビジネスロジック層から例外をスローし、ユーザーが部署を編集し、既に管理者であるユーザーを選択した後に **[更新]** をクリックした場合に、プレゼンテーション層でキャッチします。</span><span class="sxs-lookup"><span data-stu-id="0f636-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="0f636-184">(ページを表示する前に、既に管理者であることを示すドロップダウンリストから講師を削除することもできますが、ここではビジネスロジックレイヤーを使用することを目的としています)。</span><span class="sxs-lookup"><span data-stu-id="0f636-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="0f636-185">まず、ユーザーが複数の部門の管理者を作成しようとしたときにスローされる例外クラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="0f636-186">メインプロジェクトで、[ *BLL* ] フォルダーに新しいクラスファイルを作成し、 *DuplicateAdministratorException.cs*という名前を付けて、既存のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="0f636-187">次に、前の手順でテストプロジェクトで作成した一時*DuplicateAdministratorException.cs*ファイルを、コンパイルできるように削除します。</span><span class="sxs-lookup"><span data-stu-id="0f636-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="0f636-188">メインプロジェクトで、 *SchoolBL.cs*ファイルを開き、検証ロジックを含む次のメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="0f636-189">(コードは、後で作成するメソッドを参照します)。</span><span class="sxs-lookup"><span data-stu-id="0f636-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="0f636-190">別の部門が既に同じ管理者を持っているかどうかを確認するために `Department` エンティティを挿入または更新するときに、このメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="0f636-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="0f636-191">このコードは、メソッドを呼び出して、挿入または更新されるエンティティと同じ `Administrator` プロパティ値を持つ `Department` エンティティをデータベースで検索します。</span><span class="sxs-lookup"><span data-stu-id="0f636-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="0f636-192">見つかった場合、コードは例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="0f636-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="0f636-193">挿入または更新するエンティティに `Administrator` 値がない場合、検証チェックは必要ありません。更新中にメソッドが呼び出され、見つかった `Department` エンティティが更新される `Department` エンティティと一致する場合、例外はスローされません。</span><span class="sxs-lookup"><span data-stu-id="0f636-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="0f636-194">`Insert` および `Update` メソッドから新しいメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="0f636-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="0f636-195">*ISchoolRepository.cs*で、新しいデータアクセスメソッドに次の宣言を追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="0f636-196">*SchoolRepository.cs*で、次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="0f636-197">*SchoolRepository.cs*で、次の新しいデータアクセスメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="0f636-198">このコードは、指定された管理者を持つ `Department` エンティティを取得します。</span><span class="sxs-lookup"><span data-stu-id="0f636-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="0f636-199">1つの部門のみが検索されます (存在する場合)。</span><span class="sxs-lookup"><span data-stu-id="0f636-199">Only one department should be found (if any).</span></span> <span data-ttu-id="0f636-200">ただし、データベースには制約が組み込まれていないため、複数の部門が見つかった場合の戻り値の型はコレクションです。</span><span class="sxs-lookup"><span data-stu-id="0f636-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="0f636-201">既定では、オブジェクトコンテキストは、データベースからエンティティを取得するときに、オブジェクト状態マネージャーでエンティティを追跡します。</span><span class="sxs-lookup"><span data-stu-id="0f636-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="0f636-202">`MergeOption.NoTracking` パラメーターは、このクエリに対してこの追跡が行われないことを指定します。</span><span class="sxs-lookup"><span data-stu-id="0f636-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="0f636-203">この操作が必要なのは、更新しようとしているエンティティがクエリで返される可能性があるためです。そのエンティティをアタッチすることはできません。</span><span class="sxs-lookup"><span data-stu-id="0f636-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="0f636-204">たとえば、department *. .aspx*ページで履歴部門を編集し、管理者を変更しないままにした場合、このクエリは履歴部門を返します。</span><span class="sxs-lookup"><span data-stu-id="0f636-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="0f636-205">`NoTracking` が設定されていない場合、オブジェクトコンテキストでは、オブジェクト状態マネージャーに History department エンティティが既に存在します。</span><span class="sxs-lookup"><span data-stu-id="0f636-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="0f636-206">次に、ビューステートから再作成された履歴部署エンティティをアタッチすると、オブジェクトコンテキストによって `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`という例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="0f636-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="0f636-207">(`MergeOption.NoTracking`を指定する代わりに、このクエリに対してのみ新しいオブジェクトコンテキストを作成することもできます。</span><span class="sxs-lookup"><span data-stu-id="0f636-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="0f636-208">新しいオブジェクトコンテキストには独自のオブジェクト状態マネージャーがあるため、`Attach` メソッドを呼び出すときに競合が発生することはありません。</span><span class="sxs-lookup"><span data-stu-id="0f636-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="0f636-209">新しいオブジェクトコンテキストでは、メタデータとデータベース接続が元のオブジェクトコンテキストと共有されるため、この代替アプローチのパフォーマンスが低下することは少なくありません。</span><span class="sxs-lookup"><span data-stu-id="0f636-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="0f636-210">ただし、ここに示す方法では `NoTracking` オプションが導入されており、他のコンテキストでも便利です。</span><span class="sxs-lookup"><span data-stu-id="0f636-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="0f636-211">`NoTracking` オプションの詳細については、このシリーズの後のチュートリアルで説明します)。</span><span class="sxs-lookup"><span data-stu-id="0f636-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="0f636-212">テストプロジェクトで、新しいデータアクセスメソッドを*MockSchoolRepository.cs*に追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="0f636-213">このコードでは、LINQ を使用して、`ContosoUniversity` プロジェクトリポジトリが LINQ to Entities に使用するのと同じデータ選択を実行します。</span><span class="sxs-lookup"><span data-stu-id="0f636-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="0f636-214">テストプロジェクトを再度実行します。</span><span class="sxs-lookup"><span data-stu-id="0f636-214">Run the test project again.</span></span> <span data-ttu-id="0f636-215">今回はテストに合格します。</span><span class="sxs-lookup"><span data-stu-id="0f636-215">This time the tests pass.</span></span>

<span data-ttu-id="0f636-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="0f636-217">ObjectDataSource 例外の処理</span><span class="sxs-lookup"><span data-stu-id="0f636-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="0f636-218">`ContosoUniversity` プロジェクト*で、department ページを*実行し、部門の管理者を別の部門の管理者に変更してみます。</span><span class="sxs-lookup"><span data-stu-id="0f636-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="0f636-219">(このチュートリアルで追加したのは、データベースに無効なデータが事前に読み込まれているためです)。次のサーバーエラーページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="0f636-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="0f636-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="0f636-221">この種類のエラーページを表示しないようにするには、エラー処理コードを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f636-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="0f636-222">Department *.aspx*を開き、`DepartmentsObjectDataSource`の `OnUpdated` イベントのハンドラーを指定します。</span><span class="sxs-lookup"><span data-stu-id="0f636-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="0f636-223">`ObjectDataSource` 開始タグは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="0f636-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="0f636-224">*Departments.aspx.cs*で、次の `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="0f636-225">`Updated` イベントに対して次のハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="0f636-226">`ObjectDataSource` コントロールは、更新を実行しようとしたときに例外をキャッチした場合、イベント引数 (`e`) の例外をこのハンドラーに渡します。</span><span class="sxs-lookup"><span data-stu-id="0f636-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="0f636-227">ハンドラーのコードは、例外が管理者の重複する例外であるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f636-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="0f636-228">そうである場合、コードは、表示する `ValidationSummary` コントロールのエラーメッセージを含むバリデーターコントロールを作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="0f636-229">ページを実行し、2つの部門の管理者をもう一度作成します。</span><span class="sxs-lookup"><span data-stu-id="0f636-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="0f636-230">今回は、`ValidationSummary` コントロールによってエラーメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="0f636-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="0f636-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="0f636-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="0f636-232">*DepartmentsAdd*ページに同様の変更を加えます。</span><span class="sxs-lookup"><span data-stu-id="0f636-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="0f636-233">*DepartmentsAdd*で、`DepartmentsObjectDataSource`の `OnInserted` イベントのハンドラーを指定します。</span><span class="sxs-lookup"><span data-stu-id="0f636-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="0f636-234">結果のマークアップは、次の例のようになります。</span><span class="sxs-lookup"><span data-stu-id="0f636-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="0f636-235">*DepartmentsAdd.aspx.cs*で、同じ `using` ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="0f636-236">次のイベントハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="0f636-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="0f636-237">これで、 *DepartmentsAdd.aspx.cs*ページをテストして、1人のユーザーが複数の部門の管理者になる試みも正しく処理していることを確認できます。</span><span class="sxs-lookup"><span data-stu-id="0f636-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="0f636-238">このチュートリアルでは、Entity Framework で `ObjectDataSource` コントロールを使用するためのリポジトリパターンの実装の概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="0f636-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="0f636-239">リポジトリパターンとテストの容易性の詳細については、MSDN ホワイトペーパー「[テストの容易性と Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0f636-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="0f636-240">次のチュートリアルでは、並べ替えとフィルター処理の機能をアプリケーションに追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="0f636-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="0f636-241">[前へ](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [次へ](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="0f636-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
