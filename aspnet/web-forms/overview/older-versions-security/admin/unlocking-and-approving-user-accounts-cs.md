---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: ユーザーアカウントのロック解除とC#承認 () |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、管理者がユーザーのロックアウトと承認済みの状態を管理するための web ページを構築する方法について説明します。 また、新しいユーザーを承認する方法についても説明します。
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: c19f7dfac0ddd12c2b4f3388a71a8ca0f71cbb18
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78438886"
---
# <a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="d9694-104">ユーザー アカウントをロック解除し、承認する (C#)</span><span class="sxs-lookup"><span data-stu-id="d9694-104">Unlocking and Approving User Accounts (C#)</span></span>

<span data-ttu-id="d9694-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d9694-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d9694-106">[コードのダウンロード](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip)または[PDF のダウンロード](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="d9694-106">[Download Code](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="d9694-107">このチュートリアルでは、管理者がユーザーのロックアウトと承認済みの状態を管理するための web ページを構築する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="d9694-108">また、電子メールアドレスを確認した後にのみ、新しいユーザーを承認する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-108">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="introduction"></a><span data-ttu-id="d9694-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="d9694-109">Introduction</span></span>

<span data-ttu-id="d9694-110">ユーザー名、パスワード、および電子メールと共に、各ユーザーアカウントには、ユーザーがサイトにログインできるかどうかを指定する2つの状態フィールドがあります。ロックアウトされ、承認されています。</span><span class="sxs-lookup"><span data-stu-id="d9694-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="d9694-111">指定した分数内に無効な資格情報が指定した回数だけ提供された場合、ユーザーは自動的にロックアウトされます (既定の設定では、10分以内にログイン試行が5回失敗した後にユーザーがロックを解除します)。</span><span class="sxs-lookup"><span data-stu-id="d9694-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="d9694-112">承認済みの状態は、新しいユーザーがサイトにログオンする前に何らかのアクションを実行する必要がある場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="d9694-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="d9694-113">たとえば、ユーザーは、最初に電子メールアドレスを確認するか、ログインする前に管理者によって承認される必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="d9694-114">ロックアウトされたユーザーまたは未承認のユーザーがログインできないため、これらの状態をリセットする方法は自然なものになります。</span><span class="sxs-lookup"><span data-stu-id="d9694-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="d9694-115">ASP.NET には、ユーザーのロックアウトおよび承認済みの状態を管理するための組み込み機能や Web コントロールは含まれていません。これらの決定はサイトごとに処理する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="d9694-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="d9694-116">サイトによっては、すべての新しいユーザーアカウントが自動的に承認される場合があります (既定の動作)。</span><span class="sxs-lookup"><span data-stu-id="d9694-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="d9694-117">管理者が新しいアカウントを承認したり、サインアップ時に指定された電子メールアドレスに送信されたリンクにアクセスするまでユーザーを承認したりすることはできません。</span><span class="sxs-lookup"><span data-stu-id="d9694-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="d9694-118">同様に、一部のサイトでは、管理者が状態をリセットするまでユーザーがロックアウトされる場合がありますが、他のサイトでは、アカウントのロックを解除するためにアクセスできる URL を使用して、ロックアウトされたユーザーに電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="d9694-119">このチュートリアルでは、管理者がユーザーのロックアウトと承認済みの状態を管理するための web ページを構築する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="d9694-120">また、電子メールアドレスを確認した後にのみ、新しいユーザーを承認する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="d9694-121">手順 1:ユーザーのロックアウト状態と承認済み状態の管理</span><span class="sxs-lookup"><span data-stu-id="d9694-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="d9694-122"><a id="Tutorial12"> </a> [ *「多くのチュートリアルから1つのユーザーアカウントを選択するインターフェイスを構築する*](building-an-interface-to-select-one-user-account-from-many-cs.md)」では、ページ分割された GridView で各ユーザーアカウントを一覧表示するページを作成しています。</span><span class="sxs-lookup"><span data-stu-id="d9694-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="d9694-123">グリッドには、各ユーザーの名前と電子メール、承認およびロックアウトされた状態、現在オンラインになっているかどうか、およびユーザーに関するコメントが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="d9694-124">ユーザーの承認済みとロックアウト状態を管理するために、このグリッドを編集可能にすることができます。</span><span class="sxs-lookup"><span data-stu-id="d9694-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="d9694-125">ユーザーの承認済みの状態を変更するには、まず、管理者がユーザーアカウントを検索し、対応する GridView 行を編集して、[承認済み] チェックボックスをオンまたはオフにします。</span><span class="sxs-lookup"><span data-stu-id="d9694-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="d9694-126">または、別の ASP.NET ページを使用して、承認された状態とロックアウトされた状態を管理することもできます。</span><span class="sxs-lookup"><span data-stu-id="d9694-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="d9694-127">このチュートリアルでは、`ManageUsers.aspx` と `UserInformation.aspx`の2つの ASP.NET ページを使用します。</span><span class="sxs-lookup"><span data-stu-id="d9694-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="d9694-128">ここでの考え方は、`ManageUsers.aspx` はシステム内のユーザーアカウントを一覧表示しているのに対し、`UserInformation.aspx` では、管理者は特定のユーザーの承認済みおよびロックアウト状態を管理できます。</span><span class="sxs-lookup"><span data-stu-id="d9694-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="d9694-129">最初のビジネスの順序は、`ManageUsers.aspx` の GridView を拡張して、リンクの列として表示されるハイパーリンクフィールドを含めることです。</span><span class="sxs-lookup"><span data-stu-id="d9694-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="d9694-130">各リンクは `UserInformation.aspx?user=UserName`を指すようにします。 *UserName*は編集するユーザーの名前です。</span><span class="sxs-lookup"><span data-stu-id="d9694-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="d9694-131">「 <a id="Tutorial13"> </a>[*パスワードの回復と変更*](recovering-and-changing-passwords-cs.md)」チュートリアルのコードをダウンロードした場合は、[`ManageUsers.aspx`] ページに "管理" リンクのセットが既に含まれており、[`UserInformation.aspx`] ページに、選択したユーザーのパスワードを変更するためのインターフェイスが用意されていることがわかります。</span><span class="sxs-lookup"><span data-stu-id="d9694-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="d9694-132">このチュートリアルに関連付けられているコードでは、この機能をレプリケートしないことにしました。これは、メンバーシップ API を回避し、SQL Server データベースを直接操作してユーザーのパスワードを変更することによって動作したためです。</span><span class="sxs-lookup"><span data-stu-id="d9694-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="d9694-133">このチュートリアルは、最初から `UserInformation.aspx` ページから開始します。</span><span class="sxs-lookup"><span data-stu-id="d9694-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>

### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="d9694-134">`UserAccounts`GridView に "管理" リンクを追加する</span><span class="sxs-lookup"><span data-stu-id="d9694-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="d9694-135">[`ManageUsers.aspx`] ページを開き、[ハイパーリンク] フィールドを `UserAccounts` GridView に追加します。</span><span class="sxs-lookup"><span data-stu-id="d9694-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="d9694-136">[ハイパーリンク] フィールドの [`Text`] プロパティを "Manage" に設定し、その `DataNavigateUrlFields` と `DataNavigateUrlFormatString` のプロパティを `UserName` および "UserInformation .aspx? user ={0}" にそれぞれ設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="d9694-137">これらの設定は、すべてのハイパーリンクに "Manage" というテキストが表示されるように hyperlink フィールドを構成しますが、各リンクは、適切な*ユーザー名*の値を querystring に渡します。</span><span class="sxs-lookup"><span data-stu-id="d9694-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="d9694-138">[ハイパーリンク] フィールドを GridView に追加した後、ブラウザーを使用して `ManageUsers.aspx` ページを表示します。</span><span class="sxs-lookup"><span data-stu-id="d9694-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="d9694-139">図1に示すように、各 GridView 行には "Manage" リンクが含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="d9694-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="d9694-140">の [管理] リンクは `UserInformation.aspx?user=Bruce`をポイントしますが、Dave の [管理] リンクを `UserInformation.aspx?user=Dave`します。</span><span class="sxs-lookup"><span data-stu-id="d9694-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>

<span data-ttu-id="d9694-141">[ハイパーリンクフィールドに ![を追加すると、](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="d9694-142">**図 1**:[ハイパーリンク] フィールドには、ユーザーアカウントごとに "管理" リンクが追加されます ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image3.png)されます)。</span><span class="sxs-lookup"><span data-stu-id="d9694-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>

<span data-ttu-id="d9694-143">ここでは、`UserInformation.aspx` ページのユーザーインターフェイスとコードを作成しますが、まず、ユーザーのロックアウト状態と承認済みの状態をプログラムで変更する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="d9694-144">[`MembershipUser` クラス](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)には、[`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) プロパティと[`IsApproved` プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx)があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="d9694-145">`IsLockedOut` プロパティは読み取り専用です。</span><span class="sxs-lookup"><span data-stu-id="d9694-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="d9694-146">プログラムによってユーザーをロックアウトするメカニズムはありません。ユーザーのロックを解除するには、`MembershipUser` クラスの[`UnlockUser` メソッド](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)を使用します。</span><span class="sxs-lookup"><span data-stu-id="d9694-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="d9694-147">`IsApproved` プロパティは読み取りと書き込みが可能です。</span><span class="sxs-lookup"><span data-stu-id="d9694-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="d9694-148">このプロパティに対する変更を保存するには、`Membership` クラスの[`UpdateUser` メソッド](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)を呼び出して、変更された `MembershipUser` オブジェクトを渡します。</span><span class="sxs-lookup"><span data-stu-id="d9694-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="d9694-149">`IsApproved` プロパティは読み取りと書き込みが可能であるため、CheckBox コントロールは、このプロパティを構成するための最適なユーザーインターフェイス要素として使用されることがあります。</span><span class="sxs-lookup"><span data-stu-id="d9694-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="d9694-150">ただし、管理者がユーザーをロックアウトすることはできず、ユーザーのロックを解除することはできないので、`IsLockedOut` プロパティではチェックボックスは機能しません。</span><span class="sxs-lookup"><span data-stu-id="d9694-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="d9694-151">`IsLockedOut` プロパティの適切なユーザーインターフェイスはボタンです。クリックすると、ユーザーアカウントのロックが解除されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="d9694-152">このボタンは、ユーザーがロックアウトされている場合にのみ有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="d9694-153">`UserInformation.aspx`ページの作成</span><span class="sxs-lookup"><span data-stu-id="d9694-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="d9694-154">これで、`UserInformation.aspx`にユーザーインターフェイスを実装する準備が整いました。</span><span class="sxs-lookup"><span data-stu-id="d9694-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="d9694-155">このページを開き、次の Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="d9694-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="d9694-156">ハイパーリンクコントロール。クリックすると、管理者が [`ManageUsers.aspx`] ページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="d9694-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="d9694-157">選択したユーザーの名前を表示するためのラベル Web コントロール。</span><span class="sxs-lookup"><span data-stu-id="d9694-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="d9694-158">このラベルの `ID` を `UserNameLabel` に設定し、`Text` プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="d9694-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="d9694-159">`IsApproved`という名前の CheckBox コントロール。</span><span class="sxs-lookup"><span data-stu-id="d9694-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="d9694-160">`AutoPostBack` プロパティを `true`に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="d9694-161">ユーザーの最後のロックアウト日を表示するためのラベルコントロール。</span><span class="sxs-lookup"><span data-stu-id="d9694-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="d9694-162">このラベルに `LastLockedOutDateLabel` という名前を付け、その `Text` プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="d9694-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="d9694-163">ユーザーのロックを解除するためのボタン。</span><span class="sxs-lookup"><span data-stu-id="d9694-163">A Button for unlocking the user.</span></span> <span data-ttu-id="d9694-164">このボタン `UnlockUserButton` という名前を指定し、その `Text` プロパティを "Unlock User" に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="d9694-165">"ユーザーの承認された状態は更新されました。" などのステータスメッセージを表示するためのラベルコントロール。</span><span class="sxs-lookup"><span data-stu-id="d9694-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="d9694-166">このコントロールに `StatusMessage`という名前を設定し、その `Text` プロパティをオフにして、その `CssClass` プロパティを `Important`に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="d9694-167">(`Important` CSS クラスは、`Styles.css` スタイルシートファイルで定義されています。これにより、対応するテキストが大きな赤いフォントで表示されます)。</span><span class="sxs-lookup"><span data-stu-id="d9694-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="d9694-168">これらのコントロールを追加した後、Visual Studio のデザインビューは、図2のスクリーンショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="d9694-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>

<span data-ttu-id="d9694-169">[UserInformation .aspx 用のユーザーインターフェイスを作成 ![には](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="d9694-170">**図 2**:`UserInformation.aspx` 用のユーザーインターフェイスを作成[します (クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>

<span data-ttu-id="d9694-171">ユーザーインターフェイスが完成したら、次に、選択したユーザーの情報に基づいて `IsApproved` チェックボックスとその他のコントロールを設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="d9694-172">ページの `Load` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d9694-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="d9694-173">上記のコードは、最初にページにアクセスし、次のポストバックではないことを確認することから始まります。</span><span class="sxs-lookup"><span data-stu-id="d9694-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="d9694-174">次に、`user` querystring フィールドを通じて渡されたユーザー名を読み取り、`Membership.GetUser(username)` メソッドを使用してそのユーザーアカウントに関する情報を取得します。</span><span class="sxs-lookup"><span data-stu-id="d9694-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="d9694-175">Querystring でユーザー名が指定されなかった場合、または指定されたユーザーが見つからなかった場合は、管理者が `ManageUsers.aspx` ページに戻されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="d9694-176">`MembershipUser` オブジェクトの `UserName` 値が `UserNameLabel` に表示され、`IsApproved` プロパティ値に基づいて `IsApproved` チェックボックスがオンになります。</span><span class="sxs-lookup"><span data-stu-id="d9694-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="d9694-177">`MembershipUser` オブジェクトの[`LastLockoutDate` プロパティ](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx)は、ユーザーが最後にロックアウトされた日時を示す `DateTime` 値を返します。ユーザーがロックアウトされていない場合、返される値はメンバーシッププロバイダーによって異なります。</span><span class="sxs-lookup"><span data-stu-id="d9694-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="d9694-178">新しいアカウントを作成すると、`SqlMembershipProvider` によって `aspnet_Membership` テーブルの `LastLockoutDate` フィールドが `1754-01-01 12:00:00 AM`に設定されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="d9694-179">上のコードでは、`LastLockoutDate` プロパティが2000年の前に発生した場合、`LastLockoutDateLabel` に空の文字列が表示されます。それ以外の場合は、`LastLockoutDate` プロパティの日付部分がラベルに表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="d9694-180">`UnlockUserButton'` s `Enabled` プロパティは、ユーザーのロックアウト状態に設定されます。つまり、このボタンは、ユーザーがロックアウトされている場合にのみ有効になります。</span><span class="sxs-lookup"><span data-stu-id="d9694-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="d9694-181">ブラウザーを使用して `UserInformation.aspx` のページをテストしてみましょう。</span><span class="sxs-lookup"><span data-stu-id="d9694-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="d9694-182">もちろん、`ManageUsers.aspx` で開始し、管理するユーザーアカウントを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="d9694-183">`UserInformation.aspx`に到着すると、[`IsApproved`] チェックボックスは、ユーザーが承認されている場合にのみチェックされることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d9694-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="d9694-184">ユーザーがロックアウトされている場合は、最後のロックアウト日が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="d9694-185">[ユーザーのロック解除] ボタンは、ユーザーが現在ロックアウトされている場合にのみ有効になります。`IsApproved` チェックボックスをオンまたはオフにして [ユーザーのロック解除] ボタンをクリックすると、ポストバックが発生しますが、これらのイベントのイベントハンドラーをまだ作成していないため、ユーザーアカウントに変更は加えられません。</span><span class="sxs-lookup"><span data-stu-id="d9694-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="d9694-186">Visual Studio に戻り、`IsApproved` CheckBox の `CheckedChanged` イベントと、`UnlockUser` ボタンの `Click` イベントのイベントハンドラーを作成します。</span><span class="sxs-lookup"><span data-stu-id="d9694-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="d9694-187">`CheckedChanged` イベントハンドラーで、ユーザーの `IsApproved` プロパティをチェックボックスの `Checked` プロパティに設定し、`Membership.UpdateUser`の呼び出しを使用して変更を保存します。</span><span class="sxs-lookup"><span data-stu-id="d9694-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="d9694-188">`Click` イベントハンドラーでは、`MembershipUser` オブジェクトの `UnlockUser` メソッドを呼び出すだけです。</span><span class="sxs-lookup"><span data-stu-id="d9694-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="d9694-189">両方のイベントハンドラーで、`StatusMessage` ラベルに適切なメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="d9694-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="d9694-190">`UserInformation.aspx`ページのテスト</span><span class="sxs-lookup"><span data-stu-id="d9694-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="d9694-191">これらのイベントハンドラーを使用して、ページを再実行し、ユーザーを未承認にします。</span><span class="sxs-lookup"><span data-stu-id="d9694-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="d9694-192">図3に示すように、ページには、ユーザーの `IsApproved` プロパティが正常に変更されたことを示す簡単なメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>

<span data-ttu-id="d9694-193">[Chris が承認されていない ![](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="d9694-194">**図 3**:Chris が未承認になりました ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image9.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>

<span data-ttu-id="d9694-195">次に、ログアウトして、アカウントが承認されていないユーザーとしてログインします。</span><span class="sxs-lookup"><span data-stu-id="d9694-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="d9694-196">ユーザーは承認されていないため、ログインできません。</span><span class="sxs-lookup"><span data-stu-id="d9694-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="d9694-197">既定では、ログイン制御は、理由に関係なく、ユーザーがログインできない場合、同じメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="d9694-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="d9694-198">ただし、 <a id="Tutorial6"> </a>[*メンバーシップユーザーストアに対するユーザー資格情報の検証*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md)に関するチュートリアルでは、より適切なメッセージを表示するように、ログインコントロールを拡張する方法を検討しました。</span><span class="sxs-lookup"><span data-stu-id="d9694-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="d9694-199">図4に示すように、Chris には、アカウントがまだ承認されていないためにログインできないことを示すメッセージが表示されています。</span><span class="sxs-lookup"><span data-stu-id="d9694-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>

<span data-ttu-id="d9694-200">[アカウントが承認されていないため、Chris がログインできない ![](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="d9694-201">**図 4**:アカウントが承認されていないため、Chris はログインできません ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image12.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>

<span data-ttu-id="d9694-202">ロックアウトされた機能をテストするには、承認されたユーザーとしてログインを試みますが、正しくないパスワードを使用します。</span><span class="sxs-lookup"><span data-stu-id="d9694-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="d9694-203">ユーザーのアカウントがロックアウトされるまで、必要な回数だけこのプロセスを繰り返します。ロックアウトされたアカウントからログインしようとすると、カスタムメッセージを表示するように Login コントロールも更新されました。</span><span class="sxs-lookup"><span data-stu-id="d9694-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="d9694-204">ログインページで次のメッセージが表示されると、アカウントがロックアウトされていることがわかります。"無効なログイン試行回数が多すぎるため、アカウントがロックアウトされました。</span><span class="sxs-lookup"><span data-stu-id="d9694-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="d9694-205">アカウントのロックを解除するには、管理者にお問い合わせください。 "</span><span class="sxs-lookup"><span data-stu-id="d9694-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="d9694-206">`ManageUsers.aspx` ページに戻り、ロックアウトされたユーザーの [管理] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="d9694-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="d9694-207">図5に示すように、[ユーザーのロック解除] ボタンが有効になっている `LastLockedOutDateLabel` に値が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="d9694-208">ユーザーアカウントのロックを解除するには、[ユーザーのロック解除] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="d9694-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="d9694-209">ユーザーのロックを解除すると、再度ログインできるようになります。</span><span class="sxs-lookup"><span data-stu-id="d9694-209">Once you have unlocked the user, they will be able to login again.</span></span>

<span data-ttu-id="d9694-210">[![Dave がシステムからロックアウトされました](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="d9694-211">**図 5**:Dave がシステムからロックアウトされました ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>

## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="d9694-212">手順 2:新しいユーザーの承認済み状態の指定</span><span class="sxs-lookup"><span data-stu-id="d9694-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="d9694-213">承認済みの状態は、新しいユーザーがサイトのユーザー固有の機能にログインしてアクセスできるようにするために、何らかのアクションを実行する必要がある場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="d9694-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="d9694-214">たとえば、プライベート web サイトを実行していて、ログインページとサインアップページを除くすべてのページが、認証されたユーザーのみがアクセスできるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="d9694-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="d9694-215">しかし、ユーザーが web サイトに到達し、サインアップページを検索して、アカウントを作成した場合はどうなるでしょうか。</span><span class="sxs-lookup"><span data-stu-id="d9694-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="d9694-216">この問題を回避するには、サインアップページを `Administration` フォルダーに移動し、管理者が各アカウントを手動で作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="d9694-217">または、すべてのユーザーにサインアップを許可し、管理者がユーザーアカウントを承認するまでサイトアクセスを禁止することもできます。</span><span class="sxs-lookup"><span data-stu-id="d9694-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="d9694-218">既定では、CreateUserWizard コントロールは新しいアカウントを承認します。</span><span class="sxs-lookup"><span data-stu-id="d9694-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="d9694-219">この動作は、コントロールの[`DisableCreatedUser` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)を使用して構成できます。</span><span class="sxs-lookup"><span data-stu-id="d9694-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="d9694-220">新しいユーザーアカウントを承認しないようにするには、このプロパティを `true` に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="d9694-221">既定では、CreateUserWizard コントロールは新しいユーザーアカウントに自動的にログオンします。</span><span class="sxs-lookup"><span data-stu-id="d9694-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="d9694-222">この動作は、コントロールの[`LoginCreatedUser` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)によって決まります。</span><span class="sxs-lookup"><span data-stu-id="d9694-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="d9694-223">未承認のユーザーがサイトにログインできないため、`DisableCreatedUser` が `true` 場合、`LoginCreatedUser` プロパティの値に関係なく、新しいユーザーアカウントはサイトにログインしません。</span><span class="sxs-lookup"><span data-stu-id="d9694-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>

<span data-ttu-id="d9694-224">`Membership.CreateUser` メソッドを使用してプログラムによって新しいユーザーアカウントを作成する場合、未承認のユーザーアカウントを作成するには、新しいユーザーの `IsApproved` プロパティ値を入力パラメーターとして受け取るオーバーロードのいずれかを使用します。</span><span class="sxs-lookup"><span data-stu-id="d9694-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="d9694-225">手順 3:電子メールアドレスを確認してユーザーを承認する</span><span class="sxs-lookup"><span data-stu-id="d9694-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="d9694-226">ユーザーアカウントをサポートする多くの web サイトは、登録時に指定した電子メールアドレスを確認するまで、新しいユーザーを承認しません。</span><span class="sxs-lookup"><span data-stu-id="d9694-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="d9694-227">この検証プロセスは、ボット、スパム送信者、およびその他の neer を阻止するためによく使用されます。これは、一意で検証された電子メールアドレスが必要であり、サインアッププロセスに追加の手順が追加されるためです。</span><span class="sxs-lookup"><span data-stu-id="d9694-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="d9694-228">このモデルでは、新しいユーザーがサインアップすると、確認ページへのリンクを含む電子メールメッセージが送信されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="d9694-229">このリンクにアクセスすることで、ユーザーは電子メールを受信したことがわかっているので、指定された電子メールアドレスが有効であることが証明されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="d9694-230">検証ページは、ユーザーを承認する役割を担います。</span><span class="sxs-lookup"><span data-stu-id="d9694-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="d9694-231">これは自動的に発生し、このページに到達したユーザーを承認するか、ユーザーが[CAPTCHA](http://en.wikipedia.org/wiki/Captcha)などの追加情報を提供した後にのみ承認されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="d9694-232">このワークフローに対応するには、最初にアカウント作成ページを更新して、新しいユーザーが承認されないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="d9694-233">`Membership` フォルダーの [`EnhancedCreateUserWizard.aspx`] ページを開き、CreateUserWizard コントロールの `DisableCreatedUser` プロパティを [`true`] に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="d9694-234">次に、新しいユーザーに電子メールを送信するように CreateUserWizard コントロールを構成し、アカウントを確認する方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="d9694-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="d9694-235">特に、`Verification.aspx` ページ (まだ作成していません) へのリンクを電子メールに含め、新しいユーザーの `UserId` を querystring で渡します。</span><span class="sxs-lookup"><span data-stu-id="d9694-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="d9694-236">`Verification.aspx` ページでは、指定されたユーザーを検索し、承認済みとしてマークします。</span><span class="sxs-lookup"><span data-stu-id="d9694-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="d9694-237">新しいユーザーに確認メールを送信する</span><span class="sxs-lookup"><span data-stu-id="d9694-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="d9694-238">CreateUserWizard コントロールから電子メールを送信するには、その `MailDefinition` プロパティを適切に構成します。</span><span class="sxs-lookup"><span data-stu-id="d9694-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="d9694-239"><a id="Tutorial13"> </a>[前のチュートリアル](recovering-and-changing-passwords-cs.md)で説明したように、ChangePassword および passwordrecovery コントロールには、CreateUserWizard コントロールのと同じ方法で動作する[`MailDefinition` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx)が含まれています。</span><span class="sxs-lookup"><span data-stu-id="d9694-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="d9694-240">`MailDefinition` プロパティを使用するには、`Web.config`でメール配信オプションを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="d9694-241">詳細については、「 [ASP.NET での電子メールの送信」](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d9694-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>

<span data-ttu-id="d9694-242">まず、`EmailTemplates` フォルダーに `CreateUserWizard.txt` という名前の新しい電子メールテンプレートを作成します。</span><span class="sxs-lookup"><span data-stu-id="d9694-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="d9694-243">テンプレートには、次のテキストを使用します。</span><span class="sxs-lookup"><span data-stu-id="d9694-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="d9694-244">`MailDefinition'` s `BodyFileName` プロパティを "~/EmailTemplates/CreateUserWizard.txt" に設定し、その `Subject` プロパティを [My Web サイトへようこそ] に設定します。</span><span class="sxs-lookup"><span data-stu-id="d9694-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="d9694-245">アカウントをアクティブ化してください。 "</span><span class="sxs-lookup"><span data-stu-id="d9694-245">Please activate your account."</span></span>

<span data-ttu-id="d9694-246">`CreateUserWizard.txt` 電子メールテンプレートには、`<%VerificationUrl%>` プレースホルダーが含まれていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d9694-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="d9694-247">ここで、`Verification.aspx` ページの URL が配置されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="d9694-248">CreateUserWizard は、`<%UserName%>` と `<%Password%>` のプレースホルダーを新しいアカウントのユーザー名とパスワードに自動的に置き換えますが、組み込みの `<%VerificationUrl%>` プレースホルダーはありません。</span><span class="sxs-lookup"><span data-stu-id="d9694-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="d9694-249">適切な検証 URL に手動で置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="d9694-250">これを実現するには、CreateUserWizard の[`SendingMail` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx)のイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d9694-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="d9694-251">`SendingMail` イベントは、`CreatedUser` イベントの後に発生します。つまり、上記のイベントハンドラーが実行されたときに、新しいユーザーアカウントが既に作成されていることを意味します。</span><span class="sxs-lookup"><span data-stu-id="d9694-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="d9694-252">新しいユーザーの `UserId` 値にアクセスするには、`Membership.GetUser` メソッドを呼び出し、CreateUserWizard コントロールに入力した `UserName` を渡します。</span><span class="sxs-lookup"><span data-stu-id="d9694-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="d9694-253">次に、検証 URL が形成されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="d9694-254">ステートメント `Request.Url.GetLeftPart(UriPartial.Authority)` は、URL の `http://yourserver.com` の部分を返します。`Request.ApplicationPath` は、アプリケーションがルートとするパスを返します。</span><span class="sxs-lookup"><span data-stu-id="d9694-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="d9694-255">検証 URL が `Verification.aspx?ID=userId`として定義されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="d9694-256">この2つの文字列は、完全な URL を形成するために連結されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="d9694-257">最後に、電子メールメッセージの本文 (`e.Message.Body`) には、すべての `<%VerificationUrl%>` が完全な URL で置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="d9694-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="d9694-258">実質的な効果は、新しいユーザーが未承認であることです。つまり、サイトにログインすることはできません。</span><span class="sxs-lookup"><span data-stu-id="d9694-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="d9694-259">さらに、確認 URL へのリンクを含む電子メールが自動的に送信されます (図6を参照)。</span><span class="sxs-lookup"><span data-stu-id="d9694-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>

<span data-ttu-id="d9694-260">[新しいユーザーが、確認 URL へのリンクを含む電子メールを受信 ![](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="d9694-261">**図 6**:新しいユーザーは、確認 URL へのリンクを含む電子メールを受信します ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d9694-262">CreateUserWizard コントロールの既定の CreateUserWizard ステップでは、ユーザーにアカウントが作成されたことを知らせるメッセージが表示され、[続行] ボタンが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="d9694-263">このボタンをクリックすると、ユーザーはコントロールの `ContinueDestinationPageUrl` プロパティによって指定された URL に移動します。</span><span class="sxs-lookup"><span data-stu-id="d9694-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="d9694-264">`EnhancedCreateUserWizard.aspx` の CreateUserWizard は、新しいユーザーを `~/Membership/AdditionalUserInfo.aspx`に送信するように構成されています。これにより、ユーザーは自分の故郷、ホームページの URL、署名を求められます。</span><span class="sxs-lookup"><span data-stu-id="d9694-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="d9694-265">この情報は、ログオンしているユーザーのみが追加できるため、このプロパティを更新して、ユーザーをサイトのホームページ (`~/Default.aspx`) に戻すことができます。</span><span class="sxs-lookup"><span data-stu-id="d9694-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="d9694-266">さらに、[`EnhancedCreateUserWizard.aspx`] ページまたは CreateUserWizard 手順は、確認メールが送信されたことをユーザーに通知するように拡張する必要があります。また、そのアカウントは、この電子メールの指示に従うまでライセンス認証されません。</span><span class="sxs-lookup"><span data-stu-id="d9694-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="d9694-267">これらの変更は、読者のための演習として残しておきます。</span><span class="sxs-lookup"><span data-stu-id="d9694-267">I leave these modifications as an exercise for the reader.</span></span>

### <a name="creating-the-verification-page"></a><span data-ttu-id="d9694-268">検証ページの作成</span><span class="sxs-lookup"><span data-stu-id="d9694-268">Creating the Verification Page</span></span>

<span data-ttu-id="d9694-269">最後に、`Verification.aspx` ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="d9694-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="d9694-270">このページをルートフォルダーに追加し、`Site.master` マスターページに関連付けます。</span><span class="sxs-lookup"><span data-stu-id="d9694-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="d9694-271">前に説明したコンテンツページのほとんどがサイトに追加されたので、コンテンツページがマスターページの既定のコンテンツを使用するように、`LoginContent` ContentPlaceHolder を参照するコンテンツコントロールを削除します。</span><span class="sxs-lookup"><span data-stu-id="d9694-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="d9694-272">[`Verification.aspx`] ページに [ラベル] Web コントロールを追加し、その `ID` を `StatusMessage` に設定して、[text] プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="d9694-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="d9694-273">次に、`Page_Load` イベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d9694-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="d9694-274">上記のコードの大部分では、querystring を通じて提供された `UserId` が存在すること、有効な `Guid` 値であること、および既存のユーザーアカウントを参照していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="d9694-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="d9694-275">これらすべてのチェックに合格すると、ユーザーアカウントは承認されます。それ以外の場合は、適切なステータスメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="d9694-276">図7は、ブラウザーを使用してアクセスしたときの `Verification.aspx` ページを示しています。</span><span class="sxs-lookup"><span data-stu-id="d9694-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>

<span data-ttu-id="d9694-277">[新しいユーザーのアカウントが承認された ![](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d9694-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="d9694-278">**図 7**:新しいユーザーのアカウントが承認されました ([クリックすると、フルサイズの画像が表示](unlocking-and-approving-user-accounts-cs/_static/image21.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d9694-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>

## <a name="summary"></a><span data-ttu-id="d9694-279">まとめ</span><span class="sxs-lookup"><span data-stu-id="d9694-279">Summary</span></span>

<span data-ttu-id="d9694-280">すべてのメンバーシップユーザーアカウントには、ユーザーがサイトにログインできるかどうかを決定する2つの状態があります。 `IsLockedOut` と `IsApproved`です。</span><span class="sxs-lookup"><span data-stu-id="d9694-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="d9694-281">ユーザーがログインするには、これらのプロパティの両方を `true` する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d9694-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="d9694-282">ユーザーのロックアウト状態はセキュリティ対策として使用されます。これは、ブルートフォース方式によって、ハッカーがサイトに侵入する可能性を低減するためです。</span><span class="sxs-lookup"><span data-stu-id="d9694-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="d9694-283">具体的には、一定の時間内に無効なログイン試行回数があると、ユーザーはロックアウトされます。</span><span class="sxs-lookup"><span data-stu-id="d9694-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="d9694-284">これらの境界は、`Web.config`のメンバーシッププロバイダー設定を使用して構成できます。</span><span class="sxs-lookup"><span data-stu-id="d9694-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="d9694-285">承認済みの状態は、一部のアクションが発生するまで、新しいユーザーがログインできないようにする手段としてよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="d9694-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="d9694-286">サイトでは、最初に管理者が新しいアカウントを承認する必要があります。または、手順3で見たように、電子メールアドレスを確認してください。</span><span class="sxs-lookup"><span data-stu-id="d9694-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="d9694-287">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="d9694-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="d9694-288">著者について</span><span class="sxs-lookup"><span data-stu-id="d9694-288">About the Author</span></span>

<span data-ttu-id="d9694-289">1998以降、Microsoft の Web テクノロジを使用して、Scott Mitchell (複数の ASP/創設者4GuysFromRolla.com の執筆者) が Microsoft の Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="d9694-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d9694-290">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="d9694-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d9694-291">彼の最新の書籍は *[、ASP.NET 2.0 を24時間以内に教え](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* ています。</span><span class="sxs-lookup"><span data-stu-id="d9694-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="d9694-292">Scott は、 [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)またはブログで[http://ScottOnWriting.NET](http://scottonwriting.net/)にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="d9694-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="d9694-293">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="d9694-293">Special Thanks To…</span></span>

<span data-ttu-id="d9694-294">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="d9694-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="d9694-295">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="d9694-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="d9694-296">その場合は、 [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)の行を削除します。</span><span class="sxs-lookup"><span data-stu-id="d9694-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d9694-297">[前へ](recovering-and-changing-passwords-cs.md)
> [次へ](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="d9694-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
