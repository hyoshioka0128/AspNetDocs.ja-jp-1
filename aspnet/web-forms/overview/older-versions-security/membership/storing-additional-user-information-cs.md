---
uid: web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
title: 追加のユーザー情報をC#格納する () |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、非常に基本的なゲストブックアプリケーションを構築することで、この質問に答えます。 ここでは、modeli のさまざまなオプションについて説明します。
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 1642132a-1ca5-4872-983f-ab59fc8865d3
msc.legacyurl: /web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
msc.type: authoredcontent
ms.openlocfilehash: 24b96e86bc93e03d2639b73e35ed1fd1271bac5a
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74641452"
---
# <a name="storing-additional-user-information-c"></a><span data-ttu-id="da843-104">追加のユーザー情報を格納する (C#)</span><span class="sxs-lookup"><span data-stu-id="da843-104">Storing Additional User Information (C#)</span></span>

<span data-ttu-id="da843-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="da843-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="da843-106">[コードのダウンロード](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_CS.zip)または[PDF のダウンロード](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="da843-106">[Download Code](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_CS.zip) or [Download PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_cs.pdf)</span></span>

> <span data-ttu-id="da843-107">このチュートリアルでは、非常に基本的なゲストブックアプリケーションを構築することで、この質問に答えます。</span><span class="sxs-lookup"><span data-stu-id="da843-107">In this tutorial we will answer this question by building a very rudimentary guestbook application.</span></span> <span data-ttu-id="da843-108">ここでは、データベースでユーザー情報をモデル化するためのさまざまなオプションについて説明し、メンバーシップフレームワークによって作成されたユーザーアカウントにこのデータを関連付ける方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-108">In doing so, we will look at different options for modeling user information in a database, and then see how to associate this data with the user accounts created by the Membership framework.</span></span>

## <a name="introduction"></a><span data-ttu-id="da843-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="da843-109">Introduction</span></span>

<span data-ttu-id="da843-110">ASP.NET のメンバーシップフレームワークは、ユーザーを管理するための柔軟なインターフェイスを提供します。</span><span class="sxs-lookup"><span data-stu-id="da843-110">ASP.NET's Membership framework offers a flexible interface for managing users.</span></span> <span data-ttu-id="da843-111">メンバーシップ API には、資格情報の検証、現在ログオンしているユーザーに関する情報の取得、新しいユーザーアカウントの作成、および他のユーザーアカウントの削除を行うためのメソッドが含まれています。</span><span class="sxs-lookup"><span data-stu-id="da843-111">The Membership API includes methods for validating credentials, retrieving information about the currently logged on user, creating a new user account, and deleting a user account, among others.</span></span> <span data-ttu-id="da843-112">メンバーシップフレームワークの各ユーザーアカウントには、資格情報を検証し、ユーザーアカウント関連の重要なタスクを実行するために必要なプロパティのみが含まれています。</span><span class="sxs-lookup"><span data-stu-id="da843-112">Each user account in the Membership framework contains only the properties needed for validating credentials and performing essential user account-related tasks.</span></span> <span data-ttu-id="da843-113">これは、メンバーシップフレームワークでユーザーアカウントをモデル化する[`MembershipUser` クラス](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)のメソッドとプロパティによって、このことが判明します。</span><span class="sxs-lookup"><span data-stu-id="da843-113">This is evidenced by the methods and properties of the [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), which models a user account in the Membership framework.</span></span> <span data-ttu-id="da843-114">このクラスには、 [`UserName`](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx)、 [`Email`](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx)、 [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)などのプロパティと、 [`GetPassword`](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx)や[`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)などのメソッドがあります。</span><span class="sxs-lookup"><span data-stu-id="da843-114">This class has properties like [`UserName`](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx), [`Email`](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx), and [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx), and methods like [`GetPassword`](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx) and [`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span>

<span data-ttu-id="da843-115">多くの場合、アプリケーションでは、メンバーシップフレームワークに含まれていない追加のユーザー情報を格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-115">Oftentimes, applications need to store additional user information not included in the Membership framework.</span></span> <span data-ttu-id="da843-116">たとえば、オンライン小売業者は、各ユーザーに配送先住所と請求先住所、支払い情報、配信設定、連絡先の電話番号を保存することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="da843-116">For example, an online retailer might need to let each user store her shipping and billing addresses, payment information, delivery preferences, and contact phone number.</span></span> <span data-ttu-id="da843-117">さらに、システム内の各注文は、特定のユーザーアカウントに関連付けられています。</span><span class="sxs-lookup"><span data-stu-id="da843-117">Furthermore, each order in the system is associated with a particular user account.</span></span>

<span data-ttu-id="da843-118">`MembershipUser` クラスには、`PhoneNumber`、`DeliveryPreferences`、`PastOrders`などのプロパティは含まれません。</span><span class="sxs-lookup"><span data-stu-id="da843-118">The `MembershipUser` class does not include properties like `PhoneNumber` or `DeliveryPreferences` or `PastOrders`.</span></span> <span data-ttu-id="da843-119">では、アプリケーションが必要とするユーザー情報を追跡し、それをメンバーシップフレームワークと統合するにはどうすればよいでしょうか。</span><span class="sxs-lookup"><span data-stu-id="da843-119">So how do we track the user information needed by the application and have it integrate with the Membership framework?</span></span> <span data-ttu-id="da843-120">このチュートリアルでは、非常に基本的なゲストブックアプリケーションを構築することで、この質問に答えます。</span><span class="sxs-lookup"><span data-stu-id="da843-120">In this tutorial we will answer this question by building a very rudimentary guestbook application.</span></span> <span data-ttu-id="da843-121">ここでは、データベースでユーザー情報をモデル化するためのさまざまなオプションについて説明し、メンバーシップフレームワークによって作成されたユーザーアカウントにこのデータを関連付ける方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-121">In doing so, we will look at different options for modeling user information in a database, and then see how to associate this data with the user accounts created by the Membership framework.</span></span> <span data-ttu-id="da843-122">では、始めましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-122">Let's get started!</span></span>

## <a name="step-1-creating-the-guestbook-applications-data-model"></a><span data-ttu-id="da843-123">手順 1: ゲストブックアプリケーションのデータモデルを作成する</span><span class="sxs-lookup"><span data-stu-id="da843-123">Step 1: Creating the Guestbook Application's Data Model</span></span>

<span data-ttu-id="da843-124">データベース内のユーザー情報をキャプチャし、メンバーシップフレームワークによって作成されたユーザーアカウントに関連付けることができるさまざまな手法があります。</span><span class="sxs-lookup"><span data-stu-id="da843-124">There are a variety of techniques that can be employed to capture user information in a database and associate it with the user accounts created by the Membership framework.</span></span> <span data-ttu-id="da843-125">これらの手法を説明するために、ユーザーに関連する何らかのデータをキャプチャするように、チュートリアル web アプリケーションを拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-125">In order to illustrate these techniques, we will need to augment the tutorial web application so that it captures some sort of user-related data.</span></span> <span data-ttu-id="da843-126">(現時点では、アプリケーションのデータモデルには、`SqlMembershipProvider`に必要なアプリケーションサービステーブルだけが含まれています)。</span><span class="sxs-lookup"><span data-stu-id="da843-126">(Currently, the application's data model contains only the application services tables needed by the `SqlMembershipProvider`.)</span></span>

<span data-ttu-id="da843-127">認証されたユーザーがコメントを残すことができる、非常に単純なゲストブックアプリケーションを作成しましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-127">Let's create a very simple guestbook application where an authenticated user can leave a comment.</span></span> <span data-ttu-id="da843-128">ゲストブックのコメントを保存するだけでなく、各ユーザーに自宅の町、ホームページ、署名を保存することができます。</span><span class="sxs-lookup"><span data-stu-id="da843-128">In addition to storing guestbook comments, let's allow each user to store his home town, homepage, and signature.</span></span> <span data-ttu-id="da843-129">指定した場合、ユーザーのホーム、ホームページ、署名は、ゲストブックに残されている各メッセージに表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-129">If provided, the user's home town, homepage, and signature will appear on each message he has left in the guestbook.</span></span>

### <a name="adding-theguestbookcommentstable"></a><span data-ttu-id="da843-130">`GuestbookComments`テーブルの追加</span><span class="sxs-lookup"><span data-stu-id="da843-130">Adding the`GuestbookComments`Table</span></span>

<span data-ttu-id="da843-131">ゲストブックのコメントを取得するには、`CommentId`、`Subject`、`Body`、`CommentDate`などの列を含む `GuestbookComments` という名前のデータベーステーブルを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-131">In order to capture the guestbook comments, we need to create a database table named `GuestbookComments` that has columns like `CommentId`, `Subject`, `Body`, and `CommentDate`.</span></span> <span data-ttu-id="da843-132">また、`GuestbookComments` テーブル内の各レコードが、コメントを残したユーザーを参照している必要もあります。</span><span class="sxs-lookup"><span data-stu-id="da843-132">We also need to have each record in the `GuestbookComments` table reference the user who left the comment.</span></span>

<span data-ttu-id="da843-133">このテーブルをデータベースに追加するには、Visual Studio のデータベースエクスプローラーに移動し、`SecurityTutorials` データベースにドリルダウンします。</span><span class="sxs-lookup"><span data-stu-id="da843-133">To add this table to our database, go to the Database Explorer in Visual Studio and drill down into the `SecurityTutorials` database.</span></span> <span data-ttu-id="da843-134">[テーブル] フォルダーを右クリックし、[新しいテーブルの追加] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-134">Right-click on the Tables folder and choose Add New Table.</span></span> <span data-ttu-id="da843-135">これにより、新しいテーブルの列を定義できるインターフェイスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-135">This brings up an interface that allows us to define the columns for the new table.</span></span>

<span data-ttu-id="da843-136">[SecurityTutorials データベースに新しいテーブルを追加 ![には](storing-additional-user-information-cs/_static/image2.png)](storing-additional-user-information-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="da843-136">[![Add a New Table to the SecurityTutorials Database](storing-additional-user-information-cs/_static/image2.png)](storing-additional-user-information-cs/_static/image1.png)</span></span>

<span data-ttu-id="da843-137">**図 1**: `SecurityTutorials` データベースに新しいテーブルを追加する ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image3.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-137">**Figure 1**: Add a New Table to the `SecurityTutorials` Database  ([Click to view full-size image](storing-additional-user-information-cs/_static/image3.png))</span></span>

<span data-ttu-id="da843-138">次に、`GuestbookComments`の列を定義します。</span><span class="sxs-lookup"><span data-stu-id="da843-138">Next, define the `GuestbookComments`'s columns.</span></span> <span data-ttu-id="da843-139">まず、`uniqueidentifier`型の `CommentId` という名前の列を追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-139">Start by adding a column named `CommentId` of type `uniqueidentifier`.</span></span> <span data-ttu-id="da843-140">この列は、ゲストブック内の各コメントを一意に識別するため、`NULL` を禁止し、テーブルの主キーとしてマークします。</span><span class="sxs-lookup"><span data-stu-id="da843-140">This column will uniquely identify each comment in the guestbook, so disallow `NULL` s and mark it as the table's primary key.</span></span> <span data-ttu-id="da843-141">各 `INSERT`の [`CommentId`] フィールドに値を指定するのではなく、列の既定値を `NEWID()`に設定することによって、`INSERT` 上のこのフィールドに対して新しい `uniqueidentifier` 値を自動的に生成するように指定できます。</span><span class="sxs-lookup"><span data-stu-id="da843-141">Rather than providing a value for the `CommentId` field on each `INSERT`, we can indicate that a new `uniqueidentifier` value should be automatically generated for this field on `INSERT` by setting the column's default value to `NEWID()`.</span></span> <span data-ttu-id="da843-142">この最初のフィールドを追加して主キーとしてマークし、既定値を設定すると、画面は図2に示すスクリーンショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-142">After adding this first field, marking it as the primary key, and settings its default value, your screen should look similar to the screen shot shown in Figure 2.</span></span>

<span data-ttu-id="da843-143">[CommentId という名前のプライマリ列を追加 ![には](storing-additional-user-information-cs/_static/image5.png)](storing-additional-user-information-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="da843-143">[![Add a Primary Column Named CommentId](storing-additional-user-information-cs/_static/image5.png)](storing-additional-user-information-cs/_static/image4.png)</span></span>

<span data-ttu-id="da843-144">**図 2**: `CommentId` という名前のプライマリ列を追加[する (クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image6.png)される)</span><span class="sxs-lookup"><span data-stu-id="da843-144">**Figure 2**: Add a Primary Column Named `CommentId` ([Click to view full-size image](storing-additional-user-information-cs/_static/image6.png))</span></span>

<span data-ttu-id="da843-145">次に、`nvarchar(50)` 型の `Subject` という名前の列と `nvarchar(MAX)`型の `Body` という名前の列を追加し、両方の列で `NULL` s を禁止します。</span><span class="sxs-lookup"><span data-stu-id="da843-145">Next, add a column named `Subject` of type `nvarchar(50)` and a column named `Body` of type `nvarchar(MAX)`, disallowing `NULL` s in both columns.</span></span> <span data-ttu-id="da843-146">その後、`datetime`型の `CommentDate` という名前の列を追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-146">Following that, add a column named `CommentDate` of type `datetime`.</span></span> <span data-ttu-id="da843-147">`NULL` s を禁止し、`CommentDate` 列の既定値を `getdate()`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-147">Disallow `NULL` s and set the `CommentDate` column's default value to `getdate()`.</span></span>

<span data-ttu-id="da843-148">残っているのは、各ゲストブックコメントにユーザーアカウントを関連付ける列を追加することだけです。</span><span class="sxs-lookup"><span data-stu-id="da843-148">All that remains is to add a column that associates a user account with each guestbook comment.</span></span> <span data-ttu-id="da843-149">1つの方法として、`nvarchar(256)`型の `UserName` という名前の列を追加する方法があります。</span><span class="sxs-lookup"><span data-stu-id="da843-149">One option would be to add a column named `UserName` of type `nvarchar(256)`.</span></span> <span data-ttu-id="da843-150">このオプションは、`SqlMembershipProvider`以外のメンバーシッププロバイダーを使用する場合に適しています。</span><span class="sxs-lookup"><span data-stu-id="da843-150">This is a suitable choice when using a Membership provider other than the `SqlMembershipProvider`.</span></span> <span data-ttu-id="da843-151">ただし、このチュートリアルシリーズで説明しているように、`SqlMembershipProvider`を使用する場合、`aspnet_Users` テーブルの `UserName` 列は一意であるとは限りません。</span><span class="sxs-lookup"><span data-stu-id="da843-151">But when using the `SqlMembershipProvider`, as we are in this tutorial series, the `UserName` column in the `aspnet_Users` table is not guaranteed to be unique.</span></span> <span data-ttu-id="da843-152">`aspnet_Users` テーブルの主キーが `UserId` であり、`uniqueidentifier`型です。</span><span class="sxs-lookup"><span data-stu-id="da843-152">The `aspnet_Users` table's primary key is `UserId` and is of type `uniqueidentifier`.</span></span> <span data-ttu-id="da843-153">したがって、`GuestbookComments` テーブルには `uniqueidentifier` 型の `UserId` という名前の列が必要です (`NULL` 値は禁止されています)。</span><span class="sxs-lookup"><span data-stu-id="da843-153">Therefore, the `GuestbookComments` table needs a column named `UserId` of type `uniqueidentifier` (disallowing `NULL` values).</span></span> <span data-ttu-id="da843-154">この列を追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-154">Go ahead and add this column.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-155">SQL Server チュートリアルの[*メンバーシップスキーマの作成*](creating-the-membership-schema-in-sql-server-cs.md)に関するチュートリアルで説明したように、メンバーシップフレームワークは、異なるユーザーアカウントを持つ複数の web アプリケーションで同じユーザーストアを共有できるように設計されています。</span><span class="sxs-lookup"><span data-stu-id="da843-155">As we discussed in the [*Creating the Membership Schema in SQL Server*](creating-the-membership-schema-in-sql-server-cs.md) tutorial, the Membership framework is designed to enable multiple web applications with different user accounts to share the same user store.</span></span> <span data-ttu-id="da843-156">これは、ユーザーアカウントを別のアプリケーションに分割することによって行われます。</span><span class="sxs-lookup"><span data-stu-id="da843-156">It does this by partitioning user accounts into different applications.</span></span> <span data-ttu-id="da843-157">また、各ユーザー名はアプリケーション内で一意であることが保証されていますが、同じユーザーストアを使用する異なるアプリケーションで同じユーザー名を使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="da843-157">And while each username is guaranteed to be unique within an application, the same username may be used in different applications using the same user store.</span></span> <span data-ttu-id="da843-158">`UserName` フィールドと `ApplicationId` フィールドの `aspnet_Users` テーブルには複合 `UNIQUE` 制約がありますが、`UserName` フィールドだけではありません。</span><span class="sxs-lookup"><span data-stu-id="da843-158">There is a composite `UNIQUE` constraint in the `aspnet_Users` table on the `UserName` and `ApplicationId` fields, but not one on just the `UserName` field.</span></span> <span data-ttu-id="da843-159">このため、aspnet\_Users テーブルには、同じ `UserName` 値を持つ2つ (以上) のレコードを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="da843-159">Consequently, it is possible for the aspnet\_Users table to have two (or more) records with the same `UserName` value.</span></span> <span data-ttu-id="da843-160">ただし、`aspnet_Users` テーブルの `UserId` フィールドには `UNIQUE` 制約があります (これは主キーであるため)。</span><span class="sxs-lookup"><span data-stu-id="da843-160">There is, however, a `UNIQUE` constraint on the `aspnet_Users` table's `UserId` field (since it is the primary key).</span></span> <span data-ttu-id="da843-161">`UNIQUE` 制約は、`GuestbookComments` テーブルと `aspnet_Users` テーブルの間に外部キー制約を設定できないため、重要です。</span><span class="sxs-lookup"><span data-stu-id="da843-161">A `UNIQUE` constraint is important because without it we cannot establish a foreign key constraint between the `GuestbookComments` and `aspnet_Users` tables.</span></span>

<span data-ttu-id="da843-162">`UserId` 列を追加したら、ツールバーの [保存] アイコンをクリックしてテーブルを保存します。</span><span class="sxs-lookup"><span data-stu-id="da843-162">After adding the `UserId` column, save the table by clicking on the Save icon in the Toolbar.</span></span> <span data-ttu-id="da843-163">新しいテーブルに `GuestbookComments`という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="da843-163">Name the new table `GuestbookComments`.</span></span>

<span data-ttu-id="da843-164">`GuestbookComments` テーブルを使用して1つの最後の問題が発生しました。 `GuestbookComments.UserId` 列と `aspnet_Users.UserId` 列の間に[外部キー制約](https://msdn.microsoft.com/library/ms175464.aspx)を作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-164">We have one last issue to attend to with the `GuestbookComments` table: we need to create a [foreign key constraint](https://msdn.microsoft.com/library/ms175464.aspx) between the `GuestbookComments.UserId` column and the `aspnet_Users.UserId` column.</span></span> <span data-ttu-id="da843-165">これを実現するには、ツールバーの [リレーションシップ] アイコンをクリックして、[外部キーのリレーションシップ] ダイアログボックスを開きます。</span><span class="sxs-lookup"><span data-stu-id="da843-165">To achieve this, click the Relationship icon in the Toolbar to launch the Foreign Key Relationships dialog box.</span></span> <span data-ttu-id="da843-166">(または、[テーブルデザイナー] メニューの [リレーションシップ] をクリックして、このダイアログボックスを起動することもできます)。</span><span class="sxs-lookup"><span data-stu-id="da843-166">(Alternatively, you can launch this dialog box by going to the Table Designer menu and choosing Relationships.)</span></span>

<span data-ttu-id="da843-167">[外部キーのリレーションシップ] ダイアログボックスの左下隅にある [追加] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-167">Click the Add button in the lower left corner of the Foreign Key Relationships dialog box.</span></span> <span data-ttu-id="da843-168">これにより、新しい外部キー制約が追加されます。ただし、リレーションシップに参加するテーブルを定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-168">This will add a new foreign key constraint, although we still need to define the tables that participate in the relationship.</span></span>

<span data-ttu-id="da843-169">[[外部キーのリレーションシップ] ダイアログボックスを使用してテーブルの Foreign Key 制約を管理 ![には](storing-additional-user-information-cs/_static/image8.png)](storing-additional-user-information-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="da843-169">[![Use the Foreign Key Relationships Dialog Box to Manage a Table's Foreign Key Constraints](storing-additional-user-information-cs/_static/image8.png)](storing-additional-user-information-cs/_static/image7.png)</span></span>

<span data-ttu-id="da843-170">**図 3**: [外部キーのリレーションシップ] ダイアログボックスを使用してテーブルの外部キー制約を管理する ([クリックしてフルサイズの画像を表示する](storing-additional-user-information-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="da843-170">**Figure 3**: Use the Foreign Key Relationships Dialog Box to Manage a Table's Foreign Key Constraints  ([Click to view full-size image](storing-additional-user-information-cs/_static/image9.png))</span></span>

<span data-ttu-id="da843-171">次に、右側の [テーブルと列の指定] 行にある省略記号アイコンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-171">Next, click the ellipses icon in the "Table and Columns Specifications" row on the right.</span></span> <span data-ttu-id="da843-172">[テーブルと列] ダイアログボックスが表示されます。ここでは、主キーテーブルと列、および `GuestbookComments` テーブルの外部キー列を指定できます。</span><span class="sxs-lookup"><span data-stu-id="da843-172">This will launch the Tables and Columns dialog box, from which we can specify the primary key table and column and the foreign key column from the `GuestbookComments` table.</span></span> <span data-ttu-id="da843-173">特に、[`aspnet_Users`] を選択し、主キーのテーブルと列として `UserId` を選択し、`GuestbookComments` テーブルから外部キー列として `UserId` します (図4を参照)。</span><span class="sxs-lookup"><span data-stu-id="da843-173">In particular, select `aspnet_Users` and `UserId` as the primary key table and column, and `UserId` from the `GuestbookComments` table as the foreign key column (see Figure 4).</span></span> <span data-ttu-id="da843-174">主キーと外部キーのテーブルおよび列を定義したら、[OK] をクリックして [外部キーのリレーションシップ] ダイアログボックスに戻ります。</span><span class="sxs-lookup"><span data-stu-id="da843-174">After defining the primary and foreign key tables and columns, click OK to return to the Foreign Key Relationships dialog box.</span></span>

<span data-ttu-id="da843-175">[aspnet_Users テーブルと GuesbookComments テーブルの間に外部キー制約を確立 ![には](storing-additional-user-information-cs/_static/image11.png)](storing-additional-user-information-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="da843-175">[![Establish a Foreign Key Constraint Between the aspnet_Users and GuesbookComments Tables](storing-additional-user-information-cs/_static/image11.png)](storing-additional-user-information-cs/_static/image10.png)</span></span>

<span data-ttu-id="da843-176">**図 4**: `aspnet_Users` テーブルと `GuesbookComments` テーブルの間に外部キー制約を設定[する (クリックしてフルサイズの画像を表示する](storing-additional-user-information-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="da843-176">**Figure 4**: Establish a Foreign Key Constraint Between the `aspnet_Users` and `GuesbookComments` Tables  ([Click to view full-size image](storing-additional-user-information-cs/_static/image12.png))</span></span>

<span data-ttu-id="da843-177">この時点で、外部キー制約が確立されています。</span><span class="sxs-lookup"><span data-stu-id="da843-177">At this point the foreign key constraint has been established.</span></span> <span data-ttu-id="da843-178">この制約が存在することで、存在しないユーザーアカウントを参照するゲストブックエントリがないことを保証することで、2つのテーブル間の[リレーショナル整合性](http://en.wikipedia.org/wiki/Referential_integrity)が保証されます。</span><span class="sxs-lookup"><span data-stu-id="da843-178">The presence of this constraint ensures [relational integrity](http://en.wikipedia.org/wiki/Referential_integrity) between the two tables by guaranteeing that there will never be a guestbook entry referring to a non-existent user account.</span></span> <span data-ttu-id="da843-179">既定では、対応する子レコードがある場合、外部キー制約によって親レコードが削除されることは許可されません。</span><span class="sxs-lookup"><span data-stu-id="da843-179">By default, a foreign key constraint will disallow a parent record to be deleted if there are corresponding child records.</span></span> <span data-ttu-id="da843-180">つまり、ユーザーが1つ以上のゲストブックコメントを作成した後、そのユーザーアカウントを削除しようとすると、そのユーザーのゲストブックコメントが最初に削除されない限り、削除は失敗します。</span><span class="sxs-lookup"><span data-stu-id="da843-180">That is, if a user makes one or more guestbook comments, and then we attempt to delete that user account, the delete will fail unless his guestbook comments are deleted first.</span></span>

<span data-ttu-id="da843-181">親レコードが削除されたときに、関連付けられている子レコードを自動的に削除するように、Foreign key 制約を構成できます。</span><span class="sxs-lookup"><span data-stu-id="da843-181">Foreign key constraints can be configured to automatically delete the associated child records when a parent record is deleted.</span></span> <span data-ttu-id="da843-182">言い換えると、この外部キー制約を設定して、ユーザーのユーザーアカウントが削除されたときにユーザーのゲストブックエントリが自動的に削除されるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="da843-182">In other words, we can setup this foreign key constraint so that a user's guestbook entries are automatically deleted when her user account is deleted.</span></span> <span data-ttu-id="da843-183">これを行うには、[挿入と更新の指定] セクションを展開し、[ルールの削除] プロパティを Cascade に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-183">To accomplish this, expand the "INSERT And UPDATE Specification" section and set the "Delete Rule" property to Cascade.</span></span>

<span data-ttu-id="da843-184">[外部キー制約を連鎖削除に構成 ![には](storing-additional-user-information-cs/_static/image14.png)](storing-additional-user-information-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="da843-184">[![Configure the Foreign Key Constraint to Cascade Deletes](storing-additional-user-information-cs/_static/image14.png)](storing-additional-user-information-cs/_static/image13.png)</span></span>

<span data-ttu-id="da843-185">**図 5**: 外部キー制約を構成して削除を連鎖させる ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-185">**Figure 5**: Configure the Foreign Key Constraint to Cascade Deletes  ([Click to view full-size image](storing-additional-user-information-cs/_static/image15.png))</span></span>

<span data-ttu-id="da843-186">外部キーの制約を保存するには、[閉じる] ボタンをクリックして外部キーのリレーションシップを終了します。</span><span class="sxs-lookup"><span data-stu-id="da843-186">To save the foreign key constraint, click the Close button to exit out of the Foreign Key Relationships.</span></span> <span data-ttu-id="da843-187">次に、ツールバーの [保存] アイコンをクリックして、テーブルとこのリレーションシップを保存します。</span><span class="sxs-lookup"><span data-stu-id="da843-187">Then click the Save icon in the Toolbar to save the table and the this relationship.</span></span>

### <a name="storing-the-users-home-town-homepage-and-signature"></a><span data-ttu-id="da843-188">ユーザーの自宅、ホームページ、署名を保存する</span><span class="sxs-lookup"><span data-stu-id="da843-188">Storing the User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="da843-189">`GuestbookComments` の表は、ユーザーアカウントと一対多のリレーションシップを共有する情報を格納する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="da843-189">The `GuestbookComments` table illustrates how to store information that shares a one-to-many relationship with user accounts.</span></span> <span data-ttu-id="da843-190">各ユーザーアカウントには任意の数のコメントが関連付けられている可能性があるため、このリレーションシップは、各コメントを特定のユーザーにリンクする列を含む一連のコメントを保持するテーブルを作成することによってモデル化されます。</span><span class="sxs-lookup"><span data-stu-id="da843-190">Since each user account may have an arbitrary number of associated comments, this relationship is modeled by creating a table to hold the set of comments that includes a column that links back each comment to a particular user.</span></span> <span data-ttu-id="da843-191">`SqlMembershipProvider`を使用する場合は、`uniqueidentifier` 型の `UserId` という名前の列と、この列と `aspnet_Users.UserId`の間の foreign key 制約を作成することによって、このリンクを作成することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="da843-191">When using the `SqlMembershipProvider`, this link is best established by creating a column named `UserId` of type `uniqueidentifier` and a foreign key constraint between this column and `aspnet_Users.UserId`.</span></span>

<span data-ttu-id="da843-192">ここで、3つの列を各ユーザーアカウントに関連付けて、ユーザーのホーム、ホームページ、署名を保存する必要があります。これは、ゲストブックのコメントに表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-192">We now need to associate three columns with each user account to store the user's home town, homepage, and signature, which will appear in his guestbook comments.</span></span> <span data-ttu-id="da843-193">これを実現するには、さまざまな方法があります。</span><span class="sxs-lookup"><span data-stu-id="da843-193">There are number of different ways to accomplish this:</span></span>

- <span data-ttu-id="da843-194"><strong>`aspnet_Users`テーブル</strong><strong>または</strong><strong>`aspnet_Membership`</strong>テーブル<strong>に新しい列を追加</strong>し<strong>ます。</strong></span><span class="sxs-lookup"><span data-stu-id="da843-194"><strong>Add new columns to the</strong><strong>`aspnet_Users`</strong><strong>or</strong><strong>`aspnet_Membership`</strong><strong>tables.</strong></span></span> <span data-ttu-id="da843-195">`SqlMembershipProvider`によって使用されるスキーマを変更するため、この方法はお勧めしません。</span><span class="sxs-lookup"><span data-stu-id="da843-195">I would not recommend this approach because it modifies the schema used by the `SqlMembershipProvider`.</span></span> <span data-ttu-id="da843-196">この決定は、ましょうに戻ってくる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="da843-196">This decision may come back to haunt you down the road.</span></span> <span data-ttu-id="da843-197">たとえば、ASP.NET の将来のバージョンで別の `SqlMembershipProvider` スキーマを使用している場合はどうなるでしょうか。</span><span class="sxs-lookup"><span data-stu-id="da843-197">For example, what if a future version of ASP.NET uses a different `SqlMembershipProvider` schema.</span></span> <span data-ttu-id="da843-198">Microsoft には、ASP.NET 2.0 `SqlMembershipProvider` データを新しいスキーマに移行するためのツールが含まれている場合がありますが、ASP.NET 2.0 `SqlMembershipProvider` スキーマを変更した場合は、変換できないことがあります。</span><span class="sxs-lookup"><span data-stu-id="da843-198">Microsoft may include a tool to migrate the ASP.NET 2.0 `SqlMembershipProvider` data to the new schema, but if you have modified the ASP.NET 2.0 `SqlMembershipProvider` schema, such a conversion may not be possible.</span></span>

- <span data-ttu-id="da843-199">**ASP を使用します。ホーム、ホームページ、署名のプロファイルプロパティを定義する NET の Profile framework。**</span><span class="sxs-lookup"><span data-stu-id="da843-199">**Use ASP.NET's Profile framework, defining a profile property for the home town, homepage, and signature.**</span></span> <span data-ttu-id="da843-200">ASP.NET には、追加のユーザー固有データを格納するように設計されたプロファイルフレームワークが含まれています。</span><span class="sxs-lookup"><span data-stu-id="da843-200">ASP.NET includes a Profile framework that is designed to store additional user-specific data.</span></span> <span data-ttu-id="da843-201">メンバーシップフレームワークと同様に、プロファイルフレームワークはプロバイダーモデルの上に構築されます。</span><span class="sxs-lookup"><span data-stu-id="da843-201">Like the Membership framework, the Profile framework is built atop the provider model.</span></span> <span data-ttu-id="da843-202">.NET Framework には、SQL Server データベースにプロファイルデータを格納する `SqlProfileProvider` が付属しています。</span><span class="sxs-lookup"><span data-stu-id="da843-202">The .NET Framework ships with a `SqlProfileProvider` sthat stores profile data in a SQL Server database.</span></span> <span data-ttu-id="da843-203">実際、データベースには、`SqlProfileProvider` (`aspnet_Profile`) によって使用されているテーブルが既に存在しています。これは<a id="_msoanchor_2"> </a>、 [*SQL Server チュートリアルでメンバーシップスキーマを作成*](creating-the-membership-schema-in-sql-server-cs.md)するときにアプリケーションサービスを追加したときに追加されたためです。</span><span class="sxs-lookup"><span data-stu-id="da843-203">In fact, our database already has the table used by the `SqlProfileProvider` (`aspnet_Profile`), as it was added when we added the application services back in the <a id="_msoanchor_2"></a>[*Creating the Membership Schema in SQL Server*](creating-the-membership-schema-in-sql-server-cs.md) tutorial.</span></span>   
  <span data-ttu-id="da843-204">プロファイルフレームワークの主な利点は、開発者が `Web.config` のプロファイルプロパティを定義できることです。これにより、基になるデータストアとの間でプロファイルデータをシリアル化するためにコードを記述する必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="da843-204">The main benefit of the Profile framework is that it allows for developers to define the profile properties in `Web.config` – no code needs to be written to serialize the profile data to and from the underlying data store.</span></span> <span data-ttu-id="da843-205">簡単に言えば、一連のプロファイルプロパティを定義し、コードで使用することは非常に簡単です。</span><span class="sxs-lookup"><span data-stu-id="da843-205">In short, it is incredibly easy to define a set of profile properties and to work with them in code.</span></span> <span data-ttu-id="da843-206">ただし、バージョン管理に関しては、プロファイルシステムが必要になることはほとんどありません。そのため、新しいユーザー固有のプロパティを後で追加したり、既存のプロパティを削除または変更したりする必要があるアプリケーションがある場合、プロファイルフレームワークは次のようにならない可能性があります。 最適なオプション。</span><span class="sxs-lookup"><span data-stu-id="da843-206">However, the Profile system leaves a lot to be desired when it comes to versioning, so if you have an application where you expect new user-specific properties to be added at a later time, or existing ones to be removed or modified, then the Profile framework may not be the best option.</span></span> <span data-ttu-id="da843-207">さらに、`SqlProfileProvider` は、プロファイルのプロパティを非常に非正規化された形式で保存し、プロファイルデータに対して直接クエリを実行することができないようにします (たとえば、ニューヨークの自宅の町を持つユーザーの数)。</span><span class="sxs-lookup"><span data-stu-id="da843-207">Moreover, the `SqlProfileProvider` stores the profile properties in a highly denormalized fashion, making it next to impossible to run queries directly against the profile data (such as, how many users have a home town of New York).</span></span>   
  <span data-ttu-id="da843-208">プロファイルフレームワークの詳細については、このチュートリアルの最後にある「参考資料」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-208">For more information on the Profile framework, consult the "Further Readings" section at the end of this tutorial.</span></span>

- <span data-ttu-id="da843-209"><strong>この3つの列をデータベースの新しいテーブルに追加し、このテーブルと`aspnet_Users`の間に一対一のリレーションシップを確立し</strong><strong>ます。</strong></span><span class="sxs-lookup"><span data-stu-id="da843-209"><strong>Add these three columns to a new table in the database and establish a one-to-one relationship between this table and</strong><strong>`aspnet_Users`</strong><strong>.</strong></span></span> <span data-ttu-id="da843-210">この方法では、プロファイルフレームワークよりも少し作業が必要になりますが、データベース内で追加のユーザープロパティがどのようにモデル化されるかについて、最大限の柔軟性が提供されます。</span><span class="sxs-lookup"><span data-stu-id="da843-210">This approach involves a bit more work than with the Profile framework, but offers maximum flexibility in how the additional user properties are modeled in the database.</span></span> <span data-ttu-id="da843-211">これは、このチュートリアルで使用するオプションです。</span><span class="sxs-lookup"><span data-stu-id="da843-211">This is the option we will use in this tutorial.</span></span>

<span data-ttu-id="da843-212">ここでは、`UserProfiles` という名前の新しいテーブルを作成し、各ユーザーのホームの町、ホームページ、および署名を保存します。</span><span class="sxs-lookup"><span data-stu-id="da843-212">We will create a new table called `UserProfiles` to save the home town, homepage, and signature for each user.</span></span> <span data-ttu-id="da843-213">データベースエクスプローラーウィンドウで [テーブル] フォルダーを右クリックし、[新しいテーブルの作成] を選択します。</span><span class="sxs-lookup"><span data-stu-id="da843-213">Right-click on the Tables folder in the Database Explorer window and choose to create a new table.</span></span> <span data-ttu-id="da843-214">最初の列に `UserId` 名前を指定し、その型を `uniqueidentifier`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-214">Name the first column `UserId` and set its type to `uniqueidentifier`.</span></span> <span data-ttu-id="da843-215">`NULL` 値を許可せずに、列を主キーとしてマークします。</span><span class="sxs-lookup"><span data-stu-id="da843-215">Disallow `NULL` values and mark the column as a primary key.</span></span> <span data-ttu-id="da843-216">次に、`nvarchar(50)`型の `HomeTown` という名前の列を追加します。`nvarchar(100)`型の `HomepageUrl``nvarchar(500)`型のシグネチャ。</span><span class="sxs-lookup"><span data-stu-id="da843-216">Next, add columns named: `HomeTown` of type `nvarchar(50)`; `HomepageUrl` of type `nvarchar(100)`; and Signature of type `nvarchar(500)`.</span></span> <span data-ttu-id="da843-217">これら3つの列はそれぞれ `NULL` 値を受け取ることができます。</span><span class="sxs-lookup"><span data-stu-id="da843-217">Each of these three columns can accept a `NULL` value.</span></span>

<span data-ttu-id="da843-218">[UserProfiles テーブルを作成 ![には](storing-additional-user-information-cs/_static/image17.png)](storing-additional-user-information-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="da843-218">[![Create the UserProfiles Table](storing-additional-user-information-cs/_static/image17.png)](storing-additional-user-information-cs/_static/image16.png)</span></span>

<span data-ttu-id="da843-219">**図 6**: `UserProfiles` テーブルを作成[する (クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-219">**Figure 6**: Create the `UserProfiles` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image18.png))</span></span>

<span data-ttu-id="da843-220">テーブルを保存し、`UserProfiles`という名前を付けます。</span><span class="sxs-lookup"><span data-stu-id="da843-220">Save the table and name it `UserProfiles`.</span></span> <span data-ttu-id="da843-221">最後に、`UserProfiles` テーブルの `UserId` フィールドと `aspnet_Users.UserId` フィールドの間に外部キー制約を設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-221">Lastly, establish a foreign key constraint between the `UserProfiles` table's `UserId` field and the `aspnet_Users.UserId` field.</span></span> <span data-ttu-id="da843-222">`GuestbookComments` テーブルと `aspnet_Users` テーブルの間の foreign key 制約を使用したのと同様に、この制約を連鎖削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-222">As we did with the foreign key constraint between the `GuestbookComments` and `aspnet_Users` tables, have this constraint cascade deletes.</span></span> <span data-ttu-id="da843-223">`UserProfiles` の `UserId` フィールドは主キーであるため、ユーザーアカウントごとに `UserProfiles` テーブルにレコードが1つだけ存在することになります。</span><span class="sxs-lookup"><span data-stu-id="da843-223">Since the `UserId` field in `UserProfiles` is the primary key, this ensures that there will be no more than one record in the `UserProfiles` table for each user account.</span></span> <span data-ttu-id="da843-224">この種類のリレーションシップは、一対一と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="da843-224">This type of relationship is referred to as one-to-one.</span></span>

<span data-ttu-id="da843-225">データモデルを作成したので、これを使用する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="da843-225">Now that we have the data model created, we are ready to use it.</span></span> <span data-ttu-id="da843-226">手順2と3では、現在ログオンしているユーザーが自宅の町、ホームページ、および署名情報を表示および編集する方法を確認します。</span><span class="sxs-lookup"><span data-stu-id="da843-226">In Steps 2 and 3 we will look at how the currently logged on user can view and edit their home town, homepage, and signature information.</span></span> <span data-ttu-id="da843-227">手順 4. では、認証されたユーザーが新しいコメントをゲストブックに送信し、既存のものを表示するためのインターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-227">In Step 4 we will create the interface for authenticated users to submit new comments to the guestbook and view the existing ones.</span></span>

## <a name="step-2-displaying-the-users-home-town-homepage-and-signature"></a><span data-ttu-id="da843-228">手順 2: ユーザーの自宅、ホームページ、および署名を表示する</span><span class="sxs-lookup"><span data-stu-id="da843-228">Step 2: Displaying the User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="da843-229">現在ログオンしているユーザーが自宅の町、ホームページ、および署名情報を表示および編集できるようにするには、さまざまな方法があります。</span><span class="sxs-lookup"><span data-stu-id="da843-229">There are a variety of ways to allow the currently logged on user to view and edit his home town, homepage, and signature information.</span></span> <span data-ttu-id="da843-230">TextBox コントロールや Label コントロールを使用してユーザーインターフェイスを手動で作成することも、DetailsView コントロールなどのデータ Web コントロールのいずれかを使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="da843-230">We could manually create the user interface with TextBox and Label controls or we could use one of the data Web controls, such as the DetailsView control.</span></span> <span data-ttu-id="da843-231">データベース `SELECT` と `UPDATE` ステートメントを実行するには、ページの分離コードクラスに ADO.NET コードを記述するか、または SqlDataSource で宣言型のアプローチを使用します。</span><span class="sxs-lookup"><span data-stu-id="da843-231">To perform the database `SELECT` and `UPDATE` statements we could write ADO.NET code in our page's code-behind class or, alternatively, employ a declarative approach with the SqlDataSource.</span></span> <span data-ttu-id="da843-232">アプリケーションでは、階層型アーキテクチャを使用するのが理想的です。これは、ページの分離コードクラスからプログラムで呼び出すことも、ObjectDataSource コントロールを使用して宣言することもできます。</span><span class="sxs-lookup"><span data-stu-id="da843-232">Ideally our application would contain a tiered architecture, which we could either invoke programmatically from the page's code-behind class or declaratively via the ObjectDataSource control.</span></span>

<span data-ttu-id="da843-233">このチュートリアルシリーズではフォーム認証、承認、ユーザーアカウント、およびロールに焦点を当てているため、これらのさまざまなデータアクセスオプションの詳細については説明しません。また、SQL ステートメントを直接実行するよりも、階層型アーキテクチャが推奨される理由については説明しません。[ASP.NET] ページから開始します。</span><span class="sxs-lookup"><span data-stu-id="da843-233">Since this tutorial series focuses on forms authentication, authorization, user accounts, and roles, there will not be a thorough discussion of these different data access options or why a tiered architecture is preferred over executing SQL statements directly from the ASP.NET page.</span></span> <span data-ttu-id="da843-234">ここでは、DetailsView と SqlDataSource の使用方法を順を追って説明します。最も迅速で簡単なオプションですが、ここで説明する概念は、他の Web コントロールやデータアクセスロジックにも確実に適用できます。</span><span class="sxs-lookup"><span data-stu-id="da843-234">I am going to walk through using a DetailsView and SqlDataSource – the quickest and easiest option – but the concepts discussed can certainly be applied to alternative Web controls and data access logic.</span></span> <span data-ttu-id="da843-235">ASP.NET でのデータの操作の詳細については、 *[ASP.NET 2.0 チュートリアルシリーズのデータの操作](../../data-access/index.md)* に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-235">For more information on working with data in ASP.NET, refer to my *[Working with Data in ASP.NET 2.0](../../data-access/index.md)* tutorial series.</span></span>

<span data-ttu-id="da843-236">`Membership` フォルダーの [`AdditionalUserInfo.aspx`] ページを開き、[DetailsView] コントロールをページに追加します。その `ID` プロパティを `UserProfile` に設定し、その `Width` と `Height` のプロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="da843-236">Open the `AdditionalUserInfo.aspx` page in the `Membership` folder and add a DetailsView control to the page, setting its `ID` property to `UserProfile` and clearing out its `Width` and `Height` properties.</span></span> <span data-ttu-id="da843-237">DetailsView のスマートタグを展開し、新しいデータソースコントロールにバインドすることを選択します。</span><span class="sxs-lookup"><span data-stu-id="da843-237">Expand the DetailsView's Smart Tag and choose to bind it to a new data source control.</span></span> <span data-ttu-id="da843-238">これにより、データソース構成ウィザードが起動します (図7を参照)。</span><span class="sxs-lookup"><span data-stu-id="da843-238">This will launch the DataSource Configuration Wizard (see Figure 7).</span></span> <span data-ttu-id="da843-239">最初の手順では、データソースの種類を指定するように求められます。</span><span class="sxs-lookup"><span data-stu-id="da843-239">The first step asks you to specify the data source type.</span></span> <span data-ttu-id="da843-240">`SecurityTutorials` データベースに直接接続するため、[データベース] アイコンを選択し、`ID` を `UserProfileDataSource`として指定します。</span><span class="sxs-lookup"><span data-stu-id="da843-240">Since we are going to connect directly to the `SecurityTutorials` database, choose the Database icon, specifying the `ID` as `UserProfileDataSource`.</span></span>

<span data-ttu-id="da843-241">[UserProfileDataSource という名前の新しい SqlDataSource コントロールを追加 ![には](storing-additional-user-information-cs/_static/image20.png)](storing-additional-user-information-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="da843-241">[![Add a New SqlDataSource Control Named UserProfileDataSource](storing-additional-user-information-cs/_static/image20.png)](storing-additional-user-information-cs/_static/image19.png)</span></span>

<span data-ttu-id="da843-242">**図 7**: `UserProfileDataSource` という名前の新しい SqlDataSource コントロールを追加[する (クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image21.png)される)</span><span class="sxs-lookup"><span data-stu-id="da843-242">**Figure 7**: Add a New SqlDataSource Control Named `UserProfileDataSource` ([Click to view full-size image](storing-additional-user-information-cs/_static/image21.png))</span></span>

<span data-ttu-id="da843-243">次の画面では、使用するデータベースを入力するように求められます。</span><span class="sxs-lookup"><span data-stu-id="da843-243">The next screen prompts for the database to use.</span></span> <span data-ttu-id="da843-244">`SecurityTutorials` データベースの `Web.config` には、既に接続文字列が定義されています。</span><span class="sxs-lookup"><span data-stu-id="da843-244">We have already defined a connection string in `Web.config` for the `SecurityTutorials` database.</span></span> <span data-ttu-id="da843-245">この接続文字列名 (`SecurityTutorialsConnectionString`) は、ドロップダウンリストに表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-245">This connection string name – `SecurityTutorialsConnectionString` – should be in the drop-down list.</span></span> <span data-ttu-id="da843-246">このオプションを選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-246">Select this option and click Next.</span></span>

<span data-ttu-id="da843-247">[![ドロップダウンリストから [SecurityTutorialsConnectionString] を選択します。](storing-additional-user-information-cs/_static/image23.png)](storing-additional-user-information-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="da843-247">[![Choose SecurityTutorialsConnectionString from the Drop-Down List](storing-additional-user-information-cs/_static/image23.png)](storing-additional-user-information-cs/_static/image22.png)</span></span>

<span data-ttu-id="da843-248">**図 8**: ドロップダウンリストから `SecurityTutorialsConnectionString` を選択する ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image24.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-248">**Figure 8**: Choose `SecurityTutorialsConnectionString` from the Drop-Down List  ([Click to view full-size image](storing-additional-user-information-cs/_static/image24.png))</span></span>

<span data-ttu-id="da843-249">次の画面では、クエリを実行するテーブルと列を指定するように求められます。</span><span class="sxs-lookup"><span data-stu-id="da843-249">The subsequent screen asks us to specify the table and columns to query.</span></span> <span data-ttu-id="da843-250">ドロップダウンリストから `UserProfiles` テーブルを選択し、すべての列を確認します。</span><span class="sxs-lookup"><span data-stu-id="da843-250">Choose the `UserProfiles` table from the drop-down list and check all of the columns.</span></span>

<span data-ttu-id="da843-251">[UserProfiles テーブルからすべての列を戻す ![には](storing-additional-user-information-cs/_static/image26.png)](storing-additional-user-information-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="da843-251">[![Bring Back All of the Columns from the UserProfiles Table](storing-additional-user-information-cs/_static/image26.png)](storing-additional-user-information-cs/_static/image25.png)</span></span>

<span data-ttu-id="da843-252">**図 9**: `UserProfiles` テーブルのすべての列を元に戻す ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image27.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-252">**Figure 9**: Bring Back All of the Columns from the `UserProfiles` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image27.png))</span></span>

<span data-ttu-id="da843-253">図9の現在のクエリでは `UserProfiles`の*すべて*のレコードが返されますが、現在ログオンしているユーザーのレコードのみが対象となります。</span><span class="sxs-lookup"><span data-stu-id="da843-253">The current query in Figure 9 returns *all* of the records in `UserProfiles`, but we are only interested in the currently logged on user's record.</span></span> <span data-ttu-id="da843-254">`WHERE` 句を追加するには、[`WHERE`] ボタンをクリックして [`WHERE` 句の追加] ダイアログボックスを表示します (図10を参照)。</span><span class="sxs-lookup"><span data-stu-id="da843-254">To add a `WHERE` clause, click the `WHERE` button to bring up the Add `WHERE` Clause dialog box (see Figure 10).</span></span> <span data-ttu-id="da843-255">ここでは、フィルターを適用する列、演算子、およびフィルターパラメーターのソースを選択できます。</span><span class="sxs-lookup"><span data-stu-id="da843-255">Here you can select the column to filter on, the operator, and the source of the filter parameter.</span></span> <span data-ttu-id="da843-256">列として [`UserId`] を選択し、演算子として "=" を選択します。</span><span class="sxs-lookup"><span data-stu-id="da843-256">Select `UserId` as the column and "=" as the Operator.</span></span>

<span data-ttu-id="da843-257">残念ながら、現在ログオンしているユーザーの `UserId` 値を返す組み込みパラメーターソースはありません。</span><span class="sxs-lookup"><span data-stu-id="da843-257">Unfortunately there is no built-in parameter source to return the currently logged on user's `UserId` value.</span></span> <span data-ttu-id="da843-258">この値はプログラムによって取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-258">We will need to grab this value programmatically.</span></span> <span data-ttu-id="da843-259">そのため、[ソース] ドロップダウンリストを "なし" に設定し、[追加] ボタンをクリックしてパラメーターを追加し、[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-259">Therefore, set the Source drop-down list to "None," click the Add button to add the parameter, and then click OK.</span></span>

<span data-ttu-id="da843-260">[UserId 列にフィルターパラメーターを追加 ![には](storing-additional-user-information-cs/_static/image29.png)](storing-additional-user-information-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="da843-260">[![Add a Filter Parameter on the UserId Column](storing-additional-user-information-cs/_static/image29.png)](storing-additional-user-information-cs/_static/image28.png)</span></span>

<span data-ttu-id="da843-261">**図 10**: `UserId` 列にフィルターパラメーターを追加する ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image30.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-261">**Figure 10**: Add a Filter Parameter on the `UserId` Column  ([Click to view full-size image](storing-additional-user-information-cs/_static/image30.png))</span></span>

<span data-ttu-id="da843-262">[OK] をクリックすると、図9に示す画面に戻ります。</span><span class="sxs-lookup"><span data-stu-id="da843-262">After clicking OK you will be returned to the screen shown in Figure 9.</span></span> <span data-ttu-id="da843-263">ただし、この時点では、画面の下部にある SQL クエリには `WHERE` 句が含まれている必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-263">This time, however, the SQL query at the bottom of the screen should include a `WHERE` clause.</span></span> <span data-ttu-id="da843-264">[次へ] をクリックして、[クエリのテスト] 画面に移動します。</span><span class="sxs-lookup"><span data-stu-id="da843-264">Click Next to move on to the "Test Query" screen.</span></span> <span data-ttu-id="da843-265">ここでクエリを実行し、結果を確認できます。</span><span class="sxs-lookup"><span data-stu-id="da843-265">Here you can run the query and see the results.</span></span> <span data-ttu-id="da843-266">[完了] をクリックしてウィザードを終了します。</span><span class="sxs-lookup"><span data-stu-id="da843-266">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="da843-267">データソース構成ウィザードを完了すると、ウィザードで指定した設定に基づいて SqlDataSource コントロールが作成されます。</span><span class="sxs-lookup"><span data-stu-id="da843-267">Upon completing the DataSource Configuration Wizard, Visual Studio creates the SqlDataSource control based on the settings specified in the wizard.</span></span> <span data-ttu-id="da843-268">さらに、SqlDataSource の `SelectCommand`によって返される各列の DetailsView には、手動で BoundFields を追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-268">Moreover, it manually adds BoundFields to the DetailsView for each column returned by the SqlDataSource's `SelectCommand`.</span></span> <span data-ttu-id="da843-269">ユーザーがこの値を知る必要がないため、DetailsView に `UserId` フィールドを表示する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="da843-269">There's no need to show the `UserId` field in the DetailsView, since the user does not need to know this value.</span></span> <span data-ttu-id="da843-270">このフィールドを DetailsView コントロールの宣言型マークアップから直接削除することも、スマートタグから [フィールドの編集] リンクをクリックして削除することもできます。</span><span class="sxs-lookup"><span data-stu-id="da843-270">You can remove this field directly from the DetailsView control's declarative markup or by clicking the "Edit Fields" link from its Smart Tag.</span></span>

<span data-ttu-id="da843-271">この時点で、ページの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-271">At this point your page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample1.aspx)]

<span data-ttu-id="da843-272">データを選択する前に、SqlDataSource コントロールの `UserId` パラメーターを、現在ログインしているユーザーの `UserId` にプログラムで設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-272">We need to programmatically set the SqlDataSource control's `UserId` parameter to the currently logged in user's `UserId` before the data is selected.</span></span> <span data-ttu-id="da843-273">これは、SqlDataSource の `Selecting` イベントのイベントハンドラーを作成し、そこに次のコードを追加することで実現できます。</span><span class="sxs-lookup"><span data-stu-id="da843-273">This can be accomplished by creating an event handler for the SqlDataSource's `Selecting` event and adding the following code there:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample2.cs)]

<span data-ttu-id="da843-274">上記のコードは、`Membership` クラスの `GetUser` メソッドを呼び出すことによって、現在ログオンしているユーザーへの参照を取得することから始まります。</span><span class="sxs-lookup"><span data-stu-id="da843-274">The above code starts by obtaining a reference to the currently logged on user by calling the `Membership` class's `GetUser` method.</span></span> <span data-ttu-id="da843-275">これにより、`ProviderUserKey` プロパティに `UserId`が含まれている `MembershipUser` オブジェクトが返されます。</span><span class="sxs-lookup"><span data-stu-id="da843-275">This returns a `MembershipUser` object, whose `ProviderUserKey` property contains the `UserId`.</span></span> <span data-ttu-id="da843-276">`UserId` 値が SqlDataSource の `@UserId` パラメーターに割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="da843-276">The `UserId` value is then assigned to the SqlDataSource's `@UserId` parameter.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-277">`Membership.GetUser()` メソッドは、現在ログオンしているユーザーに関する情報を返します。</span><span class="sxs-lookup"><span data-stu-id="da843-277">The `Membership.GetUser()` method returns information about the currently logged on user.</span></span> <span data-ttu-id="da843-278">匿名ユーザーがページにアクセスしている場合は、`null`の値が返されます。</span><span class="sxs-lookup"><span data-stu-id="da843-278">If an anonymous user is visiting the page, it will return a value of `null`.</span></span> <span data-ttu-id="da843-279">このような場合、`ProviderUserKey` プロパティを読み取ろうとすると、次のコード行の `NullReferenceException` になります。</span><span class="sxs-lookup"><span data-stu-id="da843-279">In such a case, this will lead to a `NullReferenceException` on the following line of code when attempting to read the `ProviderUserKey` property.</span></span> <span data-ttu-id="da843-280">もちろん、`AdditionalUserInfo.aspx` ページで `null` 値を返す `Membership.GetUser()` について心配する必要はありません。これは、認証されたユーザーのみがこのフォルダー内の ASP.NET リソースにアクセスできるように、前のチュートリアルで URL 承認を構成したためです。</span><span class="sxs-lookup"><span data-stu-id="da843-280">Of course, we don't have to worry about `Membership.GetUser()` returning a `null` value in the `AdditionalUserInfo.aspx` page because we configured URL authorization in a previous tutorial so that only authenticated users could access the ASP.NET resources in this folder.</span></span> <span data-ttu-id="da843-281">匿名アクセスが許可されているページで現在ログオンしているユーザーに関する情報にアクセスする必要がある場合は、プロパティを参照する前に、`GetUser()` メソッドから非`null MembershipUser` オブジェクトが返されることを必ず確認してください。</span><span class="sxs-lookup"><span data-stu-id="da843-281">If you need to access information about the currently logged on user in a page where anonymous access is permitted, make sure to check that a non-`null MembershipUser` object is returned from the `GetUser()` method before referencing its properties.</span></span>

<span data-ttu-id="da843-282">ブラウザーで [`AdditionalUserInfo.aspx`] ページにアクセスすると、`UserProfiles` テーブルに行を追加していないため、空白のページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-282">If you visit the `AdditionalUserInfo.aspx` page through a browser you will see a blank page because we have yet to add any rows to the `UserProfiles` table.</span></span> <span data-ttu-id="da843-283">手順 6. では、CreateUserWizard コントロールをカスタマイズして、新しいユーザーアカウントが作成されたときに新しい行が `UserProfiles` テーブルに自動的に追加されるようにする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-283">In Step 6 we will look at how to customize the CreateUserWizard control to automatically add a new row to the `UserProfiles` table when a new user account is created.</span></span> <span data-ttu-id="da843-284">ただし、現時点では、テーブルにレコードを手動で作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-284">For now, however, we will need to manually create a record in the table.</span></span>

<span data-ttu-id="da843-285">Visual Studio で データベースエクスプローラーに移動し、テーブル フォルダーを展開します。</span><span class="sxs-lookup"><span data-stu-id="da843-285">Navigate to the Database Explorer in Visual Studio and expand the Tables folder.</span></span> <span data-ttu-id="da843-286">`aspnet_Users` テーブルを右クリックし、[テーブルデータの表示] を選択して、テーブル内のレコードを表示します。`UserProfiles` テーブルに対しても同じ処理を行います。</span><span class="sxs-lookup"><span data-stu-id="da843-286">Right-click on the `aspnet_Users` table and choose "Show Table Data" to see the records in the table; do the same thing for the `UserProfiles` table.</span></span> <span data-ttu-id="da843-287">図11は、上下に並べて表示される場合の結果を示しています。</span><span class="sxs-lookup"><span data-stu-id="da843-287">Figure 11 shows these results when tiled vertically.</span></span> <span data-ttu-id="da843-288">私のデータベースでは、現在は `aspnet_Users` のレコードがありますが、`UserProfiles` テーブルにはレコードがありません。</span><span class="sxs-lookup"><span data-stu-id="da843-288">In my database there are currently `aspnet_Users` records for Bruce, Fred, and Tito, but no records in the `UserProfiles` table.</span></span>

<span data-ttu-id="da843-289">[aspnet_Users および UserProfiles テーブルの内容が表示され ![](storing-additional-user-information-cs/_static/image32.png)](storing-additional-user-information-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="da843-289">[![The Contents of the aspnet_Users and UserProfiles Tables are Displayed](storing-additional-user-information-cs/_static/image32.png)](storing-additional-user-information-cs/_static/image31.png)</span></span>

<span data-ttu-id="da843-290">**図 11**: `aspnet_Users` テーブルと `UserProfiles` テーブルの内容が表示される ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image33.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-290">**Figure 11**: The Contents of the `aspnet_Users` and `UserProfiles` Tables are Displayed  ([Click to view full-size image](storing-additional-user-information-cs/_static/image33.png))</span></span>

<span data-ttu-id="da843-291">`HomeTown`、`HomepageUrl`、および `Signature` の各フィールドの値を手動で入力して、`UserProfiles` テーブルに新しいレコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-291">Add a new record to the `UserProfiles` table by manually typing in values for the `HomeTown`, `HomepageUrl`, and `Signature` fields.</span></span> <span data-ttu-id="da843-292">新しい `UserProfiles` レコードで有効な `UserId` 値を取得する最も簡単な方法は、`aspnet_Users` テーブルの特定のユーザーアカウントから `UserId` フィールドを選択し、`UserId` の `UserProfiles`フィールドにコピーして貼り付けることです。</span><span class="sxs-lookup"><span data-stu-id="da843-292">The easiest way to get a valid `UserId` value in the new `UserProfiles` record is to select the `UserId` field from a particular user account in the `aspnet_Users` table and copy and paste it into the `UserId` field in `UserProfiles`.</span></span> <span data-ttu-id="da843-293">図12は、新しいレコードが追加された後の `UserProfiles` テーブルを示しています。</span><span class="sxs-lookup"><span data-stu-id="da843-293">Figure 12 shows the `UserProfiles` table after a new record has been added for Bruce.</span></span>

<span data-ttu-id="da843-294">[ユーザープロファイルにレコードが追加された ![](storing-additional-user-information-cs/_static/image35.png)](storing-additional-user-information-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="da843-294">[![A Record was Added to UserProfiles for Bruce](storing-additional-user-information-cs/_static/image35.png)](storing-additional-user-information-cs/_static/image34.png)</span></span>

<span data-ttu-id="da843-295">**図 12**: `UserProfiles` にレコードが追加されました ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image36.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-295">**Figure 12**: A Record was Added to `UserProfiles` for Bruce  ([Click to view full-size image](storing-additional-user-information-cs/_static/image36.png))</span></span>

<span data-ttu-id="da843-296">[`AdditionalUserInfo.aspx`] ページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="da843-296">Return to the `AdditionalUserInfo.aspx` page, logged in as Bruce.</span></span> <span data-ttu-id="da843-297">図13に示すように、この設定が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-297">As Figure 13 shows, Bruce's settings are displayed.</span></span>

<span data-ttu-id="da843-298">[現在アクセスしているユーザーの設定が表示され ![](storing-additional-user-information-cs/_static/image38.png)](storing-additional-user-information-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="da843-298">[![The Currently Visiting User is Shown His Settings](storing-additional-user-information-cs/_static/image38.png)](storing-additional-user-information-cs/_static/image37.png)</span></span>

<span data-ttu-id="da843-299">**図 13**: 現在アクセスしているユーザーに設定が表示される ([クリックしてフルサイズの画像を表示する](storing-additional-user-information-cs/_static/image39.png))</span><span class="sxs-lookup"><span data-stu-id="da843-299">**Figure 13**: The Currently Visiting User is Shown His Settings  ([Click to view full-size image](storing-additional-user-information-cs/_static/image39.png))</span></span>

> [!NOTE]
> <span data-ttu-id="da843-300">ここで、メンバーシップユーザーごとに `UserProfiles` テーブルにレコードを手動で追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-300">Go ahead and manually add records in the `UserProfiles` table for each Membership user.</span></span> <span data-ttu-id="da843-301">手順 6. では、CreateUserWizard コントロールをカスタマイズして、新しいユーザーアカウントが作成されたときに新しい行が `UserProfiles` テーブルに自動的に追加されるようにする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-301">In Step 6 we will look at how to customize the CreateUserWizard control to automatically add a new row to the `UserProfiles` table when a new user account is created.</span></span>

## <a name="step-3-allowing-the-user-to-edit-his-home-town-homepage-and-signature"></a><span data-ttu-id="da843-302">手順 3: ユーザーが自分の自宅、ホームページ、および署名を編集できるようにする</span><span class="sxs-lookup"><span data-stu-id="da843-302">Step 3: Allowing the User to Edit His Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="da843-303">この時点で、現在ログインしているユーザーはホームの町、ホームページ、および署名の設定を表示できますが、まだ変更することはできません。</span><span class="sxs-lookup"><span data-stu-id="da843-303">At this point the currently logged in user can view their home town, homepage, and signature setting, but they cannot yet modify them.</span></span> <span data-ttu-id="da843-304">データを編集できるように DetailsView コントロールを更新してみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-304">Let's update the DetailsView control so that the data can be edited.</span></span>

<span data-ttu-id="da843-305">最初に行う必要があるのは、実行する `UPDATE` ステートメントとそれに対応するパラメーターを指定して、SqlDataSource の `UpdateCommand` を追加することです。</span><span class="sxs-lookup"><span data-stu-id="da843-305">The first thing we need to do is add an `UpdateCommand` for the SqlDataSource, specifying the `UPDATE` statement to execute and its corresponding parameters.</span></span> <span data-ttu-id="da843-306">SqlDataSource を選択し、プロパティウィンドウの [UpdateQuery] プロパティの横にある省略記号をクリックして、[コマンドおよびパラメーターエディター] ダイアログボックスを表示します。</span><span class="sxs-lookup"><span data-stu-id="da843-306">Select the SqlDataSource and, from the Properties window, click on the ellipses next to the UpdateQuery property to bring up the Command and Parameter Editor dialog box.</span></span> <span data-ttu-id="da843-307">次の `UPDATE` ステートメントをテキストボックスに入力します。</span><span class="sxs-lookup"><span data-stu-id="da843-307">Enter the following `UPDATE` statement into the textbox:</span></span>

[!code-sql[Main](storing-additional-user-information-cs/samples/sample3.sql)]

<span data-ttu-id="da843-308">次に、[パラメーターの更新] ボタンをクリックします。これにより、`UPDATE` ステートメントの各パラメーターについて、SqlDataSource コントロールの `UpdateParameters` コレクションにパラメーターが作成されます。</span><span class="sxs-lookup"><span data-stu-id="da843-308">Next, click the "Refresh Parameters" button, which will create a parameter in the SqlDataSource control's `UpdateParameters` collection for each of the parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="da843-309">すべてのパラメーターのソースを None に設定し、[OK] ボタンをクリックしてダイアログボックスを完成させます。</span><span class="sxs-lookup"><span data-stu-id="da843-309">Leave the source for all of the parameters set to None and click the OK button to complete the dialog box.</span></span>

<span data-ttu-id="da843-310">[SqlDataSource の UpdateCommand と UpdateParameters を指定 ![には](storing-additional-user-information-cs/_static/image41.png)](storing-additional-user-information-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="da843-310">[![Specify the SqlDataSource's UpdateCommand and UpdateParameters](storing-additional-user-information-cs/_static/image41.png)](storing-additional-user-information-cs/_static/image40.png)</span></span>

<span data-ttu-id="da843-311">**図 14**: SqlDataSource の `UpdateCommand` と `UpdateParameters` を指定[する (クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image42.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-311">**Figure 14**: Specify the SqlDataSource's `UpdateCommand` and `UpdateParameters` ([Click to view full-size image](storing-additional-user-information-cs/_static/image42.png))</span></span>

<span data-ttu-id="da843-312">SqlDataSource コントロールに加えられた追加により、DetailsView コントロールで編集がサポートされるようになりました。</span><span class="sxs-lookup"><span data-stu-id="da843-312">Due to the additions we made to the SqlDataSource control, the DetailsView control can now support editing.</span></span> <span data-ttu-id="da843-313">DetailsView のスマートタグから、[編集を有効にする] チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="da843-313">From the DetailsView's Smart Tag, check the "Enable Editing" checkbox.</span></span> <span data-ttu-id="da843-314">これにより、`ShowEditButton` プロパティが True に設定されたコントロールの `Fields` コレクションに CommandField が追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-314">This adds a CommandField to the control's `Fields` collection with its `ShowEditButton` property set to True.</span></span> <span data-ttu-id="da843-315">これにより、編集モードで DetailsView が読み取り専用モードで表示されている場合は [編集] ボタンが表示され、[更新] ボタンと [キャンセル] ボタンが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-315">This renders an Edit button when the DetailsView is displayed in read-only mode and Update and Cancel buttons when displayed in edit mode.</span></span> <span data-ttu-id="da843-316">ただし、ユーザーが [編集] をクリックする必要はありませんが、DetailsView コントロールの[`DefaultMode` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx)を `Edit`に設定することにより、detailsview を "常に編集可能" 状態にすることができます。</span><span class="sxs-lookup"><span data-stu-id="da843-316">Rather than requiring the user to click Edit, though, we can have the DetailsView render in an "always editable" state by setting the DetailsView control's [`DefaultMode` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx) to `Edit`.</span></span>

<span data-ttu-id="da843-317">これらの変更により、DetailsView コントロールの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-317">With these changes, your DetailsView control's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample4.aspx)]

<span data-ttu-id="da843-318">CommandField と `DefaultMode` プロパティが追加されていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="da843-318">Note the addition of the CommandField and the `DefaultMode` property.</span></span>

<span data-ttu-id="da843-319">ブラウザーでこのページをテストしてみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-319">Go ahead and test this page through a browser.</span></span> <span data-ttu-id="da843-320">`UserProfiles`に対応するレコードを持つユーザーと一緒にアクセスすると、ユーザーの設定が編集可能なインターフェイスに表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-320">When visiting with a user that has a corresponding record in `UserProfiles`, the user's settings are displayed in an editable interface.</span></span>

<span data-ttu-id="da843-321">[DetailsView が編集可能なインターフェイスをレンダリング ![](storing-additional-user-information-cs/_static/image44.png)](storing-additional-user-information-cs/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="da843-321">[![The DetailsView Renders an Editable Interface](storing-additional-user-information-cs/_static/image44.png)](storing-additional-user-information-cs/_static/image43.png)</span></span>

<span data-ttu-id="da843-322">**図 15**: DetailsView によって編集可能なインターフェイスがレンダリングされる ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image45.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-322">**Figure 15**: The DetailsView Renders an Editable Interface  ([Click to view full-size image](storing-additional-user-information-cs/_static/image45.png))</span></span>

<span data-ttu-id="da843-323">値を変更し、[更新] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-323">Try changing the values and clicking the Update button.</span></span> <span data-ttu-id="da843-324">何も起こらないかのように見えます。</span><span class="sxs-lookup"><span data-stu-id="da843-324">It appears as if nothing happens.</span></span> <span data-ttu-id="da843-325">ポストバックがあり、値はデータベースに保存されますが、保存が発生したことを視覚的に示すフィードバックはありません。</span><span class="sxs-lookup"><span data-stu-id="da843-325">There is a postback and the values are saved to the database, but there's no visual feedback that the save occurred.</span></span>

<span data-ttu-id="da843-326">これを解決するには、Visual Studio に戻り、DetailsView の上に Label コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-326">To remedy this, return to Visual Studio and add a Label control above the DetailsView.</span></span> <span data-ttu-id="da843-327">`ID` を `SettingsUpdatedMessage`に設定し、その `Text` プロパティを「設定が更新されました」に設定し、`Visible` プロパティと `EnableViewState` プロパティを `false`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-327">Set its `ID` to `SettingsUpdatedMessage`, its `Text` property to "Your settings have been updated," and its `Visible` and `EnableViewState` properties to `false`.</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample5.aspx)]

<span data-ttu-id="da843-328">DetailsView が更新されるたびに `SettingsUpdatedMessage` ラベルを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-328">We need to display the `SettingsUpdatedMessage` Label whenever the DetailsView is updated.</span></span> <span data-ttu-id="da843-329">これを実現するには、DetailsView の `ItemUpdated` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-329">To accomplish this, create an event handler for the DetailsView's `ItemUpdated` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample6.cs)]

<span data-ttu-id="da843-330">ブラウザーを使用して `AdditionalUserInfo.aspx` ページに戻り、データを更新します。</span><span class="sxs-lookup"><span data-stu-id="da843-330">Return to the `AdditionalUserInfo.aspx` page through a browser and update the data.</span></span> <span data-ttu-id="da843-331">今回は、役に立つステータスメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-331">This time, a helpful status message is displayed.</span></span>

<span data-ttu-id="da843-332">[設定が更新されると、短いメッセージ ![表示されます。](storing-additional-user-information-cs/_static/image47.png)](storing-additional-user-information-cs/_static/image46.png)</span><span class="sxs-lookup"><span data-stu-id="da843-332">[![A Short Message is Displayed When the Settings are Updated](storing-additional-user-information-cs/_static/image47.png)](storing-additional-user-information-cs/_static/image46.png)</span></span>

<span data-ttu-id="da843-333">**図 16**: 設定が更新されたときに短いメッセージが表示される ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image48.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-333">**Figure 16**: A Short Message is Displayed When the Settings are Updated  ([Click to view full-size image](storing-additional-user-information-cs/_static/image48.png))</span></span>

> [!NOTE]
> <span data-ttu-id="da843-334">DetailsView コントロールの編集インターフェイスは、必要に応じて大きくなります。</span><span class="sxs-lookup"><span data-stu-id="da843-334">The DetailsView control's editing interface leaves a lot to be desired.</span></span> <span data-ttu-id="da843-335">標準サイズのテキストボックスを使用しますが、署名フィールドは複数行のテキストボックスにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-335">It uses standard-sized textboxes, but the Signature field should probably be a multi-line textbox.</span></span> <span data-ttu-id="da843-336">RegularExpressionValidator を使用して、ホームページの URL が "http://" または "https://" で始まることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-336">A RegularExpressionValidator should be used to ensure that the homepage URL, if entered, starts with "http://" or "https://".</span></span> <span data-ttu-id="da843-337">さらに、DetailsView コントロールの `DefaultMode` プロパティは `Edit`に設定されているため、[キャンセル] ボタンでは何も実行されません。</span><span class="sxs-lookup"><span data-stu-id="da843-337">Moreover, since the DetailsView control has its `DefaultMode` property set to `Edit`, the Cancel button does not do anything.</span></span> <span data-ttu-id="da843-338">削除するか、クリックしてユーザーを他のページ (`~/Default.aspx`など) にリダイレクトする必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-338">It should either be removed or, when clicked, redirect the user to some other page (such as `~/Default.aspx`).</span></span> <span data-ttu-id="da843-339">これらの機能強化は、読者のための演習として残しておきます。</span><span class="sxs-lookup"><span data-stu-id="da843-339">I leave these enhancements as an exercise for the reader.</span></span>

### <a name="adding-a-link-to-theadditionaluserinfoaspxpage-in-the-master-page"></a><span data-ttu-id="da843-340">マスターページの`AdditionalUserInfo.aspx`ページへのリンクの追加</span><span class="sxs-lookup"><span data-stu-id="da843-340">Adding a Link to the`AdditionalUserInfo.aspx`Page in the Master Page</span></span>

<span data-ttu-id="da843-341">現在、web サイトには `AdditionalUserInfo.aspx` ページへのリンクはありません。</span><span class="sxs-lookup"><span data-stu-id="da843-341">Currently, the website does not provide any links to the `AdditionalUserInfo.aspx` page.</span></span> <span data-ttu-id="da843-342">このページに移動する唯一の方法は、ブラウザーのアドレスバーにページの URL を直接入力することです。</span><span class="sxs-lookup"><span data-stu-id="da843-342">The only way to reach it is to enter the page's URL directly into the browser's Address bar.</span></span> <span data-ttu-id="da843-343">`Site.master` マスターページで、このページへのリンクを追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-343">Let's add a link to this page in the `Site.master` master page.</span></span>

<span data-ttu-id="da843-344">マスターページには、認証された訪問者と匿名の訪問者の異なるマークアップを表示する、`LoginContent` ContentPlaceHolder の LoginView Web コントロールが含まれていることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="da843-344">Recall that the master page contains a LoginView Web control in its `LoginContent` ContentPlaceHolder that displays different markup for authenticated and anonymous visitors.</span></span> <span data-ttu-id="da843-345">LoginView コントロールの `LoggedInTemplate` を更新して、`AdditionalUserInfo.aspx` ページへのリンクを含めます。</span><span class="sxs-lookup"><span data-stu-id="da843-345">Update the LoginView control's `LoggedInTemplate` to include a link to the `AdditionalUserInfo.aspx` page.</span></span> <span data-ttu-id="da843-346">これらの変更を行った後、LoginView コントロールの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-346">After making these changes the LoginView control's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample7.aspx)]

<span data-ttu-id="da843-347">`LoggedInTemplate`に `lnkUpdateSettings` ハイパーリンクコントロールが追加されていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="da843-347">Note the addition of the `lnkUpdateSettings` HyperLink control to the `LoggedInTemplate`.</span></span> <span data-ttu-id="da843-348">このリンクを使用すると、認証されたユーザーはページにすばやく移動して、自宅、ホームページ、および署名の設定を表示および変更できます。</span><span class="sxs-lookup"><span data-stu-id="da843-348">With this link in place, authenticated users can quickly jump to the page to view and modify their home town, homepage, and signature settings.</span></span>

## <a name="step-4-adding-new-guestbook-comments"></a><span data-ttu-id="da843-349">手順 4: 新しいゲストブックコメントを追加する</span><span class="sxs-lookup"><span data-stu-id="da843-349">Step 4: Adding New Guestbook Comments</span></span>

<span data-ttu-id="da843-350">[`Guestbook.aspx`] ページでは、認証されたユーザーがゲストブックを表示し、コメントを残すことができます。</span><span class="sxs-lookup"><span data-stu-id="da843-350">The `Guestbook.aspx` page is where authenticated users can view the guestbook and leave a comment.</span></span> <span data-ttu-id="da843-351">まず、新しいゲストブックコメントを追加するためのインターフェイスの作成について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-351">Let's start with creating the interface to add new guestbook comments.</span></span>

<span data-ttu-id="da843-352">Visual Studio の [`Guestbook.aspx`] ページを開き、2つのテキストボックスコントロールで構成されるユーザーインターフェイスを作成します。1つは新しいコメントの件名用、もう1つは本文用です。</span><span class="sxs-lookup"><span data-stu-id="da843-352">Open the `Guestbook.aspx` page in Visual Studio and construct a user interface consisting of two TextBox controls, one for the new comment's subject and one for its body.</span></span> <span data-ttu-id="da843-353">最初のテキストボックスコントロールの `ID` プロパティを `Subject` に設定し、その `Columns` プロパティを40に設定します。2番目の `ID` を `Body`に、その `TextMode` を `MultiLine`に、`Width` プロパティと `Rows` プロパティをそれぞれ "95%" と8に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-353">Set the first TextBox control's `ID` property to `Subject` and its `Columns` property to 40; set second's `ID` to `Body`, its `TextMode` to `MultiLine`, and its `Width` and `Rows` properties to "95%" and 8, respectively.</span></span> <span data-ttu-id="da843-354">ユーザーインターフェイスを完成させるには、`PostCommentButton` という名前のボタン Web コントロールを追加し、その `Text` プロパティを「コメントの投稿」に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-354">To complete the user interface, add a Button Web control named `PostCommentButton` and set its `Text` property to "Post Your Comment".</span></span>

<span data-ttu-id="da843-355">各ゲストブックのコメントには件名と本文が必要であるため、各テキストボックスに RequiredFieldValidator を追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-355">Since each guestbook comment requires a subject and body, add a RequiredFieldValidator for each of the TextBoxes.</span></span> <span data-ttu-id="da843-356">これらのコントロールの `ValidationGroup` プロパティを "EnterComment" に設定します。同様に、`PostCommentButton` コントロールの `ValidationGroup` プロパティを "EnterComment" に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-356">Set the `ValidationGroup` property of these controls to "EnterComment"; likewise, set the `PostCommentButton` control's `ValidationGroup` property to "EnterComment".</span></span> <span data-ttu-id="da843-357">ASP の詳細については、「」を参照してください。NET の検証コントロール、 [ASP.NET でのフォーム検証](http://www.4guysfromrolla.com/webtech/090200-1.shtml)の確認、 [ASP.NET 2.0 の検証コントロールの解説](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)、 [W3Schools](http://www.w3schools.com/)の[検証サーバーコントロールのチュートリアル](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp)。</span><span class="sxs-lookup"><span data-stu-id="da843-357">For more information on ASP.NET's validation controls, check out [Form Validation in ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml), [Dissecting the Validation Controls in ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx), and the [Validation Server Controls Tutorial](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp) on [W3Schools](http://www.w3schools.com/).</span></span>

<span data-ttu-id="da843-358">ユーザーインターフェイスを作成した後、ページの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-358">After crafting the user interface your page's declarative markup should look something like the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample8.aspx)]

<span data-ttu-id="da843-359">ユーザーインターフェイスが完成したら、次に、`PostCommentButton` をクリックしたときに `GuestbookComments` テーブルに新しいレコードを挿入します。</span><span class="sxs-lookup"><span data-stu-id="da843-359">With the user interface complete, our next task is to insert a new record into the `GuestbookComments` table when the `PostCommentButton` is clicked.</span></span> <span data-ttu-id="da843-360">これはさまざまな方法で実現できます。ボタンの `Click` イベントハンドラーに ADO.NET コードを記述できます。SqlDataSource コントロールをページに追加し、その `InsertCommand`を構成した後、`Click` イベントハンドラーからその `Insert` メソッドを呼び出すことができます。または、新しいゲストブックコメントの挿入を担当する中間層を構築し、この機能を `Click` イベントハンドラーから呼び出すこともできます。</span><span class="sxs-lookup"><span data-stu-id="da843-360">This can be accomplished in a number of ways: we can write ADO.NET code in the Button's `Click` event handler; we can add a SqlDataSource control to the page, configure its `InsertCommand`, and then call its `Insert` method from the `Click` event handler; or we could build a middle tier that was responsible for inserting new guestbook comments, and invoke this functionality from the `Click` event handler.</span></span> <span data-ttu-id="da843-361">手順 3. で SqlDataSource を使用することを確認したので、ここでは ADO.NET コードを使用してみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-361">Since we looked at using a SqlDataSource in Step 3, let's use ADO.NET code here.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-362">Microsoft SQL Server データベースのデータにプログラムでアクセスするために使用される ADO.NET クラスは、`System.Data.SqlClient` 名前空間にあります。</span><span class="sxs-lookup"><span data-stu-id="da843-362">The ADO.NET classes used to programmatically access data from a Microsoft SQL Server database are located in the `System.Data.SqlClient` namespace.</span></span> <span data-ttu-id="da843-363">この名前空間をページの分離コードクラス (`using System.Data.SqlClient;`) にインポートすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="da843-363">You may need to import this namespace into your page's code-behind class (i.e., `using System.Data.SqlClient;`).</span></span>

<span data-ttu-id="da843-364">`PostCommentButton`の `Click` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-364">Create an event handler for the `PostCommentButton`'s `Click` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample9.cs)]

<span data-ttu-id="da843-365">`Click` イベントハンドラーは、ユーザーが指定したデータが有効であることを確認することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="da843-365">The `Click` event handler starts by checking that the user-supplied data is valid.</span></span> <span data-ttu-id="da843-366">そうでない場合は、レコードを挿入する前にイベントハンドラーが終了します。</span><span class="sxs-lookup"><span data-stu-id="da843-366">If it is not, the event handler exits before inserting a record.</span></span> <span data-ttu-id="da843-367">指定されたデータが有効であると仮定すると、現在ログオンしているユーザーの `UserId` 値が取得され、`currentUserId` ローカル変数に格納されます。</span><span class="sxs-lookup"><span data-stu-id="da843-367">Assuming the supplied data is valid, the currently logged on user's `UserId` value is retrieved and stored in the `currentUserId` local variable.</span></span> <span data-ttu-id="da843-368">`GuestbookComments`にレコードを挿入するときに `UserId` 値を指定する必要があるため、この値が必要になります。</span><span class="sxs-lookup"><span data-stu-id="da843-368">This value is needed because we must supply a `UserId` value when inserting a record into `GuestbookComments`.</span></span>

<span data-ttu-id="da843-369">その後、`SecurityTutorials` データベースの接続文字列が `Web.config` から取得され、`INSERT` SQL ステートメントが指定されます。</span><span class="sxs-lookup"><span data-stu-id="da843-369">Following that, the connection string for the `SecurityTutorials` database is retrieved from `Web.config` and the `INSERT` SQL statement is specified.</span></span> <span data-ttu-id="da843-370">次に、`SqlConnection` オブジェクトを作成して開きます。</span><span class="sxs-lookup"><span data-stu-id="da843-370">A `SqlConnection` object is then created and opened.</span></span> <span data-ttu-id="da843-371">次に、`SqlCommand` オブジェクトが構築され、`INSERT` クエリで使用されるパラメーターの値が割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="da843-371">Next, a `SqlCommand` object is constructed and the values for the parameters used in the `INSERT` query are assigned.</span></span> <span data-ttu-id="da843-372">次に、`INSERT` ステートメントが実行され、接続が閉じられます。</span><span class="sxs-lookup"><span data-stu-id="da843-372">The `INSERT` statement is then executed and the connection closed.</span></span> <span data-ttu-id="da843-373">イベントハンドラーの最後に、ユーザーの値がポストバック全体で保持されないように、`Subject` と `Body` のテキストボックスの `Text` プロパティがクリアされます。</span><span class="sxs-lookup"><span data-stu-id="da843-373">At the end of the event handler, the `Subject` and `Body` TextBoxes' `Text` properties are cleared out so that the user's values are not persisted across the postback.</span></span>

<span data-ttu-id="da843-374">ブラウザーでこのページをテストしてみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-374">Go ahead and test out this page in a browser.</span></span> <span data-ttu-id="da843-375">このページは `Membership` フォルダーにあるため、匿名訪問者はアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="da843-375">Since this page is in the `Membership` folder it is not accessible to anonymous visitors.</span></span> <span data-ttu-id="da843-376">そのため、最初にログオンする必要があります (まだインストールしていない場合)。</span><span class="sxs-lookup"><span data-stu-id="da843-376">Therefore, you will need to first log on (if you have not already).</span></span> <span data-ttu-id="da843-377">`Subject` と `Body` のテキストボックスに値を入力し、[`PostCommentButton`] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-377">Enter a value into the `Subject` and `Body` TextBoxes and click the `PostCommentButton` button.</span></span> <span data-ttu-id="da843-378">これにより、新しいレコードが `GuestbookComments`に追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-378">This will cause a new record to be added to `GuestbookComments`.</span></span> <span data-ttu-id="da843-379">ポストバック時に、指定した件名と本文がテキストボックスからワイプされます。</span><span class="sxs-lookup"><span data-stu-id="da843-379">On postback, the subject and body you provided are wiped from the TextBoxes.</span></span>

<span data-ttu-id="da843-380">[`PostCommentButton`] ボタンをクリックした後、コメントがゲストブックに追加されたことを示す視覚的なフィードバックはありません。</span><span class="sxs-lookup"><span data-stu-id="da843-380">After clicking the `PostCommentButton` button there is no visual feedback that the comment was added to the guestbook.</span></span> <span data-ttu-id="da843-381">このページを更新して、既存のゲストブックのコメントを表示する必要もあります。これは、手順 5. で行います。</span><span class="sxs-lookup"><span data-stu-id="da843-381">We still need to update this page to display the existing guestbook comments, which we will do in Step 5.</span></span> <span data-ttu-id="da843-382">これを完了すると、コメントの一覧に追加されたコメントが表示され、適切な視覚的なフィードバックが得られます。</span><span class="sxs-lookup"><span data-stu-id="da843-382">Once we accomplish that, the just-added comment will appear in the list of comments, providing adequate visual feedback.</span></span> <span data-ttu-id="da843-383">ここでは、`GuestbookComments` テーブルの内容を調べて、ゲストブックコメントが保存されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="da843-383">For now, confirm that your guestbook comment was saved by examining the contents of the `GuestbookComments` table.</span></span>

<span data-ttu-id="da843-384">図17は、2つのコメントが残された後の `GuestbookComments` テーブルの内容を示しています。</span><span class="sxs-lookup"><span data-stu-id="da843-384">Figure 17 shows the contents of the `GuestbookComments` table after two comments have been left.</span></span>

<span data-ttu-id="da843-385">[ゲストブックのコメントを GuestbookComments テーブルに表示する ![](storing-additional-user-information-cs/_static/image50.png)](storing-additional-user-information-cs/_static/image49.png)</span><span class="sxs-lookup"><span data-stu-id="da843-385">[![You Can See the Guestbook Comments in the GuestbookComments Table](storing-additional-user-information-cs/_static/image50.png)](storing-additional-user-information-cs/_static/image49.png)</span></span>

<span data-ttu-id="da843-386">**図 17**: `GuestbookComments` テーブルにゲストブックのコメントを表示する ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image51.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-386">**Figure 17**: You Can See the Guestbook Comments in the `GuestbookComments` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image51.png))</span></span>

> [!NOTE]
> <span data-ttu-id="da843-387">危険性のあるマークアップ (HTML – ASP.NET など) を含むゲストブックコメントをユーザーが挿入しようとすると、`HttpRequestValidationException`がスローされます。</span><span class="sxs-lookup"><span data-stu-id="da843-387">If a user attempts to insert a guestbook comment that contains potentially dangerous markup – such as HTML – ASP.NET will throw an `HttpRequestValidationException`.</span></span> <span data-ttu-id="da843-388">この例外の詳細、スローされる理由、ユーザーが危険な可能性のある値を送信することを許可する方法については、「要求の検証に関する[ホワイトペーパー](../../../../whitepapers/request-validation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-388">To learn more about this exception, why it's thrown, and how to permit users to submit potentially dangerous values, consult the [Request Validation Whitepaper](../../../../whitepapers/request-validation.md).</span></span>

## <a name="step-5-listing-the-existing-guestbook-comments"></a><span data-ttu-id="da843-389">手順 5: 既存のゲストブックコメントを一覧表示する</span><span class="sxs-lookup"><span data-stu-id="da843-389">Step 5: Listing the Existing Guestbook Comments</span></span>

<span data-ttu-id="da843-390">コメントを残すだけでなく、`Guestbook.aspx` ページにアクセスするユーザーも、ゲストブックの既存のコメントを表示することができます。</span><span class="sxs-lookup"><span data-stu-id="da843-390">In addition to leaving comments, a user visiting the `Guestbook.aspx` page should also be able to view the guestbook's existing comments.</span></span> <span data-ttu-id="da843-391">これを実現するには、`CommentList` という名前の ListView コントロールをページの下部に追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-391">To accomplish this, add a ListView control named `CommentList` to the bottom of the page.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-392">ListView コントロールは、ASP.NET バージョン3.5 の新しいバージョンです。</span><span class="sxs-lookup"><span data-stu-id="da843-392">The ListView control is new to ASP.NET version 3.5.</span></span> <span data-ttu-id="da843-393">カスタマイズ可能で柔軟性の高いレイアウトで項目の一覧を表示するように設計されていますが、GridView などの組み込みの編集、挿入、削除、ページング、および並べ替えの機能も提供しています。</span><span class="sxs-lookup"><span data-stu-id="da843-393">It is designed to display a list of items in a very customizable and flexible layout, yet still offer built-in editing, inserting, deleting, paging, and sorting functionality like the GridView.</span></span> <span data-ttu-id="da843-394">ASP.NET 2.0 を使用している場合は、代わりに DataList または Repeater コントロールを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-394">If you are using ASP.NET 2.0, you will need to use the DataList or Repeater control instead.</span></span> <span data-ttu-id="da843-395">ListView の使用方法の詳細については、 [Scott Guthrie](https://weblogs.asp.net/scottgu/)のブログエントリ、 [Asp: listview コントロール](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)、および記事「 [Listview コントロールでデータを表示](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)する」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-395">For more information on using the ListView, see [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog entry, [The asp:ListView Control](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx), and my article, [Displaying Data with the ListView Control](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx).</span></span>

<span data-ttu-id="da843-396">ListView のスマートタグを開き、[データソースの選択] ドロップダウンリストから新しいデータソースにコントロールをバインドします。</span><span class="sxs-lookup"><span data-stu-id="da843-396">Open the ListView's Smart Tag and, from the Choose Data Source drop-down list, bind the control to a new data source.</span></span> <span data-ttu-id="da843-397">手順 2. で見たように、これによりデータソース構成ウィザードが起動します。</span><span class="sxs-lookup"><span data-stu-id="da843-397">As we saw in Step 2, this will launch the Data Source Configuration Wizard.</span></span> <span data-ttu-id="da843-398">データベースアイコンを選択し、結果の SqlDataSource `CommentsDataSource`という名前を指定して、[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-398">Select the Database icon, name the resulting SqlDataSource `CommentsDataSource`, and click OK.</span></span> <span data-ttu-id="da843-399">次に、ドロップダウンリストから `SecurityTutorialsConnectionString` 接続文字列を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-399">Next, select the `SecurityTutorialsConnectionString` connection string from the drop-down list and click Next.</span></span>

<span data-ttu-id="da843-400">手順2のこの時点で、ドロップダウンリストから `UserProfiles` テーブルを選択し、返す列を選択することによって、クエリするデータを指定しました (図9を参照)。</span><span class="sxs-lookup"><span data-stu-id="da843-400">At this point in Step 2 we specified the data to query by picking the `UserProfiles` table from the drop-down list and selecting the columns to return (refer back to Figure 9).</span></span> <span data-ttu-id="da843-401">ここでは、`GuestbookComments`からレコードだけでなく、コメンターのホーム、ホームページ、署名、およびユーザー名も返す SQL ステートメントを記述する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-401">This time, however, we want to craft a SQL statement that pulls back not only the records from `GuestbookComments`, but also the commenter's home town, homepage, signature, and username.</span></span> <span data-ttu-id="da843-402">そのため、[カスタム SQL ステートメントまたはストアドプロシージャを指定してください] オプションを選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-402">Therefore, select the "Specify a custom SQL statement or stored procedure" radio button and click Next.</span></span>

<span data-ttu-id="da843-403">これにより、"カスタムステートメントまたはストアドプロシージャの定義" 画面が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-403">This will bring up the "Define Custom Statements or Stored Procedures" screen.</span></span> <span data-ttu-id="da843-404">[クエリビルダー] ボタンをクリックして、クエリをグラフィカルに作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-404">Click the Query Builder button to graphically build the query.</span></span> <span data-ttu-id="da843-405">クエリビルダーは、まずクエリを実行するテーブルを指定するように求めるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-405">The Query Builder starts by prompting us to specify the tables we want to query from.</span></span> <span data-ttu-id="da843-406">`GuestbookComments`、`UserProfiles`、および `aspnet_Users` テーブルを選択し、[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-406">Select the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables and click OK.</span></span> <span data-ttu-id="da843-407">これにより、3つすべてのテーブルがデザイン画面に追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-407">This will add all three tables to the design surface.</span></span> <span data-ttu-id="da843-408">`GuestbookComments`、`UserProfiles`、および `aspnet_Users` テーブルの間には foreign key 制約があるため、これらのテーブルはクエリビルダーによって自動的に `JOIN` されます。</span><span class="sxs-lookup"><span data-stu-id="da843-408">Since there are foreign key constraints amongst the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables, the Query Builder automatically `JOIN` s these tables.</span></span>

<span data-ttu-id="da843-409">残っているのは、返される列を指定することだけです。</span><span class="sxs-lookup"><span data-stu-id="da843-409">All that remains is to specify the columns to return.</span></span> <span data-ttu-id="da843-410">`GuestbookComments` テーブルから、`Subject`、`Body`、および `CommentDate` 列を選択します。`UserProfiles` テーブルから `HomeTown`、`HomepageUrl`、および `Signature` の各列を返します。`aspnet_Users`から `UserName` を返します。</span><span class="sxs-lookup"><span data-stu-id="da843-410">From the `GuestbookComments` table select the `Subject`, `Body`, and `CommentDate` columns; return the `HomeTown`, `HomepageUrl`, and `Signature` columns from the `UserProfiles` table; and return `UserName` from `aspnet_Users`.</span></span> <span data-ttu-id="da843-411">また、`SELECT` クエリの末尾に "`ORDER BY CommentDate DESC`" を追加して、最新の投稿が最初に返されるようにします。</span><span class="sxs-lookup"><span data-stu-id="da843-411">Also, add "`ORDER BY CommentDate DESC`" to the end of the `SELECT` query so that the most recent posts are returned first.</span></span> <span data-ttu-id="da843-412">これらの選択を行った後、クエリビルダーインターフェイスは、図18のスクリーンショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-412">After making these selections, your Query Builder interface should look similar to the screen shot in Figure 18.</span></span>

<span data-ttu-id="da843-413">[構築されたクエリが GuestbookComments、UserProfiles、aspnet_Users テーブルを結合 ![](storing-additional-user-information-cs/_static/image53.png)](storing-additional-user-information-cs/_static/image52.png)</span><span class="sxs-lookup"><span data-stu-id="da843-413">[![The Constructed Query JOINs the GuestbookComments, UserProfiles, and aspnet_Users Tables](storing-additional-user-information-cs/_static/image53.png)](storing-additional-user-information-cs/_static/image52.png)</span></span>

<span data-ttu-id="da843-414">**図 18**: 構築されたクエリは、`GuestbookComments`、`UserProfiles`、および `aspnet_Users` テーブルを `JOIN` します ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image54.png)されます)。</span><span class="sxs-lookup"><span data-stu-id="da843-414">**Figure 18**: The Constructed Query `JOIN` s the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` Tables  ([Click to view full-size image](storing-additional-user-information-cs/_static/image54.png))</span></span>

<span data-ttu-id="da843-415">[OK] をクリックしてクエリビルダーウィンドウを閉じ、[カスタムステートメントまたはストアドプロシージャの定義] 画面に戻ります。</span><span class="sxs-lookup"><span data-stu-id="da843-415">Click OK to close the Query Builder window and return to the "Define Custom Statements or Stored Procedures" screen.</span></span> <span data-ttu-id="da843-416">[次へ] をクリックして [クエリのテスト] 画面に進みます。この画面では、[クエリのテスト] ボタンをクリックしてクエリの結果を表示できます。</span><span class="sxs-lookup"><span data-stu-id="da843-416">Click Next to advance to the "Test Query" screen, where you may view the query results by clicking the Test Query button.</span></span> <span data-ttu-id="da843-417">準備ができたら、[完了] をクリックして、データソースの構成ウィザードを完了します。</span><span class="sxs-lookup"><span data-stu-id="da843-417">When you're ready, click Finish to complete the Configure Data Source wizard.</span></span>

<span data-ttu-id="da843-418">手順2でデータソースの構成ウィザードを完了すると、関連する DetailsView コントロールの `Fields` コレクションが更新され、`SelectCommand`によって返される各列の BoundField が含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="da843-418">When we completed the Configure Data Source wizard in Step 2, the associated DetailsView control's `Fields` collection was updated to include a BoundField for each column returned by the `SelectCommand`.</span></span> <span data-ttu-id="da843-419">ただし、ListView は変更されません。そのレイアウトを定義する必要もあります。</span><span class="sxs-lookup"><span data-stu-id="da843-419">The ListView, however, remains unchanged; we still need to define its layout.</span></span> <span data-ttu-id="da843-420">ListView のレイアウトは、宣言型マークアップまたはスマートタグの [ListView の構成] オプションを使用して手動で構築できます。</span><span class="sxs-lookup"><span data-stu-id="da843-420">The ListView's layout can be constructed manually through its declarative markup or from the "Configure ListView" option in its Smart Tag.</span></span> <span data-ttu-id="da843-421">通常はマークアップを手動で定義することをお勧めしますが、最も自然な方法を使用します。</span><span class="sxs-lookup"><span data-stu-id="da843-421">I usually prefer defining the markup by hand, but use whatever method is most natural to you.</span></span>

<span data-ttu-id="da843-422">ここでは、ListView コントロールに対して、次の `LayoutTemplate`、`ItemTemplate`、および `ItemSeparatorTemplate` を使用しました。</span><span class="sxs-lookup"><span data-stu-id="da843-422">I ended up using the following `LayoutTemplate`, `ItemTemplate`, and `ItemSeparatorTemplate` for my ListView control:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample10.aspx)]

<span data-ttu-id="da843-423">`LayoutTemplate` は、コントロールによって出力されるマークアップを定義し、`ItemTemplate` は SqlDataSource によって返される各項目をレンダリングします。</span><span class="sxs-lookup"><span data-stu-id="da843-423">The `LayoutTemplate` defines the markup emitted by the control, while the `ItemTemplate` renders each item returned by the SqlDataSource.</span></span> <span data-ttu-id="da843-424">`ItemTemplate`の結果のマークアップは、`LayoutTemplate`の `itemPlaceholder` コントロールに配置されます。</span><span class="sxs-lookup"><span data-stu-id="da843-424">The `ItemTemplate`'s resulting markup is placed in the `LayoutTemplate`'s `itemPlaceholder` control.</span></span> <span data-ttu-id="da843-425">`itemPlaceholder`に加えて、`LayoutTemplate` には DataPager コントロールが含まれています。このコントロールでは、ListView が1ページあたり10個のゲストブックコメントのみを表示するように制限されており、ページングインターフェイスがレンダリングされます。</span><span class="sxs-lookup"><span data-stu-id="da843-425">In addition to the `itemPlaceholder`, the `LayoutTemplate` includes a DataPager control, which limits the ListView to showing just 10 guestbook comments per page (the default) and renders a paging interface.</span></span>

<span data-ttu-id="da843-426">マイ `ItemTemplate` には、各ゲストブックコメントの件名が件名の下にある `<h4>` 要素に表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-426">My `ItemTemplate` displays each guestbook comment's subject in an `<h4>` element with the body situated below the subject.</span></span> <span data-ttu-id="da843-427">本文の表示に使用される構文は、`Eval("Body")` databinding ステートメントによって返されるデータを取得し、それを文字列に変換し、改行を `<br />` 要素に置き換えることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="da843-427">Note that syntax used for displaying the body takes the data returned by the `Eval("Body")` databinding statement, converts it to a string, and replaces line breaks with the `<br />` element.</span></span> <span data-ttu-id="da843-428">この変換は、HTML では空白が無視されるため、コメントの送信時に入力した改行を表示するために必要です。</span><span class="sxs-lookup"><span data-stu-id="da843-428">This conversion is needed in order to show the line breaks entered when submitting the comment since whitespace is ignored by HTML.</span></span> <span data-ttu-id="da843-429">ユーザーの署名は、本文の下に斜体で表示され、その後にユーザーの自宅の町、ホームページへのリンク、コメントが作成された日付と時刻、コメントを残した人物のユーザー名が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-429">The user's signature is displayed beneath the body in italics, followed by the user's home town, a link to his homepage, the date and time the comment was made, and the username of the person who left the comment.</span></span>

<span data-ttu-id="da843-430">ブラウザーでページを表示してみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-430">Take a moment to view the page through a browser.</span></span> <span data-ttu-id="da843-431">ここに表示されている手順5のゲストブックに追加したコメントが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-431">You should see the comments that you added to the guestbook in Step 5 displayed here.</span></span>

<span data-ttu-id="da843-432">[![のゲストブックのコメントが表示されるようになりました](storing-additional-user-information-cs/_static/image56.png)](storing-additional-user-information-cs/_static/image55.png)</span><span class="sxs-lookup"><span data-stu-id="da843-432">[![Guestbook.aspx Now Displays the Guestbook's Comments](storing-additional-user-information-cs/_static/image56.png)](storing-additional-user-information-cs/_static/image55.png)</span></span>

<span data-ttu-id="da843-433">**図 19**: `Guestbook.aspx` がゲストブックのコメントを表示[する (クリックしてフルサイズの画像を表示する](storing-additional-user-information-cs/_static/image57.png))</span><span class="sxs-lookup"><span data-stu-id="da843-433">**Figure 19**: `Guestbook.aspx` Now Displays the Guestbook's Comments  ([Click to view full-size image](storing-additional-user-information-cs/_static/image57.png))</span></span>

<span data-ttu-id="da843-434">ゲストブックに新しいコメントを追加してみてください。</span><span class="sxs-lookup"><span data-stu-id="da843-434">Try adding a new comment to the guestbook.</span></span> <span data-ttu-id="da843-435">`PostCommentButton` ボタンをクリックすると、ページがポストバックされ、コメントがデータベースに追加されますが、ListView コントロールは新しいコメントを表示するように更新されません。</span><span class="sxs-lookup"><span data-stu-id="da843-435">Upon clicking the `PostCommentButton` button the page posts back and the comment is added to the database, but the ListView control is not updated to show the new comment.</span></span> <span data-ttu-id="da843-436">これは、次のいずれかの方法で修正できます。</span><span class="sxs-lookup"><span data-stu-id="da843-436">This can be fixed by either:</span></span>

- <span data-ttu-id="da843-437">`PostCommentButton` ボタンの `Click` イベントハンドラーを更新して、データベースに新しいコメントを挿入した後に ListView コントロールの `DataBind()` メソッドを呼び出すようにします。</span><span class="sxs-lookup"><span data-stu-id="da843-437">Updating the `PostCommentButton` button's `Click` event handler so that it invokes the ListView control's `DataBind()` method after inserting the new comment into the database, or</span></span>
- <span data-ttu-id="da843-438">ListView コントロールの `EnableViewState` プロパティを `false`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-438">Setting the ListView control's `EnableViewState` property to `false`.</span></span> <span data-ttu-id="da843-439">この方法は、コントロールのビューステートを無効にすることで、すべてのポストバックで基になるデータに再バインドする必要があるため、機能します。</span><span class="sxs-lookup"><span data-stu-id="da843-439">This approach works because by disabling the control's view state, it must rebind to the underlying data on every postback.</span></span>

<span data-ttu-id="da843-440">このチュートリアルでダウンロードできるチュートリアル web サイトには、両方の方法が示されています。</span><span class="sxs-lookup"><span data-stu-id="da843-440">The tutorial website downloadable from this tutorial illustrates both techniques.</span></span> <span data-ttu-id="da843-441">`false` する ListView コントロールの `EnableViewState` プロパティ、およびプログラムによって ListView にデータを再バインドするために必要なコードは `Click` イベントハンドラーに存在しますが、コメントアウトされています。</span><span class="sxs-lookup"><span data-stu-id="da843-441">The ListView control's `EnableViewState` property to `false` and the code needed to programmatically rebind the data to the ListView is present in the `Click` event handler, but is commented out.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-442">現在、[`AdditionalUserInfo.aspx`] ページでは、ユーザーは自分の自宅、ホームページ、および署名の設定を表示および編集できます。</span><span class="sxs-lookup"><span data-stu-id="da843-442">Currently the `AdditionalUserInfo.aspx` page allows the user to view and edit their home town, homepage, and signature settings.</span></span> <span data-ttu-id="da843-443">`AdditionalUserInfo.aspx` を更新して、ログインしているユーザーのゲストブックコメントを表示すると便利な場合があります。</span><span class="sxs-lookup"><span data-stu-id="da843-443">It might be nice to update `AdditionalUserInfo.aspx` to display the logged in user's guestbook comments.</span></span> <span data-ttu-id="da843-444">つまり、ユーザーは自分の情報を確認して変更するだけでなく、[`AdditionalUserInfo.aspx`] ページにアクセスして、過去に行われたゲストブックのコメントを確認することもできます。</span><span class="sxs-lookup"><span data-stu-id="da843-444">That is, in addition to examining and modifying her information, a user can visit the `AdditionalUserInfo.aspx` page to see what guestbook comments she's made in the past.</span></span> <span data-ttu-id="da843-445">これは関心のある読者のための演習として残されています。</span><span class="sxs-lookup"><span data-stu-id="da843-445">I leave this as an exercise for the interested reader.</span></span>

## <a name="step-6-customizing-the-createuserwizard-control-to-include-an-interface-for-the-home-town-homepage-and-signature"></a><span data-ttu-id="da843-446">手順 6: CreateUserWizard コントロールをカスタマイズして、自宅、ホームページ、および署名のインターフェイスを含める</span><span class="sxs-lookup"><span data-stu-id="da843-446">Step 6: Customizing the CreateUserWizard Control to Include an Interface for the Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="da843-447">`Guestbook.aspx` ページで使用される `SELECT` クエリでは、`INNER JOIN` を使用して、`GuestbookComments`、`UserProfiles`、および `aspnet_Users` テーブル間で関連レコードを結合します。</span><span class="sxs-lookup"><span data-stu-id="da843-447">The `SELECT` query used by the `Guestbook.aspx` page uses an `INNER JOIN` to combine the related records amongst the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables.</span></span> <span data-ttu-id="da843-448">`UserProfiles` にレコードを持たないユーザーがゲストブックコメントを作成した場合、`INNER JOIN` は `UserProfiles` および `aspnet_Users`に一致するレコードがある場合にのみ `GuestbookComments` レコードを返すため、ListView にコメントは表示されません。</span><span class="sxs-lookup"><span data-stu-id="da843-448">If a user that has no record in `UserProfiles` makes a guestbook comment, the comment won't be displayed in the ListView because the `INNER JOIN` only returns `GuestbookComments` records when there are matching records in `UserProfiles` and `aspnet_Users`.</span></span> <span data-ttu-id="da843-449">手順 3. で見たように、ユーザーがレコードを持っていない場合 `UserProfiles` `AdditionalUserInfo.aspx` ページで自分の設定を表示または編集することはできません。</span><span class="sxs-lookup"><span data-stu-id="da843-449">And as we saw in Step 3, if a user does not have a record in `UserProfiles` she cannot view or edit her settings in the `AdditionalUserInfo.aspx` page.</span></span>

<span data-ttu-id="da843-450">言うまでもありませんが、設計上の決定により、メンバーシップシステムのすべてのユーザーアカウントには、`UserProfiles` テーブルに一致するレコードがあることが重要です。</span><span class="sxs-lookup"><span data-stu-id="da843-450">Needless to say, due to our design decisions it is important that every user account in the Membership system have a matching record in the `UserProfiles` table.</span></span> <span data-ttu-id="da843-451">CreateUserWizard を使用して新しいメンバーシップユーザーアカウントが作成されるたびに、対応するレコードが `UserProfiles` に追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-451">What we want is for a corresponding record to be added to `UserProfiles` whenever a new Membership user account is created through the CreateUserWizard.</span></span>

<span data-ttu-id="da843-452">「[*ユーザーアカウントの作成*](creating-user-accounts-cs.md)」チュートリアルで説明したように、新しいメンバーシップユーザーアカウントが作成されると、CreateUserWizard コントロールによって[`CreatedUser` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx)が発生します。</span><span class="sxs-lookup"><span data-stu-id="da843-452">As discussed in the [*Creating User Accounts*](creating-user-accounts-cs.md) tutorial, after the new Membership user account is created the CreateUserWizard control raises its [`CreatedUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx).</span></span> <span data-ttu-id="da843-453">このイベントのイベントハンドラーを作成し、作成したユーザーの UserId を取得して、`HomeTown`、`HomepageUrl`、および `Signature` 列の既定値を使用して `UserProfiles` テーブルにレコードを挿入できます。</span><span class="sxs-lookup"><span data-stu-id="da843-453">We can create an event handler for this event, get the UserId for the just-created user, and then insert a record into the `UserProfiles` table with default values for the `HomeTown`, `HomepageUrl`, and `Signature` columns.</span></span> <span data-ttu-id="da843-454">さらに、追加のテキストボックスを含めるように CreateUserWizard コントロールのインターフェイスをカスタマイズすることで、ユーザーにこれらの値の入力を求めることができます。</span><span class="sxs-lookup"><span data-stu-id="da843-454">What's more, it is possible to prompt the user for these values by customizing the CreateUserWizard control's interface to include additional TextBoxes.</span></span>

<span data-ttu-id="da843-455">まず、既定値を使用して、`CreatedUser` イベントハンドラーの `UserProfiles` テーブルに新しい行を追加する方法を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-455">Let's first look at how to add a new row to the `UserProfiles` table in the `CreatedUser` event handler with default values.</span></span> <span data-ttu-id="da843-456">その後、CreateUserWizard コントロールのユーザーインターフェイスをカスタマイズして、新しいユーザーのホームの町、ホームページ、および署名を収集するための追加のフォームフィールドを含める方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-456">Following that, we will see how to customize the CreateUserWizard control's user interface to include additional form fields to collect the new user's home town, homepage, and signature.</span></span>

### <a name="adding-a-default-row-touserprofiles"></a><span data-ttu-id="da843-457">`UserProfiles` に既定の行を追加する</span><span class="sxs-lookup"><span data-stu-id="da843-457">Adding a Default Row to`UserProfiles`</span></span>

<span data-ttu-id="da843-458">「[*ユーザーアカウントの作成*](creating-user-accounts-cs.md)」チュートリアルでは、`Membership` フォルダーの `CreatingUserAccounts.aspx` ページに CreateUserWizard コントロールを追加しました。</span><span class="sxs-lookup"><span data-stu-id="da843-458">In the [*Creating User Accounts*](creating-user-accounts-cs.md) tutorial we added a CreateUserWizard control to the `CreatingUserAccounts.aspx` page in the `Membership` folder.</span></span> <span data-ttu-id="da843-459">ユーザーアカウントの作成時に CreateUserWizard コントロールが `UserProfiles` テーブルにレコードを追加するには、CreateUserWizard コントロールの機能を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-459">In order to have the CreateUserWizard control add a record to `UserProfiles` table upon user account creation, we need to update the CreateUserWizard control's functionality.</span></span> <span data-ttu-id="da843-460">`CreatingUserAccounts.aspx` のページにこれらの変更を加えるのではなく、`EnhancedCreateUserWizard.aspx` のページに新しい CreateUserWizard コントロールを追加して、このチュートリアルの変更を加えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-460">Rather than making these changes to the `CreatingUserAccounts.aspx` page, let's instead add a new CreateUserWizard control to `EnhancedCreateUserWizard.aspx` page and make the modifications for this tutorial there.</span></span>

<span data-ttu-id="da843-461">Visual Studio の [`EnhancedCreateUserWizard.aspx`] ページを開き、[ツールボックス] から CreateUserWizard コントロールをページにドラッグします。</span><span class="sxs-lookup"><span data-stu-id="da843-461">Open the `EnhancedCreateUserWizard.aspx` page in Visual Studio and drag a CreateUserWizard control from the Toolbox onto the page.</span></span> <span data-ttu-id="da843-462">CreateUserWizard コントロールの `ID` プロパティを `NewUserWizard`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-462">Set the CreateUserWizard control's `ID` property to `NewUserWizard`.</span></span> <span data-ttu-id="da843-463">「 <a id="_msoanchor_5"> </a>[*ユーザーアカウントの作成*](creating-user-accounts-cs.md)」チュートリアルで説明したように、CreateUserWizard の既定のユーザーインターフェイスによって、ビジターに必要な情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-463">As we discussed in the <a id="_msoanchor_5"></a>[*Creating User Accounts*](creating-user-accounts-cs.md) tutorial, the CreateUserWizard's default user interface prompts the visitor for the necessary information.</span></span> <span data-ttu-id="da843-464">この情報が提供されると、コントロールは内部的にメンバーシップフレームワークに新しいユーザーアカウントを作成します。1行のコードを記述する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="da843-464">Once this information has been supplied, the control internally creates a new user account in the Membership framework, all without us having to write a single line of code.</span></span>

<span data-ttu-id="da843-465">CreateUserWizard コントロールは、ワークフローの実行中に多数のイベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="da843-465">The CreateUserWizard control raises a number of events during its workflow.</span></span> <span data-ttu-id="da843-466">ビジターが要求情報を提供してフォームを送信すると、CreateUserWizard コントロールは最初にその[`CreatingUser` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx)を発生させます。</span><span class="sxs-lookup"><span data-stu-id="da843-466">After a visitor supplies the request information and submits the form, the CreateUserWizard control initially fires its [`CreatingUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx).</span></span> <span data-ttu-id="da843-467">作成プロセス中に問題が発生した場合は、 [`CreateUserError` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx)が発生します。ただし、ユーザーが正常に作成された場合は、 [`CreatedUser` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx)が発生します。</span><span class="sxs-lookup"><span data-stu-id="da843-467">If there is a problem during the create process, the [`CreateUserError` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx) is fired; however, if the user is successfully created, then the [`CreatedUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx) is raised.</span></span> <span data-ttu-id="da843-468"><a id="_msoanchor_6"> </a>「[*ユーザーアカウントの作成*](creating-user-accounts-cs.md)」チュートリアルでは、指定されたユーザー名に先頭または末尾のスペースが含まれておらず、ユーザー名がパスワードのどこにも表示されていないことを確認するために、`CreatingUser` イベントのイベントハンドラーを作成しました。</span><span class="sxs-lookup"><span data-stu-id="da843-468">In the <a id="_msoanchor_6"></a>[*Creating User Accounts*](creating-user-accounts-cs.md) tutorial we created an event handler for the `CreatingUser` event to ensure that the supplied username did not contain any leading or trailing spaces, and that the username did not appear anywhere in the password.</span></span>

<span data-ttu-id="da843-469">作成したばかりのユーザーの `UserProfiles` テーブルに行を追加するには、`CreatedUser` イベントのイベントハンドラーを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-469">In order to add a row in the `UserProfiles` table for the just-created user, we need to create an event handler for the `CreatedUser` event.</span></span> <span data-ttu-id="da843-470">`CreatedUser` イベントが発生した時点までに、メンバーシップフレームワークでユーザーアカウントが既に作成されているため、アカウントの UserId 値を取得できます。</span><span class="sxs-lookup"><span data-stu-id="da843-470">By the time the `CreatedUser` event has fired, the user account has already been created in the Membership framework, enabling us to retrieve the account's UserId value.</span></span>

<span data-ttu-id="da843-471">`NewUserWizard`の `CreatedUser` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-471">Create an event handler for the `NewUserWizard`'s `CreatedUser` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample11.cs)]

<span data-ttu-id="da843-472">上記のコードでは、追加されたユーザーアカウントの UserId を取得します。</span><span class="sxs-lookup"><span data-stu-id="da843-472">The above code beings by retrieving the UserId of the just-added user account.</span></span> <span data-ttu-id="da843-473">これを行うには、`Membership.GetUser(username)` メソッドを使用して特定のユーザーに関する情報を返し、次に `ProviderUserKey` プロパティを使用してユーザー Id を取得します。</span><span class="sxs-lookup"><span data-stu-id="da843-473">This is accomplished by using the `Membership.GetUser(username)` method to return information about a particular user, and then using the `ProviderUserKey` property to retrieve their UserId.</span></span> <span data-ttu-id="da843-474">CreateUserWizard コントロールにユーザーが入力したユーザー名は、 [`UserName` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx)を介して使用できます。</span><span class="sxs-lookup"><span data-stu-id="da843-474">The username entered by the user in the CreateUserWizard control is available via its [`UserName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx).</span></span>

<span data-ttu-id="da843-475">次に、接続文字列が `Web.config` から取得され、`INSERT` ステートメントが指定されます。</span><span class="sxs-lookup"><span data-stu-id="da843-475">Next, the connection string is retrieved from `Web.config` and the `INSERT` statement is specified.</span></span> <span data-ttu-id="da843-476">必要な ADO.NET オブジェクトがインスタンス化され、コマンドが実行されます。</span><span class="sxs-lookup"><span data-stu-id="da843-476">The necessary ADO.NET objects are instantiated and the command executed.</span></span> <span data-ttu-id="da843-477">このコードは、`@HomeTown`、`@HomepageUrl`、および `@Signature` の各パラメーターに[`DBNull`](https://msdn.microsoft.com/library/system.dbnull.aspx)インスタンスを割り当てます。これらのパラメーターには、`NULL`、`HomeTown`、および `HomepageUrl`の各フィールドのデータベース `Signature` 値が挿入された場合の効果があります。</span><span class="sxs-lookup"><span data-stu-id="da843-477">The code assigns a [`DBNull`](https://msdn.microsoft.com/library/system.dbnull.aspx) instance to the `@HomeTown`, `@HomepageUrl`, and `@Signature` parameters, which has the effect of inserting database `NULL` values for the `HomeTown`, `HomepageUrl`, and `Signature` fields.</span></span>

<span data-ttu-id="da843-478">ブラウザーを使用して `EnhancedCreateUserWizard.aspx` のページにアクセスし、新しいユーザーアカウントを作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-478">Visit the `EnhancedCreateUserWizard.aspx` page through a browser and create a new user account.</span></span> <span data-ttu-id="da843-479">その後、Visual Studio に戻り、`aspnet_Users` テーブルと `UserProfiles` テーブルの内容を確認します (図12に戻っています)。</span><span class="sxs-lookup"><span data-stu-id="da843-479">After doing so, return to Visual Studio and examine the contents of the `aspnet_Users` and `UserProfiles` tables (like we did back in Figure 12).</span></span> <span data-ttu-id="da843-480">`aspnet_Users` に新しいユーザーアカウントが表示され、対応する `UserProfiles` 行 (`HomeTown`、`HomepageUrl`、`Signature`の `NULL` 値) が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-480">You should see the new user account in `aspnet_Users` and a corresponding `UserProfiles` row (with `NULL` values for `HomeTown`, `HomepageUrl`, and `Signature`).</span></span>

<span data-ttu-id="da843-481">[新しいユーザーアカウントと UserProfiles レコードが追加された ![](storing-additional-user-information-cs/_static/image59.png)](storing-additional-user-information-cs/_static/image58.png)</span><span class="sxs-lookup"><span data-stu-id="da843-481">[![A New User Account and UserProfiles Record Have Been Added](storing-additional-user-information-cs/_static/image59.png)](storing-additional-user-information-cs/_static/image58.png)</span></span>

<span data-ttu-id="da843-482">**図 20**: 新しいユーザーアカウントと `UserProfiles` レコードが追加されました ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image60.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-482">**Figure 20**: A New User Account and `UserProfiles` Record Have Been Added  ([Click to view full-size image](storing-additional-user-information-cs/_static/image60.png))</span></span>

<span data-ttu-id="da843-483">訪問者が新しいアカウント情報を入力し、[Create User] \ (ユーザーの作成 \) ボタンをクリックすると、ユーザーアカウントが作成され、`UserProfiles` テーブルに行が追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-483">After the visitor has supplied his new account information and clicked the "Create User" button, the user account is created and a row added to the `UserProfiles` table.</span></span> <span data-ttu-id="da843-484">その後、CreateUserWizard に `CompleteWizardStep`が表示され、成功メッセージと [続行] ボタンが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-484">The CreateUserWizard then displays its `CompleteWizardStep`, which displays a success message and a Continue button.</span></span> <span data-ttu-id="da843-485">[続行] ボタンをクリックするとポストバックが発生しますが、操作は行われず、ユーザーは `EnhancedCreateUserWizard.aspx` ページにスタックしたままになります。</span><span class="sxs-lookup"><span data-stu-id="da843-485">Clicking the Continue button causes a postback, but no action is taken, leaving the user stuck on the `EnhancedCreateUserWizard.aspx` page.</span></span>

<span data-ttu-id="da843-486">CreateUserWizard コントロールの[`ContinueDestinationPageUrl` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx)を使用して [続行] ボタンをクリックしたときに、ユーザーを送信する URL を指定できます。</span><span class="sxs-lookup"><span data-stu-id="da843-486">We can specify a URL to send the user to when the Continue button is clicked via the CreateUserWizard control's [`ContinueDestinationPageUrl` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx).</span></span> <span data-ttu-id="da843-487">[`ContinueDestinationPageUrl`] プロパティを "~/メンバーシップ/Additionaluserinfo.aspx" に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-487">Set the `ContinueDestinationPageUrl` property to "~/Membership/AdditionalUserInfo.aspx".</span></span> <span data-ttu-id="da843-488">これにより、新しいユーザーが `AdditionalUserInfo.aspx`し、設定を表示および更新できるようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-488">This takes the new user to `AdditionalUserInfo.aspx`, where they can view and update their settings.</span></span>

### <a name="customizing-the-createuserwizards-interface-to-prompt-for-the-new-users-home-town-homepage-and-signature"></a><span data-ttu-id="da843-489">CreateUserWizard のインターフェイスをカスタマイズして、新しいユーザーのホーム、ホームページ、署名を要求する</span><span class="sxs-lookup"><span data-stu-id="da843-489">Customizing the CreateUserWizard's Interface to Prompt for the New User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="da843-490">CreateUserWizard コントロールの既定のインターフェイスでは、ユーザー名、パスワード、電子メールなどのコアユーザーアカウント情報だけを収集する必要がある単純なアカウント作成シナリオに十分です。</span><span class="sxs-lookup"><span data-stu-id="da843-490">The CreateUserWizard control's default interface is sufficient for simple account creation scenarios where only core user account information like username, password, and email need be collected.</span></span> <span data-ttu-id="da843-491">では、アカウントの作成中に自宅の町、ホームページ、署名を入力するように求めるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-491">But what if we wanted to prompt the visitor to enter her home town, homepage, and signature while creating her account?</span></span> <span data-ttu-id="da843-492">CreateUserWizard コントロールのインターフェイスをカスタマイズしてサインアップ時に追加情報を収集することができます。この情報は、基になるデータベースに追加のレコードを挿入するために `CreatedUser` イベントハンドラーで使用される場合があります。</span><span class="sxs-lookup"><span data-stu-id="da843-492">It is possible to customize the CreateUserWizard control's interface to collect additional information at signup, and this information may be used in the `CreatedUser` event handler to insert additional records into the underlying database.</span></span>

<span data-ttu-id="da843-493">CreateUserWizard コントロールは、ページ開発者が一連の順序付けられた `WizardSteps`を定義できるコントロールである、ASP.NET Wizard コントロールを拡張します。</span><span class="sxs-lookup"><span data-stu-id="da843-493">The CreateUserWizard control extends the ASP.NET Wizard control, which is a control that allows a page developer to define a series of ordered `WizardSteps`.</span></span> <span data-ttu-id="da843-494">ウィザードコントロールは、アクティブなステップをレンダリングし、ビジターがこれらの手順を移動できるようにするナビゲーションインターフェイスを提供します。</span><span class="sxs-lookup"><span data-stu-id="da843-494">The Wizard control renders the active step and provides a navigation interface that allows the visitor to move through these steps.</span></span> <span data-ttu-id="da843-495">ウィザードコントロールは、長いタスクをいくつかの簡単な手順に分割するのに最適です。</span><span class="sxs-lookup"><span data-stu-id="da843-495">The Wizard control is ideal for breaking down a long task into several short steps.</span></span> <span data-ttu-id="da843-496">ウィザードコントロールの詳細については、「 [ASP.NET 2.0 ウィザードコントロールを使用したステップバイステップのユーザーインターフェイスの作成](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-496">For more information on the Wizard control, see [Creating a Step-by-Step User Interface with the ASP.NET 2.0 Wizard Control](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx).</span></span>

<span data-ttu-id="da843-497">CreateUserWizard コントロールの既定のマークアップは、`CreateUserWizardStep` と `CompleteWizardStep`の2つの `WizardSteps`を定義します。</span><span class="sxs-lookup"><span data-stu-id="da843-497">The CreateUserWizard control's default markup defines two `WizardSteps`: `CreateUserWizardStep` and `CompleteWizardStep`.</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample12.aspx)]

<span data-ttu-id="da843-498">最初の `WizardStep`、`CreateUserWizardStep`では、ユーザー名、パスワード、電子メールなどを要求するインターフェイスがレンダリングされます。</span><span class="sxs-lookup"><span data-stu-id="da843-498">The first `WizardStep`, `CreateUserWizardStep`, renders the interface that prompts for the username, password, email, and so on.</span></span> <span data-ttu-id="da843-499">訪問者がこの情報を提供し、[Create User (ユーザーの作成)] をクリックすると、`CompleteWizardStep`が表示され、成功メッセージと [続行] ボタンが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-499">After the visitor supplies this information and clicks "Create User", she is shown the `CompleteWizardStep`, which shows the success message and a Continue button.</span></span>

<span data-ttu-id="da843-500">追加のフォームフィールドを含めるように CreateUserWizard コントロールのインターフェイスをカスタマイズするには、次の操作を行います。</span><span class="sxs-lookup"><span data-stu-id="da843-500">To customize the CreateUserWizard control's interface to include additional form fields, we can:</span></span>

- <span data-ttu-id="da843-501"><strong>追加のユーザーインターフェイス要素が含まれるように、</strong> <strong>1 つまたは複数の新しい</strong><strong>`WizardStep`</strong>s を作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-501"><strong>Create one or more new</strong><strong>`WizardStep`</strong><strong>s to contain the additional user interface elements</strong>.</span></span> <span data-ttu-id="da843-502">新しい `WizardStep` を CreateUserWizard に追加するには、そのスマートタグから [`WizardSteps`の追加/削除] リンクをクリックして `WizardStep` コレクションエディターを起動します。</span><span class="sxs-lookup"><span data-stu-id="da843-502">To add a new `WizardStep` to the CreateUserWizard, click the "Add/Remove `WizardSteps`" link from its Smart Tag to launch the `WizardStep` Collection Editor.</span></span> <span data-ttu-id="da843-503">そこから、ウィザードの手順を追加、削除、または順序変更することができます。</span><span class="sxs-lookup"><span data-stu-id="da843-503">From there you can add, remove, or reorder the steps in the wizard.</span></span> <span data-ttu-id="da843-504">このチュートリアルで使用する方法を次に示します。</span><span class="sxs-lookup"><span data-stu-id="da843-504">This is the approach we will use for this tutorial.</span></span>

- <span data-ttu-id="da843-505"><strong>`CreateUserWizardStep`</strong>を<strong>編集可能な</strong><strong>`WizardStep`</strong>に変換<strong>します。</strong></span><span class="sxs-lookup"><span data-stu-id="da843-505"><strong>Convert the</strong><strong>`CreateUserWizardStep`</strong><strong>into an editable</strong><strong>`WizardStep`</strong><strong>.</strong></span></span> <span data-ttu-id="da843-506">これにより、`CreateUserWizardStep` が、`CreateUserWizardStep`のと一致するユーザーインターフェイスを定義するマークアップを持つ同等の `WizardStep` に置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="da843-506">This replaces the `CreateUserWizardStep` with an equivalent `WizardStep` whose markup defines a user interface that matches the `CreateUserWizardStep`'s.</span></span> <span data-ttu-id="da843-507">`CreateUserWizardStep` を `WizardStep` に変換することによって、コントロールの位置を変更したり、このステップにユーザーインターフェイス要素を追加したりできます。</span><span class="sxs-lookup"><span data-stu-id="da843-507">By converting the `CreateUserWizardStep` into a `WizardStep` we can reposition the controls or add additional user interface elements to this step.</span></span> <span data-ttu-id="da843-508">`CreateUserWizardStep` または `CompleteWizardStep` を編集可能な `WizardStep`に変換するには、コントロールのスマートタグから [ユーザーの作成手順をカスタマイズする] または [完了手順のカスタマイズ] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="da843-508">To convert the `CreateUserWizardStep` or `CompleteWizardStep` into an editable `WizardStep`, click the "Customize Create User Step" or "Customize Complete Step" link from the control's Smart Tag.</span></span>

- <span data-ttu-id="da843-509">**上記の2つのオプションの組み合わせを使用します。**</span><span class="sxs-lookup"><span data-stu-id="da843-509">**Use some combination of the above two options.**</span></span>

<span data-ttu-id="da843-510">注意すべき重要な点の1つは、CreateUserWizard コントロールが、`CreateUserWizardStep`内から [Create User] \ (ユーザーの作成 \) ボタンをクリックしたときに、ユーザーアカウントの作成プロセスを実行することです。</span><span class="sxs-lookup"><span data-stu-id="da843-510">One important thing to keep in mind is that the CreateUserWizard control executes its user account creation process when the "Create User" button is clicked from within its `CreateUserWizardStep`.</span></span> <span data-ttu-id="da843-511">`CreateUserWizardStep` の後に `WizardStep` が追加されているかどうかは関係ありません。</span><span class="sxs-lookup"><span data-stu-id="da843-511">It doesn't matter if there are additional `WizardStep` s after the `CreateUserWizardStep` or not.</span></span>

<span data-ttu-id="da843-512">追加のユーザー入力を収集するためにカスタム `WizardStep` を CreateUserWizard コントロールに追加する場合、カスタム `WizardStep` は `CreateUserWizardStep`の前または後に配置できます。</span><span class="sxs-lookup"><span data-stu-id="da843-512">When adding a custom `WizardStep` to the CreateUserWizard control to collect additional user input, the custom `WizardStep` can be placed before or after the `CreateUserWizardStep`.</span></span> <span data-ttu-id="da843-513">`CreateUserWizardStep` の前にある場合は、カスタム `WizardStep` から収集された追加のユーザー入力を `CreatedUser` イベントハンドラーで使用できます。</span><span class="sxs-lookup"><span data-stu-id="da843-513">If it comes before the `CreateUserWizardStep` then the additional user input collected from the custom `WizardStep` is available for the `CreatedUser` event handler.</span></span> <span data-ttu-id="da843-514">ただし、カスタム `WizardStep` が `CreateUserWizardStep` 後、カスタム `WizardStep` が表示されたときに、新しいユーザーアカウントが既に作成されており、`CreatedUser` イベントが既に発生しています。</span><span class="sxs-lookup"><span data-stu-id="da843-514">However, if the custom `WizardStep` comes after `CreateUserWizardStep` then by the time the custom `WizardStep` is displayed the new user account has already been created and the `CreatedUser` event has already fired.</span></span>

<span data-ttu-id="da843-515">図21は、追加された `WizardStep` が `CreateUserWizardStep`の前にある場合のワークフローを示しています。</span><span class="sxs-lookup"><span data-stu-id="da843-515">Figure 21 shows the workflow when the added `WizardStep` precedes the `CreateUserWizardStep`.</span></span> <span data-ttu-id="da843-516">追加のユーザー情報は `CreatedUser` イベントが発生した時点までに収集されているため、`CreatedUser` イベントハンドラーを更新してこれらの入力を取得し、`DBNull.Value`ではなく `INSERT` ステートメントのパラメーター値に使用するだけです。</span><span class="sxs-lookup"><span data-stu-id="da843-516">Since the additional user information has been collected by the time the `CreatedUser` event fires, all we have to do is update the `CreatedUser` event handler to retrieve these inputs and use those for the `INSERT` statement's parameter values (rather than `DBNull.Value`).</span></span>

<span data-ttu-id="da843-517">[追加の WizardStep が Createuserwizardstep.contenttemplate はの前にある場合は、CreateUserWizard ワークフローを ![します。](storing-additional-user-information-cs/_static/image62.png)](storing-additional-user-information-cs/_static/image61.png)</span><span class="sxs-lookup"><span data-stu-id="da843-517">[![The CreateUserWizard Workflow When an Additional WizardStep Precedes the CreateUserWizardStep](storing-additional-user-information-cs/_static/image62.png)](storing-additional-user-information-cs/_static/image61.png)</span></span>

<span data-ttu-id="da843-518">**図 21**: `WizardStep` が `CreateUserWizardStep` の前にある場合 ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image63.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-518">**Figure 21**: The CreateUserWizard Workflow When an Additional `WizardStep` Precedes the `CreateUserWizardStep` ([Click to view full-size image](storing-additional-user-information-cs/_static/image63.png))</span></span>

<span data-ttu-id="da843-519">ただし、`CreateUserWizardStep`の*後*にカスタム `WizardStep` が配置されている場合は、ユーザーが自宅の町、ホームページ、または署名を入力する前に、ユーザーアカウントの作成プロセスが実行されます。</span><span class="sxs-lookup"><span data-stu-id="da843-519">If the custom `WizardStep` is placed *after* the `CreateUserWizardStep`, however, the create user account process occurs before the user has had a chance to enter her home town, homepage, or signature.</span></span> <span data-ttu-id="da843-520">このような場合、図22に示すように、ユーザーアカウントが作成された後に、この追加情報をデータベースに挿入する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-520">In such a case, this additional information needs to be inserted into the database after the user account has been created, as Figure 22 illustrates.</span></span>

<span data-ttu-id="da843-521">[Createuserwizardstep.contenttemplate はの後に追加の WizardStep があるときに CreateUserWizard ワークフローを ![します。](storing-additional-user-information-cs/_static/image65.png)](storing-additional-user-information-cs/_static/image64.png)</span><span class="sxs-lookup"><span data-stu-id="da843-521">[![The CreateUserWizard Workflow When an Additional WizardStep Comes After the CreateUserWizardStep](storing-additional-user-information-cs/_static/image65.png)](storing-additional-user-information-cs/_static/image64.png)</span></span>

<span data-ttu-id="da843-522">**図 22**: `CreateUserWizardStep` の後に追加の `WizardStep` が発生した場合の CreateUserWizard のワークフロー ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image66.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-522">**Figure 22**: The CreateUserWizard Workflow When an Additional `WizardStep` Comes After the `CreateUserWizardStep` ([Click to view full-size image](storing-additional-user-information-cs/_static/image66.png))</span></span>

<span data-ttu-id="da843-523">図22に示すワークフローは、手順 2. が完了するまで、`UserProfiles` テーブルにレコードを挿入するのを待機します。</span><span class="sxs-lookup"><span data-stu-id="da843-523">The workflow shown in Figure 22 waits to insert a record into the `UserProfiles` table until after Step 2 completes.</span></span> <span data-ttu-id="da843-524">ただし、手順1の後にビジターがブラウザーを閉じると、ユーザーアカウントが作成されたが、`UserProfiles`にレコードが追加されなかったという状態になります。</span><span class="sxs-lookup"><span data-stu-id="da843-524">If the visitor closes her browser after step 1, however, we will have reached a state where a user account was created, but no record was added to `UserProfiles`.</span></span> <span data-ttu-id="da843-525">回避策の1つとして、`NULL` または既定値を持つレコードを `CreatedUser` イベントハンドラー (手順1の後に発生する) の `UserProfiles` に挿入して、手順 2. の完了後にこのレコードを更新します。</span><span class="sxs-lookup"><span data-stu-id="da843-525">One workaround is to have a record with `NULL` or default values inserted into `UserProfiles` in the `CreatedUser` event handler (which fires after step 1), and then update this record after step 2 completes.</span></span> <span data-ttu-id="da843-526">これにより、ユーザーが途中で登録プロセスを終了した場合でも、ユーザーアカウントの `UserProfiles` レコードが確実に追加されます。</span><span class="sxs-lookup"><span data-stu-id="da843-526">This ensures that a `UserProfiles` record will be added for the user account even if the user quits the registration process midway through.</span></span>

<span data-ttu-id="da843-527">このチュートリアルでは、`CreateUserWizardStep` の後、`CompleteWizardStep`の前に発生する新しい `WizardStep` を作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-527">For this tutorial let's create a new `WizardStep` that occurs after the `CreateUserWizardStep` but before the `CompleteWizardStep`.</span></span> <span data-ttu-id="da843-528">まず、WizardStep を設定して構成してから、コードを見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="da843-528">Let's first get the WizardStep in place and configured and then we'll look at the code.</span></span>

<span data-ttu-id="da843-529">CreateUserWizard コントロールのスマートタグから、[`WizardStep` の追加と削除] を選択すると、[`WizardStep` コレクションエディター] ダイアログが表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-529">From the CreateUserWizard control's Smart Tag, select the "Add/Remove `WizardStep` s", which brings up the `WizardStep` Collection Editor dialog.</span></span> <span data-ttu-id="da843-530">新しい `WizardStep`を追加し、その `ID` を `UserSettings`に設定します。その `Title` を "your Settings" に設定し、`StepType` を `Step`に設定します。</span><span class="sxs-lookup"><span data-stu-id="da843-530">Add a new `WizardStep`, setting its `ID` to `UserSettings`, its `Title` to "Your Settings" and its `StepType` to `Step`.</span></span> <span data-ttu-id="da843-531">次に、図23に示すように、`CreateUserWizardStep` ("新しいアカウントにサインアップする") の後、`CompleteWizardStep` ("Complete") の前に来るように配置します。</span><span class="sxs-lookup"><span data-stu-id="da843-531">Then position it so that it comes after the `CreateUserWizardStep` ("Sign Up for Your New Account") and before the `CompleteWizardStep` ("Complete"), as shown in Figure 23.</span></span>

<span data-ttu-id="da843-532">[新しい WizardStep を CreateUserWizard コントロールに追加 ![には](storing-additional-user-information-cs/_static/image68.png)](storing-additional-user-information-cs/_static/image67.png)</span><span class="sxs-lookup"><span data-stu-id="da843-532">[![Add a New WizardStep to the CreateUserWizard Control](storing-additional-user-information-cs/_static/image68.png)](storing-additional-user-information-cs/_static/image67.png)</span></span>

<span data-ttu-id="da843-533">**図 23**: CreateUserWizard コントロールに新しい `WizardStep` を追加する ([クリックすると、フルサイズの画像が表示](storing-additional-user-information-cs/_static/image69.png)されます)</span><span class="sxs-lookup"><span data-stu-id="da843-533">**Figure 23**: Add a New `WizardStep` to the CreateUserWizard Control  ([Click to view full-size image](storing-additional-user-information-cs/_static/image69.png))</span></span>

<span data-ttu-id="da843-534">[OK] をクリックして [`WizardStep` コレクションエディター] ダイアログボックスを閉じます。</span><span class="sxs-lookup"><span data-stu-id="da843-534">Click OK to close the `WizardStep` Collection Editor dialog.</span></span> <span data-ttu-id="da843-535">新しい `WizardStep` は、CreateUserWizard コントロールによって更新された宣言型マークアップによって、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-535">The new `WizardStep` is evidenced by the CreateUserWizard control's updated declarative markup:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample13.aspx)]

<span data-ttu-id="da843-536">新しい `<asp:WizardStep>` 要素に注意してください。</span><span class="sxs-lookup"><span data-stu-id="da843-536">Note the new `<asp:WizardStep>` element.</span></span> <span data-ttu-id="da843-537">ここでは、新しいユーザーのホームホーム、ホームページ、および署名を収集するために、ユーザーインターフェイスを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-537">We need to add the user interface to collect the new user's home town, homepage, and signature here.</span></span> <span data-ttu-id="da843-538">このコンテンツは、宣言構文またはデザイナーを使用して入力できます。</span><span class="sxs-lookup"><span data-stu-id="da843-538">You can enter this content in the declarative syntax or through the Designer.</span></span> <span data-ttu-id="da843-539">デザイナーを使用するには、スマートタグのドロップダウンリストから [自分の設定] ステップを選択して、デザイナーの手順を確認します。</span><span class="sxs-lookup"><span data-stu-id="da843-539">To use the Designer, select the "Your Settings" step from the drop-down list in the Smart Tag to see the step in the Designer.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-540">スマートタグのドロップダウンリストからステップを選択すると、CreateUserWizard コントロールの[`ActiveStepIndex` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx)が更新されます。このプロパティは、開始ステップのインデックスを指定します。</span><span class="sxs-lookup"><span data-stu-id="da843-540">Selecting a step through the Smart Tag's drop-down list updates the CreateUserWizard control's [`ActiveStepIndex` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx), which specifies the index of the starting step.</span></span> <span data-ttu-id="da843-541">このため、このドロップダウンリストを使用してデザイナーの "自分の設定" 手順を編集する場合は、ユーザーが最初に `EnhancedCreateUserWizard.aspx` ページにアクセスしたときにこの手順が表示されるように、必ず [新しいアカウントにサインアップする] に設定してください。</span><span class="sxs-lookup"><span data-stu-id="da843-541">Therefore, if you use this drop-down list to edit the "Your Settings" step in the Designer, be sure to set it back to "Sign Up for Your New Account" so that this step is shown when users first visit the `EnhancedCreateUserWizard.aspx` page.</span></span>

<span data-ttu-id="da843-542">`HomeTown`、`HomepageUrl`、`Signature`という3つのテキストボックスコントロールが含まれている [設定] ステップ内にユーザーインターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-542">Create a user interface within the "Your Settings" step that contains three TextBox controls named `HomeTown`, `HomepageUrl`, and `Signature`.</span></span> <span data-ttu-id="da843-543">このインターフェイスを構築した後、CreateUserWizard の宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da843-543">After constructing this interface, the CreateUserWizard's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample14.aspx)]

<span data-ttu-id="da843-544">ブラウザーを使用してこのページにアクセスし、新しいユーザーアカウントを作成して、ホーム、ホームページ、署名の値を指定します。</span><span class="sxs-lookup"><span data-stu-id="da843-544">Go ahead and visit this page through a browser and create a new user account, specifying values for the home town, homepage, and signature.</span></span> <span data-ttu-id="da843-545">`CreateUserWizardStep` 完了すると、メンバーシップフレームワークにユーザーアカウントが作成され、`CreatedUser` イベントハンドラーが実行されます。これにより `UserProfiles`に新しい行が追加されますが、`HomeTown`、`HomepageUrl`、`Signature`のデータベース `NULL` 値が使用されます。</span><span class="sxs-lookup"><span data-stu-id="da843-545">After completing the `CreateUserWizardStep` the user account is created in the Membership framework and the `CreatedUser` event handler runs, which adds a new row to `UserProfiles`, but with a database `NULL` value for `HomeTown`, `HomepageUrl`, and `Signature`.</span></span> <span data-ttu-id="da843-546">ホームの町、ホームページ、および署名に入力した値は使用されません。</span><span class="sxs-lookup"><span data-stu-id="da843-546">The values entered for the home town, homepage, and signature are never used.</span></span> <span data-ttu-id="da843-547">この結果、`HomeTown`、`HomepageUrl`、および `Signature` のフィールドが指定されていない `UserProfiles` レコードを持つ新しいユーザーアカウントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="da843-547">The net result is a new user account with a `UserProfiles` record whose `HomeTown`, `HomepageUrl`, and `Signature` fields have yet to be specified.</span></span>

<span data-ttu-id="da843-548">ユーザーによって入力されたホームの町、honepage、および署名の値を取得する "your Settings" 手順の後にコードを実行し、適切な `UserProfiles` レコードを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-548">We need to execute code after the "Your Settings" step that takes the home town, honepage, and signature values entered by the user and updates the appropriate `UserProfiles` record.</span></span> <span data-ttu-id="da843-549">ユーザーがウィザードコントロールのステップの間を移動するたびに、ウィザードの[`ActiveStepChanged` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx)が発生します。</span><span class="sxs-lookup"><span data-stu-id="da843-549">Each time the user moves between steps in a Wizard control, the Wizard's [`ActiveStepChanged` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx) fires.</span></span> <span data-ttu-id="da843-550">このイベントのイベントハンドラーを作成し、"設定" 手順が完了したら、`UserProfiles` テーブルを更新できます。</span><span class="sxs-lookup"><span data-stu-id="da843-550">We can create an event handler for this event and update the `UserProfiles` table when the "Your Settings" step has completed.</span></span>

<span data-ttu-id="da843-551">CreateUserWizard の `ActiveStepChanged` イベントのイベントハンドラーを追加し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="da843-551">Add an event handler for the CreateUserWizard's `ActiveStepChanged` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample15.cs)]

<span data-ttu-id="da843-552">上記のコードは、"Complete" 手順に到達したかどうかを判断することから始まります。</span><span class="sxs-lookup"><span data-stu-id="da843-552">The above code starts by determining if we have just reached the "Complete" step.</span></span> <span data-ttu-id="da843-553">"完了" の手順は、"設定" の手順の直後に実行されるので、訪問者が "完了" の手順に達したときに、彼女が "自分の設定" 手順を完了したことを意味します。</span><span class="sxs-lookup"><span data-stu-id="da843-553">Since the "Complete" step occurs immediately after the "Your Settings" step, then when the visitor reaches "Complete" step that means she just finished the "Your Settings" step.</span></span>

<span data-ttu-id="da843-554">このような場合は、`UserSettings WizardStep`内のテキストボックスコントロールをプログラムで参照する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da843-554">In such a case, we need to programmatically reference the TextBox controls within the `UserSettings WizardStep`.</span></span> <span data-ttu-id="da843-555">これを行うには、まず `FindControl` メソッドを使用してプログラムで `UserSettings WizardStep`を参照し、次に `WizardStep`内からテキストボックスを参照します。</span><span class="sxs-lookup"><span data-stu-id="da843-555">This is accomplished by first using the `FindControl` method to programmatically referencing the `UserSettings WizardStep`, and then again to reference the TextBoxes from within the `WizardStep`.</span></span> <span data-ttu-id="da843-556">テキストボックスが参照されたら、`UPDATE` ステートメントを実行する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="da843-556">Once the TextBoxes have been referenced, we're ready to execute the `UPDATE` statement.</span></span> <span data-ttu-id="da843-557">`UPDATE` ステートメントには、`CreatedUser` イベントハンドラーの `INSERT` ステートメントと同じ数のパラメーターがありますが、ここでは、ユーザーによって指定されたホームの町、ホームページ、および署名の値を使用します。</span><span class="sxs-lookup"><span data-stu-id="da843-557">The `UPDATE` statement has the same number of parameters as the `INSERT` statement in the `CreatedUser` event handler, but here we use the home town, homepage, and signature values supplied by the user.</span></span>

<span data-ttu-id="da843-558">このイベントハンドラーを配置したら、ブラウザーを使用して `EnhancedCreateUserWizard.aspx` のページにアクセスし、ホーム、ホームページ、および署名の値を指定する新しいユーザーアカウントを作成します。</span><span class="sxs-lookup"><span data-stu-id="da843-558">With this event handler in place, visit the `EnhancedCreateUserWizard.aspx` page through a browser and create a new user account specifying values for the home town, homepage, and signature.</span></span> <span data-ttu-id="da843-559">新しいアカウントを作成した後、[`AdditionalUserInfo.aspx`] ページにリダイレクトされます。ここには、入力した自宅の町、ホームページ、および署名情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="da843-559">After creating the new account you should be redirected to the `AdditionalUserInfo.aspx` page, where the just-entered home town, homepage, and signature information is displayed.</span></span>

> [!NOTE]
> <span data-ttu-id="da843-560">Web サイトには、現在、訪問者が新しいアカウントを作成するための2つのページ (`CreatingUserAccounts.aspx` と `EnhancedCreateUserWizard.aspx`) があります。</span><span class="sxs-lookup"><span data-stu-id="da843-560">Our website currently has two pages from which a visitor can create a new account: `CreatingUserAccounts.aspx` and `EnhancedCreateUserWizard.aspx`.</span></span> <span data-ttu-id="da843-561">Web サイトのサイトマップとログインページは `CreatingUserAccounts.aspx` ページを指していますが、[`CreatingUserAccounts.aspx`] ページでは、ユーザーに自宅の住所、ホームページ、および署名情報の入力を求めるメッセージは表示されず、対応する行は `UserProfiles`に追加されません。</span><span class="sxs-lookup"><span data-stu-id="da843-561">The website's sitemap and login page point to the `CreatingUserAccounts.aspx` page, but the `CreatingUserAccounts.aspx` page does not prompt the user for their home town, homepage, and signature information and does not add a corresponding row to `UserProfiles`.</span></span> <span data-ttu-id="da843-562">したがって、この機能を提供するように `CreatingUserAccounts.aspx` ページを更新するか、`CreatingUserAccounts.aspx`ではなく `EnhancedCreateUserWizard.aspx` を参照するように sitemap と login ページを更新してください。</span><span class="sxs-lookup"><span data-stu-id="da843-562">Therefore, either update the `CreatingUserAccounts.aspx` page so that it offers this functionality or update the sitemap and login page to reference `EnhancedCreateUserWizard.aspx` instead of `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="da843-563">後者のオプションを選択した場合は、匿名ユーザーが `EnhancedCreateUserWizard.aspx` ページにアクセスできるように、`Membership` フォルダーの `Web.config` ファイルを必ず更新してください。</span><span class="sxs-lookup"><span data-stu-id="da843-563">If you choose the latter option, be sure to update the `Membership` folder's `Web.config` file so as to allow anonymous users access to the `EnhancedCreateUserWizard.aspx` page.</span></span>

## <a name="summary"></a><span data-ttu-id="da843-564">要約</span><span class="sxs-lookup"><span data-stu-id="da843-564">Summary</span></span>

<span data-ttu-id="da843-565">このチュートリアルでは、メンバーシップフレームワーク内のユーザーアカウントに関連するデータをモデル化するための手法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="da843-565">In this tutorial we looked at techniques for modeling data that is related to user accounts within the Membership framework.</span></span> <span data-ttu-id="da843-566">特に、一対多のリレーションシップをユーザーアカウントと共有するエンティティと、一対一のリレーションシップを共有するデータをモデル化することを検討しました。</span><span class="sxs-lookup"><span data-stu-id="da843-566">In particular, we looked at modeling entities that share a one-to-many relationship with user accounts as well as data that shares a one-to-one relationship.</span></span> <span data-ttu-id="da843-567">さらに、この関連情報を表示、挿入、更新する方法についても説明しました。ここでは、SqlDataSource コントロールを使用した例と ADO.NET コードを使用したその他の例を紹介します。</span><span class="sxs-lookup"><span data-stu-id="da843-567">Furthermore, we saw how this related information could be displayed, inserted, and updated, with some examples using the SqlDataSource control and others using ADO.NET code.</span></span>

<span data-ttu-id="da843-568">このチュートリアルでは、ユーザーアカウントの概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-568">This tutorial completes our look at user accounts.</span></span> <span data-ttu-id="da843-569">次のチュートリアルでは、ロールに注目します。</span><span class="sxs-lookup"><span data-stu-id="da843-569">Starting with the next tutorial we will turn our attention to roles.</span></span> <span data-ttu-id="da843-570">次のいくつかのチュートリアルでは、ロールフレームワークについて説明します。新しいロールを作成する方法、ユーザーにロールを割り当てる方法、ユーザーが属するロールを確認する方法、およびロールベースの承認を適用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="da843-570">Over the next several tutorials we will look at the Roles framework, see how to create new roles, how to assign roles to users, how to determine what roles a user belongs to, and how to apply role-based authorization.</span></span>

<span data-ttu-id="da843-571">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="da843-571">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="da843-572">関連項目</span><span class="sxs-lookup"><span data-stu-id="da843-572">Further Reading</span></span>

<span data-ttu-id="da843-573">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="da843-573">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="da843-574">ASP.NET 2.0 でのデータへのアクセスと更新</span><span class="sxs-lookup"><span data-stu-id="da843-574">Accessing and Updating Data in ASP.NET 2.0</span></span>](http://aspnet.4guysfromrolla.com/articles/011106-1.aspx)
- [<span data-ttu-id="da843-575">ASP.NET 2.0 ウィザードコントロール</span><span class="sxs-lookup"><span data-stu-id="da843-575">ASP.NET 2.0 Wizard Control</span></span>](https://weblogs.asp.net/scottgu/archive/2006/02/21/438732.aspx)
- [<span data-ttu-id="da843-576">ASP.NET 2.0 Wizard コントロールを使用したステップバイステップのユーザーインターフェイスの作成</span><span class="sxs-lookup"><span data-stu-id="da843-576">Creating a Step-by-Step User Interface with the ASP.NET 2.0 Wizard Control</span></span>](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)
- [<span data-ttu-id="da843-577">カスタム DataSource コントロールパラメーターの作成</span><span class="sxs-lookup"><span data-stu-id="da843-577">Creating Custom DataSource Control Parameters</span></span>](http://aspnet.4guysfromrolla.com/articles/110106-1.aspx)
- [<span data-ttu-id="da843-578">CreateUserWizard コントロールのカスタマイズ</span><span class="sxs-lookup"><span data-stu-id="da843-578">Customizing the CreateUserWizard Control</span></span>](http://aspnet.4guysfromrolla.com/articles/070506-1.aspx)
- [<span data-ttu-id="da843-579">DetailsView コントロールのクイックスタート</span><span class="sxs-lookup"><span data-stu-id="da843-579">DetailsView Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/data/detailsview.aspx)
- [<span data-ttu-id="da843-580">ListView コントロールを使用したデータの表示</span><span class="sxs-lookup"><span data-stu-id="da843-580">Displaying Data with the ListView Control</span></span>](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)
- [<span data-ttu-id="da843-581">ASP.NET 2.0 の検証コントロールの解説</span><span class="sxs-lookup"><span data-stu-id="da843-581">Dissecting the Validation Controls in ASP.NET 2.0</span></span>](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)
- [<span data-ttu-id="da843-582">データの挿入と削除の編集</span><span class="sxs-lookup"><span data-stu-id="da843-582">Editing Insert and Deleting Data</span></span>](../../data-access/editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)
- [<span data-ttu-id="da843-583">ASP.NET でのフォームの検証</span><span class="sxs-lookup"><span data-stu-id="da843-583">Form Validation in ASP.NET</span></span>](http://www.4guysfromrolla.com/webtech/090200-1.shtml)
- [<span data-ttu-id="da843-584">カスタムユーザー登録情報を収集しています</span><span class="sxs-lookup"><span data-stu-id="da843-584">Gathering Custom User Registration Information</span></span>](https://weblogs.asp.net/scottgu/archive/2006/07/05/Tip_2F00_Trick_3A00_-Gathering-Custom-User-Registration-Information.aspx)
- [<span data-ttu-id="da843-585">ASP.NET 2.0 のプロファイル</span><span class="sxs-lookup"><span data-stu-id="da843-585">Profiles in ASP.NET 2.0</span></span>](http://www.odetocode.com/Articles/440.aspx)
- [<span data-ttu-id="da843-586">Asp: ListView コントロール</span><span class="sxs-lookup"><span data-stu-id="da843-586">The asp:ListView Control</span></span>](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)
- [<span data-ttu-id="da843-587">ユーザープロファイルのクイックスタート</span><span class="sxs-lookup"><span data-stu-id="da843-587">User Profiles QuickStart</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/profile/default.aspx)

### <a name="about-the-author"></a><span data-ttu-id="da843-588">作成者について</span><span class="sxs-lookup"><span data-stu-id="da843-588">About the Author</span></span>

<span data-ttu-id="da843-589">1998以降、Microsoft の Web テクノロジを使用して、Scott Mitchell (複数の ASP/創設者4GuysFromRolla.com の執筆者) が Microsoft の Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="da843-589">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="da843-590">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="da843-590">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="da843-591">彼の最新の書籍は *[、ASP.NET 2.0 を24時間以内に教え](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* ています。</span><span class="sxs-lookup"><span data-stu-id="da843-591">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="da843-592">Scott は、 [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)またはブログで[http://ScottOnWriting.NET](http://scottonwriting.net/)にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="da843-592">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="da843-593">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="da843-593">Special Thanks To…</span></span>

<span data-ttu-id="da843-594">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="da843-594">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="da843-595">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="da843-595">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="da843-596">その場合は、 [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)の行を削除します。</span><span class="sxs-lookup"><span data-stu-id="da843-596">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="da843-597">[前へ](user-based-authorization-cs.md)
> [次へ](creating-the-membership-schema-in-sql-server-vb.md)</span><span class="sxs-lookup"><span data-stu-id="da843-597">[Previous](user-based-authorization-cs.md)
[Next](creating-the-membership-schema-in-sql-server-vb.md)</span></span>
