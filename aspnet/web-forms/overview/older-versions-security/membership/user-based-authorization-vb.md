---
uid: web-forms/overview/older-versions-security/membership/user-based-authorization-vb
title: ユーザーベースの承認 (VB) |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、ページへのアクセスを制限し、さまざまな手法によってページレベルの機能を制限する方法について説明します。
ms.author: riande
ms.date: 01/18/2008
ms.assetid: bc937e9d-5c14-4fc4-aec7-440da924dd18
msc.legacyurl: /web-forms/overview/older-versions-security/membership/user-based-authorization-vb
msc.type: authoredcontent
ms.openlocfilehash: dfac0c6fa955e59c6ea996533f2447e89ec8d468
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74587903"
---
# <a name="user-based-authorization-vb"></a><span data-ttu-id="d37d2-103">ユーザー ベースの承認 (VB)</span><span class="sxs-lookup"><span data-stu-id="d37d2-103">User-Based Authorization (VB)</span></span>

<span data-ttu-id="d37d2-104">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d37d2-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d37d2-105">[コードのダウンロード](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_VB.zip)または[PDF のダウンロード](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_vb.pdf)</span><span class="sxs-lookup"><span data-stu-id="d37d2-105">[Download Code](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_VB.zip) or [Download PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_vb.pdf)</span></span>

> <span data-ttu-id="d37d2-106">このチュートリアルでは、ページへのアクセスを制限し、さまざまな手法によってページレベルの機能を制限する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-106">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span>

## <a name="introduction"></a><span data-ttu-id="d37d2-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="d37d2-107">Introduction</span></span>

<span data-ttu-id="d37d2-108">ユーザーアカウントを提供するほとんどの web アプリケーションでは、特定の訪問者がサイト内の特定のページにアクセスできないように制限します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-108">Most web applications that offer user accounts do so in part to restrict certain visitors from accessing certain pages within the site.</span></span> <span data-ttu-id="d37d2-109">ほとんどのオンラインの messageboard サイトでは、たとえば、すべてのユーザー (匿名および認証済み) は messageboard の投稿を表示できますが、web ページにアクセスして新しい投稿を作成できるのは、認証されたユーザーのみです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-109">In most online messageboard sites, for example, all users - anonymous and authenticated - are able to view the messageboard's posts, but only authenticated users can visit the web page to create a new post.</span></span> <span data-ttu-id="d37d2-110">また、特定のユーザー (または特定のユーザーのセット) だけがアクセスできる管理ページがある場合もあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-110">And there may be administrative pages that are only accessible to a particular user (or a particular set of users).</span></span> <span data-ttu-id="d37d2-111">さらに、ページレベルの機能はユーザーごとに異なる場合があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-111">Moreover, page-level functionality can differ on a user-by-user basis.</span></span> <span data-ttu-id="d37d2-112">投稿の一覧を表示すると、認証されたユーザーには各投稿を評価するためのインターフェイスが表示されますが、このインターフェイスは匿名訪問者には使用できません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-112">When viewing a list of posts, authenticated users are shown an interface for rating each post, whereas this interface is not available to anonymous visitors.</span></span>

<span data-ttu-id="d37d2-113">ASP.NET を使用すると、ユーザーベースの承認規則を簡単に定義できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-113">ASP.NET makes it easy to define user-based authorization rules.</span></span> <span data-ttu-id="d37d2-114">`Web.config`の単なるマークアップでは、特定の web ページまたはディレクトリ全体をロックダウンして、指定したユーザーのサブセットだけにアクセスできるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-114">With just a bit of markup in `Web.config`, specific web pages or entire directories can be locked down so that they are only accessible to a specified subset of users.</span></span> <span data-ttu-id="d37d2-115">ページレベルの機能は、現在ログインしているユーザーに基づいて、プログラムおよび宣言的な方法で有効または無効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-115">Page-level functionality can be turned on or off based on the currently logged in user through programmatic and declarative means.</span></span>

<span data-ttu-id="d37d2-116">このチュートリアルでは、ページへのアクセスを制限し、さまざまな手法によってページレベルの機能を制限する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-116">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span> <span data-ttu-id="d37d2-117">では、始めましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-117">Let's get started!</span></span>

## <a name="a-look-at-the-url-authorization-workflow"></a><span data-ttu-id="d37d2-118">URL 承認ワークフローの概要</span><span class="sxs-lookup"><span data-stu-id="d37d2-118">A Look at the URL Authorization Workflow</span></span>

<span data-ttu-id="d37d2-119">[ *「フォーム認証の概要*](../introduction/an-overview-of-forms-authentication-vb.md)」のチュートリアルで説明したように、ASP.NET ランタイムが ASP.NET リソースの要求を処理すると、その要求によって、そのライフサイクル中に多数のイベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-119">As discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-vb.md) tutorial, when the ASP.NET runtime processes a request for an ASP.NET resource the request raises a number of events during its lifecycle.</span></span> <span data-ttu-id="d37d2-120">*HTTP モジュール*は、要求ライフサイクル内の特定のイベントに応答して実行されるコードを持つマネージクラスです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-120">*HTTP Modules* are managed classes whose code is executed in response to a particular event in the request lifecycle.</span></span> <span data-ttu-id="d37d2-121">ASP.NET には、バックグラウンドで重要なタスクを実行する多数の HTTP モジュールが付属しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-121">ASP.NET ships with a number of HTTP Modules that perform essential tasks behind the scenes.</span></span>

<span data-ttu-id="d37d2-122">このような HTTP モジュールの1つは[`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-122">One such HTTP Module is [`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx).</span></span> <span data-ttu-id="d37d2-123">前のチュートリアルで説明したように、`FormsAuthenticationModule` の主な機能は、現在の要求の id を特定することです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-123">As discussed in previous tutorials, the primary function of the `FormsAuthenticationModule` is to determine the identity of the current request.</span></span> <span data-ttu-id="d37d2-124">これは、cookie に配置されているか、URL 内に埋め込まれているフォーム認証チケットを検査することで実現されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-124">This is accomplished by inspecting the forms authentication ticket, which is either located in a cookie or embedded within the URL.</span></span> <span data-ttu-id="d37d2-125">この id は[`AuthenticateRequest` イベントの発生](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)時に行われます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-125">This identification takes place during the [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx).</span></span>

<span data-ttu-id="d37d2-126">もう1つの重要な HTTP モジュールは、 [`AuthorizeRequest` イベント](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)(`AuthenticateRequest` イベントの後に発生する) に応答して発生する[`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-126">Another important HTTP Module is the [`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx), which is raised in response to the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx) (which happens after the `AuthenticateRequest` event).</span></span> <span data-ttu-id="d37d2-127">`UrlAuthorizationModule` は `Web.config` の構成マークアップを調べて、現在の id に指定されたページにアクセスする権限があるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-127">The `UrlAuthorizationModule` examines configuration markup in `Web.config` to determine whether the current identity has authority to visit the specified page.</span></span> <span data-ttu-id="d37d2-128">このプロセスは、 *URL 承認*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-128">This process is referred to as *URL authorization*.</span></span>

<span data-ttu-id="d37d2-129">ここでは、手順 1. の URL 承認規則の構文について説明しますが、まず、要求が承認されているかどうかに応じて、`UrlAuthorizationModule` の動作を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-129">We'll examine the syntax for the URL authorization rules in Step 1, but first let's look at what the `UrlAuthorizationModule` does depending on whether the request is authorized or not.</span></span> <span data-ttu-id="d37d2-130">要求が承認されていることが `UrlAuthorizationModule` によって判断された場合は、何も実行されず、要求はそのライフサイクルを通じて続行されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-130">If the `UrlAuthorizationModule` determines that the request is authorized, then it does nothing, and the request continues through its lifecycle.</span></span> <span data-ttu-id="d37d2-131">ただし、要求が承認されて*いない*場合、`UrlAuthorizationModule` は、ライフサイクルを中止し、`Response` オブジェクトに対して[HTTP 401 の未承認](http://www.checkupdown.com/status/E401.html)ステータスを返すように指示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-131">However, if the request is *not* authorized, then the `UrlAuthorizationModule` aborts the lifecycle and instructs the `Response` object to return an [HTTP 401 Unauthorized](http://www.checkupdown.com/status/E401.html) status.</span></span> <span data-ttu-id="d37d2-132">フォーム認証を使用する場合、この HTTP 401 ステータスはクライアントに返されません。これは、`FormsAuthenticationModule` が HTTP 401 の状態を検出した場合、はログインページに[リダイレクト 302](http://www.checkupdown.com/status/E302.html)されるためです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-132">When using forms authentication this HTTP 401 status is never returned to the client because if the `FormsAuthenticationModule` detects an HTTP 401 status is modifies it to an [HTTP 302 Redirect](http://www.checkupdown.com/status/E302.html) to the login page.</span></span>

<span data-ttu-id="d37d2-133">図1は、承認されていない要求が到着したときの、ASP.NET パイプライン、`FormsAuthenticationModule`、`UrlAuthorizationModule` のワークフローを示しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-133">Figure 1 illustrates the workflow of the ASP.NET pipeline, the `FormsAuthenticationModule`, and the `UrlAuthorizationModule` when an unauthorized request arrives.</span></span> <span data-ttu-id="d37d2-134">特に、図1は `ProtectedPage.aspx`の匿名ビジターによる要求を示しています。これは、匿名ユーザーへのアクセスを拒否するページです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-134">In particular, Figure 1 shows a request by an anonymous visitor for `ProtectedPage.aspx`, which is a page that denies access to anonymous users.</span></span> <span data-ttu-id="d37d2-135">ビジターが匿名であるため、`UrlAuthorizationModule` によって要求が中止され、HTTP 401 の未承認ステータスが返されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-135">Since the visitor is anonymous, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="d37d2-136">`FormsAuthenticationModule` は、401の状態を302リダイレクトにログインページに変換します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-136">The `FormsAuthenticationModule` then converts the 401 status into a 302 Redirect to login page.</span></span> <span data-ttu-id="d37d2-137">ログインページを使用して認証されたユーザーは、`ProtectedPage.aspx`にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-137">After the user is authenticated via the login page, he is redirected to `ProtectedPage.aspx`.</span></span> <span data-ttu-id="d37d2-138">今回は、`FormsAuthenticationModule` は自分の認証チケットに基づいてユーザーを識別します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-138">This time the `FormsAuthenticationModule` identifies the user based on his authentication ticket.</span></span> <span data-ttu-id="d37d2-139">ビジターが認証されたので、`UrlAuthorizationModule` はページへのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-139">Now that the visitor is authenticated, the `UrlAuthorizationModule` permits access to the page.</span></span>

<span data-ttu-id="d37d2-140">[フォーム認証と URL 承認ワークフローの ![](user-based-authorization-vb/_static/image2.png)](user-based-authorization-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-140">[![The Forms Authentication and URL Authorization Workflow](user-based-authorization-vb/_static/image2.png)](user-based-authorization-vb/_static/image1.png)</span></span>

<span data-ttu-id="d37d2-141">**図 1**: フォーム認証と URL 承認のワークフロー ([クリックすると、フルサイズのイメージが表示](user-based-authorization-vb/_static/image3.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-141">**Figure 1**: The Forms Authentication and URL Authorization Workflow  ([Click to view full-size image](user-based-authorization-vb/_static/image3.png))</span></span>

<span data-ttu-id="d37d2-142">図1は、匿名ユーザーが匿名ユーザーには使用できないリソースにアクセスしようとしたときに発生する相互作用を示しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-142">Figure 1 depicts the interaction that occurs when an anonymous visitor attempts to access a resource that is not available to anonymous users.</span></span> <span data-ttu-id="d37d2-143">このような場合、匿名ビジターは、クエリ文字列で指定されたアクセスを試みたページでログインページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-143">In such a case, the anonymous visitor is redirected to the login page with the page she attempted to visit specified in the querystring.</span></span> <span data-ttu-id="d37d2-144">ユーザーが正常にログオンすると、最初に表示しようとしていたリソースに自動的にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-144">Once the user has successfully logged on, she will be automatically redirected back to the resource she was initially attempting to view.</span></span>

<span data-ttu-id="d37d2-145">匿名ユーザーによって承認されていない要求が行われた場合、このワークフローは簡単であり、ユーザーが何が起こったかとその理由を簡単に把握できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-145">When the unauthorized request is made by an anonymous user, this workflow is straightforward and is easy for the visitor to understand what has happened and why.</span></span> <span data-ttu-id="d37d2-146">ただし、認証されたユーザーによって要求が行われた場合でも、`FormsAuthenticationModule` によって、承認されていないユーザーがログインページ*にリダイレクトさ*れることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-146">But keep in mind that the `FormsAuthenticationModule` will redirect *any* unauthorized user to the login page, even if the request is made by an authenticated user.</span></span> <span data-ttu-id="d37d2-147">認証されたユーザーが権限を持っていないページにアクセスしようとすると、ユーザーエクスペリエンスが混乱する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-147">This can result in a confusing user experience if an authenticated user attempts to visit a page for which she lacks authority.</span></span>

<span data-ttu-id="d37d2-148">Web サイトの URL 承認規則が構成されているとします。これにより、ASP.NET ページ `OnlyTito.aspx` が accessibly ではないようになりました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-148">Imagine that our website had its URL authorization rules configured such that the ASP.NET page `OnlyTito.aspx` was accessibly only to Tito.</span></span> <span data-ttu-id="d37d2-149">ここで、Sam がサイトにアクセスし、ログオンして、`OnlyTito.aspx`にアクセスしようとするとします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-149">Now, imagine that Sam visits the site, logs on, and then attempts to visit `OnlyTito.aspx`.</span></span> <span data-ttu-id="d37d2-150">`UrlAuthorizationModule` は、要求のライフサイクルを停止し、HTTP 401 の許可されていない状態を返します。この状態は、`FormsAuthenticationModule` が検出し、ログインページに Sam をリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-150">The `UrlAuthorizationModule` will halt the request lifecycle and return an HTTP 401 Unauthorized status, which the `FormsAuthenticationModule` will detect and then redirect Sam to the login page.</span></span> <span data-ttu-id="d37d2-151">Sam は既にログインしているため、ログインページに返送された理由を不思議に思うかもしれません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-151">Since Sam has already logged in, though, she may wonder why she has been sent back to the login page.</span></span> <span data-ttu-id="d37d2-152">ログイン資格情報がなんらかの理由で失われたか、または無効な資格情報を入力したことが考えられます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-152">She might reason that her login credentials were lost somehow, or that she entered invalid credentials.</span></span> <span data-ttu-id="d37d2-153">Sam がログインページから資格情報を入力すると、その資格情報が再度ログオンし、`OnlyTito.aspx`にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-153">If Sam reenters her credentials from the login page she will be logged on (again) and redirected to `OnlyTito.aspx`.</span></span> <span data-ttu-id="d37d2-154">`UrlAuthorizationModule` は、Sam がこのページにアクセスできないことを検出し、ログインページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-154">The `UrlAuthorizationModule` will detect that Sam cannot visit this page and she will be returned to the login page.</span></span>

<span data-ttu-id="d37d2-155">図2は、この混乱を招くワークフローを示しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-155">Figure 2 depicts this confusing workflow.</span></span>

<span data-ttu-id="d37d2-156">[既定のワークフローを ![と、混乱を招く可能性があります。](user-based-authorization-vb/_static/image5.png)](user-based-authorization-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-156">[![The Default Workflow Can Lead to a Confusing Cycle](user-based-authorization-vb/_static/image5.png)](user-based-authorization-vb/_static/image4.png)</span></span>

<span data-ttu-id="d37d2-157">**図 2**: 既定のワークフローが混乱を招く可能性があります ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-157">**Figure 2**: The Default Workflow Can Lead to a Confusing Cycle  ([Click to view full-size image](user-based-authorization-vb/_static/image6.png))</span></span>

<span data-ttu-id="d37d2-158">図2に示されているワークフローを使用すると、コンピューターの知識の高い訪問者でもすぐに befuddle ことができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-158">The workflow illustrated in Figure 2 can quickly befuddle even the most computer savvy visitor.</span></span> <span data-ttu-id="d37d2-159">ここでは、手順 2. で混乱を防ぐ方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-159">We will look at ways to prevent this confusing cycle in Step 2.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-160">ASP.NET は、URL 承認とファイル承認という2つのメカニズムを使用して、現在のユーザーが特定の web ページにアクセスできるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-160">ASP.NET uses two mechanisms to determine whether the current user can access a particular web page: URL authorization and file authorization.</span></span> <span data-ttu-id="d37d2-161">ファイルの承認は[`FileAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx)によって実装され、要求されたファイルの acl をコンサルティングすることによって権限を決定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-161">File authorization is implemented by the [`FileAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx), which determines authority by consulting the requested file(s) ACLs.</span></span> <span data-ttu-id="d37d2-162">Acl は Windows アカウントに適用されるアクセス許可であるため、ファイル承認は Windows 認証で最も一般的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-162">File authorization is most commonly used with Windows authentication because ACLs are permissions that apply to Windows accounts.</span></span> <span data-ttu-id="d37d2-163">フォーム認証を使用する場合、すべてのオペレーティングシステムとファイルシステムレベルの要求は、サイトにアクセスしているユーザーに関係なく、同じ Windows アカウントによって実行されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-163">When using forms authentication, all operating system- and file system-level requests are executed by the same Windows account, regardless of the user visiting the site.</span></span> <span data-ttu-id="d37d2-164">このチュートリアルシリーズではフォーム認証に焦点を当てているため、ファイル承認については説明しません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-164">Since this tutorial series focuses on forms authentication, we will not be discussing file authorization.</span></span>

### <a name="the-scope-of-url-authorization"></a><span data-ttu-id="d37d2-165">URL 承認のスコープ</span><span class="sxs-lookup"><span data-stu-id="d37d2-165">The Scope of URL Authorization</span></span>

<span data-ttu-id="d37d2-166">`UrlAuthorizationModule` は、ASP.NET ランタイムの一部であるマネージコードです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-166">The `UrlAuthorizationModule` is managed code that is part of the ASP.NET runtime.</span></span> <span data-ttu-id="d37d2-167">Microsoft の[インターネットインフォメーションサービス (iis)](https://www.iis.net/) web サーバーのバージョン7より前では、IIS の HTTP パイプラインと ASP.NET ランタイムのパイプラインの間には個別のバリアがありました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-167">Prior to version 7 of Microsoft's [Internet Information Services (IIS)](https://www.iis.net/) web server, there was a distinct barrier between IIS's HTTP pipeline and the ASP.NET runtime's pipeline.</span></span> <span data-ttu-id="d37d2-168">つまり、IIS 6 以前の ASP では、NET の `UrlAuthorizationModule` は、要求が IIS から ASP.NET ランタイムに委任された場合にのみ実行されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-168">In short, in IIS 6 and earlier, ASP.NET's `UrlAuthorizationModule` only executes when a request is delegated from IIS to the ASP.NET runtime.</span></span> <span data-ttu-id="d37d2-169">既定では、IIS は静的なコンテンツ自体 (HTML ページ、CSS、JavaScript、イメージファイルなど) を処理し、`.aspx`、`.asmx`、または `.ashx` の拡張機能を持つページが要求された場合にのみ、ASP.NET ランタイムに要求を渡します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-169">By default, IIS processes static content itself - like HTML pages and CSS, JavaScript, and image files - and only hands off requests to the ASP.NET runtime when a page with an extension of `.aspx`, `.asmx`, or `.ashx` is requested.</span></span>

<span data-ttu-id="d37d2-170">ただし、IIS 7 では、IIS と ASP.NET の統合パイプラインを使用できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-170">IIS 7, however, allows for integrated IIS and ASP.NET pipelines.</span></span> <span data-ttu-id="d37d2-171">いくつかの構成設定を使用して、IIS 7 をセットアップして*すべて*の要求の `UrlAuthorizationModule` を呼び出すことができます。つまり、URL 承認規則を任意の種類のファイルに対して定義できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-171">With a few configuration settings you can setup IIS 7 to invoke the `UrlAuthorizationModule` for *all* requests, meaning that URL authorization rules can be defined for files of any type.</span></span> <span data-ttu-id="d37d2-172">さらに、IIS 7 には、独自の URL 承認エンジンも含まれています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-172">Additionally, IIS 7 includes its own URL authorization engine.</span></span> <span data-ttu-id="d37d2-173">ASP.NET 統合と IIS 7 のネイティブ URL 承認機能の詳細については、「 [IIS7 Url 承認につい](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization)て」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-173">For more information on ASP.NET integration and IIS 7's native URL authorization functionality, see [Understanding IIS7 URL Authorization](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).</span></span> <span data-ttu-id="d37d2-174">ASP.NET と IIS 7 の統合の詳細については、Shahram Khosravi の書籍、 *PROFESSIONAL IIS 7、ASP.NET Integrated プログラミング*(ISBN: 978-0470152539) のコピーを参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-174">For a more in-depth look at ASP.NET and IIS 7 integration, pick up a copy of Shahram Khosravi's book, *Professional IIS 7 and ASP.NET Integrated Programming* (ISBN: 978-0470152539).</span></span>

<span data-ttu-id="d37d2-175">簡単に言うと、IIS 7 より前のバージョンでは、URL 承認規則は ASP.NET ランタイムによって処理されるリソースにのみ適用されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-175">In a nutshell, in versions prior to IIS 7, URL authorization rules are only applied to resources handled by the ASP.NET runtime.</span></span> <span data-ttu-id="d37d2-176">ただし、IIS 7 では、IIS のネイティブ URL 承認機能を使用することも、ASP を統合することもできます。NET は IIS の HTTP パイプラインに `UrlAuthorizationModule` し、この機能をすべての要求に拡張します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-176">But with IIS 7 it is possible to use IIS's native URL authorization feature or to integrate ASP.NET's `UrlAuthorizationModule` into IIS's HTTP pipeline, thereby extending this functionality to all requests.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-177">ASP の方法には、いくつかの重要な相違点があります。NET の `UrlAuthorizationModule` および IIS 7 の URL 承認機能によって、承認規則が処理されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-177">There are some subtle yet important differences in how ASP.NET's `UrlAuthorizationModule` and IIS 7's URL authorization feature process the authorization rules.</span></span> <span data-ttu-id="d37d2-178">このチュートリアルでは、IIS 7 の URL 承認機能や、`UrlAuthorizationModule`と比較して承認規則を解析する方法の違いについては説明しません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-178">This tutorial does not examine IIS 7's URL authorization functionality or the differences in how it parses authorization rules compared to the `UrlAuthorizationModule`.</span></span> <span data-ttu-id="d37d2-179">これらのトピックの詳細については、MSDN または[www.iis.net](https://www.iis.net/)の IIS 7 のドキュメントを参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-179">For more information on these topics, refer to the IIS 7 documentation on MSDN or at [www.iis.net](https://www.iis.net/).</span></span>

## <a name="step-1-defining-url-authorization-rules-inwebconfig"></a><span data-ttu-id="d37d2-180">手順 1:`Web.config` で URL 承認規則を定義する</span><span class="sxs-lookup"><span data-stu-id="d37d2-180">Step 1: Defining URL Authorization Rules in`Web.config`</span></span>

<span data-ttu-id="d37d2-181">`UrlAuthorizationModule` は、アプリケーションの構成で定義されている URL 承認規則に基づいて、特定の id に対して要求されたリソースへのアクセスを許可するか拒否するかを決定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-181">The `UrlAuthorizationModule` determines whether to grant or deny access to a requested resource for a particular identity based on the URL authorization rules defined in the application's configuration.</span></span> <span data-ttu-id="d37d2-182">承認規則は、`<allow>` と `<deny>` の子要素の形式で[`<authorization>` 要素](https://msdn.microsoft.com/library/8d82143t.aspx)に記載されています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-182">The authorization rules are spelled out in the [`<authorization>` element](https://msdn.microsoft.com/library/8d82143t.aspx) in the form of `<allow>` and `<deny>` child elements.</span></span> <span data-ttu-id="d37d2-183">各 `<allow>` および `<deny>` 子要素は、次の項目を指定できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-183">Each `<allow>` and `<deny>` child element can specify:</span></span>

- <span data-ttu-id="d37d2-184">特定のユーザー</span><span class="sxs-lookup"><span data-stu-id="d37d2-184">A particular user</span></span>
- <span data-ttu-id="d37d2-185">コンマで区切られたユーザーの一覧</span><span class="sxs-lookup"><span data-stu-id="d37d2-185">A comma-delimited list of users</span></span>
- <span data-ttu-id="d37d2-186">すべての匿名ユーザー (疑問符 (?) で示される)</span><span class="sxs-lookup"><span data-stu-id="d37d2-186">All anonymous users, denoted by a question mark (?)</span></span>
- <span data-ttu-id="d37d2-187">アスタリスク (\*) で示されるすべてのユーザー</span><span class="sxs-lookup"><span data-stu-id="d37d2-187">All users, denoted by an asterisk (\*)</span></span>

<span data-ttu-id="d37d2-188">次のマークアップは、URL 承認規則を使用して、ユーザーに Tito と Scott を許可し、他のすべての操作を拒否できるようにする方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-188">The following markup illustrates how to use the URL authorization rules to allow users Tito and Scott and deny all others:</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample1.xml)]

<span data-ttu-id="d37d2-189">`<allow>` 要素は、ユーザーが許可されているユーザー (Tito と Scott-) を定義します。一方、`<deny>` 要素は、*すべて*のユーザーを拒否するように指示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-189">The `<allow>` element defines what users are permitted - Tito and Scott - while the `<deny>` element instructs that *all* users are denied.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-190">`<allow>` 要素と `<deny>` 要素では、ロールの承認規則を指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-190">The `<allow>` and `<deny>` elements can also specify authorization rules for roles.</span></span> <span data-ttu-id="d37d2-191">ロールベースの承認については、今後のチュートリアルで確認します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-191">We will examine role-based authorization in a future tutorial.</span></span>

<span data-ttu-id="d37d2-192">次の設定は、Sam 以外のユーザー (匿名訪問者を含む) へのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-192">The following setting grants access to anyone other than Sam (including anonymous visitors):</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample2.xml)]

<span data-ttu-id="d37d2-193">認証されたユーザーのみを許可するには、次の構成を使用します。これにより、すべての匿名ユーザーへのアクセスが拒否されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-193">To allow only authenticated users, use the following configuration, which denies access to all anonymous users:</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample3.xml)]

<span data-ttu-id="d37d2-194">承認規則は `Web.config` の `<system.web>` 要素内で定義され、web アプリケーション内のすべての ASP.NET リソースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-194">The authorization rules are defined within the `<system.web>` element in `Web.config` and apply to all of the ASP.NET resources in the web application.</span></span> <span data-ttu-id="d37d2-195">多くの場合、アプリケーションには異なるセクションに対して異なる承認規則があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-195">Oftentimes, an application has different authorization rules for different sections.</span></span> <span data-ttu-id="d37d2-196">たとえば、e コマースサイトでは、すべての訪問者が製品を調べたり、製品レビューを参照したり、カタログを検索したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-196">For example, at an eCommerce site, all visitors may peruse the products, see product reviews, search the catalog, and so on.</span></span> <span data-ttu-id="d37d2-197">ただし、認証されたユーザーのみがチェックアウトに到着したり、1つの出荷履歴を管理するためのページが表示されたりする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-197">However, only authenticated users may reach the checkout or the pages to manage one's shipping history.</span></span> <span data-ttu-id="d37d2-198">また、サイトの一部が、サイト管理者などの選択したユーザーのみがアクセスできるようになる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-198">Moreover, there may be portions of the site that are only accessible by select users, such as site administrators.</span></span>

<span data-ttu-id="d37d2-199">ASP.NET を使用すると、サイト内のさまざまなファイルやフォルダーに対して異なる承認規則を簡単に定義できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-199">ASP.NET makes it easy to define different authorization rules for different files and folders in the site.</span></span> <span data-ttu-id="d37d2-200">ルートフォルダーの `Web.config` ファイルに指定されている承認規則は、サイト内のすべての ASP.NET リソースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-200">The authorization rules specified in the root folder's `Web.config` file apply to all ASP.NET resources in the site.</span></span> <span data-ttu-id="d37d2-201">ただし、これらの既定の承認設定は、`<authorization>` セクションを持つ `Web.config` を追加することで、特定のフォルダーに対してオーバーライドできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-201">However, these default authorization settings can be overridden for a particular folder by adding a `Web.config` with an `<authorization>` section.</span></span>

<span data-ttu-id="d37d2-202">認証されたユーザーのみが `Membership` フォルダー内の ASP.NET ページにアクセスできるように web サイトを更新してみましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-202">Let's update our website so that only authenticated users can visit the ASP.NET pages in the `Membership` folder.</span></span> <span data-ttu-id="d37d2-203">これを行うには、`Membership` フォルダーに `Web.config` ファイルを追加し、その承認設定を匿名ユーザーを拒否するように設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-203">To accomplish this we need to add a `Web.config` file to the `Membership` folder and set its authorization settings to deny anonymous users.</span></span> <span data-ttu-id="d37d2-204">ソリューションエクスプローラーで `Membership` フォルダーを右クリックし、コンテキストメニューの [新しい項目の追加] メニューをクリックして、`Web.config`という名前の新しい Web 構成ファイルを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-204">Right-click the `Membership` folder in the Solution Explorer, choose the Add New Item menu from the context menu, and add a new Web Configuration File named `Web.config`.</span></span>

<span data-ttu-id="d37d2-205">[メンバーシップフォルダーに web.config ファイルを追加 ![には](user-based-authorization-vb/_static/image8.png)](user-based-authorization-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-205">[![Add a Web.config File to the Membership Folder](user-based-authorization-vb/_static/image8.png)](user-based-authorization-vb/_static/image7.png)</span></span>

<span data-ttu-id="d37d2-206">**図 3**: `Membership` フォルダーに `Web.config` ファイルを追加する ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image9.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-206">**Figure 3**: Add a `Web.config` File to the `Membership` Folder  ([Click to view full-size image](user-based-authorization-vb/_static/image9.png))</span></span>

<span data-ttu-id="d37d2-207">この時点で、プロジェクトには2つの `Web.config` ファイルが含まれている必要があります。1つはルートディレクトリに、もう1つは `Membership` フォルダーにあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-207">At this point your project should contain two `Web.config` files: one in the root directory and one in the `Membership` folder.</span></span>

<span data-ttu-id="d37d2-208">[アプリケーションに2つの web.config ファイルが含まれるようになった ![](user-based-authorization-vb/_static/image11.png)](user-based-authorization-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-208">[![Your Application Should Now Contain Two Web.config Files](user-based-authorization-vb/_static/image11.png)](user-based-authorization-vb/_static/image10.png)</span></span>

<span data-ttu-id="d37d2-209">**図 4**: アプリケーションに2つの `Web.config` ファイルが含まれるようにする ([クリックしてフルサイズのイメージを表示する](user-based-authorization-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="d37d2-209">**Figure 4**: Your Application Should Now Contain Two `Web.config` Files  ([Click to view full-size image](user-based-authorization-vb/_static/image12.png))</span></span>

<span data-ttu-id="d37d2-210">`Membership` フォルダー内の構成ファイルを更新して、匿名ユーザーへのアクセスを禁止します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-210">Update the configuration file in the `Membership` folder so that it prohibits access to anonymous users.</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample4.xml)]

<span data-ttu-id="d37d2-211">必要な作業は以上です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-211">That's all there is to it!</span></span>

<span data-ttu-id="d37d2-212">この変更をテストするには、ブラウザーでホームページにアクセスし、ログアウトしていることを確認してください。ASP.NET アプリケーションの既定の動作ではすべての訪問者が許可されるため、ルートディレクトリの `Web.config` ファイルに対して承認を変更しなかったため、ルートディレクトリ内のファイルに匿名ビジターとしてアクセスできるようになります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-212">To test out this change, visit the homepage in a browser and make sure you are logged out. Since the default behavior of an ASP.NET application is to allow all visitors, and since we didn't make any authorization modifications to the root directory's `Web.config` file, we are able to visit the files in the root directory as an anonymous visitor.</span></span>

<span data-ttu-id="d37d2-213">左側の列にある [ユーザーアカウントの作成] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-213">Click on the Creating User Accounts link found in the left column.</span></span> <span data-ttu-id="d37d2-214">これにより、`~/Membership/CreatingUserAccounts.aspx`に移動します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-214">This will take you to the `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="d37d2-215">`Membership` フォルダー内の `Web.config` ファイルでは、匿名アクセスを禁止する承認規則が定義されているため、`UrlAuthorizationModule` は要求を中止し、HTTP 401 の未承認ステータスを返します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-215">Since the `Web.config` file in the `Membership` folder defines authorization rules to prohibit anonymous access, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="d37d2-216">`FormsAuthenticationModule` はこれを302リダイレクトステータスに変更し、ログインページに送信します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-216">The `FormsAuthenticationModule` modifies this to a 302 Redirect status, sending us to the login page.</span></span> <span data-ttu-id="d37d2-217">アクセスしようとしていたページ (`CreatingUserAccounts.aspx`) は、`ReturnUrl` querystring パラメーターを使用してログインページに渡されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-217">Note that the page we were attempting to access (`CreatingUserAccounts.aspx`) is passed to the login page via the `ReturnUrl` querystring parameter.</span></span>

<span data-ttu-id="d37d2-218">[![URL 承認規則によって匿名アクセスが禁止されているため、ログインページにリダイレクトされます](user-based-authorization-vb/_static/image14.png)](user-based-authorization-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-218">[![Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page](user-based-authorization-vb/_static/image14.png)](user-based-authorization-vb/_static/image13.png)</span></span>

<span data-ttu-id="d37d2-219">**図 5**: URL 承認規則によって匿名アクセスが禁止されているため、ログインページにリダイレクトされます ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-219">**Figure 5**: Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page  ([Click to view full-size image](user-based-authorization-vb/_static/image15.png))</span></span>

<span data-ttu-id="d37d2-220">ログインに成功すると、`CreatingUserAccounts.aspx` ページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-220">Upon successfully logging in, we are redirected to the `CreatingUserAccounts.aspx` page.</span></span> <span data-ttu-id="d37d2-221">今回は、匿名ではなくなったため、`UrlAuthorizationModule` がページへのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-221">This time the `UrlAuthorizationModule` permits access to the page because we are no longer anonymous.</span></span>

### <a name="applying-url-authorization-rules-to-a-specific-location"></a><span data-ttu-id="d37d2-222">特定の場所への URL 承認規則の適用</span><span class="sxs-lookup"><span data-stu-id="d37d2-222">Applying URL Authorization Rules to a Specific Location</span></span>

<span data-ttu-id="d37d2-223">`Web.config` の `<system.web>` セクションで定義されている承認設定は、そのディレクトリとそのサブディレクトリ内のすべての ASP.NET リソース (他の `Web.config` ファイルによってオーバーライドされるまで) に適用されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-223">The authorization settings defined in the `<system.web>` section of `Web.config` apply to all of the ASP.NET resources in that directory and its subdirectories (until otherwise overridden by another `Web.config` file).</span></span> <span data-ttu-id="d37d2-224">ただし、場合によっては、特定のディレクトリ内のすべての ASP.NET リソースに特定の承認構成が必要になることがあります (1 つまたは2つの特定のページを除く)。</span><span class="sxs-lookup"><span data-stu-id="d37d2-224">In some cases, though, we may want all ASP.NET resources in a given directory to have a particular authorization configuration except for one or two specific pages.</span></span> <span data-ttu-id="d37d2-225">これを実現するには、`Web.config`に `<location>` 要素を追加し、承認規則が異なるファイルを参照して、その固有の承認規則を定義します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-225">This can be achieved by adding a `<location>` element in `Web.config`, pointing it to the file whose authorization rules differ, and defining its unique authorization rules therein.</span></span>

<span data-ttu-id="d37d2-226">`<location>` 要素を使用して特定のリソースの構成設定を上書きする方法を示すために、承認設定をカスタマイズして、Tito が `CreatingUserAccounts.aspx`にアクセスできるようにします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-226">To illustrate using the `<location>` element to override the configuration settings for a specific resource, let's customize the authorization settings so that only Tito can visit `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="d37d2-227">これを行うには、`Membership` フォルダーの `Web.config` ファイルに `<location>` 要素を追加し、次のようにマークアップを更新します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-227">To accomplish this, add a `<location>` element to the `Membership` folder's `Web.config` file and update its markup so that it looks like the following:</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample5.xml)]

<span data-ttu-id="d37d2-228">`<system.web>` の `<authorization>` 要素は、`Membership` フォルダーとそのサブフォルダー内の ASP.NET リソースに対する既定の URL 承認規則を定義します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-228">The `<authorization>` element in `<system.web>` defines the default URL authorization rules for ASP.NET resources in the `Membership` folder and its subfolders.</span></span> <span data-ttu-id="d37d2-229">`<location>` 要素を使用すると、特定のリソースに対してこれらのルールをオーバーライドできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-229">The `<location>` element allows us to override these rules for a particular resource.</span></span> <span data-ttu-id="d37d2-230">上のマークアップでは、`<location>` 要素は `CreatingUserAccounts.aspx` ページを参照し、などの承認規則を指定して Tito を許可し、他のすべてのユーザーを拒否します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-230">In the above markup the `<location>` element references the `CreatingUserAccounts.aspx` page and specifies its authorization rules such as to allow Tito, but deny everyone else.</span></span>

<span data-ttu-id="d37d2-231">この承認変更をテストするには、まず、匿名ユーザーとして web サイトにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-231">To test out this authorization change, start by visiting the website as an anonymous user.</span></span> <span data-ttu-id="d37d2-232">`UserBasedAuthorization.aspx`など、`Membership` フォルダー内のページにアクセスしようとすると、`UrlAuthorizationModule` によって要求が拒否され、ログインページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-232">If you attempt to visit any page in the `Membership` folder, such as `UserBasedAuthorization.aspx`, the `UrlAuthorizationModule` will deny the request and you will be redirected to the login page.</span></span> <span data-ttu-id="d37d2-233">Scott などとしてログインした後、`Membership` フォルダー内の任意のページにアクセスできます (`CreatingUserAccounts.aspx`を*除く*)。</span><span class="sxs-lookup"><span data-stu-id="d37d2-233">After logging in as, say, Scott, you can visit any page in the `Membership` folder *except* for `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="d37d2-234">`CreatingUserAccounts.aspx` ログオンしようとすると、不正なアクセスが試行され、ログインページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-234">Attempting to visit `CreatingUserAccounts.aspx` logged on as anyone but Tito will result in an unauthorized access attempt, redirecting you back to the login page.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-235">`<location>` 要素は、構成の `<system.web>` 要素の外に置く必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-235">The `<location>` element must appear outside of the configuration's `<system.web>` element.</span></span> <span data-ttu-id="d37d2-236">承認設定を上書きするリソースごとに個別の `<location>` 要素を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-236">You need to use a separate `<location>` element for each resource whose authorization settings you want to override.</span></span>

### <a name="a-look-at-how-theurlauthorizationmoduleuses-the-authorization-rules-to-grant-or-deny-access"></a><span data-ttu-id="d37d2-237">`UrlAuthorizationModule`が承認規則を使用してアクセスを許可または拒否する方法を確認する</span><span class="sxs-lookup"><span data-stu-id="d37d2-237">A Look at How the`UrlAuthorizationModule`Uses the Authorization Rules to Grant or Deny Access</span></span>

<span data-ttu-id="d37d2-238">`UrlAuthorizationModule` は、1つの URL 承認規則を1つずつ分析して、特定の URL の特定の id を承認するかどうかを決定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-238">The `UrlAuthorizationModule` determines whether to authorize a particular identity for a particular URL by analyzing the URL authorization rules one at a time, starting from the first one and working its way down.</span></span> <span data-ttu-id="d37d2-239">一致が見つかるとすぐに、`<allow>` または `<deny>` 要素で一致が見つかったかどうかによって、ユーザーはアクセスを許可または拒否されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-239">As soon as a match is found, the user is granted or denied access, depending on if the match was found in an `<allow>` or `<deny>` element.</span></span> <span data-ttu-id="d37d2-240"><strong>一致するものが見つからない場合は、ユーザーにアクセス権が付与されます。</strong></span><span class="sxs-lookup"><span data-stu-id="d37d2-240"><strong>If no match is found, the user is granted access.</strong></span></span> <span data-ttu-id="d37d2-241">そのため、アクセスを制限する場合は、URL 承認構成の最後の要素として `<deny>` 要素を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-241">Consequently, if you want to restrict access, it is imperative that you use a `<deny>` element as the last element in the URL authorization configuration.</span></span> <span data-ttu-id="d37d2-242">`<deny>`要素を<strong>省略すると</strong> <strong>、すべてのユーザーにアクセス権が付与されます。</strong></span><span class="sxs-lookup"><span data-stu-id="d37d2-242"><strong>If you omit a</strong><strong>`<deny>`</strong><strong>element, all users will be granted access.</strong></span></span>

<span data-ttu-id="d37d2-243">`UrlAuthorizationModule` が使用するプロセスについて理解を深めるには、この手順の前半で説明した URL 承認規則の例を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-243">To better understand the process used by the `UrlAuthorizationModule` to determine authority, consider the example URL authorization rules we looked at earlier in this step.</span></span> <span data-ttu-id="d37d2-244">最初の規則は、Tito と Scott へのアクセスを許可する `<allow>` 要素です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-244">The first rule is an `<allow>` element that allows access to Tito and Scott.</span></span> <span data-ttu-id="d37d2-245">2番目の規則は、すべてのユーザーへのアクセスを拒否する `<deny>` 要素です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-245">The second rules is a `<deny>` element that denies access to everyone.</span></span> <span data-ttu-id="d37d2-246">匿名ユーザーがアクセスした場合、`UrlAuthorizationModule` は、Scott または Tito に匿名であるかどうかを確認してから開始しますか?</span><span class="sxs-lookup"><span data-stu-id="d37d2-246">If an anonymous user visits, the `UrlAuthorizationModule` starts by asking, Is anonymous either Scott or Tito?</span></span> <span data-ttu-id="d37d2-247">もちろん、答えは「いいえ」であるため、2番目のルールに進みます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-247">The answer, obviously, is No, so it proceeds to the second rule.</span></span> <span data-ttu-id="d37d2-248">全員が匿名であるか。</span><span class="sxs-lookup"><span data-stu-id="d37d2-248">Is anonymous in the set of everybody?</span></span> <span data-ttu-id="d37d2-249">ここでの答えは "はい" であるため、`<deny>` の規則は有効になり、ビジターはログインページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-249">Since the answer here is Yes, the `<deny>` rule is put in effect and the visitor is redirected to the login page.</span></span> <span data-ttu-id="d37d2-250">同様に、Jisun がアクセスしている場合は、`UrlAuthorizationModule`、Jisun は Scott または Tito ですか。</span><span class="sxs-lookup"><span data-stu-id="d37d2-250">Similarly, if Jisun is visiting, the `UrlAuthorizationModule` starts by asking, Is Jisun either Scott or Tito?</span></span> <span data-ttu-id="d37d2-251">私はそうではないので、`UrlAuthorizationModule` は2番目の質問に進みます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-251">Since she is not, the `UrlAuthorizationModule` proceeds to the second question, Is Jisun in the set of everybody?</span></span> <span data-ttu-id="d37d2-252">アクセスは拒否されています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-252">She is, so she, too, is denied access.</span></span> <span data-ttu-id="d37d2-253">最後に、アクセスする場合は、`UrlAuthorizationModule` によって最初に行われる質問が肯定的な回答であるため、Tito にはアクセス権が付与されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-253">Finally, if Tito visits, the first question posed by the `UrlAuthorizationModule` is an affirmative answer, so Tito is granted access.</span></span>

<span data-ttu-id="d37d2-254">`UrlAuthorizationModule` は、上から順に承認規則を処理するので、すべての一致を停止します。そのため、より具体的な規則よりも具体的な規則を指定することが重要です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-254">Since the `UrlAuthorizationModule` processes the authorization rules from the top down, stopping at any match, it is important to have the more specific rules come before the less specific ones.</span></span> <span data-ttu-id="d37d2-255">つまり、Jisun と匿名ユーザーを禁止し、他のすべての認証済みユーザーを許可する承認規則を定義するには、最も限定的な規則から開始します (Jisun に影響を与える規則と、それ以外の規則を許可する規則に従います)。認証されたユーザー。ただし、すべての匿名ユーザーを拒否します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-255">That is, to define authorization rules that forbid Jisun and anonymous users, but allow all other authenticated users, you would start with the most specific rule - the one impacting Jisun - and then proceed to the less specific rules - those allowing all other authenticated users, but denying all anonymous users.</span></span> <span data-ttu-id="d37d2-256">次の URL 承認規則では、最初に Jisun を拒否し、匿名ユーザーを拒否することによって、このポリシーを実装します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-256">The following URL authorization rules implements this policy by first denying Jisun, and then denying any anonymous user.</span></span> <span data-ttu-id="d37d2-257">Jisun 以外の認証されたユーザーには、これらの `<deny>` ステートメントのどちらも一致しないため、アクセスが許可されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-257">Any authenticated user other than Jisun will be granted access because neither of these `<deny>` statements will match.</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample6.xml)]

## <a name="step-2-fixing-the-workflow-for-unauthorized-authenticated-users"></a><span data-ttu-id="d37d2-258">手順 2: 承認されていない認証済みユーザーのワークフローを修正する</span><span class="sxs-lookup"><span data-stu-id="d37d2-258">Step 2: Fixing the Workflow for Unauthorized, Authenticated Users</span></span>

<span data-ttu-id="d37d2-259">このチュートリアルで既に説明したように、「URL Authorization Workflow」セクションでは、承認されていない要求を発生するたびに、要求が中止され、HTTP 401 `UrlAuthorizationModule` の未承認ステータスが返されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-259">As we discussed earlier in this tutorial in the A Look at the URL Authorization Workflow section, anytime an unauthorized request transpires, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="d37d2-260">この401状態は、`FormsAuthenticationModule` によって、ユーザーをログインページに送信する302リダイレクトステータスに変更されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-260">This 401 status is modified by the `FormsAuthenticationModule` into a 302 Redirect status that sends the user to the login page.</span></span> <span data-ttu-id="d37d2-261">このワークフローは、ユーザーが認証されている場合でも、承認されていない要求に対して発生します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-261">This workflow occurs on any unauthorized request, even if the user is authenticated.</span></span>

<span data-ttu-id="d37d2-262">認証されたユーザーをログインページに返すことは、システムに既にログインしているため、ユーザーが混乱する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-262">Returning an authenticated user to the login page is likely to confuse them since they have already logged into the system.</span></span> <span data-ttu-id="d37d2-263">少しの作業で、承認されていない要求を行う認証済みユーザーを、制限されたページにアクセスしようとしたことを示すページにリダイレクトすることで、このワークフローを改善できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-263">With a little bit of work we can improve this workflow by redirecting authenticated users who make unauthorized requests to a page that explains that they have attempted to access a restricted page.</span></span>

<span data-ttu-id="d37d2-264">まず、`UnauthorizedAccess.aspx`という名前の web アプリケーションのルートフォルダーに新しい ASP.NET ページを作成します。このページを `Site.master` マスターページに必ず関連付けるようにしてください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-264">Start by creating a new ASP.NET page in the web application's root folder named `UnauthorizedAccess.aspx`; don't forget to associate this page with the `Site.master` master page.</span></span> <span data-ttu-id="d37d2-265">このページを作成した後、マスターページの既定のコンテンツが表示されるように、`LoginContent` ContentPlaceHolder を参照するコンテンツコントロールを削除します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-265">After creating this page, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the master page's default content will be displayed.</span></span> <span data-ttu-id="d37d2-266">次に、状況を説明するメッセージを追加します。つまり、ユーザーが保護されたリソースにアクセスしようとしたことを示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-266">Next, add a message that explains the situation, namely that the user attempted to access a protected resource.</span></span> <span data-ttu-id="d37d2-267">このようなメッセージを追加すると、`UnauthorizedAccess.aspx` ページの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-267">After adding such a message, the `UnauthorizedAccess.aspx` page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample7.aspx)]

<span data-ttu-id="d37d2-268">次に、認証されたユーザーによって承認されていない要求が実行されると、ログインページではなく `UnauthorizedAccess.aspx` ページに送信されるように、ワークフローを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-268">We now need to alter the workflow so that if an unauthorized request is performed by an authenticated user they are sent to the `UnauthorizedAccess.aspx` page instead of the login page.</span></span> <span data-ttu-id="d37d2-269">ログインページに承認されていない要求をリダイレクトするロジックは、`FormsAuthenticationModule` クラスのプライベートメソッド内に埋もれているので、この動作をカスタマイズすることはできません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-269">The logic that redirects unauthorized requests to the login page is buried within a private method of the `FormsAuthenticationModule` class, so we cannot customize this behavior.</span></span> <span data-ttu-id="d37d2-270">ただし、必要に応じて、ユーザーを `UnauthorizedAccess.aspx`にリダイレクトするログインページに独自のロジックを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-270">What we can do, however, is add our own logic to the login page that redirects the user to `UnauthorizedAccess.aspx`, if needed.</span></span>

<span data-ttu-id="d37d2-271">`FormsAuthenticationModule` が権限のないユーザーをログインページにリダイレクトすると、要求された承認されていない URL が `ReturnUrl`という名前のクエリ文字列に追加されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-271">When the `FormsAuthenticationModule` redirects an unauthorized visitor to the login page it appends the requested, unauthorized URL to the querystring with the name `ReturnUrl`.</span></span> <span data-ttu-id="d37d2-272">たとえば、承認されていないユーザーが `OnlyTito.aspx`にアクセスしようとすると、`FormsAuthenticationModule` によって `Login.aspx?ReturnUrl=OnlyTito.aspx`にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-272">For example, if an unauthorized user attempted to visit `OnlyTito.aspx`, the `FormsAuthenticationModule` would redirect them to `Login.aspx?ReturnUrl=OnlyTito.aspx`.</span></span> <span data-ttu-id="d37d2-273">したがって、認証されたユーザーが `ReturnUrl` パラメーターを含むクエリ文字列を使用してログインページに到達した場合は、この認証されていないユーザーが閲覧を許可されていないページにアクセスしようとしただけであることがわかります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-273">Therefore, if the login page is reached by an authenticated user with a querystring that includes the `ReturnUrl` parameter, then we know that this unauthenticated user just attempted to visit a page she is not authorized to view.</span></span> <span data-ttu-id="d37d2-274">このような場合は、`UnauthorizedAccess.aspx`にリダイレクトする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-274">In such a case, we want to redirect her to `UnauthorizedAccess.aspx`.</span></span>

<span data-ttu-id="d37d2-275">これを実現するには、ログインページの `Page_Load` イベントハンドラーに次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-275">To accomplish this, add the following code to the login page's `Page_Load` event handler:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample8.vb)]

<span data-ttu-id="d37d2-276">上記のコードは、認証された承認されていないユーザーを `UnauthorizedAccess.aspx` ページにリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-276">The above code redirects authenticated, unauthorized users to the `UnauthorizedAccess.aspx` page.</span></span> <span data-ttu-id="d37d2-277">このロジックが動作していることを確認するには、匿名ビジターとしてサイトにアクセスし、左側の列にある [ユーザーアカウントの作成] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-277">To see this logic in action, visit the site as an anonymous visitor and click on the Creating User Accounts link in the left column.</span></span> <span data-ttu-id="d37d2-278">これにより、[`~/Membership/CreatingUserAccounts.aspx`] ページに移動します。手順 1. では、Tito へのアクセスのみを許可するように構成されています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-278">This will take you to the `~/Membership/CreatingUserAccounts.aspx` page, which in Step 1 we configured to only permit access to Tito.</span></span> <span data-ttu-id="d37d2-279">匿名ユーザーは禁止されているため、`FormsAuthenticationModule` はログインページにリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-279">Since anonymous users are prohibited, the `FormsAuthenticationModule` redirects us back to the login page.</span></span>

<span data-ttu-id="d37d2-280">この時点では匿名であるため、`Request.IsAuthenticated` は `False` を返し、`UnauthorizedAccess.aspx`にはリダイレクトされません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-280">At this point we are anonymous, so `Request.IsAuthenticated` returns `False` and we are not redirected to `UnauthorizedAccess.aspx`.</span></span> <span data-ttu-id="d37d2-281">代わりに、ログインページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-281">Instead, the login page is displayed.</span></span> <span data-ttu-id="d37d2-282">たとえば、Tito 以外のユーザーとしてログインします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-282">Log in as a user other than Tito, such as Bruce.</span></span> <span data-ttu-id="d37d2-283">適切な資格情報を入力すると、ログインページが `~/Membership/CreatingUserAccounts.aspx`にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-283">After entering the appropriate credentials, the login page redirects us back to `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="d37d2-284">ただし、このページにアクセスできるのは Tito だけなので、このページを表示する権限はありませんので、すぐにログインページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-284">However, since this page is only accessible to Tito, we are unauthorized to view it and are promptly returned to the login page.</span></span> <span data-ttu-id="d37d2-285">ただし、今度は `Request.IsAuthenticated` が返され `True` (と `ReturnUrl` querystring パラメーターが存在する) ため、`UnauthorizedAccess.aspx` ページにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-285">This time, however, `Request.IsAuthenticated` returns `True` (and the `ReturnUrl` querystring parameter exists), so we are redirected to the `UnauthorizedAccess.aspx` page.</span></span>

<span data-ttu-id="d37d2-286">[認証され ![認証されていないユーザーは、UnauthorizedAccess .aspx にリダイレクトされます。](user-based-authorization-vb/_static/image17.png)](user-based-authorization-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-286">[![Authenticated, Unauthorized Users are Redirected to UnauthorizedAccess.aspx](user-based-authorization-vb/_static/image17.png)](user-based-authorization-vb/_static/image16.png)</span></span>

<span data-ttu-id="d37d2-287">**図 6**: 認証された承認されていないユーザーが `UnauthorizedAccess.aspx` にリダイレクトされる ([クリックしてフルサイズの画像を表示する](user-based-authorization-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="d37d2-287">**Figure 6**: Authenticated, Unauthorized Users are Redirected to `UnauthorizedAccess.aspx` ([Click to view full-size image](user-based-authorization-vb/_static/image18.png))</span></span>

<span data-ttu-id="d37d2-288">このカスタマイズされたワークフローは、図2に示すサイクルを簡単に示すことで、より合理的でわかりやすいユーザーエクスペリエンスを提供します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-288">This customized workflow presents a more sensible and straightforward user experience by short circuiting the cycle depicted in Figure 2.</span></span>

## <a name="step-3-limiting-functionality-based-on-the-currently-logged-in-user"></a><span data-ttu-id="d37d2-289">手順 3: 現在ログインしているユーザーに基づいて機能を制限する</span><span class="sxs-lookup"><span data-stu-id="d37d2-289">Step 3: Limiting Functionality Based on the Currently Logged In User</span></span>

<span data-ttu-id="d37d2-290">URL 承認を使用すると、粒度の粗い承認規則を簡単に指定できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-290">URL authorization makes it easy to specify coarse authorization rules.</span></span> <span data-ttu-id="d37d2-291">手順 1. で説明したように、URL 承認を使用すると、許可される id と、フォルダー内の特定のページまたはすべてのページを表示する際に拒否される id を簡潔に把握できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-291">As we saw in Step 1, with URL authorization we can succinctly state what identities are permitted and which ones are denied from viewing a particular page or all pages in a folder.</span></span> <span data-ttu-id="d37d2-292">ただし、特定のシナリオでは、すべてのユーザーがページにアクセスできるようにする必要がありますが、ページにアクセスするユーザーに基づいてページの機能を制限することもできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-292">In certain scenarios, however, we may want to allow all users to visit a page, but limit the page's functionality based on the user visiting it.</span></span>

<span data-ttu-id="d37d2-293">認証された訪問者が製品をレビューできる e コマース web サイトのケースを考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-293">Consider the case of an eCommerce website that allows authenticated visitors to review their products.</span></span> <span data-ttu-id="d37d2-294">匿名ユーザーが製品のページにアクセスすると、製品情報だけが表示され、レビューを終了する機会は与えられません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-294">When an anonymous user visits a product's page, they would see just the product information and would not be given the opportunity to leave a review.</span></span> <span data-ttu-id="d37d2-295">ただし、認証されたユーザーが同じページにアクセスすると、[確認] インターフェイスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-295">However, an authenticated user visiting the same page would see the reviewing interface.</span></span> <span data-ttu-id="d37d2-296">認証されたユーザーがこの製品をまだ確認していない場合、インターフェイスによってレビューを送信できるようになります。それ以外の場合は、以前に送信したレビューが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-296">If the authenticated user had not yet reviewed this product, the interface would enable them to submit a review; otherwise it would show them their previously-submitted review.</span></span> <span data-ttu-id="d37d2-297">このシナリオをさらに進めるために、製品ページには追加情報が記載されています。また、e コマース会社で利用できるユーザーのための拡張機能を提供しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-297">To take this scenario a step further, the product page might show additional information and offer extended features for those users that work for the eCommerce company.</span></span> <span data-ttu-id="d37d2-298">たとえば、製品ページに在庫の一覧が表示され、従業員がアクセスしたときに製品の価格と説明を編集するためのオプションが含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-298">For example, the product page might list the inventory in stock and include options to edit the product's price and description when visited by an employee.</span></span>

<span data-ttu-id="d37d2-299">このような細かい粒度の承認規則は、宣言によって、またはプログラムによって (または2つの組み合わせを使用して) 実装できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-299">Such fine grain authorization rules can be implemented either declaratively or programmatically (or through some combination of the two).</span></span> <span data-ttu-id="d37d2-300">次のセクションでは、LoginView コントロールを使用して細かい粒度承認を実装する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-300">In the next section we will see how to implement fine grain authorization via the LoginView control.</span></span> <span data-ttu-id="d37d2-301">次に、プログラムによる手法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-301">Following that, we will explore programmatic techniques.</span></span> <span data-ttu-id="d37d2-302">ただし、綿密な粒度の承認規則の適用を確認する前に、まず、アクセスするユーザーによって機能が異なるページを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-302">Before we can look at applying fine grain authorization rules, however, we first need to create a page whose functionality depends on the user visiting it.</span></span>

<span data-ttu-id="d37d2-303">GridView 内の特定のディレクトリ内のファイルを一覧表示するページを作成してみましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-303">Let's create a page that lists the files in a particular directory within a GridView.</span></span> <span data-ttu-id="d37d2-304">GridView には、各ファイルの名前、サイズ、およびその他の情報を一覧表示すると共に、リンクボタンの2つの列が含まれます。1つはタイトル付きビューで、もう1つは Delete というタイトルです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-304">Along with listing each file's name, size, and other information, the GridView will include two columns of LinkButtons: one titled View and one titled Delete.</span></span> <span data-ttu-id="d37d2-305">ビュー LinkButton がクリックされると、選択したファイルの内容が表示されます。Delete LinkButton がクリックされると、ファイルは削除されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-305">If the View LinkButton is clicked, the contents of the selected file will be displayed; if the Delete LinkButton is clicked, the file will be deleted.</span></span> <span data-ttu-id="d37d2-306">最初にこのページを作成して、すべてのユーザーがそのビューおよび削除機能を使用できるようにしましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-306">Let's initially create this page such that its view and delete functionality is available to all users.</span></span> <span data-ttu-id="d37d2-307">「LoginView コントロールの使用」および「プログラムによる機能の制限」では、ページにアクセスしているユーザーに基づいてこれらの機能を有効または無効にする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-307">In the Using the LoginView Control and Programmatically Limiting Functionality sections we will see how to enable or disable these features based on the user visiting the page.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-308">ビルドしようとしている ASP.NET ページでは、GridView コントロールを使用してファイルの一覧を表示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-308">The ASP.NET page we are about to build uses a GridView control to display a list of files.</span></span> <span data-ttu-id="d37d2-309">このチュートリアルシリーズでは、フォーム認証、承認、ユーザーアカウント、およびロールに焦点を当てているため、GridView コントロールの内部動作についてはあまり時間をかけたくありません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-309">Since this tutorial series focuses on forms authentication, authorization, user accounts, and roles, I do not want to spend too much time discussing the inner workings of the GridView control.</span></span> <span data-ttu-id="d37d2-310">このチュートリアルでは、このページを設定するための具体的な手順について説明しますが、特定の選択が行われた理由や、レンダリングされた出力に対する特定のプロパティの影響については詳しく説明しません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-310">While this tutorial provides specific step-by-step instructions for setting up this page, it does not delve into the details of why certain choices were made, or what effect particular properties have on the rendered output.</span></span> <span data-ttu-id="d37d2-311">GridView コントロールの詳細な調査については、「 *[ASP.NET 2.0 チュートリアルシリーズのデータの操作」](../../data-access/index.md)* を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-311">For a thorough examination of the GridView control, consult my *[Working with Data in ASP.NET 2.0](../../data-access/index.md)* tutorial series.</span></span>

<span data-ttu-id="d37d2-312">まず、`Membership` フォルダー内の `UserBasedAuthorization.aspx` ファイルを開いて、`FilesGrid`という名前のページに GridView コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-312">Start by opening the `UserBasedAuthorization.aspx` file in the `Membership` folder and adding a GridView control to the page named `FilesGrid`.</span></span> <span data-ttu-id="d37d2-313">GridView のスマートタグから、[列の編集] リンクをクリックして [フィールド] ダイアログボックスを開きます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-313">From the GridView's Smart Tag, click the Edit Columns link to launch the Fields dialog box.</span></span> <span data-ttu-id="d37d2-314">ここで、左下隅にある [フィールドの自動生成] チェックボックスをオフにします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-314">From here, uncheck the Auto-generate fields checkbox in the lower left corner.</span></span> <span data-ttu-id="d37d2-315">次に、左上隅にある [選択] ボタン、[削除] ボタン、および2つの連結フィールドを追加します ([選択] ボタンと [削除] ボタンは CommandField 型の下にあります)。</span><span class="sxs-lookup"><span data-stu-id="d37d2-315">Next, add a Select button, a Delete button, and two BoundFields from the upper left corner (the Select and Delete buttons can be found under the CommandField type).</span></span> <span data-ttu-id="d37d2-316">[選択] ボタンの `SelectText` プロパティを [表示] に設定し、最初の BoundField の `HeaderText` と [`DataField` のプロパティ] を [名前] に設定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-316">Set the Select button's `SelectText` property to View and the first BoundField's `HeaderText` and `DataField` properties to Name.</span></span> <span data-ttu-id="d37d2-317">2番目の BoundField の `HeaderText` プロパティをバイト単位のサイズに設定し、その `DataField` プロパティを長さに、その `DataFormatString` プロパティを {0:N0} に設定し、その `HtmlEncode` プロパティを False に設定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-317">Set the second BoundField's `HeaderText` property to Size in Bytes, its `DataField` property to Length, its `DataFormatString` property to {0:N0} and its `HtmlEncode` property to False.</span></span>

<span data-ttu-id="d37d2-318">GridView の列を構成したら、[OK] をクリックして [フィールド] ダイアログボックスを閉じます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-318">After configuring the GridView's columns, click OK to close the Fields dialog box.</span></span> <span data-ttu-id="d37d2-319">プロパティウィンドウから、GridView の `DataKeyNames` プロパティを `FullName`に設定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-319">From the Properties window, set the GridView's `DataKeyNames` property to `FullName`.</span></span> <span data-ttu-id="d37d2-320">この時点で、GridView の宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-320">At this point the GridView's declarative markup should look like the following:</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample9.aspx)]

<span data-ttu-id="d37d2-321">GridView のマークアップを作成したら、特定のディレクトリにあるファイルを取得して GridView にバインドするコードを記述する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-321">With the GridView's markup created, we're ready to write the code that will retrieve the files in a particular directory and bind them to the GridView.</span></span> <span data-ttu-id="d37d2-322">ページの `Page_Load` イベントハンドラーに次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-322">Add the following code to the page's `Page_Load` event handler:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample10.vb)]

<span data-ttu-id="d37d2-323">上記のコードでは、 [`DirectoryInfo` クラス](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx)を使用して、アプリケーションのルートフォルダー内のファイルの一覧を取得します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-323">The above code uses the [`DirectoryInfo` class](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx) to obtain a list of the files in the application's root folder.</span></span> <span data-ttu-id="d37d2-324">[`GetFiles()` メソッド](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx)は、ディレクトリ内のすべてのファイルを[`FileInfo` オブジェクト](https://msdn.microsoft.com/library/system.io.fileinfo.aspx)の配列として返します。このオブジェクトは、GridView にバインドされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-324">The [`GetFiles()` method](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx) returns all of the files in the directory as an array of [`FileInfo` objects](https://msdn.microsoft.com/library/system.io.fileinfo.aspx), which is then bound to the GridView.</span></span> <span data-ttu-id="d37d2-325">`FileInfo` オブジェクトには、`Name`、`Length`、`IsReadOnly`など、さまざまなプロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-325">The `FileInfo` object has an assortment of properties, such as `Name`, `Length`, and `IsReadOnly`, among others.</span></span> <span data-ttu-id="d37d2-326">宣言型マークアップからわかるように、GridView には `Name` と `Length` のプロパティだけが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-326">As you can see from its declarative markup, the GridView displays just the `Name` and `Length` properties.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-327">`DirectoryInfo` クラスと `FileInfo` クラスは、 [`System.IO` 名前空間](https://msdn.microsoft.com/library/system.io.aspx)にあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-327">The `DirectoryInfo` and `FileInfo` classes are found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="d37d2-328">したがって、これらのクラス名の先頭には名前空間名を付けるか、または名前空間をクラスファイルにインポートする必要があります (`Imports System.IO`)。</span><span class="sxs-lookup"><span data-stu-id="d37d2-328">Therefore, you will either need to preface these class names with their namespace names or have the namespace imported into the class file (via `Imports System.IO`).</span></span>

<span data-ttu-id="d37d2-329">ブラウザーを使用してこのページにアクセスしてください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-329">Take a moment to visit this page through a browser.</span></span> <span data-ttu-id="d37d2-330">これにより、アプリケーションのルートディレクトリに存在するファイルの一覧が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-330">It will display the list of files residing in the application's root directory.</span></span> <span data-ttu-id="d37d2-331">ビューまたは削除リンクボタンのいずれかをクリックするとポストバックが発生しますが、必要なイベントハンドラーをまだ作成していないため、アクションは発生しません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-331">Clicking any of the View or Delete LinkButtons will cause a postback, but no action will occur because we've yet to create the necessary event handlers.</span></span>

<span data-ttu-id="d37d2-332">[GridView に ![、Web アプリケーションのルートディレクトリにあるファイルが一覧表示されます。](user-based-authorization-vb/_static/image20.png)](user-based-authorization-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-332">[![The GridView Lists the Files in the Web Application's Root Directory](user-based-authorization-vb/_static/image20.png)](user-based-authorization-vb/_static/image19.png)</span></span>

<span data-ttu-id="d37d2-333">**図 7**: GridView によって、Web アプリケーションのルートディレクトリ内のファイルが一覧表示されます ([クリックすると、フルサイズのイメージが表示](user-based-authorization-vb/_static/image21.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-333">**Figure 7**: The GridView Lists the Files in the Web Application's Root Directory  ([Click to view full-size image](user-based-authorization-vb/_static/image21.png))</span></span>

<span data-ttu-id="d37d2-334">選択したファイルの内容を表示するための手段が必要です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-334">We need a means to display the contents of the selected file.</span></span> <span data-ttu-id="d37d2-335">Visual Studio に戻り、GridView の上に `FileContents` という名前のテキストボックスを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-335">Return to Visual Studio and add a TextBox named `FileContents` above the GridView.</span></span> <span data-ttu-id="d37d2-336">`TextMode` プロパティを `MultiLine` に設定し、`Columns` と `Rows` プロパティをそれぞれ95% と10に設定します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-336">Set its `TextMode` property to `MultiLine` and its `Columns` and `Rows` properties to 95% and 10, respectively.</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample11.aspx)]

<span data-ttu-id="d37d2-337">次に、GridView の[`SelectedIndexChanged` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx)のイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-337">Next, create an event handler for the GridView's [`SelectedIndexChanged` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx) and add the following code:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample12.vb)]

<span data-ttu-id="d37d2-338">このコードでは、GridView の `SelectedValue` プロパティを使用して、選択したファイルの完全なファイル名を確認します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-338">This code uses the GridView's `SelectedValue` property to determine the full file name of the selected file.</span></span> <span data-ttu-id="d37d2-339">内部的には、`SelectedValue`を取得するために `DataKeys` コレクションが参照されているため、この手順の前半で説明したように、GridView の `DataKeyNames` プロパティを Name に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-339">Internally, the `DataKeys` collection is referenced in order to obtain the `SelectedValue`, so it is imperative that you set the GridView's `DataKeyNames` property to Name, as described earlier in this step.</span></span> <span data-ttu-id="d37d2-340">[`File` クラス](https://msdn.microsoft.com/library/system.io.file.aspx)は、選択したファイルの内容を文字列に読み取るために使用されます。この文字列は、`FileContents` テキストボックスの `Text` プロパティに割り当てられます。これにより、選択したファイルの内容がページ上に表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-340">The [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) is used to read the selected file's contents into a string, which is then assigned to the `FileContents` TextBox's `Text` property, thereby displaying the contents of the selected file on the page.</span></span>

<span data-ttu-id="d37d2-341">[選択したファイルの内容をテキストボックスに表示 ![](user-based-authorization-vb/_static/image23.png)](user-based-authorization-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-341">[![The Selected File's Contents are Displayed in the TextBox](user-based-authorization-vb/_static/image23.png)](user-based-authorization-vb/_static/image22.png)</span></span>

<span data-ttu-id="d37d2-342">**図 8**: 選択したファイルの内容がテキストボックスに表示される ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image24.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-342">**Figure 8**: The Selected File's Contents are Displayed in the TextBox  ([Click to view full-size image](user-based-authorization-vb/_static/image24.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-343">HTML マークアップが含まれているファイルの内容を表示し、ファイルを表示または削除しようとすると、`HttpRequestValidationException` エラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-343">If you view the contents of a file that contains HTML markup, and then attempt to view or delete a file, you will receive an `HttpRequestValidationException` error.</span></span> <span data-ttu-id="d37d2-344">これは、ポストバック時に TextBox の内容が web サーバーに送り返されるためです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-344">This occurs because on postback the TextBox's contents are sent back to the web server.</span></span> <span data-ttu-id="d37d2-345">既定では、HTML マークアップなどの危険なポストバックコンテンツが検出されると、ASP.NET は `HttpRequestValidationException` エラーを発生させます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-345">By default, ASP.NET raises an `HttpRequestValidationException` error whenever potentially dangerous postback content, such as HTML markup, is detected.</span></span> <span data-ttu-id="d37d2-346">このエラーが発生しないようにするには、`@Page` ディレクティブに `ValidateRequest="false"` を追加して、ページの要求の検証を無効にします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-346">To disable this error from occurring, turn off request validation for the page by adding `ValidateRequest="false"` to the `@Page` directive.</span></span> <span data-ttu-id="d37d2-347">要求の検証の利点と、それを無効にするときに行う必要がある対策の詳細については、「[要求の検証-スクリプト攻撃の防止](https://asp.net/learn/whitepapers/request-validation/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-347">For more information on the benefits of request validation as well as what precautions you should take when disabling it, read [Request Validation - Preventing Script Attacks](https://asp.net/learn/whitepapers/request-validation/).</span></span>

<span data-ttu-id="d37d2-348">最後に、GridView の[`RowDeleting` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx)の次のコードを使用して、イベントハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-348">Finally, add an event handler with the following code for the GridView's [`RowDeleting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx):</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample13.vb)]

<span data-ttu-id="d37d2-349">このコードは、ファイルを実際に削除する*ことなく*、`FileContents` テキストボックスで削除するファイルの完全な名前を表示するだけです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-349">The code simply displays the full name of the file to delete in the `FileContents` TextBox *without* actually deleting the file.</span></span>

<span data-ttu-id="d37d2-350">[[削除] ボタンをクリックしても、ファイルは実際には削除されません ![](user-based-authorization-vb/_static/image26.png)](user-based-authorization-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-350">[![Clicking the Delete Button Does Not Actually Delete the File](user-based-authorization-vb/_static/image26.png)](user-based-authorization-vb/_static/image25.png)</span></span>

<span data-ttu-id="d37d2-351">**図 9**: [削除] ボタンをクリックしてもファイルが削除されない ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image27.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-351">**Figure 9**: Clicking the Delete Button Does Not Actually Delete the File  ([Click to view full-size image](user-based-authorization-vb/_static/image27.png))</span></span>

<span data-ttu-id="d37d2-352">手順1では、匿名ユーザーが `Membership` フォルダー内のページを表示できないように、URL 承認規則を構成しました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-352">In Step 1 we configured the URL authorization rules to prohibit anonymous users from viewing the pages in the `Membership` folder.</span></span> <span data-ttu-id="d37d2-353">きめ細かな認証をより適切に行うために、匿名ユーザーが `UserBasedAuthorization.aspx` ページにアクセスできるようにしますが、機能は制限されています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-353">In order to better exhibit fine grain authentication, let's allow anonymous users to visit the `UserBasedAuthorization.aspx` page, but with limited functionality.</span></span> <span data-ttu-id="d37d2-354">すべてのユーザーがアクセスできるようにこのページを開くには、次の `<location>` 要素を `Membership` フォルダー内の `Web.config` ファイルに追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-354">To open this page up to be accessed by all users, add the following `<location>` element to the `Web.config` file in the `Membership` folder:</span></span>

[!code-xml[Main](user-based-authorization-vb/samples/sample14.xml)]

<span data-ttu-id="d37d2-355">この `<location>` 要素を追加した後、サイトからログアウトして、新しい URL 承認規則をテストします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-355">After adding this `<location>` element, test the new URL authorization rules by logging out of the site.</span></span> <span data-ttu-id="d37d2-356">匿名ユーザーは、`UserBasedAuthorization.aspx` ページにアクセスすることが許可されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-356">As an anonymous user you should be permitted to visit the `UserBasedAuthorization.aspx` page.</span></span>

<span data-ttu-id="d37d2-357">現在、認証されたユーザーまたは匿名ユーザーは、`UserBasedAuthorization.aspx` ページにアクセスして、ファイルを表示または削除できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-357">Currently, any authenticated or anonymous user can visit the `UserBasedAuthorization.aspx` page and view or delete files.</span></span> <span data-ttu-id="d37d2-358">認証されたユーザーのみがファイルの内容を表示できるようにし、ファイルを削除できるのは Tito です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-358">Let's make it so that only authenticated users can view contents of a file and only Tito can delete a file.</span></span> <span data-ttu-id="d37d2-359">このような細かい粒度の承認規則は、プログラムによって、または両方の方法を組み合わせて適用できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-359">Such fine grain authorization rules can be applied declaratively, programmatically, or through a combination of both methods.</span></span> <span data-ttu-id="d37d2-360">宣言型の方法を使用して、ファイルの内容を表示できるユーザーを制限してみましょう。プログラムによる方法を使用して、ファイルを削除できるユーザーを制限します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-360">Let's use the declarative approach to limit who can view the contents of a file; we'll use the programmatic approach to limit who can delete a file.</span></span>

### <a name="using-the-loginview-control"></a><span data-ttu-id="d37d2-361">LoginView コントロールの使用</span><span class="sxs-lookup"><span data-stu-id="d37d2-361">Using the LoginView Control</span></span>

<span data-ttu-id="d37d2-362">これまでのチュートリアルで説明したように、LoginView コントロールは、認証されたユーザーと匿名ユーザー用にさまざまなインターフェイスを表示する場合に便利です。また、匿名ユーザーがアクセスできない機能を簡単に隠すことができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-362">As we've seen in past tutorials, the LoginView control is useful for displaying different interfaces for authenticated and anonymous users, and offers an easy way to hide functionality that is not accessible to anonymous users.</span></span> <span data-ttu-id="d37d2-363">匿名ユーザーがファイルを表示または削除することはできないため、認証されたユーザーがページにアクセスしたときにのみ、`FileContents` テキストボックスを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-363">Since anonymous users cannot view or delete files, we only need to show the `FileContents` TextBox when the page is visited by an authenticated user.</span></span> <span data-ttu-id="d37d2-364">これを実現するには、LoginView コントロールをページに追加し `LoginViewForFileContentsTextBox`という名前を指定し、`FileContents` TextBox の宣言型マークアップを LoginView コントロールの `LoggedInTemplate`に移動します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-364">To achieve this, add a LoginView control to the page, name it `LoginViewForFileContentsTextBox`, and move the `FileContents` TextBox's declarative markup into the LoginView control's `LoggedInTemplate`.</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample15.aspx)]

<span data-ttu-id="d37d2-365">LoginView のテンプレート内の Web コントロールは、分離コードクラスから直接アクセスできなくなりました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-365">The Web controls in the LoginView's templates are no longer directly accessible from the code-behind class.</span></span> <span data-ttu-id="d37d2-366">たとえば、`FilesGrid` GridView の `SelectedIndexChanged` および `RowDeleting` イベントハンドラーは、現在、次のようなコードを使用して `FileContents` TextBox コントロールを参照します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-366">For example, the `FilesGrid` GridView's `SelectedIndexChanged` and `RowDeleting` event handlers currently reference the `FileContents` TextBox control with code like:</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample16.aspx)]

<span data-ttu-id="d37d2-367">ただし、このコードは有効ではなくなりました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-367">However, this code is no longer valid.</span></span> <span data-ttu-id="d37d2-368">`FileContents` TextBox を `LoggedInTemplate` に移動すると、テキストボックスに直接アクセスできなくなります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-368">By moving the `FileContents` TextBox into the `LoggedInTemplate` the TextBox cannot be directly accessed.</span></span> <span data-ttu-id="d37d2-369">代わりに、`FindControl("controlId")` メソッドを使用して、プログラムでコントロールを参照する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-369">Instead, we must use the `FindControl("controlId")` method to programmatically reference the control.</span></span> <span data-ttu-id="d37d2-370">次のように、テキストボックスを参照するように `FilesGrid` イベントハンドラーを更新します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-370">Update the `FilesGrid` event handlers to reference the TextBox like so:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample17.vb)]

<span data-ttu-id="d37d2-371">TextBox を LoginView の `LoggedInTemplate` に移動し、`FindControl("controlId")` パターンを使用してテキストボックスを参照するようにページのコードを更新した後は、匿名ユーザーとしてページにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-371">After moving the TextBox to the LoginView's `LoggedInTemplate` and updating the page's code to reference the TextBox using the `FindControl("controlId")` pattern, visit the page as an anonymous user.</span></span> <span data-ttu-id="d37d2-372">図10に示すように、[`FileContents`] ボックスは表示されません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-372">As Figure 10 shows, the `FileContents` TextBox is not displayed.</span></span> <span data-ttu-id="d37d2-373">ただし、ビュー LinkButton は引き続き表示されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-373">However, the View LinkButton is still displayed.</span></span>

<span data-ttu-id="d37d2-374">[LoginView コントロールでは、認証されたユーザーの FileContents TextBox のみがレンダリングされます。 ![](user-based-authorization-vb/_static/image29.png)](user-based-authorization-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-374">[![The LoginView Control Only Renders the FileContents TextBox for Authenticated Users](user-based-authorization-vb/_static/image29.png)](user-based-authorization-vb/_static/image28.png)</span></span>

<span data-ttu-id="d37d2-375">**図 10**: LoginView コントロールでは、認証されたユーザーの `FileContents` テキストボックスのみがレンダリングされます ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image30.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-375">**Figure 10**: The LoginView Control Only Renders the `FileContents` TextBox for Authenticated Users  ([Click to view full-size image](user-based-authorization-vb/_static/image30.png))</span></span>

<span data-ttu-id="d37d2-376">匿名ユーザーの [表示] ボタンを非表示にする方法の1つとして、GridView フィールドを TemplateField に変換する方法があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-376">One way to hide the View button for anonymous users is to convert the GridView field into a TemplateField.</span></span> <span data-ttu-id="d37d2-377">これにより、ビュー LinkButton の宣言型マークアップを含むテンプレートが生成されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-377">This will generate a template that contains the declarative markup for the View LinkButton.</span></span> <span data-ttu-id="d37d2-378">次に、LoginView コントロールを TemplateField に追加し、LoginView の `LoggedInTemplate`内に LinkButton を配置します。これにより、匿名訪問者から表示ボタンが非表示になります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-378">We can then add a LoginView control to the TemplateField and place the LinkButton within the LoginView's `LoggedInTemplate`, thereby hiding the View button from anonymous visitors.</span></span> <span data-ttu-id="d37d2-379">これを行うには、GridView のスマートタグから [列の編集] リンクをクリックして、[フィールド] ダイアログボックスを起動します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-379">To accomplish this, click on the Edit Columns link from the GridView's Smart Tag to launch the Fields dialog box.</span></span> <span data-ttu-id="d37d2-380">次に、左下隅にある一覧から [選択] ボタンを選択し、[このフィールドを TemplateField に変換する] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-380">Next, select the Select button from the list in the lower left corner and then click the Convert this field to a TemplateField link.</span></span> <span data-ttu-id="d37d2-381">これにより、次のようにフィールドの宣言マークアップが変更されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-381">Doing so will modify the field's declarative markup from:</span></span>

[!code-aspx[Main](user-based-authorization-vb/samples/sample18.aspx)]

 <span data-ttu-id="d37d2-382">宛先:</span><span class="sxs-lookup"><span data-stu-id="d37d2-382">To:</span></span> 

[!code-aspx[Main](user-based-authorization-vb/samples/sample19.aspx)]

 <span data-ttu-id="d37d2-383">この時点で、TemplateField に LoginView を追加できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-383">At this point, we can add a LoginView to the TemplateField.</span></span> <span data-ttu-id="d37d2-384">次のマークアップは、認証されたユーザーに対してのみビュー LinkButton を表示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-384">The following markup displays the View LinkButton only for authenticated users.</span></span> 

[!code-aspx[Main](user-based-authorization-vb/samples/sample20.aspx)]

<span data-ttu-id="d37d2-385">図11に示すように、最終的な結果は、列内のビューリンクボタンが非表示になっていても、ビュー列が引き続き表示されるという点ではありません。</span><span class="sxs-lookup"><span data-stu-id="d37d2-385">As Figure 11 shows, the end result is not that pretty as the View column is still displayed even though the View LinkButtons within the column are hidden.</span></span> <span data-ttu-id="d37d2-386">次のセクションでは、(LinkButton だけでなく) GridView 列全体を非表示にする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-386">We will look at how to hide the entire GridView column (and not just the LinkButton) in the next section.</span></span>

<span data-ttu-id="d37d2-387">[LoginView コントロールを ![すると、匿名訪問者のビューリンクボタンが非表示になります。](user-based-authorization-vb/_static/image32.png)](user-based-authorization-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-387">[![The LoginView Control Hides the View LinkButtons for Anonymous Visitors](user-based-authorization-vb/_static/image32.png)](user-based-authorization-vb/_static/image31.png)</span></span>

<span data-ttu-id="d37d2-388">**図 11**: LoginView コントロールは、匿名の訪問者のビューリンクボタンを非表示にします ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image33.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-388">**Figure 11**: The LoginView Control Hides the View LinkButtons for Anonymous Visitors  ([Click to view full-size image](user-based-authorization-vb/_static/image33.png))</span></span>

### <a name="programmatically-limiting-functionality"></a><span data-ttu-id="d37d2-389">プログラムによる機能制限</span><span class="sxs-lookup"><span data-stu-id="d37d2-389">Programmatically Limiting Functionality</span></span>

<span data-ttu-id="d37d2-390">場合によっては、ページに機能を制限するための宣言型手法が不十分です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-390">In some circumstances, declarative techniques are insufficient for limiting functionality to a page.</span></span> <span data-ttu-id="d37d2-391">たとえば、ページにアクセスするユーザーが匿名または認証されているかどうかに関係なく、特定のページ機能の可用性が条件に依存している場合があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-391">For example, the availability of certain page functionality may be dependent on criteria beyond whether the user visiting the page is anonymous or authenticated.</span></span> <span data-ttu-id="d37d2-392">このような場合は、プログラムによって、さまざまなユーザーインターフェイス要素を表示または非表示にすることができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-392">In such cases, the various user interface elements can be displayed or hidden through programmatic means.</span></span>

<span data-ttu-id="d37d2-393">プログラムによって機能を制限するために、次の2つのタスクを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-393">In order to limit the functionality programmatically, we need to perform two tasks:</span></span>

1. <span data-ttu-id="d37d2-394">ページにアクセスしているユーザーが機能にアクセスできるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-394">Determine whether the user visiting the page can access the functionality, and</span></span>
2. <span data-ttu-id="d37d2-395">ユーザーが問題の機能にアクセスできるかどうかに基づいて、プログラムによってユーザーインターフェイスを変更します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-395">Programmatically modify the user interface based on whether the user has access to the functionality in question.</span></span>

<span data-ttu-id="d37d2-396">これらの2つのタスクの適用を示すために、GridView からのファイルの削除のみを許可してみましょう。</span><span class="sxs-lookup"><span data-stu-id="d37d2-396">To demonstrate the application of these two tasks, let's only allow Tito to delete files from the GridView.</span></span> <span data-ttu-id="d37d2-397">最初のタスクは、ページにアクセスする必要があるかどうかを判断することです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-397">Our first task, then, is to determine whether it is Tito visiting the page.</span></span> <span data-ttu-id="d37d2-398">確認したら、GridView の Delete 列を非表示 (または表示) する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-398">Once that has been determined, we need to hide (or show) the GridView's Delete column.</span></span> <span data-ttu-id="d37d2-399">GridView の列には、`Columns` プロパティを使用してアクセスできます。列が表示されるのは、その `Visible` プロパティが `True` (既定値) に設定されている場合のみです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-399">The GridView's columns are accessible through its `Columns` property; a column is only rendered if its `Visible` property is set to `True` (the default).</span></span>

<span data-ttu-id="d37d2-400">データを GridView にバインドする前に、`Page_Load` イベントハンドラーに次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-400">Add the following code to the `Page_Load` event handler prior to binding the data to the GridView:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample21.vb)]

<span data-ttu-id="d37d2-401">[ *「フォーム認証の概要」* ](../introduction/an-overview-of-forms-authentication-vb.md)チュートリアルで説明したように、`User.Identity.Name` は id の名前を返します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-401">As we discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-vb.md) tutorial, `User.Identity.Name` returns the identity's name.</span></span> <span data-ttu-id="d37d2-402">これは、ログインコントロールに入力されたユーザー名に対応します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-402">This corresponds to the username entered in the Login control.</span></span> <span data-ttu-id="d37d2-403">ページにアクセスする必要がある場合、GridView の2番目の列の `Visible` プロパティは `True`に設定されます。それ以外の場合は、`False`に設定されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-403">If it is Tito visiting the page, the GridView's second column's `Visible` property is set to `True`; otherwise, it is set to `False`.</span></span> <span data-ttu-id="d37d2-404">結果として、他のユーザーがページにアクセスしたときに、別の認証済みユーザーまたは匿名ユーザーのいずれかが表示されない場合、削除列はレンダリングされません (図12を参照)。ただし、このページにアクセスするときは、[削除] 列が表示されます (図13を参照)。</span><span class="sxs-lookup"><span data-stu-id="d37d2-404">The net result is that when someone other than Tito visits the page, either another authenticated user or an anonymous user, the Delete column is not rendered (see Figure 12); however, when Tito visits the page, the Delete column is present (see Figure 13).</span></span>

<span data-ttu-id="d37d2-405">[[削除] 列が Tito 以外のユーザーによって閲覧されたときにはレンダリングされません (例 ![)。](user-based-authorization-vb/_static/image35.png)](user-based-authorization-vb/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-405">[![The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)](user-based-authorization-vb/_static/image35.png)](user-based-authorization-vb/_static/image34.png)</span></span>

<span data-ttu-id="d37d2-406">**図 12**: [削除] 列が Tito 以外のユーザーによって閲覧されたときに表示されない (たとえば、[クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image36.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-406">**Figure 12**: The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)  ([Click to view full-size image](user-based-authorization-vb/_static/image36.png))</span></span>

<span data-ttu-id="d37d2-407">[削除列が Tito に表示さ ![](user-based-authorization-vb/_static/image38.png)](user-based-authorization-vb/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-407">[![The Delete Column is Rendered for Tito](user-based-authorization-vb/_static/image38.png)](user-based-authorization-vb/_static/image37.png)</span></span>

<span data-ttu-id="d37d2-408">**図 13**: Delete 列が Tito に表示される ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image39.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-408">**Figure 13**: The Delete Column is Rendered for Tito  ([Click to view full-size image](user-based-authorization-vb/_static/image39.png))</span></span>

## <a name="step-4-applying-authorization-rules-to-classes-and-methods"></a><span data-ttu-id="d37d2-409">手順 4: クラスとメソッドに承認規則を適用する</span><span class="sxs-lookup"><span data-stu-id="d37d2-409">Step 4: Applying Authorization Rules to Classes and Methods</span></span>

<span data-ttu-id="d37d2-410">手順3では、匿名ユーザーがファイルの内容を表示できないようにし、すべてのユーザーがファイルを削除することを禁止しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-410">In Step 3 we disallowed anonymous users from viewing a file's contents and prohibited all users but Tito from deleting files.</span></span> <span data-ttu-id="d37d2-411">これは、認証されていない訪問者に関連付けられたユーザーインターフェイス要素を、宣言型およびプログラムによって非表示にすることによって実現</span><span class="sxs-lookup"><span data-stu-id="d37d2-411">This was accomplished by hiding the associated user interface elements for unauthorized visitors through declarative and programmatic techniques.</span></span> <span data-ttu-id="d37d2-412">単純な例では、ユーザーインターフェイス要素を適切に非表示にするのは簡単ですが、同じ機能を実行するためのさまざまな方法がある複雑なサイトについてはどうでしょうか。</span><span class="sxs-lookup"><span data-stu-id="d37d2-412">For our simple example, properly hiding the user interface elements was straightforward, but what about more complex sites where there may be many different ways to perform the same functionality?</span></span> <span data-ttu-id="d37d2-413">この機能を承認されていないユーザーに制限する際、適用可能なすべてのユーザーインターフェイス要素を非表示にしたり、無効にしたりした場合はどうなりますか。</span><span class="sxs-lookup"><span data-stu-id="d37d2-413">In limiting that functionality to unauthorized users, what happens if we forget to hide or disable all of the applicable user interface elements?</span></span>

<span data-ttu-id="d37d2-414">権限のないユーザーが特定の機能にアクセスできないようにする簡単な方法は、そのクラスまたはメソッドを[`PrincipalPermission` 属性](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx)で修飾することです。</span><span class="sxs-lookup"><span data-stu-id="d37d2-414">An easy way to ensure that a particular piece of functionality cannot be accessed by an unauthorized user is to decorate that class or method with the [`PrincipalPermission` attribute](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx).</span></span> <span data-ttu-id="d37d2-415">.NET ランタイムでクラスを使用する場合、またはメソッドのいずれかを実行する場合は、現在のセキュリティコンテキストにクラスを使用するか、メソッドを実行するアクセス許可があるかどうかがチェックされます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-415">When the .NET runtime uses a class or executes one of its methods, it checks to ensure that the current security context has permission to use the class or execute the method.</span></span> <span data-ttu-id="d37d2-416">`PrincipalPermission` 属性は、これらの規則を定義できるメカニズムを提供します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-416">The `PrincipalPermission` attribute provides a mechanism through which we can define these rules.</span></span>

<span data-ttu-id="d37d2-417">GridView の `SelectedIndexChanged` および `RowDeleting` イベントハンドラーの `PrincipalPermission` 属性を使用して、Tito 以外の匿名ユーザーとユーザーによる実行を禁止する方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-417">Let's demonstrate using the `PrincipalPermission` attribute on the GridView's `SelectedIndexChanged` and `RowDeleting` event handlers to prohibit execution by anonymous users and users other than Tito, respectively.</span></span> <span data-ttu-id="d37d2-418">それぞれの関数定義の上に適切な属性を追加するだけで十分です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-418">All we need to do is add the appropriate attribute atop each function definition:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample22.vb)]

<span data-ttu-id="d37d2-419">`SelectedIndexChanged` イベントハンドラーの属性は、認証されたユーザーのみがイベントハンドラーを実行できることを指定します。この場合、`RowDeleting` イベントハンドラーの属性によって実行が Tito に制限されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-419">The attribute for the `SelectedIndexChanged` event handler dictates that only authenticated users can execute the event handler, where as the attribute on the `RowDeleting` event handler limits the execution to Tito.</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-420">属性は、クラス、メソッド、プロパティ、またはイベントに適用できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-420">An attribute can be applied to a class, method, property, or event.</span></span> <span data-ttu-id="d37d2-421">属性を追加するときは、クラス、メソッド、プロパティ、またはイベント宣言ステートメントの一部である必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-421">When adding an attribute, it must be part of the class, method, property, or event declaration statement.</span></span> <span data-ttu-id="d37d2-422">Visual Basic では、ステートメントの区切り記号として改行を使用するため、属性は宣言と同じ行に記述するか、または行連結文字 (アンダースコア) で直接指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-422">Since Visual Basic uses line breaks as statement delimiters, attributes must either appear on the same line as the declaration or directly above it with a line continuation character (the underscore).</span></span> <span data-ttu-id="d37d2-423">上記のコードスニペットでは、行連結文字を使用して、属性を1行に、メソッド宣言を別の行に配置しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-423">In the code snippet above, the line continuation character is used to place the attribute on one line and the method declaration on another.</span></span>

<span data-ttu-id="d37d2-424">場合によっては、Tito 以外のユーザーが `RowDeleting` イベントハンドラーを実行しようとするか、認証されていないユーザーが `SelectedIndexChanged` イベントハンドラーを実行しようとすると、.NET ランタイムによって `SecurityException`が発生します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-424">If, somehow, a user other than Tito attempts to execute the `RowDeleting` event handler or a non-authenticated user attempts to execute the `SelectedIndexChanged` event handler, the .NET runtime will raise a `SecurityException`.</span></span>

<span data-ttu-id="d37d2-425">[![、セキュリティコンテキストにメソッドの実行が許可されていない場合は、SecurityException がスローされます。](user-based-authorization-vb/_static/image41.png)](user-based-authorization-vb/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="d37d2-425">[![If the Security Context is not Authorized to Execute the Method, a SecurityException is Thrown](user-based-authorization-vb/_static/image41.png)](user-based-authorization-vb/_static/image40.png)</span></span>

<span data-ttu-id="d37d2-426">**図 14**: セキュリティコンテキストにメソッドの実行が許可されていない場合は、`SecurityException` がスローされます ([クリックすると、フルサイズの画像が表示](user-based-authorization-vb/_static/image42.png)されます)</span><span class="sxs-lookup"><span data-stu-id="d37d2-426">**Figure 14**: If the Security Context is not Authorized to Execute the Method, a `SecurityException` is Thrown  ([Click to view full-size image](user-based-authorization-vb/_static/image42.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d37d2-427">複数のセキュリティコンテキストでクラスまたはメソッドにアクセスできるようにするには、各セキュリティコンテキストの `PrincipalPermission` 属性を使用して、クラスまたはメソッドを装飾します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-427">To allow multiple security contexts to access a class or method, decorate the class or method with a `PrincipalPermission` attribute for each security context.</span></span> <span data-ttu-id="d37d2-428">つまり、Tito と `RowDeleting` の両方のイベントハンドラーを実行できるようにするには、次の*2 つ*の `PrincipalPermission` 属性を追加します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-428">That is, to allow both Tito and Bruce to execute the `RowDeleting` event handler, add *two* `PrincipalPermission` attributes:</span></span>

[!code-vb[Main](user-based-authorization-vb/samples/sample23.vb)]

<span data-ttu-id="d37d2-429">ASP.NET ページに加えて、多くのアプリケーションには、ビジネスロジックやデータアクセス層などのさまざまなレイヤーを含むアーキテクチャもあります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-429">In addition to ASP.NET pages, many applications also have an architecture that includes various layers, such as Business Logic and Data Access Layers.</span></span> <span data-ttu-id="d37d2-430">これらのレイヤーは、通常、クラスライブラリとして実装され、ビジネスロジックおよびデータに関連する機能を実行するためのクラスとメソッドを提供します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-430">These layers are typically implemented as Class Libraries and offer classes and methods for performing business logic- and data-related functionality.</span></span> <span data-ttu-id="d37d2-431">`PrincipalPermission` 属性は、これらのレイヤーに承認規則を適用する場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="d37d2-431">The `PrincipalPermission` attribute is useful for applying authorization rules to these layers.</span></span>

<span data-ttu-id="d37d2-432">`PrincipalPermission` 属性を使用してクラスとメソッドの承認規則を定義する方法の詳細については、 [Scott Guthrie](https://weblogs.asp.net/scottgu/)のブログ記事「 [`PrincipalPermissionAttributes`を使用したビジネス層およびデータ層への承認規則の追加](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-432">For more information on using the `PrincipalPermission` attribute to define authorization rules on classes and methods, refer to [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog entry [Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="d37d2-433">要約</span><span class="sxs-lookup"><span data-stu-id="d37d2-433">Summary</span></span>

<span data-ttu-id="d37d2-434">このチュートリアルでは、ユーザーベースの承認規則を適用する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-434">In this tutorial we looked at how to apply user-based authorization rules.</span></span> <span data-ttu-id="d37d2-435">ASP の概要について説明しました。NET の URL 承認フレームワーク。</span><span class="sxs-lookup"><span data-stu-id="d37d2-435">We started with a look at ASP.NET's URL authorization framework.</span></span> <span data-ttu-id="d37d2-436">各要求で、ASP.NET エンジンの `UrlAuthorizationModule` は、アプリケーションの構成で定義されている URL 承認規則を検査して、要求されたリソースへのアクセスが id に許可されているかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-436">On each request, the ASP.NET engine's `UrlAuthorizationModule` inspects the URL authorization rules defined in the application's configuration to determine whether the identity is authorized to access the requested resource.</span></span> <span data-ttu-id="d37d2-437">つまり、URL 承認を使用すると、特定のページまたは特定のディレクトリ内のすべてのページに対して承認規則を簡単に指定できます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-437">In short, URL authorization makes it easy to specify authorization rules for a specific page or for all pages in a particular directory.</span></span>

<span data-ttu-id="d37d2-438">URL 承認フレームワークは、ページ単位で承認規則を適用します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-438">The URL authorization framework applies authorization rules on a page-by-page basis.</span></span> <span data-ttu-id="d37d2-439">URL 承認では、要求元の id が特定のリソースへのアクセスを承認されているかどうかを示します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-439">With URL authorization, either the requesting identity is authorized to access a particular resource or not.</span></span> <span data-ttu-id="d37d2-440">ただし、多くのシナリオでは、より細かい粒度の承認規則が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-440">Many scenarios, however, call for more fine grain authorization rules.</span></span> <span data-ttu-id="d37d2-441">ページにアクセスできるユーザーを定義するのではなく、すべてのユーザーにページへのアクセスを許可し、別のデータを表示したり、ページにアクセスするユーザーに応じて異なる機能を提供したりすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="d37d2-441">Rather than defining who is permitted to access a page, we may need to let everyone access a page, but to show different data or offer different functionality depending on the user visiting the page.</span></span> <span data-ttu-id="d37d2-442">通常、ページレベルの承認では、許可されていないユーザーが禁止された機能にアクセスするのを防ぐために、特定のユーザーインターフェイス要素を非表示にします。</span><span class="sxs-lookup"><span data-stu-id="d37d2-442">Page-level authorization usually involves hiding specific user interface elements in order to prevent unauthorized users from accessing prohibited functionality.</span></span> <span data-ttu-id="d37d2-443">また、属性を使用して、クラスへのアクセスを制限したり、特定のユーザーに対してメソッドを実行したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-443">Additionally, it is possible to use attributes to restrict access to classes and execution of its methods for certain users.</span></span>

<span data-ttu-id="d37d2-444">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-444">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="d37d2-445">関連項目</span><span class="sxs-lookup"><span data-stu-id="d37d2-445">Further Reading</span></span>

<span data-ttu-id="d37d2-446">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="d37d2-446">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="d37d2-447">`PrincipalPermissionAttributes` を使用したビジネス層およびデータ層への承認規則の追加</span><span class="sxs-lookup"><span data-stu-id="d37d2-447">Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`</span></span>](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)
- [<span data-ttu-id="d37d2-448">ASP.NET 承認</span><span class="sxs-lookup"><span data-stu-id="d37d2-448">ASP.NET Authorization</span></span>](https://msdn.microsoft.com/library/wce3kxhd.aspx)
- [<span data-ttu-id="d37d2-449">IIS6 と IIS7 のセキュリティ間の変更</span><span class="sxs-lookup"><span data-stu-id="d37d2-449">Changes Between IIS6 and IIS7 Security</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/Changes-between-IIS6-and-IIS7-Security)
- [<span data-ttu-id="d37d2-450">特定のファイルとサブディレクトリの構成</span><span class="sxs-lookup"><span data-stu-id="d37d2-450">Configuring Specific Files and Subdirectories</span></span>](https://msdn.microsoft.com/library/6hbkh9s7.aspx)
- [<span data-ttu-id="d37d2-451">ユーザーに基づいてデータ変更機能を制限する</span><span class="sxs-lookup"><span data-stu-id="d37d2-451">Limiting Data Modification Functionality Based on the User</span></span>](../../data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-vb.md)
- [<span data-ttu-id="d37d2-452">LoginView コントロールのクイックスタート</span><span class="sxs-lookup"><span data-stu-id="d37d2-452">LoginView Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/loginview.aspx)
- [<span data-ttu-id="d37d2-453">IIS7 URL 承認について</span><span class="sxs-lookup"><span data-stu-id="d37d2-453">Understanding IIS7 URL Authorization</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization)
- [<span data-ttu-id="d37d2-454">`UrlAuthorizationModule` 技術ドキュメント</span><span class="sxs-lookup"><span data-stu-id="d37d2-454">`UrlAuthorizationModule` Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)
- [<span data-ttu-id="d37d2-455">ASP.NET 2.0 でのデータの操作</span><span class="sxs-lookup"><span data-stu-id="d37d2-455">Working with Data in ASP.NET 2.0</span></span>](../../data-access/index.md)

### <a name="about-the-author"></a><span data-ttu-id="d37d2-456">作成者について</span><span class="sxs-lookup"><span data-stu-id="d37d2-456">About the Author</span></span>

<span data-ttu-id="d37d2-457">1998以降、Microsoft の Web テクノロジを使用して、Scott Mitchell (複数の ASP/創設者4GuysFromRolla.com の執筆者) が Microsoft の Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-457">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d37d2-458">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-458">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d37d2-459">彼の最新の書籍は *[、ASP.NET 2.0 を24時間以内に教え](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* ています。</span><span class="sxs-lookup"><span data-stu-id="d37d2-459">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="d37d2-460">Scott は、 [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)またはブログで[http://ScottOnWriting.NET](http://scottonwriting.net/)にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="d37d2-460">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="d37d2-461">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-461">Special Thanks To</span></span>

<span data-ttu-id="d37d2-462">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="d37d2-462">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="d37d2-463">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="d37d2-463">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="d37d2-464">その場合は、 [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)の行を削除します。</span><span class="sxs-lookup"><span data-stu-id="d37d2-464">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d37d2-465">[前へ](validating-user-credentials-against-the-membership-user-store-vb.md)
> [次へ](storing-additional-user-information-vb.md)</span><span class="sxs-lookup"><span data-stu-id="d37d2-465">[Previous](validating-user-credentials-against-the-membership-user-store-vb.md)
[Next](storing-additional-user-information-vb.md)</span></span>
