---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
title: 新しいレコードを追加するときにファイルアップロードオプションを含める (VB) |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、ユーザーがテキストデータを入力し、バイナリファイルをアップロードするための Web インターフェイスを作成する方法について説明します。 使用可能なオプションについて説明します...
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 5776281d-4637-4d1e-a65b-2621d2cade44
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
msc.type: authoredcontent
ms.openlocfilehash: 8edaf1754eddd7b03f1c323d1bee13238582fc99
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74596877"
---
# <a name="including-a-file-upload-option-when-adding-a-new-record-vb"></a><span data-ttu-id="72c21-104">新しいレコードを追加するとき、ファイル アップロード オプションを含める (VB)</span><span class="sxs-lookup"><span data-stu-id="72c21-104">Including a File Upload Option When Adding a New Record (VB)</span></span>

<span data-ttu-id="72c21-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="72c21-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="72c21-106">[サンプルアプリのダウンロード](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe)または[PDF のダウンロード](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="72c21-106">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span></span>

> <span data-ttu-id="72c21-107">このチュートリアルでは、ユーザーがテキストデータを入力し、バイナリファイルをアップロードするための Web インターフェイスを作成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="72c21-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="72c21-108">バイナリデータを格納するために使用できるオプションを示すために、1つのファイルはデータベースに保存され、もう一方のファイルはファイルシステムに格納されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>

## <a name="introduction"></a><span data-ttu-id="72c21-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="72c21-109">Introduction</span></span>

<span data-ttu-id="72c21-110">前の2つのチュートリアルでは、application s データモデルに関連付けられているバイナリデータを格納する方法について説明しました。 FileUpload コントロールを使用してクライアントから web サーバーにファイルを送信する方法、およびこのバイナリデータをデータに表示する方法について説明しました。eb コントロール。</span><span class="sxs-lookup"><span data-stu-id="72c21-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="72c21-111">ただし、アップロードしたデータをデータモデルに関連付ける方法については、まだ説明していません。</span><span class="sxs-lookup"><span data-stu-id="72c21-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="72c21-112">このチュートリアルでは、新しいカテゴリを追加するための web ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="72c21-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="72c21-113">カテゴリの名前と説明のテキストボックスに加えて、このページには2つの FileUpload コントロールを含める必要があります。1つは新しいカテゴリの画像用で、もう1つはパンフレット用です。</span><span class="sxs-lookup"><span data-stu-id="72c21-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="72c21-114">アップロードした画像は、[新しいレコード s `Picture`] 列に直接保存されます。一方、[新しいレコード] `BrochurePath` 列に保存されたファイルへのパスを使用して、`~/Brochures` フォルダーにパンフレットが保存されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="72c21-115">この新しい web ページを作成する前に、アーキテクチャを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="72c21-116">`CategoriesTableAdapter` s メインクエリでは、`Picture` 列は取得されません。</span><span class="sxs-lookup"><span data-stu-id="72c21-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="72c21-117">このため、自動生成される `Insert` メソッドには、`CategoryName`、`Description`、および `BrochurePath` の各フィールドの入力のみがあります。</span><span class="sxs-lookup"><span data-stu-id="72c21-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="72c21-118">そのため、4つのすべての `Categories` フィールドを入力するように求める、TableAdapter に追加のメソッドを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="72c21-119">ビジネスロジック層の `CategoriesBLL` クラスも更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="72c21-120">手順 1:`CategoriesTableAdapter` に`InsertWithPicture`メソッドを追加する</span><span class="sxs-lookup"><span data-stu-id="72c21-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="72c21-121">「[データアクセス層の作成](../introduction/creating-a-data-access-layer-vb.md)」チュートリアルで `CategoriesTableAdapter` を作成したときに、メインクエリに基づいて `INSERT`、`UPDATE`、および `DELETE` ステートメントを自動的に生成するように構成しました。</span><span class="sxs-lookup"><span data-stu-id="72c21-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="72c21-122">さらに、`Insert`、`Update`、および `Delete`メソッドを作成した DB Direct アプローチを採用するように TableAdapter に指示しました。</span><span class="sxs-lookup"><span data-stu-id="72c21-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="72c21-123">これらのメソッドは、自動生成された `INSERT`、`UPDATE`、および `DELETE` ステートメントを実行し、その結果、メインクエリによって返される列に基づいて入力パラメーターを受け取ります。</span><span class="sxs-lookup"><span data-stu-id="72c21-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="72c21-124">ファイルの[アップロード](uploading-files-vb.md)に関するチュートリアルでは、`BrochurePath` 列を使用するように `CategoriesTableAdapter` s メインクエリを拡張しました。</span><span class="sxs-lookup"><span data-stu-id="72c21-124">In the [Uploading Files](uploading-files-vb.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="72c21-125">`CategoriesTableAdapter` s メインクエリは `Picture` 列を参照しないため、新しいレコードを追加したり、`Picture` 列の値を持つ既存のレコードを更新したりすることはできません。</span><span class="sxs-lookup"><span data-stu-id="72c21-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="72c21-126">この情報を取得するには、バイナリデータを含むレコードを挿入するために特に使用される、TableAdapter に新しいメソッドを作成するか、自動生成される `INSERT` ステートメントをカスタマイズします。</span><span class="sxs-lookup"><span data-stu-id="72c21-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="72c21-127">自動生成される `INSERT` ステートメントのカスタマイズに関する問題は、カスタマイズがウィザードによって上書きされる危険性があるということです。</span><span class="sxs-lookup"><span data-stu-id="72c21-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="72c21-128">たとえば、`Picture` 列を使用するように `INSERT` ステートメントをカスタマイズしたとします。</span><span class="sxs-lookup"><span data-stu-id="72c21-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="72c21-129">これにより、TableAdapter の `Insert` メソッドが更新され、category s picture s バイナリデータに対する追加の入力パラメーターが追加されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="72c21-130">その後、ビジネスロジック層でメソッドを作成して、この DAL メソッドを使用し、プレゼンテーション層を介してこの BLL メソッドを呼び出すことができます。これにより、すべての処理がてされます。</span><span class="sxs-lookup"><span data-stu-id="72c21-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="72c21-131">つまり、次に TableAdapter 構成ウィザードを使用して TableAdapter を構成するまでの間です。</span><span class="sxs-lookup"><span data-stu-id="72c21-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="72c21-132">ウィザードが完了するとすぐに、`INSERT` ステートメントに対するカスタマイズが上書きされ、`Insert` メソッドが古い形式に戻り、コードはコンパイルされなくなります。</span><span class="sxs-lookup"><span data-stu-id="72c21-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="72c21-133">アドホック SQL ステートメントではなくストアドプロシージャを使用する場合、この問題は発生しません。</span><span class="sxs-lookup"><span data-stu-id="72c21-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="72c21-134">今後のチュートリアルでは、データアクセス層でアドホック SQL ステートメントの代わりにストアドプロシージャを使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="72c21-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>

<span data-ttu-id="72c21-135">自動生成された SQL ステートメントをカスタマイズするのではなく、このような問題を回避するには、代わりに TableAdapter の新しいメソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="72c21-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="72c21-136">`InsertWithPicture`という名前のこのメソッドは、`CategoryName`、`Description`、`BrochurePath`、および `Picture` の各列の値を受け取り、4つのすべての値を新しいレコードに格納する `INSERT` ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="72c21-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="72c21-137">型指定されたデータセットを開き、デザイナーで `CategoriesTableAdapter` s ヘッダーを右クリックし、コンテキストメニューから [クエリの追加] を選択します。</span><span class="sxs-lookup"><span data-stu-id="72c21-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="72c21-138">これにより、tableadapter クエリの構成ウィザードが起動します。このウィザードでは、まず TableAdapter クエリがデータベースにアクセスする方法を尋ねます。</span><span class="sxs-lookup"><span data-stu-id="72c21-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="72c21-139">[SQL ステートメントを使用する] を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="72c21-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="72c21-140">次の手順では、生成するクエリの種類を指定します。</span><span class="sxs-lookup"><span data-stu-id="72c21-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="72c21-141">`Categories` テーブルに新しいレコードを追加するクエリを作成したので、[挿入] を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="72c21-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>

<span data-ttu-id="72c21-142">[![[挿入] オプションを選択します。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span></span>

<span data-ttu-id="72c21-143">**図 1**: [挿入] オプションを選択[する (クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span></span>

<span data-ttu-id="72c21-144">次に、`INSERT` SQL ステートメントを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="72c21-145">このウィザードでは、TableAdapter のメインクエリに対応する `INSERT` ステートメントが自動的に提示されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="72c21-146">この場合、`CategoryName`、`Description`、および `BrochurePath` の値を挿入する `INSERT` ステートメントです。</span><span class="sxs-lookup"><span data-stu-id="72c21-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="72c21-147">次のように、`@Picture` のパラメーターと共に `Picture` 列が含まれるようにステートメントを更新します。</span><span class="sxs-lookup"><span data-stu-id="72c21-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>

[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample1.sql)]

<span data-ttu-id="72c21-148">ウィザードの最後の画面では、新しい TableAdapter メソッドに名前を指定するように求められます。</span><span class="sxs-lookup"><span data-stu-id="72c21-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="72c21-149">`InsertWithPicture` を入力し、[完了] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="72c21-149">Enter `InsertWithPicture` and click Finish.</span></span>

<span data-ttu-id="72c21-150">[新しい TableAdapter メソッド InsertWithPicture の ![名前](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span></span>

<span data-ttu-id="72c21-151">**図 2**: 新しい TableAdapter メソッドに名前を指定[する `InsertWithPicture` (クリックすると、フルサイズのイメージが表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span></span>

## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="72c21-152">手順 2: ビジネスロジック層を更新する</span><span class="sxs-lookup"><span data-stu-id="72c21-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="72c21-153">プレゼンテーション層は、データアクセス層に直接アクセスするのをバイパスするのではなく、ビジネスロジック層とのみインターフェイスする必要があるため、先ほど作成した DAL メソッド (`InsertWithPicture`) を呼び出す BLL メソッドを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="72c21-154">このチュートリアルでは、`InsertWithPicture` という名前の `CategoriesBLL` クラスにメソッドを作成します。このクラスは、3つの `String` s と `Byte` の配列を入力として受け取ります。</span><span class="sxs-lookup"><span data-stu-id="72c21-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `String` s and a `Byte` array.</span></span> <span data-ttu-id="72c21-155">`String` 入力パラメーターは、カテゴリの名前、説明、およびパンフレットファイルパス用であり、`Byte` 配列は category s picture のバイナリコンテンツ用です。</span><span class="sxs-lookup"><span data-stu-id="72c21-155">The `String` input parameters are for the category s name, description, and brochure file path, while the `Byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="72c21-156">次のコードに示すように、この BLL メソッドは対応する DAL メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="72c21-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample2.vb)]

> [!NOTE]
> <span data-ttu-id="72c21-157">`InsertWithPicture` メソッドを BLL に追加する前に、型指定されたデータセットを保存したことを確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="72c21-158">`CategoriesTableAdapter` クラスコードは型指定されたデータセットに基づいて自動生成されるため、最初に変更を型指定されたデータセットに保存しない場合、`Adapter` プロパティは `InsertWithPicture` メソッドについて認識しません。</span><span class="sxs-lookup"><span data-stu-id="72c21-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won't know about the `InsertWithPicture` method.</span></span>

## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="72c21-159">手順 3: 既存のカテゴリとそのバイナリデータを一覧表示する</span><span class="sxs-lookup"><span data-stu-id="72c21-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="72c21-160">このチュートリアルでは、エンドユーザーがシステムに新しいカテゴリを追加するためのページを作成し、新しいカテゴリの画像とパンフレットを提供します。</span><span class="sxs-lookup"><span data-stu-id="72c21-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="72c21-161">前の[チュートリアル](displaying-binary-data-in-the-data-web-controls-vb.md)では、GridView と TemplateField と imagefield を使用して、各カテゴリの名前、説明、画像、およびそのパンフレットをダウンロードするためのリンクを表示しました。</span><span class="sxs-lookup"><span data-stu-id="72c21-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-vb.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="72c21-162">このチュートリアルでは、この機能をレプリケートして、既存のすべてのカテゴリを一覧表示し、新しいものを作成できるページを作成します。</span><span class="sxs-lookup"><span data-stu-id="72c21-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="72c21-163">まず、`BinaryData` フォルダーから [`DisplayOrDownload.aspx`] ページを開きます。</span><span class="sxs-lookup"><span data-stu-id="72c21-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="72c21-164">ソースビューにアクセスし、GridView および ObjectDataSource s 宣言構文をコピーして、`UploadInDetailsView.aspx`の `<asp:Content>` 要素内に貼り付けます。</span><span class="sxs-lookup"><span data-stu-id="72c21-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="72c21-165">また、`DisplayOrDownload.aspx` の分離コードクラスから `UploadInDetailsView.aspx`に `GenerateBrochureLink` メソッドをコピーすることも忘れないでください。</span><span class="sxs-lookup"><span data-stu-id="72c21-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>

<span data-ttu-id="72c21-166">[DisplayOrDownload から UploadInDetailsView .aspx に宣言型の構文をコピーして貼り付ける ![](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span></span>

<span data-ttu-id="72c21-167">**図 3**: `DisplayOrDownload.aspx` から `UploadInDetailsView.aspx` に宣言構文をコピーして貼り付ける ([クリックしてフルサイズのイメージを表示する](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="72c21-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span></span>

<span data-ttu-id="72c21-168">宣言構文と `GenerateBrochureLink` メソッドを `UploadInDetailsView.aspx` ページにコピーした後、ブラウザーを使用してページを表示し、すべてが正しくコピーされたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="72c21-169">この GridView には、パンフレットと category s 画像をダウンロードするためのリンクを含む8つのカテゴリが一覧表示されています。</span><span class="sxs-lookup"><span data-stu-id="72c21-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>

<span data-ttu-id="72c21-170">[![各カテゴリがそのバイナリデータと共に表示されるようになります。](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span></span>

<span data-ttu-id="72c21-171">**図 4**: 各カテゴリがバイナリデータと共に表示されるようになりました ([クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png)される)</span><span class="sxs-lookup"><span data-stu-id="72c21-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span></span>

## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="72c21-172">手順 4: 挿入をサポートするための`CategoriesDataSource`の構成</span><span class="sxs-lookup"><span data-stu-id="72c21-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="72c21-173">現在 `Categories` GridView によって使用されている `CategoriesDataSource` ObjectDataSource では、データを挿入する機能が提供されていません。</span><span class="sxs-lookup"><span data-stu-id="72c21-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="72c21-174">このデータソースコントロールの挿入をサポートするには、その `Insert` メソッドを、基になるオブジェクトのメソッドにマップする必要があり `CategoriesBLL`ます。</span><span class="sxs-lookup"><span data-stu-id="72c21-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="72c21-175">特に、手順2、`InsertWithPicture`で追加した `CategoriesBLL` メソッドにマップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="72c21-176">最初に、ObjectDataSource s スマートタグから [データソースの構成] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="72c21-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="72c21-177">最初の画面には、データソースが使用するように構成されているオブジェクト (`CategoriesBLL`) が表示されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="72c21-178">この設定はそのままにして [次へ] をクリックし、[データメソッドの定義] 画面に進みます。</span><span class="sxs-lookup"><span data-stu-id="72c21-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="72c21-179">[挿入] タブに移動し、ドロップダウンリストから `InsertWithPicture` メソッドを選択します。</span><span class="sxs-lookup"><span data-stu-id="72c21-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="72c21-180">[完了] をクリックしてウィザードを終了します。</span><span class="sxs-lookup"><span data-stu-id="72c21-180">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="72c21-181">[InsertWithPicture メソッドを使用するように ObjectDataSource を構成 ![には](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span></span>

<span data-ttu-id="72c21-182">**図 5**: `InsertWithPicture` メソッドを使用するように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="72c21-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span></span>

> [!NOTE]
> <span data-ttu-id="72c21-183">ウィザードを完了すると、フィールドとキーを更新するかどうかを確認するメッセージが表示され、データ Web コントロールのフィールドが再生成されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="72c21-184">[はい] を選択すると、実行したフィールドのカスタマイズがすべて上書きされます。</span><span class="sxs-lookup"><span data-stu-id="72c21-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>

<span data-ttu-id="72c21-185">ウィザードを完了すると、次の宣言型マークアップに示すように、ObjectDataSource には `InsertMethod` プロパティの値と4つのカテゴリの列の `InsertParameters` が含まれるようになります。</span><span class="sxs-lookup"><span data-stu-id="72c21-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="72c21-186">手順 5: 挿入インターフェイスの作成</span><span class="sxs-lookup"><span data-stu-id="72c21-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="72c21-187">[「データの挿入、更新、および削除の概要](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md)」で最初に説明したように、DetailsView コントロールには、挿入をサポートするデータソースコントロールを操作するときに使用できる組み込みの挿入インターフェイスが用意されています。</span><span class="sxs-lookup"><span data-stu-id="72c21-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="72c21-188">ここでは、挿入インターフェイスを永続的にレンダリングする GridView の上のページに DetailsView コントロールを追加します。これにより、ユーザーが新しいカテゴリをすばやく追加できるようになります。</span><span class="sxs-lookup"><span data-stu-id="72c21-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="72c21-189">DetailsView に新しいカテゴリを追加すると、その下にある GridView が自動的に更新され、新しいカテゴリが表示されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="72c21-190">まず、[ツールボックス] から [DetailsView] を GridView のデザイナーにドラッグし、その `ID` プロパティを `NewCategory` に設定して、`Height` と `Width` のプロパティ値をクリアします。</span><span class="sxs-lookup"><span data-stu-id="72c21-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="72c21-191">DetailsView s スマートタグから既存の `CategoriesDataSource` にバインドし、[挿入を有効にする] チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="72c21-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>

<span data-ttu-id="72c21-192">[DetailsView をカテゴリデータソースにバインドし、挿入を有効に ![には](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span></span>

<span data-ttu-id="72c21-193">**図 6**: DetailsView を `CategoriesDataSource` にバインドし、挿入を有効にする ([クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span></span>

<span data-ttu-id="72c21-194">挿入インターフェイスで DetailsView を完全にレンダリングするには、その `DefaultMode` プロパティを `Insert`に設定します。</span><span class="sxs-lookup"><span data-stu-id="72c21-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="72c21-195">DetailsView には、`CategoryID`、`CategoryName`、`Description`、`NumberOfProducts`、および `BrochurePath` の5つの連結されたフィールドがありますが、`CategoryID` のプロパティが `InsertVisible` に設定されているため、挿入インターフェイスに `False`BoundField はレンダリングされません。</span><span class="sxs-lookup"><span data-stu-id="72c21-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `False`.</span></span> <span data-ttu-id="72c21-196">これらの BoundFields は、`GetCategories()` メソッドによって返される列であるため存在します。これは、ObjectDataSource がデータを取得するために呼び出すものです。</span><span class="sxs-lookup"><span data-stu-id="72c21-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="72c21-197">ただし、挿入の場合は、`NumberOfProducts`の値をユーザーに指定させないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="72c21-198">さらに、新しいカテゴリの画像をアップロードしたり、そのパンフレットの PDF をアップロードしたりできるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="72c21-199">DetailsView から `NumberOfProducts` BoundField を完全に削除してから、`CategoryName` と `BrochurePath` BoundFields の `HeaderText` プロパティをそれぞれ Category とパンフレットに更新します。</span><span class="sxs-lookup"><span data-stu-id="72c21-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="72c21-200">次に、`BrochurePath` BoundField を TemplateField に変換し、画像の新しい TemplateField を追加して、この新しい TemplateField `HeaderText` に Picture という値を与えます。</span><span class="sxs-lookup"><span data-stu-id="72c21-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="72c21-201">`Picture` TemplateField を `BrochurePath` TemplateField と CommandField の間に移動します。</span><span class="sxs-lookup"><span data-stu-id="72c21-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>

![DetailsView をカテゴリデータソースにバインドし、挿入を有効にする](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.gif)

<span data-ttu-id="72c21-203">**図 7**: DetailsView を `CategoriesDataSource` にバインドし、挿入を有効にする</span><span class="sxs-lookup"><span data-stu-id="72c21-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>

<span data-ttu-id="72c21-204">[フィールドの編集] ダイアログボックスを使用して `BrochurePath` BoundField を TemplateField に変換した場合、TemplateField には、`ItemTemplate`、`EditItemTemplate`、および `InsertItemTemplate`が含まれます。</span><span class="sxs-lookup"><span data-stu-id="72c21-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="72c21-205">ただし、必要なのは `InsertItemTemplate` だけです。そのため、他の2つのテンプレートを削除してもかまいません。</span><span class="sxs-lookup"><span data-stu-id="72c21-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="72c21-206">この時点で、DetailsView s 宣言構文は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="72c21-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="72c21-207">パンフレットと画像のフィールドの FileUpload コントロールを追加する</span><span class="sxs-lookup"><span data-stu-id="72c21-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="72c21-208">現在、`BrochurePath` TemplateField s `InsertItemTemplate` にはテキストボックスが含まれていますが、`Picture` の TemplateField にはテンプレートが含まれていません。</span><span class="sxs-lookup"><span data-stu-id="72c21-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="72c21-209">FileUpload コントロールを使用するには、これらの2つの TemplateField s `InsertItemTemplate` s を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="72c21-210">DetailsView s スマートタグから、[テンプレートの編集] オプションを選択し、ドロップダウンリストから `BrochurePath` TemplateField s `InsertItemTemplate` を選択します。</span><span class="sxs-lookup"><span data-stu-id="72c21-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="72c21-211">テキストボックスを削除し、FileUpload コントロールをツールボックスからテンプレートにドラッグします。</span><span class="sxs-lookup"><span data-stu-id="72c21-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="72c21-212">FileUpload コントロール s `ID` を `BrochureUpload`に設定します。</span><span class="sxs-lookup"><span data-stu-id="72c21-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="72c21-213">同様に、FileUpload コントロールを `Picture` TemplateField s `InsertItemTemplate`に追加します。</span><span class="sxs-lookup"><span data-stu-id="72c21-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="72c21-214">この FileUpload コントロール s `ID` を `PictureUpload`に設定します。</span><span class="sxs-lookup"><span data-stu-id="72c21-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>

<span data-ttu-id="72c21-215">[FileUpload コントロールを Insertitemposition に追加 ![には](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span></span>

<span data-ttu-id="72c21-216">**図 8**: `InsertItemTemplate` に FileUpload コントロールを追加する ([クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span></span>

<span data-ttu-id="72c21-217">これらの追加を行った後、2つの TemplateField s 宣言構文は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="72c21-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample5.aspx)]

<span data-ttu-id="72c21-218">ユーザーが新しいカテゴリを追加するときに、パンフレットと画像が正しいファイルの種類であることを確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="72c21-219">パンフレットの場合、ユーザーは PDF を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="72c21-220">画像の場合、ユーザーはイメージファイルをアップロードする必要がありますが、画像ファイルや、Gif や Jpg など、特定の種類のイメージファイルのみ*を許可し*ますか。</span><span class="sxs-lookup"><span data-stu-id="72c21-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="72c21-221">さまざまなファイルの種類に対応するために、`Categories` スキーマを拡張して、ファイルの種類をキャプチャする列を含める必要があります。これにより、`DisplayCategoryPicture.aspx`の `Response.ContentType` を通じてこの型をクライアントに送信できるようになります。</span><span class="sxs-lookup"><span data-stu-id="72c21-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="72c21-222">このような列を持っていないので、ユーザーが特定の画像ファイルの種類のみを提供するように制限することは賢明です。</span><span class="sxs-lookup"><span data-stu-id="72c21-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="72c21-223">`Categories` table s の既存の画像はビットマップですが、Jpg は web 経由で提供される画像に適したファイル形式です。</span><span class="sxs-lookup"><span data-stu-id="72c21-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="72c21-224">ユーザーが正しくないファイルの種類をアップロードした場合は、挿入をキャンセルし、問題を示すメッセージを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="72c21-225">DetailsView の下にラベル Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="72c21-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="72c21-226">`ID` プロパティを `UploadWarning`に設定し、`Text` プロパティをオフにします。 `CssClass` プロパティを Warning に設定し、`Visible` プロパティと `EnableViewState` プロパティを `False`に設定します。</span><span class="sxs-lookup"><span data-stu-id="72c21-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="72c21-227">`Warning` CSS クラスは `Styles.css` で定義され、大きな、赤、斜体、太字のフォントでテキストをレンダリングします。</span><span class="sxs-lookup"><span data-stu-id="72c21-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="72c21-228">理想的には、`CategoryName` および `Description` BoundFields を TemplateFields に変換し、その挿入インターフェイスをカスタマイズします。</span><span class="sxs-lookup"><span data-stu-id="72c21-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="72c21-229">たとえば、`Description` の挿入インターフェイスは、複数行のテキストボックスを使用する方が適している場合があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="72c21-230">また、`CategoryName` 列では `NULL` 値が受け付けられないため、RequiredFieldValidator を追加して、ユーザーが新しいカテゴリ名の値を確実に提供するようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="72c21-231">これらの手順は、読者のための演習として残されています。</span><span class="sxs-lookup"><span data-stu-id="72c21-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="72c21-232">データ変更インターフェイスの詳細については、「[データ変更インターフェイスのカスタマイズ](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="72c21-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) for an in-depth look at augmenting the data modification interfaces.</span></span>

## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="72c21-233">手順 6: アップロードしたパンフレットを Web サーバーのファイルシステムに保存する</span><span class="sxs-lookup"><span data-stu-id="72c21-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="72c21-234">ユーザーが新しいカテゴリの値を入力して [挿入] ボタンをクリックすると、ポストバックが発生し、挿入ワークフローが上されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="72c21-235">まず、DetailsView s [`ItemInserting` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx)が発生します。</span><span class="sxs-lookup"><span data-stu-id="72c21-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="72c21-236">次に、ObjectDataSource s `Insert()` メソッドが呼び出され、その結果、`Categories` テーブルに新しいレコードが追加されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="72c21-237">その後、DetailsView s [`ItemInserted` イベント](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx)が発生します。</span><span class="sxs-lookup"><span data-stu-id="72c21-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="72c21-238">ObjectDataSource s `Insert()` メソッドが呼び出される前に、適切なファイルの種類がユーザーによってアップロードされたことを確認し、その後、web サーバーのファイルシステムにパンフレット PDF を保存する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="72c21-239">DetailsView s `ItemInserting` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="72c21-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample6.vb)]

<span data-ttu-id="72c21-240">イベントハンドラーは、DetailsView s テンプレートから `BrochureUpload` FileUpload コントロールを参照することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="72c21-241">次に、パンフレットがアップロードされている場合、アップロードされたファイルの拡張子が調べられます。</span><span class="sxs-lookup"><span data-stu-id="72c21-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="72c21-242">拡張機能がではない場合。PDF では、警告が表示され、挿入が取り消され、イベントハンドラーの実行が終了します。</span><span class="sxs-lookup"><span data-stu-id="72c21-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="72c21-243">アップロードしたファイルの拡張子に依存することは、アップロードされたファイルが PDF ドキュメントであることを保証するための、確実な方法ではありません。</span><span class="sxs-lookup"><span data-stu-id="72c21-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="72c21-244">ユーザーは、拡張子が `.Brochure`の有効な PDF ドキュメントを作成したり、PDF 以外のドキュメントを取得して `.pdf` の拡張子を付けたりすることができます。</span><span class="sxs-lookup"><span data-stu-id="72c21-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="72c21-245">ファイルの種類をさらに効果に確認するには、ファイルのバイナリコンテンツをプログラムで調べておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="72c21-246">ただし、このような一般的なアプローチは過剰です。ほとんどのシナリオでは、拡張機能を確認するだけで十分です。</span><span class="sxs-lookup"><span data-stu-id="72c21-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>

<span data-ttu-id="72c21-247">[ファイル](uploading-files-vb.md)のアップロードに関するチュートリアルで説明したように、ファイルをファイルシステムに保存するときは注意が必要です。これにより、1人のユーザーのアップロードで別のが上書きされることはありません。</span><span class="sxs-lookup"><span data-stu-id="72c21-247">As discussed in the [Uploading Files](uploading-files-vb.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="72c21-248">このチュートリアルでは、アップロードしたファイルと同じ名前を使用しようとします。</span><span class="sxs-lookup"><span data-stu-id="72c21-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="72c21-249">ただし、同じファイル名のファイルが `~/Brochures` ディレクトリに既に存在する場合は、一意の名前が見つかるまで、末尾に数字を追加します。</span><span class="sxs-lookup"><span data-stu-id="72c21-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="72c21-250">たとえば、ユーザーが `Meats.pdf`という名前のパンフレットファイルをアップロードしても、`~/Brochures` フォルダーに `Meats.pdf` という名前のファイルが既に存在する場合は、保存したファイル名を `Meats-1.pdf`に変更します。</span><span class="sxs-lookup"><span data-stu-id="72c21-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="72c21-251">それが存在する場合は、一意のファイル名が見つかるまで、`Meats-2.pdf`します。</span><span class="sxs-lookup"><span data-stu-id="72c21-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="72c21-252">次のコードでは、 [`File.Exists(path)` メソッド](https://msdn.microsoft.com/library/system.io.file.exists.aspx)を使用して、指定したファイル名のファイルが既に存在するかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="72c21-253">その場合は、競合が見つからなくなるまで、パンフレットの新しいファイル名を試してみてください。</span><span class="sxs-lookup"><span data-stu-id="72c21-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample7.vb)]

<span data-ttu-id="72c21-254">有効なファイル名が見つかったら、ファイルをファイルシステムに保存する必要があります。また、このファイル名がデータベースに書き込まれるように ObjectDataSource s `brochurePath``InsertParameter` 値を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="72c21-255">*ファイルのアップロード*に関するチュートリアルに戻ってきたように、FileUpload control s `SaveAs(path)` メソッドを使用してファイルを保存できます。</span><span class="sxs-lookup"><span data-stu-id="72c21-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="72c21-256">ObjectDataSource s `brochurePath` パラメーターを更新するには、`e.Values` コレクションを使用します。</span><span class="sxs-lookup"><span data-stu-id="72c21-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample8.vb)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="72c21-257">手順 7: アップロードした画像をデータベースに保存する</span><span class="sxs-lookup"><span data-stu-id="72c21-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="72c21-258">アップロードした画像を新しい `Categories` レコードに保存するには、アップロードされたバイナリコンテンツを DetailsView s `ItemInserting` イベントの ObjectDataSource s `picture` パラメーターに割り当てる必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="72c21-259">ただし、この割り当てを行う前に、アップロードした画像が、他の種類のイメージではなく、JPG であることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="72c21-260">手順 6. と同様に、アップロードした画像のファイル拡張子を使用して、その種類を確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="72c21-261">`Categories` テーブルでは `Picture` 列の値を `NULL` ことができますが、すべてのカテゴリには現在画像があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="72c21-262">このページを使用して新しいカテゴリを追加するときに、によってユーザーに画像が提供されるようにします。</span><span class="sxs-lookup"><span data-stu-id="72c21-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="72c21-263">次のコードでは、画像がアップロードされていること、および適切な拡張子を持っていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="72c21-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample9.vb)]

<span data-ttu-id="72c21-264">このコードは、手順6のコードの*前に*配置して、画像のアップロードで問題が発生した場合に、パンフレットファイルがファイルシステムに保存される前にイベントハンドラーが終了するようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="72c21-265">適切なファイルがアップロードされていることを前提として、アップロードしたバイナリコンテンツを picture parameter s 値に割り当てます。次のコード行を使用します。</span><span class="sxs-lookup"><span data-stu-id="72c21-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample10.vb)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="72c21-266">Complete`ItemInserting`イベントハンドラー</span><span class="sxs-lookup"><span data-stu-id="72c21-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="72c21-267">完全を期すために、`ItemInserting` イベントハンドラー全体を次に示します。</span><span class="sxs-lookup"><span data-stu-id="72c21-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample11.vb)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="72c21-268">手順 8:`DisplayCategoryPicture.aspx`ページを修正する</span><span class="sxs-lookup"><span data-stu-id="72c21-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="72c21-269">ここでは、最後のいくつかの手順で作成した、挿入インターフェイスと `ItemInserting` イベントハンドラーをテストします。</span><span class="sxs-lookup"><span data-stu-id="72c21-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="72c21-270">ブラウザーを使用して `UploadInDetailsView.aspx` のページにアクセスし、カテゴリを追加したり、画像を省略したり、JPG 以外の画像や PDF 以外のパンフレットを指定したりします。</span><span class="sxs-lookup"><span data-stu-id="72c21-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="72c21-271">いずれの場合も、エラーメッセージが表示され、挿入ワークフローが取り消されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>

<span data-ttu-id="72c21-272">[無効なファイルの種類がアップロードされた場合に警告メッセージが表示される ![](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span></span>

<span data-ttu-id="72c21-273">**図 9**: 無効なファイルの種類がアップロードされた場合に警告メッセージが表示される ([クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span></span>

<span data-ttu-id="72c21-274">ページで画像をアップロードする必要があることを確認し、PDF 以外のファイルまたは JPG 以外のファイルを受け入れないことを確認したら、有効な JPG 画像を含む新しいカテゴリを追加して、[パンフレット] フィールドを空のままにします。</span><span class="sxs-lookup"><span data-stu-id="72c21-274">Once you have verified that the page requires a picture to be uploaded and won't accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="72c21-275">[挿入] ボタンをクリックすると、ページがポストバックされ、`Categories` テーブルに新しいレコードが追加されます。アップロードした画像は、データベースに直接格納されています。</span><span class="sxs-lookup"><span data-stu-id="72c21-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="72c21-276">GridView が更新され、新しく追加されたカテゴリの行が表示されますが、図10に示すように、新しい category s 画像は正しくレンダリングされません。</span><span class="sxs-lookup"><span data-stu-id="72c21-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>

<span data-ttu-id="72c21-277">[新しいカテゴリ s の画像が表示されていない ![](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span></span>

<span data-ttu-id="72c21-278">**図 10**: 新しいカテゴリの画像は表示されません ([クリックすると、フルサイズの画像が表示](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="72c21-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span></span>

<span data-ttu-id="72c21-279">新しい画像が表示されない理由は、指定されたカテゴリの画像を返す `DisplayCategoryPicture.aspx` ページが OLE ヘッダーを持つビットマップを処理するように構成されているためです。</span><span class="sxs-lookup"><span data-stu-id="72c21-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="72c21-280">この78バイトヘッダーは、クライアントに返される前に、`Picture` の列のバイナリコンテンツから削除されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="72c21-281">しかし、新しいカテゴリにアップロードした JPG ファイルには、この OLE ヘッダーがありません。そのため、有効なバイト数がイメージのバイナリデータから削除されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="72c21-282">`Categories` テーブルに OLE ヘッダーと Jpg の両方のビットマップがあるため、元の8つのカテゴリの OLE ヘッダーを削除し、新しいカテゴリレコードに対してこの削除をバイパスするように `DisplayCategoryPicture.aspx` を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="72c21-283">次のチュートリアルでは、既存のレコード s 画像を更新する方法を確認し、古いカテゴリの画像をすべて更新して Jpg にします。</span><span class="sxs-lookup"><span data-stu-id="72c21-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="72c21-284">ただし現時点では、`DisplayCategoryPicture.aspx` で次のコードを使用して、元の8つのカテゴリについてのみ OLE ヘッダーを削除します。</span><span class="sxs-lookup"><span data-stu-id="72c21-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample12.vb)]

<span data-ttu-id="72c21-285">この変更により、JPG イメージが GridView で正しくレンダリングされるようになりました。</span><span class="sxs-lookup"><span data-stu-id="72c21-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>

<span data-ttu-id="72c21-286">[新しいカテゴリの JPG イメージが正しくレンダリングされる ![](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="72c21-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span></span>

<span data-ttu-id="72c21-287">**図 11**: 新しいカテゴリの JPG イメージが正しくレンダリングされる ([クリックしてフルサイズのイメージを表示する](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="72c21-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span></span>

## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="72c21-288">手順 9: 例外が発生したときにパンフレットを削除する</span><span class="sxs-lookup"><span data-stu-id="72c21-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="72c21-289">バイナリデータを web サーバーのファイルシステムに格納する場合の課題の1つは、データモデルとそのバイナリデータの間に切断を導入することです。</span><span class="sxs-lookup"><span data-stu-id="72c21-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="72c21-290">したがって、レコードが削除されるたびに、ファイルシステム上の対応するバイナリデータも削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="72c21-291">これは、挿入時にも再生されることがあります。</span><span class="sxs-lookup"><span data-stu-id="72c21-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="72c21-292">次のシナリオを考えてみます。ユーザーは、有効な画像とパンフレットを指定して新しいカテゴリを追加します。</span><span class="sxs-lookup"><span data-stu-id="72c21-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="72c21-293">[挿入] ボタンをクリックすると、ポストバックが発生し、DetailsView s `ItemInserting` イベントが発生して、web サーバーのファイルシステムにパンフレットが保存されます。</span><span class="sxs-lookup"><span data-stu-id="72c21-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="72c21-294">次に、ObjectDataSource s `Insert()` メソッドが呼び出されます。このメソッドは、`CategoriesTableAdapter` s `InsertWithPicture` メソッドを呼び出す `CategoriesBLL` クラス s `InsertWithPicture` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="72c21-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="72c21-295">ここで、データベースがオフラインの場合、または `INSERT` SQL ステートメントにエラーがある場合はどうなるでしょうか。</span><span class="sxs-lookup"><span data-stu-id="72c21-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="72c21-296">明示的に挿入が失敗するため、新しいカテゴリ行はデータベースに追加されません。</span><span class="sxs-lookup"><span data-stu-id="72c21-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="72c21-297">しかし、web サーバー s ファイルシステム上には、アップロードされたパンフレットファイルが残っています。</span><span class="sxs-lookup"><span data-stu-id="72c21-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="72c21-298">このファイルは、挿入ワークフロー中に例外が発生したときに削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="72c21-299">前に説明したように、 [ASP.NET Page チュートリアルでは、BLL と DAL レベルの例外を処理](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md)します。アーキテクチャの深度内から例外がスローされると、さまざまなレイヤーによってバブルアップされます。</span><span class="sxs-lookup"><span data-stu-id="72c21-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="72c21-300">プレゼンテーション層で、DetailsView s `ItemInserted` イベントから例外が発生したかどうかを判断できます。</span><span class="sxs-lookup"><span data-stu-id="72c21-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="72c21-301">このイベントハンドラーは、ObjectDataSource s `InsertParameters`の値も提供します。</span><span class="sxs-lookup"><span data-stu-id="72c21-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="72c21-302">そのため、例外が発生したかどうかを確認し、存在する場合は ObjectDataSource s `brochurePath` パラメーターによって指定されたファイルを削除する `ItemInserted` イベントのイベントハンドラーを作成できます。</span><span class="sxs-lookup"><span data-stu-id="72c21-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample13.vb)]

## <a name="summary"></a><span data-ttu-id="72c21-303">要約</span><span class="sxs-lookup"><span data-stu-id="72c21-303">Summary</span></span>

<span data-ttu-id="72c21-304">バイナリデータを含むレコードを追加するための web ベースのインターフェイスを提供するために、いくつかの手順を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="72c21-305">バイナリデータがデータベースに直接格納されている場合、アーキテクチャを更新し、バイナリデータが挿入されるケースを処理するための特定のメソッドを追加する必要が生じる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="72c21-306">アーキテクチャが更新されたら、次の手順では挿入インターフェイスを作成します。これは、バイナリデータフィールドごとに FileUpload コントロールを含めるようにカスタマイズされた DetailsView を使用して実現できます。</span><span class="sxs-lookup"><span data-stu-id="72c21-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="72c21-307">アップロードされたデータは、web サーバーのファイルシステムに保存するか、または DetailsView s `ItemInserting` イベントハンドラーのデータソースパラメーターに割り当てることができます。</span><span class="sxs-lookup"><span data-stu-id="72c21-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="72c21-308">バイナリデータをファイルシステムに保存する場合は、データをデータベースに直接保存するよりも計画を立てる必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="72c21-309">1人のユーザーのアップロードで別のが上書きされないようにするために、名前付けスキームを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="72c21-310">また、データベースの挿入が失敗した場合に、アップロードされたファイルを削除するには、追加の手順を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="72c21-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="72c21-311">これで、パンフレットや画像を使用してシステムに新しいカテゴリを追加できるようになりましたが、既存のカテゴリのバイナリデータを更新する方法や、削除されたカテゴリのバイナリデータを正しく削除する方法についても説明しています。</span><span class="sxs-lookup"><span data-stu-id="72c21-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="72c21-312">次のチュートリアルでは、これらの2つのトピックについて説明します。</span><span class="sxs-lookup"><span data-stu-id="72c21-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="72c21-313">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="72c21-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="72c21-314">作成者について</span><span class="sxs-lookup"><span data-stu-id="72c21-314">About the Author</span></span>

<span data-ttu-id="72c21-315">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="72c21-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="72c21-316">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="72c21-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="72c21-317">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="72c21-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="72c21-318">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="72c21-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="72c21-319">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="72c21-319">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="72c21-320">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="72c21-320">Special Thanks To</span></span>

<span data-ttu-id="72c21-321">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="72c21-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="72c21-322">このチュートリアルのリードレビュー担当者は、Dave Gardner、Teresa Murphy、Bernadette Leigh でした。</span><span class="sxs-lookup"><span data-stu-id="72c21-322">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="72c21-323">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="72c21-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="72c21-324">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="72c21-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="72c21-325">[前へ](displaying-binary-data-in-the-data-web-controls-vb.md)
> [次へ](updating-and-deleting-existing-binary-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="72c21-325">[Previous](displaying-binary-data-in-the-data-web-controls-vb.md)
[Next](updating-and-deleting-existing-binary-data-vb.md)</span></span>
