---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
title: 接続文字列とその他の構成情報C#を保護する () |Microsoft Docs
author: rick-anderson
description: ASP.NET アプリケーションは、通常、構成情報を web.config ファイルに格納します。 この情報の一部は機密情報であり、保護を保証します。 Def...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: ad8dd396-30f7-4abe-ac02-a0b84422e5be
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
msc.type: authoredcontent
ms.openlocfilehash: 15970bee1e990d3a139673efe12486e08f79814c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74573490"
---
# <a name="protecting-connection-strings-and-other-configuration-information-c"></a><span data-ttu-id="8b797-105">接続文字列とその他の構成情報を保護する (C#)</span><span class="sxs-lookup"><span data-stu-id="8b797-105">Protecting Connection Strings and Other Configuration Information (C#)</span></span>

<span data-ttu-id="8b797-106">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="8b797-106">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="8b797-107">[コードのダウンロード](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip)または[PDF のダウンロード](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="8b797-107">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip) or [Download PDF](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span></span>

> <span data-ttu-id="8b797-108">ASP.NET アプリケーションは、通常、構成情報を web.config ファイルに格納します。</span><span class="sxs-lookup"><span data-stu-id="8b797-108">An ASP.NET application typically stores configuration information in a Web.config file.</span></span> <span data-ttu-id="8b797-109">この情報の一部は機密情報であり、保護を保証します。</span><span class="sxs-lookup"><span data-stu-id="8b797-109">Some of this information is sensitive and warrants protection.</span></span> <span data-ttu-id="8b797-110">既定では、このファイルは Web サイトの訪問者には提供されませんが、管理者またはハッカーが Web サーバーのファイルシステムにアクセスして、ファイルの内容を表示する場合があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-110">By default this file will not be served to a Web site visitor, but an administrator or a hacker may gain access to the Web server's file system and view the contents of the file.</span></span> <span data-ttu-id="8b797-111">このチュートリアルでは、ASP.NET 2.0 を使用して、web.config ファイルのセクションを暗号化することで機密情報を保護できることについて説明します。</span><span class="sxs-lookup"><span data-stu-id="8b797-111">In this tutorial we learn that ASP.NET 2.0 allows us to protect sensitive information by encrypting sections of the Web.config file.</span></span>

## <a name="introduction"></a><span data-ttu-id="8b797-112">はじめに</span><span class="sxs-lookup"><span data-stu-id="8b797-112">Introduction</span></span>

<span data-ttu-id="8b797-113">ASP.NET アプリケーションの構成情報は、通常、`Web.config`という名前の XML ファイルに格納されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-113">Configuration information for ASP.NET applications is commonly stored in an XML file named `Web.config`.</span></span> <span data-ttu-id="8b797-114">これらのチュートリアルでは、`Web.config` をいくつかの方法で更新しました。</span><span class="sxs-lookup"><span data-stu-id="8b797-114">Over the course of these tutorials we have updated the `Web.config` a handful of times.</span></span> <span data-ttu-id="8b797-115">たとえば、[最初のチュートリアル](../introduction/creating-a-data-access-layer-cs.md)で `Northwind` 型指定されたデータセットを作成する場合、接続文字列情報は `<connectionStrings>` セクションの `Web.config` に自動的に追加されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-115">When creating the `Northwind` Typed DataSet in the [first tutorial](../introduction/creating-a-data-access-layer-cs.md), for example, connection string information was automatically added to `Web.config` in the `<connectionStrings>` section.</span></span> <span data-ttu-id="8b797-116">後で、[マスターページとサイトナビゲーション](../introduction/master-pages-and-site-navigation-cs.md)チュートリアルで `Web.config`手動で更新し、プロジェクトのすべての ASP.NET ページで `DataWebControls` テーマを使用する必要があることを示す `<pages>` 要素を追加しました。</span><span class="sxs-lookup"><span data-stu-id="8b797-116">Later, in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial, we manually updated `Web.config`, adding a `<pages>` element indicating that all of the ASP.NET pages in our project should use the `DataWebControls` Theme.</span></span>

<span data-ttu-id="8b797-117">`Web.config` には接続文字列などの機密データが含まれている場合があるため、`Web.config` の内容は、承認されていないユーザーに対して安全かつ非表示にしておくことが重要です。</span><span class="sxs-lookup"><span data-stu-id="8b797-117">Since `Web.config` may contain sensitive data such as connection strings, it is important that the contents of `Web.config` be kept safe and hidden from unauthorized viewers.</span></span> <span data-ttu-id="8b797-118">既定では、`.config` 拡張子を持つファイルに対する HTTP 要求は、ASP.NET エンジンによって処理されます。このエンジンは、図1に示すように、*この種類のページが提供*されていないメッセージを返します。</span><span class="sxs-lookup"><span data-stu-id="8b797-118">By default, any HTTP request to a file with the `.config` extension is handled by the ASP.NET engine, which returns the *This type of page is not served* message shown in Figure 1.</span></span> <span data-ttu-id="8b797-119">これは、ブラウザーのアドレスバーに http://www.YourServer.com/Web.config を入力するだけで、`Web.config` ファイルの内容を閲覧できないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="8b797-119">This means that visitors cannot view your `Web.config` file s contents by simply entering http://www.YourServer.com/Web.config into their browser s Address bar.</span></span>

<span data-ttu-id="8b797-120">[ブラウザーを使用して web.config にアクセス ![と、この種類のページはメッセージを表示しません](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="8b797-120">[![Visiting Web.config Through a Browser Returns a This type of page is not served Message](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span></span>

<span data-ttu-id="8b797-121">**図 1**: ブラウザーを介して `Web.config` にアクセスすると、この種類のページはメッセージを表示しません ([クリックすると、フルサイズの画像が表示](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png)されます)</span><span class="sxs-lookup"><span data-stu-id="8b797-121">**Figure 1**: Visiting `Web.config` Through a Browser Returns a This type of page is not served Message ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png))</span></span>

<span data-ttu-id="8b797-122">しかし、攻撃者が `Web.config` ファイルの内容を見ることができる他の悪用を見つけることができる場合はどうでしょうか。</span><span class="sxs-lookup"><span data-stu-id="8b797-122">But what if an attacker is able to find some other exploit that allows her to view your `Web.config` file s contents?</span></span> <span data-ttu-id="8b797-123">攻撃者がこの情報を使用すると、`Web.config`内の機密情報をさらに保護するための手順を実行できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-123">What could an attacker do with this information, and what steps can be taken to further protect the sensitive information within `Web.config`?</span></span> <span data-ttu-id="8b797-124">幸い、`Web.config` のほとんどのセクションには機密情報が含まれていません。</span><span class="sxs-lookup"><span data-stu-id="8b797-124">Fortunately, most sections in `Web.config` do not contain sensitive information.</span></span> <span data-ttu-id="8b797-125">ASP.NET ページで使用されている既定のテーマの名前がわかっていれば、攻撃者がどのような問題を perpetrate ことがありますか。</span><span class="sxs-lookup"><span data-stu-id="8b797-125">What harm can an attacker perpetrate if they know the name of the default Theme used by your ASP.NET pages?</span></span>

<span data-ttu-id="8b797-126">ただし、特定の `Web.config` セクションには、接続文字列、ユーザー名、パスワード、サーバー名、暗号化キーなどの機密情報が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-126">Certain `Web.config` sections, however, contain sensitive information that may include connection strings, user names, passwords, server names, encryption keys, and so forth.</span></span> <span data-ttu-id="8b797-127">この情報は、通常、次の `Web.config` のセクションにあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-127">This information is typically found in the following `Web.config` sections:</span></span>

- `<appSettings>`
- `<connectionStrings>`
- `<identity>`
- `<sessionState>`

<span data-ttu-id="8b797-128">このチュートリアルでは、このような機密構成情報を保護する手法について説明します。</span><span class="sxs-lookup"><span data-stu-id="8b797-128">In this tutorial we will look at techniques for protecting such sensitive configuration information.</span></span> <span data-ttu-id="8b797-129">ここで説明するように、.NET Framework バージョン2.0 には、選択した構成セクションを簡単に暗号化および復号化する保護された構成システムが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-129">As we will see, the .NET Framework version 2.0 includes a protected configurations system that makes programmatically encrypting and decrypting selected configuration sections a breeze.</span></span>

> [!NOTE]
> <span data-ttu-id="8b797-130">このチュートリアルでは、ASP.NET アプリケーションからデータベースに接続するための Microsoft の推奨事項について説明します。</span><span class="sxs-lookup"><span data-stu-id="8b797-130">This tutorial concludes with a look at Microsoft s recommendations for connecting to a database from an ASP.NET application.</span></span> <span data-ttu-id="8b797-131">接続文字列を暗号化するだけでなく、セキュリティで保護された方法でデータベースに接続することで、システムを強化することができます。</span><span class="sxs-lookup"><span data-stu-id="8b797-131">In addition to encrypting your connection strings, you can help harden your system by ensuring that you are connecting to the database in a secure fashion.</span></span>

## <a name="step-1-exploring-aspnet-20-s-protected-configuration-options"></a><span data-ttu-id="8b797-132">手順 1: ASP.NET 2.0 s で保護されている構成オプションを探索する</span><span class="sxs-lookup"><span data-stu-id="8b797-132">Step 1: Exploring ASP.NET 2.0 s Protected Configuration Options</span></span>

<span data-ttu-id="8b797-133">ASP.NET 2.0 には、構成情報の暗号化と復号化を行うための保護された構成システムが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-133">ASP.NET 2.0 includes a protected configuration system for encrypting and decrypting configuration information.</span></span> <span data-ttu-id="8b797-134">これには、構成情報をプログラムで暗号化または復号化するために使用できる .NET Framework のメソッドが含まれます。</span><span class="sxs-lookup"><span data-stu-id="8b797-134">This includes methods in the .NET Framework that can be used to programmatically encrypt or decrypt configuration information.</span></span> <span data-ttu-id="8b797-135">保護された構成システムでは、[プロバイダーモデル](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)を使用します。これにより、開発者は、使用する暗号化実装を選択できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-135">The protected configuration system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), which allows developers to choose what cryptographic implementation is used.</span></span>

<span data-ttu-id="8b797-136">.NET Framework には、次の2つの保護された構成プロバイダーが付属しています。</span><span class="sxs-lookup"><span data-stu-id="8b797-136">The .NET Framework ships with two protected configuration providers:</span></span>

- <span data-ttu-id="8b797-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) -暗号化と復号化に非対称[RSA アルゴリズム](http://en.wikipedia.org/wiki/Rsa)を使用します。</span><span class="sxs-lookup"><span data-stu-id="8b797-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) - uses the asymmetric [RSA algorithm](http://en.wikipedia.org/wiki/Rsa) for encryption and decryption.</span></span>
- <span data-ttu-id="8b797-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) -Windows[データ保護 API (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx)を使用して暗号化と復号化を行います。</span><span class="sxs-lookup"><span data-stu-id="8b797-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) - uses the Windows [Data Protection API (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx) for encryption and decryption.</span></span>

<span data-ttu-id="8b797-139">保護された構成システムはプロバイダーの設計パターンを実装するため、独自の保護された構成プロバイダーを作成してアプリケーションに組み込むことができます。</span><span class="sxs-lookup"><span data-stu-id="8b797-139">Since the protected configuration system implements the provider design pattern, it is possible to create your own protected configuration provider and plug it into your application.</span></span> <span data-ttu-id="8b797-140">このプロセスの詳細について[は、「保護された構成プロバイダーの実装](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-140">See [Implementing a Protected Configuration Provider](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx) for more information on this process.</span></span>

<span data-ttu-id="8b797-141">RSA プロバイダーと DPAPI プロバイダーは、暗号化と復号化のルーチンにキーを使用します。これらのキーは、コンピューターレベルまたはユーザーレベルで格納できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-141">The RSA and DPAPI providers use keys for their encryption and decryption routines, and these keys can be stored at the machine- or user-level.</span></span> <span data-ttu-id="8b797-142">コンピューターレベルのキーは、web アプリケーションが独自の専用サーバーで実行される場合や、暗号化された情報を共有する必要があるサーバー上に複数のアプリケーションが存在する場合に最適です。</span><span class="sxs-lookup"><span data-stu-id="8b797-142">Machine-level keys are ideal for scenarios where the web application runs on its own dedicated server or if there are multiple applications on a server that need to share encrypted information.</span></span> <span data-ttu-id="8b797-143">共有ホスティング環境では、ユーザーレベルのキーはより安全なオプションです。同じサーバー上の他のアプリケーションが、アプリケーションの保護された構成セクションの暗号化を解除できないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-143">User-level keys are a more secure option in shared hosting environments where other applications on the same server should not be able to decrypt your application s protected configuration sections.</span></span>

<span data-ttu-id="8b797-144">このチュートリアルでは、DPAPI プロバイダーとコンピューターレベルのキーを使用します。</span><span class="sxs-lookup"><span data-stu-id="8b797-144">In this tutorial our examples will use the DPAPI provider and machine-level keys.</span></span> <span data-ttu-id="8b797-145">具体的には、`Web.config`の `<connectionStrings>` セクションの暗号化について説明します。ただし、保護された構成システムを使用して、ほとんどの `Web.config` セクションを暗号化できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-145">Specifically, we will look at encrypting the `<connectionStrings>` section in `Web.config`, although the protected configuration system can be used to encrypt most any `Web.config` section.</span></span> <span data-ttu-id="8b797-146">ユーザーレベルのキーを使用する方法、または RSA プロバイダーを使用する方法については、このチュートリアルの最後にある「参考資料」セクションのリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-146">For information on using user-level keys or using the RSA provider, consult the resources in the Further Readings section at the end of this tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="8b797-147">`RSAProtectedConfigurationProvider` プロバイダーと `DPAPIProtectedConfigurationProvider` プロバイダーは、それぞれ `RsaProtectedConfigurationProvider` および `DataProtectionConfigurationProvider`のプロバイダー名を使用して `machine.config` ファイルに登録されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-147">The `RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider` providers are registered in the `machine.config` file with the provider names `RsaProtectedConfigurationProvider` and `DataProtectionConfigurationProvider`, respectively.</span></span> <span data-ttu-id="8b797-148">構成情報を暗号化または復号化する場合は、実際の型名 (`RSAProtectedConfigurationProvider` および `DPAPIProtectedConfigurationProvider`) ではなく、適切なプロバイダー名 (`RsaProtectedConfigurationProvider` または `DataProtectionConfigurationProvider`) を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-148">When encrypting or decrypting configuration information we will need to supply the appropriate provider name (`RsaProtectedConfigurationProvider` or `DataProtectionConfigurationProvider`) rather than the actual type name (`RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider`).</span></span> <span data-ttu-id="8b797-149">`$WINDOWS$\Microsoft.NET\Framework\version\CONFIG` フォルダーに `machine.config` ファイルがあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-149">You can find the `machine.config` file in the `$WINDOWS$\Microsoft.NET\Framework\version\CONFIG` folder.</span></span>

## <a name="step-2-programmatically-encrypting-and-decrypting-configuration-sections"></a><span data-ttu-id="8b797-150">手順 2: プログラムによる構成セクションの暗号化と復号化</span><span class="sxs-lookup"><span data-stu-id="8b797-150">Step 2: Programmatically Encrypting and Decrypting Configuration Sections</span></span>

<span data-ttu-id="8b797-151">数行のコードを使用して、指定されたプロバイダーを使用して特定の構成セクションを暗号化または復号化することができます。</span><span class="sxs-lookup"><span data-stu-id="8b797-151">With a few lines of code we can encrypt or decrypt a particular configuration section using a specified provider.</span></span> <span data-ttu-id="8b797-152">このコードは、後で説明するように、プログラムによって適切な構成セクションを参照し、`ProtectSection` または `UnprotectSection` メソッドを呼び出してから、`Save` メソッドを呼び出して変更を保持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-152">The code, as we will see shortly, simply needs to programmatically reference the appropriate configuration section, call its `ProtectSection` or `UnprotectSection` method, and then call the `Save` method to persist the changes.</span></span> <span data-ttu-id="8b797-153">さらに、.NET Framework には、構成情報の暗号化と復号化を行うための便利なコマンドラインユーティリティが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-153">Moreover, the .NET Framework includes a helpful command line utility that can encrypt and decrypt configuration information.</span></span> <span data-ttu-id="8b797-154">このコマンドラインユーティリティについては、手順 3. で説明します。</span><span class="sxs-lookup"><span data-stu-id="8b797-154">We will explore this command line utility in Step 3.</span></span>

<span data-ttu-id="8b797-155">プログラムによって構成情報を保護する方法を説明するために、「`Web.config`の `<connectionStrings>` セクションの暗号化と復号化を行うためのボタンを含む ASP.NET ページを作成します。</span><span class="sxs-lookup"><span data-stu-id="8b797-155">To illustrate programmatically protecting configuration information, let s create an ASP.NET page that includes buttons for encrypting and decrypting the `<connectionStrings>` section in `Web.config`.</span></span>

<span data-ttu-id="8b797-156">まず、`AdvancedDAL` フォルダーの [`EncryptingConfigSections.aspx`] ページを開きます。</span><span class="sxs-lookup"><span data-stu-id="8b797-156">Start by opening the `EncryptingConfigSections.aspx` page in the `AdvancedDAL` folder.</span></span> <span data-ttu-id="8b797-157">TextBox コントロールをツールボックスからデザイナーにドラッグし、その `ID` プロパティを `WebConfigContents`に、その `TextMode` プロパティを `MultiLine`に、`Width` プロパティと `Rows` プロパティをそれぞれ95% および15に設定します。</span><span class="sxs-lookup"><span data-stu-id="8b797-157">Drag a TextBox control from the Toolbox onto the Designer, setting its `ID` property to `WebConfigContents`, its `TextMode` property to `MultiLine`, and its `Width` and `Rows` properties to 95% and 15, respectively.</span></span> <span data-ttu-id="8b797-158">このテキストボックスコントロールには `Web.config` の内容が表示され、コンテンツが暗号化されているかどうかをすばやく確認できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-158">This TextBox control will display the contents of `Web.config` allowing us to quickly see if the contents are encrypted or not.</span></span> <span data-ttu-id="8b797-159">もちろん、実際のアプリケーションでは、`Web.config`の内容を表示しないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-159">Of course, in a real application you would never want to display the contents of `Web.config`.</span></span>

<span data-ttu-id="8b797-160">テキストボックスの下に、`EncryptConnStrings` と `DecryptConnStrings`という名前の2つのボタンコントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="8b797-160">Beneath the TextBox, add two Button controls named `EncryptConnStrings` and `DecryptConnStrings`.</span></span> <span data-ttu-id="8b797-161">接続文字列を暗号化し、接続文字列の暗号化を解除するように Text プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="8b797-161">Set their Text properties to Encrypt Connection Strings and Decrypt Connection Strings .</span></span>

<span data-ttu-id="8b797-162">この時点で、画面は図2のようになります。</span><span class="sxs-lookup"><span data-stu-id="8b797-162">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="8b797-163">[テキストボックスと2つのボタン Web コントロールをページに追加 ![には](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="8b797-163">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span></span>

<span data-ttu-id="8b797-164">**図 2**: テキストボックスと2つのボタン Web コントロールをページに追加する ([クリックすると、フルサイズの画像が表示](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="8b797-164">**Figure 2**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png))</span></span>

<span data-ttu-id="8b797-165">次に、ページが最初に読み込まれたときに `WebConfigContents` テキストボックスに `Web.config` の内容を読み込んで表示するコードを記述する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-165">Next, we need to write code that loads and displays the contents of `Web.config` in the `WebConfigContents` TextBox when the page is first loaded.</span></span> <span data-ttu-id="8b797-166">ページ s 分離コードクラスに次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="8b797-166">Add the following code to the page s code-behind class.</span></span> <span data-ttu-id="8b797-167">このコードは `DisplayWebConfig` という名前のメソッドを追加し、`Page.IsPostBack` が `false`されたときに `Page_Load` イベントハンドラーから呼び出します。</span><span class="sxs-lookup"><span data-stu-id="8b797-167">This code adds a method named `DisplayWebConfig` and calls it from the `Page_Load` event handler when `Page.IsPostBack` is `false`:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample1.cs)]

<span data-ttu-id="8b797-168">`DisplayWebConfig` メソッドは、 [`File` クラス](https://msdn.microsoft.com/library/system.io.file.aspx)を使用してアプリケーションの `Web.config` ファイルを開き、 [`StreamReader` クラス](https://msdn.microsoft.com/library/system.io.streamreader.aspx)を使用してその内容を文字列に読み取り、 [`Path` クラス](https://msdn.microsoft.com/library/system.io.path.aspx)を使用して、`Web.config` ファイルへの物理パスを生成します。</span><span class="sxs-lookup"><span data-stu-id="8b797-168">The `DisplayWebConfig` method uses the [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) to open the application s `Web.config` file, the [`StreamReader` class](https://msdn.microsoft.com/library/system.io.streamreader.aspx) to read its contents into a string, and the [`Path` class](https://msdn.microsoft.com/library/system.io.path.aspx) to generate the physical path to the `Web.config` file.</span></span> <span data-ttu-id="8b797-169">これら3つのクラスはすべて、 [`System.IO` 名前空間](https://msdn.microsoft.com/library/system.io.aspx)にあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-169">These three classes are all found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="8b797-170">そのため、分離コードクラスの先頭に `using` `System.IO` ステートメントを追加するか、または、これらのクラス名の前に `System.IO.` を付ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-170">Consequently, you will need to add a `using` `System.IO` statement to the top of the code-behind class or, alternatively, prefix these class names with `System.IO.` .</span></span>

<span data-ttu-id="8b797-171">次に、2つのボタンコントロール `Click` イベントのイベントハンドラーを追加し、DPAPI プロバイダーでコンピューターレベルのキーを使用して `<connectionStrings>` セクションを暗号化および復号化するために必要なコードを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-171">Next, we need to add event handlers for the two Button controls `Click` events and add the necessary code to encrypt and decrypt the `<connectionStrings>` section using a machine-level key with the DPAPI provider.</span></span> <span data-ttu-id="8b797-172">デザイナーで、各ボタンをダブルクリックして、分離コードクラスに `Click` イベントハンドラーを追加し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="8b797-172">From the Designer, double-click each of the Buttons to add a `Click` event handler in the code-behind class and then add the following code:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample2.cs)]

<span data-ttu-id="8b797-173">2つのイベントハンドラーで使用されるコードはほぼ同じです。</span><span class="sxs-lookup"><span data-stu-id="8b797-173">The code used in the two event handlers is nearly identical.</span></span> <span data-ttu-id="8b797-174">どちらも、まず、 [`WebConfigurationManager` クラス](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx)s [`OpenWebConfiguration` メソッド](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx)を使用して、現在のアプリケーションの `Web.config` ファイルに関する情報を取得します。</span><span class="sxs-lookup"><span data-stu-id="8b797-174">They both start by getting information about the current application s `Web.config` file via the [`WebConfigurationManager` class](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx) s [`OpenWebConfiguration` method](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx).</span></span> <span data-ttu-id="8b797-175">このメソッドは、指定された仮想パスの web 構成ファイルを返します。</span><span class="sxs-lookup"><span data-stu-id="8b797-175">This method returns the web configuration file for the specified virtual path.</span></span> <span data-ttu-id="8b797-176">次に、`Web.config` file s `<connectionStrings>` セクションに[`Configuration` クラス](https://msdn.microsoft.com/library/system.configuration.configuration.aspx)s [`GetSection(sectionName)` メソッド](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx)を使用してアクセスします。このメソッドは[`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx)オブジェクトを返します。</span><span class="sxs-lookup"><span data-stu-id="8b797-176">Next, the `Web.config` file s `<connectionStrings>` section is accessed via the [`Configuration` class](https://msdn.microsoft.com/library/system.configuration.configuration.aspx) s [`GetSection(sectionName)` method](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx), which returns a [`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx) object.</span></span>

<span data-ttu-id="8b797-177">`ConfigurationSection` オブジェクトには、構成セクションに関する追加の情報と機能を提供する[`SectionInformation` プロパティ](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx)が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-177">The `ConfigurationSection` object includes a [`SectionInformation` property](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx) that provides additional information and functionality regarding the configuration section.</span></span> <span data-ttu-id="8b797-178">上記のコードに示すように、構成セクションが暗号化されているかどうかを確認するには、`SectionInformation` プロパティ s `IsProtected` プロパティを確認します。</span><span class="sxs-lookup"><span data-stu-id="8b797-178">As the code above shows, we can determine whether the configuration section is encrypted by checking the `SectionInformation` property s `IsProtected` property.</span></span> <span data-ttu-id="8b797-179">さらに、セクションは、`SectionInformation` プロパティ s `ProtectSection(provider)` と `UnprotectSection` メソッドを使用して暗号化または復号化できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-179">Moreover, the section can be encrypted or decrypted via the `SectionInformation` property s `ProtectSection(provider)` and `UnprotectSection` methods.</span></span>

<span data-ttu-id="8b797-180">`ProtectSection(provider)` メソッドは、暗号化時に使用する保護された構成プロバイダーの名前を指定する文字列を入力として受け入れます。</span><span class="sxs-lookup"><span data-stu-id="8b797-180">The `ProtectSection(provider)` method accepts as input a string specifying the name of the protected configuration provider to use when encrypting.</span></span> <span data-ttu-id="8b797-181">`EncryptConnString` ボタン s イベントハンドラーで、DataProtectionConfigurationProvider を `ProtectSection(provider)` メソッドに渡して、DPAPI プロバイダーが使用されるようにします。</span><span class="sxs-lookup"><span data-stu-id="8b797-181">In the `EncryptConnString` Button s event handler we pass DataProtectionConfigurationProvider into the `ProtectSection(provider)` method so that the DPAPI provider is used.</span></span> <span data-ttu-id="8b797-182">`UnprotectSection` メソッドは、構成セクションの暗号化に使用されたプロバイダーを特定できます。そのため、入力パラメーターは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="8b797-182">The `UnprotectSection` method can determine the provider that was used to encrypt the configuration section and therefore does not require any input parameters.</span></span>

<span data-ttu-id="8b797-183">`ProtectSection(provider)` または `UnprotectSection` メソッドを呼び出した後、`Configuration` オブジェクト s [`Save` メソッド](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx)を呼び出して変更を保持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-183">After calling the `ProtectSection(provider)` or `UnprotectSection` method, you must call the `Configuration` object s [`Save` method](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx) to persist the changes.</span></span> <span data-ttu-id="8b797-184">構成情報が暗号化または暗号化解除され、変更が保存されたら、`DisplayWebConfig` を呼び出して、更新された `Web.config` の内容をテキストボックスコントロールに読み込みます。</span><span class="sxs-lookup"><span data-stu-id="8b797-184">Once the configuration information has been encrypted or decrypted and the changes saved, we call `DisplayWebConfig` to load the updated `Web.config` contents into the TextBox control.</span></span>

<span data-ttu-id="8b797-185">上記のコードを入力したら、ブラウザーを使用して `EncryptingConfigSections.aspx` のページにアクセスしてテストします。</span><span class="sxs-lookup"><span data-stu-id="8b797-185">Once you have entered the above code, test it by visiting the `EncryptingConfigSections.aspx` page through a browser.</span></span> <span data-ttu-id="8b797-186">最初に、`<connectionStrings>` セクションがプレーンテキストで表示されている `Web.config` の内容を一覧表示するページが表示されます (図3を参照)。</span><span class="sxs-lookup"><span data-stu-id="8b797-186">You should initially see a page that lists the contents of `Web.config` with the `<connectionStrings>` section displayed in plain-text (see Figure 3).</span></span>

<span data-ttu-id="8b797-187">[テキストボックスと2つのボタン Web コントロールをページに追加 ![には](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="8b797-187">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span></span>

<span data-ttu-id="8b797-188">**図 3**: テキストボックスと2つのボタン Web コントロールをページに追加する ([クリックすると、フルサイズの画像が表示](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png)されます)</span><span class="sxs-lookup"><span data-stu-id="8b797-188">**Figure 3**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png))</span></span>

<span data-ttu-id="8b797-189">次に、[接続文字列の暗号化] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="8b797-189">Now click the Encrypt Connection Strings button.</span></span> <span data-ttu-id="8b797-190">要求の検証が有効になっている場合は、`WebConfigContents` テキストボックスからポストバックされたマークアップによって `HttpRequestValidationException`が生成されます。このメッセージには、危険性のある `Request.Form` 値がクライアントから検出されたことが示されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-190">If request validation is enabled, the markup posted back from the `WebConfigContents` TextBox will produce an `HttpRequestValidationException`, which displays the message, A potentially dangerous `Request.Form` value was detected from the client.</span></span> <span data-ttu-id="8b797-191">ASP.NET 2.0 で既定で有効になっている要求の検証では、エンコードされていない HTML を含むポストバックは禁止されており、スクリプトインジェクション攻撃を防ぐことができるように設計されています。</span><span class="sxs-lookup"><span data-stu-id="8b797-191">Request validation, which is enabled by default in ASP.NET 2.0, prohibits postbacks that include un-encoded HTML and is designed to help prevent script-injection attacks.</span></span> <span data-ttu-id="8b797-192">このチェックは、ページレベルまたはアプリケーションレベルで無効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="8b797-192">This check can be disabled at the page- or application-level.</span></span> <span data-ttu-id="8b797-193">このページで無効にするには、`ValidateRequest` 設定を `@Page` ディレクティブの `false` に設定します。</span><span class="sxs-lookup"><span data-stu-id="8b797-193">To turn it off for this page, set the `ValidateRequest` setting to `false` in the `@Page` directive.</span></span> <span data-ttu-id="8b797-194">`@Page` ディレクティブは、ページの宣言型マークアップの先頭にあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-194">The `@Page` directive is found at the top of the page s declarative markup.</span></span>

[!code-aspx[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample3.aspx)]

<span data-ttu-id="8b797-195">要求の検証、その目的、ページおよびアプリケーションレベルでの無効化方法、HTML エンコードマークアップの方法の詳細については、「[要求の検証-スクリプト攻撃の防止](../../../../whitepapers/request-validation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-195">For more information on request validation, its purpose, how to disable it at the page- and application-level, as well as how to HTML encode markup, see [Request Validation - Preventing Script Attacks](../../../../whitepapers/request-validation.md).</span></span>

<span data-ttu-id="8b797-196">ページの要求の検証を無効にした後、[接続文字列の暗号化] ボタンをもう一度クリックしてください。</span><span class="sxs-lookup"><span data-stu-id="8b797-196">After disabling request validation for the page, try clicking the Encrypt Connection Strings button again.</span></span> <span data-ttu-id="8b797-197">ポストバック時に、構成ファイルにアクセスし、その `<connectionStrings>` セクションを DPAPI プロバイダーを使用して暗号化します。</span><span class="sxs-lookup"><span data-stu-id="8b797-197">On postback, the configuration file will be accessed and its `<connectionStrings>` section encrypted using the DPAPI provider.</span></span> <span data-ttu-id="8b797-198">次に、テキストボックスが更新され、新しい `Web.config` の内容が表示されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-198">The TextBox is then updated to display the new `Web.config` content.</span></span> <span data-ttu-id="8b797-199">図4に示すように、`<connectionStrings>` 情報は現在暗号化されています。</span><span class="sxs-lookup"><span data-stu-id="8b797-199">As Figure 4 shows, the `<connectionStrings>` information is now encrypted.</span></span>

<span data-ttu-id="8b797-200">[[接続文字列の暗号化] ボタンをクリック ![と &lt;connectionString&gt; セクションが暗号化されます](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="8b797-200">[![Clicking the Encrypt Connection Strings Button Encrypts the &lt;connectionString&gt; Section](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span></span>

<span data-ttu-id="8b797-201">**図 4**: [接続文字列の暗号化] ボタンをクリックすると `<connectionString>` セクションが暗号化される ([クリックしてフルサイズの画像を表示する](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="8b797-201">**Figure 4**: Clicking the Encrypt Connection Strings Button Encrypts the `<connectionString>` Section ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png))</span></span>

<span data-ttu-id="8b797-202">コンピューターで生成された暗号化された `<connectionStrings>` セクションは次のとおりです。ただし、`<CipherData>` 要素の内容の一部は簡潔にするために削除されています。</span><span class="sxs-lookup"><span data-stu-id="8b797-202">The encrypted `<connectionStrings>` section generated on my computer follows, although some of the content in the `<CipherData>` element has been removed for brevity:</span></span>

[!code-xml[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample4.xml)]

> [!NOTE]
> <span data-ttu-id="8b797-203">`<connectionStrings>` 要素は、暗号化 (`DataProtectionConfigurationProvider`) を実行するために使用するプロバイダーを指定します。</span><span class="sxs-lookup"><span data-stu-id="8b797-203">The `<connectionStrings>` element specifies the provider used to perform the encryption (`DataProtectionConfigurationProvider`).</span></span> <span data-ttu-id="8b797-204">この情報は、[接続文字列の復号化] ボタンをクリックしたときに `UnprotectSection` メソッドによって使用されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-204">This information is used by the `UnprotectSection` method when the Decrypt Connection Strings button is clicked.</span></span>

<span data-ttu-id="8b797-205">接続文字列情報が `Web.config` からアクセスされると、コードによって、SqlDataSource コントロールから、または型指定されたデータセットの Tableadapter から自動生成されたコードのいずれかによって、自動的に暗号化が解除されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-205">When the connection string information is accessed from `Web.config` - either by code we write, from a SqlDataSource control, or the auto-generated code from the TableAdapters in our Typed DataSets - it is automatically decrypted.</span></span> <span data-ttu-id="8b797-206">つまり、暗号化された `<connectionString>` セクションの暗号化を解除するために、余分なコードやロジックを追加する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="8b797-206">In short, we do not need to add any extra code or logic to decrypt the encrypted `<connectionString>` section.</span></span> <span data-ttu-id="8b797-207">このデモを実行するには、この時点で前のチュートリアルのいずれかを参照してください。たとえば、基本的なレポートのセクション (`~/BasicReporting/SimpleDisplay.aspx`) の簡易表示チュートリアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-207">To demonstrate this, visit one of the earlier tutorials at this time, such as the Simple Display tutorial from the Basic Reporting section (`~/BasicReporting/SimpleDisplay.aspx`).</span></span> <span data-ttu-id="8b797-208">図5に示すように、このチュートリアルは想定どおりに動作し、暗号化された接続文字列情報が ASP.NET ページによって自動的に暗号化解除されることを示しています。</span><span class="sxs-lookup"><span data-stu-id="8b797-208">As Figure 5 shows, the tutorial works exactly as we would expect it, indicating that the encrypted connection string information is being automatically decrypted by the ASP.NET page.</span></span>

<span data-ttu-id="8b797-209">[データアクセス層によって接続文字列情報の暗号化が自動的に解除 ![](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="8b797-209">[![The Data Access Layer Automatically Decrypts the Connection String Information](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span></span>

<span data-ttu-id="8b797-210">**図 5**: データアクセス層によって接続文字列情報の暗号化が自動的に解除される ([クリックすると、フルサイズの画像が表示](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="8b797-210">**Figure 5**: The Data Access Layer Automatically Decrypts the Connection String Information ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png))</span></span>

<span data-ttu-id="8b797-211">`<connectionStrings>` セクションをプレーンテキスト形式に戻すには、[接続文字列の復号化] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="8b797-211">To revert the `<connectionStrings>` section back to its plain-text representation, click the Decrypt Connection Strings button.</span></span> <span data-ttu-id="8b797-212">ポストバック時に、`Web.config` の接続文字列がプレーンテキストで表示されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-212">On postback you should see the connection strings in `Web.config` in plain-text.</span></span> <span data-ttu-id="8b797-213">この時点で、このページに初めてアクセスしたときのように画面が表示されます (図3を参照)。</span><span class="sxs-lookup"><span data-stu-id="8b797-213">At this point your screen should look like it did when first visiting this page (see in Figure 3).</span></span>

## <a name="step-3-encrypting-configuration-sections-usingaspnet_regiisexe"></a><span data-ttu-id="8b797-214">手順 3:`aspnet_regiis.exe` を使用した構成セクションの暗号化</span><span class="sxs-lookup"><span data-stu-id="8b797-214">Step 3: Encrypting Configuration Sections Using`aspnet_regiis.exe`</span></span>

<span data-ttu-id="8b797-215">.NET Framework には、`$WINDOWS$\Microsoft.NET\Framework\version\` フォルダーにさまざまなコマンドラインツールが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8b797-215">The .NET Framework includes a variety of command line tools in the `$WINDOWS$\Microsoft.NET\Framework\version\` folder.</span></span> <span data-ttu-id="8b797-216">たとえば、 [Sql キャッシュの依存関係の使用](../caching-data/using-sql-cache-dependencies-cs.md)に関するチュートリアルでは、sql キャッシュの依存関係に必要なインフラストラクチャを追加するために `aspnet_regsql.exe` コマンドラインツールを使用する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="8b797-216">In the [Using SQL Cache Dependencies](../caching-data/using-sql-cache-dependencies-cs.md) tutorial, for instance, we looked at using the `aspnet_regsql.exe` command line tool to add the infrastructure necessary for SQL cache dependencies.</span></span> <span data-ttu-id="8b797-217">このフォルダーにあるもう1つの便利なコマンドラインツールは、 [ASP.NET IIS 登録ツール (`aspnet_regiis.exe`)](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx)です。</span><span class="sxs-lookup"><span data-stu-id="8b797-217">Another useful command line tool in this folder is the [ASP.NET IIS Registration tool (`aspnet_regiis.exe`)](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx).</span></span> <span data-ttu-id="8b797-218">その名前が示すように、ASP.NET IIS 登録ツールは主に ASP.NET 2.0 アプリケーションを Microsoft の professional グレード Web server (IIS) に登録するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-218">As its name implies, the ASP.NET IIS Registration tool is primarily used to register an ASP.NET 2.0 application with Microsoft s professional-grade Web server, IIS.</span></span> <span data-ttu-id="8b797-219">ASP.NET IIS 登録ツールは、IIS 関連の機能に加えて、`Web.config`の指定された構成セクションの暗号化または暗号化解除にも使用できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-219">In addition to its IIS-related features, the ASP.NET IIS Registration tool can also be used to encrypt or decrypt specified configuration sections in `Web.config`.</span></span>

<span data-ttu-id="8b797-220">次のステートメントは、`aspnet_regiis.exe` コマンドラインツールを使用して構成セクションを暗号化するために使用される一般的な構文を示しています。</span><span class="sxs-lookup"><span data-stu-id="8b797-220">The following statement shows the general syntax used to encrypt a configuration section with the `aspnet_regiis.exe` command line tool:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample5.cmd)]

<span data-ttu-id="8b797-221">*section*は暗号化する構成セクション (connectionStrings など)、*物理\_ディレクトリ*は web アプリケーションのルートディレクトリへの完全な物理パス、 *provider*は使用する保護された構成プロバイダーの名前 (dataprotectionconfigurationprovider など) です。</span><span class="sxs-lookup"><span data-stu-id="8b797-221">*section* is the configuration section to encrypt (like connectionStrings ), the *physical\_directory* is the full, physical path to the web application s root directory, and *provider* is the name of the protected configuration provider to use (such as DataProtectionConfigurationProvider ).</span></span> <span data-ttu-id="8b797-222">または、web アプリケーションが IIS に登録されている場合は、次の構文を使用して、物理パスの代わりに仮想パスを入力できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-222">Alternatively, if the web application is registered in IIS you can enter the virtual path instead of the physical path using the following syntax:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample6.cmd)]

<span data-ttu-id="8b797-223">次の `aspnet_regiis.exe` 例では、DPAPI プロバイダーとコンピューターレベルのキーを使用して、`<connectionStrings>` セクションを暗号化します。</span><span class="sxs-lookup"><span data-stu-id="8b797-223">The following `aspnet_regiis.exe` example encrypts the `<connectionStrings>` section using the DPAPI provider with a machine-level key:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample7.cmd)]

<span data-ttu-id="8b797-224">同様に、`aspnet_regiis.exe` コマンドラインツールを使用して、構成セクションの暗号化を解除することもできます。</span><span class="sxs-lookup"><span data-stu-id="8b797-224">Similarly, the `aspnet_regiis.exe` command line tool can be used to decrypt configuration sections.</span></span> <span data-ttu-id="8b797-225">`-pef` スイッチを使用する代わりに、`-pdf` (または `-pe`ではなく `-pd`) を使用します。</span><span class="sxs-lookup"><span data-stu-id="8b797-225">Instead of using the `-pef` switch, use `-pdf` (or instead of `-pe`, use `-pd`).</span></span> <span data-ttu-id="8b797-226">また、復号化するときにプロバイダー名は不要であることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-226">Also, note that the provider name is not necessary when decrypting.</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample8.cmd)]

> [!NOTE]
> <span data-ttu-id="8b797-227">コンピューターに固有のキーを使用する DPAPI プロバイダーを使用しているため、web ページが提供されているのと同じコンピューターから `aspnet_regiis.exe` を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-227">Since we are using the DPAPI provider, which uses keys specific to the computer, you must run `aspnet_regiis.exe` from the same machine from which the web pages are being served.</span></span> <span data-ttu-id="8b797-228">たとえば、このコマンドラインプログラムをローカルの開発用コンピューターから実行してから、暗号化された Web.config ファイルを実稼働サーバーにアップロードした場合、実稼働サーバーでは、暗号化されてから接続文字列情報を復号化することはできません。開発用コンピューターに固有のキーを使用します。</span><span class="sxs-lookup"><span data-stu-id="8b797-228">For example, if you run this command line program from your local development machine and then upload the encrypted Web.config file to the production server, the production server will not be able to decrypt the connection string information since it was encrypted using keys specific to your development machine.</span></span> <span data-ttu-id="8b797-229">Rsa プロバイダーには、RSA キーを別のコンピューターにエクスポートできるため、このような制限はありません。</span><span class="sxs-lookup"><span data-stu-id="8b797-229">The RSA provider does not have this limitation as it is possible to export the RSA keys to another machine.</span></span>

## <a name="understanding-database-authentication-options"></a><span data-ttu-id="8b797-230">データベース認証オプションについて</span><span class="sxs-lookup"><span data-stu-id="8b797-230">Understanding Database Authentication Options</span></span>

<span data-ttu-id="8b797-231">アプリケーションで `SELECT`、`INSERT`、`UPDATE`、または `DELETE` のクエリを Microsoft SQL Server データベースに発行する前に、まずデータベースで要求元を識別する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8b797-231">Before any application can issue `SELECT`, `INSERT`, `UPDATE`, or `DELETE` queries to a Microsoft SQL Server database, the database first must identify the requestor.</span></span> <span data-ttu-id="8b797-232">このプロセスは*認証*と呼ばれ、SQL Server は次の2つの認証方法を提供します。</span><span class="sxs-lookup"><span data-stu-id="8b797-232">This process is known as *authentication* and SQL Server provides two methods of authentication:</span></span>

- <span data-ttu-id="8b797-233">**Windows 認証**-アプリケーションが実行されているプロセスを使用して、データベースとの通信を行います。</span><span class="sxs-lookup"><span data-stu-id="8b797-233">**Windows Authentication** - the process under which the application is running is used to communicate with the database.</span></span> <span data-ttu-id="8b797-234">Visual Studio 2005 s ASP.NET 開発サーバーで ASP.NET アプリケーションを実行する場合、ASP.NET アプリケーションは、現在ログオンしているユーザーの id を前提としています。</span><span class="sxs-lookup"><span data-stu-id="8b797-234">When running an ASP.NET application through Visual Studio 2005 s ASP.NET Development Server, the ASP.NET application assumes the identity of the currently logged on user.</span></span> <span data-ttu-id="8b797-235">Microsoft Internet Information Server (IIS) の ASP.NET アプリケーションでは、ASP.NET アプリケーションは通常、`domainName``\MachineName` または `domainName``\NETWORK SERVICE`の id を想定していますが、これはカスタマイズすることもできます。</span><span class="sxs-lookup"><span data-stu-id="8b797-235">For ASP.NET applications on Microsoft Internet Information Server (IIS), ASP.NET applications usually assume the identity of `domainName``\MachineName` or `domainName``\NETWORK SERVICE`, although this can be customized.</span></span>
- <span data-ttu-id="8b797-236">**SQL 認証**-ユーザー ID とパスワードの値は、認証の資格情報として指定されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-236">**SQL Authentication** - a user ID and password values are supplied as credentials for authentication.</span></span> <span data-ttu-id="8b797-237">SQL 認証では、ユーザー ID とパスワードが接続文字列で指定されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-237">With SQL authentication, the user ID and password are provided in the connection string.</span></span>

<span data-ttu-id="8b797-238">Windows 認証は、セキュリティが強化されているため、SQL 認証よりも優先されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-238">Windows authentication is preferred over SQL authentication because it is more secure.</span></span> <span data-ttu-id="8b797-239">Windows 認証では、接続文字列はユーザー名とパスワードから解放され、web サーバーとデータベースサーバーが2つの異なるコンピューターに存在する場合、資格情報はネットワーク経由でプレーンテキストで送信されません。</span><span class="sxs-lookup"><span data-stu-id="8b797-239">With Windows authentication the connection string is free from a username and password and if the web server and database server reside on two different machines, the credentials are not sent over the network in plain-text.</span></span> <span data-ttu-id="8b797-240">ただし、SQL 認証では、認証資格情報は接続文字列にハードコーディングされ、web サーバーからデータベースサーバーにプレーンテキストで送信されます。</span><span class="sxs-lookup"><span data-stu-id="8b797-240">With SQL authentication, however, the authentication credentials are hard-coded in the connection string and are transmitted from the web server to the database server in plain-text.</span></span>

<span data-ttu-id="8b797-241">これらのチュートリアルでは、Windows 認証を使用しました。</span><span class="sxs-lookup"><span data-stu-id="8b797-241">These tutorials have used Windows authentication.</span></span> <span data-ttu-id="8b797-242">接続文字列を調べることによって、どの認証モードが使用されているかを知ることができます。</span><span class="sxs-lookup"><span data-stu-id="8b797-242">You can tell what authentication mode is being used by inspecting the connection string.</span></span> <span data-ttu-id="8b797-243">チュートリアル用の接続文字列は、次のようになりました `Web.config`。</span><span class="sxs-lookup"><span data-stu-id="8b797-243">The connection string in `Web.config` for our tutorials has been:</span></span>

`Data Source=.\SQLEXPRESS; AttachDbFilename=|DataDirectory|\NORTHWND.MDF; Integrated Security=True; User Instance=True`

<span data-ttu-id="8b797-244">Integrated Security = True であり、ユーザー名とパスワードがない場合は、Windows 認証が使用されていることを示します。</span><span class="sxs-lookup"><span data-stu-id="8b797-244">The Integrated Security=True and lack of a username and password indicate that Windows authentication is being used.</span></span> <span data-ttu-id="8b797-245">一部の接続文字列では、"信頼された接続 = Yes" または "Integrated Security = SSPI" という用語が統合セキュリティ = True の代わりに使用されますが、3つすべてが Windows 認証を使用することを示します。</span><span class="sxs-lookup"><span data-stu-id="8b797-245">In some connection strings the term Trusted Connection=Yes or Integrated Security=SSPI is used instead of Integrated Security=True, but all three indicate the use of Windows authentication.</span></span>

<span data-ttu-id="8b797-246">次の例は、SQL 認証を使用する接続文字列を示しています。</span><span class="sxs-lookup"><span data-stu-id="8b797-246">The following example shows a connection string that uses SQL authentication.</span></span> <span data-ttu-id="8b797-247">接続文字列内に埋め込まれている資格情報を確認します。</span><span class="sxs-lookup"><span data-stu-id="8b797-247">Note the credentials embedded within the connection string:</span></span>

`Server=serverName; Database=Northwind; uid=userID; pwd=password`

<span data-ttu-id="8b797-248">たとえば、攻撃者がアプリケーションの `Web.config` ファイルを表示できるとします。</span><span class="sxs-lookup"><span data-stu-id="8b797-248">Imagine that an attacker is able to view your application s `Web.config` file.</span></span> <span data-ttu-id="8b797-249">SQL 認証を使用してインターネット経由でアクセス可能なデータベースに接続する場合、攻撃者はこの接続文字列を使用して、SQL Management Studio または独自の web サイトの ASP.NET ページからデータベースに接続できます。</span><span class="sxs-lookup"><span data-stu-id="8b797-249">If you use SQL authentication to connect to a database that is accessible over the Internet, the attacker can use this connection string to connect to your database through SQL Management Studio or from ASP.NET pages on their own website.</span></span> <span data-ttu-id="8b797-250">この脅威を軽減するために、保護された構成システムを使用して `Web.config` の接続文字列情報を暗号化します。</span><span class="sxs-lookup"><span data-stu-id="8b797-250">To help mitigate this threat, encrypt the connection string information in `Web.config` using the protected configuration system.</span></span>

> [!NOTE]
> <span data-ttu-id="8b797-251">SQL Server で使用できるさまざまな種類の認証の詳細については、「[セキュリティで保護された ASP.NET アプリケーションの構築: 認証、承認、セキュリティで保護された通信](https://msdn.microsoft.com/library/aa302392.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-251">For more information on the different types of authentication available in SQL Server, see [Building Secure ASP.NET Applications: Authentication, Authorization, and Secure Communication](https://msdn.microsoft.com/library/aa302392.aspx).</span></span> <span data-ttu-id="8b797-252">Windows と SQL の認証構文の違いを示す接続文字列の例については、 [ConnectionStrings.com](http://www.connectionstrings.com/)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-252">For further connection string examples illustrating the differences between Windows and SQL authentication syntax, refer to [ConnectionStrings.com](http://www.connectionstrings.com/).</span></span>

## <a name="summary"></a><span data-ttu-id="8b797-253">要約</span><span class="sxs-lookup"><span data-stu-id="8b797-253">Summary</span></span>

<span data-ttu-id="8b797-254">既定では、ASP.NET アプリケーションの `.config` 拡張子を持つファイルには、ブラウザーからアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="8b797-254">By default, files with a `.config` extension in an ASP.NET application cannot be accessed through a browser.</span></span> <span data-ttu-id="8b797-255">これらの種類のファイルには、データベース接続文字列、ユーザー名とパスワードなどの機密情報が含まれている可能性があるため、返されません。</span><span class="sxs-lookup"><span data-stu-id="8b797-255">These types of files are not returned because they may contain sensitive information, such as database connection strings, usernames and passwords, and so on.</span></span> <span data-ttu-id="8b797-256">.NET 2.0 の保護された構成システムは、指定された構成セクションを暗号化できるようにすることで、機密情報をさらに保護するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="8b797-256">The protected configuration system in .NET 2.0 helps further protect sensitive information by allowing specified configuration sections to be encrypted.</span></span> <span data-ttu-id="8b797-257">保護された構成プロバイダーには、RSA アルゴリズムを使用するものと、Windows Data Protection API (DPAPI) を使用するものの2つがあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-257">There are two built-in protected configuration providers: one that uses the RSA algorithm and one that uses the Windows Data Protection API (DPAPI).</span></span>

<span data-ttu-id="8b797-258">このチュートリアルでは、DPAPI プロバイダーを使用して構成設定を暗号化および復号化する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="8b797-258">In this tutorial we looked at how to encrypt and decrypt configuration settings using the DPAPI provider.</span></span> <span data-ttu-id="8b797-259">これは、手順 2. で説明したようにプログラムによって行うことも、手順 3. で説明した `aspnet_regiis.exe` コマンドラインツールを使用して行うこともできます。</span><span class="sxs-lookup"><span data-stu-id="8b797-259">This can be accomplished both programmatically, as we saw in Step 2, as well as through the `aspnet_regiis.exe` command line tool, which was covered in Step 3.</span></span> <span data-ttu-id="8b797-260">ユーザーレベルのキーを使用する方法、または RSA プロバイダーを使用する方法の詳細については、「参考資料」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-260">For more information on using user-level keys or using the RSA provider instead, see the resources in the Further Reading section.</span></span>

<span data-ttu-id="8b797-261">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="8b797-261">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="8b797-262">関連項目</span><span class="sxs-lookup"><span data-stu-id="8b797-262">Further Reading</span></span>

<span data-ttu-id="8b797-263">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="8b797-263">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="8b797-264">Secure ASP.NET アプリケーションの構築: 認証、承認、セキュリティで保護された通信</span><span class="sxs-lookup"><span data-stu-id="8b797-264">Building Secure ASP.NET Application: Authentication, Authorization, and Secure Communication</span></span>](https://msdn.microsoft.com/library/aa302392.aspx)
- [<span data-ttu-id="8b797-265">ASP.NET 2.0 アプリケーションの構成情報の暗号化</span><span class="sxs-lookup"><span data-stu-id="8b797-265">Encrypting Configuration Information in ASP.NET 2.0 Applications</span></span>](http://aspnet.4guysfromrolla.com/articles/021506-1.aspx)
- [<span data-ttu-id="8b797-266">ASP.NET 2.0 での `Web.config` 値の暗号化</span><span class="sxs-lookup"><span data-stu-id="8b797-266">Encrypting `Web.config` Values in ASP.NET 2.0</span></span>](https://weblogs.asp.net/scottgu/archive/2006/01/09/434893.aspx)
- [<span data-ttu-id="8b797-267">方法: DPAPI を使用して ASP.NET 2.0 の構成セクションを暗号化する</span><span class="sxs-lookup"><span data-stu-id="8b797-267">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using DPAPI</span></span>](https://msdn.microsoft.com/library/ms998280.aspx)
- [<span data-ttu-id="8b797-268">方法: RSA を使用して ASP.NET 2.0 の構成セクションを暗号化する</span><span class="sxs-lookup"><span data-stu-id="8b797-268">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using RSA</span></span>](https://msdn.microsoft.com/library/ms998283.aspx)
- [<span data-ttu-id="8b797-269">.NET 2.0 の構成 API</span><span class="sxs-lookup"><span data-stu-id="8b797-269">The Configuration API in .NET 2.0</span></span>](http://www.odetocode.com/Articles/418.aspx)
- [<span data-ttu-id="8b797-270">Windows データ保護</span><span class="sxs-lookup"><span data-stu-id="8b797-270">Windows Data Protection</span></span>](https://msdn.microsoft.com/library/ms995355.aspx)

## <a name="about-the-author"></a><span data-ttu-id="8b797-271">作成者について</span><span class="sxs-lookup"><span data-stu-id="8b797-271">About the Author</span></span>

<span data-ttu-id="8b797-272">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="8b797-272">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="8b797-273">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="8b797-273">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="8b797-274">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="8b797-274">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="8b797-275">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8b797-275">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="8b797-276">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="8b797-276">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="8b797-277">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="8b797-277">Special Thanks To</span></span>

<span data-ttu-id="8b797-278">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="8b797-278">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="8b797-279">このチュートリアルのリードレビュー担当者は、Teresa Murphy と Randy/Midt でした。</span><span class="sxs-lookup"><span data-stu-id="8b797-279">Lead reviewers for this tutorial were Teresa Murphy and Randy Schmidt.</span></span> <span data-ttu-id="8b797-280">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="8b797-280">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="8b797-281">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8b797-281">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="8b797-282">[前へ](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
> [次へ](debugging-stored-procedures-cs.md)</span><span class="sxs-lookup"><span data-stu-id="8b797-282">[Previous](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
[Next](debugging-stored-procedures-cs.md)</span></span>
