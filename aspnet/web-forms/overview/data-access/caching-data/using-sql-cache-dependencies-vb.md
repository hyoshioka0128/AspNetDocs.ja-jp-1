---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
title: SQL キャッシュの依存関係を使用する (VB) |Microsoft Docs
author: rick-anderson
description: 最も簡単なキャッシュ方法は、キャッシュされたデータの有効期限が指定した期間後に切れるようにすることです。 ただし、この簡単な方法では、キャッシュされたデータが
ms.author: riande
ms.date: 05/30/2007
ms.assetid: bd347d93-4251-4532-801c-a36f2dfa7f96
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
msc.type: authoredcontent
ms.openlocfilehash: 7d095538bd92d50675e5fce44f5ca68e8ee6c0e8
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74603748"
---
# <a name="using-sql-cache-dependencies-vb"></a><span data-ttu-id="f9a80-104">SQL キャッシュ依存関係を使用する (VB)</span><span class="sxs-lookup"><span data-stu-id="f9a80-104">Using SQL Cache Dependencies (VB)</span></span>

<span data-ttu-id="f9a80-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f9a80-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f9a80-106">[コードのダウンロード](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_VB.zip)または[PDF のダウンロード](using-sql-cache-dependencies-vb/_static/datatutorial61vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f9a80-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_VB.zip) or [Download PDF](using-sql-cache-dependencies-vb/_static/datatutorial61vb1.pdf)</span></span>

> <span data-ttu-id="f9a80-107">最も簡単なキャッシュ方法は、キャッシュされたデータの有効期限が指定した期間後に切れるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="f9a80-108">ただし、この簡単な方法では、キャッシュされたデータが基になるデータソースと関連付けられていないことを意味します。その結果、古いデータが長すぎるか、現在のデータが短時間で期限切れになります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="f9a80-109">より優れたアプローチは、SqlCacheDependency クラスを使用して、SQL データベースで基になるデータが変更されるまでデータがキャッシュされたままになるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="f9a80-110">このチュートリアルでは、その方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-110">This tutorial shows you how.</span></span>

## <a name="introduction"></a><span data-ttu-id="f9a80-111">はじめに</span><span class="sxs-lookup"><span data-stu-id="f9a80-111">Introduction</span></span>

<span data-ttu-id="f9a80-112">アーキテクチャチュートリアルの ObjectDataSource および[キャッシュデータ](caching-data-in-the-architecture-vb.md)[を使用](caching-data-with-the-objectdatasource-vb.md)してデータをキャッシュするキャッシュ技法では、時間ベースの有効期限を使用して、指定した期間の経過後にキャッシュからデータを削除しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="f9a80-113">この方法は、データ staleness に対するキャッシュのパフォーマンス向上のバランスを取るための最も簡単な方法です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="f9a80-114">時間の有効期限を*x*秒に設定すると、ページ開発者は、キャッシュのパフォーマンス上のメリットを*x*秒だけで concedes ことができます。ただし、データが最大で*x*秒を超えないようにすることは簡単です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="f9a80-115">もちろん、静的なデータの場合、 *x*は web アプリケーションの有効期間に拡張できます。これは、「[アプリケーションの起動時にデータをキャッシュ](caching-data-at-application-startup-vb.md)する」チュートリアルで確認したものです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-vb.md) tutorial.</span></span>

<span data-ttu-id="f9a80-116">データベースデータをキャッシュする場合、時間ベースの有効期限は使いやすいものとして選択されることがよくありますが、多くの場合、不適切な解決策になります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="f9a80-117">データベース内の基になるデータが変更されるまで、データベースのデータはキャッシュされたままになることが理想的です。その後、キャッシュは削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="f9a80-118">この方法では、キャッシュのパフォーマンス上の利点が最大限に向上し、古いデータの存続期間を最小限に抑えることができます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="f9a80-119">ただし、これらの利点を活用するためには、基になるデータベースデータが変更されたことを認識し、対応する項目をキャッシュから見つけするシステムがいくつか存在している必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="f9a80-120">ASP.NET 2.0 より前のページ開発者は、このシステムの実装を担当していました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="f9a80-121">ASP.NET 2.0 は、対応するキャッシュされた項目を削除できるように、データベース内で変更が発生したことを判断するために[`SqlCacheDependency` クラス](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx)および必要なインフラストラクチャを提供します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="f9a80-122">基になるデータがどのように変更されたかを判断するには、通知とポーリングの2つの方法があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="f9a80-123">通知とポーリングの違いについて説明した後、ポーリングをサポートするために必要なインフラストラクチャを作成し、宣言型のシナリオやプログラムによるシナリオで `SqlCacheDependency` クラスを使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="f9a80-124">通知とポーリングについて</span><span class="sxs-lookup"><span data-stu-id="f9a80-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="f9a80-125">データベース内のデータが変更された日時を判断するには、通知とポーリングの2つの手法を使用できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="f9a80-126">通知を使用すると、クエリが最後に実行されてから特定のクエリの結果が変更されたときに、そのクエリに関連付けられているキャッシュされた項目が削除された時点で、データベースは ASP.NET ランタイムに自動的に警告します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="f9a80-127">データベースサーバーは、ポーリングを使用して、特定のテーブルが最後に更新された日時に関する情報を保持します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="f9a80-128">ASP.NET ランタイムは、データベースを定期的にポーリングして、キャッシュに入ってから変更されたテーブルを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="f9a80-129">データが変更されているテーブルには、関連付けられているキャッシュ項目が削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="f9a80-130">通知オプションは、ポーリングよりも設定が少なくて済むため、テーブルレベルではなくクエリレベルで変更が追跡されるため、より詳細な設定が必要になります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="f9a80-131">残念ながら、通知は Microsoft SQL Server 2005 (つまり、Express 以外のエディション) の全エディションでのみ利用できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="f9a80-132">ただし、ポーリングオプションは、7.0 から2005のすべてのバージョンの Microsoft SQL Server に使用できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="f9a80-133">これらのチュートリアルでは SQL Server 2005 の Express edition を使用しているため、ポーリングオプションの設定と使用について重点的に説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="f9a80-134">SQL Server 2005 s の通知機能に関するその他のリソースについては、このチュートリアルの最後にある「参考資料」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="f9a80-135">ポーリングを使用する場合、データベースは、`tableName`、`notificationCreated`、および `changeId`の3つの列を持つ `AspNet_SqlCacheTablesForChangeNotification` という名前のテーブルを含めるように構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="f9a80-136">このテーブルには、web アプリケーションの SQL キャッシュ依存関係で使用する必要があるデータを含むテーブルごとに1行のデータが格納されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="f9a80-137">`tableName` 列はテーブルの名前を指定し、`notificationCreated` はテーブルに行が追加された日付と時刻を示します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="f9a80-138">`changeId` 列の型は `int` で、初期値は0です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="f9a80-139">この値は、テーブルへの変更ごとにインクリメントされます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="f9a80-140">データベースでは、`AspNet_SqlCacheTablesForChangeNotification` テーブルに加えて、SQL キャッシュ依存関係に表示される可能性のある各テーブルにトリガーを含める必要もあります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="f9a80-141">これらのトリガーは、行が挿入、更新、または削除されるたびに実行され、テーブルの `changeId` 値が `AspNet_SqlCacheTablesForChangeNotification`でインクリメントされます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="f9a80-142">ASP.NET ランタイムは、`SqlCacheDependency` オブジェクトを使用してデータをキャッシュするときに、テーブルの現在の `changeId` を追跡します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="f9a80-143">データベースは定期的にチェックされ、`changeId` がデータベース内の値と異なる `SqlCacheDependency` オブジェクトは削除されます。これは、データがキャッシュされてからテーブルに変更があったことを示す `changeId` 値が異なるためです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnet_regsqlexecommand-line-program"></a><span data-ttu-id="f9a80-144">手順 1:`aspnet_regsql.exe`コマンドラインプログラムを探索する</span><span class="sxs-lookup"><span data-stu-id="f9a80-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="f9a80-145">ポーリング方法を使用する場合、データベースは、前述のインフラストラクチャを格納するようにセットアップする必要があります。定義済みのテーブル (`AspNet_SqlCacheTablesForChangeNotification`)、いくつかのストアドプロシージャ、および web アプリケーションの SQL キャッシュの依存関係で使用できる各テーブルのトリガーです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="f9a80-146">これらのテーブル、ストアドプロシージャ、およびトリガーは、`$WINDOWS$\Microsoft.NET\Framework\version` フォルダーにあるコマンドラインプログラム `aspnet_regsql.exe`を使用して作成できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="f9a80-147">`AspNet_SqlCacheTablesForChangeNotification` テーブルと関連するストアドプロシージャを作成するには、コマンドラインから次のコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="f9a80-148">これらのコマンドを実行するには、指定されたデータベースログインが[`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx)ロールと[`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx)ロールに存在する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="f9a80-149">`aspnet_regsql.exe` コマンドラインプログラムによってデータベースに送信された T-sql を確認するには、こちらの[ブログエントリ](http://scottonwriting.net/sowblog/posts/10709.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>

<span data-ttu-id="f9a80-150">たとえば、Windows 認証を使用して `ScottsServer` という名前のデータベースサーバーで `pubs` という名前の Microsoft SQL Server データベースにポーリングするためのインフラストラクチャを追加するには、適切なディレクトリに移動し、コマンドラインで次のように入力します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample2.cmd)]

<span data-ttu-id="f9a80-151">データベースレベルのインフラストラクチャを追加した後、SQL キャッシュの依存関係で使用されるこれらのテーブルにトリガーを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="f9a80-152">`aspnet_regsql.exe` コマンドラインプログラムをもう一度使用しますが、`-t` スイッチを使用してテーブル名を指定し、`-ed` スイッチを使用するのではなく、次のように `-et`を使用します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>

[!code-html[Main](using-sql-cache-dependencies-vb/samples/sample3.html)]

<span data-ttu-id="f9a80-153">`ScottsServer`上の `pubs` データベースの `authors` テーブルおよび `titles` テーブルにトリガーを追加するには、次のように使用します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample4.cmd)]

<span data-ttu-id="f9a80-154">このチュートリアルでは、トリガーを `Products`、`Categories`、および `Suppliers` テーブルに追加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="f9a80-155">ここでは、手順 3. の特定のコマンドライン構文について説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inapp_data"></a><span data-ttu-id="f9a80-156">手順 2:`App_Data` で Microsoft SQL Server 2005 Express Edition データベースを参照する</span><span class="sxs-lookup"><span data-stu-id="f9a80-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="f9a80-157">`aspnet_regsql.exe` コマンドラインプログラムでは、必要なポーリングインフラストラクチャを追加するために、データベースとサーバー名が必要です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="f9a80-158">ただし、`App_Data` フォルダーに存在する Microsoft SQL Server 2005 Express データベースのデータベースとサーバー名は何ですか。</span><span class="sxs-lookup"><span data-stu-id="f9a80-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="f9a80-159">データベースとサーバーの名前を調べる必要はありません。最も簡単な方法は、データベースを `localhost\SQLExpress` データベースインスタンスにアタッチし、 [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx)を使用してデータの名前を変更することです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="f9a80-160">SQL Server 2005 の全バージョンがコンピューターにインストールされている場合は、既にコンピューターに SQL Server Management Studio がインストールされている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="f9a80-161">Express edition のみを使用している場合は、無料の[Microsoft SQL Server Management Studio Express edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)をダウンロードできます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="f9a80-162">まず、Visual Studio を終了します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="f9a80-163">次に、SQL Server Management Studio を開き、Windows 認証を使用して `localhost\SQLExpress` サーバーへの接続を選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>

![Localhost\SQLExpress サーバーにアタッチする](using-sql-cache-dependencies-vb/_static/image1.gif)

<span data-ttu-id="f9a80-165">**図 1**: `localhost\SQLExpress` サーバーにアタッチする</span><span class="sxs-lookup"><span data-stu-id="f9a80-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>

<span data-ttu-id="f9a80-166">サーバーに接続すると、Management Studio にサーバーが表示され、データベース、セキュリティなどのサブフォルダーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="f9a80-167">Databases フォルダーを右クリックし、[アタッチ] オプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="f9a80-168">[データベースのアタッチ] ダイアログボックスが表示されます (図2を参照)。</span><span class="sxs-lookup"><span data-stu-id="f9a80-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="f9a80-169">[追加] ボタンをクリックし、web アプリケーション s `App_Data` フォルダー内の `NORTHWND.MDF` データベースフォルダーを選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>

<span data-ttu-id="f9a80-170">[NORTHWND.MDF をアタッチ ![ます。App_Data フォルダーからの MDF データベース](using-sql-cache-dependencies-vb/_static/image2.gif)](using-sql-cache-dependencies-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-vb/_static/image2.gif)](using-sql-cache-dependencies-vb/_static/image1.png)</span></span>

<span data-ttu-id="f9a80-171">**図 2**: `App_Data` フォルダーから `NORTHWND.MDF` データベースをアタッチする ([クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image2.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f9a80-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image2.png))</span></span>

<span data-ttu-id="f9a80-172">これにより、データベースが [データベース] フォルダーに追加されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="f9a80-173">データベース名には、データベースファイルへの完全なパス、または[GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier)を付加した完全パスを指定できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="f9a80-174">Aspnet\_のコマンドラインツールを使用するときに、この長いデータベース名を入力する必要がないようにするには、アタッチしたデータベースを右クリックし、[名前の変更] を選択して、データベースの名前をよりわかりやすい名前に変更します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="f9a80-175">データベースの名前を DataTutorials に変更しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-175">I ve renamed my database to DataTutorials .</span></span>

![アタッチされたデータベースの名前を、よりわかりやすい名前に変更します。](using-sql-cache-dependencies-vb/_static/image3.gif)

<span data-ttu-id="f9a80-177">**図 3**: アタッチされたデータベースの名前を人にわかりやすい名前に変更する</span><span class="sxs-lookup"><span data-stu-id="f9a80-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>

## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="f9a80-178">手順 3: ポーリングインフラストラクチャを Northwind データベースに追加する</span><span class="sxs-lookup"><span data-stu-id="f9a80-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="f9a80-179">これで、`App_Data` フォルダーから `NORTHWND.MDF` データベースがアタッチされたので、ポーリングインフラストラクチャを追加する準備が整いました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="f9a80-180">データベースの名前を DataTutorials に変更した場合は、次の4つのコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample5.cmd)]

<span data-ttu-id="f9a80-181">これらの4つのコマンドを実行した後、Management Studio でデータベース名を右クリックし、[タスク] サブメニューにアクセスして、[デタッチ] を選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="f9a80-182">次に、Management Studio を閉じて、Visual Studio を再度開きます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="f9a80-183">Visual Studio を再び開いたら、サーバーエクスプローラーを使用してデータベースをドリルダウンします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="f9a80-184">新しいテーブル (`AspNet_SqlCacheTablesForChangeNotification`)、新しいストアドプロシージャ、および `Products`、`Categories`、および `Suppliers` テーブルのトリガーに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>

![データベースに必要なポーリングインフラストラクチャが含まれるようになりました](using-sql-cache-dependencies-vb/_static/image4.gif)

<span data-ttu-id="f9a80-186">**図 4**: データベースに必要なポーリングインフラストラクチャが含まれるようになった</span><span class="sxs-lookup"><span data-stu-id="f9a80-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>

## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="f9a80-187">手順 4: ポーリングサービスを構成する</span><span class="sxs-lookup"><span data-stu-id="f9a80-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="f9a80-188">データベースに必要なテーブル、トリガー、およびストアドプロシージャを作成したら、最後の手順として、ポーリングサービスを構成します。これは、使用するデータベースとポーリング頻度をミリ秒単位で指定することによって `Web.config` によって行われます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="f9a80-189">次のマークアップは、1秒ごとに Northwind データベースをポーリングします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-189">The following markup polls the Northwind database once every second.</span></span>

[!code-xml[Main](using-sql-cache-dependencies-vb/samples/sample6.xml)]

<span data-ttu-id="f9a80-190">`<add>` 要素 (NorthwindDB) の `name` 値により、ユーザーが判読できる名前が特定のデータベースに関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="f9a80-191">SQL キャッシュの依存関係を使用する場合は、ここで定義されているデータベース名と、キャッシュされたデータの基になっているテーブルを参照する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="f9a80-192">`SqlCacheDependency` クラスを使用して、手順 6. で SQL キャッシュの依存関係とキャッシュされたデータをプログラムで関連付ける方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="f9a80-193">SQL キャッシュの依存関係が確立されると、ポーリングシステムは、`<databases>` 要素で定義されているデータベースに `pollTime` ミリ秒ごとに接続し、`AspNet_SqlCachePollingStoredProcedure` ストアドプロシージャを実行します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="f9a80-194">このストアドプロシージャは `aspnet_regsql.exe` コマンドラインツールを使用して手順3で戻されました。 `AspNet_SqlCacheTablesForChangeNotification`内の各レコードの `tableName` と `changeId` の値を返します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="f9a80-195">古くなった SQL キャッシュ依存関係はキャッシュから削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="f9a80-196">`pollTime` 設定では、パフォーマンスとデータ staleness のトレードオフが発生します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="f9a80-197">`pollTime` 値を小さくすると、データベースへの要求数が増加しますが、キャッシュから古いデータをより迅速に見つけます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="f9a80-198">`pollTime` 値を大きくすると、データベース要求の数が減少しますが、バックエンドデータが変更されてから関連するキャッシュ項目が削除されるまでの間の遅延が増加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="f9a80-199">幸いなことに、データベース要求では、単純な簡易テーブルから少数の行を返す単純なストアドプロシージャを実行しています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="f9a80-200">ただし、アプリケーションのデータベースアクセスとデータ staleness の間で最適なバランスを見つけるために、さまざまな `pollTime` 値を試してみることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="f9a80-201">許容される最小 `pollTime` 値は500です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="f9a80-202">上の例では、`<sqlCacheDependency>` 要素に1つの `pollTime` 値を指定していますが、必要に応じて `<add>` 要素の `pollTime` 値を指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="f9a80-203">これは、複数のデータベースを指定し、データベースごとにポーリング頻度をカスタマイズする場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>

## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="f9a80-204">手順 5: SQL キャッシュの依存関係を宣言的に操作する</span><span class="sxs-lookup"><span data-stu-id="f9a80-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="f9a80-205">手順 1. ~ 4. で、必要なデータベースインフラストラクチャを設定し、ポーリングシステムを構成する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="f9a80-206">このインフラストラクチャが整ったら、プログラムまたは宣言的手法を使用して、関連付けられた SQL キャッシュ依存関係を持つ項目をデータキャッシュに追加できるようになりました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="f9a80-207">この手順では、SQL キャッシュの依存関係を宣言によって操作する方法を確認します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="f9a80-208">手順 6. では、プログラムによるアプローチについて説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="f9a80-209">[Objectdatasource チュートリアルを使用したキャッシュデータ](caching-data-with-the-objectdatasource-vb.md)では、objectdatasource の宣言型キャッシュ機能について説明しています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="f9a80-210">単に `EnableCaching` プロパティを `True` に設定し、`CacheDuration` プロパティを一定の時間間隔に設定すると、ObjectDataSource は、基になるオブジェクトから返されたデータを指定された間隔で自動的にキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-210">By simply setting the `EnableCaching` property to `True` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="f9a80-211">ObjectDataSource では、1つまたは複数の SQL キャッシュの依存関係を使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="f9a80-212">SQL キャッシュの依存関係を宣言によって使用する方法を示すには、`Caching` フォルダーの [`SqlCacheDependencies.aspx`] ページを開き、[ツールボックス] からデザイナーに GridView をドラッグします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="f9a80-213">GridView の `ID` を `ProductsDeclarative` に設定し、そのスマートタグから、`ProductsDataSourceDeclarative`という名前の新しい ObjectDataSource にバインドするように選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>

<span data-ttu-id="f9a80-214">[新しい ObjectDataSource という名前の ![を作成します。](using-sql-cache-dependencies-vb/_static/image5.gif)](using-sql-cache-dependencies-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-vb/_static/image5.gif)](using-sql-cache-dependencies-vb/_static/image3.png)</span></span>

<span data-ttu-id="f9a80-215">**図 5**: `ProductsDataSourceDeclarative` という名前の新しい ObjectDataSource を作成[する (クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image4.png)される)</span><span class="sxs-lookup"><span data-stu-id="f9a80-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image4.png))</span></span>

<span data-ttu-id="f9a80-216">`ProductsBLL` クラスを使用するように ObjectDataSource を構成し、[選択] タブのドロップダウンリストを `GetProducts()`に設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="f9a80-217">[更新] タブで、3つの入力パラメーター (`productName`、`unitPrice`、および `productID`) を使用して、`UpdateProduct` のオーバーロードを選択します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="f9a80-218">[挿入] タブと [削除] タブで、ドロップダウンリストを [(なし)] に設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>

<span data-ttu-id="f9a80-219">[3つの入力パラメーターで UpdateProduct オーバーロードを使用 ![](using-sql-cache-dependencies-vb/_static/image6.gif)](using-sql-cache-dependencies-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-vb/_static/image6.gif)](using-sql-cache-dependencies-vb/_static/image5.png)</span></span>

<span data-ttu-id="f9a80-220">**図 6**: 3 つの入力パラメーターを使用して Updateproduct オーバーロードを使用する ([クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f9a80-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image6.png))</span></span>

<span data-ttu-id="f9a80-221">[[挿入] タブと [削除] タブで、ドロップダウンリストを [(なし)] に設定 ![ます。](using-sql-cache-dependencies-vb/_static/image7.gif)](using-sql-cache-dependencies-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-vb/_static/image7.gif)](using-sql-cache-dependencies-vb/_static/image7.png)</span></span>

<span data-ttu-id="f9a80-222">**図 7**: 挿入と削除のタブでドロップダウンリストを (なし) に設定する ([クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image8.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f9a80-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image8.png))</span></span>

<span data-ttu-id="f9a80-223">データソースの構成ウィザードを完了すると、Visual Studio によって、各データフィールドの GridView に BoundFields と CheckBoxFields が作成されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="f9a80-224">すべてのフィールドを削除し、`ProductName`、`CategoryName`、および `UnitPrice`を指定して、これらのフィールドの書式を調整します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="f9a80-225">GridView s スマートタグから、[ページングを有効にする]、[並べ替えを有効にする]、および [編集を有効にする] チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="f9a80-226">Visual Studio によって、ObjectDataSource s `OldValuesParameterFormatString` プロパティが `original_{0}`に設定されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="f9a80-227">GridView s edit 機能を正常に動作させるには、このプロパティを宣言構文から完全に削除するか、または `{0}`を既定値に設定し直す必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="f9a80-228">最後に、GridView の上にラベル Web コントロールを追加し、その `ID` プロパティを `ODSEvents` に設定し、その `EnableViewState` プロパティを `False`に設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `False`.</span></span> <span data-ttu-id="f9a80-229">これらの変更を行った後、ページの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="f9a80-230">SQL キャッシュの依存関係機能を示すために必要ではない GridView フィールドに対して、いくつかのカスタマイズされたカスタマイズを行ったことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>

[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample7.aspx)]

<span data-ttu-id="f9a80-231">次に、ObjectDataSource s `Selecting` イベントのイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample8.vb)]

<span data-ttu-id="f9a80-232">ObjectDataSource s `Selecting` イベントは、基になるオブジェクトからデータを取得するときにのみ発生することを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="f9a80-233">ObjectDataSource が独自のキャッシュからデータにアクセスする場合、このイベントは発生しません。</span><span class="sxs-lookup"><span data-stu-id="f9a80-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="f9a80-234">ここでは、ブラウザーを使用してこのページにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="f9a80-235">まだキャッシュを実装していないので、グリッドをページ表示、並べ替え、または編集するたびに、図8に示すように、ページに [イベントが発生しました] というテキストが表示されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, �Selecting event fired, as Figure 8 shows.</span></span>

<span data-ttu-id="f9a80-236">[GridView がページング、編集、または並べ替えられるたびに、ObjectDataSource s 選択イベントが発生する ![ます。](using-sql-cache-dependencies-vb/_static/image8.gif)](using-sql-cache-dependencies-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-vb/_static/image8.gif)](using-sql-cache-dependencies-vb/_static/image9.png)</span></span>

<span data-ttu-id="f9a80-237">**図 8**: GridView がページング、編集、または並べ替えされるたびに ([クリックしてフルサイズのイメージを表示](using-sql-cache-dependencies-vb/_static/image10.png))、ObjectDataSource s `Selecting` イベントが発生する</span><span class="sxs-lookup"><span data-stu-id="f9a80-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image10.png))</span></span>

<span data-ttu-id="f9a80-238">「 [Objectdatasource チュートリアルを使用](caching-data-with-the-objectdatasource-vb.md)したデータのキャッシュ」で説明したように、`EnableCaching` プロパティを `True` に設定すると、objectdatasource は `CacheDuration` プロパティによって指定された期間のデータをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) tutorial, setting the `EnableCaching` property to `True` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="f9a80-239">ObjectDataSource には、 [`SqlCacheDependency` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx)もあります。このプロパティは、次のパターンを使用して、キャッシュされたデータに1つ以上の SQL キャッシュの依存関係を追加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>

[!code-css[Main](using-sql-cache-dependencies-vb/samples/sample9.css)]

<span data-ttu-id="f9a80-240">ここで、 *databaseName*は `Web.config`の `<add>` 要素の `name` 属性で指定されているデータベースの名前です。 *tableName*はデータベーステーブルの名前です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="f9a80-241">たとえば、Northwind s `Products` テーブルに対する SQL キャッシュの依存関係に基づいてデータを無期限にキャッシュする ObjectDataSource を作成するには、ObjectDataSource s `EnableCaching` プロパティを `True` に設定し、その `SqlCacheDependency` プロパティを NorthwindDB: Products に設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `True` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="f9a80-242">SQL キャッシュ依存関係*と*時間ベースの有効期限を使用するには、`EnableCaching` を `True`に設定し、時間間隔に `CacheDuration` して、データベースとテーブル名に `SqlCacheDependency` します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `True`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="f9a80-243">時間ベースの有効期限に達した場合、または、基になるデータベースデータが変更されたことがポーリングシステムによって記録された場合、ObjectDataSource はデータを削除します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>

<span data-ttu-id="f9a80-244">`SqlCacheDependencies.aspx` の GridView では、`Products` と `Categories` の2つのテーブルのデータが表示されます (product s `CategoryName` フィールドは `JOIN` の `Categories`を使用して取得されます)。</span><span class="sxs-lookup"><span data-stu-id="f9a80-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="f9a80-245">そのため、SQL キャッシュの依存関係を2つ指定します。 NorthwindDB: Products;NorthwindDB: カテゴリ。</span><span class="sxs-lookup"><span data-stu-id="f9a80-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>

<span data-ttu-id="f9a80-246">[製品とカテゴリで SQL キャッシュの依存関係を使用してキャッシュをサポートするように ObjectDataSource を構成 ![には](using-sql-cache-dependencies-vb/_static/image9.gif)](using-sql-cache-dependencies-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-vb/_static/image9.gif)](using-sql-cache-dependencies-vb/_static/image11.png)</span></span>

<span data-ttu-id="f9a80-247">**図 9**: `Products` および `Categories` で SQL キャッシュの依存関係を使用してキャッシュをサポートするように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](using-sql-cache-dependencies-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f9a80-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image12.png))</span></span>

<span data-ttu-id="f9a80-248">キャッシュをサポートするように ObjectDataSource を構成したら、ブラウザーを使用してページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="f9a80-249">ここでも、[編集] ボタンまたは [キャンセル] ボタンをクリックすると、最初のページに移動したときに表示されるテキスト選択イベントが表示されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-249">Again, the text �Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="f9a80-250">これは、データが ObjectDataSource s キャッシュに読み込まれた後、`Products` または `Categories` テーブルが変更されるか、GridView によってデータが更新されるまで、データはそのまま残されるためです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="f9a80-251">グリッドをページングし、選択したイベントが発生したテキストがないことを通知した後、新しいブラウザーウィンドウを開き、[編集]、[挿入]、[削除] セクション (`~/EditInsertDelete/Basics.aspx`) の基本チュートリアルに移動します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-251">After paging through the grid and noting the lack of the �Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="f9a80-252">製品の名前または価格を更新します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-252">Update the name or price of a product.</span></span> <span data-ttu-id="f9a80-253">次に、最初のブラウザーウィンドウに対して、別のデータページを表示するか、グリッドを並べ替えるか、または行 s の [編集] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="f9a80-254">この時点で、基になるデータベースデータが変更されたため、選択したイベントが再表示されます (図10を参照)。</span><span class="sxs-lookup"><span data-stu-id="f9a80-254">This time, the �Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="f9a80-255">テキストが表示されない場合は、しばらく待ってからもう一度やり直してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="f9a80-256">ポーリングサービスは `pollTime` ミリ秒ごとに `Products` テーブルに対する変更を確認しているので、基になるデータが更新されてからキャッシュされたデータが削除されるまでには遅延があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

<span data-ttu-id="f9a80-257">[見つけテーブルを変更して、キャッシュされた製品データをする ![](using-sql-cache-dependencies-vb/_static/image10.gif)](using-sql-cache-dependencies-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-vb/_static/image10.gif)](using-sql-cache-dependencies-vb/_static/image13.png)</span></span>

<span data-ttu-id="f9a80-258">**図 10**: Products テーブルを変更してキャッシュされた製品データを見つけ[する (クリックしてフルサイズの画像を表示する](using-sql-cache-dependencies-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="f9a80-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image14.png))</span></span>

## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="f9a80-259">手順 6: プログラムで`SqlCacheDependency`クラスを操作する</span><span class="sxs-lookup"><span data-stu-id="f9a80-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="f9a80-260">アーキテクチャチュートリアルの[キャッシュデータ](caching-data-in-the-architecture-vb.md)は、キャッシュと ObjectDataSource を密に結合するのではなく、アーキテクチャで個別のキャッシュレイヤーを使用する利点を確認しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="f9a80-261">このチュートリアルでは、データキャッシュをプログラムで操作する方法を示す `ProductsCL` クラスを作成しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="f9a80-262">キャッシュレイヤーで SQL キャッシュの依存関係を利用するには、`SqlCacheDependency` クラスを使用します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="f9a80-263">ポーリングシステムでは、`SqlCacheDependency` オブジェクトが特定のデータベースとテーブルのペアに関連付けられている必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="f9a80-264">たとえば、次のコードでは、Northwind データベースの `Products` テーブルに基づいて `SqlCacheDependency` オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample10.vb)]

<span data-ttu-id="f9a80-265">`SqlCacheDependency` s コンストラクターへの2つの入力パラメーターは、それぞれデータベース名とテーブル名です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="f9a80-266">ObjectDataSource s `SqlCacheDependency` プロパティと同様に、使用されるデータベース名は `Web.config`の `<add>` 要素の `name` 属性で指定された値と同じです。</span><span class="sxs-lookup"><span data-stu-id="f9a80-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="f9a80-267">テーブル名は、データベーステーブルの実際の名前です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="f9a80-268">データキャッシュに追加された項目に `SqlCacheDependency` を関連付けるには、依存関係を受け入れる `Insert` メソッドオーバーロードのいずれかを使用します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="f9a80-269">次のコードでは、永続的な期間のデータキャッシュに*値*を追加しますが、それを `Products` テーブルの `SqlCacheDependency` に関連付けます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="f9a80-270">つまり、メモリの制約によって削除されるまで、またはポーリングシステムによって `Products` テーブルがキャッシュされてから変更されたことが検出されるまで、*値*はキャッシュに保持されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample11.vb)]

<span data-ttu-id="f9a80-271">キャッシュレイヤー s `ProductsCL` クラスは、時間ベースの有効期限60秒を使用して、`Products` テーブルのデータを現在キャッシュしています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="f9a80-272">代わりに、SQL キャッシュの依存関係を使用するように、このクラスを更新してみましょう。</span><span class="sxs-lookup"><span data-stu-id="f9a80-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="f9a80-273">データをキャッシュに追加するための `ProductsCL` クラス s `AddCacheItem` メソッドには、現在、次のコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample12.vb)]

<span data-ttu-id="f9a80-274">`MasterCacheKeyArray` キャッシュ依存関係の代わりに `SqlCacheDependency` オブジェクトを使用するように、このコードを更新します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample13.vb)]

<span data-ttu-id="f9a80-275">この機能をテストするには、gridview を既存の `ProductsDeclarative` GridView の下のページに追加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="f9a80-276">この新しい GridView s `ID` を `ProductsProgrammatic` に設定し、そのスマートタグを通じて、`ProductsDataSourceProgrammatic`という名前の新しい ObjectDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="f9a80-277">`ProductsCL` クラスを使用するように ObjectDataSource を構成し、[選択] タブと [更新] タブのドロップダウンリストにそれぞれ `GetProducts` と `UpdateProduct`を設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>

<span data-ttu-id="f9a80-278">[ProductsCL クラスを使用するように ObjectDataSource を構成 ![には](using-sql-cache-dependencies-vb/_static/image11.gif)](using-sql-cache-dependencies-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-vb/_static/image11.gif)](using-sql-cache-dependencies-vb/_static/image15.png)</span></span>

<span data-ttu-id="f9a80-279">**図 11**: `ProductsCL` クラスを使用するように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](using-sql-cache-dependencies-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="f9a80-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image16.png))</span></span>

<span data-ttu-id="f9a80-280">[[SELECT Tab s] ドロップダウンリストから GetProducts メソッドを選択 ![ます。](using-sql-cache-dependencies-vb/_static/image12.gif)](using-sql-cache-dependencies-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-vb/_static/image12.gif)](using-sql-cache-dependencies-vb/_static/image17.png)</span></span>

<span data-ttu-id="f9a80-281">**図 12**: [select Tab s] ドロップダウンリストから `GetProducts` メソッドを選択[する (クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f9a80-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image18.png))</span></span>

<span data-ttu-id="f9a80-282">[![[更新] タブのドロップダウンリストから UpdateProduct メソッドを選択します。](using-sql-cache-dependencies-vb/_static/image13.gif)](using-sql-cache-dependencies-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="f9a80-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-vb/_static/image13.gif)](using-sql-cache-dependencies-vb/_static/image19.png)</span></span>

<span data-ttu-id="f9a80-283">**図 13**: [更新] タブのドロップダウンリストから Updateproduct メソッドを選択[する (クリックすると、フルサイズの画像が表示](using-sql-cache-dependencies-vb/_static/image20.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f9a80-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image20.png))</span></span>

<span data-ttu-id="f9a80-284">データソースの構成ウィザードを完了すると、Visual Studio によって、各データフィールドの GridView に BoundFields と CheckBoxFields が作成されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="f9a80-285">このページに最初に追加された GridView と同様に、`ProductName`、`CategoryName`、および `UnitPrice`のすべてのフィールドを削除し、必要に応じてこれらのフィールドの書式を設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="f9a80-286">GridView s スマートタグから、[ページングを有効にする]、[並べ替えを有効にする]、および [編集を有効にする] チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="f9a80-287">`ProductsDataSourceDeclarative` ObjectDataSource と同様に、Visual Studio は `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` プロパティを `original_{0}`に設定します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="f9a80-288">GridView s edit 機能が正常に機能するためには、このプロパティを `{0}` に戻します (または、プロパティの割り当てを宣言構文から完全に削除します)。</span><span class="sxs-lookup"><span data-stu-id="f9a80-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="f9a80-289">これらのタスクを完了すると、結果として得られる GridView および ObjectDataSource の宣言マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>

[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample14.aspx)]

<span data-ttu-id="f9a80-290">キャッシュ層で SQL キャッシュの依存関係をテストするには、`ProductCL` クラス s `AddCacheItem` メソッドにブレークポイントを設定し、デバッグを開始します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="f9a80-291">最初に `SqlCacheDependencies.aspx`にアクセスしたときに、データが最初に要求され、キャッシュに格納されるため、ブレークポイントに達する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="f9a80-292">次に、GridView 内の別のページに移動するか、いずれかの列を並べ替えます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="f9a80-293">これにより、GridView はデータを再クエリしますが、`Products` データベーステーブルが変更されていないため、データがキャッシュ内に存在する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="f9a80-294">データがキャッシュに繰り返し見つからない場合は、コンピューターに十分なメモリがあることを確認してから、もう一度やり直してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="f9a80-295">GridView のいくつかのページを使用してページングを行った後、2番目のブラウザーウィンドウを開き、[編集]、[挿入]、[削除] セクション (`~/EditInsertDelete/Basics.aspx`) の基本チュートリアルに移動します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="f9a80-296">Products テーブルからレコードを更新してから、最初のブラウザーウィンドウから新しいページを表示するか、並べ替えヘッダーのいずれかをクリックします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="f9a80-297">このシナリオでは、次の2つのいずれかが表示されます。ブレークポイントがヒットすると、データベースの変更によってキャッシュデータが削除されたことを示します。または、ブレークポイントにヒットしません。つまり、`SqlCacheDependencies.aspx` に古いデータが表示されるようになります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="f9a80-298">ブレークポイントにヒットしない場合は、データが変更されてからポーリングサービスがまだ起動していない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="f9a80-299">ポーリングサービスは `pollTime` ミリ秒ごとに `Products` テーブルに対する変更を確認しているので、基になるデータが更新されてからキャッシュされたデータが削除されるまでには遅延があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="f9a80-300">この遅延は、`SqlCacheDependencies.aspx`の GridView で製品の1つを編集するときに表示される可能性が高くなります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="f9a80-301">アーキテクチャチュートリアルの[キャッシュデータ](caching-data-in-the-architecture-vb.md)では、`MasterCacheKeyArray` キャッシュ依存関係を追加して、`ProductsCL` クラス s `UpdateProduct` メソッドを使用して編集されるデータがキャッシュから削除されたことを確認しました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="f9a80-302">ただし、この手順の前半で `AddCacheItem` メソッドを変更するときには、このキャッシュの依存関係を置き換えました。したがって、`ProductsCL` クラスは、ポーリングシステムが `Products` テーブルに変更を記録するまで、キャッシュされたデータを引き続き表示します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="f9a80-303">手順 7. で `MasterCacheKeyArray` キャッシュの依存関係を再度導入する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>

## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="f9a80-304">手順 7: キャッシュされた項目に複数の依存関係を関連付ける</span><span class="sxs-lookup"><span data-stu-id="f9a80-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="f9a80-305">`MasterCacheKeyArray` キャッシュの依存関係を使用して、*すべて*の製品関連データが、関連付けられている1つの項目が更新されたときにキャッシュから確実に削除されることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="f9a80-306">たとえば、`GetProductsByCategoryID(categoryID)` メソッドでは、一意の*categoryID*値ごとに `ProductsDataTables` インスタンスがキャッシュされます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="f9a80-307">これらのオブジェクトのいずれかが削除されると、`MasterCacheKeyArray` キャッシュの依存関係によって、他のオブジェクトも削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="f9a80-308">このキャッシュ依存関係がない場合、キャッシュされたデータが変更されると、他のキャッシュされた製品データが古くなっている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="f9a80-309">そのため、SQL キャッシュの依存関係を使用する場合は、`MasterCacheKeyArray` キャッシュの依存関係を維持することが重要です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="f9a80-310">ただし、data cache s `Insert` メソッドでは、1つの依存関係オブジェクトのみが許可されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="f9a80-311">さらに、SQL キャッシュの依存関係を使用する場合は、複数のデータベーステーブルを依存関係として関連付けることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="f9a80-312">たとえば、`ProductsCL` クラスにキャッシュされた `ProductsDataTable` には、各製品のカテゴリ名と業者名が含まれていますが、`AddCacheItem` 方法では `Products`に対する依存関係のみが使用されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="f9a80-313">この場合、ユーザーがカテゴリまたは供給業者の名前を更新すると、キャッシュされた製品データはキャッシュに残り、期限切れになります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="f9a80-314">したがって、キャッシュされた製品データは、`Products` テーブルだけでなく、`Categories` テーブルと `Suppliers` テーブルにも依存するようにします。</span><span class="sxs-lookup"><span data-stu-id="f9a80-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="f9a80-315">[`AggregateCacheDependency` クラス](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx)は、複数の依存関係をキャッシュ項目に関連付けるための手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="f9a80-316">まず、`AggregateCacheDependency` インスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="f9a80-317">次に、`AggregateCacheDependency` s `Add` メソッドを使用して、依存関係のセットを追加します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="f9a80-318">その後、データキャッシュに項目を挿入する場合は、`AggregateCacheDependency` インスタンスを渡します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="f9a80-319">`AggregateCacheDependency` インスタンスの*いずれか*の依存関係が変更されると、キャッシュされた項目は削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="f9a80-320">`ProductsCL` クラス s `AddCacheItem` メソッドの更新されたコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="f9a80-321">メソッドは、`Products`、`Categories`、および `Suppliers` テーブルの `SqlCacheDependency` オブジェクトと共に `MasterCacheKeyArray` キャッシュ依存関係を作成します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="f9a80-322">これらはすべて、`aggregateDependencies`という名前の1つの `AggregateCacheDependency` オブジェクトに結合され、その後 `Insert` メソッドに渡されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample15.vb)]

<span data-ttu-id="f9a80-323">この新しいコードをテストします。これで、`Products`、`Categories`、または `Suppliers` テーブルに変更が加えられたため、キャッシュされたデータが削除されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="f9a80-324">さらに、`ProductsCL` クラス s `UpdateProduct` メソッドは、GridView を通じて製品を編集するときに呼び出されます。このメソッドは、キャッシュ依存関係の `MasterCacheKeyArray` を見つけします。これにより、キャッシュされた `ProductsDataTable` が削除され、次の要求でデータが再取得されます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="f9a80-325">SQL キャッシュの依存関係は、[出力キャッシュ](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx)と共に使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="f9a80-326">この機能のデモンストレーションについては、「 [SQL Server での ASP.NET 出力キャッシュの使用](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="f9a80-327">要約</span><span class="sxs-lookup"><span data-stu-id="f9a80-327">Summary</span></span>

<span data-ttu-id="f9a80-328">データベースデータをキャッシュする場合、データはデータベースで変更されるまでキャッシュに保持されるのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="f9a80-329">ASP.NET 2.0 を使用すると、SQL キャッシュの依存関係を作成し、宣言型とプログラムによる両方のシナリオで使用できます。</span><span class="sxs-lookup"><span data-stu-id="f9a80-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="f9a80-330">この方法の課題の1つは、データが変更されたときの検出です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="f9a80-331">Microsoft SQL Server 2005 の完全バージョンでは、クエリの結果が変更されたときにアプリケーションを警告できる通知機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="f9a80-332">SQL Server 2005 とそれ以前のバージョンの SQL Server の Express Edition では、代わりにポーリングシステムを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="f9a80-333">幸いにも、必要なポーリングインフラストラクチャの設定は非常に簡単です。</span><span class="sxs-lookup"><span data-stu-id="f9a80-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="f9a80-334">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="f9a80-335">関連項目</span><span class="sxs-lookup"><span data-stu-id="f9a80-335">Further Reading</span></span>

<span data-ttu-id="f9a80-336">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="f9a80-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="f9a80-337">Microsoft SQL Server 2005 でのクエリ通知の使用</span><span class="sxs-lookup"><span data-stu-id="f9a80-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="f9a80-338">クエリ通知の作成</span><span class="sxs-lookup"><span data-stu-id="f9a80-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="f9a80-339">[`SqlCacheDependency` クラスを使用した ASP.NET でのキャッシュ](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="f9a80-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="f9a80-340">[ASP.NET SQL Server 登録ツール (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="f9a80-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="f9a80-341">`SqlCacheDependency` の概要</span><span class="sxs-lookup"><span data-stu-id="f9a80-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="f9a80-342">作成者について</span><span class="sxs-lookup"><span data-stu-id="f9a80-342">About the Author</span></span>

<span data-ttu-id="f9a80-343">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f9a80-344">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="f9a80-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f9a80-345">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="f9a80-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f9a80-346">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f9a80-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f9a80-347">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="f9a80-347">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="f9a80-348">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-348">Special Thanks To</span></span>

<span data-ttu-id="f9a80-349">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="f9a80-349">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="f9a80-350">このチュートリアルのリードレビュー担当者は、Marko Rangel、Teresa Murphy、および Hilton Giesenow でした。</span><span class="sxs-lookup"><span data-stu-id="f9a80-350">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="f9a80-351">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="f9a80-351">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="f9a80-352">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f9a80-352">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="f9a80-353">前へ</span><span class="sxs-lookup"><span data-stu-id="f9a80-353">Previous</span></span>](caching-data-at-application-startup-vb.md)
