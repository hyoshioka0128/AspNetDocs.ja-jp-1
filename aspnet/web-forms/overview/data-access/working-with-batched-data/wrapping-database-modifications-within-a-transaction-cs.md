---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: トランザクション内でのデータベース変更のC#ラップ () |Microsoft Docs
author: rick-anderson
description: このチュートリアルは、データのバッチの更新、削除、および挿入についての最初の4つです。 このチュートリアルでは、データベーストランザクションでできることについて説明します。
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: da69e466a5b506b869dc8fc0624f3e6a479199a8
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78489298"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="f1c02-104">トランザクション内のデータベース変更をラップする (C#)</span><span class="sxs-lookup"><span data-stu-id="f1c02-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="f1c02-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f1c02-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f1c02-106">[コードのダウンロード](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip)または[PDF のダウンロード](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f1c02-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="f1c02-107">このチュートリアルは、データのバッチの更新、削除、および挿入についての最初の4つです。</span><span class="sxs-lookup"><span data-stu-id="f1c02-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="f1c02-108">このチュートリアルでは、データベーストランザクションでバッチ変更をアトミック操作として実行する方法について説明します。これにより、すべての手順が成功するか、すべての手順が失敗します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="f1c02-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="f1c02-109">Introduction</span></span>

<span data-ttu-id="f1c02-110">[「データの挿入、更新、削除の概要」](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)で説明したように、GridView では行レベルの編集と削除のサポートが組み込まれています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="f1c02-111">マウスを数回クリックするだけで、コードを記述せずに豊富なデータ変更インターフェイスを作成することができます。ただし、コンテンツが行ごとに編集および削除される場合に限ります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="f1c02-112">ただし、特定のシナリオでは、これは不十分であり、レコードのバッチを編集または削除する機能をユーザーに提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="f1c02-113">たとえば、ほとんどの web ベースの電子メールクライアントでは、グリッドを使用して各メッセージが一覧表示されます。各行には、電子メール情報 (件名、送信者など) と共にチェックボックスがあります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="f1c02-114">このインターフェイスを使うと、ユーザーは複数のメッセージを確認し、[選択したメッセージの削除] ボタンをクリックして削除できます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="f1c02-115">バッチ編集インターフェイスは、ユーザーが多くの異なるレコードを頻繁に編集する場合に最適です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="f1c02-116">変更する必要があるレコードごとに、ユーザーが [編集] をクリックして変更を行い、[更新] をクリックするのではなく、バッチ編集インターフェイスによって各行が編集インターフェイスと共に表示されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="f1c02-117">ユーザーは、変更する必要がある行のセットをすばやく変更し、[すべて更新] ボタンをクリックして変更を保存することができます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="f1c02-118">この一連のチュートリアルでは、データのバッチを挿入、編集、および削除するためのインターフェイスを作成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="f1c02-119">バッチ操作を実行するときは、バッチ内の操作の一部が成功するかどうかを判断することが重要です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="f1c02-120">バッチ削除インターフェイスを考えてみます。最初に選択したレコードが正常に削除された場合に、2番目のレコードが失敗した場合 (外部キー制約違反が原因で、</span><span class="sxs-lookup"><span data-stu-id="f1c02-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="f1c02-121">最初のレコードの削除をロールバックする必要がありますか。最初のレコードを削除したままにすることは許容されますか。</span><span class="sxs-lookup"><span data-stu-id="f1c02-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="f1c02-122">バッチ操作を[アトミックな操作](http://en.wikipedia.org/wiki/Atomic_operation)として処理する場合、すべての手順が成功するか、すべての手順が失敗する場合は、[データベーストランザクション](http://en.wikipedia.org/wiki/Database_transaction)のサポートを含めるようにデータアクセス層を拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="f1c02-123">データベーストランザクションでは、トランザクションの全体で実行される一連の `INSERT`、`UPDATE`、および `DELETE` ステートメントの原子性を保証し、最新のすべてのデータベースシステムでサポートされている機能です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="f1c02-124">このチュートリアルでは、DAL を拡張してデータベーストランザクションを使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="f1c02-125">以降のチュートリアルでは、バッチの挿入、更新、および削除のための web ページの実装について説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="f1c02-126">始めましょう!</span><span class="sxs-lookup"><span data-stu-id="f1c02-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="f1c02-127">バッチトランザクション内のデータを変更する場合、原子性は必ずしも必要ではありません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="f1c02-128">場合によっては、web ベースの電子メールクライアントから一連の電子メールを削除するなど、一部のデータ変更が成功し、同じバッチ内の他のユーザーが失敗することがあります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="f1c02-129">削除処理中にデータベースエラーが発生した場合は、エラーなしで処理されたレコードを削除したままにすることができます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="f1c02-130">このような場合は、データベーストランザクションをサポートするために DAL を変更する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="f1c02-131">ただし、その他のバッチ操作シナリオでは、原子性が不可欠です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="f1c02-132">顧客が銀行口座から別の銀行口座に資金を移動する場合、2つの操作を実行する必要があります。1つ目のアカウントから資金を差し引き、2番目の口座に追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="f1c02-133">銀行では最初のステップが成功しても、2番目のステップは失敗しても、その顧客は当然てしまうことを気にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="f1c02-134">このチュートリアルでは、次の3つのチュートリアルで作成するインターフェイスの挿入、更新、および削除をバッチで使用する予定がない場合でも、データベーストランザクションをサポートするために、DAL の機能強化を実装することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="f1c02-135">トランザクションの概要</span><span class="sxs-lookup"><span data-stu-id="f1c02-135">An Overview of Transactions</span></span>

<span data-ttu-id="f1c02-136">ほとんどのデータベースには*トランザクション*のサポートが含まれており、複数のデータベースコマンドを1つの論理的な作業単位にグループ化することができます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="f1c02-137">トランザクションを構成するデータベースコマンドはアトミックであることが保証されます。つまり、すべてのコマンドが失敗するか、すべてが成功します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="f1c02-138">一般に、トランザクションは、次のパターンを使用して SQL ステートメントによって実装されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="f1c02-139">トランザクションの開始を示します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="f1c02-140">トランザクションを構成する SQL ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="f1c02-141">手順 2. のステートメントのいずれかでエラーが発生した場合は、トランザクションをロールバックします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="f1c02-142">手順 2. のすべてのステートメントがエラーなしで完了した場合は、トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="f1c02-143">トランザクションの作成、コミット、およびロールバックに使用される SQL ステートメントは、SQL スクリプトの記述時やストアドプロシージャの作成時に手動で入力することも、 [`System.Transactions` 名前空間](https://msdn.microsoft.com/library/system.transactions.aspx)の ADO.NET またはクラスを使用してプログラムによって指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="f1c02-144">このチュートリアルでは、ADO.NET を使用したトランザクションの管理のみを確認します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="f1c02-145">今後のチュートリアルでは、データアクセス層でストアドプロシージャを使用する方法について説明します。この時点で、トランザクションを作成、ロールバック、およびコミットするための SQL ステートメントについて説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="f1c02-146">詳細については、「 [SQL Server ストアドプロシージャでのトランザクションの管理](http://www.4guysfromrolla.com/webtech/080305-1.shtml)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="f1c02-147">`System.Transactions` 名前空間の[`TransactionScope` クラス](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx)を使用すると、開発者はトランザクションのスコープ内で一連のステートメントをプログラムによってラップできます。また、2つの異なるデータベース、または Microsoft SQL Server データベース、Oracle データベース、Web サービスなどの異種データストアの種類も含めて、複数のソースが関係する複雑なトランザクションがサポートされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="f1c02-148">このチュートリアルでは、`TransactionScope` クラスの代わりに ADO.NET トランザクションを使用することにしました。これは、ADO.NET がデータベーストランザクションにより固有であり、多くの場合、リソースの消費量がはるかに少なくなるためです。</span><span class="sxs-lookup"><span data-stu-id="f1c02-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="f1c02-149">また、特定のシナリオでは、`TransactionScope` クラスは Microsoft 分散トランザクションコーディネーター (MSDTC) を使用します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="f1c02-150">MSDTC を取り巻く構成、実装、およびパフォーマンスの問題により、特に専門的で高度なトピックが作成され、これらのチュートリアルの範囲を超えています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="f1c02-151">ADO.NET で SqlClient プロバイダーを使用する場合、トランザクションは[`SqlTransaction` オブジェクト](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx)を返す[`SqlConnection` クラス](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx)s [`BeginTransaction` メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx)の呼び出しを通じて開始されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="f1c02-152">トランザクションを作成するデータ変更ステートメントは、`try...catch` ブロック内に配置されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="f1c02-153">`try` ブロック内のステートメントでエラーが発生した場合、実行は、`SqlTransaction` オブジェクト s [`Rollback` メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)を介してトランザクションをロールバックできる `catch` ブロックに転送されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="f1c02-154">すべてのステートメントが正常に完了した場合、`try` ブロックの最後に `SqlTransaction` object s [`Commit` メソッド](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx)を呼び出すと、トランザクションがコミットされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="f1c02-155">次のコードスニペットは、このパターンを示しています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="f1c02-156">ADO.NET でトランザクションを使用する場合のその他の構文と例については、「[トランザクションとデータベースの一貫性の維持](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="f1c02-157">既定では、型指定されたデータセット内の Tableadapter はトランザクションを使用しません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="f1c02-158">トランザクションのサポートを提供するには、上記のパターンを使用する追加のメソッドを含むように TableAdapter クラスを拡張して、トランザクションのスコープ内で一連のデータ変更ステートメントを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="f1c02-159">手順 2. では、部分クラスを使用してこれらのメソッドを追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="f1c02-160">手順 1: バッチ処理されたデータ Web ページの操作を作成する</span><span class="sxs-lookup"><span data-stu-id="f1c02-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="f1c02-161">データベーストランザクションをサポートするために DAL を拡張する方法について説明する前に、まず、このチュートリアルで必要となる ASP.NET web ページと、次の3つのページを作成します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="f1c02-162">まず、`BatchData` という名前の新しいフォルダーを追加し、次の ASP.NET ページを追加します。各ページは `Site.master` マスターページに関連付けられています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![SqlDataSource 関連のチュートリアルの ASP.NET ページを追加する](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="f1c02-164">**図 1**: SqlDataSource 関連のチュートリアルの ASP.NET ページを追加する</span><span class="sxs-lookup"><span data-stu-id="f1c02-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="f1c02-165">他のフォルダーと同様に、`Default.aspx` は `SectionLevelTutorialListing.ascx` ユーザーコントロールを使用して、そのセクション内のチュートリアルの一覧を表示します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="f1c02-166">したがって、ソリューションエクスプローラーからページデザインビューにドラッグして、このユーザーコントロールを `Default.aspx` に追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="f1c02-167">[SectionLevelTutorialListing ユーザーコントロールを default.aspx に追加 ![には](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="f1c02-168">**図 2**: `Default.aspx` に `SectionLevelTutorialListing.ascx` ユーザーコントロールを追加する ([クリックすると、フルサイズの画像が表示](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f1c02-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>

<span data-ttu-id="f1c02-169">最後に、これらの4つのページをエントリとして `Web.sitemap` ファイルに追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="f1c02-170">具体的には、`<siteMapNode>`サイトマップのカスタマイズの後に、次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="f1c02-171">`Web.sitemap`を更新した後、ブラウザーを使用してチュートリアル web サイトを表示します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="f1c02-172">左側のメニューには、バッチ化されたデータのチュートリアルを使用するための項目が含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![サイトマップに、バッチ処理されたデータの使用に関するチュートリアルのエントリが含まれるようになりました。](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="f1c02-174">**図 3**: サイトマップに、バッチ処理されたデータの使用に関するチュートリアルのエントリが含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="f1c02-175">手順 2: データベーストランザクションをサポートするためのデータアクセス層の更新</span><span class="sxs-lookup"><span data-stu-id="f1c02-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="f1c02-176">最初のチュートリアルで説明したように、[データアクセス層の作成](../introduction/creating-a-data-access-layer-cs.md)では、DAL 内の型指定されたデータセットは Datatable と tableadapter で構成されています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="f1c02-177">データテーブルはデータを保持しますが、Tableadapter はデータベースから Datatable にデータを読み取り、Datatable に加えられた変更でデータベースを更新する機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="f1c02-178">Tableadapter には、データを更新するための2つのパターンが用意されています。これは、Batch Update と DB Direct と呼ばれていました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="f1c02-179">バッチ更新パターンでは、TableAdapter にデータセット、DataTable、または Datarow のコレクションが渡されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="f1c02-180">このデータは列挙され、挿入、変更、または削除された行ごとに、`InsertCommand`、`UpdateCommand`、または `DeleteCommand` が実行されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="f1c02-181">DB ダイレクトパターンでは、1つのレコードの挿入、更新、または削除に必要な列の値が TableAdapter に渡されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="f1c02-182">次に、DB Direct pattern メソッドは、渡された値を使用して、適切な `InsertCommand`、`UpdateCommand`、または `DeleteCommand` ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="f1c02-183">使用する更新パターンに関係なく、Tableadapter の自動生成メソッドはトランザクションを使用しません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="f1c02-184">既定では、TableAdapter によって実行される挿入、更新、または削除は、1つの個別の操作として扱われます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="f1c02-185">たとえば、データベースに10個のレコードを挿入するために、BLL の一部のコードで DB ダイレクトパターンが使用されているとします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="f1c02-186">このコードは、TableAdapter s `Insert` メソッドを10回呼び出します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="f1c02-187">最初の5つの挿入が成功しても、6番目の挿入によって例外が発生した場合、最初の5つの挿入レコードはデータベースに残ります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="f1c02-188">同様に、バッチ更新パターンを使用して、DataTable 内の挿入、変更、および削除された行に対して挿入、更新、および削除を実行する場合、最初のいくつかの変更が成功したが、後でエラーが発生した場合は、以前の変更が完了したはデータベースに残ります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="f1c02-189">特定のシナリオでは、一連の変更に対して原子性を確保する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="f1c02-190">これを実現するには、トランザクションの包括的な下で `InsertCommand`、`UpdateCommand`、および `DeleteCommand` を実行する新しいメソッドを追加して、手動で TableAdapter を拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="f1c02-191">「[データアクセス層の作成](../introduction/creating-a-data-access-layer-cs.md)」では、[部分クラス](http://en.wikipedia.org/wiki/Partial_type)を使用して、型指定されたデータセット内の datatable の機能を拡張する方法を見てきました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="f1c02-192">この手法は、Tableadapter でも使用できます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="f1c02-193">型指定されたデータセット `Northwind.xsd` は、`App_Code` folder s `DAL` サブフォルダーにあります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="f1c02-194">`TransactionSupport` という名前の `DAL` フォルダーにサブフォルダーを作成し、`ProductsTableAdapter.TransactionSupport.cs` という名前の新しいクラスファイルを追加します (図4を参照)。</span><span class="sxs-lookup"><span data-stu-id="f1c02-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="f1c02-195">このファイルには、トランザクションを使用してデータ変更を実行するためのメソッドを含む `ProductsTableAdapter` の部分実装が格納されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![TransactionSupport という名前のフォルダーと ProductsTableAdapter.TransactionSupport.cs という名前のクラスファイルを追加します。](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="f1c02-197">**図 4**: `TransactionSupport` という名前のフォルダーと、という `ProductsTableAdapter.TransactionSupport.cs` 名前のクラスファイルを追加する</span><span class="sxs-lookup"><span data-stu-id="f1c02-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>

<span data-ttu-id="f1c02-198">`ProductsTableAdapter.TransactionSupport.cs` ファイルに次のコードを入力します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="f1c02-199">ここでは、クラス宣言内の `partial` キーワードは、内に追加されたメンバーが `NorthwindTableAdapters` 名前空間の `ProductsTableAdapter` クラスに追加されることをコンパイラに示しています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="f1c02-200">ファイルの先頭にある `using System.Data.SqlClient` ステートメントに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="f1c02-201">TableAdapter は SqlClient プロバイダーを使用するように構成されているため、内部的には[`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx)オブジェクトを使用して、そのコマンドをデータベースに発行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="f1c02-202">そのため、`SqlTransaction` クラスを使用してトランザクションを開始し、それをコミットするかロールバックする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="f1c02-203">Microsoft SQL Server 以外のデータストアを使用している場合は、適切なプロバイダーを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="f1c02-204">これらのメソッドには、トランザクションの開始、ロールバック、およびコミットに必要な構成要素が用意されています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="f1c02-205">これらは `public`としてマークされ、`ProductsTableAdapter`内、DAL 内の別のクラス、または BLL などのアーキテクチャの別の層から使用できるようにします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="f1c02-206">`BeginTransaction` は、TableAdapter の内部 `SqlConnection` (必要に応じて) を開き、トランザクションを開始して `Transaction` プロパティに割り当て、トランザクションを内部 `SqlDataAdapter` s `SqlCommand` オブジェクトにアタッチします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="f1c02-207">`CommitTransaction` と `RollbackTransaction` は、内部 `Rollback` オブジェクトを閉じる前に、それぞれ `Transaction` オブジェクト s `Commit` および `Connection` メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="f1c02-208">手順 3: トランザクションの包括的なデータを更新および削除するメソッドを追加する</span><span class="sxs-lookup"><span data-stu-id="f1c02-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="f1c02-209">これらのメソッドが完成したので、`ProductsDataTable` にメソッドを追加したり、トランザクションの包括的な一連のコマンドを実行する BLL にメソッドを追加したりできます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="f1c02-210">次のメソッドでは、バッチ更新パターンを使用して、トランザクションを使用して `ProductsDataTable` インスタンスを更新します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="f1c02-211">`BeginTransaction` メソッドを呼び出してトランザクションを開始し、次に `try...catch` ブロックを使用してデータ変更ステートメントを発行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="f1c02-212">`Adapter` object s `Update` メソッドの呼び出しで例外が発生した場合、トランザクションがロールバックされ、例外が再スローされる `catch` ブロックに実行が転送されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="f1c02-213">`Update` メソッドは、指定された `ProductsDataTable` の行を列挙し、必要な `InsertCommand`、`UpdateCommand`、および `DeleteCommand` を実行することで、バッチ更新パターンを実装していることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="f1c02-214">これらのコマンドのいずれかでエラーが発生した場合は、トランザクションがロールバックされ、トランザクションの有効期間中に行われた以前の変更が元に戻されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="f1c02-215">`Update` ステートメントがエラーなしで完了した場合、トランザクション全体がコミットされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="f1c02-216">`ProductsTableAdapter.TransactionSupport.cs`の部分クラスを使用して、`UpdateWithTransaction` メソッドを `ProductsTableAdapter` クラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="f1c02-217">または、このメソッドをビジネスロジック層 s `ProductsBLL` クラスに追加して、いくつかのマイナー構文変更を加えることもできます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="f1c02-218">つまり、`this.BeginTransaction()`、`this.CommitTransaction()`、および `this.RollbackTransaction()` のキーワードは `Adapter` に置き換える必要があります (`Adapter` は `ProductsBLL` 型の `ProductsTableAdapter`にあるプロパティの名前であることを思い出してください)。</span><span class="sxs-lookup"><span data-stu-id="f1c02-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="f1c02-219">`UpdateWithTransaction` メソッドはバッチ更新パターンを使用しますが、次のメソッドに示すように、一連の DB ダイレクト呼び出しをトランザクションのスコープ内で使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="f1c02-220">`DeleteProductsWithTransaction` メソッドは、`int`型の `List<T>` を入力として受け入れます。これは、削除する `ProductID` s です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="f1c02-221">メソッドは `BeginTransaction` への呼び出しを通じてトランザクションを開始した後、`try` ブロック内で、各 `ProductID` 値に対して DB ダイレクトパターン `Delete` メソッドを呼び出して、指定されたリストを反復処理します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="f1c02-222">`Delete` の呼び出しが失敗した場合、トランザクションがロールバックされ、例外が再スローされる `catch` ブロックに制御が移ります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="f1c02-223">`Delete` のすべての呼び出しが成功した場合、トランザクションはコミットされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="f1c02-224">このメソッドを `ProductsBLL` クラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="f1c02-225">複数の Tableadapter にまたがるトランザクションの適用</span><span class="sxs-lookup"><span data-stu-id="f1c02-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="f1c02-226">このチュートリアルで調べるトランザクション関連のコードでは、`ProductsTableAdapter` に対する複数のステートメントをアトミック操作として扱うことができます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="f1c02-227">しかし、異なるデータベーステーブルに対して複数の変更をアトミックに実行する必要がある場合はどうでしょうか。</span><span class="sxs-lookup"><span data-stu-id="f1c02-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="f1c02-228">たとえば、カテゴリを削除するときに、最初に現在の製品を他のカテゴリに再割り当てすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="f1c02-229">これらの2つの手順では、製品を再割り当てし、カテゴリを削除して、分割不可能な操作として実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="f1c02-230">ただし `ProductsTableAdapter` には `Products` テーブルを変更するためのメソッドのみが含まれており、`CategoriesTableAdapter` には `Categories` テーブルを変更するためのメソッドのみが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="f1c02-231">では、トランザクションに両方の Tableadapter を含めるにはどうすればよいでしょうか。</span><span class="sxs-lookup"><span data-stu-id="f1c02-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="f1c02-232">1つの方法として、`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` という名前の `CategoriesTableAdapter` にメソッドを追加し、そのメソッドで、製品を再割り当てして、ストアドプロシージャ内で定義されたトランザクションのスコープ内のカテゴリを削除するストアドプロシージャを呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="f1c02-233">この後のチュートリアルでは、ストアドプロシージャでトランザクションを開始、コミット、およびロールバックする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="f1c02-234">別の方法として、`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` メソッドを含む、DAL にヘルパークラスを作成することもできます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="f1c02-235">このメソッドは、`CategoriesTableAdapter` と `ProductsTableAdapter` のインスタンスを作成し、これらの2つの Tableadapter `Connection` プロパティを同じ `SqlConnection` インスタンスに設定します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="f1c02-236">その時点で、2つの Tableadapter のいずれかが `BeginTransaction`の呼び出しでトランザクションを開始します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="f1c02-237">製品を再割り当てし、カテゴリを削除する Tableadapter メソッドは、必要に応じてトランザクションがコミットまたはロールバックされた `try...catch` ブロックで呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="f1c02-238">手順 4: ビジネスロジック層に`UpdateWithTransaction`メソッドを追加する</span><span class="sxs-lookup"><span data-stu-id="f1c02-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="f1c02-239">手順3では、DAL の `ProductsTableAdapter` に `UpdateWithTransaction` メソッドを追加しました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="f1c02-240">BLL に対応するメソッドを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="f1c02-241">プレゼンテーション層は DAL に直接呼び出して `UpdateWithTransaction` メソッドを呼び出すことができますが、これらのチュートリアルでは、プレゼンテーション層から DAL を分離するレイヤーアーキテクチャを定義する strived があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="f1c02-242">そのため、この方法を behooves してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="f1c02-243">`ProductsBLL` クラスファイルを開き、対応する DAL メソッドを単に呼び出す `UpdateWithTransaction` という名前のメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="f1c02-244">`ProductsBLL`: `UpdateWithTransaction`に2つの新しいメソッドが追加されました。これは、手順 3. で追加した `DeleteProductsWithTransaction`です。</span><span class="sxs-lookup"><span data-stu-id="f1c02-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="f1c02-245">これらのメソッドには、ASP.NET pages 分離コードクラスからこれらのメソッドを直接呼び出すため、`ProductsBLL` クラスのほとんどのメソッドに割り当てられた `DataObjectMethodAttribute` 属性は含まれません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="f1c02-246">`DataObjectMethodAttribute` を使用して、ObjectDataSource のデータソース構成ウィザードと  タブ (SELECT、UPDATE、INSERT、または DELETE) に表示するメソッドにフラグを設定することを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="f1c02-247">GridView にはバッチ編集または削除のサポートが組み込まれていないため、コードなしの宣言型の方法を使用するのではなく、プログラムでこれらのメソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="f1c02-248">手順 5: プレゼンテーション層からデータベースデータをアトミックに更新する</span><span class="sxs-lookup"><span data-stu-id="f1c02-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="f1c02-249">レコードのバッチを更新するときのトランザクションの影響を示すために、では、GridView 内のすべての製品を一覧表示するユーザーインターフェイスを作成し、クリックすると、製品 `CategoryID` 値に再割り当てするボタン Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="f1c02-250">具体的には、最初のいくつかの製品に有効な `CategoryID` 値が割り当てられ、他の製品には存在しない `CategoryID` 値が意図的に割り当てられるように、カテゴリの再割り当てが進行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="f1c02-251">`CategoryID` が既存のカテゴリ `CategoryID`と一致しない製品を使用してデータベースを更新しようとすると、外部キー制約違反が発生し、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="f1c02-252">この例では、トランザクションを使用すると、外部キー制約違反から発生した例外によって、以前の有効な `CategoryID` 変更がロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="f1c02-253">ただし、トランザクションを使用しない場合は、初期カテゴリの変更が残ります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="f1c02-254">まず、`BatchData` フォルダーの [`Transactions.aspx`] ページを開き、ツールボックスから GridView をデザイナーにドラッグします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="f1c02-255">その `ID` を `Products` に設定し、そのスマートタグから `ProductsDataSource`という名前の新しい ObjectDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="f1c02-256">`ProductsBLL` クラス s `GetProducts` メソッドからデータをプルするように ObjectDataSource を構成します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="f1c02-257">これは読み取り専用の GridView であるため、[更新]、[挿入]、[削除] の各タブのドロップダウンリストを (なし) に設定し、[完了] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="f1c02-258">[![図 5: 製品の Bll クラス s GetProducts メソッドを使用するように ObjectDataSource を構成する](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="f1c02-259">**図 5**: 図 5: `ProductsBLL` クラス s `GetProducts` メソッドを使用するように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="f1c02-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>

<span data-ttu-id="f1c02-260">[[更新]、[挿入]、[削除] の各タブのドロップダウンリストを [(なし)] に設定 ![ます。](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="f1c02-261">**図 6**: [更新]、[挿入]、[削除] の各タブのドロップダウンリストを (なし) に設定する ([クリックしてフルサイズの画像を表示する](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f1c02-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>

<span data-ttu-id="f1c02-262">データソースの構成ウィザードを完了すると、Visual Studio によって、連結されたフィールドと製品データフィールドの CheckBoxField が作成されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="f1c02-263">`ProductID`、`ProductName`、`CategoryID`、および `CategoryName` を除くすべてのフィールドを削除し、`ProductName` プロパティと `CategoryName` BoundFields をそれぞれ Product および Category に変更します。`HeaderText`</span><span class="sxs-lookup"><span data-stu-id="f1c02-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="f1c02-264">スマートタグから、[ページングを有効にする] オプションをオンにします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="f1c02-265">これらの変更を行った後、GridView および ObjectDataSource s 宣言マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="f1c02-266">次に、GridView の上に3つのボタン Web コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="f1c02-267">最初のボタン s Text プロパティを [更新グリッド] に設定し、2番目のを [カテゴリの変更] (トランザクションあり) に設定し、3つ目の [s] をクリックしてカテゴリを変更します (トランザクションなし)。</span><span class="sxs-lookup"><span data-stu-id="f1c02-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="f1c02-268">この時点で、Visual Studio のデザインビューは、図7に示すスクリーンショットのようになります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="f1c02-269">[ページに GridView と3つのボタン Web コントロールが含まれている ![](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="f1c02-270">**図 7**: ページに GridView と3つのボタンの Web コントロールが含まれている ([クリックしてフルサイズのイメージを表示する](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="f1c02-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>

<span data-ttu-id="f1c02-271">3つのボタン `Click` イベントのそれぞれに対してイベントハンドラーを作成し、次のコードを使用します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="f1c02-272">更新ボタン s `Click` イベントハンドラーは、`Products` GridView s `DataBind` メソッドを呼び出すことによって、単にデータを GridView に再バインドします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="f1c02-273">2番目のイベントハンドラーは、製品 `CategoryID` s を再割り当てし、BLL の新しいトランザクションメソッドを使用して、トランザクションのすべてのデータベースの更新を実行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="f1c02-274">各製品 `CategoryID` は、`ProductID`と同じ値に設定されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="f1c02-275">これは、最初のいくつかの製品に対しては正常に機能します。これらの製品には、有効な `CategoryID` s にマップするために `ProductID` 値があるためです。</span><span class="sxs-lookup"><span data-stu-id="f1c02-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="f1c02-276">しかし `ProductID` s が大きくなりすぎた場合、`ProductID` s と `CategoryID` s の重複は適用されなくなります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="f1c02-277">3番目の `Click` イベントハンドラーは、同じ方法で製品 `CategoryID` を更新しますが、`ProductsTableAdapter` s default `Update` メソッドを使用してデータベースに更新を送信します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="f1c02-278">この `Update` メソッドは、トランザクション内の一連のコマンドをラップするのではなく、最初に検出された外部キー制約違反エラーが発生する前に、これらの変更が行われます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="f1c02-279">この動作を説明するには、ブラウザーを使用してこのページにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="f1c02-280">最初に、図8に示すように、データの最初のページが表示されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="f1c02-281">次に、[カテゴリの変更 (トランザクションあり)] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="f1c02-282">これにより、ポストバックが発生し、すべての製品 `CategoryID` 値を更新しようとしますが、外部キー制約違反が発生します (図9を参照)。</span><span class="sxs-lookup"><span data-stu-id="f1c02-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="f1c02-283">[ページング可能な GridView に製品が表示される ![](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="f1c02-284">**図 8**: 製品がページング可能な GridView で表示される ([クリックすると、フルサイズの画像が表示](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f1c02-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>

<span data-ttu-id="f1c02-285">[カテゴリを再割り当て ![と、外部キー制約違反になります](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="f1c02-286">**図 9**: カテゴリを再割り当てすると外部キー制約違反が発生する ([クリックすると、フルサイズの画像が表示](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png)されます)</span><span class="sxs-lookup"><span data-stu-id="f1c02-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>

<span data-ttu-id="f1c02-287">ここで、ブラウザーの [戻る] ボタンをクリックし、[更新] グリッドボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="f1c02-288">データを更新すると、図8に示すようにまったく同じ出力が表示されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="f1c02-289">つまり、`CategoryID` の製品の一部が有効な値に変更され、データベースで更新された場合でも、外部キー制約違反が発生したときにロールバックされました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="f1c02-290">次に、[カテゴリの変更 (トランザクションなし)] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="f1c02-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="f1c02-291">これにより、同じ外部キー制約違反エラーが発生します (図9を参照)。ただし今回は、`CategoryID` 値が有効な値に変更された製品はロールバックされません。</span><span class="sxs-lookup"><span data-stu-id="f1c02-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="f1c02-292">ブラウザーの [戻る] ボタンをクリックすると、[グリッドの更新] ボタンが表示されます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="f1c02-293">図10に示すように、最初の8つの製品の `CategoryID` のが再割り当てされています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="f1c02-294">たとえば、図8では、変更履歴の `CategoryID` は1になっていましたが、図10では2に再割り当てされています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="f1c02-295">[一部の製品では CategoryID 値が更新されていますが、他の製品では ![](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f1c02-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="f1c02-296">**図 10**: 一部の製品 `CategoryID` 値が更新されましたが、他の製品は更新されませんでした ([クリックしてフルサイズの画像を表示](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="f1c02-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="f1c02-297">まとめ</span><span class="sxs-lookup"><span data-stu-id="f1c02-297">Summary</span></span>

<span data-ttu-id="f1c02-298">既定では、TableAdapter のメソッドは、実行されたデータベースステートメントをトランザクションのスコープ内にラップしませんが、わずかな作業で、トランザクションを作成、コミット、およびロールバックするメソッドを追加できます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="f1c02-299">このチュートリアルでは、`ProductsTableAdapter` クラスに、`BeginTransaction`、`CommitTransaction`、および `RollbackTransaction`の3つのメソッドを作成しました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="f1c02-300">これらのメソッドを `try...catch` ブロックと共に使用して、一連のデータ変更ステートメントをアトミックにする方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="f1c02-301">具体的には、`ProductsTableAdapter`で `UpdateWithTransaction` メソッドを作成しました。このメソッドは、バッチ更新パターンを使用して、指定された `ProductsDataTable`の行に対して必要な変更を実行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="f1c02-302">また、`DeleteProductsWithTransaction` メソッドを BLL の `ProductsBLL` クラスに追加しました。このクラスは、`ProductID` 値の `List` を入力として受け取り、各 `Delete` に対して DB Direct pattern メソッド `ProductID`を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="f1c02-303">どちらの方法でも、最初にトランザクションを作成し、次に `try...catch` ブロック内でデータ変更ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="f1c02-304">例外が発生した場合は、トランザクションがロールバックされます。それ以外の場合はコミットされます。</span><span class="sxs-lookup"><span data-stu-id="f1c02-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="f1c02-305">手順 5. では、トランザクションバッチ更新の効果と、トランザクションを使用しないバッチ更新の影響を示しています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="f1c02-306">次の3つのチュートリアルでは、このチュートリアルで説明した基礎に基づいて、バッチの更新、削除、挿入を実行するためのユーザーインターフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="f1c02-307">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="f1c02-308">参考資料</span><span class="sxs-lookup"><span data-stu-id="f1c02-308">Further Reading</span></span>

<span data-ttu-id="f1c02-309">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="f1c02-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="f1c02-310">トランザクションを使用したデータベースの一貫性の維持</span><span class="sxs-lookup"><span data-stu-id="f1c02-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="f1c02-311">SQL Server ストアドプロシージャでのトランザクションの管理</span><span class="sxs-lookup"><span data-stu-id="f1c02-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="f1c02-312">簡単に作成されたトランザクション: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="f1c02-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="f1c02-313">TransactionScope と Dataadapter</span><span class="sxs-lookup"><span data-stu-id="f1c02-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="f1c02-314">.NET での Oracle Database トランザクションの使用</span><span class="sxs-lookup"><span data-stu-id="f1c02-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="f1c02-315">著者について</span><span class="sxs-lookup"><span data-stu-id="f1c02-315">About the Author</span></span>

<span data-ttu-id="f1c02-316">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f1c02-317">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="f1c02-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f1c02-318">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="f1c02-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f1c02-319">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f1c02-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f1c02-320">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="f1c02-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="f1c02-321">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-321">Special Thanks To</span></span>

<span data-ttu-id="f1c02-322">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="f1c02-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="f1c02-323">このチュートリアルのリードレビュー担当者は、Dave Gardner、Hilton Giesenow、Teresa Murphy でした。</span><span class="sxs-lookup"><span data-stu-id="f1c02-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="f1c02-324">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="f1c02-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="f1c02-325">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f1c02-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="f1c02-326">Next</span><span class="sxs-lookup"><span data-stu-id="f1c02-326">Next</span></span>](batch-updating-cs.md)
