---
uid: web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
title: データベース駆動型のカスタムサイトマッププロバイダーを構築C#する () |Microsoft Docs
author: rick-anderson
description: ASP.NET 2.0 の既定のサイトマッププロバイダーは、静的な XML ファイルからそのデータを取得します。 XML ベースのプロバイダーは、多くの小規模および中程度の siz に適しています。
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 04b7591d-106f-4f05-87e9-d416cb65a8a6
msc.legacyurl: /web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
msc.type: authoredcontent
ms.openlocfilehash: a3e27b37703b12c9796e8516f0d805aef1fdf8d8
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78495856"
---
# <a name="building-a-custom-database-driven-site-map-provider-c"></a><span data-ttu-id="5380b-104">カスタム データベース駆動型サイト マップ プロバイダーを構築する (C#)</span><span class="sxs-lookup"><span data-stu-id="5380b-104">Building a Custom Database-Driven Site Map Provider (C#)</span></span>

<span data-ttu-id="5380b-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="5380b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="5380b-106">[コードのダウンロード](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip)または[PDF のダウンロード](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="5380b-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip) or [Download PDF](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span></span>

> <span data-ttu-id="5380b-107">ASP.NET 2.0 の既定のサイトマッププロバイダーは、静的な XML ファイルからそのデータを取得します。</span><span class="sxs-lookup"><span data-stu-id="5380b-107">The default site map provider in ASP.NET 2.0 retrieves its data from a static XML file.</span></span> <span data-ttu-id="5380b-108">XML ベースのプロバイダーは、多くの小規模および中規模の Web サイトに適していますが、大規模な Web アプリケーションには、より動的なサイトマップが必要です。</span><span class="sxs-lookup"><span data-stu-id="5380b-108">While the XML-based provider is suitable to many small and medium-sized Web sites, larger Web applications require a more dynamic site map.</span></span> <span data-ttu-id="5380b-109">このチュートリアルでは、ビジネスロジック層からデータを取得し、さらにデータベースからデータを取得するカスタムサイトマッププロバイダーを構築します。</span><span class="sxs-lookup"><span data-stu-id="5380b-109">In this tutorial we'll build a custom site map provider that retrieves its data from the Business Logic Layer, which in turn retrieves data from the database.</span></span>

## <a name="introduction"></a><span data-ttu-id="5380b-110">はじめに</span><span class="sxs-lookup"><span data-stu-id="5380b-110">Introduction</span></span>

<span data-ttu-id="5380b-111">ASP.NET 2.0 s サイトマップ機能を使用すると、ページ開発者は、XML ファイルなどの一部の永続メディアで web アプリケーション s サイトマップを定義できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-111">ASP.NET 2.0 s site map feature enables a page developer to define a web application s site map in some persistent medium, such as in an XML file.</span></span> <span data-ttu-id="5380b-112">定義が完了すると、 [`System.Web` 名前空間](https://msdn.microsoft.com/library/system.web.aspx)の[`SiteMap` クラス](https://msdn.microsoft.com/library/system.web.sitemap.aspx)、または SiteMapPath、Menu、TreeView コントロールなどのさまざまなナビゲーション Web コントロールを使用して、プログラムによってサイトマップデータにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="5380b-112">Once defined, the site map data can be accessed programmatically through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx) or through a variety of navigation Web controls, such as the SiteMapPath, Menu, and TreeView controls.</span></span> <span data-ttu-id="5380b-113">サイトマップシステムでは[プロバイダーモデル](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)を使用して、さまざまなサイトマップのシリアル化の実装を作成し、web アプリケーションに接続することができます。</span><span class="sxs-lookup"><span data-stu-id="5380b-113">The site map system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx) so that different site map serialization implementations can be created and plugged into a web application.</span></span> <span data-ttu-id="5380b-114">ASP.NET 2.0 に付属する既定のサイトマッププロバイダーは、サイトマップ構造を XML ファイルに保持します。</span><span class="sxs-lookup"><span data-stu-id="5380b-114">The default site map provider that ships with ASP.NET 2.0 persists site map structure in an XML file.</span></span> <span data-ttu-id="5380b-115">[マスターページとサイトナビゲーション](../introduction/master-pages-and-site-navigation-cs.md)チュートリアルに戻り、この構造を含む `Web.sitemap` という名前のファイルを作成し、新しいチュートリアルセクションごとにその XML を更新しました。</span><span class="sxs-lookup"><span data-stu-id="5380b-115">Back in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial we created a file named `Web.sitemap` that contained this structure and have been updating its XML with each new tutorial section.</span></span>

<span data-ttu-id="5380b-116">既定の XML ベースのサイトマッププロバイダーは、サイトマップの構造が非常に静的な場合 (これらのチュートリアルの場合など) に適しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-116">The default XML-based site map provider works well if the site map s structure is fairly static, such as for these tutorials.</span></span> <span data-ttu-id="5380b-117">ただし、多くのシナリオでは、より動的なサイトマップが必要です。</span><span class="sxs-lookup"><span data-stu-id="5380b-117">In many scenarios, however, a more dynamic site map is needed.</span></span> <span data-ttu-id="5380b-118">図1に示すサイトマップを考えてみます。ここで、各カテゴリと製品は、web サイトの構造のセクションとして表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-118">Consider the site map shown in Figure 1, where each category and product appear as sections in the website s structure.</span></span> <span data-ttu-id="5380b-119">このサイトマップでは、ルートノードに対応する web ページにアクセスすると、すべてのカテゴリが一覧表示されます。特定のカテゴリの web ページにアクセスすると、カテゴリの製品が一覧表示され、特定の製品の web ページを表示すると、その製品の詳細が表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-119">With this site map, visiting the web page corresponding to the root node might list all of the categories, whereas visiting a particular category s web page would list that category s products and viewing a particular product s web page would show that product s details.</span></span>

<span data-ttu-id="5380b-120">[カテゴリと製品の ![サイトマップの構造を構成する](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-120">[![The Categories and Products Makeup the Site Map s Structure](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span></span>

<span data-ttu-id="5380b-121">**図 1**: カテゴリと製品は、サイトマップの構造を構成します ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-121">**Figure 1**: The Categories and Products Makeup the Site Map s Structure ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png))</span></span>

<span data-ttu-id="5380b-122">このカテゴリと製品ベースの構造は `Web.sitemap` ファイルにハードコーディングされている可能性がありますが、カテゴリまたは製品が追加、削除、または名前変更されるたびに、ファイルを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-122">While this category- and product-based structure could be hard-coded into the `Web.sitemap` file, the file would need to be updated each time a category or product was added, removed, or renamed.</span></span> <span data-ttu-id="5380b-123">そのため、データベースから構造を取得した場合や、理想的にはアプリケーションのアーキテクチャのビジネスロジック層からサイトマップのメンテナンスが大幅に簡素化されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-123">Consequently, the site map maintenance would be greatly simplified if its structure was retrieved from the database or, ideally, from the Business Logic Layer of the application s architecture.</span></span> <span data-ttu-id="5380b-124">これにより、製品とカテゴリが追加、名前変更、または削除されたときに、これらの変更を反映するためにサイトマップが自動的に更新されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-124">That way, as products and categories were added, renamed, or deleted, the site map would automatically update to reflect these changes.</span></span>

<span data-ttu-id="5380b-125">ASP.NET 2.0 s サイトマップのシリアル化はプロバイダーモデルの上に構築されているため、データベースやアーキテクチャなどの代替データストアからデータを取得する独自のカスタムサイトマッププロバイダーを作成できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-125">Since ASP.NET 2.0 s site map serialization is built atop the provider model, we can create our own custom site map provider that grabs its data from an alternate data store, such as the database or architecture.</span></span> <span data-ttu-id="5380b-126">このチュートリアルでは、BLL からデータを取得するカスタムプロバイダーを作成します。</span><span class="sxs-lookup"><span data-stu-id="5380b-126">In this tutorial we'll build a custom provider that retrieves its data from the BLL.</span></span> <span data-ttu-id="5380b-127">始めましょう!</span><span class="sxs-lookup"><span data-stu-id="5380b-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="5380b-128">このチュートリアルで作成したカスタムサイトマッププロバイダーは、アプリケーションのアーキテクチャとデータモデルに密結合されています。</span><span class="sxs-lookup"><span data-stu-id="5380b-128">The custom site map provider created in this tutorial is tightly coupled to the application s architecture and data model.</span></span> <span data-ttu-id="5380b-129">[SQL Server にサイトマップを格納](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)する Jeff Prosise と、記事[を待機している SQL サイトマッププロバイダーが](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)、SQL Server にサイトマップデータを格納するための一般化されたアプローチを検討しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-129">Jeff Prosise s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx) articles examine a generalized approach to storing site map data in SQL Server.</span></span>

## <a name="step-1-creating-the-custom-site-map-provider-web-pages"></a><span data-ttu-id="5380b-130">手順 1: カスタムサイトマッププロバイダー Web ページの作成</span><span class="sxs-lookup"><span data-stu-id="5380b-130">Step 1: Creating the Custom Site Map Provider Web Pages</span></span>

<span data-ttu-id="5380b-131">カスタムサイトマッププロバイダーの作成を開始する前に、まず、このチュートリアルで必要な ASP.NET ページを追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="5380b-131">Before we start creating a custom site map provider, let s first add the ASP.NET pages we'll need for this tutorial.</span></span> <span data-ttu-id="5380b-132">まず、`SiteMapProvider`という名前の新しいフォルダーを追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-132">Start by adding a new folder named `SiteMapProvider`.</span></span> <span data-ttu-id="5380b-133">次に、次の ASP.NET ページをそのフォルダーに追加します。各ページは `Site.master` マスターページに関連付けられていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-133">Next, add the following ASP.NET pages to that folder, making sure to associate each page with the `Site.master` master page:</span></span>

- `Default.aspx`
- `ProductsByCategory.aspx`
- `ProductDetails.aspx`

<span data-ttu-id="5380b-134">また、`App_Code` フォルダーに `CustomProviders` サブフォルダーを追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-134">Also add a `CustomProviders` subfolder to the `App_Code` folder.</span></span>

![サイトマッププロバイダー関連のチュートリアルの ASP.NET ページを追加する](building-a-custom-database-driven-site-map-provider-cs/_static/image2.gif)

<span data-ttu-id="5380b-136">**図 2**: サイトマッププロバイダー関連のチュートリアルの ASP.NET ページを追加する</span><span class="sxs-lookup"><span data-stu-id="5380b-136">**Figure 2**: Add the ASP.NET Pages for the Site Map Provider-Related Tutorials</span></span>

<span data-ttu-id="5380b-137">このセクションにはチュートリアルが1つしかないため、セクションのチュートリアルの一覧を表示する `Default.aspx` は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="5380b-137">Since there is only one tutorial for this section, we don t need `Default.aspx` to list the section s tutorials.</span></span> <span data-ttu-id="5380b-138">代わりに、`Default.aspx` によって GridView コントロールにカテゴリが表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-138">Instead, `Default.aspx` will display the categories in a GridView control.</span></span> <span data-ttu-id="5380b-139">これについては、手順 2. で説明します。</span><span class="sxs-lookup"><span data-stu-id="5380b-139">We'll tackle this in Step 2.</span></span>

<span data-ttu-id="5380b-140">次に、`Web.sitemap` を更新して、`Default.aspx` ページへの参照を含めます。</span><span class="sxs-lookup"><span data-stu-id="5380b-140">Next, update `Web.sitemap` to include a reference to the `Default.aspx` page.</span></span> <span data-ttu-id="5380b-141">具体的には、キャッシュ `<siteMapNode>`の後に、次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-141">Specifically, add the following markup after the Caching `<siteMapNode>`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample1.xml)]

<span data-ttu-id="5380b-142">`Web.sitemap`を更新した後、ブラウザーを使用してチュートリアル web サイトを表示します。</span><span class="sxs-lookup"><span data-stu-id="5380b-142">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="5380b-143">左側のメニューには、唯一のサイトマッププロバイダーのチュートリアルの項目が含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="5380b-143">The menu on the left now includes an item for the sole site map provider tutorial.</span></span>

![サイトマップに、サイトマッププロバイダーのチュートリアルのエントリが含まれるようになりました。](building-a-custom-database-driven-site-map-provider-cs/_static/image3.gif)

<span data-ttu-id="5380b-145">**図 3**: サイトマップにサイトマッププロバイダーのチュートリアルのエントリが含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="5380b-145">**Figure 3**: The Site Map Now Includes an Entry for the Site Map Provider Tutorial</span></span>

<span data-ttu-id="5380b-146">このチュートリアルの主な目的は、カスタムのサイトマッププロバイダーを作成し、そのプロバイダーを使用するように web アプリケーションを構成することです。</span><span class="sxs-lookup"><span data-stu-id="5380b-146">This tutorial s main focus is to illustrate creating a custom site map provider and configuring a web application to use that provider.</span></span> <span data-ttu-id="5380b-147">特に、図1に示すように、各カテゴリと製品のノードと共にルートノードを含むサイトマップを返すプロバイダーを作成します。</span><span class="sxs-lookup"><span data-stu-id="5380b-147">In particular, we'll build a provider that returns a site map that includes a root node along with a node for each category and product, as depicted in Figure 1.</span></span> <span data-ttu-id="5380b-148">一般に、サイトマップ内の各ノードは URL を指定できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-148">In general, each node in the site map may specify a URL.</span></span> <span data-ttu-id="5380b-149">サイトマップの場合、ルートノードの URL は `~/SiteMapProvider/Default.aspx`になります。これにより、データベース内のすべてのカテゴリが一覧表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-149">For our site map, the root node s URL will be `~/SiteMapProvider/Default.aspx`, which will list all of the categories in the database.</span></span> <span data-ttu-id="5380b-150">サイトマップ内の各カテゴリノードには、`~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`を指す URL があります。これにより、指定された*categoryID*内のすべての製品が一覧表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-150">Each category node in the site map will have a URL that points to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`, which will list all of the products in the specified *categoryID*.</span></span> <span data-ttu-id="5380b-151">最後に、各製品サイトマップノードが `~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`をポイントし、特定の製品の詳細が表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-151">Finally, each product site map node will point to `~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`, which will display the specific product s details.</span></span>

<span data-ttu-id="5380b-152">開始するには、`Default.aspx`、`ProductsByCategory.aspx`、および `ProductDetails.aspx` の各ページを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-152">To start we need to create the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="5380b-153">これらのページは、それぞれ手順2、3、および4で完了します。</span><span class="sxs-lookup"><span data-stu-id="5380b-153">These pages are completed in Steps 2, 3, and 4, respectively.</span></span> <span data-ttu-id="5380b-154">このチュートリアルの推力はサイトマッププロバイダーに関するものであり、過去のチュートリアルではこれらの種類の複数ページのマスター/詳細レポートの作成について説明しているため、手順 2. ~ 4. を実行します。</span><span class="sxs-lookup"><span data-stu-id="5380b-154">Since the thrust of this tutorial is on site map providers, and since past tutorials have covered creating these sorts of multi-page master/detail reports, we will hurry through Steps 2 through 4.</span></span> <span data-ttu-id="5380b-155">複数のページにまたがるマスター/詳細レポートの作成に関するリフレッシャーが必要な場合は、「 [2 ページのマスター/詳細のフィルター処理](../masterdetail/master-detail-filtering-across-two-pages-cs.md)」チュートリアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-155">If you need a refresher on creating master/detail reports that span multiple pages, refer back to the [Master/Detail Filtering Across Two Pages](../masterdetail/master-detail-filtering-across-two-pages-cs.md) tutorial.</span></span>

## <a name="step-2-displaying-a-list-of-categories"></a><span data-ttu-id="5380b-156">手順 2: カテゴリの一覧を表示する</span><span class="sxs-lookup"><span data-stu-id="5380b-156">Step 2: Displaying a List of Categories</span></span>

<span data-ttu-id="5380b-157">`SiteMapProvider` フォルダーの [`Default.aspx`] ページを開き、[ツールボックス] から GridView をデザイナーにドラッグし、`ID` を [`Categories`] に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-157">Open the `Default.aspx` page in the `SiteMapProvider` folder and drag a GridView from the Toolbox onto the Designer, setting its `ID` to `Categories`.</span></span> <span data-ttu-id="5380b-158">GridView s スマートタグから、`CategoriesDataSource` という名前の新しい ObjectDataSource にバインドし、`CategoriesBLL` クラス s `GetCategories` メソッドを使用してデータを取得するように構成します。</span><span class="sxs-lookup"><span data-stu-id="5380b-158">From the GridView s smart tag, bind it to a new ObjectDataSource named `CategoriesDataSource` and configure it so that it retrieves its data using the `CategoriesBLL` class s `GetCategories` method.</span></span> <span data-ttu-id="5380b-159">この GridView はカテゴリを表示するだけで、データ変更機能を提供しないため、[更新]、[挿入]、[削除] の各タブのドロップダウンリストを [(なし)] に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-159">Since this GridView just displays the categories and does not provide data modification capabilities, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>

<span data-ttu-id="5380b-160">[GetCategories メソッドを使用してカテゴリを返すように ObjectDataSource を構成 ![には](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-160">[![Configure the ObjectDataSource to Return Categories Using the GetCategories Method](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span></span>

<span data-ttu-id="5380b-161">**図 4**: `GetCategories` メソッドを使用してカテゴリを返すように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-161">**Figure 4**: Configure the ObjectDataSource to Return Categories Using the `GetCategories` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span></span>

<span data-ttu-id="5380b-162">[[更新]、[挿入]、[削除] の各タブのドロップダウンリストを [(なし)] に設定 ![ます。](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-162">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span></span>

<span data-ttu-id="5380b-163">**図 5**: [更新]、[挿入]、[削除] の各タブのドロップダウンリストを (なし) に設定する ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-163">**Figure 5**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span></span>

<span data-ttu-id="5380b-164">データソースの構成ウィザードを完了すると、Visual Studio によって `CategoryID`、`CategoryName`、`Description`、`NumberOfProducts`、および `BrochurePath`の BoundField が追加されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-164">After completing the Configure Data Source wizard, Visual Studio will add a BoundField for `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath`.</span></span> <span data-ttu-id="5380b-165">GridView を編集して、`CategoryName` および `Description` BoundFields のみが含まれるようにし、`CategoryName` BoundField s `HeaderText` プロパティを Category に更新します。</span><span class="sxs-lookup"><span data-stu-id="5380b-165">Edit the GridView so that it only contains the `CategoryName` and `Description` BoundFields and update the `CategoryName` BoundField s `HeaderText` property to Category .</span></span>

<span data-ttu-id="5380b-166">次に、ハイパーリンクフィールドを追加して、一番左のフィールドになるように配置します。</span><span class="sxs-lookup"><span data-stu-id="5380b-166">Next, add a HyperLinkField and position it so that it s the left-most field.</span></span> <span data-ttu-id="5380b-167">`DataNavigateUrlFields` プロパティを `CategoryID` に設定し、`DataNavigateUrlFormatString` プロパティを `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-167">Set the `DataNavigateUrlFields` property to `CategoryID` and the `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`.</span></span> <span data-ttu-id="5380b-168">製品を表示するには、`Text` プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-168">Set the `Text` property to View Products .</span></span>

![カテゴリ GridView にハイパーリンクフィールドを追加する](building-a-custom-database-driven-site-map-provider-cs/_static/image6.gif)

<span data-ttu-id="5380b-170">**図 6**: `Categories` GridView にハイパーリンクフィールドを追加する</span><span class="sxs-lookup"><span data-stu-id="5380b-170">**Figure 6**: Add a HyperLinkField to the `Categories` GridView</span></span>

<span data-ttu-id="5380b-171">ObjectDataSource を作成し、GridView のフィールドをカスタマイズした後、2つのコントロールの宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="5380b-171">After creating the ObjectDataSource and customizing the GridView s fields, the two controls declarative markup will look like the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample2.aspx)]

<span data-ttu-id="5380b-172">図7は、ブラウザーを使用して表示する場合の `Default.aspx` を示しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-172">Figure 7 shows `Default.aspx` when viewed through a browser.</span></span> <span data-ttu-id="5380b-173">Category s View Products リンクをクリックすると、手順3で作成する `ProductsByCategory.aspx?CategoryID=categoryID`に移動します。</span><span class="sxs-lookup"><span data-stu-id="5380b-173">Clicking a category s View Products link takes you to `ProductsByCategory.aspx?CategoryID=categoryID`, which we will build in Step 3.</span></span>

<span data-ttu-id="5380b-174">[各カテゴリが ![ビュー製品のリンクと共に一覧表示されます。](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-174">[![Each Category is Listed Along with a View Products Link](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span></span>

<span data-ttu-id="5380b-175">**図 7**: 各カテゴリは、[製品の表示] リンクと共に表示されます ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-175">**Figure 7**: Each Category is Listed Along with a View Products Link ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png))</span></span>

## <a name="step-3-listing-the-selected-category-s-products"></a><span data-ttu-id="5380b-176">手順 3: 選択したカテゴリの製品を一覧表示する</span><span class="sxs-lookup"><span data-stu-id="5380b-176">Step 3: Listing the Selected Category s Products</span></span>

<span data-ttu-id="5380b-177">[`ProductsByCategory.aspx`] ページを開き、GridView を追加して `ProductsByCategory`名前を付けます。</span><span class="sxs-lookup"><span data-stu-id="5380b-177">Open the `ProductsByCategory.aspx` page and add a GridView, naming it `ProductsByCategory`.</span></span> <span data-ttu-id="5380b-178">そのスマートタグから、GridView を `ProductsByCategoryDataSource`という名前の新しい ObjectDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="5380b-178">From its smart tag, bind the GridView to a new ObjectDataSource named `ProductsByCategoryDataSource`.</span></span> <span data-ttu-id="5380b-179">`ProductsBLL` クラス s `GetProductsByCategoryID(categoryID)` メソッドを使用するように ObjectDataSource を構成し、[更新]、[挿入]、[削除] の各タブで、ドロップダウンリストを [(なし)] に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-179">Configure the ObjectDataSource to use the `ProductsBLL` class s `GetProductsByCategoryID(categoryID)` method and set the drop-down lists to (None) in the UPDATE, INSERT, and DELETE tabs.</span></span>

<span data-ttu-id="5380b-180">[製品の Bll クラス s Get$ Bycategoryid (categoryID) メソッドを使用 ![](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-180">[![Use the ProductsBLL Class s GetProductsByCategoryID(categoryID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span></span>

<span data-ttu-id="5380b-181">**図 8**: `ProductsBLL` クラス s `GetProductsByCategoryID(categoryID)` メソッドを使用する ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-181">**Figure 8**: Use the `ProductsBLL` Class s `GetProductsByCategoryID(categoryID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span></span>

<span data-ttu-id="5380b-182">データソースの構成ウィザードの最後の手順では、 *categoryID*のパラメーターソースを入力するように求められます。</span><span class="sxs-lookup"><span data-stu-id="5380b-182">The final step in the Configure Data Source wizard prompts for a parameter source for *categoryID*.</span></span> <span data-ttu-id="5380b-183">この情報は、クエリ文字列フィールド `CategoryID`経由で渡されるため、図9に示すように、ドロップダウンリストから QueryString を選択し、QueryStringField テキストボックスに「CategoryID」と入力します。</span><span class="sxs-lookup"><span data-stu-id="5380b-183">Since this information is passed through the querystring field `CategoryID`, select QueryString from the drop-down list and enter CategoryID in the QueryStringField textbox as shown in Figure 9.</span></span> <span data-ttu-id="5380b-184">[完了] をクリックしてウィザードを終了します。</span><span class="sxs-lookup"><span data-stu-id="5380b-184">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="5380b-185">[categoryID パラメーターに CategoryID フィールドを使用 ![](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-185">[![Use the CategoryID Querystring Field for the categoryID Parameter](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span></span>

<span data-ttu-id="5380b-186">**図 9**: *categoryID*パラメーターに `CategoryID` Querystring フィールドを使用する ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-186">**Figure 9**: Use the `CategoryID` Querystring Field for the *categoryID* Parameter ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png))</span></span>

<span data-ttu-id="5380b-187">ウィザードを完了すると、Visual Studio によって、対応する BoundFields と CheckBoxField が製品データフィールドの GridView に追加されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-187">After completing the wizard, Visual Studio will add corresponding BoundFields and a CheckBoxField to the GridView for the product data fields.</span></span> <span data-ttu-id="5380b-188">`ProductName`、`UnitPrice`、および `SupplierName` BoundFields 以外はすべて削除します。</span><span class="sxs-lookup"><span data-stu-id="5380b-188">Remove all but the `ProductName`, `UnitPrice`, and `SupplierName` BoundFields.</span></span> <span data-ttu-id="5380b-189">これら3つの連結されたフィールド `HeaderText` プロパティをカスタマイズして、それぞれ製品、価格、および供給業者を読み取ります。</span><span class="sxs-lookup"><span data-stu-id="5380b-189">Customize these three BoundFields `HeaderText` properties to read Product, Price, and Supplier, respectively.</span></span> <span data-ttu-id="5380b-190">`UnitPrice` BoundField を通貨として書式設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-190">Format the `UnitPrice` BoundField as a currency.</span></span>

<span data-ttu-id="5380b-191">次に、ハイパーリンクフィールドを追加し、左端の位置に移動します。</span><span class="sxs-lookup"><span data-stu-id="5380b-191">Next, add a HyperLinkField and move it to the left-most position.</span></span> <span data-ttu-id="5380b-192">`Text` プロパティを [詳細を表示]、[`DataNavigateUrlFields`] プロパティを `ProductID`に、`DataNavigateUrlFormatString` プロパティを `~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-192">Set its `Text` property to View Details, its `DataNavigateUrlFields` property to `ProductID`, and its `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`.</span></span>

![ProductDetails を指す [ビューの詳細ハイパーリンク] フィールドを追加します。](building-a-custom-database-driven-site-map-provider-cs/_static/image10.gif)

<span data-ttu-id="5380b-194">**図 10**: `ProductDetails.aspx` を指し示すビューの詳細ハイパーリンクフィールドを追加する</span><span class="sxs-lookup"><span data-stu-id="5380b-194">**Figure 10**: Add a View Details HyperLinkField that Points to `ProductDetails.aspx`</span></span>

<span data-ttu-id="5380b-195">これらのカスタマイズを行った後、GridView および ObjectDataSource の宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="5380b-195">After making these customizations, the GridView and ObjectDataSource s declarative markup should resemble the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample3.aspx)]

<span data-ttu-id="5380b-196">ブラウザーを使用した `Default.aspx` の表示に戻り、飲み物の [Products] \ (製品の表示 \) リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="5380b-196">Return to viewing `Default.aspx` through a browser and click on the View Products link for Beverages.</span></span> <span data-ttu-id="5380b-197">これにより、飲料カテゴリに属する Northwind データベース内の製品の名前、価格、および仕入先が `ProductsByCategory.aspx?CategoryID=1`表示されます (図11を参照)。</span><span class="sxs-lookup"><span data-stu-id="5380b-197">This will take you to `ProductsByCategory.aspx?CategoryID=1`, displaying the names, prices, and suppliers of the products in the Northwind database that belong to the Beverages category (see Figure 11).</span></span> <span data-ttu-id="5380b-198">このページをさらに拡張して、カテゴリリストページ (`Default.aspx`) にユーザーを返すリンクや、選択したカテゴリの名前と説明を表示する DetailsView または FormView コントロールを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="5380b-198">Feel free to further enhance this page to include a link to return users to the category listing page (`Default.aspx`) and a DetailsView or FormView control that displays the selected category s name and description.</span></span>

<span data-ttu-id="5380b-199">[飲み物の名前、価格、および仕入先が表示され ![](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-199">[![The Beverages Names, Prices, and Suppliers are Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span></span>

<span data-ttu-id="5380b-200">**図 11**: 飲み物の名前、価格、および仕入先が表示される ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-200">**Figure 11**: The Beverages Names, Prices, and Suppliers are Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png))</span></span>

## <a name="step-4-showing-a-product-s-details"></a><span data-ttu-id="5380b-201">手順 4: 製品の詳細を表示する</span><span class="sxs-lookup"><span data-stu-id="5380b-201">Step 4: Showing a Product s Details</span></span>

<span data-ttu-id="5380b-202">最後のページ `ProductDetails.aspx`には、選択した製品の詳細が表示されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-202">The final page, `ProductDetails.aspx`, displays the selected products details.</span></span> <span data-ttu-id="5380b-203">`ProductDetails.aspx` を開き、[ツールボックス] から [DetailsView] をデザイナーにドラッグします。</span><span class="sxs-lookup"><span data-stu-id="5380b-203">Open `ProductDetails.aspx` and drag a DetailsView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="5380b-204">[DetailsView s `ID`] プロパティを `ProductInfo` に設定し、`Height` と `Width` プロパティの値をクリアします。</span><span class="sxs-lookup"><span data-stu-id="5380b-204">Set the DetailsView s `ID` property to `ProductInfo` and clear out its `Height` and `Width` property values.</span></span> <span data-ttu-id="5380b-205">スマートタグから、DetailsView を `ProductDataSource`という名前の新しい ObjectDataSource にバインドし、ObjectDataSource を構成して `ProductsBLL` クラス s `GetProductByProductID(productID)` メソッドからデータをプルします。</span><span class="sxs-lookup"><span data-stu-id="5380b-205">From its smart tag, bind the DetailsView to a new ObjectDataSource named `ProductDataSource`, configuring the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProductByProductID(productID)` method.</span></span> <span data-ttu-id="5380b-206">手順 2. と 3. で作成した前の web ページと同様に、[更新]、[挿入]、および [削除] の各タブのドロップダウンリストを [(なし)] に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-206">As with the previous web pages created in Steps 2 and 3, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>

<span data-ttu-id="5380b-207">[GetProductByProductID (productID) メソッドを使用するように ObjectDataSource を構成 ![には](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-207">[![Configure the ObjectDataSource to Use the GetProductByProductID(productID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span></span>

<span data-ttu-id="5380b-208">**図 12**: `GetProductByProductID(productID)` メソッドを使用するように ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-208">**Figure 12**: Configure the ObjectDataSource to Use the `GetProductByProductID(productID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span></span>

<span data-ttu-id="5380b-209">データソースの構成ウィザードの最後の手順では、 *productID*パラメーターのソースが要求されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-209">The last step of the Configure Data Source wizard prompts for the source of the *productID* parameter.</span></span> <span data-ttu-id="5380b-210">このデータにはクエリ文字列フィールド `ProductID`が含まれているため、ドロップダウンリストを QueryString に設定し、QueryStringField テキストボックスを ProductID に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-210">Since this data comes through the querystring field `ProductID`, set the drop-down list to QueryString and the QueryStringField textbox to ProductID.</span></span> <span data-ttu-id="5380b-211">最後に、[完了] をクリックしてウィザードを完了します。</span><span class="sxs-lookup"><span data-stu-id="5380b-211">Finally, click the Finish button to complete the wizard.</span></span>

<span data-ttu-id="5380b-212">[productid パラメーターを構成して、ProductID パラメーターフィールドから値を取得 ![](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-212">[![Configure the productID Parameter to Pull its Value from the ProductID Querystring Field](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span></span>

<span data-ttu-id="5380b-213">**図 13**: *productID*パラメーターを `ProductID` Querystring フィールドから値をプルするように構成する ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-213">**Figure 13**: Configure the *productID* Parameter to Pull its Value from the `ProductID` Querystring Field ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span></span>

<span data-ttu-id="5380b-214">データソースの構成ウィザードを完了すると、Visual Studio によって、対応する BoundFields と CheckBoxField が製品データフィールドの DetailsView に作成されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-214">After completing the Configure Data Source wizard, Visual Studio will create corresponding BoundFields and a CheckBoxField in the DetailsView for the product data fields.</span></span> <span data-ttu-id="5380b-215">`ProductID`、`SupplierID`、および `CategoryID` BoundFields を削除し、必要に応じて残りのフィールドを構成します。</span><span class="sxs-lookup"><span data-stu-id="5380b-215">Remove the `ProductID`, `SupplierID`, and `CategoryID` BoundFields and configure the remaining fields as you see fit.</span></span> <span data-ttu-id="5380b-216">いくつかの美しい構成を行った後、その DetailsView および ObjectDataSource s 宣言マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="5380b-216">After a handful of aesthetic configurations, my DetailsView and ObjectDataSource s declarative markup looked like the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample4.aspx)]

<span data-ttu-id="5380b-217">このページをテストするには、`Default.aspx` に戻り、[飲料] カテゴリの [製品の表示] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5380b-217">To test this page, return to `Default.aspx` and click on View Products for the Beverages category.</span></span> <span data-ttu-id="5380b-218">飲み物製品の一覧から、Chai 紅茶の [Details] \ (詳細の表示 \) リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="5380b-218">From the listing of beverage products, click on the View Details link for Chai Tea.</span></span> <span data-ttu-id="5380b-219">これにより、`ProductDetails.aspx?ProductID=1`に移動します。これには、Chai 茶の詳細が表示されます (図14を参照)。</span><span class="sxs-lookup"><span data-stu-id="5380b-219">This will take you to `ProductDetails.aspx?ProductID=1`, which shows a Chai Tea s details (see Figure 14).</span></span>

<span data-ttu-id="5380b-220">[![Chai 茶 s 仕入先、カテゴリ、価格などの情報が表示されます](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-220">[![Chai Tea s Supplier, Category, Price, and Other Information is Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span></span>

<span data-ttu-id="5380b-221">**図 14**: Chai ティー s の仕入先、カテゴリ、価格、およびその他の情報が表示されます ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-221">**Figure 14**: Chai Tea s Supplier, Category, Price, and Other Information is Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png))</span></span>

## <a name="step-5-understanding-the-inner-workings-of-a-site-map-provider"></a><span data-ttu-id="5380b-222">手順 5: サイトマッププロバイダーの内部動作を理解する</span><span class="sxs-lookup"><span data-stu-id="5380b-222">Step 5: Understanding the Inner Workings of a Site Map Provider</span></span>

<span data-ttu-id="5380b-223">サイトマップは、web サーバーのメモリ内で、階層を形成する `SiteMapNode` インスタンスのコレクションとして表されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-223">The site map is represented in the web server s memory as a collection of `SiteMapNode` instances that form a hierarchy.</span></span> <span data-ttu-id="5380b-224">ルートは1つだけである必要があります。ルート以外のすべてのノードには1つの親ノードが必要であり、すべてのノードが任意の数の子を持つことができます。</span><span class="sxs-lookup"><span data-stu-id="5380b-224">There must be exactly one root, all non-root nodes must have exactly one parent node, and all nodes may have an arbitrary number of children.</span></span> <span data-ttu-id="5380b-225">各 `SiteMapNode` オブジェクトは、web サイトの構造内のセクションを表します。これらのセクションには、通常、対応する web ページがあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-225">Each `SiteMapNode` object represents a section in the website s structure; these sections commonly have a corresponding web page.</span></span> <span data-ttu-id="5380b-226">その結果、 [`SiteMapNode` クラス](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx)には `Title`、`Url`、および `Description`のようなプロパティがあり、`SiteMapNode` が表すセクションの情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="5380b-226">Consequently, the [`SiteMapNode` class](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx) has properties like `Title`, `Url`, and `Description`, which provide information for the section the `SiteMapNode` represents.</span></span> <span data-ttu-id="5380b-227">また、階層内の各 `SiteMapNode` を一意に識別する `Key` プロパティと、この階層 `ChildNodes`、`ParentNode`、`NextSibling`、`PreviousSibling`などを確立するために使用されるプロパティもあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-227">There is also a `Key` property that uniquely identifies each `SiteMapNode` in the hierarchy, as well as properties used to establish this hierarchy `ChildNodes`, `ParentNode`, `NextSibling`, `PreviousSibling`, and so forth.</span></span>

<span data-ttu-id="5380b-228">図15は、図1の一般的なサイトマップ構造を示していますが、実装の詳細については詳細に説明しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-228">Figure 15 shows the general site map structure from Figure 1, but with the implementation details sketched out in finer detail.</span></span>

<span data-ttu-id="5380b-229">[各 SiteMapNode には、Title、Url、Key などのプロパティがあります。 ![](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span><span class="sxs-lookup"><span data-stu-id="5380b-229">[![Each SiteMapNode has Properties Like Title, Url, Key, and So On](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span></span>

<span data-ttu-id="5380b-230">**図 15**: 各 `SiteMapNode` には `Title`、`Url`、`Key`などのプロパティがあります ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif)されます)。</span><span class="sxs-lookup"><span data-stu-id="5380b-230">**Figure 15**: Each `SiteMapNode` has Properties Like `Title`, `Url`, `Key`, and So On ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif))</span></span>

<span data-ttu-id="5380b-231">サイトマップには、 [`System.Web` 名前空間](https://msdn.microsoft.com/library/system.web.aspx)の[`SiteMap` クラス](https://msdn.microsoft.com/library/system.web.sitemap.aspx)を使用してアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="5380b-231">The site map is accessible through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx).</span></span> <span data-ttu-id="5380b-232">このクラスの `RootNode` プロパティは、サイトマップのルート `SiteMapNode` インスタンスを返します。`CurrentNode` は、現在要求されているページの URL と一致する `Url` プロパティを持つ `SiteMapNode` を返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-232">This class s `RootNode` property returns the site map s root `SiteMapNode` instance; `CurrentNode` returns the `SiteMapNode` whose `Url` property matches the URL of the currently requested page.</span></span> <span data-ttu-id="5380b-233">このクラスは、ASP.NET 2.0 s ナビゲーション Web コントロールによって内部的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-233">This class is used internally by ASP.NET 2.0 s navigation Web controls.</span></span>

<span data-ttu-id="5380b-234">`SiteMap` クラスのプロパティにアクセスするときは、サイトマップ構造を永続メディアからメモリにシリアル化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-234">When the `SiteMap` class s properties are accessed, it must serialize the site map structure from some persistent medium into memory.</span></span> <span data-ttu-id="5380b-235">ただし、サイトマップのシリアル化ロジックは `SiteMap` クラスにハードコーディングされません。</span><span class="sxs-lookup"><span data-stu-id="5380b-235">However, the site map serialization logic is not hard coded into the `SiteMap` class.</span></span> <span data-ttu-id="5380b-236">代わりに、実行時に、`SiteMap` クラスによって、シリアル化に使用するサイトマップ*プロバイダー*が決定されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-236">Instead, at runtime the `SiteMap` class determines which site map *provider* to use for serialization.</span></span> <span data-ttu-id="5380b-237">既定では、 [`XmlSiteMapProvider` クラス](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx)が使用されます。これにより、適切に書式設定された XML ファイルからサイトマップの構造が読み取られます。</span><span class="sxs-lookup"><span data-stu-id="5380b-237">By default, the [`XmlSiteMapProvider` class](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx) is used, which reads the site map s structure from a properly-formatted XML file.</span></span> <span data-ttu-id="5380b-238">ただし、少しの作業で、独自のカスタムサイトマッププロバイダーを作成できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-238">However, with a little bit of work we can create our own custom site map provider.</span></span>

<span data-ttu-id="5380b-239">すべてのサイトマッププロバイダーは、 [`SiteMapProvider` クラス](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx)から派生する必要があります。このクラスには、サイトマッププロバイダーに必要な必須のメソッドとプロパティが含まれていますが、実装の詳細の多くは省略されています。</span><span class="sxs-lookup"><span data-stu-id="5380b-239">All site map providers must be derived from the [`SiteMapProvider` class](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx), which includes the essential methods and properties needed for site map providers, but omits many of the implementation details.</span></span> <span data-ttu-id="5380b-240">2つ目のクラス[`StaticSiteMapProvider`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx)は、`SiteMapProvider` クラスを拡張し、必要な機能をより堅牢に実装しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-240">A second class, [`StaticSiteMapProvider`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx), extends the `SiteMapProvider` class and contains a more robust implementation of the needed functionality.</span></span> <span data-ttu-id="5380b-241">内部的には、`StaticSiteMapProvider` はサイトマップの `SiteMapNode` インスタンスを `Hashtable` に格納し、`RemoveNode(siteMapNode),` を内部 `Clear()` に追加および削除する `AddNode(child, parent)`、`SiteMapNode`、`Hashtable`などのメソッドを提供します。</span><span class="sxs-lookup"><span data-stu-id="5380b-241">Internally, the `StaticSiteMapProvider` stores the `SiteMapNode` instances of the site map in a `Hashtable` and provides methods like `AddNode(child, parent)`, `RemoveNode(siteMapNode),` and `Clear()` that add and remove `SiteMapNode` s to the internal `Hashtable`.</span></span> <span data-ttu-id="5380b-242">`XmlSiteMapProvider` は、`StaticSiteMapProvider` から派生しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-242">`XmlSiteMapProvider` is derived from `StaticSiteMapProvider`.</span></span>

<span data-ttu-id="5380b-243">`StaticSiteMapProvider`を拡張するカスタムのサイトマッププロバイダーを作成する場合は、 [`BuildSiteMap`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx)と[`GetRootNodeCore`](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx)の2つの抽象メソッドをオーバーライドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-243">When creating a custom site map provider that extends `StaticSiteMapProvider`, there are two abstract methods that must be overridden: [`BuildSiteMap`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx) and [`GetRootNodeCore`](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx).</span></span> <span data-ttu-id="5380b-244">`BuildSiteMap`は、その名前が示すとおり、は、永続ストレージからサイトマップ構造を読み込み、メモリに構築する役割を担います。</span><span class="sxs-lookup"><span data-stu-id="5380b-244">`BuildSiteMap`, as its name implies, is responsible for loading the site map structure from persistent storage and constructing it in memory.</span></span> <span data-ttu-id="5380b-245">`GetRootNodeCore` は、サイトマップ内のルートノードを返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-245">`GetRootNodeCore` returns the root node in the site map.</span></span>

<span data-ttu-id="5380b-246">Web アプリケーションでサイトマッププロバイダーを使用する前に、アプリケーションの構成に登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-246">Before a web application can use a site map provider it must be registered in the application s configuration.</span></span> <span data-ttu-id="5380b-247">既定では、`XmlSiteMapProvider` クラスは `AspNetXmlSiteMapProvider`名前を使用して登録されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-247">By default, the `XmlSiteMapProvider` class is registered using the name `AspNetXmlSiteMapProvider`.</span></span> <span data-ttu-id="5380b-248">追加のサイトマッププロバイダーを登録するには、`Web.config`に次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-248">To register additional site map providers, add the following markup to `Web.config`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample5.xml)]

<span data-ttu-id="5380b-249">*名前*の値は、ユーザーが判読できる名前をプロバイダーに割り当てますが、*型*はサイトマッププロバイダーの完全修飾型名を指定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-249">The *name* value assigns a human-readable name to the provider while *type* specifies the fully-qualified type name of the site map provider.</span></span> <span data-ttu-id="5380b-250">ここでは、カスタムのサイトマッププロバイダーを作成した後、手順 7. で*名前*と*型*の値の具体的な値について説明します。</span><span class="sxs-lookup"><span data-stu-id="5380b-250">We'll explore concrete values for the *name* and *type* values in Step 7, after we ve created our custom site map provider.</span></span>

<span data-ttu-id="5380b-251">サイトマッププロバイダークラスは、`SiteMap` クラスから初めてアクセスしたときにインスタンス化され、web アプリケーションの有効期間中はメモリに残ります。</span><span class="sxs-lookup"><span data-stu-id="5380b-251">The site map provider class is instantiated the first time it is accessed from the `SiteMap` class and remains in memory for the lifetime of the web application.</span></span> <span data-ttu-id="5380b-252">サイトマッププロバイダーのインスタンスは、同時に複数の web サイトの訪問者から呼び出される可能性があるため、プロバイダーのメソッドが*スレッドセーフ*であることが不可欠です。</span><span class="sxs-lookup"><span data-stu-id="5380b-252">Since there is only one instance of the site map provider that may be invoked from multiple, concurrent web site visitors, it is imperative that the provider s methods be *thread-safe*.</span></span>

<span data-ttu-id="5380b-253">パフォーマンスとスケーラビリティ上の理由から、`BuildSiteMap` メソッドが呼び出されるたびに再作成するのではなく、メモリ内のサイトマップ構造をキャッシュし、このキャッシュされた構造体を返すことが重要です。</span><span class="sxs-lookup"><span data-stu-id="5380b-253">For performance and scalability reasons, it s important that we cache the in-memory site map structure and return this cached structure rather than recreating it every time the `BuildSiteMap` method is invoked.</span></span> <span data-ttu-id="5380b-254">ページで使用されているナビゲーションコントロールとサイトマップ構造の深さによっては、`BuildSiteMap` が1ページあたりの要求ごとに複数回呼び出されることがあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-254">`BuildSiteMap` may be called several times per page request per user, depending on the navigation controls in use on the page and the depth of the site map structure.</span></span> <span data-ttu-id="5380b-255">どのような場合でも、サイトマップ構造を `BuildSiteMap` にキャッシュしない場合は、起動するたびに、アーキテクチャから製品とカテゴリの情報を再取得する必要があります (これにより、データベースに対するクエリが実行されます)。</span><span class="sxs-lookup"><span data-stu-id="5380b-255">In any case, if we do not cache the site map structure in `BuildSiteMap` then each time it is invoked we would need to re-retrieve the product and category information from the architecture (which would result in a query to the database).</span></span> <span data-ttu-id="5380b-256">前のキャッシュのチュートリアルで説明したように、キャッシュされたデータは古くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-256">As we discussed in the previous caching tutorials, cached data can become stale.</span></span> <span data-ttu-id="5380b-257">これに対処するには、時間または SQL キャッシュの依存関係ベースの expiries を使用できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-257">To combat this, we can use either time- or SQL cache dependency-based expiries.</span></span>

> [!NOTE]
> <span data-ttu-id="5380b-258">サイトマッププロバイダーは、必要に応じて[`Initialize` メソッド](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx)をオーバーライドできます。</span><span class="sxs-lookup"><span data-stu-id="5380b-258">A site map provider may optionally override the [`Initialize` method](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx).</span></span> <span data-ttu-id="5380b-259">`Initialize` は、サイトマッププロバイダーが最初にインスタンス化され、次のように `<add>` 要素の `Web.config` でプロバイダーに割り当てられたカスタム属性が渡されたときに呼び出されます。 `<add name="name" type="type" customAttribute="value" />`です。</span><span class="sxs-lookup"><span data-stu-id="5380b-259">`Initialize` is invoked when the site map provider is first instantiated and is passed any custom attributes assigned to the provider in `Web.config` in the `<add>` element like: `<add name="name" type="type" customAttribute="value" />`.</span></span> <span data-ttu-id="5380b-260">これは、ページ開発者がプロバイダーのコードを変更しなくても、さまざまなサイトマッププロバイダーに関連する設定を指定できるようにする場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="5380b-260">It is useful if you want to allow a page developer to specify various site map provider-related settings without having to modify the provider s code.</span></span> <span data-ttu-id="5380b-261">たとえば、アーキテクチャではなくデータベースからカテゴリと製品データを直接読み取る場合、プロバイダーのコードでハードコーディングされた値を使用するのではなく、`Web.config` でデータベース接続文字列を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="5380b-261">For example, if we were reading the category and products data directly from the database as opposed to through the architecture, we d likely want to let the page developer specify the database connection string through `Web.config` rather than using a hard coded value in the provider s code.</span></span> <span data-ttu-id="5380b-262">手順6でビルドするカスタムサイトマッププロバイダーは、この `Initialize` メソッドをオーバーライドしません。</span><span class="sxs-lookup"><span data-stu-id="5380b-262">The custom site map provider we'll build in Step 6 does not override this `Initialize` method.</span></span> <span data-ttu-id="5380b-263">`Initialize` メソッドの使用例については、SQL Server の記事に記載されている[Jeff Prosise](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) [のサイトマップの格納](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-263">For an example of using the `Initialize` method, refer to [Jeff Prosise](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) article.</span></span>

## <a name="step-6-creating-the-custom-site-map-provider"></a><span data-ttu-id="5380b-264">手順 6: カスタムサイトマッププロバイダーを作成する</span><span class="sxs-lookup"><span data-stu-id="5380b-264">Step 6: Creating the Custom Site Map Provider</span></span>

<span data-ttu-id="5380b-265">Northwind データベースのカテゴリと製品からサイトマップを構築するカスタムサイトマッププロバイダーを作成するには、`StaticSiteMapProvider`を拡張するクラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-265">To create a custom site map provider that builds the site map from the categories and products in the Northwind database, we need to create a class that extends `StaticSiteMapProvider`.</span></span> <span data-ttu-id="5380b-266">手順 1. では、`App_Code` フォルダーに `CustomProviders` フォルダーを追加するように求められました。 `NorthwindSiteMapProvider`という名前の新しいクラスをこのフォルダーに追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-266">In Step 1 I asked you to add a `CustomProviders` folder in the `App_Code` folder - add a new class to this folder named `NorthwindSiteMapProvider`.</span></span> <span data-ttu-id="5380b-267">以下のコードを `NorthwindSiteMapProvider` クラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-267">Add the following code to the `NorthwindSiteMapProvider` class:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample6.cs)]

<span data-ttu-id="5380b-268">まず、このクラス `BuildSiteMap` メソッドを調べてみましょう。このメソッドは、 [`lock` ステートメント](https://msdn.microsoft.com/library/c5kehkcz.aspx)から始まります。</span><span class="sxs-lookup"><span data-stu-id="5380b-268">Let s start with exploring this class s `BuildSiteMap` method, which starts with a [`lock` statement](https://msdn.microsoft.com/library/c5kehkcz.aspx).</span></span> <span data-ttu-id="5380b-269">`lock` ステートメントでは、一度に1つのスレッドだけを入力できます。これにより、そのコードへのアクセスがシリアル化され、2つの同時実行スレッドが1つの生まれたをステップ実行できなくなります。</span><span class="sxs-lookup"><span data-stu-id="5380b-269">The `lock` statement only allows one thread at a time to enter, thereby serializing access to its code and preventing two concurrent threads from stepping on one another s toes.</span></span>

<span data-ttu-id="5380b-270">クラスレベル `SiteMapNode` 変数 `root` は、サイトマップ構造をキャッシュするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-270">The class-level `SiteMapNode` variable `root` is used to cache the site map structure.</span></span> <span data-ttu-id="5380b-271">サイトマップを初めて作成する場合、または基になるデータが変更された後に初めて構成する場合は、`root` が `null` され、サイトマップ構造が構築されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-271">When the site map is constructed for the first time, or for the first time after the underlying data has been modified, `root` will be `null` and the site map structure will be constructed.</span></span> <span data-ttu-id="5380b-272">このメソッドが次回呼び出されるときに、`root` が `null`されないように、構築プロセス中に、サイトマップのルートノードが `root` に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="5380b-272">The site map s root node is assigned to `root` during the construction process so that the next time this method is called, `root` will not be `null`.</span></span> <span data-ttu-id="5380b-273">そのため、`root` が `null` ない限り、サイトマップ構造は、再作成することなく、呼び出し元に返されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-273">Consequently, so long as `root` is not `null` the site map structure will be returned to the caller without having to recreate it.</span></span>

<span data-ttu-id="5380b-274">ルートが `null`場合は、製品とカテゴリの情報からサイトマップ構造が作成されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-274">If root is `null`, the site map structure is created from the product and category information.</span></span> <span data-ttu-id="5380b-275">サイトマップを作成するには、`SiteMapNode` インスタンスを作成し、`StaticSiteMapProvider` クラス s `AddNode` メソッドの呼び出しを使用して階層を形成します。</span><span class="sxs-lookup"><span data-stu-id="5380b-275">The site map is built by creating the `SiteMapNode` instances and then forming the hierarchy through calls to the `StaticSiteMapProvider` class s `AddNode` method.</span></span> <span data-ttu-id="5380b-276">`AddNode` によって内部のブックキーピングが実行され、`Hashtable`に複数の `SiteMapNode` インスタンスが格納されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-276">`AddNode` performs the internal bookkeeping, storing the assorted `SiteMapNode` instances in a `Hashtable`.</span></span> <span data-ttu-id="5380b-277">階層の構築を始める前に、まず、`Clear` メソッドを呼び出します。これにより、内部 `Hashtable`から要素が消去されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-277">Before we start constructing the hierarchy, we start by calling the `Clear` method, which clears out the elements from the internal `Hashtable`.</span></span> <span data-ttu-id="5380b-278">次に、`ProductsBLL` クラス s `GetProducts` メソッドと、結果として得られる `ProductsDataTable` がローカル変数に格納されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-278">Next, the `ProductsBLL` class s `GetProducts` method and the resulting `ProductsDataTable` are stored in local variables.</span></span>

<span data-ttu-id="5380b-279">サイトマップの構築は、ルートノードを作成し、それを `root`に割り当てることから始まります。</span><span class="sxs-lookup"><span data-stu-id="5380b-279">The site map s construction begins by creating the root node and assigning it to `root`.</span></span> <span data-ttu-id="5380b-280">ここで使用する[`SiteMapNode` s コンストラクター](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx)とこの `BuildSiteMap` 全体のオーバーロードには、次の情報が渡されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-280">The overload of the [`SiteMapNode` s constructor](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx) used here and throughout this `BuildSiteMap` is passed the following information:</span></span>

- <span data-ttu-id="5380b-281">サイトマッププロバイダー (`this`) への参照。</span><span class="sxs-lookup"><span data-stu-id="5380b-281">A reference to the site map provider (`this`).</span></span>
- <span data-ttu-id="5380b-282">`SiteMapNode` s `Key`。</span><span class="sxs-lookup"><span data-stu-id="5380b-282">The `SiteMapNode` s `Key`.</span></span> <span data-ttu-id="5380b-283">この必須値は、`SiteMapNode`ごとに一意である必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-283">This required value must be unique for each `SiteMapNode`.</span></span>
- <span data-ttu-id="5380b-284">`SiteMapNode` s `Url`。</span><span class="sxs-lookup"><span data-stu-id="5380b-284">The `SiteMapNode` s `Url`.</span></span> <span data-ttu-id="5380b-285">`Url` は省略可能ですが、指定する場合、`SiteMapNode` s `Url` 値はそれぞれ一意である必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-285">`Url` is optional, but if provided, each `SiteMapNode` s `Url` value must be unique.</span></span>
- <span data-ttu-id="5380b-286">`SiteMapNode` s `Title`。これは必須です。</span><span class="sxs-lookup"><span data-stu-id="5380b-286">The `SiteMapNode` s `Title`, which is required.</span></span>

<span data-ttu-id="5380b-287">`AddNode(root)` メソッド呼び出しは、ルートとしてサイトマップに `SiteMapNode` `root` を追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-287">The `AddNode(root)` method call adds the `SiteMapNode` `root` to the site map as the root.</span></span> <span data-ttu-id="5380b-288">次に、`ProductsDataTable` 内の各 `ProductRow` が列挙されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-288">Next, each `ProductRow` in the `ProductsDataTable` is enumerated.</span></span> <span data-ttu-id="5380b-289">現在の product s カテゴリの `SiteMapNode` が既に存在する場合は、そのカテゴリが参照されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-289">If there already exists a `SiteMapNode` for the current product s category, it is referenced.</span></span> <span data-ttu-id="5380b-290">それ以外の場合は、`AddNode(categoryNode, root)` メソッド呼び出しによって、カテゴリの新しい `SiteMapNode` が作成され、`SiteMapNode``root` の子として追加されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-290">Otherwise, a new `SiteMapNode` for the category is created and added as a child of the `SiteMapNode``root` through the `AddNode(categoryNode, root)` method call.</span></span> <span data-ttu-id="5380b-291">適切なカテゴリ `SiteMapNode` ノードが見つかったか作成されると、現在の製品に対して `SiteMapNode` が作成され、`AddNode(productNode, categoryNode)`経由で `SiteMapNode` カテゴリの子として追加されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-291">After the appropriate category `SiteMapNode` node has been found or created, a `SiteMapNode` is created for the current product and added as a child of the category `SiteMapNode` via `AddNode(productNode, categoryNode)`.</span></span> <span data-ttu-id="5380b-292">Product `SiteMapNode` s `Url` プロパティに `~/SiteMapNode/ProductDetails.aspx?ProductID=productID`が割り当てられている間、category `SiteMapNode` `Url` プロパティ値は `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID` ます。</span><span class="sxs-lookup"><span data-stu-id="5380b-292">Note that the category `SiteMapNode` s `Url` property value is `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID` while the product `SiteMapNode` s `Url` property is assigned `~/SiteMapNode/ProductDetails.aspx?ProductID=productID`.</span></span>

> [!NOTE]
> <span data-ttu-id="5380b-293">`CategoryID` に対してデータベース `NULL` 値を持つ製品は、`Title` プロパティが None に設定され、`Url` プロパティが空の文字列に設定されているカテゴリ `SiteMapNode` の下にグループ化されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-293">Those products that have a database `NULL` value for their `CategoryID` are grouped under a category `SiteMapNode` whose `Title` property is set to None and whose `Url` property is set to an empty string.</span></span> <span data-ttu-id="5380b-294">`Url` を空の文字列に設定することにしました。これは、`ProductBLL` クラス s `GetProductsByCategory(categoryID)` メソッドには、現在 `NULL` `CategoryID` 値を持つ製品だけを返す機能がないためです。</span><span class="sxs-lookup"><span data-stu-id="5380b-294">I decided to set `Url` to an empty string since the `ProductBLL` class s `GetProductsByCategory(categoryID)` method currently lacks the capability to return just those products with a `NULL` `CategoryID` value.</span></span> <span data-ttu-id="5380b-295">また、ナビゲーションコントロールが、`Url` プロパティの値が不足している `SiteMapNode` をどのように表示するかを説明します。</span><span class="sxs-lookup"><span data-stu-id="5380b-295">Also, I wanted to demonstrate how the navigation controls render a `SiteMapNode` that lacks a value for its `Url` property.</span></span> <span data-ttu-id="5380b-296">このチュートリアルを拡張して、None `SiteMapNode` s `Url` プロパティが `ProductsByCategory.aspx`を指すようにすることをお勧めしますが、`NULL` `CategoryID` 値を持つ製品のみが表示されるようにしています。</span><span class="sxs-lookup"><span data-stu-id="5380b-296">I encourage you to extend this tutorial so that the None `SiteMapNode` s `Url` property points to `ProductsByCategory.aspx`, yet only displays the products with `NULL` `CategoryID` values.</span></span>

<span data-ttu-id="5380b-297">サイトマップを構築した後、任意のオブジェクトが、`AggregateCacheDependency` オブジェクトを介して `Categories` テーブルと `Products` テーブルに対する SQL キャッシュの依存関係を使用して、データキャッシュに追加されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-297">After constructing the site map, an arbitrary object is added to the data cache using a SQL cache dependency on the `Categories` and `Products` tables through an `AggregateCacheDependency` object.</span></span> <span data-ttu-id="5380b-298">*Sql キャッシュ*の依存関係を使用して、前のチュートリアルで sql キャッシュの依存関係を使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="5380b-298">We explored using SQL cache dependencies in the preceding tutorial, *Using SQL Cache Dependencies*.</span></span> <span data-ttu-id="5380b-299">ただし、カスタムのサイトマッププロバイダーでは、データキャッシュ s `Insert` メソッドのオーバーロードを使用します。</span><span class="sxs-lookup"><span data-stu-id="5380b-299">The custom site map provider, however, uses an overload of the data cache s `Insert` method that we ve yet to explore.</span></span> <span data-ttu-id="5380b-300">このオーバーロードは、最後の入力パラメーターとしてを受け入れます。このデリゲートは、オブジェクトがキャッシュから削除されたときに呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-300">This overload accepts as its final input parameter a delegate that is called when the object is removed from the cache.</span></span> <span data-ttu-id="5380b-301">具体的には、`NorthwindSiteMapProvider` クラスで定義されている `OnSiteMapChanged` メソッドを指す新しい[`CacheItemRemovedCallback` デリゲート](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx)を渡します。</span><span class="sxs-lookup"><span data-stu-id="5380b-301">Specifically, we pass in a new [`CacheItemRemovedCallback` delegate](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx) that points to the `OnSiteMapChanged` method defined further down in the `NorthwindSiteMapProvider` class.</span></span>

> [!NOTE]
> <span data-ttu-id="5380b-302">サイトマップのメモリ内表現は、クラスレベルの変数 `root`によってキャッシュされます。</span><span class="sxs-lookup"><span data-stu-id="5380b-302">The in-memory representation of the site map is cached through the class-level variable `root`.</span></span> <span data-ttu-id="5380b-303">カスタムサイトマッププロバイダークラスのインスタンスは1つだけであり、そのインスタンスは web アプリケーションのすべてのスレッド間で共有されるため、このクラス変数はキャッシュとして機能します。</span><span class="sxs-lookup"><span data-stu-id="5380b-303">Since there is only one instance of the custom site map provider class and since that instance is shared among all threads in the web application, this class variable serves as a cache.</span></span> <span data-ttu-id="5380b-304">`BuildSiteMap` メソッドはデータキャッシュも使用しますが、`Categories` または `Products` テーブル内の基になるデータベースデータが変更されたときに通知を受信する手段としてのみ使用します。</span><span class="sxs-lookup"><span data-stu-id="5380b-304">The `BuildSiteMap` method also uses the data cache, but only as a means to receive notification when the underlying database data in the `Categories` or `Products` tables changes.</span></span> <span data-ttu-id="5380b-305">データキャッシュに格納される値は、現在の日付と時刻のみであることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-305">Note that the value put into the data cache is just the current date and time.</span></span> <span data-ttu-id="5380b-306">実際のサイトマップデータはデータキャッシュに格納され*ません*。</span><span class="sxs-lookup"><span data-stu-id="5380b-306">The actual site map data is *not* put in the data cache.</span></span>

<span data-ttu-id="5380b-307">`BuildSiteMap` メソッドは、サイトマップのルートノードを返すことによって完了します。</span><span class="sxs-lookup"><span data-stu-id="5380b-307">The `BuildSiteMap` method completes by returning the root node of the site map.</span></span>

<span data-ttu-id="5380b-308">残りのメソッドは非常に簡単です。</span><span class="sxs-lookup"><span data-stu-id="5380b-308">The remaining methods are fairly straightforward.</span></span> <span data-ttu-id="5380b-309">`GetRootNodeCore` は、ルートノードを返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-309">`GetRootNodeCore` is responsible for returning the root node.</span></span> <span data-ttu-id="5380b-310">`BuildSiteMap` はルートを返すため、`GetRootNodeCore` は単に `BuildSiteMap` s 戻り値を返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-310">Since `BuildSiteMap` returns the root, `GetRootNodeCore` simply returns `BuildSiteMap` s return value.</span></span> <span data-ttu-id="5380b-311">`OnSiteMapChanged` メソッドは、キャッシュ項目が削除されたときに `root` を `null` に戻します。</span><span class="sxs-lookup"><span data-stu-id="5380b-311">The `OnSiteMapChanged` method sets `root` back to `null` when the cache item is removed.</span></span> <span data-ttu-id="5380b-312">ルートを `null`に設定し直すと、次に `BuildSiteMap` が呼び出されたときに、サイトマップ構造が再構築されます。</span><span class="sxs-lookup"><span data-stu-id="5380b-312">With root set back to `null`, the next time `BuildSiteMap` is invoked, the site map structure will be rebuilt.</span></span> <span data-ttu-id="5380b-313">最後に、このような値が存在する場合、`CachedDate` プロパティは、データキャッシュに格納されている日付と時刻の値を返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-313">Lastly, the `CachedDate` property returns the date and time value stored in the data cache, if such a value exists.</span></span> <span data-ttu-id="5380b-314">このプロパティは、サイトマップデータが最後にキャッシュされた日時を確認するために、ページ開発者が使用できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-314">This property can be used by a page developer to determine when the site map data was last cached.</span></span>

## <a name="step-7-registering-thenorthwindsitemapprovider"></a><span data-ttu-id="5380b-315">手順 7:`NorthwindSiteMapProvider` を登録する</span><span class="sxs-lookup"><span data-stu-id="5380b-315">Step 7: Registering the`NorthwindSiteMapProvider`</span></span>

<span data-ttu-id="5380b-316">手順6で作成した `NorthwindSiteMapProvider` サイトマッププロバイダーを web アプリケーションで使用するには、`Web.config`の `<siteMap>` セクションに登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-316">In order for our web application to use the `NorthwindSiteMapProvider` site map provider created in Step 6, we need to register it in the `<siteMap>` section of `Web.config`.</span></span> <span data-ttu-id="5380b-317">具体的には、`Web.config`の `<system.web>` 要素内に次のマークアップを追加します。</span><span class="sxs-lookup"><span data-stu-id="5380b-317">Specifically, add the following markup within the `<system.web>` element in `Web.config`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample7.xml)]

<span data-ttu-id="5380b-318">このマークアップは2つの処理を行います。まず、組み込みの `AspNetXmlSiteMapProvider` が既定のサイトマッププロバイダーであることを示します。次に、手順 6. で作成したカスタムサイトマッププロバイダーを、Northwind という名前で登録します。</span><span class="sxs-lookup"><span data-stu-id="5380b-318">This markup does two things: first, it indicates that the built-in `AspNetXmlSiteMapProvider` is the default site map provider; second, it registers the custom site map provider created in Step 6 with the human-friendly name Northwind .</span></span>

> [!NOTE]
> <span data-ttu-id="5380b-319">アプリケーションの `App_Code` フォルダーに配置されているサイトマッププロバイダーの場合、`type` 属性の値は単にクラス名になります。</span><span class="sxs-lookup"><span data-stu-id="5380b-319">For site map providers located in the application s `App_Code` folder, the value of the `type` attribute is simply the class name.</span></span> <span data-ttu-id="5380b-320">または、カスタムのサイトマッププロバイダーが、web アプリケーション s の `/Bin` ディレクトリに配置されたコンパイル済みアセンブリと共に、別のクラスライブラリプロジェクトに作成されている場合もあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-320">Alternatively, the custom site map provider could have been created in a separate Class Library project with the compiled assembly placed in the web application s `/Bin` directory.</span></span> <span data-ttu-id="5380b-321">この場合、`type` 属性値は*名前空間*になります。*ClassName*、 *AssemblyName* 。</span><span class="sxs-lookup"><span data-stu-id="5380b-321">In that case, the `type` attribute value would be *Namespace*.*ClassName*, *AssemblyName* .</span></span>

<span data-ttu-id="5380b-322">`Web.config`を更新した後、ブラウザーでチュートリアルのページを表示してみてください。</span><span class="sxs-lookup"><span data-stu-id="5380b-322">After updating `Web.config`, take a moment to view any page from the tutorials in a browser.</span></span> <span data-ttu-id="5380b-323">左側のナビゲーションインターフェイスには、`Web.sitemap`で定義されているセクションとチュートリアルがまだ表示されていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-323">Note that the navigation interface on the left still shows the sections and tutorials defined in `Web.sitemap`.</span></span> <span data-ttu-id="5380b-324">これは、`AspNetXmlSiteMapProvider` が既定のプロバイダーとして残されているためです。</span><span class="sxs-lookup"><span data-stu-id="5380b-324">This is because we left `AspNetXmlSiteMapProvider` as the default provider.</span></span> <span data-ttu-id="5380b-325">`NorthwindSiteMapProvider`を使用するナビゲーションユーザーインターフェイス要素を作成するには、Northwind サイトマッププロバイダーを使用する必要があることを明示的に指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-325">In order to create a navigation user interface element that uses the `NorthwindSiteMapProvider`, we'll need to explicitly specify that the Northwind site map provider should be used.</span></span> <span data-ttu-id="5380b-326">手順8でこれを実現する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="5380b-326">We'll see how to accomplish this in Step 8.</span></span>

## <a name="step-8-displaying-site-map-information-using-the-custom-site-map-provider"></a><span data-ttu-id="5380b-327">手順 8: カスタムサイトマッププロバイダーを使用してサイトマップ情報を表示する</span><span class="sxs-lookup"><span data-stu-id="5380b-327">Step 8: Displaying Site Map Information Using the Custom Site Map Provider</span></span>

<span data-ttu-id="5380b-328">`Web.config`にカスタムサイトマッププロバイダーを作成して登録すると、`SiteMapProvider` フォルダー内の `Default.aspx`、`ProductsByCategory.aspx`、および `ProductDetails.aspx` の各ページにナビゲーションコントロールを追加できるようになります。</span><span class="sxs-lookup"><span data-stu-id="5380b-328">With the custom site map provider created and registered in `Web.config`, we re ready to add navigation controls to the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="5380b-329">まず、[`Default.aspx`] ページを開いて、[ツールボックス] からデザイナーに `SiteMapPath` をドラッグします。</span><span class="sxs-lookup"><span data-stu-id="5380b-329">Start by opening the `Default.aspx` page and drag a `SiteMapPath` from the Toolbox onto the Designer.</span></span> <span data-ttu-id="5380b-330">SiteMapPath コントロールは、ツールボックスのナビゲーションセクションにあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-330">The SiteMapPath control is located in the Navigation section of the Toolbox.</span></span>

<span data-ttu-id="5380b-331">[SiteMapPath を default.aspx に追加 ![には](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span><span class="sxs-lookup"><span data-stu-id="5380b-331">[![Add a SiteMapPath to Default.aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span></span>

<span data-ttu-id="5380b-332">**図 16**: `Default.aspx` に SiteMapPath を追加する ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif)される)</span><span class="sxs-lookup"><span data-stu-id="5380b-332">**Figure 16**: Add a SiteMapPath to `Default.aspx` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif))</span></span>

<span data-ttu-id="5380b-333">SiteMapPath コントロールは、サイトマップ内の現在のページの場所を示す階層リンクを表示します。</span><span class="sxs-lookup"><span data-stu-id="5380b-333">The SiteMapPath control displays a breadcrumb, indicating the current page s location within the site map.</span></span> <span data-ttu-id="5380b-334">マスターページ*とサイトナビゲーション*のチュートリアルで、マスターページの一番上に SiteMapPath を追加しました。</span><span class="sxs-lookup"><span data-stu-id="5380b-334">We added a SiteMapPath to the top of the master page back in the *Master Pages and Site Navigation* tutorial.</span></span>

<span data-ttu-id="5380b-335">ブラウザーを使用してこのページを表示します。</span><span class="sxs-lookup"><span data-stu-id="5380b-335">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="5380b-336">図16で追加した SiteMapPath は、既定のサイトマッププロバイダーを使用して、`Web.sitemap`からデータをプルします。</span><span class="sxs-lookup"><span data-stu-id="5380b-336">The SiteMapPath added in Figure 16 uses the default site map provider, pulling its data from `Web.sitemap`.</span></span> <span data-ttu-id="5380b-337">そのため、階層リンクは、右上隅の階層リンクと同じように、サイトマップをカスタマイズするホーム &gt; を表示します。</span><span class="sxs-lookup"><span data-stu-id="5380b-337">Therefore, the breadcrumb shows Home &gt; Customizing the Site Map, just like the breadcrumb in the upper-right corner.</span></span>

<span data-ttu-id="5380b-338">[階層リンクが既定のサイトマッププロバイダーを使用する ![](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span><span class="sxs-lookup"><span data-stu-id="5380b-338">[![The Breadcrumb Uses the Default Site Map Provider](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span></span>

<span data-ttu-id="5380b-339">**図 17**: 階層リンクで既定のサイトマッププロバイダーが使用される ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-339">**Figure 17**: The Breadcrumb Uses the Default Site Map Provider ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif))</span></span>

<span data-ttu-id="5380b-340">図16で SiteMapPath を追加するには、手順6で作成したカスタムサイトマッププロバイダーを使用し、その[`SiteMapProvider` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx)を Northwind に設定します。この名前は `Web.config`で `NorthwindSiteMapProvider` に割り当てられています。</span><span class="sxs-lookup"><span data-stu-id="5380b-340">To have the SiteMapPath added in Figure 16 use the custom site map provider we created in Step 6, set its [`SiteMapProvider` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx) to Northwind, the name we assigned to the `NorthwindSiteMapProvider` in `Web.config`.</span></span> <span data-ttu-id="5380b-341">残念ながら、デザイナーは引き続き既定のサイトマッププロバイダーを使用しますが、このプロパティを変更した後でブラウザーを使用してページにアクセスすると、階層リンクでカスタムサイトマッププロバイダーが使用されていることがわかります。</span><span class="sxs-lookup"><span data-stu-id="5380b-341">Unfortunately, the Designer continues to use the default site map provider, but if you visit the page through a browser after making this property change you'll see that the breadcrumb now uses the custom site map provider.</span></span>

<span data-ttu-id="5380b-342">[![階層リンクがカスタムサイトマッププロバイダー NorthwindSiteMapProvider を使用するようになりました。](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span><span class="sxs-lookup"><span data-stu-id="5380b-342">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span></span>

<span data-ttu-id="5380b-343">**図 18**: 階層リンクがカスタムサイトマッププロバイダー `NorthwindSiteMapProvider` を使用するようになりました ([クリックしてフルサイズのイメージを表示](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span><span class="sxs-lookup"><span data-stu-id="5380b-343">**Figure 18**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span></span>

<span data-ttu-id="5380b-344">SiteMapPath コントロールは、`ProductsByCategory.aspx` ページと `ProductDetails.aspx` ページにより機能の高いユーザーインターフェイスを表示します。</span><span class="sxs-lookup"><span data-stu-id="5380b-344">The SiteMapPath control displays a more functional user interface in the `ProductsByCategory.aspx` and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="5380b-345">これらのページに SiteMapPath を追加し、両方の `SiteMapProvider` プロパティを Northwind に設定します。</span><span class="sxs-lookup"><span data-stu-id="5380b-345">Add a SiteMapPath to these pages, setting the `SiteMapProvider` property in both to Northwind.</span></span> <span data-ttu-id="5380b-346">[飲料] の [Products の表示] リンクを `Default.aspx` クリックし、[Chai 茶] の [詳細の表示] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="5380b-346">From `Default.aspx` click on the View Products link for Beverages, and then on the View Details link for Chai Tea.</span></span> <span data-ttu-id="5380b-347">図19に示すように、階層リンクには、現在のサイトマップセクション (Chai 紅茶) とその先祖 (飲み物およびすべてのカテゴリ) が含まれます。</span><span class="sxs-lookup"><span data-stu-id="5380b-347">As Figure 19 shows, the breadcrumb includes the current site map section ( Chai Tea ) and its ancestors: Beverages and All Categories .</span></span>

<span data-ttu-id="5380b-348">[![階層リンクがカスタムサイトマッププロバイダー NorthwindSiteMapProvider を使用するようになりました。](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="5380b-348">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span></span>

<span data-ttu-id="5380b-349">**図 19**: 階層リンクがカスタムサイトマッププロバイダー `NorthwindSiteMapProvider` を使用するようになりました ([クリックしてフルサイズのイメージを表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="5380b-349">**Figure 19**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span></span>

<span data-ttu-id="5380b-350">他のナビゲーションユーザーインターフェイス要素は、メニューや TreeView コントロールなど、SiteMapPath に加えて使用できます。</span><span class="sxs-lookup"><span data-stu-id="5380b-350">Other navigation user interface elements can be used in addition to the SiteMapPath, such as the Menu and TreeView controls.</span></span> <span data-ttu-id="5380b-351">このチュートリアルのダウンロードの `Default.aspx`、`ProductsByCategory.aspx`、および `ProductDetails.aspx` ページ (たとえば、すべてのメニューコントロールが含まれます (図20を参照)。</span><span class="sxs-lookup"><span data-stu-id="5380b-351">The `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the download for this tutorial, for example, all include Menu controls (see Figure 20).</span></span> <span data-ttu-id="5380b-352">ASP.NET 2.0 のナビゲーションコントロールとサイトマップシステムの詳細については、 [ASP.NET 2.0 クイックスタート](https://quickstarts.asp.net/QuickStartv20/aspnet/)の「 [ASP.NET 2.0 s サイトナビゲーション機能](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)とサイト[ナビゲーションコントロールの使用](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-352">See [Examining ASP.NET 2.0 s Site Navigation Features](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx) and the [Using Site Navigation Controls](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx) section of the [ASP.NET 2.0 QuickStarts](https://quickstarts.asp.net/QuickStartv20/aspnet/) for a more in-depth look at the navigation controls and site map system in ASP.NET 2.0.</span></span>

<span data-ttu-id="5380b-353">[メニューコントロールの ![カテゴリと製品の一覧を表示する](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span><span class="sxs-lookup"><span data-stu-id="5380b-353">[![The Menu Control Lists Each of the Categories and Products](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span></span>

<span data-ttu-id="5380b-354">**図 20**: メニューコントロールにカテゴリと製品の一覧が表示される ([クリックすると、フルサイズの画像が表示](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif)されます)</span><span class="sxs-lookup"><span data-stu-id="5380b-354">**Figure 20**: The Menu Control Lists Each of the Categories and Products ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif))</span></span>

<span data-ttu-id="5380b-355">このチュートリアルで既に説明したように、サイトマップ構造には、`SiteMap` クラスを使用してプログラムからアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="5380b-355">As mentioned earlier in this tutorial, the site map structure can be accessed programmatically through the `SiteMap` class.</span></span> <span data-ttu-id="5380b-356">次のコードは、既定のプロバイダーのルート `SiteMapNode` を返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-356">The following code returns the root `SiteMapNode` of the default provider:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample8.cs)]

<span data-ttu-id="5380b-357">`AspNetXmlSiteMapProvider` はアプリケーションの既定のプロバイダーであるため、上記のコードは `Web.sitemap`で定義されているルートノードを返します。</span><span class="sxs-lookup"><span data-stu-id="5380b-357">Since the `AspNetXmlSiteMapProvider` is the default provider for our application, the above code would return the root node defined in `Web.sitemap`.</span></span> <span data-ttu-id="5380b-358">既定以外のサイトマッププロバイダーを参照するには、次のように `SiteMap` クラス s [`Providers` プロパティ](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx)を使用します。</span><span class="sxs-lookup"><span data-stu-id="5380b-358">To reference a site map provider other than the default, use the `SiteMap` class s [`Providers` property](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx) like so:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample9.cs)]

<span data-ttu-id="5380b-359">ここで、 *name*はカスタムサイトマッププロバイダー (web アプリケーションの場合は Northwind) の名前です。</span><span class="sxs-lookup"><span data-stu-id="5380b-359">Where *name* is the name of the custom site map provider ( Northwind, for our web application).</span></span>

<span data-ttu-id="5380b-360">サイトマッププロバイダーに固有のメンバーにアクセスするには、`SiteMap.Providers["name"]` を使用してプロバイダーインスタンスを取得し、それを適切な型にキャストします。</span><span class="sxs-lookup"><span data-stu-id="5380b-360">To access a member specific to a site map provider, use `SiteMap.Providers["name"]` to retrieve the provider instance and then cast it to the appropriate type.</span></span> <span data-ttu-id="5380b-361">たとえば、ASP.NET ページで `NorthwindSiteMapProvider` s `CachedDate` プロパティを表示するには、次のコードを使用します。</span><span class="sxs-lookup"><span data-stu-id="5380b-361">For example, to display the `NorthwindSiteMapProvider` s `CachedDate` property in an ASP.NET page, use the following code:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample10.cs)]

> [!NOTE]
> <span data-ttu-id="5380b-362">SQL キャッシュ依存関係機能を必ずテストしてください。</span><span class="sxs-lookup"><span data-stu-id="5380b-362">Be sure to test out the SQL cache dependency feature.</span></span> <span data-ttu-id="5380b-363">`Default.aspx`、`ProductsByCategory.aspx`、および `ProductDetails.aspx` ページにアクセスした後、[編集]、[挿入]、[削除] セクションのいずれかのチュートリアルにアクセスし、カテゴリまたは製品の名前を編集します。</span><span class="sxs-lookup"><span data-stu-id="5380b-363">After visiting the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages, go to one of the tutorials in the Editing, Inserting, and Deleting section and edit the name of a category or product.</span></span> <span data-ttu-id="5380b-364">次に、`SiteMapProvider` フォルダー内のいずれかのページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="5380b-364">Then return to one of the pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="5380b-365">基になるデータベースへの変更を記録するためにポーリングメカニズムに十分な時間が経過していると仮定した場合、新しい製品名またはカテゴリ名を表示するようにサイトマップを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-365">Assuming enough time has passed for the polling mechanism to note the change to the underlying database, the site map should be updated to show the new product or category name.</span></span>

## <a name="summary"></a><span data-ttu-id="5380b-366">まとめ</span><span class="sxs-lookup"><span data-stu-id="5380b-366">Summary</span></span>

<span data-ttu-id="5380b-367">ASP.NET 2.0 s サイトマップ機能には、`SiteMap` クラス、多数の組み込みナビゲーション Web コントロール、および XML ファイルに保存されているサイトマップ情報を期待する既定のサイトマッププロバイダーが含まれています。</span><span class="sxs-lookup"><span data-stu-id="5380b-367">ASP.NET 2.0 s site map features includes a `SiteMap` class, a number of built-in navigation Web controls, and a default site map provider that expects the site map information persisted to an XML file.</span></span> <span data-ttu-id="5380b-368">データベース、アプリケーションのアーキテクチャ、リモート Web サービスなど、他のソースからのサイトマップ情報を使用するには、カスタムのサイトマッププロバイダーを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-368">In order to use site map information from some other source such as from a database, the application s architecture, or a remote Web service we need to create a custom site map provider.</span></span> <span data-ttu-id="5380b-369">これには、`SiteMapProvider` クラスから直接的または間接的に派生するクラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5380b-369">This involves creating a class that derives, directly or indirectly, from the `SiteMapProvider` class.</span></span>

<span data-ttu-id="5380b-370">このチュートリアルでは、製品のサイトマップとアプリケーションアーキテクチャからカリングされるカテゴリ情報を基にした、カスタムのサイトマッププロバイダーを作成する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="5380b-370">In this tutorial we saw how to create a custom site map provider that based the site map on the product and category information culled from the application architecture.</span></span> <span data-ttu-id="5380b-371">プロバイダーは `StaticSiteMapProvider` クラスと低下を拡張し、データを取得し、サイトマップ階層を構築し、結果の構造をクラスレベルの変数にキャッシュする `BuildSiteMap` メソッドを作成しました。</span><span class="sxs-lookup"><span data-stu-id="5380b-371">Our provider extended the `StaticSiteMapProvider` class and entailed creating a `BuildSiteMap` method that retrieved the data, constructed the site map hierarchy, and cached the resulting structure in a class-level variable.</span></span> <span data-ttu-id="5380b-372">基になる `Categories` または `Products` データが変更されたときに、キャッシュされた構造体を無効にするために、コールバック関数と共に SQL キャッシュの依存関係を使用しました。</span><span class="sxs-lookup"><span data-stu-id="5380b-372">We used a SQL cache dependency with a callback function to invalidate the cached structure when the underlying `Categories` or `Products` data is modified.</span></span>

<span data-ttu-id="5380b-373">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="5380b-373">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="5380b-374">参考資料</span><span class="sxs-lookup"><span data-stu-id="5380b-374">Further Reading</span></span>

<span data-ttu-id="5380b-375">このチュートリアルで説明しているトピックの詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5380b-375">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- <span data-ttu-id="5380b-376">SQL Server と、[待機していた SQL サイトマッププロバイダー](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx) [にサイトマップを格納](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)しています</span><span class="sxs-lookup"><span data-stu-id="5380b-376">[Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)</span></span>
- [<span data-ttu-id="5380b-377">ASP.NET 2.0 s プロバイダーモデルの概要</span><span class="sxs-lookup"><span data-stu-id="5380b-377">A Look at ASP.NET 2.0 s Provider Model</span></span>](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)
- [<span data-ttu-id="5380b-378">プロバイダーツールキット</span><span class="sxs-lookup"><span data-stu-id="5380b-378">The Provider Toolkit</span></span>](https://msdn.microsoft.com/asp.net/aa336558.aspx)
- [<span data-ttu-id="5380b-379">ASP.NET 2.0 s サイトナビゲーション機能の確認</span><span class="sxs-lookup"><span data-stu-id="5380b-379">Examining ASP.NET 2.0 s Site Navigation Features</span></span>](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)

## <a name="about-the-author"></a><span data-ttu-id="5380b-380">著者について</span><span class="sxs-lookup"><span data-stu-id="5380b-380">About the Author</span></span>

<span data-ttu-id="5380b-381">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="5380b-381">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="5380b-382">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="5380b-382">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="5380b-383">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="5380b-383">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="5380b-384">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="5380b-384">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="5380b-385">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="5380b-385">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="5380b-386">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="5380b-386">Special Thanks To</span></span>

<span data-ttu-id="5380b-387">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="5380b-387">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="5380b-388">このチュートリアルのリードレビュー担当者は、Dave Gardner、Zack Jones、Teresa Murphy、Bernadette Leigh でした。</span><span class="sxs-lookup"><span data-stu-id="5380b-388">Lead reviewers for this tutorial were Dave Gardner, Zack Jones, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="5380b-389">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="5380b-389">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="5380b-390">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="5380b-390">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="5380b-391">Next</span><span class="sxs-lookup"><span data-stu-id="5380b-391">Next</span></span>](building-a-custom-database-driven-site-map-provider-vb.md)
