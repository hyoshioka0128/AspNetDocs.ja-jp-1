---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
title: ASP.NET ページ (C#) での BLL レベルおよび DAL レベルの例外の処理Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、挿入、更新、または削除の操作中に例外が発生した場合に、わかりやすい情報を表示するエラーメッセージを表示する方法について説明します。
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 49d8a66c-3ea8-4087-839f-179d1d94512a
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
msc.type: authoredcontent
ms.openlocfilehash: 2b9cdb5af6f33171b191d5a80473c7796eb098d9
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78492772"
---
# <a name="handling-bll--and-dal-level-exceptions-in-an-aspnet-page-c"></a><span data-ttu-id="84ace-103">ASP.NET ページで BLL レベルと DAL レベルの例外を処理する (C#)</span><span class="sxs-lookup"><span data-stu-id="84ace-103">Handling BLL- and DAL-Level Exceptions in an ASP.NET Page (C#)</span></span>

<span data-ttu-id="84ace-104">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="84ace-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="84ace-105">[サンプルアプリのダウンロード](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe)または[PDF のダウンロード](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="84ace-105">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span></span>

> <span data-ttu-id="84ace-106">このチュートリアルでは、ASP.NET データ Web コントロールの挿入、更新、または削除操作中に例外が発生した場合に、わかりやすいエラーメッセージを表示する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="84ace-106">In this tutorial we will see how to display a friendly, informative error message should an exception occur during an insert, update, or delete operation of an ASP.NET data Web control.</span></span>

## <a name="introduction"></a><span data-ttu-id="84ace-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="84ace-107">Introduction</span></span>

<span data-ttu-id="84ace-108">階層化されたアプリケーションアーキテクチャを使用して ASP.NET web アプリケーションのデータを操作するには、次の3つの一般的な手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="84ace-108">Working with data from an ASP.NET web application using a tiered application architecture involves the following three general steps:</span></span>

1. <span data-ttu-id="84ace-109">ビジネスロジック層を呼び出す必要がある方法と、それに渡すパラメーター値を決定します。</span><span class="sxs-lookup"><span data-stu-id="84ace-109">Determine what method of the Business Logic Layer needs to be invoked and what parameter values to pass it.</span></span> <span data-ttu-id="84ace-110">パラメーター値は、ハードコーディングされているか、プログラムによって割り当てられるか、またはユーザーが入力する入力です。</span><span class="sxs-lookup"><span data-stu-id="84ace-110">The parameter values can be hard coded, programmatically-assigned, or inputs entered by the user.</span></span>
2. <span data-ttu-id="84ace-111">メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="84ace-111">Invoke the method.</span></span>
3. <span data-ttu-id="84ace-112">結果を処理します。</span><span class="sxs-lookup"><span data-stu-id="84ace-112">Process the results.</span></span> <span data-ttu-id="84ace-113">データを返す BLL メソッドを呼び出す場合、データをデータ Web コントロールにバインドすることが必要になることがあります。</span><span class="sxs-lookup"><span data-stu-id="84ace-113">When calling a BLL method that returns data, this may involve binding the data to a data Web control.</span></span> <span data-ttu-id="84ace-114">データを変更する BLL メソッドの場合は、戻り値に基づいて何らかのアクションを実行したり、手順 2. で発生した例外を適切に処理したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="84ace-114">For BLL methods that modify data, this may include performing some action based on a return value or gracefully handling any exception that arose in Step 2.</span></span>

<span data-ttu-id="84ace-115">[前のチュートリアル](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)で見たように、ObjectDataSource とデータ Web コントロールの両方で、手順 1. と 3. の機能拡張ポイントが提供されています。</span><span class="sxs-lookup"><span data-stu-id="84ace-115">As we saw in the [previous tutorial](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md), both the ObjectDataSource and the data Web controls provide extensibility points for Steps 1 and 3.</span></span> <span data-ttu-id="84ace-116">たとえば、GridView は、フィールド値を ObjectDataSource の `UpdateParameters` コレクションに割り当てる前に、その `RowUpdating` イベントを発生させます。この `RowUpdated` イベントは、ObjectDataSource が操作を完了した後に発生します。</span><span class="sxs-lookup"><span data-stu-id="84ace-116">The GridView, for example, fires its `RowUpdating` event prior to assigning its field values to its ObjectDataSource's `UpdateParameters` collection; its `RowUpdated` event is raised after the ObjectDataSource has completed the operation.</span></span>

<span data-ttu-id="84ace-117">手順1で発生するイベントを既に調べており、それらを使用して入力パラメーターをカスタマイズしたり操作を取り消したりする方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="84ace-117">We've already examined the events that fire during Step 1 and have seen how they can be used to customize the input parameters or cancel the operation.</span></span> <span data-ttu-id="84ace-118">このチュートリアルでは、操作が完了した後に発生するイベントに注目します。</span><span class="sxs-lookup"><span data-stu-id="84ace-118">In this tutorial we'll turn our attention to the events that fire after the operation has completed.</span></span> <span data-ttu-id="84ace-119">これらの投稿レベルのイベントハンドラーを使用すると、操作中に例外が発生したかどうかを判断し、適切に処理することができます。標準の ASP.NET を既定のままにするのではなく、わかりやすい情報を示すエラーメッセージが画面に表示されます。例外ページ。</span><span class="sxs-lookup"><span data-stu-id="84ace-119">With these post-level event handlers we can, among other things, determine if an exception occurred during the operation and handle it gracefully, displaying a friendly, informative error message on the screen rather than defaulting to the standard ASP.NET exception page.</span></span>

<span data-ttu-id="84ace-120">これらの投稿レベルのイベントを使用する方法を示すために、編集可能な GridView で製品を一覧表示するページを作成してみましょう。</span><span class="sxs-lookup"><span data-stu-id="84ace-120">To illustrate working with these post-level events, let's create a page that lists the products in an editable GridView.</span></span> <span data-ttu-id="84ace-121">製品を更新するときに、例外が発生した場合、ASP.NET ページには、問題が発生したことを示す、GridView の上に短いメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-121">When updating a product, if an exception is raised our ASP.NET page will display a short message above the GridView explaining that a problem has occurred.</span></span> <span data-ttu-id="84ace-122">作業開始</span><span class="sxs-lookup"><span data-stu-id="84ace-122">Let's get started!</span></span>

## <a name="step-1-creating-an-editable-gridview-of-products"></a><span data-ttu-id="84ace-123">手順 1: 編集可能な製品の GridView を作成する</span><span class="sxs-lookup"><span data-stu-id="84ace-123">Step 1: Creating an Editable GridView of Products</span></span>

<span data-ttu-id="84ace-124">前のチュートリアルでは、`ProductName` と `UnitPrice`の2つのフィールドだけを含む編集可能な GridView を作成しました。</span><span class="sxs-lookup"><span data-stu-id="84ace-124">In the previous tutorial we created an editable GridView with just two fields, `ProductName` and `UnitPrice`.</span></span> <span data-ttu-id="84ace-125">これには、`ProductsBLL` クラスの `UpdateProduct` メソッドに対して追加のオーバーロードを作成する必要があります。1つは、各製品フィールドのパラメーターとしてではなく、3つの入力パラメーター (製品の名前、単価、および ID) のみを受け入れたものです。</span><span class="sxs-lookup"><span data-stu-id="84ace-125">This required creating an additional overload for the `ProductsBLL` class's `UpdateProduct` method, one that only accepted three input parameters (the product's name, unit price, and ID) as opposed a parameter for each product field.</span></span> <span data-ttu-id="84ace-126">このチュートリアルでは、この方法をもう一度実行して、製品の名前、単位あたりの数量、単価、および在庫数を表示する編集可能な GridView を作成します。ただし、在庫の名前、単価、および単位の編集のみが許可されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-126">For this tutorial, let's practice this technique again, creating an editable GridView that displays the product's name, quantity per unit, unit price, and units in stock, but only allows the name, unit price, and units in stock to be edited.</span></span>

<span data-ttu-id="84ace-127">このシナリオに対応するには、`UpdateProduct` メソッドの別のオーバーロードが必要です。1つは、製品の名前、単価、在庫数量、および ID の4つのパラメーターを受け取ります。</span><span class="sxs-lookup"><span data-stu-id="84ace-127">To accommodate this scenario we'll need another overload of the `UpdateProduct` method, one that accepts four parameters: the product's name, unit price, units in stock, and ID.</span></span> <span data-ttu-id="84ace-128">次のメソッドを `ProductsBLL` クラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="84ace-128">Add the following method to the `ProductsBLL` class:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample1.cs)]

<span data-ttu-id="84ace-129">このメソッドが完成したら、この4つの特定の製品フィールドを編集できる ASP.NET ページを作成できます。</span><span class="sxs-lookup"><span data-stu-id="84ace-129">With this method complete, we're ready to create the ASP.NET page that allows for editing these four particular product fields.</span></span> <span data-ttu-id="84ace-130">`EditInsertDelete` フォルダーの [`ErrorHandling.aspx`] ページを開き、デザイナーを使用して GridView をページに追加します。</span><span class="sxs-lookup"><span data-stu-id="84ace-130">Open the `ErrorHandling.aspx` page in the `EditInsertDelete` folder and add a GridView to the page through the Designer.</span></span> <span data-ttu-id="84ace-131">GridView を新しい ObjectDataSource にバインドし、`Select()` メソッドを `ProductsBLL` クラスの `GetProducts()` メソッドにマップし、`Update()` メソッドを、先ほど作成した `UpdateProduct` オーバーロードに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="84ace-131">Bind the GridView to a new ObjectDataSource, mapping the `Select()` method to the `ProductsBLL` class's `GetProducts()` method and the `Update()` method to the `UpdateProduct` overload just created.</span></span>

<span data-ttu-id="84ace-132">[4つの入力パラメーターを受け取る UpdateProduct メソッドのオーバーロードを使用 ![](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-132">[![Use the UpdateProduct Method Overload That Accepts Four Input Parameters](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span></span>

<span data-ttu-id="84ace-133">**図 1**: 4 つの入力パラメーターを受け取る `UpdateProduct` メソッドのオーバーロードを使用する ([クリックしてフルサイズのイメージを表示する](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="84ace-133">**Figure 1**: Use the `UpdateProduct` Method Overload That Accepts Four Input Parameters ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span></span>

<span data-ttu-id="84ace-134">これにより、4つのパラメーターを持つ `UpdateParameters` コレクションを持つ ObjectDataSource と、product フィールドごとにフィールドを持つ GridView が作成されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-134">This will create an ObjectDataSource with an `UpdateParameters` collection with four parameters and a GridView with a field for each of the product fields.</span></span> <span data-ttu-id="84ace-135">ObjectDataSource の宣言型マークアップは、`OldValuesParameterFormatString` プロパティに値 `original_{0}`を割り当てます。これにより、BLL クラスでは `original_productID` という名前の入力パラメーターが渡されないため、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="84ace-135">The ObjectDataSource's declarative markup assigns the `OldValuesParameterFormatString` property the value `original_{0}`, which will cause an exception since our BLL class's don't expect an input parameter named `original_productID` to be passed in.</span></span> <span data-ttu-id="84ace-136">この設定を宣言構文から完全に削除することを忘れないでください (または、既定値に設定して `{0}`)。</span><span class="sxs-lookup"><span data-stu-id="84ace-136">Don't forget to remove this setting altogether from the declarative syntax (or set it to the default value, `{0}`).</span></span>

<span data-ttu-id="84ace-137">次に、`ProductName`、`QuantityPerUnit`、`UnitPrice`、および `UnitsInStock` BoundFields のみを含むように、GridView を省いします。</span><span class="sxs-lookup"><span data-stu-id="84ace-137">Next, pare down the GridView to include only the `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` BoundFields.</span></span> <span data-ttu-id="84ace-138">また、必要と思われるフィールドレベルの書式設定も自由に適用できます (`HeaderText` プロパティの変更など)。</span><span class="sxs-lookup"><span data-stu-id="84ace-138">Also feel free to apply any field-level formatting you deem necessary (such as changing the `HeaderText` properties).</span></span>

<span data-ttu-id="84ace-139">前のチュートリアルでは、読み取り専用モードと編集モードの両方で、`UnitPrice` BoundField を通貨として書式設定する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="84ace-139">In the previous tutorial we looked at how to format the `UnitPrice` BoundField as a currency both in read-only mode and edit mode.</span></span> <span data-ttu-id="84ace-140">ここでも同じ操作を行います。</span><span class="sxs-lookup"><span data-stu-id="84ace-140">Let's do the same here.</span></span> <span data-ttu-id="84ace-141">図2に示すように、BoundField の `DataFormatString` プロパティを `{0:c}`、その `HtmlEncode` プロパティを `false`に設定し、その `ApplyFormatInEditMode` を `true`に設定する必要があることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="84ace-141">Recall that this required setting the BoundField's `DataFormatString` property to `{0:c}`, its `HtmlEncode` property to `false`, and its `ApplyFormatInEditMode` to `true`, as shown in Figure 2.</span></span>

<span data-ttu-id="84ace-142">[UnitPrice BoundField を通貨として表示するように構成 ![には](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-142">[![Configure the UnitPrice BoundField to Display as a Currency](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span></span>

<span data-ttu-id="84ace-143">**図 2**: `UnitPrice` BoundField を通貨として表示するように構成する ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-143">**Figure 2**: Configure the `UnitPrice` BoundField to Display as a Currency ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png))</span></span>

<span data-ttu-id="84ace-144">`UnitPrice` を編集インターフェイスで通貨として書式設定するには、`decimal` 値に通貨形式の文字列を解析する GridView の `RowUpdating` イベントのイベントハンドラーを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="84ace-144">Formatting the `UnitPrice` as a currency in the editing interface requires creating an event handler for the GridView's `RowUpdating` event that parses the currency-formatted string into a `decimal` value.</span></span> <span data-ttu-id="84ace-145">最後のチュートリアルの `RowUpdating` イベントハンドラーも、ユーザーが `UnitPrice` 値を指定したことを確認するためにチェックされていることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="84ace-145">Recall that the `RowUpdating` event handler from the last tutorial also checked to ensure that the user provided a `UnitPrice` value.</span></span> <span data-ttu-id="84ace-146">ただし、このチュートリアルでは、ユーザーが価格を省略できるようにします。</span><span class="sxs-lookup"><span data-stu-id="84ace-146">However, for this tutorial let's allow the user to omit the price.</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample2.cs)]

<span data-ttu-id="84ace-147">GridView には `QuantityPerUnit` BoundField が含まれていますが、この BoundField は表示のみを目的としているため、ユーザーが編集することはできません。</span><span class="sxs-lookup"><span data-stu-id="84ace-147">Our GridView includes a `QuantityPerUnit` BoundField, but this BoundField should be only for display purposes and should not be editable by the user.</span></span> <span data-ttu-id="84ace-148">これを配置するには、単に BoundFields ' `ReadOnly` プロパティを `true`に設定します。</span><span class="sxs-lookup"><span data-stu-id="84ace-148">To arrange this, simply set the BoundFields' `ReadOnly` property to `true`.</span></span>

<span data-ttu-id="84ace-149">[QuantityPerUnit BoundField を読み取り専用にする ![](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-149">[![Make the QuantityPerUnit BoundField Read-Only](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span></span>

<span data-ttu-id="84ace-150">**図 3**: `QuantityPerUnit` BoundField を読み取り専用[にする (クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-150">**Figure 3**: Make the `QuantityPerUnit` BoundField Read-Only ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png))</span></span>

<span data-ttu-id="84ace-151">最後に、GridView のスマートタグの [編集を有効にする] チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="84ace-151">Finally, check the Enable Editing checkbox from the GridView's smart tag.</span></span> <span data-ttu-id="84ace-152">これらの手順を完了すると、`ErrorHandling.aspx` ページのデザイナーは図4のようになります。</span><span class="sxs-lookup"><span data-stu-id="84ace-152">After completing these steps the `ErrorHandling.aspx` page's Designer should look similar to Figure 4.</span></span>

<span data-ttu-id="84ace-153">[必要な BoundFields 以外のすべてを削除して、[編集を有効にする] チェックボックスをオンに ![](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-153">[![Remove All But the Needed BoundFields and Check the Enable Editing Checkbox](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span></span>

<span data-ttu-id="84ace-154">**図 4**: 必要な Boundfields 以外のすべてを削除し、[編集を有効にする] チェックボックスをオン[にする (クリックしてフルサイズのイメージを表示する](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="84ace-154">**Figure 4**: Remove All But the Needed BoundFields and Check the Enable Editing Checkbox ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span></span>

<span data-ttu-id="84ace-155">この時点で、すべての製品の `ProductName`、`QuantityPerUnit`、`UnitPrice`、および `UnitsInStock` の各フィールドの一覧が表示されます。ただし、編集できるのは、`ProductName`、`UnitPrice`、および `UnitsInStock` フィールドのみです。</span><span class="sxs-lookup"><span data-stu-id="84ace-155">At this point we have a list of all of the products' `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` fields; however, only the `ProductName`, `UnitPrice`, and `UnitsInStock` fields can be edited.</span></span>

<span data-ttu-id="84ace-156">[![ユーザーは、在庫フィールドの製品名、価格、単位を簡単に編集できるようになりました。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-156">[![Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span></span>

<span data-ttu-id="84ace-157">**図 5**: ユーザーは在庫フィールドの製品名、価格、単位を簡単に編集できるようになりました ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-157">**Figure 5**: Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png))</span></span>

## <a name="step-2-gracefully-handling-dal-level-exceptions"></a><span data-ttu-id="84ace-158">手順 2: DAL レベルの例外を適切に処理する</span><span class="sxs-lookup"><span data-stu-id="84ace-158">Step 2: Gracefully Handling DAL-Level Exceptions</span></span>

<span data-ttu-id="84ace-159">編集可能な GridView は、ユーザーが編集した製品の名前、価格、および在庫の単位に対して有効な値を入力したときにてになりますが、無効な値を入力すると例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="84ace-159">While our editable GridView works wonderfully when users enter legal values for the edited product's name, price, and units in stock, entering illegal values results in an exception.</span></span> <span data-ttu-id="84ace-160">たとえば、`ProductName` 値を省略すると、`ProductsRow` クラスの `ProductName` プロパティの `AllowDBNull` プロパティが `false`に設定されているため、 [system.data.nonullallowedexception](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp)がスローされます。データベースがダウンしている場合は、データベースに接続しようとすると、TableAdapter によって `SqlException` がスローされます。</span><span class="sxs-lookup"><span data-stu-id="84ace-160">For example, omitting the `ProductName` value causes a [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) to be thrown since the `ProductName` property in the `ProductsRow` class has its `AllowDBNull` property set to `false`; if the database is down, a `SqlException` will be thrown by the TableAdapter when attempting to connect to the database.</span></span> <span data-ttu-id="84ace-161">アクションを実行しないと、これらの例外はデータアクセス層からビジネスロジック層、ASP.NET ページ、最後に ASP.NET ランタイムにバブルアップされます。</span><span class="sxs-lookup"><span data-stu-id="84ace-161">Without taking any action, these exceptions bubble up from the Data Access Layer to the Business Logic Layer, then to the ASP.NET page, and finally to the ASP.NET runtime.</span></span>

<span data-ttu-id="84ace-162">Web アプリケーションがどのように構成されているか、および `localhost`からアプリケーションにアクセスしているかどうかによって、ハンドルされない例外によって、汎用サーバーエラーページ、詳細エラーレポート、またはユーザーフレンドリな web ページのいずれかが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="84ace-162">Depending on how your web application is configured and whether or not you're visiting the application from `localhost`, an unhandled exception can result in either a generic server-error page, a detailed error report, or a user-friendly web page.</span></span> <span data-ttu-id="84ace-163">ASP.NET ランタイムがキャッチされない例外に応答する方法の詳細については、「ASP.NET と[CustomErrors 要素](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx)の[Web アプリケーションエラー処理](http://www.15seconds.com/issue/030102.htm)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="84ace-163">See [Web Application Error Handling in ASP.NET](http://www.15seconds.com/issue/030102.htm) and the [customErrors Element](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) for more information on how the ASP.NET runtime responds to an uncaught exception.</span></span>

<span data-ttu-id="84ace-164">図6は、`ProductName` 値を指定せずに製品を更新しようとしたときに発生した画面を示しています。</span><span class="sxs-lookup"><span data-stu-id="84ace-164">Figure 6 shows the screen encountered when attempting to update a product without specifying the `ProductName` value.</span></span> <span data-ttu-id="84ace-165">これは `localhost`を通じて表示される既定の詳細エラーレポートです。</span><span class="sxs-lookup"><span data-stu-id="84ace-165">This is the default detailed error report displayed when coming through `localhost`.</span></span>

<span data-ttu-id="84ace-166">[製品名を省略すると ![例外の詳細が表示されます](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-166">[![Omitting the Product's Name Will Display Exception Details](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span></span>

<span data-ttu-id="84ace-167">**図 6**: 製品名を省略すると例外の詳細が表示される ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-167">**Figure 6**: Omitting the Product's Name Will Display Exception Details ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png))</span></span>

<span data-ttu-id="84ace-168">このような例外の詳細は、アプリケーションをテストする場合に役立ちますが、例外が発生したときに、このような画面をエンドユーザーに提示することは、理想よりも低くなります。</span><span class="sxs-lookup"><span data-stu-id="84ace-168">While such exception details are helpful when testing an application, presenting an end user with such a screen in the face of an exception is less than ideal.</span></span> <span data-ttu-id="84ace-169">エンドユーザーは、`NoNullAllowedException` の内容や原因がわからない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="84ace-169">An end user likely doesn't know what a `NoNullAllowedException` is or why it was caused.</span></span> <span data-ttu-id="84ace-170">より良い方法は、製品を更新しようとしたときに問題が発生したことを説明する、ユーザーにわかりやすいメッセージを表示することです。</span><span class="sxs-lookup"><span data-stu-id="84ace-170">A better approach is to present the user with a more user-friendly message explaining that there were problems attempting to update the product.</span></span>

<span data-ttu-id="84ace-171">操作の実行中に例外が発生した場合、ObjectDataSource と data Web control の両方のレベルイベントは、その例外を検出し、ASP.NET ランタイムまでのバブルから例外をキャンセルする手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="84ace-171">If an exception occurs when performing the operation, the post-level events in both the ObjectDataSource and the data Web control provide a means to detect it and cancel the exception from bubbling up to the ASP.NET runtime.</span></span> <span data-ttu-id="84ace-172">この例では、GridView の `RowUpdated` イベントのイベントハンドラーを作成して、例外が発生したかどうかを判断し、その場合は、ラベル Web コントロールに例外の詳細を表示します。</span><span class="sxs-lookup"><span data-stu-id="84ace-172">For our example, let's create an event handler for the GridView's `RowUpdated` event that determines if an exception has fired and, if so, displays the exception details in a Label Web control.</span></span>

<span data-ttu-id="84ace-173">まず、ラベルを ASP.NET ページに追加し、その `ID` プロパティを `ExceptionDetails` に設定して、その `Text` プロパティをクリアします。</span><span class="sxs-lookup"><span data-stu-id="84ace-173">Start by adding a Label to the ASP.NET page, setting its `ID` property to `ExceptionDetails` and clearing out its `Text` property.</span></span> <span data-ttu-id="84ace-174">このメッセージに対するユーザーの目を引くには、`CssClass` プロパティを `Warning`に設定します。これは、前のチュートリアルで `Styles.css` ファイルに追加した CSS クラスです。</span><span class="sxs-lookup"><span data-stu-id="84ace-174">In order to draw the user's eye to this message, set its `CssClass` property to `Warning`, which is a CSS class we added to the `Styles.css` file in the previous tutorial.</span></span> <span data-ttu-id="84ace-175">この CSS クラスを使用すると、ラベルのテキストが赤、斜体、太字、特大のフォントで表示されることを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="84ace-175">Recall that this CSS class causes the Label's text to be displayed in a red, italic, bold, extra large font.</span></span>

<span data-ttu-id="84ace-176">[ページにラベル Web コントロールを追加 ![には](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-176">[![Add a Label Web Control to the Page](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span></span>

<span data-ttu-id="84ace-177">**図 7**: ページにラベル Web コントロールを追加する ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-177">**Figure 7**: Add a Label Web Control to the Page ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png))</span></span>

<span data-ttu-id="84ace-178">このラベル Web コントロールは、例外が発生した直後にのみ表示されるようにするため、`Page_Load` イベントハンドラーで `Visible` プロパティを false に設定します。</span><span class="sxs-lookup"><span data-stu-id="84ace-178">Since we want this Label Web control to be visible only immediately after an exception has occurred, set its `Visible` property to false in the `Page_Load` event handler:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample3.cs)]

<span data-ttu-id="84ace-179">このコードでは、最初のページにアクセスし、次のポストバックで、`ExceptionDetails` コントロールの `Visible` プロパティを `false`に設定します。</span><span class="sxs-lookup"><span data-stu-id="84ace-179">With this code, on the first page visit and subsequent postbacks the `ExceptionDetails` control will have its `Visible` property set to `false`.</span></span> <span data-ttu-id="84ace-180">GridView の `RowUpdated` イベントハンドラーで検出できる DAL または BLL レベルの例外が発生した場合は、`ExceptionDetails` コントロールの `Visible` プロパティを true に設定します。</span><span class="sxs-lookup"><span data-stu-id="84ace-180">In the face of a DAL- or BLL-level exception, which we can detect in the GridView's `RowUpdated` event handler, we will set the `ExceptionDetails` control's `Visible` property to true.</span></span> <span data-ttu-id="84ace-181">Web コントロールのイベントハンドラーは、ページのライフサイクルの `Page_Load` イベントハンドラーの後に発生するため、ラベルが表示されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-181">Since Web control event handlers occur after the `Page_Load` event handler in the page lifecycle, the Label will be shown.</span></span> <span data-ttu-id="84ace-182">ただし、次のポストバック時には、`Page_Load` イベントハンドラーによって `Visible` プロパティが `false`に戻され、再度ビューから非表示になります。</span><span class="sxs-lookup"><span data-stu-id="84ace-182">However, on the next postback, the `Page_Load` event handler will revert the `Visible` property back to `false`, hiding it from view again.</span></span>

> [!NOTE]
> <span data-ttu-id="84ace-183">または、`Page_Load` で `ExceptionDetails` コントロールの `Visible` プロパティを設定する必要があります。これを行うには、宣言構文で `Visible` プロパティ `false` を割り当て、そのビューステートを無効にします (`EnableViewState` プロパティを `false`に設定します)。</span><span class="sxs-lookup"><span data-stu-id="84ace-183">Alternatively, we could remove the necessity for setting the `ExceptionDetails` control's `Visible` property in `Page_Load` by assigning its `Visible` property `false` in the declarative syntax and disabling its view state (setting its `EnableViewState` property to `false`).</span></span> <span data-ttu-id="84ace-184">この代替アプローチは、今後のチュートリアルで使用します。</span><span class="sxs-lookup"><span data-stu-id="84ace-184">We'll use this alternative approach in a future tutorial.</span></span>

<span data-ttu-id="84ace-185">ラベルコントロールが追加されたので、次のステップは GridView の `RowUpdated` イベントのイベントハンドラーを作成することです。</span><span class="sxs-lookup"><span data-stu-id="84ace-185">With the Label control added, our next step is to create the event handler for the GridView's `RowUpdated` event.</span></span> <span data-ttu-id="84ace-186">デザイナーで GridView を選択し、プロパティウィンドウにアクセスして、[稲妻] アイコンをクリックし、GridView のイベントを一覧表示します。</span><span class="sxs-lookup"><span data-stu-id="84ace-186">Select the GridView in the Designer, go to the Properties window, and click the lightning bolt icon, listing the GridView's events.</span></span> <span data-ttu-id="84ace-187">このチュートリアルの前半でこのイベントのイベントハンドラーを作成したので、GridView の `RowUpdating` イベントのエントリが既に存在している必要があります。</span><span class="sxs-lookup"><span data-stu-id="84ace-187">There should already be an entry there for the GridView's `RowUpdating` event, as we created an event handler for this event earlier in this tutorial.</span></span> <span data-ttu-id="84ace-188">`RowUpdated` イベントのイベントハンドラーも作成します。</span><span class="sxs-lookup"><span data-stu-id="84ace-188">Create an event handler for the `RowUpdated` event as well.</span></span>

![GridView の RowUpdated イベントのイベントハンドラーを作成します。](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image22.png)

<span data-ttu-id="84ace-190">**図 8**: GridView の `RowUpdated` イベントのイベントハンドラーを作成する</span><span class="sxs-lookup"><span data-stu-id="84ace-190">**Figure 8**: Create an Event Handler for the GridView's `RowUpdated` Event</span></span>

> [!NOTE]
> <span data-ttu-id="84ace-191">イベントハンドラーは、分離コードクラスファイルの先頭にあるドロップダウンリストを使用して作成することもできます。</span><span class="sxs-lookup"><span data-stu-id="84ace-191">You can also create the event handler through the drop-down lists at the top of the code-behind class file.</span></span> <span data-ttu-id="84ace-192">左側のドロップダウンリストから GridView を選択し、右側にある [`RowUpdated` イベント] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="84ace-192">Select the GridView from the drop-down list on the left and the `RowUpdated` event from the one on the right.</span></span>

<span data-ttu-id="84ace-193">このイベントハンドラーを作成すると、ASP.NET ページの分離コードクラスに次のコードが追加されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-193">Creating this event handler will add the following code to the ASP.NET page's code-behind class:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample4.cs)]

<span data-ttu-id="84ace-194">このイベントハンドラーの2番目の入力パラメーターは、 [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx)型のオブジェクトで、例外を処理するための3つのプロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="84ace-194">This event handler's second input parameter is an object of type [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), which has three properties of interest for handling exceptions:</span></span>

- <span data-ttu-id="84ace-195">スローされた例外への参照を `Exception` します。例外がスローされなかった場合、このプロパティの値はになり `null`</span><span class="sxs-lookup"><span data-stu-id="84ace-195">`Exception` a reference to the thrown exception; if no exception has been thrown, this property will have a value of `null`</span></span>
- <span data-ttu-id="84ace-196">例外が `RowUpdated` イベントハンドラーで処理されたかどうかを示すブール値を `ExceptionHandled` します。`false` (既定値) の場合、例外が再スローされ、ASP.NET ランタイムまで実行されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-196">`ExceptionHandled` a Boolean value that indicates whether or not the exception was handled in the `RowUpdated` event handler; if `false` (the default), the exception is re-thrown, percolating up to the ASP.NET runtime</span></span>
- <span data-ttu-id="84ace-197">`KeepInEditMode` に設定 `true` すると、編集された GridView 行は編集モードのままになります。`false` (既定値) の場合、GridView 行は読み取り専用モードに戻ります。</span><span class="sxs-lookup"><span data-stu-id="84ace-197">`KeepInEditMode` if set to `true` the edited GridView row remains in edit mode; if `false` (the default), the GridView row reverts back to its read-only mode</span></span>

<span data-ttu-id="84ace-198">次に、コードは `Exception` が `null`ないかどうかを確認する必要があります。つまり、操作の実行中に例外が発生したことを意味します。</span><span class="sxs-lookup"><span data-stu-id="84ace-198">Our code, then, should check to see if `Exception` is not `null`, meaning that an exception was raised while performing the operation.</span></span> <span data-ttu-id="84ace-199">この場合は、次のようにします。</span><span class="sxs-lookup"><span data-stu-id="84ace-199">If this is the case, we want to:</span></span>

- <span data-ttu-id="84ace-200">`ExceptionDetails` ラベルにわかりやすいメッセージを表示する</span><span class="sxs-lookup"><span data-stu-id="84ace-200">Display a user-friendly message in the `ExceptionDetails` Label</span></span>
- <span data-ttu-id="84ace-201">例外が処理されたことを示します。</span><span class="sxs-lookup"><span data-stu-id="84ace-201">Indicate that the exception was handled</span></span>
- <span data-ttu-id="84ace-202">GridView 行を編集モードのままにする</span><span class="sxs-lookup"><span data-stu-id="84ace-202">Keep the GridView row in edit mode</span></span>

<span data-ttu-id="84ace-203">次のコードは、これらの目的を達成します。</span><span class="sxs-lookup"><span data-stu-id="84ace-203">This following code accomplishes these objectives:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample5.cs)]

<span data-ttu-id="84ace-204">このイベントハンドラーは、`e.Exception` が `null`かどうかを確認することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-204">This event handler begins by checking to see if `e.Exception` is `null`.</span></span> <span data-ttu-id="84ace-205">そうでない場合は、`ExceptionDetails` ラベルの `Visible` プロパティが `true` に設定され、その `Text` プロパティが "製品の更新で問題が発生しました。" となります。</span><span class="sxs-lookup"><span data-stu-id="84ace-205">If it's not, the `ExceptionDetails` Label's `Visible` property is set to `true` and its `Text` property to "There was a problem updating the product."</span></span> <span data-ttu-id="84ace-206">スローされた実際の例外の詳細は、`e.Exception` オブジェクトの `InnerException` プロパティに存在します。</span><span class="sxs-lookup"><span data-stu-id="84ace-206">The details of the actual exception that was thrown reside in the `e.Exception` object's `InnerException` property.</span></span> <span data-ttu-id="84ace-207">この内部例外が調べられ、特定の型の場合は、追加の便利なメッセージが `ExceptionDetails` ラベルの `Text` プロパティに追加されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-207">This inner exception is examined and, if it is of a particular type, an additional, helpful message is appended to the `ExceptionDetails` Label's `Text` property.</span></span> <span data-ttu-id="84ace-208">最後に、`ExceptionHandled` プロパティと `KeepInEditMode` プロパティの両方が `true`に設定されています。</span><span class="sxs-lookup"><span data-stu-id="84ace-208">Lastly, the `ExceptionHandled` and `KeepInEditMode` properties are both set to `true`.</span></span>

<span data-ttu-id="84ace-209">図9に、製品名を省略した場合のこのページのスクリーンショットを示します。図10は、無効な `UnitPrice` 値 (-50) を入力した場合の結果を示しています。</span><span class="sxs-lookup"><span data-stu-id="84ace-209">Figure 9 shows a screen shot of this page when omitting the name of the product; Figure 10 shows the results when entering an illegal `UnitPrice` value (-50).</span></span>

<span data-ttu-id="84ace-210">[ProductName BoundField には値が含まれている必要があり ![](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-210">[![The ProductName BoundField Must Contain a Value](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span></span>

<span data-ttu-id="84ace-211">**図 9**: `ProductName` BoundField に値が含まれている必要があります ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-211">**Figure 9**: The `ProductName` BoundField Must Contain a Value ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png))</span></span>

<span data-ttu-id="84ace-212">[![負の UnitPrice 値は使用できません](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-212">[![Negative UnitPrice Values are Not Allowed](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span></span>

<span data-ttu-id="84ace-213">**図 10**: 負の `UnitPrice` 値は使用できません ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-213">**Figure 10**: Negative `UnitPrice` Values are Not Allowed ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png))</span></span>

<span data-ttu-id="84ace-214">`e.ExceptionHandled` プロパティを `true`に設定すると、`RowUpdated` イベントハンドラーによって例外が処理されたことが示されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-214">By setting the `e.ExceptionHandled` property to `true`, the `RowUpdated` event handler has indicated that it has handled the exception.</span></span> <span data-ttu-id="84ace-215">このため、例外は ASP.NET ランタイムに反映されません。</span><span class="sxs-lookup"><span data-stu-id="84ace-215">Therefore, the exception won't propagate up to the ASP.NET runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="84ace-216">図9と10は、ユーザー入力が無効であるために発生した例外を適切に処理する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="84ace-216">Figures 9 and 10 show a graceful way to handle exceptions raised due to invalid user input.</span></span> <span data-ttu-id="84ace-217">ただし、ASP.NET ページでは、`ProductsBLL` クラスの `UpdateProduct` メソッドを呼び出す前に、ユーザーの入力が有効であることを確認する必要があるため、このような無効な入力はビジネスロジックレイヤーには適していません。</span><span class="sxs-lookup"><span data-stu-id="84ace-217">Ideally, though, such invalid input will never reach the Business Logic Layer in the first place, as the ASP.NET page should ensure that the user's inputs are valid before invoking the `ProductsBLL` class's `UpdateProduct` method.</span></span> <span data-ttu-id="84ace-218">次のチュートリアルでは、ビジネスロジック層に送信されるデータがビジネスルールに準拠していることを確認するために、編集および挿入インターフェイスに検証コントロールを追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="84ace-218">In our next tutorial we'll see how to add validation controls to the editing and inserting interfaces to ensure that the data submitted to the Business Logic Layer conforms to the business rules.</span></span> <span data-ttu-id="84ace-219">検証コントロールは、ユーザーが指定したデータが有効になるまで `UpdateProduct` メソッドを呼び出すことができないようにするだけでなく、データ入力の問題を特定するためのより有益なユーザーエクスペリエンスも提供します。</span><span class="sxs-lookup"><span data-stu-id="84ace-219">The validation controls not only prevent the invocation of the `UpdateProduct` method until the user-supplied data is valid, but also provide a more informative user experience for identifying data entry problems.</span></span>

## <a name="step-3-gracefully-handling-bll-level-exceptions"></a><span data-ttu-id="84ace-220">手順 3: BLL レベルの例外を適切に処理する</span><span class="sxs-lookup"><span data-stu-id="84ace-220">Step 3: Gracefully Handling BLL-Level Exceptions</span></span>

<span data-ttu-id="84ace-221">データの挿入、更新、または削除を行う場合、データアクセス層は、データ関連のエラーが発生したときに例外をスローすることがあります。</span><span class="sxs-lookup"><span data-stu-id="84ace-221">When inserting, updating, or deleting data, the Data Access Layer may throw an exception in the face of a data-related error.</span></span> <span data-ttu-id="84ace-222">データベースがオフラインであるか、必要なデータベーステーブル列に値が指定されていないか、テーブルレベルの制約に違反している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="84ace-222">The database may be offline, a required database table column might not have had a value specified, or a table-level constraint may have been violated.</span></span> <span data-ttu-id="84ace-223">ビジネスロジック層では、厳密なデータ関連の例外だけでなく、例外を使用してビジネスルールに違反したことを示すことができます。</span><span class="sxs-lookup"><span data-stu-id="84ace-223">In addition to strictly data-related exceptions, the Business Logic Layer can use exceptions to indicate when business rules have been violated.</span></span> <span data-ttu-id="84ace-224">たとえば、[ビジネスロジック層の作成](../introduction/creating-a-business-logic-layer-cs.md)に関するチュートリアルでは、元の `UpdateProduct` オーバーロードにビジネスルールチェックを追加しました。</span><span class="sxs-lookup"><span data-stu-id="84ace-224">In the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-cs.md) tutorial, for example, we added a business rule check to the original `UpdateProduct` overload.</span></span> <span data-ttu-id="84ace-225">具体的には、ユーザーが製品を廃止済みとしてマークしていた場合、その製品が供給業者によって提供される唯一の製品ではないことが必要でした。</span><span class="sxs-lookup"><span data-stu-id="84ace-225">Specifically, if the user was marking a product as discontinued, we required that the product not be the only one provided by its supplier.</span></span> <span data-ttu-id="84ace-226">この状態に違反した場合は、`ApplicationException` がスローされました。</span><span class="sxs-lookup"><span data-stu-id="84ace-226">If this condition was violated, an `ApplicationException` was thrown.</span></span>

<span data-ttu-id="84ace-227">このチュートリアルで作成した `UpdateProduct` のオーバーロードについては、`UnitPrice` フィールドが元の `UnitPrice` 値の2倍を超える新しい値に設定されることを禁止するビジネスルールを追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="84ace-227">For the `UpdateProduct` overload created in this tutorial, let's add a business rule that prohibits the `UnitPrice` field from being set to a new value that's more than twice the original `UnitPrice` value.</span></span> <span data-ttu-id="84ace-228">これを実現するには、このチェックを実行し、規則に違反した場合に `ApplicationException` をスローするように `UpdateProduct` オーバーロードを調整します。</span><span class="sxs-lookup"><span data-stu-id="84ace-228">To accomplish this, adjust the `UpdateProduct` overload so that it performs this check and throws an `ApplicationException` if the rule is violated.</span></span> <span data-ttu-id="84ace-229">更新されたメソッドは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="84ace-229">The updated method follows:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample6.cs)]

<span data-ttu-id="84ace-230">この変更により、既存の価格の2倍を超える価格更新によって `ApplicationException` がスローされます。</span><span class="sxs-lookup"><span data-stu-id="84ace-230">With this change, any price update that is more than twice the existing price will cause an `ApplicationException` to be thrown.</span></span> <span data-ttu-id="84ace-231">DAL から発生した例外と同様に、この BLL によって生成される `ApplicationException` は、GridView の `RowUpdated` イベントハンドラーで検出および処理できます。</span><span class="sxs-lookup"><span data-stu-id="84ace-231">Just like the exception raised from the DAL, this BLL-raised `ApplicationException` can be detected and handled in the GridView's `RowUpdated` event handler.</span></span> <span data-ttu-id="84ace-232">実際には、書き込まれた `RowUpdated` イベントハンドラーのコードは、この例外を正しく検出し、`ApplicationException`の `Message` プロパティ値を表示します。</span><span class="sxs-lookup"><span data-stu-id="84ace-232">In fact, the `RowUpdated` event handler's code, as written, will correctly detect this exception and display the `ApplicationException`'s `Message` property value.</span></span> <span data-ttu-id="84ace-233">図11は、ユーザーが Chai の価格を $50.00 に更新しようとしたときのスクリーンショットを示しています。これは、現在の $19.95 の価格の2倍を超えています。</span><span class="sxs-lookup"><span data-stu-id="84ace-233">Figure 11 shows a screen shot when a user attempts to update the price of Chai to $50.00, which is more than double its current price of $19.95.</span></span>

<span data-ttu-id="84ace-234">[ビジネスルールによって、製品の2倍以上の価格が適用されない ![](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="84ace-234">[![The Business Rules Disallow Price Increases That More Than Double a Product's Price](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span></span>

<span data-ttu-id="84ace-235">**図 11**: ビジネスルールによって、製品の2倍以上の価格が適用されない場合 ([クリックすると、フルサイズの画像が表示](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png)されます)</span><span class="sxs-lookup"><span data-stu-id="84ace-235">**Figure 11**: The Business Rules Disallow Price Increases That More Than Double a Product's Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png))</span></span>

> [!NOTE]
> <span data-ttu-id="84ace-236">ビジネスロジックルールが `UpdateProduct` メソッドのオーバーロードから共通のメソッドにリファクタリングされるのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="84ace-236">Ideally our business logic rules would be refactored out of the `UpdateProduct` method overloads and into a common method.</span></span> <span data-ttu-id="84ace-237">これは、リーダーの演習として残されています。</span><span class="sxs-lookup"><span data-stu-id="84ace-237">This is left as an exercise for the reader.</span></span>

## <a name="summary"></a><span data-ttu-id="84ace-238">まとめ</span><span class="sxs-lookup"><span data-stu-id="84ace-238">Summary</span></span>

<span data-ttu-id="84ace-239">挿入、更新、削除の各操作では、データ Web コントロールと ObjectDataSource の両方が、実際の操作をもうする前レベルと後レベルのイベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="84ace-239">During inserting, updating, and deleting operations, both the data Web control and the ObjectDataSource involved fire pre- and post-level events that bookend the actual operation.</span></span> <span data-ttu-id="84ace-240">このチュートリアルと前のチュートリアルで説明したように、gridview の `RowUpdating` イベントが発生し、その後に ObjectDataSource の `Updating` イベントが発生します。この時点で、ObjectDataSource の基になるオブジェクトに対して update コマンドが実行されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-240">As we saw in this tutorial and the preceding one, when working with an editable GridView the GridView's `RowUpdating` event fires, followed by the ObjectDataSource's `Updating` event, at which point the update command is made to the ObjectDataSource's underlying object.</span></span> <span data-ttu-id="84ace-241">操作が完了すると、ObjectDataSource の `Updated` イベントが発生し、その後に GridView の `RowUpdated` イベントが続きます。</span><span class="sxs-lookup"><span data-stu-id="84ace-241">After the operation has completed, the ObjectDataSource's `Updated` event fires, followed by the GridView's `RowUpdated` event.</span></span>

<span data-ttu-id="84ace-242">事前レベルのイベントのイベントハンドラーを作成して、操作の結果を検査し、それに対応するために、入力パラメーターまたはポストレベルイベントをカスタマイズすることができます。</span><span class="sxs-lookup"><span data-stu-id="84ace-242">We can create event handlers for the pre-level events in order to customize the input parameters or for the post-level events in order to inspect and respond to the operation's results.</span></span> <span data-ttu-id="84ace-243">Post レベルのイベントハンドラーは、操作中に例外が発生したかどうかを検出するために最もよく使用されます。</span><span class="sxs-lookup"><span data-stu-id="84ace-243">Post-level event handlers are most commonly used to detect whether an exception occurred during the operation.</span></span> <span data-ttu-id="84ace-244">例外が発生した場合、これらのポストレベルのイベントハンドラーは、必要に応じて独自の例外を処理できます。</span><span class="sxs-lookup"><span data-stu-id="84ace-244">In the face of an exception, these post-level event handlers can optionally handle the exception on their own.</span></span> <span data-ttu-id="84ace-245">このチュートリアルでは、わかりやすいエラーメッセージを表示することによって、このような例外を処理する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="84ace-245">In this tutorial we saw how to handle such an exception by displaying a friendly error message.</span></span>

<span data-ttu-id="84ace-246">次のチュートリアルでは、データの書式設定の問題 (負の `UnitPrice`の入力など) によって発生する例外の可能性を軽減する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="84ace-246">In the next tutorial we'll see how to lessen the likelihood of exceptions arising from data formatting issues (such as entering a negative `UnitPrice`).</span></span> <span data-ttu-id="84ace-247">具体的には、編集および挿入インターフェイスに検証コントロールを追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="84ace-247">Specifically, we'll look at how to add validation controls to the editing and inserting interfaces.</span></span>

<span data-ttu-id="84ace-248">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="84ace-248">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="84ace-249">著者について</span><span class="sxs-lookup"><span data-stu-id="84ace-249">About the Author</span></span>

<span data-ttu-id="84ace-250">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="84ace-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="84ace-251">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="84ace-251">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="84ace-252">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="84ace-252">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="84ace-253">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="84ace-253">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="84ace-254">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="84ace-254">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="84ace-255">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="84ace-255">Special Thanks To</span></span>

<span data-ttu-id="84ace-256">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="84ace-256">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="84ace-257">このチュートリアルのリードレビュー担当者は、Liz Shulok でした。</span><span class="sxs-lookup"><span data-stu-id="84ace-257">Lead reviewer for this tutorial was Liz Shulok.</span></span> <span data-ttu-id="84ace-258">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="84ace-258">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="84ace-259">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="84ace-259">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="84ace-260">[前へ](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
> [次へ](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span><span class="sxs-lookup"><span data-stu-id="84ace-260">[Previous](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
[Next](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span></span>
