---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
title: ユーザーに基づいてデータ変更機能を制限C#する () |Microsoft Docs
author: rick-anderson
description: ユーザーがデータを編集できるようにする web アプリケーションでは、ユーザーアカウントごとにデータ編集特権が異なる場合があります。 このチュートリアルでは、次の方法について説明します。
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2b251c82-77cf-4e36-baa9-b648eddaa394
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
msc.type: authoredcontent
ms.openlocfilehash: c3cacaddb7e9b493ba39718f41dcaab360d36fd9
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74580706"
---
# <a name="limiting-data-modification-functionality-based-on-the-user-c"></a><span data-ttu-id="85327-104">ユーザーに基づいてデータ編集機能を制限する (C#)</span><span class="sxs-lookup"><span data-stu-id="85327-104">Limiting Data Modification Functionality Based on the User (C#)</span></span>

<span data-ttu-id="85327-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="85327-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="85327-106">[サンプルアプリのダウンロード](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe)または[PDF のダウンロード](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="85327-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe) or [Download PDF](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span></span>

> <span data-ttu-id="85327-107">ユーザーがデータを編集できるようにする web アプリケーションでは、ユーザーアカウントごとにデータ編集特権が異なる場合があります。</span><span class="sxs-lookup"><span data-stu-id="85327-107">In a web application that allows users to edit data, different user accounts may have different data-editing privileges.</span></span> <span data-ttu-id="85327-108">このチュートリアルでは、訪問しているユーザーに基づいてデータ変更機能を動的に調整する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="85327-108">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span>

## <a name="introduction"></a><span data-ttu-id="85327-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="85327-109">Introduction</span></span>

<span data-ttu-id="85327-110">多くの web アプリケーションは、ユーザーアカウントをサポートし、ログインしているユーザーに基づいてさまざまなオプション、レポート、および機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="85327-110">A number of web applications support user accounts and provide different options, reports, and functionality based on the logged in user.</span></span> <span data-ttu-id="85327-111">たとえば、このチュートリアルでは、サプライヤー企業のユーザーにサイトへのログオンを許可し、その製品に関する一般情報 (たとえば、会社名などのサプライヤー情報と共に) を更新することができます。アドレス、連絡先ユーザーの情報などです。</span><span class="sxs-lookup"><span data-stu-id="85327-111">For example, with our tutorials we might want to allow users from the supplier companies to log on to the site and update general information about their products - their name and quantity per unit, perhaps - along with supplier information, such as their company name, address, the contact person s information, and so on.</span></span> <span data-ttu-id="85327-112">さらに、会社のユーザーのために、在庫の単位や並べ替えレベルなどの製品情報にログオンして更新できるユーザーアカウントを追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="85327-112">Furthermore, we might want to include some user accounts for people from our company so that they can log on and update product information like units on stock, reorder level, and so forth.</span></span> <span data-ttu-id="85327-113">Web アプリケーションでは、匿名ユーザーがアクセスできるようにすることもできますが (ログオンしていないユーザー)、データの表示のみに制限することがあります。</span><span class="sxs-lookup"><span data-stu-id="85327-113">Our web application might also allow anonymous users to visit (people who have not logged on), but would limit them to just viewing data.</span></span> <span data-ttu-id="85327-114">このようなユーザーアカウントシステムを使用して、ASP.NET ページのデータ Web コントロールで、現在ログオンしているユーザーに適した挿入、編集、および削除の機能を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-114">With such a user account system in place, we would want the data Web controls in our ASP.NET pages to offer the inserting, editing, and deleting capabilities appropriate for the currently logged on user.</span></span>

<span data-ttu-id="85327-115">このチュートリアルでは、訪問しているユーザーに基づいてデータ変更機能を動的に調整する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="85327-115">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span> <span data-ttu-id="85327-116">特に、編集可能な DetailsView の仕入先情報と、業者によって提供される製品を一覧表示する GridView を表示するページを作成します。</span><span class="sxs-lookup"><span data-stu-id="85327-116">In particular, we'll create a page that displays the suppliers information in an editable DetailsView along with a GridView that lists the products provided by the supplier.</span></span> <span data-ttu-id="85327-117">ページにアクセスしているユーザーが会社からのものである場合、仕入先の情報を表示できます。アドレスを編集します。仕入先から提供される製品の情報を編集します。</span><span class="sxs-lookup"><span data-stu-id="85327-117">If the user visiting the page is from our company, they can: view any supplier s information; edit their address; and edit the information for any product provided by the supplier.</span></span> <span data-ttu-id="85327-118">ただし、ユーザーが特定の会社からのものである場合は、自分の住所情報を表示および編集するだけで、廃止済みとしてマークされていない製品のみを編集することができます。</span><span class="sxs-lookup"><span data-stu-id="85327-118">If, however, the user is from a particular company, they can only view and edit their own address information and can only edit their products that have not been marked as discontinued.</span></span>

<span data-ttu-id="85327-119">[会社のユーザーが仕入先の情報を編集できる ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="85327-119">[![A User from Our Company Can Edit Any Supplier s Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span></span>

<span data-ttu-id="85327-120">**図 1**: 会社のユーザーが仕入先の情報を編集できる ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-120">**Figure 1**: A User from Our Company Can Edit Any Supplier s Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png))</span></span>

<span data-ttu-id="85327-121">[特定の業者からのユーザー ![、その情報の表示と編集のみを行うことができます](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="85327-121">[![A User from a Particular Supplier Can Only View and Edit their Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span></span>

<span data-ttu-id="85327-122">**図 2**: 特定の業者のユーザーが自分の情報を表示および編集することはできません ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-122">**Figure 2**: A User from a Particular Supplier Can Only View and Edit their Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png))</span></span>

<span data-ttu-id="85327-123">始めましょう!</span><span class="sxs-lookup"><span data-stu-id="85327-123">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="85327-124">ASP.NET 2.0 s メンバーシップシステムは、ユーザーアカウントを作成、管理、および検証するための、標準化された拡張可能なプラットフォームを提供します。</span><span class="sxs-lookup"><span data-stu-id="85327-124">ASP.NET 2.0 s membership system provides a standardized, extensible platform for creating, managing, and validating user accounts.</span></span> <span data-ttu-id="85327-125">メンバーシップシステムの検査はこれらのチュートリアルの範囲を超えているため、このチュートリアルでは、匿名の訪問者が特定の業者または会社のどちらからのものかを選択できるようにすることで、メンバーシップを "フェイク" します。</span><span class="sxs-lookup"><span data-stu-id="85327-125">Since an examination of the membership system is beyond the scope of these tutorials, this tutorial instead "fakes" membership by allowing anonymous visitors to choose whether they are from a particular supplier or from our company.</span></span> <span data-ttu-id="85327-126">メンバーシップの詳細については、 [ASP.NET 2.0 s のメンバーシップ、ロール、およびプロファイル](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)に関する記事シリーズを参照してください。</span><span class="sxs-lookup"><span data-stu-id="85327-126">For more on membership, refer to my [Examining ASP.NET 2.0 s Membership, Roles, and Profile](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx) article series.</span></span>

## <a name="step-1-allowing-the-user-to-specify-their-access-rights"></a><span data-ttu-id="85327-127">手順 1: ユーザーが自分のアクセス権を指定できるようにする</span><span class="sxs-lookup"><span data-stu-id="85327-127">Step 1: Allowing the User to Specify their Access Rights</span></span>

<span data-ttu-id="85327-128">実際の web アプリケーションでは、ユーザーが会社で働いているか、特定の業者に勤務しているかがユーザーのアカウント情報に含まれており、ユーザーがサイトにログオンした後、ASP.NET のページからこの情報にプログラムからアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="85327-128">In a real-world web application, a user s account information would include whether they worked for our company or for a particular supplier, and this information would be programmatically accessible from our ASP.NET pages once the user has logged on to the site.</span></span> <span data-ttu-id="85327-129">この情報は、ASP.NET 2.0 s ロールシステムを通じて、プロファイルシステムを通じてユーザーレベルのアカウント情報として、またはカスタム手段を通じてキャプチャできます。</span><span class="sxs-lookup"><span data-stu-id="85327-129">This information could be captured through ASP.NET 2.0 s roles system, as user-level account information through the profile system, or through some custom means.</span></span>

<span data-ttu-id="85327-130">このチュートリアルの目的は、ログオンしたユーザーに基づいてデータ変更機能を調整することであり、ASP.NET 2.0 のメンバーシップ、役割、およびプロファイルシステムを示すことを目的としたものではないため、非常に単純なメカニズムを使用して、ページにアクセスするユーザーのための機能-ユーザーがサプライヤー情報を表示および編集できるようにする必要があるかどうか、または、表示および編集が可能な特定の仕入先情報を指定できます。</span><span class="sxs-lookup"><span data-stu-id="85327-130">Since the aim of this tutorial is to demonstrate adjusting the data modification capabilities based on the logged on user, and is not meant to showcase ASP.NET 2.0 s membership, roles, and profile systems, we'll use a very simply mechanism to determine the capabilities for the user visiting the page - a DropDownList from which the user can indicate if they should be able to view and edit any of the suppliers information or, alternatively, what particular supplier s information they can view and edit.</span></span> <span data-ttu-id="85327-131">ユーザーがすべての仕入先情報を表示および編集できることを示している場合 (既定)、すべての業者に対してページを表示し、仕入先の住所情報を編集して、選択した業者によって提供される任意の製品の名前と数量を編集することができます。</span><span class="sxs-lookup"><span data-stu-id="85327-131">If the user indicates that she can view and edit all supplier information (the default), she can page through all suppliers, edit any supplier s address information, and edit the name and quantity per unit for any product provided by the selected supplier.</span></span> <span data-ttu-id="85327-132">ただし、ユーザーが特定の業者を表示および編集するだけであることを示している場合は、その仕入先の詳細と製品のみを表示できます。また、提供が中止されて*いない*製品の名前と数量ごとの情報のみを更新できます。</span><span class="sxs-lookup"><span data-stu-id="85327-132">If the user indicates that she can only view and edit a particular supplier, however, then she can only view the details and products for that one supplier and can only update the name and quantity per unit information for those products that are *not* discontinued.</span></span>

<span data-ttu-id="85327-133">このチュートリアルの最初の手順として、この DropDownList を作成し、システムのサプライヤーを設定します。</span><span class="sxs-lookup"><span data-stu-id="85327-133">Our first step in this tutorial, then, is to create this DropDownList and populate it with the suppliers in the system.</span></span> <span data-ttu-id="85327-134">`EditInsertDelete` フォルダーの [`UserLevelAccess.aspx`] ページを開き、`ID` プロパティが [`Suppliers`] に設定されている DropDownList を追加し、この DropDownList を `AllSuppliersDataSource`という名前の新しい ObjectDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="85327-134">Open the `UserLevelAccess.aspx` page in the `EditInsertDelete` folder, add a DropDownList whose `ID` property is set to `Suppliers`, and bind this DropDownList to a new ObjectDataSource named `AllSuppliersDataSource`.</span></span>

<span data-ttu-id="85327-135">[AllSuppliersDataSource という名前の新しい ObjectDataSource を作成 ![には](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="85327-135">[![Create a New ObjectDataSource Named AllSuppliersDataSource](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span></span>

<span data-ttu-id="85327-136">**図 3**: `AllSuppliersDataSource` という名前の新しい ObjectDataSource を作成[する (クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png)される)</span><span class="sxs-lookup"><span data-stu-id="85327-136">**Figure 3**: Create a New ObjectDataSource Named `AllSuppliersDataSource` ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png))</span></span>

<span data-ttu-id="85327-137">この DropDownList にすべての業者を含めるようにするため、`SuppliersBLL` クラス s `GetSuppliers()` メソッドを呼び出すように ObjectDataSource を構成します。</span><span class="sxs-lookup"><span data-stu-id="85327-137">Since we want this DropDownList to include all suppliers, configure the ObjectDataSource to invoke the `SuppliersBLL` class s `GetSuppliers()` method.</span></span> <span data-ttu-id="85327-138">また、ObjectDataSource s `Update()` メソッドが `SuppliersBLL` クラス s `UpdateSupplierAddress` メソッドにマップされていることを確認します。この ObjectDataSource は、手順 2. で追加する DetailsView によっても使用されるためです。</span><span class="sxs-lookup"><span data-stu-id="85327-138">Also ensure that the ObjectDataSource s `Update()` method is mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method, as this ObjectDataSource will also be used by the DetailsView we'll be adding in Step 2.</span></span>

<span data-ttu-id="85327-139">ObjectDataSource ウィザードの完了後、`CompanyName` データフィールドが表示されるように `Suppliers` DropDownList を構成して、各 `ListItem`の値として `SupplierID` データフィールドを使用するように、ステップを完了します。</span><span class="sxs-lookup"><span data-stu-id="85327-139">After completing the ObjectDataSource wizard, complete the steps by configuring the `Suppliers` DropDownList such that it shows the `CompanyName` data field and uses the `SupplierID` data field as the value for each `ListItem`.</span></span>

<span data-ttu-id="85327-140">[仕入先の DropDownList が CompanyName および仕入先のデータフィールドを使用するように構成 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="85327-140">[![Configure the Suppliers DropDownList to Use the CompanyName and SupplierID Data Fields](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span></span>

<span data-ttu-id="85327-141">**図 4**: `CompanyName` と `SupplierID` のデータフィールドを使用するように `Suppliers` DropDownList を構成する ([クリックしてフルサイズの画像を表示する](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="85327-141">**Figure 4**: Configure the `Suppliers` DropDownList to Use the `CompanyName` and `SupplierID` Data Fields ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png))</span></span>

<span data-ttu-id="85327-142">この時点で、データベース内の仕入先の会社名が一覧表示されます。</span><span class="sxs-lookup"><span data-stu-id="85327-142">At this point, the DropDownList lists the company names of the suppliers in the database.</span></span> <span data-ttu-id="85327-143">ただし、DropDownList に [すべての仕入先を表示/編集] オプションを含める必要もあります。</span><span class="sxs-lookup"><span data-stu-id="85327-143">However, we also need to include a "Show/Edit ALL Suppliers" option to the DropDownList.</span></span> <span data-ttu-id="85327-144">これを行うには、`Suppliers` DropDownList s `AppendDataBoundItems` プロパティを `true` に設定してから、`Text` プロパティが "すべての仕入先の表示/編集" で、値が `-1`である `ListItem` を追加します。</span><span class="sxs-lookup"><span data-stu-id="85327-144">To accomplish this, set the `Suppliers` DropDownList s `AppendDataBoundItems` property to `true` and then add a `ListItem` whose `Text` property is "Show/Edit ALL Suppliers" and whose value is `-1`.</span></span> <span data-ttu-id="85327-145">これは、宣言マークアップまたはデザイナーを使用して直接追加できます。そのためには、プロパティウィンドウに移動し、DropDownList s `Items` プロパティの省略記号をクリックします。</span><span class="sxs-lookup"><span data-stu-id="85327-145">This can be added directly through the declarative markup or through the Designer by going to the Properties window and clicking on the ellipses in the DropDownList s `Items` property.</span></span>

> [!NOTE]
> <span data-ttu-id="85327-146">[すべて選択] 項目をデータバインド DropDownList に追加する方法の詳細については、「DropDownList チュートリアルを使用した[*マスター/詳細のフィルター処理*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="85327-146">Refer back to the [*Master/Detail Filtering With a DropDownList*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md) tutorial for a more detailed discussion on adding a Select All item to a databound DropDownList.</span></span>

<span data-ttu-id="85327-147">`AppendDataBoundItems` プロパティが設定され、`ListItem` が追加されると、DropDownList の宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="85327-147">After the `AppendDataBoundItems` property has been set and the `ListItem` added, the DropDownList s declarative markup should look like:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample1.aspx)]

<span data-ttu-id="85327-148">図5に、ブラウザーで表示したときの現在の進行状況のスクリーンショットを示します。</span><span class="sxs-lookup"><span data-stu-id="85327-148">Figure 5 shows a screen shot of our current progress, when viewed through a browser.</span></span>

<span data-ttu-id="85327-149">[仕入先の DropDownList に [すべてのアイテムの表示] と、仕入先ごとに1つの ![が含まれている](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="85327-149">[![The Suppliers DropDownList Contains a Show ALL ListItem, Plus One for Each Supplier](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span></span>

<span data-ttu-id="85327-150">**図 5**: `Suppliers` DropDownList には、各仕入先に1つずつ、[すべて表示] `ListItem`が含まれます ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-150">**Figure 5**: The `Suppliers` DropDownList Contains a Show ALL `ListItem`, Plus One for Each Supplier ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png))</span></span>

<span data-ttu-id="85327-151">ユーザーが選択内容を変更した直後にユーザーインターフェイスを更新する必要があるため、`Suppliers` DropDownList s `AutoPostBack` プロパティを `true`に設定します。</span><span class="sxs-lookup"><span data-stu-id="85327-151">Since we want to update the user interface immediately after the user has changed their selection, set the `Suppliers` DropDownList s `AutoPostBack` property to `true`.</span></span> <span data-ttu-id="85327-152">手順 2. では、DropDownList の選択に基づいて仕入先の情報を表示する DetailsView コントロールを作成します。</span><span class="sxs-lookup"><span data-stu-id="85327-152">In Step 2 we'll create a DetailsView control that will show the information for the supplier(s) based on the DropDownList selection.</span></span> <span data-ttu-id="85327-153">次に、手順3で、この DropDownList `SelectedIndexChanged` イベントのイベントハンドラーを作成します。ここでは、選択した業者に基づいて、適切な仕入先情報を DetailsView にバインドするコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="85327-153">Then, in Step 3, we'll create an event handler for this DropDownList s `SelectedIndexChanged` event, in which we'll add code that binds the appropriate supplier information to the DetailsView based upon the selected supplier.</span></span>

## <a name="step-2-adding-a-detailsview-control"></a><span data-ttu-id="85327-154">手順 2: DetailsView コントロールの追加</span><span class="sxs-lookup"><span data-stu-id="85327-154">Step 2: Adding a DetailsView Control</span></span>

<span data-ttu-id="85327-155">ここでは、DetailsView を使用して仕入先情報を表示します。</span><span class="sxs-lookup"><span data-stu-id="85327-155">Let s use a DetailsView to show supplier information.</span></span> <span data-ttu-id="85327-156">すべての業者を表示および編集できるユーザーに対して、DetailsView はページングをサポートします。これにより、ユーザーは一度に1レコードずつ業者情報をステップ実行できます。</span><span class="sxs-lookup"><span data-stu-id="85327-156">For the user who can view and edit all suppliers, the DetailsView will support paging, allowing the user to step through the supplier information one record at a time.</span></span> <span data-ttu-id="85327-157">ただし、ユーザーが特定の業者に対して作業する場合、DetailsView には特定の供給業者の情報のみが表示され、ページングインターフェイスは含まれません。</span><span class="sxs-lookup"><span data-stu-id="85327-157">If the user works for a particular supplier, however, the DetailsView will show only that particular supplier s information and will not include a paging interface.</span></span> <span data-ttu-id="85327-158">どちらの場合も、DetailsView は、ユーザーが仕入先の住所、市区町村、および国のフィールドを編集できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-158">In either case, the DetailsView needs to allow the user to edit the supplier s address, city, and country fields.</span></span>

<span data-ttu-id="85327-159">DetailsView を `Suppliers` DropDownList の下のページに追加し、その `ID` プロパティを `SupplierDetails`に設定して、前の手順で作成した `AllSuppliersDataSource` ObjectDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="85327-159">Add a DetailsView to the page beneath the `Suppliers` DropDownList, set its `ID` property to `SupplierDetails`, and bind it to the `AllSuppliersDataSource` ObjectDataSource created in the previous step.</span></span> <span data-ttu-id="85327-160">次に、[ページングを有効にする] チェックボックスをオンにし、DetailsView s スマートタグから編集チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="85327-160">Next, check the Enable Paging and Enable Editing checkboxes from the DetailsView s smart tag.</span></span>

> [!NOTE]
> <span data-ttu-id="85327-161">DetailsView s スマートタグに [編集を有効にする] オプションが表示されない場合は、ObjectDataSource s `Update()` メソッドを `SuppliersBLL` クラス s `UpdateSupplierAddress` メソッドにマップしていないためです。</span><span class="sxs-lookup"><span data-stu-id="85327-161">If you don t see an Enable Editing option in the DetailsView s smart tag it s because you did not map the ObjectDataSource s `Update()` method to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span> <span data-ttu-id="85327-162">前に戻ってこの構成を変更してください。その後、[編集を有効にする] オプションが DetailsView s スマートタグに表示されます。</span><span class="sxs-lookup"><span data-stu-id="85327-162">Take a moment to go back and make this configuration change, after which the Enable Editing option should appear in the DetailsView s smart tag.</span></span>

<span data-ttu-id="85327-163">`SuppliersBLL` クラス s `UpdateSupplierAddress` メソッドは、`supplierID`、`address`、`city`、および `country` の4つのパラメーターのみを受け入れるため、`CompanyName` と `Phone` BoundFields が読み取り専用になるように DetailsView の BoundFields を変更します。</span><span class="sxs-lookup"><span data-stu-id="85327-163">Since the `SuppliersBLL` class s `UpdateSupplierAddress` method only accepts four parameters - `supplierID`, `address`, `city`, and `country` - modify the DetailsView s BoundFields so that the `CompanyName` and `Phone` BoundFields are read-only.</span></span> <span data-ttu-id="85327-164">さらに、`SupplierID` BoundField を完全に削除します。</span><span class="sxs-lookup"><span data-stu-id="85327-164">Additionally, remove the `SupplierID` BoundField altogether.</span></span> <span data-ttu-id="85327-165">最後に、`AllSuppliersDataSource` ObjectDataSource の `OldValuesParameterFormatString` プロパティは `original_{0}`に設定されています。</span><span class="sxs-lookup"><span data-stu-id="85327-165">Finally, the `AllSuppliersDataSource` ObjectDataSource currently has its `OldValuesParameterFormatString` property set to `original_{0}`.</span></span> <span data-ttu-id="85327-166">このプロパティ設定を宣言構文から完全に削除するか、既定値の `{0}`に設定してください。</span><span class="sxs-lookup"><span data-stu-id="85327-166">Take a moment to remove this property setting from the declarative syntax altogether, or set it to the default value, `{0}`.</span></span>

<span data-ttu-id="85327-167">`SupplierDetails` の DetailsView と `AllSuppliersDataSource` ObjectDataSource を構成した後、次の宣言型マークアップがあります。</span><span class="sxs-lookup"><span data-stu-id="85327-167">After configuring the `SupplierDetails` DetailsView and `AllSuppliersDataSource` ObjectDataSource, we will have the following declarative markup:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample2.aspx)]

<span data-ttu-id="85327-168">この時点で、DetailsView はページスルーでき、選択した業者のアドレス情報は、`Suppliers` DropDownList での選択に関係なく更新できます (図6を参照)。</span><span class="sxs-lookup"><span data-stu-id="85327-168">At this point the DetailsView can be paged through and the selected supplier s address information can be updated, regardless of the selection made in the `Suppliers` DropDownList (see Figure 6).</span></span>

<span data-ttu-id="85327-169">[![は、すべてのサプライヤー情報を表示し、そのアドレスを更新することができます。](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="85327-169">[![Any Suppliers Information Can Be Viewed, and Its Address Updated](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span></span>

<span data-ttu-id="85327-170">**図 6**: 任意の仕入先情報を表示し、そのアドレスを更新する ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-170">**Figure 6**: Any Suppliers Information Can Be Viewed, and Its Address Updated ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png))</span></span>

## <a name="step-3-displaying-only-the-selected-supplier-s-information"></a><span data-ttu-id="85327-171">手順 3: 選択した仕入先の情報のみを表示する</span><span class="sxs-lookup"><span data-stu-id="85327-171">Step 3: Displaying Only the Selected Supplier s Information</span></span>

<span data-ttu-id="85327-172">現在のページには、特定の供給業者が `Suppliers` DropDownList から選択されているかどうかに関係なく、すべての業者の情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="85327-172">Our page currently displays the information for all suppliers regardless of whether a particular supplier has been selected from the `Suppliers` DropDownList.</span></span> <span data-ttu-id="85327-173">選択した業者の仕入先情報だけを表示するには、別の ObjectDataSource をページに追加する必要があります。1つは特定の業者に関する情報を取得するためのものです。</span><span class="sxs-lookup"><span data-stu-id="85327-173">In order to display just the supplier information for the selected supplier we need to add another ObjectDataSource to our page, one that retrieves information about a particular supplier.</span></span>

<span data-ttu-id="85327-174">新しい ObjectDataSource をページに追加し、`SingleSupplierDataSource`名前を付けます。</span><span class="sxs-lookup"><span data-stu-id="85327-174">Add a new ObjectDataSource to the page, naming it `SingleSupplierDataSource`.</span></span> <span data-ttu-id="85327-175">そのスマートタグから、[データソースの構成] リンクをクリックし、`SuppliersBLL` クラスの `GetSupplierBySupplierID(supplierID)` 方法を使用します。</span><span class="sxs-lookup"><span data-stu-id="85327-175">From its smart tag, click the Configure Data Source link and have it use the `SuppliersBLL` class s `GetSupplierBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="85327-176">`AllSuppliersDataSource` ObjectDataSource と同様に、`SingleSupplierDataSource` ObjectDataSource s `Update()` メソッドを `SuppliersBLL` クラス s `UpdateSupplierAddress` メソッドにマップします。</span><span class="sxs-lookup"><span data-stu-id="85327-176">As with the `AllSuppliersDataSource` ObjectDataSource, have the `SingleSupplierDataSource` ObjectDataSource s `Update()` method mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span>

<span data-ttu-id="85327-177">[SingleSupplierDataSource ObjectDataSource が GetSupplierBySupplierID (仕入先) メソッドを使用するように構成 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="85327-177">[![Configure the SingleSupplierDataSource ObjectDataSource to Use the GetSupplierBySupplierID(supplierID) Method](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span></span>

<span data-ttu-id="85327-178">**図 7**: `GetSupplierBySupplierID(supplierID)` メソッドを使用するように `SingleSupplierDataSource` ObjectDataSource を構成する ([クリックしてフルサイズのイメージを表示する](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="85327-178">**Figure 7**: Configure the `SingleSupplierDataSource` ObjectDataSource to Use the `GetSupplierBySupplierID(supplierID)` Method ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png))</span></span>

<span data-ttu-id="85327-179">次に、`GetSupplierBySupplierID(supplierID)` メソッド s `supplierID` 入力パラメーターのパラメーターソースを指定するように求められます。</span><span class="sxs-lookup"><span data-stu-id="85327-179">Next, we re prompted to specify the parameter source for the `GetSupplierBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="85327-180">DropDownList から選択された業者の情報を表示するため、`Suppliers` DropDownList s `SelectedValue` プロパティをパラメーターソースとして使用します。</span><span class="sxs-lookup"><span data-stu-id="85327-180">Since we want to show the information for the supplier selected from the DropDownList, use the `Suppliers` DropDownList s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="85327-181">[仕入先の DropDownList を仕入先パラメーターのソースとして使用 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="85327-181">[![Use the Suppliers DropDownList as the supplierID Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span></span>

<span data-ttu-id="85327-182">**図 8**: `Suppliers` DropDownList を `supplierID` パラメーターソースとして使用する ([クリックしてフルサイズのイメージを表示する](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="85327-182">**Figure 8**: Use the `Suppliers` DropDownList as the `supplierID` Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png))</span></span>

<span data-ttu-id="85327-183">この2番目の ObjectDataSource を追加した場合でも、現在、DetailsView コントロールは `AllSuppliersDataSource` ObjectDataSource を常に使用するように構成されています。</span><span class="sxs-lookup"><span data-stu-id="85327-183">Even with this second ObjectDataSource added, the DetailsView control is currently configured to always use the `AllSuppliersDataSource` ObjectDataSource.</span></span> <span data-ttu-id="85327-184">選択した `Suppliers` の DropDownList 項目に応じて、DetailsView によって使用されるデータソースを調整するロジックを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-184">We need to add logic to adjust the data source used by the DetailsView depending on the `Suppliers` DropDownList item selected.</span></span> <span data-ttu-id="85327-185">これを実現するには、仕入先の DropDownList の `SelectedIndexChanged` イベントハンドラーを作成します。</span><span class="sxs-lookup"><span data-stu-id="85327-185">To accomplish this, create a `SelectedIndexChanged` event handler for the Suppliers DropDownList.</span></span> <span data-ttu-id="85327-186">これは、デザイナーで DropDownList をダブルクリックすることで、最も簡単に作成できます。</span><span class="sxs-lookup"><span data-stu-id="85327-186">This can most easily be created by double-clicking the DropDownList in the Designer.</span></span> <span data-ttu-id="85327-187">このイベントハンドラーは、使用するデータソースを決定し、データを DetailsView に再バインドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-187">This event handler needs to determine what data source to use and must rebind the data to the DetailsView.</span></span> <span data-ttu-id="85327-188">これは、次のコードを使用して行います。</span><span class="sxs-lookup"><span data-stu-id="85327-188">This is accomplished with the following code:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample3.cs)]

<span data-ttu-id="85327-189">イベントハンドラーは、[すべての仕入先を表示/編集] オプションが選択されているかどうかを判断することから始まります。</span><span class="sxs-lookup"><span data-stu-id="85327-189">The event handler begins by determining whether the "Show/Edit ALL Suppliers" option was selected.</span></span> <span data-ttu-id="85327-190">含まれている場合は、`SupplierDetails` DetailsView s `DataSourceID` を `AllSuppliersDataSource` に設定し、`PageIndex` プロパティを0に設定して、ユーザーを一連のサプライヤーの最初のレコードに返します。</span><span class="sxs-lookup"><span data-stu-id="85327-190">If it was, it sets the `SupplierDetails` DetailsView s `DataSourceID` to `AllSuppliersDataSource` and returns the user to the first record in the set of suppliers by setting the `PageIndex` property to 0.</span></span> <span data-ttu-id="85327-191">ただし、ユーザーが DropDownList から特定の供給業者を選択している場合は、DetailsView s `DataSourceID` が `SingleSuppliersDataSource`に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="85327-191">If, however, the user has selected a particular supplier from the DropDownList, the DetailsView s `DataSourceID` is assigned to `SingleSuppliersDataSource`.</span></span> <span data-ttu-id="85327-192">使用されるデータソースに関係なく、`SuppliersDetails` モードは読み取り専用モードに戻され、`SuppliersDetails` コントロール s `DataBind()` メソッドの呼び出しによってデータが DetailsView に再バインドされます。</span><span class="sxs-lookup"><span data-stu-id="85327-192">Regardless of what data source is used, the `SuppliersDetails` mode is reverted back to the read-only mode and the data is rebound to the DetailsView by a call to the `SuppliersDetails` control s `DataBind()` method.</span></span>

<span data-ttu-id="85327-193">このイベントハンドラーを配置すると、[すべての仕入先を表示/編集] オプションが選択されていない限り、DetailsView コントロールは選択された業者を表示するようになります。この場合、すべてのサプライヤーがページングインターフェイスを通じて表示されます。</span><span class="sxs-lookup"><span data-stu-id="85327-193">With this event handler in place, the DetailsView control now shows the selected supplier, unless the "Show/Edit ALL Suppliers" option was selected, in which case all of the suppliers can be viewed through the paging interface.</span></span> <span data-ttu-id="85327-194">図9に、[すべての仕入先を表示/編集] オプションが選択されているページを示します。ページングインターフェイスが存在し、ユーザーが任意の業者にアクセスして更新できることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="85327-194">Figure 9 shows the page with the "Show/Edit ALL Suppliers" option selected; note that the paging interface is present, allowing the user to visit and update any supplier.</span></span> <span data-ttu-id="85327-195">図10は、Ma Maison supplier が選択されているページを示しています。</span><span class="sxs-lookup"><span data-stu-id="85327-195">Figure 10 shows the page with the Ma Maison supplier selected.</span></span> <span data-ttu-id="85327-196">この場合、Ma Maison s 情報のみが表示および編集できます。</span><span class="sxs-lookup"><span data-stu-id="85327-196">Only Ma Maison s information is viewable and editable in this case.</span></span>

<span data-ttu-id="85327-197">[すべての仕入先情報を表示および編集できる ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="85327-197">[![All of the Suppliers Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span></span>

<span data-ttu-id="85327-198">**図 9**: すべての仕入先情報を表示および編集できる ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-198">**Figure 9**: All of the Suppliers Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png))</span></span>

<span data-ttu-id="85327-199">[選択した仕入先の情報のみを表示および編集できる ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="85327-199">[![Only the Selected Supplier s Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span></span>

<span data-ttu-id="85327-200">**図 10**: 選択した仕入先の情報のみを表示および編集できます ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-200">**Figure 10**: Only the Selected Supplier s Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png))</span></span>

> [!NOTE]
> <span data-ttu-id="85327-201">このチュートリアルでは、dropdownlist および DetailsView コントロール s `EnableViewState` を `true` (既定) に設定する必要があります。これは、DropDownList の `SelectedIndex` および DetailsView s `DataSourceID` プロパティの変更をポストバック間で記録する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="85327-201">For this tutorial, both the DropDownList and DetailsView control s `EnableViewState` must be set to `true` (the default) because the DropDownList s `SelectedIndex` and the DetailsView s `DataSourceID` property s changes must be remembered across postbacks.</span></span>

## <a name="step-4-listing-the-suppliers-products-in-an-editable-gridview"></a><span data-ttu-id="85327-202">手順 4: 編集可能な GridView で仕入先製品を一覧表示する</span><span class="sxs-lookup"><span data-stu-id="85327-202">Step 4: Listing the Suppliers Products in an Editable GridView</span></span>

<span data-ttu-id="85327-203">DetailsView が完了したら、次の手順として、選択した業者によって提供される製品を一覧表示する編集可能な GridView を含めます。</span><span class="sxs-lookup"><span data-stu-id="85327-203">With the DetailsView complete, our next step is to include an editable GridView that lists those products provided by the selected supplier.</span></span> <span data-ttu-id="85327-204">この GridView では、`ProductName` フィールドと `QuantityPerUnit` フィールドだけを編集できます。</span><span class="sxs-lookup"><span data-stu-id="85327-204">This GridView should allow edits to only the `ProductName` and `QuantityPerUnit` fields.</span></span> <span data-ttu-id="85327-205">さらに、ページにアクセスしているユーザーが特定の業者からのものである場合は、提供が中止されて*いない*製品の更新のみを許可する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-205">Moreover, if the user visiting the page is from a particular supplier, it should only allow updates to those products that are *not* discontinued.</span></span> <span data-ttu-id="85327-206">これを実現するには、最初に、`ProductID`、`ProductName`、および `QuantityPerUnit` のフィールドだけを入力として受け取る `ProductsBLL` クラス s `UpdateProducts` メソッドのオーバーロードを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-206">To accomplish this we'll need to first add an overload of the `ProductsBLL` class s `UpdateProducts` method that takes in just the `ProductID`, `ProductName`, and `QuantityPerUnit` fields as inputs.</span></span> <span data-ttu-id="85327-207">このプロセスは、多くのチュートリアルで事前に段階的に説明したので、次のコードを見てみましょう。 `ProductsBLL`に追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-207">We ve stepped through this process beforehand in numerous tutorials, so let s just look at the code here, which should be added to `ProductsBLL`:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample4.cs)]

<span data-ttu-id="85327-208">このオーバーロードを作成したので、GridView コントロールとそれに関連付けられた ObjectDataSource を追加する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="85327-208">With this overload created, we re ready to add the GridView control and its associated ObjectDataSource.</span></span> <span data-ttu-id="85327-209">新しい GridView をページに追加し、その `ID` プロパティを `ProductsBySupplier`に設定して、`ProductsBySupplierDataSource`という名前の新しい ObjectDataSource を使用するように構成します。</span><span class="sxs-lookup"><span data-stu-id="85327-209">Add a new GridView to the page, set its `ID` property to `ProductsBySupplier`, and configure it to use a new ObjectDataSource named `ProductsBySupplierDataSource`.</span></span> <span data-ttu-id="85327-210">この GridView では、選択した業者によってこれらの製品が一覧表示されるようにするため、`ProductsBLL` クラス s `GetProductsBySupplierID(supplierID)` メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="85327-210">Since we want this GridView to list those products by the selected supplier, use the `ProductsBLL` class s `GetProductsBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="85327-211">また、`Update()` メソッドを、先ほど作成した新しい `UpdateProduct` オーバーロードにマップします。</span><span class="sxs-lookup"><span data-stu-id="85327-211">Also map the `Update()` method to the new `UpdateProduct` overload we just created.</span></span>

<span data-ttu-id="85327-212">[作成したばかりの UpdateProduct オーバーロードを使用するように ObjectDataSource を構成 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="85327-212">[![Configure the ObjectDataSource to Use the UpdateProduct Overload Just Created](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span></span>

<span data-ttu-id="85327-213">**図 11**: 作成した `UpdateProduct` のオーバーロードを使用するように ObjectDataSource を構成する ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-213">**Figure 11**: Configure the ObjectDataSource to Use the `UpdateProduct` Overload Just Created ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png))</span></span>

<span data-ttu-id="85327-214">`GetProductsBySupplierID(supplierID)` メソッド s `supplierID` 入力パラメーターのパラメーターソースを選択するように求められます。</span><span class="sxs-lookup"><span data-stu-id="85327-214">We re prompted to select the parameter source for the `GetProductsBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="85327-215">DetailsView で選択された業者の製品を表示するため、`SuppliersDetails` DetailsView コントロール s `SelectedValue` プロパティをパラメーターソースとして使用します。</span><span class="sxs-lookup"><span data-stu-id="85327-215">Since we want to show the products for the supplier selected in the DetailsView, use the `SuppliersDetails` DetailsView control s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="85327-216">[SuppliersDetails DetailsView s SelectedValue プロパティをパラメーターソースとして使用 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="85327-216">[![Use the SuppliersDetails DetailsView s SelectedValue Property as the Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span></span>

<span data-ttu-id="85327-217">**図 12**: `SuppliersDetails` DetailsView s `SelectedValue` プロパティをパラメーターソースとして使用する ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-217">**Figure 12**: Use the `SuppliersDetails` DetailsView s `SelectedValue` Property as the Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png))</span></span>

<span data-ttu-id="85327-218">GridView に戻り、`ProductName`、`QuantityPerUnit`、および `Discontinued`を除くすべての GridView フィールドを削除し、`Discontinued` CheckBoxField を読み取り専用としてマークします。</span><span class="sxs-lookup"><span data-stu-id="85327-218">Returning to the GridView, remove all of the GridView fields except for `ProductName`, `QuantityPerUnit`, and `Discontinued`, marking the `Discontinued` CheckBoxField as read-only.</span></span> <span data-ttu-id="85327-219">また、GridView s スマートタグの [編集を有効にする] オプションをオンにします。</span><span class="sxs-lookup"><span data-stu-id="85327-219">Also, check the Enable Editing option from the GridView s smart tag.</span></span> <span data-ttu-id="85327-220">これらの変更が行われると、GridView および ObjectDataSource の宣言型マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="85327-220">After these changes have been made, the declarative markup for the GridView and ObjectDataSource should look similar to the following:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample5.aspx)]

<span data-ttu-id="85327-221">以前の ObjectDataSources ソースと同様に、この1つの `OldValuesParameterFormatString` プロパティは `original_{0}`に設定されています。これにより、製品名またはユニットあたりの数量を更新しようとしたときに問題が発生します。</span><span class="sxs-lookup"><span data-stu-id="85327-221">As with our previous ObjectDataSources, this one s `OldValuesParameterFormatString` property is set to `original_{0}`, which will cause problems when attempting to update a product s name or quantity per unit.</span></span> <span data-ttu-id="85327-222">このプロパティを宣言構文から完全に削除するか、既定の `{0}`に設定します。</span><span class="sxs-lookup"><span data-stu-id="85327-222">Remove this property from the declarative syntax altogether or set it to its default, `{0}`.</span></span>

<span data-ttu-id="85327-223">この構成が完了すると、GridView で選択された業者によって提供された製品がページに表示されるようになります (図13を参照)。</span><span class="sxs-lookup"><span data-stu-id="85327-223">With this configuration complete, our page now lists the products provided by the supplier selected in the GridView (see Figure 13).</span></span> <span data-ttu-id="85327-224">現在 *、すべての*製品名またはユニットあたりの数量を更新できます。</span><span class="sxs-lookup"><span data-stu-id="85327-224">Currently *any* product s name or quantity per unit can be updated.</span></span> <span data-ttu-id="85327-225">ただし、特定の業者に関連付けられているユーザーの製品が廃止された場合は、ページロジックを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-225">However, we need to update our page logic so that such functionality is prohibited for discontinued products for users associated with a particular supplier.</span></span> <span data-ttu-id="85327-226">この最後の部分は、手順 5. で説明します。</span><span class="sxs-lookup"><span data-stu-id="85327-226">We'll tackle this final piece in Step 5.</span></span>

<span data-ttu-id="85327-227">[選択した業者によって提供される製品 ![表示されます](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="85327-227">[![The Products Provided by the Selected Supplier are Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span></span>

<span data-ttu-id="85327-228">**図 13**: 選択した業者によって提供される製品が表示されます ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-228">**Figure 13**: The Products Provided by the Selected Supplier are Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png))</span></span>

> [!NOTE]
> <span data-ttu-id="85327-229">この編集可能な GridView を追加すると、`Suppliers` DropDownList s `SelectedIndexChanged` イベントハンドラーを更新して、GridView を読み取り専用の状態に戻す必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-229">With the addition of this editable GridView the `Suppliers` DropDownList s `SelectedIndexChanged` event handler should be updated to return the GridView to a read-only state.</span></span> <span data-ttu-id="85327-230">それ以外の場合、製品情報の編集中に別の業者が選択されていると、新しい業者の GridView の対応するインデックスも編集可能になります。</span><span class="sxs-lookup"><span data-stu-id="85327-230">Otherwise, if a different supplier is selected while in the middle of editing product information, the corresponding index in the GridView for the new supplier will also be editable.</span></span> <span data-ttu-id="85327-231">これを回避するには、`SelectedIndexChanged` イベントハンドラーで GridView s `EditIndex` プロパティを `-1` に設定するだけです。</span><span class="sxs-lookup"><span data-stu-id="85327-231">To prevent this, simply set the GridView s `EditIndex` property to `-1` in the `SelectedIndexChanged` event handler.</span></span>

<span data-ttu-id="85327-232">また、GridView のビューステートが有効になっていることが重要であることを思い出してください (既定の動作)。</span><span class="sxs-lookup"><span data-stu-id="85327-232">Also, recall that it is important that the GridView s view state be enabled (the default behavior).</span></span> <span data-ttu-id="85327-233">GridView s `EnableViewState` プロパティを `false`に設定すると、同時実行ユーザーが誤ってレコードを削除または編集する危険性があります。</span><span class="sxs-lookup"><span data-stu-id="85327-233">If you set the GridView s `EnableViewState` property to `false`, you run the risk of having concurrent users unintentionally deleting or editing records.</span></span> <span data-ttu-id="85327-234">「警告: 詳細については[、編集または削除をサポートし、ビューステートが無効になっている ASP.NET 2.0 GridViews/DetailsView/formviews での同時実行の問題](http://scottonwriting.net/sowblog/posts/10054.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="85327-234">See [WARNING: Concurrency Issue with ASP.NET 2.0 GridViews/DetailsView/FormViews that Support Editing and/or Deleting and Whose View State is Disabled](http://scottonwriting.net/sowblog/posts/10054.aspx) for more information.</span></span>

## <a name="step-5-disallow-editing-for-discontinued-products-when-showedit-all-suppliers-is-not-selected"></a><span data-ttu-id="85327-235">手順 5: [すべての業者を表示/編集] が選択されていないときに、廃止された製品の編集を禁止する</span><span class="sxs-lookup"><span data-stu-id="85327-235">Step 5: Disallow Editing for Discontinued Products When Show/Edit ALL Suppliers is Not Selected</span></span>

<span data-ttu-id="85327-236">`ProductsBySupplier` GridView は完全に機能していますが、現在は特定の業者からのユーザーへのアクセスを許可しています。</span><span class="sxs-lookup"><span data-stu-id="85327-236">While the `ProductsBySupplier` GridView is fully functional, it currently grants too much access to those users who are from a particular supplier.</span></span> <span data-ttu-id="85327-237">Microsoft のビジネスルールに従って、このようなユーザーは、廃止された製品を更新できないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-237">Per our business rules, such users should not be able to update discontinued products.</span></span> <span data-ttu-id="85327-238">これを適用するには、仕入先からユーザーがページにアクセスしているときに、廃止された製品を含む GridView 行の [編集] ボタンを非表示 (または無効) にします。</span><span class="sxs-lookup"><span data-stu-id="85327-238">To enforce this, we can hide (or disable) the Edit button in those GridView rows with discontinued products when the page is being visited by a user from a supplier.</span></span>

<span data-ttu-id="85327-239">GridView s `RowDataBound` イベントのイベントハンドラーを作成します。</span><span class="sxs-lookup"><span data-stu-id="85327-239">Create an event handler for the GridView s `RowDataBound` event.</span></span> <span data-ttu-id="85327-240">このイベントハンドラーでは、ユーザーが特定の業者に関連付けられているかどうかを判断する必要があります。これは、このチュートリアルでは、supplier DropDownList `SelectedValue` プロパティをチェックすることによって決定できます。-1 以外の場合は、ユーザーが特定の業者に関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="85327-240">In this event handler we need to determine whether or not the user is associated with a particular supplier, which, for this tutorial, can be determined by checking the Suppliers DropDownList s `SelectedValue` property - if it s something other than -1, then the user is associated with a particular supplier.</span></span> <span data-ttu-id="85327-241">そのようなユーザーについては、製品が廃止されたかどうかを判断する必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-241">For such users, we then need to determine whether or not the product is discontinued.</span></span> <span data-ttu-id="85327-242">Gridview の[*フッターに概要情報を表示*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md)する方法に関するページで説明されているように、`e.Row.DataItem` プロパティを使用して、gridview 行にバインドされている実際の `ProductRow` インスタンスへの参照を取得できます。</span><span class="sxs-lookup"><span data-stu-id="85327-242">We can grab a reference to the actual `ProductRow` instance bound to the GridView row via the `e.Row.DataItem` property, as discussed in the [*Displaying Summary Information in the GridView s Footer*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md) tutorial.</span></span> <span data-ttu-id="85327-243">製品が廃止された場合は、前のチュートリアルで説明した手法を使用して、GridView の CommandField の [Edit] ボタンへのプログラムによる参照を取得し、[*削除時にクライアント側の確認を追加*](adding-client-side-confirmation-when-deleting-cs.md)することができます。</span><span class="sxs-lookup"><span data-stu-id="85327-243">If the product is discontinued, we can grab a programmatic reference to the Edit button in the GridView s CommandField using the techniques discussed in the previous tutorial, [*Adding Client-Side Confirmation When Deleting*](adding-client-side-confirmation-when-deleting-cs.md).</span></span> <span data-ttu-id="85327-244">参照を取得したら、ボタンを非表示にしたり、無効にしたりできます。</span><span class="sxs-lookup"><span data-stu-id="85327-244">Once we have a reference we can then hide or disable the button.</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample6.cs)]

<span data-ttu-id="85327-245">このイベントハンドラーが配置されている場合、特定の業者からのユーザーとしてこのページにアクセスすると、これらの製品の [編集] ボタンが非表示になっているため、廃止された製品は編集できません。</span><span class="sxs-lookup"><span data-stu-id="85327-245">With this event handler in place, when visiting this page as a user from a specific supplier those products that are discontinued are not editable, as the Edit button is hidden for these products.</span></span> <span data-ttu-id="85327-246">たとえば、Chef Anton s Gumbo Mix は、新しい Orleans Cajun Delights supplier で廃止された製品です。</span><span class="sxs-lookup"><span data-stu-id="85327-246">For example, Chef Anton s Gumbo Mix is a discontinued product for the New Orleans Cajun Delights supplier.</span></span> <span data-ttu-id="85327-247">この特定の業者のページにアクセスすると、この製品の [編集] ボタンが表示されません (図14を参照)。</span><span class="sxs-lookup"><span data-stu-id="85327-247">When visiting the page for this particular supplier, the Edit button for this product is hidden from sight (see Figure 14).</span></span> <span data-ttu-id="85327-248">ただし、[すべての仕入先を表示/編集する] を使用してアクセスする場合は、[編集] ボタンを使用できます (図15を参照)。</span><span class="sxs-lookup"><span data-stu-id="85327-248">However, when visiting using the "Show/Edit ALL Suppliers," the Edit button is available (see Figure 15).</span></span>

<span data-ttu-id="85327-249">[仕入先固有のユーザーの ![、Chef Anton s Gumbo ミックスの [編集] ボタンが非表示になっています](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="85327-249">[![For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span></span>

<span data-ttu-id="85327-250">**図 14**: 仕入先固有のユーザーの場合は、Chef Anton s Gumbo ミックスの [編集] ボタンが非表示になります ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-250">**Figure 14**: For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png))</span></span>

<span data-ttu-id="85327-251">[[すべてのサプライヤーユーザーの表示/編集] の ![、Chef Anton s Gumbo ミックスの [編集] ボタンが表示されます。](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="85327-251">[![For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span></span>

<span data-ttu-id="85327-252">**図 15**: [すべてのサプライヤーユーザーの表示/編集] では、Chef Anton s Gumbo ミックスの [編集] ボタンが表示されます ([クリックすると、フルサイズの画像が表示](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png)されます)</span><span class="sxs-lookup"><span data-stu-id="85327-252">**Figure 15**: For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png))</span></span>

## <a name="checking-for-access-rights-in-the-business-logic-layer"></a><span data-ttu-id="85327-253">ビジネスロジック層のアクセス権を確認しています</span><span class="sxs-lookup"><span data-stu-id="85327-253">Checking for Access Rights in the Business Logic Layer</span></span>

<span data-ttu-id="85327-254">このチュートリアルでは、ASP.NET ページで、ユーザーに表示される情報と更新可能な製品に関して、すべてのロジックを処理します。</span><span class="sxs-lookup"><span data-stu-id="85327-254">In this tutorial the ASP.NET page handles all logic with regards to what information the user can see and what products he can update.</span></span> <span data-ttu-id="85327-255">このロジックはビジネスロジックレイヤーにも存在するのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="85327-255">Ideally, this logic would also be present at the Business Logic Layer.</span></span> <span data-ttu-id="85327-256">たとえば、`SuppliersBLL` クラス s `GetSuppliers()` メソッド (すべての業者を返す) には、現在ログオンしているユーザーが特定の業者に関連付けられて*いない*ことを確認するためのチェックが含まれる場合があります。</span><span class="sxs-lookup"><span data-stu-id="85327-256">For example, the `SuppliersBLL` class s `GetSuppliers()` method (which returns all suppliers) might include a check to ensure that the currently logged on user is *not* associated with a specific supplier.</span></span> <span data-ttu-id="85327-257">同様に、`UpdateSupplierAddress` 方法では、現在ログオンしているユーザーが会社で働いている (したがって、すべての仕入先住所情報を更新できる) か、データが更新される業者に関連付けられているかを確認することができます。</span><span class="sxs-lookup"><span data-stu-id="85327-257">Likewise, the `UpdateSupplierAddress` method could include a check to ensure that the currently logged on user either worked for our company (and therefore can update all suppliers address information) or is associated with the supplier whose data is being updated.</span></span>

<span data-ttu-id="85327-258">ここでは、このような BLL レイヤーチェックを含めませんでした。このチュートリアルでは、ユーザーの権利はページの DropDownList によって決定され、BLL クラスはアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="85327-258">I did not include such BLL-layer checks here because in our tutorial the user s rights are determined by a DropDownList on the page, which the BLL classes cannot access.</span></span> <span data-ttu-id="85327-259">メンバーシップシステムを使用する場合、または ASP.NET によって提供される既定の認証スキーム (Windows 認証など) のいずれかを使用する場合は、現在ログオンしているユーザーの情報とロール情報に BLL からアクセスして、そのようなアクセスを行うことができます。権限は、プレゼンテーション層と BLL レイヤーの両方で確認できます。</span><span class="sxs-lookup"><span data-stu-id="85327-259">When using the membership system or one of the out-of-the box authentication schemes provided by ASP.NET (such as Windows authentication), the currently logged on user s information and roles information can be accessed from the BLL, thereby making such access rights checks possible at both the presentation and BLL layers.</span></span>

## <a name="summary"></a><span data-ttu-id="85327-260">要約</span><span class="sxs-lookup"><span data-stu-id="85327-260">Summary</span></span>

<span data-ttu-id="85327-261">ユーザーアカウントを提供するほとんどのサイトでは、ログインしているユーザーに基づいてデータ変更インターフェイスをカスタマイズする必要があります。</span><span class="sxs-lookup"><span data-stu-id="85327-261">Most sites that provide user accounts need to customize the data modification interface based upon the logged in user.</span></span> <span data-ttu-id="85327-262">管理ユーザーは任意のレコードを削除して編集できますが、管理者以外のユーザーは、自分が作成したレコードの更新または削除のみに制限される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="85327-262">Administrative users may be able to delete and edit any record, whereas non-administrative users may be limited to only updating or deleting records they created themselves.</span></span> <span data-ttu-id="85327-263">シナリオに関係なく、データ Web コントロール、ObjectDataSource、およびビジネスロジックレイヤークラスを拡張して、ログオンしているユーザーに基づいて特定の機能を追加または拒否することができます。</span><span class="sxs-lookup"><span data-stu-id="85327-263">Whatever the scenario may be, the data Web controls, ObjectDataSource, and Business Logic Layer classes can be extended to add or deny certain functionality based on the logged on user.</span></span> <span data-ttu-id="85327-264">このチュートリアルでは、ユーザーが特定の業者に関連付けられているかどうか、または会社で働いていたかに応じて、表示可能なデータと編集可能なデータを制限する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="85327-264">In this tutorial we saw how to limit the viewable and editable data depending on whether the user was associated with a particular supplier or if they worked for our company.</span></span>

<span data-ttu-id="85327-265">このチュートリアルでは、GridView、DetailsView、および FormView コントロールを使用したデータの挿入、更新、および削除についての調査を終了します。</span><span class="sxs-lookup"><span data-stu-id="85327-265">This tutorial concludes our examination of inserting, updating, and deleting data using the GridView, DetailsView, and FormView controls.</span></span> <span data-ttu-id="85327-266">次のチュートリアルから、ページングと並べ替えのサポートを追加することに注目します。</span><span class="sxs-lookup"><span data-stu-id="85327-266">Starting with the next tutorial, we'll turn our attention to adding paging and sorting support.</span></span>

<span data-ttu-id="85327-267">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="85327-267">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="85327-268">作成者について</span><span class="sxs-lookup"><span data-stu-id="85327-268">About the Author</span></span>

<span data-ttu-id="85327-269">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="85327-269">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="85327-270">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="85327-270">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="85327-271">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="85327-271">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="85327-272">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="85327-272">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="85327-273">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="85327-273">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="85327-274">[前へ](adding-client-side-confirmation-when-deleting-cs.md)
> [次へ](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="85327-274">[Previous](adding-client-side-confirmation-when-deleting-cs.md)
[Next](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span></span>
