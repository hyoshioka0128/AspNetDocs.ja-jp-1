---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: SqlDataSource (C#) を使用したオプティミスティック同時実行制御の実装Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、オプティミスティック同時実行制御の基礎を確認し、SqlDataSource コントロールを使用して実装する方法について説明します。
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 87fca52e2e8be844411b2fff8382c6002eccbe09
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74598196"
---
# <a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="940f1-103">SqlDataSource でオプティミスティック同時実行制御を実装する (C#)</span><span class="sxs-lookup"><span data-stu-id="940f1-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>

<span data-ttu-id="940f1-104">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="940f1-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="940f1-105">[サンプルアプリのダウンロード](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe)または[PDF のダウンロード](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="940f1-105">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="940f1-106">このチュートリアルでは、オプティミスティック同時実行制御の基礎を確認し、SqlDataSource コントロールを使用して実装する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="940f1-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>

## <a name="introduction"></a><span data-ttu-id="940f1-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="940f1-107">Introduction</span></span>

<span data-ttu-id="940f1-108">前のチュートリアルでは、SqlDataSource コントロールに挿入、更新、削除の各機能を追加する方法を説明しています。</span><span class="sxs-lookup"><span data-stu-id="940f1-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="940f1-109">つまり、これらの機能を提供するには、コントロール s `InsertCommand`、`UpdateCommand`、`DeleteCommand` の各プロパティで、対応する `INSERT`、`UPDATE`、または `DELETE` SQL ステートメントを、`InsertParameters`、`UpdateParameters`、および `DeleteParameters` の各コレクションの適切なパラメーターと共に指定する必要がありました。</span><span class="sxs-lookup"><span data-stu-id="940f1-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="940f1-110">これらのプロパティとコレクションは手動で指定できますが、[データソースの構成ウィザード] の [詳細設定] ボタンをクリックすると、[`INSERT`、`UPDATE`、および `DELETE` ステートメントの生成] チェックボックスが表示され、これらのステートメントが `SELECT` ステートメントに基づいて自動的に作成されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="940f1-111">[`INSERT`の生成]、[`UPDATE`]、および [`DELETE` ステートメント] チェックボックスと共に、[SQL 生成の詳細オプション] ダイアログボックスには、オプティミスティック同時実行オプションがあります (図1を参照)。</span><span class="sxs-lookup"><span data-stu-id="940f1-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="940f1-112">オンになっている場合、自動生成された `UPDATE` ステートメントと `DELETE` ステートメントの `WHERE` 句は、ユーザーが最後にデータをグリッドに読み込んだ後に基になるデータベースデータが変更されていない場合にのみ、更新または削除を実行するように変更されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn't been modified since the user last loaded the data into the grid.</span></span>

![オプティミスティック同時実行制御のサポートは、[SQL 生成の詳細オプション] ダイアログボックスから追加できます。](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="940f1-114">**図 1**: [SQL 生成の詳細オプション] ダイアログボックスでオプティミスティック同時実行制御のサポートを追加する</span><span class="sxs-lookup"><span data-stu-id="940f1-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>

<span data-ttu-id="940f1-115">「[オプティミスティック同時実行](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)制御の実装」チュートリアルに戻り、オプティミスティック同時実行制御の基礎と、それを ObjectDataSource に追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="940f1-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="940f1-116">このチュートリアルでは、オプティミスティック同時実行制御の基礎を詳しく説明し、SqlDataSource を使用した実装方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="940f1-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="940f1-117">オプティミスティック同時実行制御の要約</span><span class="sxs-lookup"><span data-stu-id="940f1-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="940f1-118">複数のユーザーが同時に同じデータを編集または削除できるようにする web アプリケーションの場合、1人のユーザーが別の変更を誤って上書きする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="940f1-119">[オプティミスティック同時実行制御の実装](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)に関するチュートリアルでは、次の例を示しました。</span><span class="sxs-lookup"><span data-stu-id="940f1-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="940f1-120">Jisun と Sam の2人のユーザーが、アプリケーション内のページにアクセスしていて、ビジターが GridView コントロールを使用して製品を更新および削除できることを想像してください。</span><span class="sxs-lookup"><span data-stu-id="940f1-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="940f1-121">両方とも、同じ時刻の Chai の [編集] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="940f1-122">Jisun は製品名を Chai 茶に変更し、[更新] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="940f1-123">結果として、データベースに送信される `UPDATE` ステートメントがあります。これにより、*すべて*の製品の更新可能フィールドが設定されます (Jisun によって1つのフィールドが更新された場合でも、`ProductName`)。</span><span class="sxs-lookup"><span data-stu-id="940f1-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="940f1-124">この時点で、データベースには、この特定の製品について、Chai 茶、カテゴリ飲み物、仕入先の特別な液体などが含まれています。</span><span class="sxs-lookup"><span data-stu-id="940f1-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="940f1-125">ただし、[Sam s] 画面の GridView でも、編集可能な GridView 行の製品名は Chai として表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="940f1-126">Jisun s の変更がコミットされてから数秒後に、Sam はカテゴリを Condiments に更新し、[更新] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="940f1-127">この結果、製品名を Chai に設定する `UPDATE` ステートメントがデータベースに送信され、`CategoryID` が対応する Condiments category ID になります。</span><span class="sxs-lookup"><span data-stu-id="940f1-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="940f1-128">製品名に対する jisun の変更が上書きされました。</span><span class="sxs-lookup"><span data-stu-id="940f1-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="940f1-129">図2は、この相互作用を示しています。</span><span class="sxs-lookup"><span data-stu-id="940f1-129">Figure 2 illustrates this interaction.</span></span>

<span data-ttu-id="940f1-130">[2人のユーザーが同時にレコードを更新するときに、1人のユーザーの変更によって他のが上書きされる可能性がある ![](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="940f1-131">**図 2**: 2 人のユーザーが同時にレコードを更新する場合、1人のユーザーの変更によって他のが上書きされる可能性があります ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png)されます)。</span><span class="sxs-lookup"><span data-stu-id="940f1-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>

<span data-ttu-id="940f1-132">このシナリオを確保に防ぐには、[同時実行制御](http://en.wikipedia.org/wiki/Concurrency_control)の形式を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="940f1-133">[オプティミスティック同時実行制御](http://en.wikipedia.org/wiki/Optimistic_concurrency_control)このチュートリアルでは、同時実行の競合が発生する可能性がありますが、このような競合が発生することはほとんどありません。</span><span class="sxs-lookup"><span data-stu-id="940f1-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise.</span></span> <span data-ttu-id="940f1-134">そのため、競合が発生した場合、オプティミスティック同時実行制御は、別のユーザーが同じデータを変更したため変更を保存できないことをユーザーに通知するだけです。</span><span class="sxs-lookup"><span data-stu-id="940f1-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="940f1-135">多くの同時実行の競合が発生すると想定されるアプリケーションの場合、またはこのような競合が許容できない場合は、代わりにペシミスティック同時実行制御を使用できます。</span><span class="sxs-lookup"><span data-stu-id="940f1-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="940f1-136">ペシミスティック同時実行制御の詳細については、「[オプティミスティック同時実行](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)制御の実装」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="940f1-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>

<span data-ttu-id="940f1-137">オプティミスティック同時実行制御は、更新または削除するレコードの値が、更新または削除処理の開始時と同じ値であることを保証することによって機能します。</span><span class="sxs-lookup"><span data-stu-id="940f1-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="940f1-138">たとえば、編集可能な GridView で [編集] ボタンをクリックすると、レコードの値がデータベースから読み取られ、テキストボックスやその他の Web コントロールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="940f1-139">これらの元の値は、GridView によって保存されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="940f1-140">その後、ユーザーが変更を行って [更新] ボタンをクリックした後、使用する `UPDATE` ステートメントで元の値と新しい値を考慮する必要があります。また、ユーザーが編集を開始した元の値がデータベース内の値と同じである場合にのみ、基になるデータベースレコードを更新します。</span><span class="sxs-lookup"><span data-stu-id="940f1-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="940f1-141">図3は、この一連のイベントを示しています。</span><span class="sxs-lookup"><span data-stu-id="940f1-141">Figure 3 depicts this sequence of events.</span></span>

<span data-ttu-id="940f1-142">[更新または削除を成功させるには、元の値が現在のデータベースの値と同じである必要があり ![](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="940f1-143">**図 3**: 更新または削除を成功させるには、元の値が現在のデータベースの値と同じである必要があります ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png)されます)。</span><span class="sxs-lookup"><span data-stu-id="940f1-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>

<span data-ttu-id="940f1-144">オプティミスティック同時実行制御の実装にはさまざまな方法があります (いくつかのオプションについては、「 [Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)の[オプティミスティック同時実行制御のロジック](http://www.eggheadcafe.com/articles/20050719.asp)」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="940f1-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="940f1-145">SqlDataSource (およびデータアクセス層で使用される ADO.NET 型指定されたデータセット) によって使用される手法により、`WHERE` 句が、元のすべての値の比較を含むように強化されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="940f1-146">次の `UPDATE` ステートメントでは、現在のデータベース値が GridView のレコードを更新するときに最初に取得された値と等しい場合にのみ、製品の名前と価格を更新します。</span><span class="sxs-lookup"><span data-stu-id="940f1-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="940f1-147">`@ProductName` パラメーターと `@UnitPrice` パラメーターには、ユーザーが入力した新しい値が含まれます。一方、`@original_ProductName` と `@original_UnitPrice` には、[編集] ボタンをクリックしたときに GridView に最初に読み込まれた値が含まれます。</span><span class="sxs-lookup"><span data-stu-id="940f1-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="940f1-148">このチュートリアルで説明するように、SqlDataSource でオプティミスティック同時実行制御を有効にすることは、チェックボックスをオンにするだけで簡単です。</span><span class="sxs-lookup"><span data-stu-id="940f1-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="940f1-149">手順 1: オプティミスティック同時実行制御をサポートする SqlDataSource の作成</span><span class="sxs-lookup"><span data-stu-id="940f1-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="940f1-150">まず、`SqlDataSource` フォルダーから [`OptimisticConcurrency.aspx`] ページを開きます。</span><span class="sxs-lookup"><span data-stu-id="940f1-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="940f1-151">SqlDataSource コントロールをツールボックスからデザイナーにドラッグし、その `ID` プロパティを `ProductsDataSourceWithOptimisticConcurrency`に設定します。</span><span class="sxs-lookup"><span data-stu-id="940f1-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="940f1-152">次に、コントロール s スマートタグから [データソースの構成] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="940f1-153">ウィザードの最初の画面で、`NORTHWINDConnectionString` を操作することを選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>

<span data-ttu-id="940f1-154">[NORTHWINDConnectionString の操作を選択 ![](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="940f1-155">**図 4**: `NORTHWINDConnectionString` の操作を選択する ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="940f1-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>

<span data-ttu-id="940f1-156">この例では、ユーザーが `Products` テーブルを編集できるようにする GridView を追加します。</span><span class="sxs-lookup"><span data-stu-id="940f1-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="940f1-157">そのため、[Select ステートメントの構成] 画面で、ドロップダウンリストから `Products` テーブルを選択し、図5に示すように、[`ProductID`]、[`ProductName`]、[`UnitPrice`]、[`Discontinued`] の各列を選択します。</span><span class="sxs-lookup"><span data-stu-id="940f1-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>

<span data-ttu-id="940f1-158">[Products テーブルから ![、ProductID、ProductName、UnitPrice、および廃止された列を返します。](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="940f1-159">**図 5**: `Products` テーブルから、`ProductID`、`ProductName`、`UnitPrice`、および `Discontinued` の各列を返します ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png)されます)。</span><span class="sxs-lookup"><span data-stu-id="940f1-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>

<span data-ttu-id="940f1-160">列を選択したら、[詳細設定] ボタンをクリックして [SQL 生成の詳細オプション] ダイアログボックスを表示します。</span><span class="sxs-lookup"><span data-stu-id="940f1-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="940f1-161">`INSERT`、`UPDATE`、および `DELETE` のステートメントを生成し、オプティミスティック同時実行チェックボックスをオンにして、[OK] をクリックします (スクリーンショットについては、図1を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="940f1-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="940f1-162">[次へ] をクリックし、[完了] をクリックしてウィザードを完了します。</span><span class="sxs-lookup"><span data-stu-id="940f1-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="940f1-163">データソースの構成ウィザードを完了した後、結果の `DeleteCommand` と `UpdateCommand` プロパティ、および `DeleteParameters` および `UpdateParameters` コレクションを確認します。</span><span class="sxs-lookup"><span data-stu-id="940f1-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="940f1-164">これを行う最も簡単な方法は、左下隅にある [ソース] タブをクリックして、ページの宣言構文を表示することです。</span><span class="sxs-lookup"><span data-stu-id="940f1-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="940f1-165">次のような `UpdateCommand` 値が表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-165">There you will find an `UpdateCommand` value of:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="940f1-166">`UpdateParameters` コレクションに7つのパラメーターがある場合:</span><span class="sxs-lookup"><span data-stu-id="940f1-166">With seven parameters in the `UpdateParameters` collection:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="940f1-167">同様に、`DeleteCommand` のプロパティと `DeleteParameters` コレクションは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="940f1-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="940f1-168">[オプティミスティック同時実行制御を使用] オプションを選択すると、`UpdateCommand` プロパティと `DeleteCommand` プロパティの `WHERE` 句を補強するだけでなく、その他のパラメーターを各パラメーターコレクションに追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="940f1-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="940f1-169">[`ConflictDetection` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx)を `OverwriteChanges` (既定値) からに変更 `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="940f1-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="940f1-170">[`OldValuesParameterFormatString` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx)を {0} (既定値) から元の\_{0} に変更します。</span><span class="sxs-lookup"><span data-stu-id="940f1-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="940f1-171">データ Web コントロールが SqlDataSource s `Update()` または `Delete()` メソッドを呼び出すと、元の値が渡されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="940f1-172">SqlDataSource s `ConflictDetection` プロパティが `CompareAllValues`に設定されている場合、これらの元の値はコマンドに追加されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="940f1-173">`OldValuesParameterFormatString` プロパティは、これらの元の値パラメーターに使用される名前付けパターンを提供します。</span><span class="sxs-lookup"><span data-stu-id="940f1-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="940f1-174">データソースの構成ウィザードでは、元の\_{0} を使用して、`UpdateCommand` の元のパラメーターと `DeleteCommand` のプロパティを指定し、それに従って `UpdateParameters` コレクションを `DeleteParameters` します。</span><span class="sxs-lookup"><span data-stu-id="940f1-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="940f1-175">SqlDataSource control s の挿入機能を使用しないので、`InsertCommand` プロパティとその `InsertParameters` コレクションを削除してもかまいません。</span><span class="sxs-lookup"><span data-stu-id="940f1-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>

## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="940f1-176">`NULL`値の正しく処理</span><span class="sxs-lookup"><span data-stu-id="940f1-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="940f1-177">ただし、オプティミスティック同時実行制御を使用しているときに、データソースの構成ウィザードによって自動生成される拡張 `UPDATE` および `DELETE` ステートメントは、`NULL` 値を含むレコードでは機能し*ません*。</span><span class="sxs-lookup"><span data-stu-id="940f1-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="940f1-178">その理由を確認するために、次の `UpdateCommand`を考えてみましょう。</span><span class="sxs-lookup"><span data-stu-id="940f1-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="940f1-179">`Products` テーブルの `UnitPrice` 列には `NULL` 値を指定できます。</span><span class="sxs-lookup"><span data-stu-id="940f1-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="940f1-180">特定のレコードに `UnitPrice`の `NULL` 値がある場合、`NULL = NULL` は常に False を返すため、`WHERE` 句の `[UnitPrice] = @original_UnitPrice` は*常*に false と評価されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="940f1-181">したがって、`NULL` 値を含むレコードを編集または削除することはできません。 `UPDATE` と `DELETE` ステートメント `WHERE` 句は、更新または削除する行を返しません。</span><span class="sxs-lookup"><span data-stu-id="940f1-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won't return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="940f1-182">このバグは最初に Microsoft に報告され、SqlDataSource の2004年6月に、[不適切な SQL ステートメントが生成](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937)され、次のバージョンの ASP.NET で修正される予定です。</span><span class="sxs-lookup"><span data-stu-id="940f1-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>

<span data-ttu-id="940f1-183">この問題を解決するには、`NULL` 値を持つことのできる**すべて**の列の `UpdateCommand` プロパティと `DeleteCommand` プロパティの両方で、`WHERE` 句を手動で更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="940f1-184">一般に、`[ColumnName] = @original_ColumnName` をに変更します。</span><span class="sxs-lookup"><span data-stu-id="940f1-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="940f1-185">この変更は、宣言マークアップ、プロパティウィンドウの UpdateQuery または DeleteQuery オプション、またはデータの構成の [カスタム SQL ステートメントまたはストアドプロシージャの指定] オプションの [更新] タブと [削除] タブを使用して直接行うことができます。ソースウィザード。</span><span class="sxs-lookup"><span data-stu-id="940f1-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="940f1-186">ここでも、`NULL` 値を含むことができる `UpdateCommand` および `DeleteCommand` s `WHERE` 句の*すべて*の列に対してこの変更を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="940f1-187">この例に適用すると、次の変更された `UpdateCommand` と `DeleteCommand` 値が生成されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="940f1-188">手順 2: 編集および削除オプションを使用した GridView の追加</span><span class="sxs-lookup"><span data-stu-id="940f1-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="940f1-189">オプティミスティック同時実行制御をサポートするように SqlDataSource が構成されていれば、この同時実行制御を使用するページにデータ Web コントロールを追加するだけで済みます。</span><span class="sxs-lookup"><span data-stu-id="940f1-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="940f1-190">このチュートリアルでは、編集と削除の両方の機能を提供する GridView を追加してみましょう。</span><span class="sxs-lookup"><span data-stu-id="940f1-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="940f1-191">これを行うには、GridView をツールボックスからデザイナーにドラッグし、その `ID` を `Products`に設定します。</span><span class="sxs-lookup"><span data-stu-id="940f1-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="940f1-192">GridView s スマートタグから、手順1で追加した `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource コントロールにバインドします。</span><span class="sxs-lookup"><span data-stu-id="940f1-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="940f1-193">最後に、[編集を有効にする] チェックボックスをオンにして、スマートタグから削除オプションを有効にします。</span><span class="sxs-lookup"><span data-stu-id="940f1-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>

<span data-ttu-id="940f1-194">[GridView を SqlDataSource にバインドし、編集と削除を有効に ![には](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="940f1-195">**図 6**: GridView を SqlDataSource にバインドし、編集と削除を有効に[する (クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png)されます)</span><span class="sxs-lookup"><span data-stu-id="940f1-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>

<span data-ttu-id="940f1-196">GridView を追加した後、`ProductID` BoundField を削除し、`ProductName` BoundField s `HeaderText` プロパティを Product に変更し、`UnitPrice` BoundField を更新して、その `HeaderText` プロパティが単なる価格になるように、その外観を構成します。</span><span class="sxs-lookup"><span data-stu-id="940f1-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="940f1-197">理想的には、編集インターフェイスを拡張して、`ProductName` 値の RequiredFieldValidator と、`UnitPrice` 値の CompareValidator (適切に書式設定された数値) を含めることができるようにします。</span><span class="sxs-lookup"><span data-stu-id="940f1-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="940f1-198">GridView の編集インターフェイスのカスタマイズの詳細については、[データ変更インターフェイスのカスタマイズ](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md)に関するチュートリアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="940f1-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="940f1-199">Gridview から SqlDataSource に渡された元の値がビューステートに格納されるため、GridView のビューステートを有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>

<span data-ttu-id="940f1-200">GridView に対してこれらの変更を行った後、GridView および SqlDataSource 宣言マークアップは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="940f1-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="940f1-201">オプティミスティック同時実行制御の動作を確認するには、2つのブラウザーウィンドウを開き、両方の `OptimisticConcurrency.aspx` ページを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="940f1-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="940f1-202">両方のブラウザーで最初の製品の [編集] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="940f1-203">1つのブラウザーで製品名を変更し、[更新] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="940f1-204">ブラウザーがポストバックされ、GridView が編集前のモードに戻り、編集したばかりのレコードの新しい製品名が表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="940f1-205">2番目のブラウザーウィンドウで価格を変更し (ただし、製品名は元の値のままにします)、[更新] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="940f1-206">ポストバック時に、グリッドは編集前モードに戻りますが、価格の変更は記録されません。</span><span class="sxs-lookup"><span data-stu-id="940f1-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="940f1-207">2番目のブラウザーでは、最初の値と同じ値が、新しい製品名と古い価格で表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="940f1-208">2番目のブラウザーウィンドウで行った変更は失われました。</span><span class="sxs-lookup"><span data-stu-id="940f1-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="940f1-209">また、同時実行違反が発生したことを示す例外やメッセージがないため、変更は自動的に失われました。</span><span class="sxs-lookup"><span data-stu-id="940f1-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>

<span data-ttu-id="940f1-210">[2番目のブラウザーウィンドウでの変更がサイレントに失われた ![](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="940f1-211">**図 7**: 2 番目のブラウザーウィンドウでの変更がサイレントに失われました ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png)されます)</span><span class="sxs-lookup"><span data-stu-id="940f1-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>

<span data-ttu-id="940f1-212">2番目のブラウザーの変更がコミットされなかった理由は、`UPDATE` statement s `WHERE` 句によってすべてのレコードが除外されているため、どの行にも影響しないためです。</span><span class="sxs-lookup"><span data-stu-id="940f1-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="940f1-213">`UPDATE` ステートメントをもう一度見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="940f1-213">Let s look at the `UPDATE` statement again:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="940f1-214">2番目のブラウザーウィンドウでレコードが更新されると、`WHERE` 句で指定された元の製品名は、(最初のブラウザーによって変更されたため) 既存の製品名と一致しません。</span><span class="sxs-lookup"><span data-stu-id="940f1-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="940f1-215">したがって、ステートメント `[ProductName] = @original_ProductName` は False を返し、`UPDATE` はどのレコードにも影響しません。</span><span class="sxs-lookup"><span data-stu-id="940f1-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="940f1-216">Delete は同じ方法で動作します。</span><span class="sxs-lookup"><span data-stu-id="940f1-216">Delete works in the same manner.</span></span> <span data-ttu-id="940f1-217">2つのブラウザーウィンドウを開いた状態で、特定の製品を1つずつ編集し、その変更を保存します。</span><span class="sxs-lookup"><span data-stu-id="940f1-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="940f1-218">1つのブラウザーで変更を保存した後、もう一方の製品の同じ製品の [削除] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="940f1-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="940f1-219">元の値は `DELETE` statement s `WHERE` 句では一致しないため、削除はサイレントに失敗します。</span><span class="sxs-lookup"><span data-stu-id="940f1-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>

<span data-ttu-id="940f1-220">2番目のブラウザーウィンドウのエンドユーザーの視点から、[更新] ボタンをクリックした後、グリッドは編集前モードに戻りますが、変更は失われていました。</span><span class="sxs-lookup"><span data-stu-id="940f1-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="940f1-221">ただし、変更が反映されていないという視覚的なフィードバックはありません。</span><span class="sxs-lookup"><span data-stu-id="940f1-221">However, there s no visual feedback that their changes didn't stick.</span></span> <span data-ttu-id="940f1-222">ユーザーの変更が同時実行違反に失われた場合は、そのことを通知し、おそらくグリッドを編集モードのままにしておきます。</span><span class="sxs-lookup"><span data-stu-id="940f1-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="940f1-223">これを実現する方法を見てみましょう。</span><span class="sxs-lookup"><span data-stu-id="940f1-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="940f1-224">手順 3: 同時実行違反が発生したことを確認する</span><span class="sxs-lookup"><span data-stu-id="940f1-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="940f1-225">同時実行違反によって行われた変更は拒否されるため、同時実行違反が発生した場合にユーザーに警告することができます。</span><span class="sxs-lookup"><span data-stu-id="940f1-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="940f1-226">ユーザーに警告するには、`Text` `ConcurrencyViolationMessage` という名前のページの先頭にラベル Web コントロールを追加します。これにより、別のユーザーによって同時に更新されたレコードを更新または削除しようとしたことを示すメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="940f1-227">他のユーザーの変更内容を確認してから、更新または削除をやり直してください。</span><span class="sxs-lookup"><span data-stu-id="940f1-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="940f1-228">Label コントロール s `CssClass` プロパティを Warning に設定します。これは、赤、斜体、太字、および大きいフォントでテキストを表示する `Styles.css` で定義された CSS クラスです。</span><span class="sxs-lookup"><span data-stu-id="940f1-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="940f1-229">最後に、Label s `Visible` と `EnableViewState` プロパティを `false`に設定します。</span><span class="sxs-lookup"><span data-stu-id="940f1-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="940f1-230">これにより、`Visible` プロパティを明示的に `true`に設定したポストバックだけを除き、ラベルは非表示になります。</span><span class="sxs-lookup"><span data-stu-id="940f1-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>

<span data-ttu-id="940f1-231">[警告を表示するラベルコントロールをページに追加 ![には](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="940f1-232">**図 8**: 警告を表示するためのラベルコントロールをページに追加する ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png)されます)</span><span class="sxs-lookup"><span data-stu-id="940f1-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>

<span data-ttu-id="940f1-233">Update または delete を実行すると、データソースコントロールが要求された更新または削除を実行した後に、GridView s `RowUpdated` イベントハンドラーと `RowDeleted` イベントハンドラーが起動します。</span><span class="sxs-lookup"><span data-stu-id="940f1-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="940f1-234">これらのイベントハンドラーから、操作によって影響を受けた行の数を確認できます。</span><span class="sxs-lookup"><span data-stu-id="940f1-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="940f1-235">0行が影響を受けた場合は、`ConcurrencyViolationMessage` ラベルを表示します。</span><span class="sxs-lookup"><span data-stu-id="940f1-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="940f1-236">`RowUpdated` イベントと `RowDeleted` イベントの両方のイベントハンドラーを作成し、次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="940f1-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="940f1-237">どちらのイベントハンドラーでも、`e.AffectedRows` プロパティを確認し、0に等しい場合は、`ConcurrencyViolationMessage` Label s `Visible` プロパティを `true`に設定します。</span><span class="sxs-lookup"><span data-stu-id="940f1-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="940f1-238">`RowUpdated` イベントハンドラーでは、`KeepInEditMode` プロパティを true に設定して、GridView を編集モードのままにするように指示します。</span><span class="sxs-lookup"><span data-stu-id="940f1-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="940f1-239">その場合は、データをグリッドに再バインドして、他のユーザーのデータが編集インターフェイスに読み込まれるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="940f1-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="940f1-240">これは、GridView s `DataBind()` メソッドを呼び出すことによって実現されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="940f1-241">図9に示すように、これら2つのイベントハンドラーを使用すると、同時実行違反が発生するたびに非常に顕著なメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="940f1-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>

<span data-ttu-id="940f1-242">[同時実行違反の発生時にメッセージが表示される ![](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="940f1-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="940f1-243">**図 9**: 同時実行違反の発生時にメッセージが表示される ([クリックすると、フルサイズの画像が表示](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png)されます)</span><span class="sxs-lookup"><span data-stu-id="940f1-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>

## <a name="summary"></a><span data-ttu-id="940f1-244">要約</span><span class="sxs-lookup"><span data-stu-id="940f1-244">Summary</span></span>

<span data-ttu-id="940f1-245">複数の同時実行ユーザーが同じデータを編集している可能性がある web アプリケーションを作成する場合は、同時実行制御オプションを考慮することが重要です。</span><span class="sxs-lookup"><span data-stu-id="940f1-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="940f1-246">既定では、ASP.NET データの Web コントロールとデータソースコントロールは、同時実行制御を使用しません。</span><span class="sxs-lookup"><span data-stu-id="940f1-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="940f1-247">このチュートリアルで説明したように、SqlDataSource を使用したオプティミスティック同時実行制御の実装は比較的迅速で簡単です。</span><span class="sxs-lookup"><span data-stu-id="940f1-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="940f1-248">SqlDataSource は、拡張された `WHERE` 句を自動生成された `UPDATE` および `DELETE` のステートメントに追加するためのほとんどの業務を処理しますが、`NULL` 値の列の処理にはいくつかの微妙な違いがあります。詳細については、「`NULL` 値を正しく処理する」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="940f1-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="940f1-249">このチュートリアルでは、SqlDataSource の調査を終了します。</span><span class="sxs-lookup"><span data-stu-id="940f1-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="940f1-250">残りのチュートリアルでは、ObjectDataSource と階層型アーキテクチャを使用したデータの操作に戻ります。</span><span class="sxs-lookup"><span data-stu-id="940f1-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="940f1-251">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="940f1-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="940f1-252">作成者について</span><span class="sxs-lookup"><span data-stu-id="940f1-252">About the Author</span></span>

<span data-ttu-id="940f1-253">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="940f1-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="940f1-254">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="940f1-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="940f1-255">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="940f1-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="940f1-256">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="940f1-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="940f1-257">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="940f1-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="940f1-258">[前へ](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [次へ](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="940f1-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
