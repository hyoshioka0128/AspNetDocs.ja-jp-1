---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-vb
title: SqlDataSource (VB) でのパラメーター化クエリの使用 |Microsoft Docs
author: rick-anderson
description: このチュートリアルでは、SqlDataSource コントロールの概要を説明し、パラメーター化クエリを定義する方法を学習します。 パラメーターは宣言の両方を指定できます...
ms.author: riande
ms.date: 02/20/2007
ms.assetid: e322f34c-83b7-41ea-ab65-ab1e0bdcc609
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-vb
msc.type: authoredcontent
ms.openlocfilehash: 19b93ff6c0878ae6ed546d347cafef95fd2a01e6
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/28/2019
ms.locfileid: "74597554"
---
# <a name="using-parameterized-queries-with-the-sqldatasource-vb"></a><span data-ttu-id="54889-104">パラメーター化されたクエリと SqlDataSource を使用する (VB)</span><span class="sxs-lookup"><span data-stu-id="54889-104">Using Parameterized Queries with the SqlDataSource (VB)</span></span>

<span data-ttu-id="54889-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="54889-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="54889-106">[サンプルアプリのダウンロード](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_48_VB.exe)または[PDF のダウンロード](using-parameterized-queries-with-the-sqldatasource-vb/_static/datatutorial48vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="54889-106">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_48_VB.exe) or [Download PDF](using-parameterized-queries-with-the-sqldatasource-vb/_static/datatutorial48vb1.pdf)</span></span>

> <span data-ttu-id="54889-107">このチュートリアルでは、SqlDataSource コントロールの概要を説明し、パラメーター化クエリを定義する方法を学習します。</span><span class="sxs-lookup"><span data-stu-id="54889-107">In this tutorial, we continue our look at the SqlDataSource control and learn how to define parameterized queries.</span></span> <span data-ttu-id="54889-108">パラメーターは、宣言とプログラムの両方で指定できます。また、クエリ文字列、セッション状態、その他のコントロールなど、さまざまな場所からプルできます。</span><span class="sxs-lookup"><span data-stu-id="54889-108">The parameters can be specified both declaratively and programmatically, and can be pulled from a number of locations such as the querystring, Session state, other controls, and more.</span></span>

## <a name="introduction"></a><span data-ttu-id="54889-109">はじめに</span><span class="sxs-lookup"><span data-stu-id="54889-109">Introduction</span></span>

<span data-ttu-id="54889-110">前のチュートリアルでは、SqlDataSource コントロールを使用してデータベースからデータを直接取得する方法を説明しました。</span><span class="sxs-lookup"><span data-stu-id="54889-110">In the previous tutorial we saw how to use the SqlDataSource control to retrieve data directly from a database.</span></span> <span data-ttu-id="54889-111">データソースの構成ウィザードを使用して、データベースを選択し、テーブルまたはビューから返す列を選択します。カスタム SQL ステートメントを入力してください。または、ストアドプロシージャを使用します。</span><span class="sxs-lookup"><span data-stu-id="54889-111">Using the Configure Data Source wizard, we could choose the database and then either: pick the columns to return from a table or view; enter a custom SQL statement; or use a stored procedure.</span></span> <span data-ttu-id="54889-112">テーブルまたはビューから列を選択するか、カスタム SQL ステートメントを入力するかにかかわらず、SqlDataSource control s `SelectCommand` プロパティには、作成されたアドホック SQL `SELECT` ステートメントが割り当てられます。この `SELECT` ステートメントは、SqlDataSource s `Select()` メソッドが呼び出されたときに実行されます (プログラムによって、またはデータ Web コントロールから自動で)。</span><span class="sxs-lookup"><span data-stu-id="54889-112">Whether selecting columns from a table or view or entering a custom SQL statement, the SqlDataSource control s `SelectCommand` property is assigned the resulting ad-hoc SQL `SELECT` statement and it is this `SELECT` statement that is executed when the SqlDataSource s `Select()` method is invoked (either programmatically or automatically from a data Web control).</span></span>

<span data-ttu-id="54889-113">前のチュートリアルのデモで使用した SQL `SELECT` ステートメントには、`WHERE` の句がありませんでした。</span><span class="sxs-lookup"><span data-stu-id="54889-113">The SQL `SELECT` statements used in the previous tutorial s demos lacked `WHERE` clauses.</span></span> <span data-ttu-id="54889-114">`SELECT` ステートメントでは、`WHERE` 句を使用して、返される結果を制限できます。</span><span class="sxs-lookup"><span data-stu-id="54889-114">In a `SELECT` statement, the `WHERE` clause can be used to limit the results returned.</span></span> <span data-ttu-id="54889-115">たとえば、$50.00 を超える製品の名前を表示するには、次のクエリを使用します。</span><span class="sxs-lookup"><span data-stu-id="54889-115">For example, to display the names of products costing more than $50.00, we could use the following query:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample1.sql)]

<span data-ttu-id="54889-116">通常、`WHERE` 句で使用される値は、クエリ文字列値、セッション変数、ページ上の Web コントロールからのユーザー入力など、一部の外部ソースによって決定されます。</span><span class="sxs-lookup"><span data-stu-id="54889-116">Typically, the values used in a `WHERE` clause are determine by some external source, such as a querystring value, a session variable, or user input from a Web control on the page.</span></span> <span data-ttu-id="54889-117">このような入力は、*パラメーター*を使用して指定するのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="54889-117">Ideally, such inputs are specified through the use of *parameters*.</span></span> <span data-ttu-id="54889-118">Microsoft SQL Server では、次のように `@parameterName`を使用してパラメーターが示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-118">With Microsoft SQL Server, parameters are denoted using `@parameterName`, as in:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample2.sql)]

<span data-ttu-id="54889-119">SqlDataSource は、`SELECT` ステートメントと `INSERT`、`UPDATE`、および `DELETE` ステートメントの両方に対して、パラメーター化クエリをサポートします。</span><span class="sxs-lookup"><span data-stu-id="54889-119">The SqlDataSource supports parameterized queries, both for `SELECT` statements and `INSERT`, `UPDATE`, and `DELETE` statements.</span></span> <span data-ttu-id="54889-120">さらに、パラメーター値は、クエリ文字列、セッション状態、ページ上のコントロールなど、さまざまなソースから自動的に取得できます。また、プログラムで割り当てることもできます。</span><span class="sxs-lookup"><span data-stu-id="54889-120">Moreover, the parameter values can be automatically pulled from a variety of sources the querystring, session state, controls on the page, and so on or can be assigned programmatically.</span></span> <span data-ttu-id="54889-121">このチュートリアルでは、パラメーター化されたクエリを定義する方法と、パラメーターの値を宣言とプログラムの両方で指定する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="54889-121">In this tutorial, we'll see how to define parameterized queries as well as how to specify the parameter values both declaratively and programmatically.</span></span>

> [!NOTE]
> <span data-ttu-id="54889-122">前のチュートリアルでは、最初の46チュートリアルの中で選択されていた ObjectDataSource と、概念的な類似性について説明しました。</span><span class="sxs-lookup"><span data-stu-id="54889-122">In the previous tutorial we compared the ObjectDataSource which has been our tool of choice over the first 46 tutorials with the SqlDataSource, noting their conceptual similarities.</span></span> <span data-ttu-id="54889-123">これらの類似点は、パラメーターにも拡張されます。</span><span class="sxs-lookup"><span data-stu-id="54889-123">These similarities also extend to parameters.</span></span> <span data-ttu-id="54889-124">ビジネスロジック層のメソッドの入力パラメーターにマップされた ObjectDataSource s パラメーター。</span><span class="sxs-lookup"><span data-stu-id="54889-124">The ObjectDataSource s parameters mapped to the input parameters for the methods in the Business Logic Layer.</span></span> <span data-ttu-id="54889-125">SqlDataSource を使用すると、パラメーターは SQL クエリ内で直接定義されます。</span><span class="sxs-lookup"><span data-stu-id="54889-125">With the SqlDataSource, the parameters are defined directly within the SQL query.</span></span> <span data-ttu-id="54889-126">両方のコントロールには、`Select()`、`Insert()`、`Update()`、および `Delete()` メソッドのパラメーターのコレクションがあります。また、これらのパラメーター値は、事前定義されたソース (querystring 値、セッション変数など) から設定することも、プログラムによって割り当てられることもあります。</span><span class="sxs-lookup"><span data-stu-id="54889-126">Both controls have collections of parameters for their `Select()`, `Insert()`, `Update()`, and `Delete()` methods, and both can have these parameter values populated from pre-defined sources (querystring values, session variables, and so on) or assigned programmatically.</span></span>

## <a name="creating-a-parameterized-query"></a><span data-ttu-id="54889-127">パラメーター クエリの作成</span><span class="sxs-lookup"><span data-stu-id="54889-127">Creating a Parameterized Query</span></span>

<span data-ttu-id="54889-128">SqlDataSource control s データソース構成ウィザードには、データベースレコードを取得するために実行するコマンドを定義する3つの方法が用意されています。</span><span class="sxs-lookup"><span data-stu-id="54889-128">The SqlDataSource control s Configure Data Source wizard offers three avenues for defining the command to execute to retrieve database records:</span></span>

- <span data-ttu-id="54889-129">既存のテーブルまたはビューから列を選択することにより、</span><span class="sxs-lookup"><span data-stu-id="54889-129">By picking the columns from an existing table or view,</span></span>
- <span data-ttu-id="54889-130">カスタム SQL ステートメントを入力することによって、または</span><span class="sxs-lookup"><span data-stu-id="54889-130">By entering a custom SQL statement, or</span></span>
- <span data-ttu-id="54889-131">ストアドプロシージャを選択する</span><span class="sxs-lookup"><span data-stu-id="54889-131">By choosing a stored procedure</span></span>

<span data-ttu-id="54889-132">既存のテーブルまたはビューから列を選択する場合は、[`WHERE` 句の追加] ダイアログボックスで `WHERE` 句のパラメーターを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-132">When picking columns from an existing table or view, the parameters for the `WHERE` clause must be specified through the Add `WHERE` Clause dialog box.</span></span> <span data-ttu-id="54889-133">ただし、カスタム SQL ステートメントを作成する場合は、パラメーターを `WHERE` 句に直接入力できます (各パラメーターを示すには `@parameterName` を使用します)。</span><span class="sxs-lookup"><span data-stu-id="54889-133">When creating a custom SQL statement, however, you can enter the parameters directly into the `WHERE` clause (using `@parameterName` to denote each parameter).</span></span> <span data-ttu-id="54889-134">[ストアドプロシージャ](http://www.awprofessional.com/articles/article.asp?p=25288&amp;rl=1)は1つ以上の SQL ステートメントで構成され、これらのステートメントはパラメーター化できます。</span><span class="sxs-lookup"><span data-stu-id="54889-134">A [stored procedure](http://www.awprofessional.com/articles/article.asp?p=25288&amp;rl=1) consists of one or more SQL statements, and these statements can be parameterized.</span></span> <span data-ttu-id="54889-135">ただし、SQL ステートメントで使用されるパラメーターは、ストアドプロシージャに入力パラメーターとして渡す必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-135">The parameters used in the SQL statements, however, must be passed in as input parameters to the stored procedure.</span></span>

<span data-ttu-id="54889-136">パラメーター化されたクエリの作成は、SqlDataSource s `SelectCommand` の指定方法によって異なります。そのため、では、3つのアプローチすべてを見ていきましょう。</span><span class="sxs-lookup"><span data-stu-id="54889-136">Since creating a parameterized query depends on how the SqlDataSource s `SelectCommand` is specified, let s take a look at all three approaches.</span></span> <span data-ttu-id="54889-137">作業を開始するには、`SqlDataSource` フォルダーの [`ParameterizedQueries.aspx`] ページを開き、[SqlDataSource] コントロールを [ツールボックス] からデザイナーにドラッグし、`ID` を [`Products25BucksAndUnderDataSource`] に設定します。</span><span class="sxs-lookup"><span data-stu-id="54889-137">To get started, open the `ParameterizedQueries.aspx` page in the `SqlDataSource` folder, drag a SqlDataSource control from the Toolbox onto the Designer, and set its `ID` to `Products25BucksAndUnderDataSource`.</span></span> <span data-ttu-id="54889-138">次に、コントロール s スマートタグから [データソースの構成] リンクをクリックします。</span><span class="sxs-lookup"><span data-stu-id="54889-138">Next, click the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="54889-139">使用するデータベース (`NORTHWINDConnectionString`) を選択し、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="54889-139">Select the database to use (`NORTHWINDConnectionString`) and click Next.</span></span>

## <a name="step-1-adding-awhereclause-when-picking-the-columns-from-a-table-or-view"></a><span data-ttu-id="54889-140">手順 1: テーブルまたはビューから列を選択するときに`WHERE`句を追加する</span><span class="sxs-lookup"><span data-stu-id="54889-140">Step 1: Adding a`WHERE`Clause When Picking the Columns from a Table or View</span></span>

<span data-ttu-id="54889-141">SqlDataSource コントロールを使用してデータベースから返すデータを選択する場合、データソースの構成ウィザードでは、既存のテーブルまたはビューから返す列を選択するだけで済みます (図1を参照)。</span><span class="sxs-lookup"><span data-stu-id="54889-141">When selecting the data to return from the database with the SqlDataSource control, the Configure Data Source wizard allows us to simply pick the columns to return from an existing table or view (see Figure 1).</span></span> <span data-ttu-id="54889-142">これにより、SQL `SELECT` ステートメントが自動的に作成されます。このステートメントは、SqlDataSource s `Select()` メソッドが呼び出されたときにデータベースに送信されます。</span><span class="sxs-lookup"><span data-stu-id="54889-142">Doing so automatically builds up a SQL `SELECT` statement, which is what is sent to the database when the SqlDataSource s `Select()` method is invoked.</span></span> <span data-ttu-id="54889-143">前のチュートリアルで行ったように、ドロップダウンリストから Products テーブルを選択し、`ProductID`、`ProductName`、および `UnitPrice` 列を確認します。</span><span class="sxs-lookup"><span data-stu-id="54889-143">As we did in the previous tutorial, select the Products table from the drop-down list and check the `ProductID`, `ProductName`, and `UnitPrice` columns.</span></span>

<span data-ttu-id="54889-144">[テーブルまたはビューから返す列を選択 ![には](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="54889-144">[![Pick the Columns to Return from a Table or View](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.png)</span></span>

<span data-ttu-id="54889-145">**図 1**: テーブルまたはビューから返す列を選択する ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-145">**Figure 1**: Pick the Columns to Return from a Table or View ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.png))</span></span>

<span data-ttu-id="54889-146">`SELECT` ステートメントに `WHERE` 句を含めるには、[`WHERE`] ボタンをクリックします。 [`WHERE` 句の追加] ダイアログボックスが表示されます (図2を参照)。</span><span class="sxs-lookup"><span data-stu-id="54889-146">To include a `WHERE` clause in the `SELECT` statement, click the `WHERE` button, which brings up the Add `WHERE` Clause dialog box (see Figure 2).</span></span> <span data-ttu-id="54889-147">パラメーターを追加して `SELECT` クエリによって返される結果を制限するには、まず、データをフィルター処理する列を選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-147">To add a parameter to limit the results returned by the `SELECT` query, first choose the column to filter the data by.</span></span> <span data-ttu-id="54889-148">次に、フィルター処理に使用する演算子 (=、&lt;、&lt;=、&gt;など) を選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-148">Next, choose the operator to use for filtering (=, &lt;, &lt;=, &gt;, and so on).</span></span> <span data-ttu-id="54889-149">最後に、クエリ文字列やセッション状態など、パラメーター s 値のソースを選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-149">Finally, choose the source of the parameter s value, such as from the querystring or session state.</span></span> <span data-ttu-id="54889-150">パラメーターを構成した後、[追加] ボタンをクリックして `SELECT` クエリに含めます。</span><span class="sxs-lookup"><span data-stu-id="54889-150">After configuring the parameter, click the Add button to include it in the `SELECT` query.</span></span>

<span data-ttu-id="54889-151">この例では、`UnitPrice` 値が $25.00 以下の結果のみを返すようにします。</span><span class="sxs-lookup"><span data-stu-id="54889-151">For this example, let s only return those results where the `UnitPrice` value is less than or equal to $25.00.</span></span> <span data-ttu-id="54889-152">そのため、[列] ドロップダウンリストから [`UnitPrice`] を選択し、[演算子] ドロップダウンリストから [=] を &lt;ます。</span><span class="sxs-lookup"><span data-stu-id="54889-152">Therefore, pick `UnitPrice` from the Column drop-down list and &lt;= from the Operator drop-down list.</span></span> <span data-ttu-id="54889-153">ハードコーディングされたパラメーター値 ($25.00 など) を使用する場合、またはパラメーター値をプログラムによって指定する場合は、[ソース] ボックスの一覧から [なし] を選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-153">When using a hard-coded parameter value (such as $25.00) or if the parameter value is to be specified programmatically, select None from the Source drop-down list.</span></span> <span data-ttu-id="54889-154">次に、ハードコーディングされたパラメーター値をテキストボックス25.00 に入力し、[追加] ボタンをクリックしてプロセスを完了します。</span><span class="sxs-lookup"><span data-stu-id="54889-154">Next, enter the hard-coded parameter value in the Value textbox 25.00 and complete the process by clicking the Add button.</span></span>

<span data-ttu-id="54889-155">[[WHERE 句の追加] ダイアログボックスから返される結果を制限 ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="54889-155">[![Limit the Results Returned from the Add WHERE Clause Dialog Box](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.png)</span></span>

<span data-ttu-id="54889-156">**図 2**: [`WHERE` 句の追加] ダイアログボックスで返される結果を制限[する (クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-156">**Figure 2**: Limit the Results Returned from the Add `WHERE` Clause Dialog Box ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.png))</span></span>

<span data-ttu-id="54889-157">パラメーターを追加したら、[OK] をクリックして、データソースの構成ウィザードに戻ります。</span><span class="sxs-lookup"><span data-stu-id="54889-157">After adding the parameter, click OK to return to the Configure Data Source wizard.</span></span> <span data-ttu-id="54889-158">ウィザードの下部にある `SELECT` ステートメントに、`@UnitPrice`という名前のパラメーターを持つ `WHERE` 句が含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="54889-158">The `SELECT` statement at the bottom of the wizard should now include a `WHERE` clause with a parameter named `@UnitPrice`:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample3.sql)]

> [!NOTE]
> <span data-ttu-id="54889-159">[`WHERE` 句の追加] ダイアログボックスで `WHERE` 句に複数の条件を指定した場合は、ウィザードによって `AND` 演算子と結合されます。</span><span class="sxs-lookup"><span data-stu-id="54889-159">If you specify multiple conditions in the `WHERE` clause from the Add `WHERE` Clause dialog box, the wizard joins them with the `AND` operator.</span></span> <span data-ttu-id="54889-160">`WHERE` 句 (`WHERE UnitPrice <= @UnitPrice OR Discontinued = 1`など) に `OR` を含める必要がある場合は、[カスタム SQL ステートメント] 画面を使用して `SELECT` ステートメントを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-160">If you need to include an `OR` in the `WHERE` clause (such as `WHERE UnitPrice <= @UnitPrice OR Discontinued = 1`) then you have to build the `SELECT` statement through the custom SQL statement screen.</span></span>

<span data-ttu-id="54889-161">SqlDataSource の構成を完了します ([次へ]、[完了] の順にクリック)。次に、SqlDataSource s 宣言型マークアップを調べます。</span><span class="sxs-lookup"><span data-stu-id="54889-161">Complete configuring the SqlDataSource (click Next, then Finish) and then inspect the SqlDataSource s declarative markup.</span></span> <span data-ttu-id="54889-162">マークアップには、`<SelectParameters>` コレクションが含まれるようになりました。これにより、`SelectCommand`内のパラメーターのソースが特定されます。</span><span class="sxs-lookup"><span data-stu-id="54889-162">The markup now includes a `<SelectParameters>` collection, which spells out the sources for the parameters in the `SelectCommand`.</span></span>

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample4.aspx)]

<span data-ttu-id="54889-163">SqlDataSource s `Select()` メソッドが呼び出されると、データベースに送信される前に、`UnitPrice` パラメーター値 (25.00) が `SelectCommand` 内の `@UnitPrice` パラメーターに適用されます。</span><span class="sxs-lookup"><span data-stu-id="54889-163">When the SqlDataSource s `Select()` method is invoked, the `UnitPrice` parameter value (25.00) is applied to the `@UnitPrice` parameter in the `SelectCommand` before being sent to the database.</span></span> <span data-ttu-id="54889-164">結果として、$25.00 以下の製品のみが `Products` テーブルから返されます。</span><span class="sxs-lookup"><span data-stu-id="54889-164">The net result is that only those products less than or equal to $25.00 are returned from the `Products` table.</span></span> <span data-ttu-id="54889-165">これを確認するには、GridView をページに追加し、このデータソースにバインドしてから、ブラウザーを使用してページを表示します。</span><span class="sxs-lookup"><span data-stu-id="54889-165">To confirm this, add a GridView to the page, bind it to this data source, and then view the page through a browser.</span></span> <span data-ttu-id="54889-166">図3に示すように、$25.00 以下の製品のみが表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-166">You should only see those products listed that are less than or equal to $25.00, as Figure 3 confirms.</span></span>

<span data-ttu-id="54889-167">[![$25.00 以下の製品のみが表示されます](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="54889-167">[![Only Those Products Less Than or Equal to $25.00 are Displayed](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.png)</span></span>

<span data-ttu-id="54889-168">**図 3**: $25.00 以下の製品のみが表示されます ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-168">**Figure 3**: Only Those Products Less Than or Equal to $25.00 are Displayed ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.png))</span></span>

## <a name="step-2-adding-parameters-to-a-custom-sql-statement"></a><span data-ttu-id="54889-169">手順 2: カスタム SQL ステートメントへのパラメーターの追加</span><span class="sxs-lookup"><span data-stu-id="54889-169">Step 2: Adding Parameters to a Custom SQL Statement</span></span>

<span data-ttu-id="54889-170">カスタム SQL ステートメントを追加する場合は、`WHERE` 句に明示的に入力するか、クエリビルダーのフィルターセルに値を指定します。</span><span class="sxs-lookup"><span data-stu-id="54889-170">When adding a custom SQL statement you can enter the `WHERE` clause explicitly or specify a value in the Filter cell of the Query Builder.</span></span> <span data-ttu-id="54889-171">これを示すために、には、特定のしきい値未満の価格を持つ GridView の製品のみが表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-171">To demonstrate this, let s display just those products in a GridView whose prices are less than a certain threshold.</span></span> <span data-ttu-id="54889-172">まず、`ParameterizedQueries.aspx` ページにテキストボックスを追加して、ユーザーからこのしきい値を収集します。</span><span class="sxs-lookup"><span data-stu-id="54889-172">Start by adding a TextBox to the `ParameterizedQueries.aspx` page to collect this threshold value from the user.</span></span> <span data-ttu-id="54889-173">TextBox s `ID` プロパティを `MaxPrice`に設定します。</span><span class="sxs-lookup"><span data-stu-id="54889-173">Set the TextBox s `ID` property to `MaxPrice`.</span></span> <span data-ttu-id="54889-174">ボタン Web コントロールを追加し、一致する製品を表示するように `Text` プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="54889-174">Add a Button Web control and set its `Text` property to Display Matching Products .</span></span>

<span data-ttu-id="54889-175">次に、GridView をページにドラッグし、そのスマートタグから `ProductsFilteredByPriceDataSource`という名前の新しい SqlDataSource を作成します。</span><span class="sxs-lookup"><span data-stu-id="54889-175">Next, drag a GridView onto the page and from its smart tag choose to create a new SqlDataSource named `ProductsFilteredByPriceDataSource`.</span></span> <span data-ttu-id="54889-176">データソースの構成ウィザードで、[カスタム SQL ステートメントまたはストアドプロシージャの指定] 画面に進み (図4を参照)、次のクエリを入力します。</span><span class="sxs-lookup"><span data-stu-id="54889-176">From the Configure Data Source wizard, proceed to the Specify a custom SQL statement or stored procedure screen (see Figure 4) and enter the following query:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample5.sql)]

<span data-ttu-id="54889-177">(手動またはクエリビルダーを使用して) クエリを入力したら、[次へ] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="54889-177">After entering the query (either manually or through the Query Builder), click Next.</span></span>

<span data-ttu-id="54889-178">[パラメーター値以下の製品のみを返す ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="54889-178">[![Return Only Those Products Less Than or Equal to a Parameter Value](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.png)</span></span>

<span data-ttu-id="54889-179">**図 4**: パラメーター値以下の製品のみを返す (クリックすると、[フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-179">**Figure 4**: Return Only Those Products Less Than or Equal to a Parameter Value ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.png))</span></span>

<span data-ttu-id="54889-180">クエリにはパラメーターが含まれているため、ウィザードの次の画面では、パラメーター値のソースを入力するように求められます。</span><span class="sxs-lookup"><span data-stu-id="54889-180">Since the query includes parameters, the next screen in the wizard prompts us for the source of the parameters values.</span></span> <span data-ttu-id="54889-181">[パラメーターのソース] ボックスの一覧から [コントロール] を選択し、[ControlID] ドロップダウンリストから `MaxPrice` (TextBox コントロール s `ID` 値) を選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-181">Choose Control from the Parameter source drop-down list and `MaxPrice` (the TextBox control s `ID` value) from the ControlID drop-down list.</span></span> <span data-ttu-id="54889-182">ユーザーが `MaxPrice` テキストボックスにテキストを入力していない場合に使用するオプションの既定値を入力することもできます。</span><span class="sxs-lookup"><span data-stu-id="54889-182">You can also enter an optional default value to use in the case where the user has not entered any text into the `MaxPrice` TextBox.</span></span> <span data-ttu-id="54889-183">時間については、既定値を入力しないでください。</span><span class="sxs-lookup"><span data-stu-id="54889-183">For the time being, do not enter a default value.</span></span>

<span data-ttu-id="54889-184">[パラメーターのソースとして MaxPrice TextBox s Text プロパティが使用されて ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="54889-184">[![The MaxPrice TextBox s Text Property is Used as the Parameter Source](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.png)</span></span>

<span data-ttu-id="54889-185">**図 5**: `MaxPrice` TextBox s `Text` プロパティがパラメーターソースとして使用されている ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-185">**Figure 5**: The `MaxPrice` TextBox s `Text` Property is Used as the Parameter Source ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.png))</span></span>

<span data-ttu-id="54889-186">[次へ]、[完了] の順にクリックして、データソースの構成ウィザードを完了します。</span><span class="sxs-lookup"><span data-stu-id="54889-186">Complete the Configure Data Source wizard by clicking Next, then Finish.</span></span> <span data-ttu-id="54889-187">GridView、TextBox、Button、および SqlDataSource の宣言型マークアップは、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="54889-187">The declarative markup for the GridView, TextBox, Button, and SqlDataSource follows:</span></span>

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample6.aspx)]

<span data-ttu-id="54889-188">SqlDataSource s `<SelectParameters>` セクション内のパラメーターは `ControlParameter`であり、`ControlID` や `PropertyName`などの追加のプロパティが含まれていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="54889-188">Note that the parameter within the SqlDataSource s `<SelectParameters>` section is a `ControlParameter`, which includes additional properties like `ControlID` and `PropertyName`.</span></span> <span data-ttu-id="54889-189">SqlDataSource s `Select()` メソッドが呼び出されると、`ControlParameter` は、指定された Web コントロールプロパティから値を取得し、`SelectCommand`内の対応するパラメーターに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="54889-189">When the SqlDataSource s `Select()` method is invoked, the `ControlParameter` grabs the value from the specified Web control property and assigns it to the corresponding parameter in the `SelectCommand`.</span></span> <span data-ttu-id="54889-190">この例では、`MaxPrice` s Text プロパティが `@MaxPrice` パラメーター値として使用されています。</span><span class="sxs-lookup"><span data-stu-id="54889-190">In this example, the `MaxPrice` s Text property is used as the `@MaxPrice` parameter value.</span></span>

<span data-ttu-id="54889-191">ブラウザーを使用してこのページを表示します。</span><span class="sxs-lookup"><span data-stu-id="54889-191">Take a minute to view this page through a browser.</span></span> <span data-ttu-id="54889-192">最初にページにアクセスしたとき、または `MaxPrice` TextBox に値がない場合は、GridView にレコードが表示されません。</span><span class="sxs-lookup"><span data-stu-id="54889-192">When first visiting the page or whenever the `MaxPrice` TextBox lacks a value no records are displayed in the GridView.</span></span>

<span data-ttu-id="54889-193">[MaxPrice テキストボックスが空のときにレコードが表示されない ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="54889-193">[![No Records are Displayed When the MaxPrice TextBox is Empty](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.png)</span></span>

<span data-ttu-id="54889-194">**図 6**: `MaxPrice` テキストボックスが空のときにレコードが表示されない ([クリックしてフルサイズの画像を表示する](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="54889-194">**Figure 6**: No Records are Displayed When the `MaxPrice` TextBox is Empty ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.png))</span></span>

<span data-ttu-id="54889-195">製品が表示されない理由は、既定では、パラメーター値の空の文字列がデータベース `NULL` 値に変換されるためです。</span><span class="sxs-lookup"><span data-stu-id="54889-195">The reason no products are shown is because, by default, an empty string for a parameter value is converted into a database `NULL` value.</span></span> <span data-ttu-id="54889-196">`[UnitPrice] <= NULL` の比較は常に False と評価されるため、結果は返されません。</span><span class="sxs-lookup"><span data-stu-id="54889-196">Since the comparison of `[UnitPrice] <= NULL` always evaluates as False, no results are returned.</span></span>

<span data-ttu-id="54889-197">テキストボックスに5.00 のような値を入力し、[一致する製品の表示] ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="54889-197">Enter a value into the textbox, like 5.00, and click the Display Matching Products button.</span></span> <span data-ttu-id="54889-198">ポストバック時に、SqlDataSource は、パラメーターソースの1つが変更されたことを GridView に通知します。</span><span class="sxs-lookup"><span data-stu-id="54889-198">On postback, the SqlDataSource informs the GridView that one of its parameter sources has changed.</span></span> <span data-ttu-id="54889-199">その結果、GridView は、$5.00 以下の製品を表示して SqlDataSource に再バインドされます。</span><span class="sxs-lookup"><span data-stu-id="54889-199">Consequently, the GridView rebinds to the SqlDataSource, displaying those products less than or equal to $5.00.</span></span>

<span data-ttu-id="54889-200">[$5.00 以下の ![製品が表示されます](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="54889-200">[![Products Less Than or Equal to $5.00 are Displayed](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.png)</span></span>

<span data-ttu-id="54889-201">**図 7**: $5.00 以下の製品が表示される ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-201">**Figure 7**: Products Less Than or Equal to $5.00 are Displayed ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.png))</span></span>

## <a name="initially-displaying-all-products"></a><span data-ttu-id="54889-202">すべての製品を最初に表示</span><span class="sxs-lookup"><span data-stu-id="54889-202">Initially Displaying All Products</span></span>

<span data-ttu-id="54889-203">ページが最初に読み込まれたときに製品を表示するのではなく、*すべて*の製品を表示することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="54889-203">Rather than displaying no products when the page is first loaded, we may want to display *all* products.</span></span> <span data-ttu-id="54889-204">`MaxPrice` テキストボックスが空のときにすべての製品を一覧表示する方法の1つとして、パラメーター s の既定値を非常 high 値 (100万など) に設定する方法があります。これは、Northwind Traders では、単価が $100万を超える在庫を持つ可能性が低いためです。</span><span class="sxs-lookup"><span data-stu-id="54889-204">One way to list all products whenever the `MaxPrice` TextBox is empty is to set the parameter s default value to some insanely high value, like 1000000, since it s unlikely that Northwind Traders will ever have inventory whose unit price exceeds $1,000,000.</span></span> <span data-ttu-id="54889-205">ただし、この方法は shortsighted であり、他の状況では機能しない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="54889-205">However, this approach is shortsighted and might not work in other situations.</span></span>

<span data-ttu-id="54889-206">前のチュートリアル-[宣言型パラメーター](../basic-reporting/declarative-parameters-vb.md)と[、DropDownList を使用したマスター/詳細フィルター処理](../masterdetail/master-detail-filtering-with-a-dropdownlist-vb.md)では、同様の問題が発生しました。</span><span class="sxs-lookup"><span data-stu-id="54889-206">In previous tutorials - [Declarative Parameters](../basic-reporting/declarative-parameters-vb.md) and [Master/Detail Filtering With a DropDownList](../masterdetail/master-detail-filtering-with-a-dropdownlist-vb.md) we were faced with a similar problem.</span></span> <span data-ttu-id="54889-207">このソリューションでは、このロジックをビジネスロジック層に配置する必要がありました。</span><span class="sxs-lookup"><span data-stu-id="54889-207">Our solution there was to put this logic in the Business Logic Layer.</span></span> <span data-ttu-id="54889-208">具体的には、BLL は受信値を確認し、`NULL` または予約された値の場合は、すべてのレコードを返す DAL メソッドに呼び出しをルーティングしました。</span><span class="sxs-lookup"><span data-stu-id="54889-208">Specifically, the BLL examined the incoming value and, if it was `NULL` or some reserved value, the call was routed to the DAL method that returned all records.</span></span> <span data-ttu-id="54889-209">受信した値が通常のフィルター選択値の場合は、指定された値を持つパラメーター化された `WHERE` 句を使用した SQL ステートメントを実行した DAL メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="54889-209">If the incoming value was a normal filtering value, a call was made to the DAL method that executed a SQL statement that used a parameterized `WHERE` clause with the supplied value.</span></span>

<span data-ttu-id="54889-210">残念ながら、SqlDataSource を使用する場合、アーキテクチャは無視されます。</span><span class="sxs-lookup"><span data-stu-id="54889-210">Unfortunately, we bypass the architecture when using the SqlDataSource.</span></span> <span data-ttu-id="54889-211">代わりに、`@MaximumPrice` パラメーターが `NULL` または予約済みの値である場合は、すべてのレコードをインテリジェントに取得するように SQL ステートメントをカスタマイズする必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-211">Instead, we need to customize the SQL statement to intelligently grab all records if the `@MaximumPrice` parameter is `NULL` or some reserved value.</span></span> <span data-ttu-id="54889-212">この演習では、`@MaximumPrice` パラメーターが `-1.0`と等しい場合に、*すべて*のレコードが返されるようにします (製品に負の `UnitPrice` 値を設定することはできないため、`-1.0` は予約済みの値として機能します)。</span><span class="sxs-lookup"><span data-stu-id="54889-212">For this exercise, let s have it so that if the `@MaximumPrice` parameter is equal to `-1.0`, then *all* of the records are to be returned (`-1.0` works as a reserved value since no product can have a negative `UnitPrice` value).</span></span> <span data-ttu-id="54889-213">これを実現するには、次の SQL ステートメントを使用します。</span><span class="sxs-lookup"><span data-stu-id="54889-213">To accomplish this we can use the following SQL statement:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample7.sql)]

<span data-ttu-id="54889-214">この `WHERE` 句は、`@MaximumPrice` パラメーターが `-1.0`の場合に*すべて*のレコードを返します。</span><span class="sxs-lookup"><span data-stu-id="54889-214">This `WHERE` clause returns *all* records if the `@MaximumPrice` parameter equals `-1.0`.</span></span> <span data-ttu-id="54889-215">パラメーター値が `-1.0`されていない場合は、`UnitPrice` が `@MaximumPrice` パラメーター値以下の製品のみが返されます。</span><span class="sxs-lookup"><span data-stu-id="54889-215">If the parameter value is not `-1.0`, only those products whose `UnitPrice` is less than or equal to the `@MaximumPrice` parameter value are returned.</span></span> <span data-ttu-id="54889-216">`@MaximumPrice` パラメーターの既定値を `-1.0`に設定すると、最初のページの読み込み時 (または [`MaxPrice`] ボックスが空のとき) に、`@MaximumPrice` の値が `-1.0` になり、すべての製品が表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-216">By setting the default value of the `@MaximumPrice` parameter to `-1.0`, on the first page load (or whenever the `MaxPrice` TextBox is empty), `@MaximumPrice` will have a value of `-1.0` and all products will be displayed.</span></span>

<span data-ttu-id="54889-217">[![MaxPrice テキストボックスが空のときにすべての製品が表示されるようになりました。](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="54889-217">[![Now All Products are Displayed When the MaxPrice TextBox is Empty](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.png)</span></span>

<span data-ttu-id="54889-218">**図 8**: `MaxPrice` テキストボックスが空のときにすべての製品が表示されるようになりました ([クリックしてフルサイズの画像を表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="54889-218">**Figure 8**: Now All Products are Displayed When the `MaxPrice` TextBox is Empty ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image16.png))</span></span>

<span data-ttu-id="54889-219">この方法で注意すべき注意事項がいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="54889-219">There are a couple of caveats to note with this approach.</span></span> <span data-ttu-id="54889-220">まず、パラメーター s データ型が SQL クエリでの使用によって推論されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="54889-220">First, realize that the parameter s data type is inferred by it s usage in the SQL query.</span></span> <span data-ttu-id="54889-221">`WHERE` 句を `@MaximumPrice = -1.0` から `@MaximumPrice = -1`に変更した場合、ランタイムはパラメーターを整数として扱います。</span><span class="sxs-lookup"><span data-stu-id="54889-221">If you change the `WHERE` clause from `@MaximumPrice = -1.0` to `@MaximumPrice = -1`, the runtime treats the parameter as an integer.</span></span> <span data-ttu-id="54889-222">その後、`MaxPrice` テキストボックスを10進数値 (5.00 など) に割り当てようとすると、5.00 を整数に変換できないため、エラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="54889-222">If you then attempt to assign the `MaxPrice` TextBox to a decimal value (like 5.00 ), an error will occur because it cannot convert 5.00 to an integer.</span></span> <span data-ttu-id="54889-223">これを解決するには、`WHERE` 句で `@MaximumPrice = -1.0` を使用していることを確認するか、さらに優れた `ControlParameter` オブジェクト s `Type` プロパティを Decimal に設定します。</span><span class="sxs-lookup"><span data-stu-id="54889-223">To remedy this, either make sure that you use `@MaximumPrice = -1.0` in the `WHERE` clause or, better yet, set the `ControlParameter` object s `Type` property to Decimal .</span></span>

<span data-ttu-id="54889-224">2つ目の方法として、`OR @MaximumPrice = -1.0` を `WHERE` 句に追加すると、クエリエンジンは `UnitPrice` (存在する場合) のインデックスを使用できず、その結果、テーブルスキャンが実行されます。</span><span class="sxs-lookup"><span data-stu-id="54889-224">Secondly, by adding the `OR @MaximumPrice = -1.0` to the `WHERE` clause, the query engine cannot use an index on `UnitPrice` (assuming one exists), thereby resulting in a table scan.</span></span> <span data-ttu-id="54889-225">これは、`Products` テーブルに十分な数のレコードがある場合に、パフォーマンスに影響を与える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="54889-225">This can impact performance if there are a sufficiently large number of records in the `Products` table.</span></span> <span data-ttu-id="54889-226">より適切な方法は、このロジックをストアドプロシージャに移行することです。この場合、すべてのレコードを返す必要がある場合、または `WHERE` 句に `UnitPrice` 条件だけが含まれている場合は、`WHERE` 句を指定せずに、`IF` ステートメントで `Products` テーブルから `SELECT` クエリを実行することで、インデックスを使用できます。</span><span class="sxs-lookup"><span data-stu-id="54889-226">A better approach would be to move this logic to a stored procedure where an `IF` statement would either perform a `SELECT` query from the `Products` table without a `WHERE` clause when all records need to be returned or one whose `WHERE` clause contains just the `UnitPrice` criteria, so that an index can be used.</span></span>

## <a name="step-3-creating-and-using-parameterized-stored-procedures"></a><span data-ttu-id="54889-227">手順 3: パラメーター化されたストアドプロシージャの作成と使用</span><span class="sxs-lookup"><span data-stu-id="54889-227">Step 3: Creating and Using Parameterized Stored Procedures</span></span>

<span data-ttu-id="54889-228">ストアドプロシージャには、ストアドプロシージャ内で定義されている SQL ステートメントで使用できる一連の入力パラメーターを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-228">Stored procedures can include a set of input parameters that can then be used in the SQL statement(s) defined within the stored procedure.</span></span> <span data-ttu-id="54889-229">入力パラメーターを受け取るストアドプロシージャを使用するように SqlDataSource を構成する場合、アドホック SQL ステートメントと同じ手法を使用して、これらのパラメーター値を指定できます。</span><span class="sxs-lookup"><span data-stu-id="54889-229">When configuring the SqlDataSource to use a stored procedure that accepts input parameters, these parameter values can be specified using the same techniques as with ad-hoc SQL statements.</span></span>

<span data-ttu-id="54889-230">SqlDataSource でストアドプロシージャを使用する方法を示すために、`GetProductsByCategory`という名前の Northwind データベースに新しいストアドプロシージャを作成します。このストアドプロシージャは `@CategoryID` という名前のパラメーターを受け取り、`CategoryID` 列が `@CategoryID`と一致する製品のすべての列を返します。</span><span class="sxs-lookup"><span data-stu-id="54889-230">To illustrate using stored procedures in the SqlDataSource, let s create a new stored procedure in the Northwind database named `GetProductsByCategory`, which accepts a parameter named `@CategoryID` and returns all of the columns of the products whose `CategoryID` column matches `@CategoryID`.</span></span> <span data-ttu-id="54889-231">ストアドプロシージャを作成するには、サーバーエクスプローラーに移動し、`NORTHWND.MDF` データベースにドリルダウンします。</span><span class="sxs-lookup"><span data-stu-id="54889-231">To create a stored procedure, go to the Server Explorer and drill down into the `NORTHWND.MDF` database.</span></span> <span data-ttu-id="54889-232">(サーバーエクスプローラーが表示されない場合は、[表示] メニューに移動して [サーバーエクスプローラー] オプションを選択すると表示されます)。</span><span class="sxs-lookup"><span data-stu-id="54889-232">(If you don t see the Server Explorer, bring it up by going to the View menu and selecting the Server Explorer option.)</span></span>

<span data-ttu-id="54889-233">`NORTHWND.MDF` データベースで、[ストアドプロシージャ] フォルダーを右クリックし、[新しいストアドプロシージャの追加] を選択して、次の構文を入力します。</span><span class="sxs-lookup"><span data-stu-id="54889-233">From the `NORTHWND.MDF` database, right-click on the Stored Procedures folder, choose Add New Stored Procedure, and enter the following syntax:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample8.sql)]

<span data-ttu-id="54889-234">保存アイコン (または Ctrl + S) をクリックして、ストアドプロシージャを保存します。</span><span class="sxs-lookup"><span data-stu-id="54889-234">Click the Save icon (or Ctrl+S) to save the stored procedure.</span></span> <span data-ttu-id="54889-235">ストアドプロシージャをテストするには、[ストアドプロシージャ] フォルダーでストアドプロシージャを右クリックし、[実行] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="54889-235">You can test the stored procedure by right-clicking it from the Stored Procedures folder and choosing Execute.</span></span> <span data-ttu-id="54889-236">これにより、ストアドプロシージャ s パラメーター (このインスタンスでは`@CategoryID`) を入力するように求められます。その後、結果が出力ウィンドウに表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-236">This will prompt you for the stored procedure s parameters (`@CategoryID`, in this instance), after which the results will be displayed in the Output window.</span></span>

<span data-ttu-id="54889-237">[@CategoryID を1にして実行したときに Get$ Bycategory ストアドプロシージャを ![する](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="54889-237">[![The GetProductsByCategory Stored Procedure when Executed with a @CategoryID of 1](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image17.png)</span></span>

<span data-ttu-id="54889-238">**図 9**: `@CategoryID` を1にして実行した場合の `GetProductsByCategory` ストアドプロシージャ ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image18.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-238">**Figure 9**: The `GetProductsByCategory` Stored Procedure when Executed with a `@CategoryID` of 1 ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image18.png))</span></span>

<span data-ttu-id="54889-239">このストアドプロシージャを使用して、[飲料] カテゴリのすべての製品を GridView に表示します。</span><span class="sxs-lookup"><span data-stu-id="54889-239">Let s use this stored procedure to display all products in the Beverages category in a GridView.</span></span> <span data-ttu-id="54889-240">新しい GridView をページに追加し、`BeverageProductsDataSource`という名前の新しい SqlDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="54889-240">Add a new GridView to the page and bind it to a new SqlDataSource named `BeverageProductsDataSource`.</span></span> <span data-ttu-id="54889-241">[カスタム SQL ステートメントまたはストアドプロシージャの指定] 画面に進み、[ストアドプロシージャ] オプションボタンを選択し、ドロップダウンリストから `GetProductsByCategory` ストアドプロシージャを選択します。</span><span class="sxs-lookup"><span data-stu-id="54889-241">Continue to the Specify a custom SQL statement or stored procedure screen, select the Stored procedure radio button, and pick the `GetProductsByCategory` stored procedure from the drop-down list.</span></span>

<span data-ttu-id="54889-242">[![ドロップダウンリストから [Get$ Bycategory] ストアドプロシージャを選択します。](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="54889-242">[![Select the GetProductsByCategory Stored Procedure from the Drop-Down List](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image19.png)</span></span>

<span data-ttu-id="54889-243">**図 10**: ドロップダウンリストから `GetProductsByCategory` ストアドプロシージャを選択[する (クリックしてフルサイズの画像を表示する](using-parameterized-queries-with-the-sqldatasource-vb/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="54889-243">**Figure 10**: Select the `GetProductsByCategory` Stored Procedure from the Drop-Down List ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image20.png))</span></span>

<span data-ttu-id="54889-244">ストアドプロシージャは入力パラメーター (`@CategoryID`) を受け入れるため、[次へ] をクリックすると、このパラメーターの値のソースを指定するように求められます。</span><span class="sxs-lookup"><span data-stu-id="54889-244">Since the stored procedure accepts an input parameter (`@CategoryID`), clicking Next prompts us to specify the source for this parameter s value.</span></span> <span data-ttu-id="54889-245">飲み物 `CategoryID` は1であるため、[パラメーターのソース] ボックスの一覧は [なし] のままにして、[DefaultValue] ボックスに「1」と入力します。</span><span class="sxs-lookup"><span data-stu-id="54889-245">The Beverages `CategoryID` is 1, so leave the Parameter source drop-down list at None and enter 1 into the DefaultValue textbox.</span></span>

<span data-ttu-id="54889-246">[ハードコーディングされた値1を使用して飲料カテゴリの製品を返す ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="54889-246">[![Use a Hard-Coded Value of 1 to Return the Products in the Beverages Category](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image21.png)</span></span>

<span data-ttu-id="54889-247">**図 11**: ハードコーディングされた値1を使用して飲料カテゴリの製品を返す ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image22.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-247">**Figure 11**: Use a Hard-Coded Value of 1 to Return the Products in the Beverages Category ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image22.png))</span></span>

<span data-ttu-id="54889-248">次の宣言型マークアップに示すように、ストアドプロシージャを使用する場合、SqlDataSource s `SelectCommand` プロパティはストアドプロシージャの名前に設定され、 [`SelectCommandType` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.selectcommandtype.aspx)は `StoredProcedure`に設定されます。これは、`SelectCommand` がアドホック SQL ステートメントではなくストアドプロシージャの名前であることを示します。</span><span class="sxs-lookup"><span data-stu-id="54889-248">As the following declarative markup shows, when using a stored procedure, the SqlDataSource s `SelectCommand` property is set to the name of the stored procedure and the [`SelectCommandType` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.selectcommandtype.aspx) is set to `StoredProcedure`, indicating that the `SelectCommand` is the name of a stored procedure rather than an ad-hoc SQL statement.</span></span>

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample9.aspx)]

<span data-ttu-id="54889-249">ブラウザーでページをテストします。</span><span class="sxs-lookup"><span data-stu-id="54889-249">Test out the page in a browser.</span></span> <span data-ttu-id="54889-250">飲料カテゴリに属する製品のみが表示されます。ただし、`GetProductsByCategory` ストアドプロシージャからは、`Products` テーブルのすべての列が返されるので、*すべて*の product フィールドが表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-250">Only those products that belong to the Beverages category are displayed, although *all* of the product fields are displayed since the `GetProductsByCategory` stored procedure returns all of the columns from the `Products` table.</span></span> <span data-ttu-id="54889-251">もちろん、gridview の [列の編集] ダイアログボックスから GridView に表示されるフィールドを制限したり、カスタマイズしたりすることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-251">We could, of course, limit or customize the fields displayed in the GridView from the GridView s Edit Columns dialog box.</span></span>

<span data-ttu-id="54889-252">[すべての飲み物が表示され ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="54889-252">[![All of the Beverages are Displayed](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image23.png)</span></span>

<span data-ttu-id="54889-253">**図 12**: すべての飲み物が表示されます ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image24.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-253">**Figure 12**: All of the Beverages are Displayed ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image24.png))</span></span>

## <a name="step-4-programmatically-invoking-a-sqldatasource-sselectstatement"></a><span data-ttu-id="54889-254">手順 4: プログラムによる SqlDataSource s`Select()`ステートメントの呼び出し</span><span class="sxs-lookup"><span data-stu-id="54889-254">Step 4: Programmatically Invoking a SqlDataSource s`Select()`Statement</span></span>

<span data-ttu-id="54889-255">前のチュートリアルで説明した例とこのチュートリアルでは、SqlDataSource コントロールを直接 GridView にバインドしました。</span><span class="sxs-lookup"><span data-stu-id="54889-255">The examples we ve seen in the previous tutorial and this tutorial so far have bound SqlDataSource controls directly to a GridView.</span></span> <span data-ttu-id="54889-256">ただし、SqlDataSource コントロールのデータは、プログラムによってコード内でアクセスおよび列挙できます。</span><span class="sxs-lookup"><span data-stu-id="54889-256">The SqlDataSource control s data, however, can be programmatically accessed and enumerated in code.</span></span> <span data-ttu-id="54889-257">これは、データを照会して検査する必要があるが、表示する必要がない場合に特に便利です。</span><span class="sxs-lookup"><span data-stu-id="54889-257">This can be particularly useful when you need to query data to inspect it, but don t need to display it.</span></span> <span data-ttu-id="54889-258">データベースに接続してコマンドを指定し、結果を取得するために、すべての定型 ADO.NET コードを記述するのではなく、SqlDataSource がこの単調なコードを処理できるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-258">Rather than having to write all of the boilerplate ADO.NET code to connect to the database, specify the command, and retrieve the results, you can let the SqlDataSource handle this monotonous code.</span></span>

<span data-ttu-id="54889-259">プログラムによって SqlDataSource s データを操作する方法を示すために、上司がランダムに選択されたカテゴリとそれに関連付けられた製品の名前を表示する web ページを作成するように要求することを想定しています。</span><span class="sxs-lookup"><span data-stu-id="54889-259">To illustrate working with the SqlDataSource s data programmatically, imagine that your boss has approached you with a request to create a web page that displays the name of a randomly selected category and its associated products.</span></span> <span data-ttu-id="54889-260">つまり、ユーザーがこのページにアクセスすると、`Categories` テーブルからランダムにカテゴリを選択し、カテゴリ名を表示して、そのカテゴリに属する製品を一覧表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-260">That is, when a user visits this page, we want to randomly choose a category from the `Categories` table, display the category name, and then list the products belonging to that category.</span></span>

<span data-ttu-id="54889-261">これを実現するには、2つの SqlDataSource コントロールが必要です。1つは `Categories` テーブルからランダムなカテゴリを取得し、もう1つは category s 製品を取得するためです。</span><span class="sxs-lookup"><span data-stu-id="54889-261">To accomplish this we need two SqlDataSource controls one to grab a random category from the `Categories` table and another to get the category s products.</span></span> <span data-ttu-id="54889-262">この手順では、ランダムなカテゴリレコードを取得する SqlDataSource を作成します。手順5では、カテゴリの製品を取得する SqlDataSource の構築について説明します。</span><span class="sxs-lookup"><span data-stu-id="54889-262">We'll build the SqlDataSource that retrieves a random category record in this step; Step 5 looks at crafting the SqlDataSource that retrieves the category s products.</span></span>

<span data-ttu-id="54889-263">まず、`ParameterizedQueries.aspx` に SqlDataSource を追加し、その `ID` を `RandomCategoryDataSource`に設定します。</span><span class="sxs-lookup"><span data-stu-id="54889-263">Start by adding a SqlDataSource to `ParameterizedQueries.aspx` and set its `ID` to `RandomCategoryDataSource`.</span></span> <span data-ttu-id="54889-264">次の SQL クエリを使用するように構成します。</span><span class="sxs-lookup"><span data-stu-id="54889-264">Configure it so that it uses the following SQL query:</span></span>

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample10.sql)]

<span data-ttu-id="54889-265">`ORDER BY NEWID()` は、ランダムな順序で並べ替えられたレコードを返します (「 [`NEWID()` を使用してレコードをランダムに並べ替える](http://www.sqlteam.com/item.asp?ItemID=8747)」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="54889-265">`ORDER BY NEWID()` returns the records sorted in random order (see [Using `NEWID()` to Randomly Sort Records](http://www.sqlteam.com/item.asp?ItemID=8747)).</span></span> <span data-ttu-id="54889-266">`SELECT TOP 1` は、結果セットの最初のレコードを返します。</span><span class="sxs-lookup"><span data-stu-id="54889-266">`SELECT TOP 1` returns the first record from the result set.</span></span> <span data-ttu-id="54889-267">このクエリでは、ランダムに選択された単一のカテゴリから、`CategoryID` と `CategoryName` 列の値が返されます。</span><span class="sxs-lookup"><span data-stu-id="54889-267">Put together, this query returns the `CategoryID` and `CategoryName` column values from a single, randomly selected category.</span></span>

<span data-ttu-id="54889-268">Category s `CategoryName` の値を表示するには、ラベル Web コントロールをページに追加し、その `ID` プロパティを `CategoryNameLabel`に設定して、その `Text` プロパティをオフにします。</span><span class="sxs-lookup"><span data-stu-id="54889-268">To display the category s `CategoryName` value, add a Label Web control to the page, set its `ID` property to `CategoryNameLabel`, and clear out its `Text` property.</span></span> <span data-ttu-id="54889-269">プログラムによって SqlDataSource コントロールからデータを取得するには、`Select()` メソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-269">To programmatically retrieve the data from a SqlDataSource control, we need to invoke its `Select()` method.</span></span> <span data-ttu-id="54889-270">[`Select()` メソッド](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.select.aspx)では、返される前にデータをどのようにメッセージするかを指定する[`DataSourceSelectArguments`](https://msdn.microsoft.com/library/system.web.ui.datasourceselectarguments.aspx)型の1つの入力パラメーターが必要です。</span><span class="sxs-lookup"><span data-stu-id="54889-270">The [`Select()` method](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.select.aspx) expects a single input parameter of type [`DataSourceSelectArguments`](https://msdn.microsoft.com/library/system.web.ui.datasourceselectarguments.aspx), which specifies how the data should be messaged before being returned.</span></span> <span data-ttu-id="54889-271">これには、データの並べ替えとフィルター処理に関する指示が含まれ、SqlDataSource コントロールからのデータの並べ替えやページングを行うときに、データ Web コントロールによって使用されます。</span><span class="sxs-lookup"><span data-stu-id="54889-271">This can include instructions on sorting and filtering the data, and is used by the data Web controls when sorting or paging through the data from a SqlDataSource control.</span></span> <span data-ttu-id="54889-272">ただし、この例では、返される前にデータを変更する必要はないため、`DataSourceSelectArguments.Empty` オブジェクトに渡されます。</span><span class="sxs-lookup"><span data-stu-id="54889-272">For our example, though, we don t need the data to be modified before being returned, and therefore will pass in the `DataSourceSelectArguments.Empty` object.</span></span>

<span data-ttu-id="54889-273">`Select()` メソッドは、`IEnumerable`を実装するオブジェクトを返します。</span><span class="sxs-lookup"><span data-stu-id="54889-273">The `Select()` method returns an object that implements `IEnumerable`.</span></span> <span data-ttu-id="54889-274">返される正確な型は、SqlDataSource control s [`DataSourceMode` プロパティ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.datasourcemode.aspx)の値によって異なります。</span><span class="sxs-lookup"><span data-stu-id="54889-274">The precise type returned depends on the value of the SqlDataSource control s [`DataSourceMode` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.datasourcemode.aspx).</span></span> <span data-ttu-id="54889-275">前のチュートリアルで説明したように、このプロパティは `DataSet` または `DataReader`のいずれかの値に設定できます。</span><span class="sxs-lookup"><span data-stu-id="54889-275">As discussed in the previous tutorial, this property can be set to a value of either `DataSet` or `DataReader`.</span></span> <span data-ttu-id="54889-276">`DataSet`に設定した場合、`Select()` メソッドは[DataView](https://msdn.microsoft.com/library/01s96x0z.aspx)オブジェクトを返します。`DataReader`に設定すると、 [`IDataReader`](https://msdn.microsoft.com/library/system.data.idatareader.aspx)を実装するオブジェクトが返されます。</span><span class="sxs-lookup"><span data-stu-id="54889-276">If set to `DataSet`, the `Select()` method returns a [DataView](https://msdn.microsoft.com/library/01s96x0z.aspx) object; if set to `DataReader`, it returns an object that implements [`IDataReader`](https://msdn.microsoft.com/library/system.data.idatareader.aspx).</span></span> <span data-ttu-id="54889-277">`RandomCategoryDataSource` SqlDataSource の `DataSourceMode` プロパティは `DataSet` (既定値) に設定されているため、DataView オブジェクトを操作します。</span><span class="sxs-lookup"><span data-stu-id="54889-277">Since the `RandomCategoryDataSource` SqlDataSource has its `DataSourceMode` property set to `DataSet` (the default), we will be working with a DataView object.</span></span>

<span data-ttu-id="54889-278">次のコードは、DataView として `RandomCategoryDataSource` SqlDataSource からレコードを取得する方法と、最初の DataView 行から `CategoryName` 列の値を読み取る方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="54889-278">The following code illustrates how to retrieve the records from the `RandomCategoryDataSource` SqlDataSource as a DataView as well as how to read the `CategoryName` column value from the first DataView row:</span></span>

[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample11.vb)]

<span data-ttu-id="54889-279">`randomCategoryView(0)` は、DataView 内の最初の `DataRowView` を返します。</span><span class="sxs-lookup"><span data-stu-id="54889-279">`randomCategoryView(0)` returns the first `DataRowView` in the DataView.</span></span> <span data-ttu-id="54889-280">`randomCategoryView(0)("CategoryName")` は、この最初の行の `CategoryName` 列の値を返します。</span><span class="sxs-lookup"><span data-stu-id="54889-280">`randomCategoryView(0)("CategoryName")` returns the value of the `CategoryName` column in this first row.</span></span> <span data-ttu-id="54889-281">DataView は弱く型指定されていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="54889-281">Note that the DataView is loosely-typed.</span></span> <span data-ttu-id="54889-282">特定の列の値を参照するには、列の名前を文字列として渡す必要があります (この場合は)。</span><span class="sxs-lookup"><span data-stu-id="54889-282">To reference a particular column value we need to pass in the name of the column as a string ( CategoryName, in this case).</span></span> <span data-ttu-id="54889-283">図13は、ページを表示するときに `CategoryNameLabel` に表示されるメッセージを示しています。</span><span class="sxs-lookup"><span data-stu-id="54889-283">Figure 13 shows the message displayed in the `CategoryNameLabel` when viewing the page.</span></span> <span data-ttu-id="54889-284">もちろん、実際に表示されるカテゴリ名は、ページにアクセスするたびに (ポストバックを含む) `RandomCategoryDataSource` SqlDataSource によってランダムに選択されます。</span><span class="sxs-lookup"><span data-stu-id="54889-284">Of course, the actual category name displayed is randomly selected by the `RandomCategoryDataSource` SqlDataSource on each visit to the page (including postbacks).</span></span>

<span data-ttu-id="54889-285">[ランダムに選択されたカテゴリの名前が表示さ ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="54889-285">[![The Randomly Selected Category s Name is Displayed](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image25.png)</span></span>

<span data-ttu-id="54889-286">**図 13**: ランダムに選択されたカテゴリの名前が表示される ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image26.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-286">**Figure 13**: The Randomly Selected Category s Name is Displayed ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image26.png))</span></span>

> [!NOTE]
> <span data-ttu-id="54889-287">SqlDataSource control s `DataSourceMode` プロパティが `DataReader`に設定されている場合は、`Select()` メソッドからの戻り値を `IDataReader`にキャストする必要があります。</span><span class="sxs-lookup"><span data-stu-id="54889-287">If the SqlDataSource control s `DataSourceMode` property had been set to `DataReader`, the return value from the `Select()` method would have needed to be cast to `IDataReader`.</span></span> <span data-ttu-id="54889-288">最初の行から `CategoryName` 列の値を読み取るには、次のようなコードを使用します。</span><span class="sxs-lookup"><span data-stu-id="54889-288">To read the `CategoryName` column value from the first row, we d use code like:</span></span>

[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample12.vb)]

<span data-ttu-id="54889-289">SqlDataSource でカテゴリをランダムに選択し、カテゴリの製品を一覧表示する GridView を追加する準備ができました。</span><span class="sxs-lookup"><span data-stu-id="54889-289">With the SqlDataSource randomly selecting a category, we re ready to add the GridView that lists the category s products.</span></span>

> [!NOTE]
> <span data-ttu-id="54889-290">ラベル Web コントロールを使用してカテゴリ名を表示するのではなく、ページに FormView または DetailsView を追加して、SqlDataSource にバインドすることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-290">Rather than using a Label Web control to display the category s name, we could have added a FormView or DetailsView to the page, binding it to the SqlDataSource.</span></span> <span data-ttu-id="54889-291">ただし、ラベルを使用すると、プログラムで SqlDataSource s `Select()` ステートメントを呼び出し、結果のデータをコードで操作する方法を調べることができました。</span><span class="sxs-lookup"><span data-stu-id="54889-291">Using the Label, however, allowed us to explore how to programmatically invoke the SqlDataSource s `Select()` statement and work with its resulting data in code.</span></span>

## <a name="step-5-assigning-parameter-values-programmatically"></a><span data-ttu-id="54889-292">手順 5: プログラムによるパラメーター値の割り当て</span><span class="sxs-lookup"><span data-stu-id="54889-292">Step 5: Assigning Parameter Values Programmatically</span></span>

<span data-ttu-id="54889-293">このチュートリアルでこれまでに説明したすべての例では、ハードコーディングされたパラメーター値を使用しているか、事前に定義されたパラメーターのソース (querystring の値、ページの Web コントロールなど) のいずれかを使用しています。</span><span class="sxs-lookup"><span data-stu-id="54889-293">All of the examples we ve seen so far in this tutorial have used either a hard-coded parameter value or one taken from one of the pre-defined parameter sources (a querystring value, a Web control on the page, and so on).</span></span> <span data-ttu-id="54889-294">ただし、SqlDataSource コントロール s パラメーターはプログラムで設定することもできます。</span><span class="sxs-lookup"><span data-stu-id="54889-294">However, the SqlDataSource control s parameters can also be set programmatically.</span></span> <span data-ttu-id="54889-295">現在の例を完了するには、指定されたカテゴリに属するすべての製品を返す SqlDataSource が必要です。</span><span class="sxs-lookup"><span data-stu-id="54889-295">To complete our current example, we need a SqlDataSource that returns all of the products belonging to a specified category.</span></span> <span data-ttu-id="54889-296">この SqlDataSource には、`Page_Load` イベントハンドラーの SqlDataSource `RandomCategoryDataSource` によって返される `CategoryID` 列の値に基づいて値を設定する必要がある `CategoryID` パラメーターがあります。</span><span class="sxs-lookup"><span data-stu-id="54889-296">This SqlDataSource will have a `CategoryID` parameter whose value needs to be set based on the `CategoryID` column value returned by the `RandomCategoryDataSource` SqlDataSource in the `Page_Load` event handler.</span></span>

<span data-ttu-id="54889-297">まず、GridView をページに追加し、`ProductsByCategoryDataSource`という名前の新しい SqlDataSource にバインドします。</span><span class="sxs-lookup"><span data-stu-id="54889-297">Start by adding a GridView to the page and bind it to a new SqlDataSource named `ProductsByCategoryDataSource`.</span></span> <span data-ttu-id="54889-298">手順3で行ったのと同様に、`GetProductsByCategory` ストアドプロシージャを呼び出すように SqlDataSource を構成します。</span><span class="sxs-lookup"><span data-stu-id="54889-298">Much like we did in Step 3, configure the SqlDataSource so that it invokes the `GetProductsByCategory` stored procedure.</span></span> <span data-ttu-id="54889-299">[パラメーターソース] ドロップダウンリストは [なし] のままにします。ただし、この既定値はプログラムによって設定されるため、既定値は入力しないでください。</span><span class="sxs-lookup"><span data-stu-id="54889-299">Leave the Parameter source drop-down list set to None, but do not enter a default value, as we will set this default value programmatically.</span></span>

<span data-ttu-id="54889-300">[パラメーターのソースまたは既定値を指定し ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="54889-300">[![Do Not Specify a Parameter Source or Default Value](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image27.png)</span></span>

<span data-ttu-id="54889-301">**図 14**: パラメーターのソースまたは既定値を指定しない ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image28.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-301">**Figure 14**: Do Not Specify a Parameter Source or Default Value ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image28.png))</span></span>

<span data-ttu-id="54889-302">SqlDataSource ウィザードを完了すると、次のような宣言型マークアップが表示されます。</span><span class="sxs-lookup"><span data-stu-id="54889-302">After completing the SqlDataSource wizard, the resulting declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample13.aspx)]

<span data-ttu-id="54889-303">`CategoryID` パラメーターの `DefaultValue` は、`Page_Load` イベントハンドラーでプログラムを使用して割り当てることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-303">We can assign the `DefaultValue` of the `CategoryID` parameter programmatically in the `Page_Load` event handler:</span></span>

[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample14.vb)]

<span data-ttu-id="54889-304">この追加により、ランダムに選択されたカテゴリに関連付けられている製品を示す GridView がページに含まれます。</span><span class="sxs-lookup"><span data-stu-id="54889-304">With this addition, the page includes a GridView that shows the products associated with the randomly selected category.</span></span>

<span data-ttu-id="54889-305">[パラメーターのソースまたは既定値を指定し ![](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="54889-305">[![Do Not Specify a Parameter Source or Default Value](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image29.png)</span></span>

<span data-ttu-id="54889-306">**図 15**: パラメーターのソースまたは既定値を指定しない ([クリックすると、フルサイズの画像が表示](using-parameterized-queries-with-the-sqldatasource-vb/_static/image30.png)されます)</span><span class="sxs-lookup"><span data-stu-id="54889-306">**Figure 15**: Do Not Specify a Parameter Source or Default Value ([Click to view full-size image](using-parameterized-queries-with-the-sqldatasource-vb/_static/image30.png))</span></span>

## <a name="summary"></a><span data-ttu-id="54889-307">要約</span><span class="sxs-lookup"><span data-stu-id="54889-307">Summary</span></span>

<span data-ttu-id="54889-308">SqlDataSource を使用すると、ページ開発者は、パラメーター化されたクエリを定義して、パラメーター値をハードコーディングしたり、定義済みのパラメーターソースから取得したり、プログラムによって割り当てたりすることができます。</span><span class="sxs-lookup"><span data-stu-id="54889-308">The SqlDataSource enables page developers to define parameterized queries whose parameter values can be hard-coded, pulled from pre-defined parameter sources, or assigned programmatically.</span></span> <span data-ttu-id="54889-309">このチュートリアルでは、アドホック SQL クエリとストアドプロシージャの両方について、データソースの構成ウィザードからパラメーター化クエリを作成する方法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="54889-309">In this tutorial we saw how to craft a parameterized query from the Configure Data Source wizard for both ad-hoc SQL queries and stored procedures.</span></span> <span data-ttu-id="54889-310">また、ハードコーディングされたパラメーターソース、パラメーターソースとしての Web コントロール、およびパラメーター値をプログラムによって指定する方法についても説明しました。</span><span class="sxs-lookup"><span data-stu-id="54889-310">We also looked at using hard-coded parameter sources, a Web control as a parameter source, and programmatically specifying the parameter value.</span></span>

<span data-ttu-id="54889-311">ObjectDataSource と同様に、SqlDataSource には、基になるデータを変更する機能も用意されています。</span><span class="sxs-lookup"><span data-stu-id="54889-311">Like with the ObjectDataSource, the SqlDataSource also provides capabilities to modify its underlying data.</span></span> <span data-ttu-id="54889-312">次のチュートリアルでは、SqlDataSource を使用して `INSERT`、`UPDATE`、および `DELETE` ステートメントを定義する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="54889-312">In the next tutorial we'll look at how to define `INSERT`, `UPDATE`, and `DELETE` statements with the SqlDataSource.</span></span> <span data-ttu-id="54889-313">これらのステートメントを追加したら、GridView、DetailsView、および FormView コントロールに固有の組み込みの挿入、編集、および削除機能を利用できます。</span><span class="sxs-lookup"><span data-stu-id="54889-313">Once these statements have been added, we can utilize the built-in inserting, editing, and deleting features inherent to the GridView, DetailsView, and FormView controls.</span></span>

<span data-ttu-id="54889-314">プログラミングを楽しんでください。</span><span class="sxs-lookup"><span data-stu-id="54889-314">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="54889-315">作成者について</span><span class="sxs-lookup"><span data-stu-id="54889-315">About the Author</span></span>

<span data-ttu-id="54889-316">1998以来、 [Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)は 7 asp/創設者 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)の執筆者であり、Microsoft Web テクノロジを使用しています。</span><span class="sxs-lookup"><span data-stu-id="54889-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="54889-317">Scott は、独立したコンサルタント、トレーナー、およびライターとして機能します。</span><span class="sxs-lookup"><span data-stu-id="54889-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="54889-318">彼の最新の書籍は[ *、ASP.NET 2.0 を24時間以内に教え*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)ています。</span><span class="sxs-lookup"><span data-stu-id="54889-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="54889-319">mitchell@4GuysFromRolla.comでアクセスでき[ます。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="54889-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="54889-320">または彼のブログを参照してください。これは[http://ScottOnWriting.NET](http://ScottOnWriting.NET)にあります。</span><span class="sxs-lookup"><span data-stu-id="54889-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="54889-321">ありがとうございました。</span><span class="sxs-lookup"><span data-stu-id="54889-321">Special Thanks To</span></span>

<span data-ttu-id="54889-322">このチュートリアルシリーズは、役に立つ多くのレビュー担当者によってレビューされました。</span><span class="sxs-lookup"><span data-stu-id="54889-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="54889-323">このチュートリアルのリードレビュー担当者は、Scott Clyde、Randell の機能、および Ken による Isa です。</span><span class="sxs-lookup"><span data-stu-id="54889-323">Lead reviewers for this tutorial were Scott Clyde, Randell Schmidt, and Ken Pespisa.</span></span> <span data-ttu-id="54889-324">今後の MSDN 記事を確認することに興味がありますか?</span><span class="sxs-lookup"><span data-stu-id="54889-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="54889-325">その場合は、mitchell@4GuysFromRolla.comの行を削除[します。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="54889-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="54889-326">[前へ](querying-data-with-the-sqldatasource-control-vb.md)
> [次へ](inserting-updating-and-deleting-data-with-the-sqldatasource-vb.md)</span><span class="sxs-lookup"><span data-stu-id="54889-326">[Previous](querying-data-with-the-sqldatasource-control-vb.md)
[Next](inserting-updating-and-deleting-data-with-the-sqldatasource-vb.md)</span></span>
