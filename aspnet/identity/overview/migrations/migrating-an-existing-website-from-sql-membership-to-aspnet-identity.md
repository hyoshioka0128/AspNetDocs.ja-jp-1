---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: 既存の Web サイトを SQL メンバーシップから ASP.NET Identity-ASP.NET 4.x に移行する
author: Rick-Anderson
description: このチュートリアルでは、SQL メンバーシップを使用して作成されたユーザーおよびロールデータを持つ既存の web アプリケーションを新しい ASP.NET Identity に移行する手順について説明します...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: eacfbb8a5b2d1aa3678892bc2077a56185fdebbc
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519155"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="5ff8e-103">既存 Web サイトを SQL メンバーシップから ASP.NET Identity に移行する</span><span class="sxs-lookup"><span data-stu-id="5ff8e-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="5ff8e-104">[Rick Anderson]((https://twitter.com/RickAndMSFT))、 [suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="5ff8e-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="5ff8e-105">このチュートリアルでは、SQL メンバーシップを使用して作成されたユーザーデータとロールデータを使用して、既存の web アプリケーションを新しい ASP.NET Identity システムに移行する手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="5ff8e-106">この方法では、既存のデータベーススキーマを ASP.NET Identity によって必要とされるスキーマに変更し、古い/新しいクラスにフックします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="5ff8e-107">このアプローチを採用した後、データベースを移行すると、今後 Id に対する更新が簡単に処理されるようになります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="5ff8e-108">このチュートリアルでは、Visual Studio 2010 を使用して作成された web アプリケーションテンプレート (Web フォーム) を使用して、ユーザーとロールのデータを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="5ff8e-109">次に、SQL スクリプトを使用して、既存のデータベースを Id システムで必要とされるテーブルに移行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="5ff8e-110">次に、必要な NuGet パッケージをインストールし、メンバーシップ管理に Id システムを使用する新しいアカウント管理ページを追加します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="5ff8e-111">移行のテストとして、SQL メンバーシップを使用して作成されたユーザーはログインでき、新しいユーザーが登録できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="5ff8e-112">完全なサンプルは、[こちら](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/)でご覧いただけます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="5ff8e-113">「 [ASP.NET メンバーシップから ASP.NET Identity への移行](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html)」も参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="5ff8e-114">作業の開始</span><span class="sxs-lookup"><span data-stu-id="5ff8e-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="5ff8e-115">SQL メンバーシップを使用したアプリケーションの作成</span><span class="sxs-lookup"><span data-stu-id="5ff8e-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="5ff8e-116">SQL メンバーシップを使用し、ユーザーデータとロールデータを持つ既存のアプリケーションを使用して開始する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="5ff8e-117">この記事では、Visual Studio 2010 で web アプリケーションを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="5ff8e-118">ASP.NET 構成ツールを使用して、2人のユーザー ( **Oldadminuser**と olduser) を作成し**ます。**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="5ff8e-119">Admin という名前のロールを作成し、そのロールのユーザーとして "oldAdminUser" を追加します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="5ff8e-120">Default.aspx を使用して、サイトの管理者セクションを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="5ff8e-121">Web.config ファイルの authorization タグを設定して、管理者ロールのユーザーのみにアクセスを有効にします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="5ff8e-122">詳細については、こちらを参照してください[https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="5ff8e-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="5ff8e-123">SQL メンバーシップシステムによって作成されたテーブルを理解するには、サーバーエクスプローラーでデータベースを表示します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="5ff8e-124">ユーザーログインデータは、aspnet\_Users および aspnet\_メンバーシップテーブルに格納されますが、ロールデータは aspnet\_Roles テーブルに格納されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="5ff8e-125">Aspnet\_UsersInRoles テーブルに格納されているロールのユーザーに関する情報。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="5ff8e-126">基本的なメンバーシップ管理の場合は、上記の表の情報を ASP.NET Identity システムに移植するだけで十分です。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="5ff8e-127">Visual Studio 2013 への移行</span><span class="sxs-lookup"><span data-stu-id="5ff8e-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="5ff8e-128">[最新の更新プログラム](https://www.microsoft.com/download/details.aspx?id=44921)と共に、Web または Visual Studio 2013 の Visual Studio Express 2013 をインストールします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="5ff8e-129">インストールされているバージョンの Visual Studio で、上記のプロジェクトを開きます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="5ff8e-130">コンピューターに SQL Server Express がインストールされていない場合は、プロジェクトを開いたときにプロンプトが表示されます。これは、接続文字列で SQL Express が使用されているためです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="5ff8e-131">SQL Express のインストールを選択することも、接続文字列を LocalDb に変更することもできます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="5ff8e-132">この記事では、これを LocalDb に変更します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="5ff8e-133">Web.config を開き、接続文字列をから変更します。SQLExpress to (LocalDb) v1.0。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="5ff8e-134">接続文字列から ' User Instance = true ' を削除します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="5ff8e-135">サーバーエクスプローラーを開き、テーブルのスキーマとデータを確認できることを確認します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="5ff8e-136">ASP.NET Identity システムは、バージョン4.5 以上のフレームワークで動作します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="5ff8e-137">アプリケーションを4.5 以降に再ターゲットします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="5ff8e-138">プロジェクトをビルドして、エラーがないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="5ff8e-139">Nuget パッケージのインストール</span><span class="sxs-lookup"><span data-stu-id="5ff8e-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="5ff8e-140">ソリューションエクスプローラーで、プロジェクトを右クリックし、 **[NuGet パッケージの管理]** &gt; ます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="5ff8e-141">検索ボックスに、「Asp.net Identity」と入力します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="5ff8e-142">結果の一覧でパッケージを選択し、[インストール] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="5ff8e-143">[同意する] ボタンをクリックして、使用許諾契約書に同意します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="5ff8e-144">このパッケージでは、EntityFramework および Microsoft ASP.NET Identity Core という依存関係パッケージがインストールされることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="5ff8e-145">同様に、次のパッケージをインストールします (OAuth ログインを有効にしない場合は、最後の4つの OWIN パッケージをスキップします)。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="5ff8e-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="5ff8e-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="5ff8e-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="5ff8e-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="5ff8e-148">Owin (Microsoft. Security)</span><span class="sxs-lookup"><span data-stu-id="5ff8e-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="5ff8e-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="5ff8e-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="5ff8e-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="5ff8e-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="5ff8e-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="5ff8e-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="5ff8e-152">新しい Id システムへのデータベースの移行</span><span class="sxs-lookup"><span data-stu-id="5ff8e-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="5ff8e-153">次の手順では、既存のデータベースを ASP.NET Identity システムに必要なスキーマに移行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="5ff8e-154">これを実現するには、新しいテーブルを作成し、既存のユーザー情報を新しいテーブルに移行するためのコマンドのセットを含む SQL スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="5ff8e-155">スクリプトファイルは[こちらで](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql)参照できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="5ff8e-156">このスクリプトファイルは、このサンプルに固有のものです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-156">This script file is specific to this sample.</span></span> <span data-ttu-id="5ff8e-157">SQL メンバーシップを使用して作成されたテーブルのスキーマがカスタマイズまたは変更された場合は、それに応じてスクリプトを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="5ff8e-158">スキーマ移行用の SQL スクリプトを生成する方法</span><span class="sxs-lookup"><span data-stu-id="5ff8e-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="5ff8e-159">既存のユーザーのデータを使用して ASP.NET Identity クラスをすぐに使用できるようにするには、データベーススキーマを ASP.NET Identity で必要なものに移行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="5ff8e-160">これを行うには、新しいテーブルを追加し、既存の情報をそれらのテーブルにコピーします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="5ff8e-161">既定では、ASP.NET Identity は EntityFramework を使用して Id モデルクラスをデータベースにマップし、情報を格納または取得します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="5ff8e-162">これらのモデルクラスは、ユーザーおよびロールオブジェクトを定義するコア Id インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="5ff8e-163">データベース内のテーブルと列は、これらのモデルクラスに基づいています。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="5ff8e-164">Identity v 2.1.0 の EntityFramework モデルクラスとそのプロパティは次のように定義されています。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="5ff8e-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-165">**IdentityUser**</span></span> | <span data-ttu-id="5ff8e-166">**型**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-166">**Type**</span></span> | <span data-ttu-id="5ff8e-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-167">**IdentityRole**</span></span> | <span data-ttu-id="5ff8e-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-168">**IdentityUserRole**</span></span> | <span data-ttu-id="5ff8e-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="5ff8e-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="5ff8e-171">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-171">Id</span></span> | <span data-ttu-id="5ff8e-172">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-172">string</span></span> | <span data-ttu-id="5ff8e-173">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-173">Id</span></span> | <span data-ttu-id="5ff8e-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="5ff8e-174">RoleId</span></span> | <span data-ttu-id="5ff8e-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="5ff8e-175">ProviderKey</span></span> | <span data-ttu-id="5ff8e-176">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-176">Id</span></span> |
| <span data-ttu-id="5ff8e-177">ユーザー名</span><span class="sxs-lookup"><span data-stu-id="5ff8e-177">Username</span></span> | <span data-ttu-id="5ff8e-178">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-178">string</span></span> | <span data-ttu-id="5ff8e-179">[名前]</span><span class="sxs-lookup"><span data-stu-id="5ff8e-179">Name</span></span> | <span data-ttu-id="5ff8e-180">UserId</span><span class="sxs-lookup"><span data-stu-id="5ff8e-180">UserId</span></span> | <span data-ttu-id="5ff8e-181">UserId</span><span class="sxs-lookup"><span data-stu-id="5ff8e-181">UserId</span></span> | <span data-ttu-id="5ff8e-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="5ff8e-182">ClaimType</span></span> |
| <span data-ttu-id="5ff8e-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="5ff8e-183">PasswordHash</span></span> | <span data-ttu-id="5ff8e-184">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-184">string</span></span> |  |  | <span data-ttu-id="5ff8e-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="5ff8e-185">LoginProvider</span></span> | <span data-ttu-id="5ff8e-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="5ff8e-186">ClaimValue</span></span> |
| <span data-ttu-id="5ff8e-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="5ff8e-187">SecurityStamp</span></span> | <span data-ttu-id="5ff8e-188">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-188">string</span></span> |  |  |  | <span data-ttu-id="5ff8e-189">ユーザー\_Id</span><span class="sxs-lookup"><span data-stu-id="5ff8e-189">User\_Id</span></span> |
| <span data-ttu-id="5ff8e-190">電子メール</span><span class="sxs-lookup"><span data-stu-id="5ff8e-190">Email</span></span> | <span data-ttu-id="5ff8e-191">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-192">電子メールの確認</span><span class="sxs-lookup"><span data-stu-id="5ff8e-192">EmailConfirmed</span></span> | <span data-ttu-id="5ff8e-193">ブール</span><span class="sxs-lookup"><span data-stu-id="5ff8e-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="5ff8e-194">PhoneNumber</span></span> | <span data-ttu-id="5ff8e-195">string</span><span class="sxs-lookup"><span data-stu-id="5ff8e-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="5ff8e-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="5ff8e-197">ブール</span><span class="sxs-lookup"><span data-stu-id="5ff8e-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="5ff8e-198">LockoutEnabled</span></span> | <span data-ttu-id="5ff8e-199">ブール</span><span class="sxs-lookup"><span data-stu-id="5ff8e-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="5ff8e-200">LockoutEndDate</span></span> | <span data-ttu-id="5ff8e-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="5ff8e-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="5ff8e-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="5ff8e-202">AccessFailedCount</span></span> | <span data-ttu-id="5ff8e-203">int</span><span class="sxs-lookup"><span data-stu-id="5ff8e-203">int</span></span> |  |  |  |  |

<span data-ttu-id="5ff8e-204">これらの各モデルのテーブルには、プロパティに対応する列を用意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="5ff8e-205">クラスとテーブル間のマッピングは、`IdentityDBContext`の `OnModelCreating` メソッドで定義されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="5ff8e-206">これは、構成の fluent API 方法として知られています。詳細については、[こちら](https://msdn.microsoft.com/data/jj591617.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="5ff8e-207">クラスの構成は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="5ff8e-208">**クラス**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-208">**Class**</span></span> | <span data-ttu-id="5ff8e-209">**テーブル**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-209">**Table**</span></span> | <span data-ttu-id="5ff8e-210">**主キー**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-210">**Primary key**</span></span> | <span data-ttu-id="5ff8e-211">**外部キー**</span><span class="sxs-lookup"><span data-stu-id="5ff8e-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="5ff8e-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="5ff8e-212">IdentityUser</span></span> | <span data-ttu-id="5ff8e-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="5ff8e-213">AspnetUsers</span></span> | <span data-ttu-id="5ff8e-214">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-214">Id</span></span> |  |
| <span data-ttu-id="5ff8e-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="5ff8e-215">IdentityRole</span></span> | <span data-ttu-id="5ff8e-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="5ff8e-216">AspnetRoles</span></span> | <span data-ttu-id="5ff8e-217">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-217">Id</span></span> |  |
| <span data-ttu-id="5ff8e-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="5ff8e-218">IdentityUserRole</span></span> | <span data-ttu-id="5ff8e-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="5ff8e-219">AspnetUserRole</span></span> | <span data-ttu-id="5ff8e-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="5ff8e-220">UserId + RoleId</span></span> | <span data-ttu-id="5ff8e-221">ユーザー\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="5ff8e-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="5ff8e-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="5ff8e-222">IdentityUserLogin</span></span> | <span data-ttu-id="5ff8e-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="5ff8e-223">AspnetUserLogins</span></span> | <span data-ttu-id="5ff8e-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="5ff8e-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="5ff8e-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="5ff8e-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="5ff8e-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="5ff8e-226">IdentityUserClaim</span></span> | <span data-ttu-id="5ff8e-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="5ff8e-227">AspnetUserClaims</span></span> | <span data-ttu-id="5ff8e-228">ID</span><span class="sxs-lookup"><span data-stu-id="5ff8e-228">Id</span></span> | <span data-ttu-id="5ff8e-229">ユーザー\_Id-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="5ff8e-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="5ff8e-230">この情報を使用して、新しいテーブルを作成する SQL ステートメントを作成できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="5ff8e-231">各ステートメントを個別に記述するか、必要に応じて編集できる EntityFramework PowerShell コマンドを使用してスクリプト全体を生成することができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="5ff8e-232">これを行うには、VS で **[ビュー]** メニューまたは **[ツール]** メニューから**パッケージマネージャーコンソール**を開きます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="5ff8e-233">EntityFramework の移行を有効にするには、コマンド "Enable-移行" を実行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="5ff8e-234">コマンド "Add-migration initial" を実行して、データベースC#を作成するための初期セットアップコードを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="5ff8e-235">最後の手順では、モデルクラスに基づいて SQL スクリプトを生成する "Update-Database – Script" コマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="5ff8e-236">このデータベース生成スクリプトは、新しい列を追加したりデータをコピーしたりするための追加の変更を行う最初の方法として使用できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="5ff8e-237">この利点は、将来のバージョンの Id リリースでモデルクラスが変更されたときに、EntityFramework がデータベーススキーマを変更するために使用する `_MigrationHistory` テーブルを生成することです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="5ff8e-238">SQL メンバーシップのユーザー情報には、Identity user model クラスに含まれるもの以外に、電子メール、パスワードの試行、最後のログインの日付、最後のロックアウト日などのプロパティがありました。これは有用な情報であり、Id システムに引き継がれるようにしたいと考えています。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="5ff8e-239">これを行うには、ユーザーモデルにプロパティを追加して、データベースのテーブル列にマップし直します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="5ff8e-240">これを行うには、`IdentityUser` モデルをサブクラスにするクラスを追加します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="5ff8e-241">このカスタムクラスにプロパティを追加し、SQL スクリプトを編集して、テーブルの作成時に対応する列を追加できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="5ff8e-242">このクラスのコードについては、この記事で詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="5ff8e-243">新しいプロパティを追加した後で `AspnetUsers` テーブルを作成するための SQL スクリプトは、</span><span class="sxs-lookup"><span data-stu-id="5ff8e-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="5ff8e-244">次に、SQL メンバーシップデータベースから、Id 用に新しく追加されたテーブルに既存の情報をコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="5ff8e-245">これは、データを1つのテーブルから別のテーブルに直接コピーすることによって、SQL を通じて行うことができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="5ff8e-246">テーブルの行にデータを追加するには、`INSERT INTO [Table]` コンストラクトを使用します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="5ff8e-247">別のテーブルからコピーするには、`INSERT INTO` ステートメントを `SELECT` ステートメントと共に使用できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="5ff8e-248">すべてのユーザー情報を取得するには、 *aspnet\_ユーザー*および*aspnet\_メンバーシップ*テーブルにクエリを実行し、データを*AspNetUsers*テーブルにコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="5ff8e-249">`INSERT INTO` と `SELECT` を `JOIN` および `LEFT OUTER JOIN` ステートメントと共に使用します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="5ff8e-250">テーブル間でのデータのクエリとコピーの詳細については、こちら[のリンクを](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx)参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="5ff8e-251">また、AspnetUserLogins テーブルと AspnetUserClaims テーブルは、既定ではこの値にマップされる情報が SQL メンバーシップにないため、では空になります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="5ff8e-252">コピーされる情報は、ユーザーとロールのみです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="5ff8e-253">前の手順で作成したプロジェクトでは、ユーザーテーブルに情報をコピーする SQL クエリはになります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="5ff8e-254">上記の SQL ステートメントでは、 *aspnet\_Users*および*aspnet\_* の各ユーザーに関する情報が、 *AspnetUsers*テーブルの列にコピーされます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="5ff8e-255">ここで行った変更は、パスワードをコピーしたときだけです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="5ff8e-256">SQL メンバーシップのパスワードの暗号化アルゴリズムでは ' PasswordSalt ' と ' Passwordsalt ' が使用されているため、ハッシュされたパスワードと共にコピーして、Id によってパスワードの暗号化を解除することができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="5ff8e-257">詳細については、「カスタムパスワードの hasher をフックするとき」で詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="5ff8e-258">このスクリプトファイルは、このサンプルに固有のものです。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-258">This script file is specific to this sample.</span></span> <span data-ttu-id="5ff8e-259">追加のテーブルを持つアプリケーションでは、開発者は同様のアプローチに従って、ユーザーモデルクラスにプロパティを追加し、AspnetUsers テーブルの列にマップすることができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="5ff8e-260">スクリプトを実行するには、</span><span class="sxs-lookup"><span data-stu-id="5ff8e-260">To run the script,</span></span>

1. <span data-ttu-id="5ff8e-261">サーバー エクスプローラーを開きます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-261">Open Server Explorer.</span></span> <span data-ttu-id="5ff8e-262">"ApplicationServices" 接続を展開してテーブルを表示します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="5ff8e-263">[テーブル] ノードを右クリックし、[新しいクエリ] オプションを選択します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="5ff8e-264">クエリウィンドウで、SQL スクリプト全体をコピーして、移行 .sql ファイルから貼り付けます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="5ff8e-265">[実行] 矢印ボタンを押してスクリプトファイルを実行します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="5ff8e-266">サーバーエクスプローラーウィンドウを更新します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="5ff8e-267">5つの新しいテーブルがデータベースに作成されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="5ff8e-268">SQL メンバーシップテーブルの情報を新しい Id システムにマップする方法を次に示します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="5ff8e-269">aspnet\_ロール--&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="5ff8e-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="5ff8e-270">asp\_netUsers および asp\_Netusers--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="5ff8e-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="5ff8e-271">aspnet\_UserInRoles--&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="5ff8e-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="5ff8e-272">上のセクションで説明したように、AspNetUserClaims テーブルと AspNetUserLogins テーブルは空です。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="5ff8e-273">AspNetUser テーブルの ' 識別子 ' フィールドは、次の手順として定義されているモデルクラス名と一致する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="5ff8e-274">また、PasswordHash 列は、"暗号化されたパスワード | パスワード salt | パスワードの形式" という形式になっています。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="5ff8e-275">これにより、古いパスワードを再利用できるように、特別な SQL メンバーシップ暗号化ロジックを使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="5ff8e-276">これについては、この記事の後半で説明します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="5ff8e-277">モデルとメンバーシップページの作成</span><span class="sxs-lookup"><span data-stu-id="5ff8e-277">Creating models and membership pages</span></span>

<span data-ttu-id="5ff8e-278">前述のように、Id 機能は Entity Framework を使用してデータベースと対話し、既定でアカウント情報を格納します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="5ff8e-279">テーブル内の既存のデータを操作するには、テーブルにマップし直して Id システムにフックするモデルクラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="5ff8e-280">Id コントラクトの一部として、モデルクラスは、Identity. Core dll で定義されているインターフェイスを実装するか、またはこれらのインターフェイスの既存の実装を拡張して使用できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="5ff8e-281">このサンプルでは、AspNetRoles、AspNetUserClaims、AspNetLogins、AspNetUserRole の各テーブルに、Id システムの既存の実装に似た列があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="5ff8e-282">そのため、既存のクラスを再利用して、これらのテーブルにマップすることができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="5ff8e-283">AspNetUser テーブルには、SQL メンバーシップテーブルから追加情報を格納するために使用される追加の列がいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="5ff8e-284">これは、' ユーザー ' の既存の実装を拡張し、追加のプロパティを追加するモデルクラスを作成することによってマップできます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="5ff8e-285">プロジェクトにモデルフォルダーを作成し、クラスユーザーを追加します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="5ff8e-286">クラスの名前は、' AspnetUsers ' テーブルの ' 識別子 ' 列に追加されたデータと一致している必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="5ff8e-287">User クラスでは、 *Microsoft .net framework* dll のユーザークラスを拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="5ff8e-288">AspNetUser 列にマップし直すクラスのプロパティを宣言します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="5ff8e-289">プロパティ ID、ユーザー名、PasswordHash は、ユーザーに定義されているので、省略します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="5ff8e-290">すべてのプロパティを持つ User クラスのコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="5ff8e-291">モデル内のデータをテーブルに保存し、テーブルからデータを取得してモデルを作成するためには、Entity Framework DbContext クラスが必要です。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="5ff8e-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span><span class="sxs-lookup"><span data-stu-id="5ff8e-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="5ff8e-293">ユーザー&gt;&lt;tuser は、"TUser" クラスを受け取ります。このクラスには、ユーザークラスを拡張する任意のクラスを指定できます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="5ff8e-294">' Model ' フォルダーの下にある "ユーザー" クラスを渡して、"モデル" フォルダーの下にある [ユーザー] クラスを渡す新しいクラス ApplicationDBContext を作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="5ff8e-295">新しい Id システムでのユーザー管理*は、* usermanager の&lt;tuser&gt; クラスを使用して実行されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="5ff8e-296">UserManager を拡張するカスタムクラスを作成し、手順 1. で作成した ' User ' クラスを渡す必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="5ff8e-297">[モデル] フォルダーで、UserManager&lt;ユーザーを拡張する新しいクラス UserManager を作成し&gt;</span><span class="sxs-lookup"><span data-stu-id="5ff8e-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="5ff8e-298">アプリケーションのユーザーのパスワードは暗号化され、データベースに格納されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="5ff8e-299">SQL メンバーシップで使用される暗号アルゴリズムは、新しい Id システムとは異なります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="5ff8e-300">古いパスワードを再利用するには、古いユーザーが SQL メンバーシップアルゴリズムを使用してログインしているときにパスワードの暗号化を解除し、新しいユーザーの Id で暗号化アルゴリズムを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="5ff8e-301">UserManager クラスには、' IPasswordHasher ' インターフェイスを実装するクラスのインスタンスを格納する ' PasswordHasher ' プロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="5ff8e-302">これは、ユーザー認証トランザクション中にパスワードの暗号化/暗号化解除に使用されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="5ff8e-303">手順 3. で定義した UserManager クラスで、新しいクラス SQLPasswordHasher を作成し、次のコードをコピーします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="5ff8e-304">System.string および system.string 名前空間をインポートして、コンパイルエラーを解決します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="5ff8e-305">EncodePassword メソッドは、既定の SQL メンバーシップ暗号化の実装に従ってパスワードを暗号化します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="5ff8e-306">これは、System.web dll から取得されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="5ff8e-307">以前のアプリでカスタム実装を使用していた場合は、ここに反映させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="5ff8e-308">*EncodePassword*メソッドを使用して指定されたパスワードをハッシュする方法、またはプレーンテキストパスワードをデータベース内の既存のパスワードで確認する方法を、 *Hashpassword*と*VerifyHashedPassword*の2つのメソッドで定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="5ff8e-309">SQL メンバーシップシステムは、パスワードを登録または変更するときにユーザーが入力したパスワードをハッシュするために、PasswordHash、PasswordSalt、および Passwordsalt を使用しました。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="5ff8e-310">移行中、3つのフィールドはすべて、AspNetUser テーブルの PasswordHash 列に ' | ' 文字で区切られて格納されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="5ff8e-311">ユーザーがログインし、パスワードにこれらのフィールドが含まれている場合、SQL メンバーシップ暗号化を使用してパスワードを確認します。それ以外の場合は、Id システムの既定の暗号化を使用してパスワードを確認します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="5ff8e-312">このようにすると、アプリを移行した後で、古いユーザーがパスワードを変更する必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="5ff8e-313">UserManager クラスのコンストラクターを宣言し、これを SQLPasswordHasher としてコンストラクターのプロパティに渡します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="5ff8e-314">新しいアカウント管理ページを作成する</span><span class="sxs-lookup"><span data-stu-id="5ff8e-314">Create new account management pages</span></span>

<span data-ttu-id="5ff8e-315">移行の次の手順では、ユーザーが登録してログインできるようにするアカウント管理ページを追加します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="5ff8e-316">SQL メンバーシップの古いアカウントページでは、新しい Id システムで動作しないコントロールが使用されます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="5ff8e-317">新しいユーザー管理ページを追加するには、このリンクのチュートリアルに従って、プロジェクトを既に作成し、NuGet パッケージを追加したので、「アプリケーションにユーザーを登録するための Web フォームを追加する」の手順から開始[https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md)ます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="5ff8e-318">ここで使用しているプロジェクトを操作するには、サンプルにいくつかの変更を加える必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="5ff8e-319">Register.aspx.cs および Login.aspx.cs の分離コードクラスは、Id パッケージの `UserManager` を使用してユーザーを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="5ff8e-320">この例では、前に説明した手順に従って、[モデル] フォルダーに追加した UserManager を使用します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="5ff8e-321">Register.aspx.cs および Login.aspx.cs コードビハインドクラスのユーザーではなく、作成されたユーザークラスを使用します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="5ff8e-322">これにより、カスタムユーザークラスが Id システムにフックされます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="5ff8e-323">データベースを作成する部分はスキップできます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="5ff8e-324">開発者は、新しいユーザーの ApplicationId を現在のアプリケーション ID と一致するように設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="5ff8e-325">これを行うには、Register.aspx.cs クラスでユーザーオブジェクトが作成される前に、このアプリケーションの ApplicationId に対してクエリを実行し、ユーザーオブジェクトを作成する前に設定します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="5ff8e-326">例:</span><span class="sxs-lookup"><span data-stu-id="5ff8e-326">Example:</span></span>

    <span data-ttu-id="5ff8e-327">Register.aspx.cs ページでメソッドを定義して、aspnet\_Applications テーブルに対してクエリを実行し、アプリケーション名に従ってアプリケーション Id を取得します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="5ff8e-328">ここで、ユーザーオブジェクトに対してこれを設定します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="5ff8e-329">古いユーザー名とパスワードを使用して、既存のユーザーをログインします。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="5ff8e-330">[登録] ページを使用して、新しいユーザーを作成します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="5ff8e-331">また、ユーザーが期待どおりにロールに含まれていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="5ff8e-332">Id システムに移植すると、ユーザーが Open Authentication (OAuth) をアプリケーションに追加するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="5ff8e-333">OAuth が有効[になっているサンプルを](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/)参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5ff8e-334">次のステップ</span><span class="sxs-lookup"><span data-stu-id="5ff8e-334">Next Steps</span></span>

<span data-ttu-id="5ff8e-335">このチュートリアルでは、ユーザーを SQL メンバーシップから ASP.NET Identity に移植する方法を説明しましたが、プロファイルデータを移植していませんでした。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="5ff8e-336">次のチュートリアルでは、SQL メンバーシップから新しい Id システムへのプロファイルデータの移植について説明します。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="5ff8e-337">この記事の下部にあるフィードバックを残すことができます。</span><span class="sxs-lookup"><span data-stu-id="5ff8e-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="5ff8e-338">*記事の内容を確認するための Tom Dykstra と Rick Anderson に感謝します。*</span><span class="sxs-lookup"><span data-stu-id="5ff8e-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
