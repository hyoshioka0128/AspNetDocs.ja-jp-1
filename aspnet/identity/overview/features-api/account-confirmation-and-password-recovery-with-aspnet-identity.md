---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: アカウントの確認 & パスワードの回復-C#ASP.NET Identity ()-ASP.NET 4.x
author: HaoK
description: このチュートリアルを実行する前に、「ログイン、電子メール確認、パスワードリセットを使用して secure ASP.NET MVC 5 web アプリを作成する」を完了しておく必要があります。 このチュートリアル...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519116"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="1be64-104">ASP.NET Identity (C#) を使用したアカウントの確認とパスワードの回復</span><span class="sxs-lookup"><span data-stu-id="1be64-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="1be64-105">このチュートリアルを実行する前に[、「ログイン、電子メール確認、パスワードリセットを使用して secure ASP.NET MVC 5 web アプリを作成する」](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)を完了しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="1be64-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="1be64-106">このチュートリアルでは詳細について説明します。また、ローカルアカウントの確認のために電子メールを設定し、ユーザーが ASP.NET Identity で忘れたパスワードをリセットできるようにする方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="1be64-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="1be64-107">ローカルユーザーアカウントでは、ユーザーはアカウントのパスワードを作成する必要があり、そのパスワードは web アプリで (安全に) 格納されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="1be64-108">ASP.NET Identity は、ユーザーがアプリのパスワードを作成する必要がないソーシャルアカウントもサポートしています。</span><span class="sxs-lookup"><span data-stu-id="1be64-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="1be64-109">[ソーシャルアカウント](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)は、サードパーティ (Google、Twitter、Facebook、Microsoft など) を使用してユーザーを認証します。</span><span class="sxs-lookup"><span data-stu-id="1be64-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="1be64-110">このトピックでは、以下の内容を説明します。</span><span class="sxs-lookup"><span data-stu-id="1be64-110">This topic covers the following:</span></span>

- <span data-ttu-id="1be64-111">[ASP.NET MVC アプリを作成](#createMvc)し、ASP.NET Identity の機能を調べます。</span><span class="sxs-lookup"><span data-stu-id="1be64-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="1be64-112">Id サンプルをビルドする</span><span class="sxs-lookup"><span data-stu-id="1be64-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="1be64-113">電子メールの確認を設定する</span><span class="sxs-lookup"><span data-stu-id="1be64-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="1be64-114">新しいユーザーが自分の電子メールエイリアスを登録すると、ローカルアカウントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="1be64-115">[登録] ボタンを選択すると、検証トークンを含む確認メールが電子メールアドレスに送信されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="1be64-116">ユーザーには、アカウントの確認トークンを含む電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="1be64-117">リンクを選択すると、アカウントが確認されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="1be64-118">パスワードの回復/リセット</span><span class="sxs-lookup"><span data-stu-id="1be64-118">Password recovery/reset</span></span>

<span data-ttu-id="1be64-119">ローカルユーザーのパスワードを忘れた場合、セキュリティトークンを電子メールアカウントに送信して、パスワードをリセットできるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="1be64-120">ユーザーはすぐに、パスワードをリセットするためのリンクを含む電子メールを受け取ります。</span><span class="sxs-lookup"><span data-stu-id="1be64-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="1be64-121">リンクを選択すると、[リセット] ページに移動します。</span><span class="sxs-lookup"><span data-stu-id="1be64-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="1be64-122">**[リセット]** ボタンを選択すると、パスワードがリセットされたことが確認されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="1be64-123">ASP.NET Web アプリを作成する</span><span class="sxs-lookup"><span data-stu-id="1be64-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="1be64-124">まず、 [Visual Studio 2017](https://visualstudio.microsoft.com/)をインストールして実行します。</span><span class="sxs-lookup"><span data-stu-id="1be64-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="1be64-125">新しい ASP.NET Web プロジェクトを作成し、MVC テンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="1be64-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="1be64-126">Web フォームでも ASP.NET Identity がサポートされているため、web フォームアプリで同様の手順に従うことができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="1be64-127">認証を個々の**ユーザーアカウント**に変更します。</span><span class="sxs-lookup"><span data-stu-id="1be64-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="1be64-128">アプリを実行し、 **[登録]** リンクを選択してユーザーを登録します。</span><span class="sxs-lookup"><span data-stu-id="1be64-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="1be64-129">この時点で、電子メールの検証は、 [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性でのみ行うことができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="1be64-130">サーバーエクスプローラーで、 **[Data Connections\DefaultConnection\Tables\AspNetUsers]** に移動し、右クリックして、 **[テーブル定義を開く]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="1be64-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="1be64-131">次の図は、`AspNetUsers` スキーマを示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="1be64-132">**AspNetUsers**テーブルを右クリックし、 **[テーブルデータの表示]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="1be64-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="1be64-133">この時点で、電子メールは確認されていません。</span><span class="sxs-lookup"><span data-stu-id="1be64-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="1be64-134">ASP.NET Identity の既定のデータストアは Entity Framework ですが、他のデータストアを使用したり、フィールドを追加したりするように構成することができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="1be64-135">このチュートリアルの最後にある「[その他のリソース](#addRes)」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="1be64-136">[OWIN startup クラス](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)( *Startup.cs* ) は、アプリの起動時に呼び出され、 *app\_Start\Startup.Auth.cs*の `ConfigureAuth` メソッドを呼び出します。これにより、OWIN パイプラインが構成され、ASP.NET Identity が初期化されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="1be64-137">`ConfigureAuth` メソッドを調べます。</span><span class="sxs-lookup"><span data-stu-id="1be64-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="1be64-138">各 `CreatePerOwinContext` 呼び出しは、指定された型のインスタンスを作成するために要求ごとに1回呼び出されるコールバック (`OwinContext`に保存されます) を登録します。</span><span class="sxs-lookup"><span data-stu-id="1be64-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="1be64-139">コンストラクターにブレークポイントを設定し、各型 (`ApplicationDbContext, ApplicationUserManager`) の `Create` メソッドを設定して、各要求で呼び出されることを確認できます。</span><span class="sxs-lookup"><span data-stu-id="1be64-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="1be64-140">`ApplicationDbContext` と `ApplicationUserManager` のインスタンスは OWIN コンテキストに格納され、アプリケーション全体でアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="1be64-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="1be64-141">クッキーミドルウェアを使用して OWIN パイプラインにフックする ASP.NET Identity ます。</span><span class="sxs-lookup"><span data-stu-id="1be64-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="1be64-142">詳細については、 [ASP.NET Identity の UserManager クラスの要求ごとの有効期間管理に](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)関する説明を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="1be64-143">セキュリティプロファイルを変更すると、新しいセキュリティスタンプが生成され、 *AspNetUsers*テーブルの `SecurityStamp` フィールドに格納されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="1be64-144">`SecurityStamp` フィールドは、セキュリティ cookie とは異なります。</span><span class="sxs-lookup"><span data-stu-id="1be64-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="1be64-145">セキュリティクッキーは `AspNetUsers` テーブル (または Id DB 内の他の場所) に格納されません。</span><span class="sxs-lookup"><span data-stu-id="1be64-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="1be64-146">セキュリティ cookie トークンは、 [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)を使用して自己署名され、`UserId, SecurityStamp` と有効期限情報を使用して作成されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="1be64-147">Cookie ミドルウェアは、各要求の cookie を確認します。</span><span class="sxs-lookup"><span data-stu-id="1be64-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="1be64-148">`Startup` クラスの `SecurityStampValidator` メソッドは、データベースにヒットし、`validateInterval`で指定されているように、セキュリティスタンプを定期的にチェックします。</span><span class="sxs-lookup"><span data-stu-id="1be64-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="1be64-149">これは、セキュリティプロファイルを変更しない限り、30分 (このサンプルでは) ごとに実行されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="1be64-150">データベースへのトリップを最小限に抑えるために、30分間隔が選択されました。</span><span class="sxs-lookup"><span data-stu-id="1be64-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="1be64-151">詳細については[、「2要素認証チュートリアル](index.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="1be64-152">`UseCookieAuthentication` メソッドは、コード内のコメントに従って cookie 認証をサポートします。</span><span class="sxs-lookup"><span data-stu-id="1be64-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="1be64-153">`SecurityStamp` のフィールドと関連付けられたコードによって、アプリに追加のセキュリティ層が提供されます。パスワードを変更すると、ログインに使用したブラウザーからログアウトされます。</span><span class="sxs-lookup"><span data-stu-id="1be64-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="1be64-154">`SecurityStampValidator.OnValidateIdentity` メソッドを使用すると、ユーザーがログインするときに、アプリはセキュリティトークンを検証できます。パスワードを変更したり、外部ログインを使用したりするときに使用されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="1be64-155">これは、古いパスワードを使用して生成されたトークン (cookie) がすべて無効になるようにするために必要です。</span><span class="sxs-lookup"><span data-stu-id="1be64-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="1be64-156">サンプルプロジェクトでは、ユーザーのパスワードを変更すると、ユーザーの新しいトークンが生成され、以前のトークンは無効になり `SecurityStamp` フィールドが更新されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="1be64-157">Id システムを使用すると、ユーザーのセキュリティプロファイルが変更されたとき (たとえば、ユーザーがパスワードを変更したり、関連付けられているログイン (Facebook、Google、Microsoft アカウントなど) を変更したりしたときに、ユーザーがログオフしてからログアウトするようにアプリを構成することができます。ブラウザーインスタンス。</span><span class="sxs-lookup"><span data-stu-id="1be64-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="1be64-158">たとえば、次の図は、1つのボタンを選択することによって、ユーザーがすべてのブラウザーインスタンス (この場合は IE、Firefox、Chrome) からサインアウトできる[サインアウトサンプル](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample)アプリを示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="1be64-159">または、サンプルを使用すると、特定のブラウザーインスタンスからのみログアウトできます。</span><span class="sxs-lookup"><span data-stu-id="1be64-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="1be64-160">[シングルサインアウトサンプル](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample)アプリでは、ASP.NET Identity でセキュリティトークンを再生成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="1be64-161">これは、古いパスワードを使用して生成されたトークン (cookie) がすべて無効になるようにするために必要です。</span><span class="sxs-lookup"><span data-stu-id="1be64-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="1be64-162">この機能により、アプリケーションのセキュリティが強化されます。パスワードを変更すると、このアプリケーションにログインした場所でログアウトされます。</span><span class="sxs-lookup"><span data-stu-id="1be64-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="1be64-163">*アプリ\_Start\IdentityConfig.cs*ファイルには、`ApplicationUserManager`、`EmailService`、および `SmsService` の各クラスが含まれています。</span><span class="sxs-lookup"><span data-stu-id="1be64-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="1be64-164">`EmailService` クラスと `SmsService` クラスはそれぞれ `IIdentityMessageService` インターフェイスを実装します。そのため、各クラスには、電子メールと SMS を構成するための一般的なメソッドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="1be64-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="1be64-165">このチュートリアルでは、 [Sendgrid](http://sendgrid.com/)を使用して電子メール通知を追加する方法のみを示していますが、SMTP などのメカニズムを使用して電子メールを送信することもできます。</span><span class="sxs-lookup"><span data-stu-id="1be64-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="1be64-166">`Startup` クラスには、ソーシャルログイン (Facebook、Twitter など) を追加するためのボイラープレートも含まれています。詳細については、 [facebook、twitter、LinkedIn、Google OAuth2 サインオンを使用した my チュートリアル MVC 5 アプリ](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="1be64-167">`ApplicationUserManager` クラスを調べます。このクラスには、ユーザーの id 情報が含まれており、次の機能が構成されています。</span><span class="sxs-lookup"><span data-stu-id="1be64-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="1be64-168">パスワードの強度の要件。</span><span class="sxs-lookup"><span data-stu-id="1be64-168">Password strength requirements.</span></span>
- <span data-ttu-id="1be64-169">ユーザーのロックアウト (試行回数と時間)。</span><span class="sxs-lookup"><span data-stu-id="1be64-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="1be64-170">2要素認証 (2FA)。</span><span class="sxs-lookup"><span data-stu-id="1be64-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="1be64-171">もう1つのチュートリアルでは、2FA と SMS について説明します。</span><span class="sxs-lookup"><span data-stu-id="1be64-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="1be64-172">電子メールと SMS サービスをフックする。</span><span class="sxs-lookup"><span data-stu-id="1be64-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="1be64-173">(別のチュートリアルで SMS について説明します)。</span><span class="sxs-lookup"><span data-stu-id="1be64-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="1be64-174">`ApplicationUserManager` クラスは、ジェネリック `UserManager<ApplicationUser>` クラスから派生します。</span><span class="sxs-lookup"><span data-stu-id="1be64-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="1be64-175">`ApplicationUser` は、[ユーザー](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)から派生します。</span><span class="sxs-lookup"><span data-stu-id="1be64-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="1be64-176">`IdentityUser` は、ジェネリック `IdentityUser` クラスから派生します。</span><span class="sxs-lookup"><span data-stu-id="1be64-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="1be64-177">上のプロパティは、上に示した `AspNetUsers` テーブルのプロパティと一致します。</span><span class="sxs-lookup"><span data-stu-id="1be64-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="1be64-178">`IUser` の汎用引数を使用すると、主キーに対して異なる型を使用してクラスを派生させることができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="1be64-179">主キーを文字列から int または GUID に変更する方法を示す[Changepk](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK)サンプルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="1be64-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="1be64-180">ApplicationUser</span></span>

<span data-ttu-id="1be64-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) は、 *Models\IdentityModels.cs*で次のように定義されています。</span><span class="sxs-lookup"><span data-stu-id="1be64-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="1be64-182">上の強調表示されたコードは、 [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)を生成します。</span><span class="sxs-lookup"><span data-stu-id="1be64-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="1be64-183">ASP.NET Identity と OWIN Cookie 認証はクレームベースであるため、フレームワークでは、ユーザーの `ClaimsIdentity` を生成するようにアプリに要求します。</span><span class="sxs-lookup"><span data-stu-id="1be64-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="1be64-184">`ClaimsIdentity` には、ユーザーの名前、年齢、ユーザーが属するロールなど、ユーザーのすべての要求に関する情報が含まれています。</span><span class="sxs-lookup"><span data-stu-id="1be64-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="1be64-185">この段階で、ユーザーに対する要求をさらに追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="1be64-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="1be64-186">OWIN `AuthenticationManager.SignIn` メソッドは、`ClaimsIdentity` を渡し、ユーザーにサインインします。</span><span class="sxs-lookup"><span data-stu-id="1be64-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="1be64-187">[Facebook、Twitter、LinkedIn、Google OAuth2 サインオンを使用した MVC 5 アプリ](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)は、`ApplicationUser` クラスにプロパティを追加する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="1be64-188">電子メールの確認</span><span class="sxs-lookup"><span data-stu-id="1be64-188">Email confirmation</span></span>

<span data-ttu-id="1be64-189">新しいユーザーが登録した電子メールを確認して、他のユーザーが偽装していないこと (つまり、他のユーザーの電子メールに登録されていないこと) を確認することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="1be64-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="1be64-190">ディスカッションフォーラムがあるとしたら、`"bob@example.com"` が `"joe@contoso.com"`として登録されないようにしたいと考えています。</span><span class="sxs-lookup"><span data-stu-id="1be64-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="1be64-191">電子メールを確認しないと、`"joe@contoso.com"` アプリから不要な電子メールを受け取る可能性があります。</span><span class="sxs-lookup"><span data-stu-id="1be64-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="1be64-192">Bob が誤って `"bib@example.com"` として登録されていて気付かないとしても、アプリには正しい電子メールがないため、パスワードの回復を使用することはできません。</span><span class="sxs-lookup"><span data-stu-id="1be64-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="1be64-193">電子メールの確認では、bot から制限された保護のみを提供し、特定のスパム送信者からの保護を提供しません。登録に使用できる多くの勤務先の電子メールエイリアスがあります。次のサンプルでは、アカウントが確認されるまで、ユーザーはパスワードを変更できません (登録した電子メールアカウントで受信した確認リンクを選択します)。この作業フローを他のシナリオに適用できます。たとえば、管理者が作成した新しいアカウントのパスワードを確認およびリセットするためのリンクを送信したり、ユーザーがプロファイルを変更したときに電子メールを送信したりすることができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="1be64-194">通常は、電子メール、SMS テキストメッセージ、または別のメカニズムによって確認される前に、新しいユーザーが web サイトにデータを投稿できないようにします。</span><span class="sxs-lookup"><span data-stu-id="1be64-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="1be64-195">より完全なサンプルをビルドする</span><span class="sxs-lookup"><span data-stu-id="1be64-195">Build a more complete sample</span></span>

<span data-ttu-id="1be64-196">このセクションでは、NuGet を使用して、使用するより完全なサンプルをダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="1be64-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="1be64-197">新しい***空***の ASP.NET Web プロジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="1be64-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="1be64-198">パッケージマネージャーコンソールで、次のコマンドを入力します。</span><span class="sxs-lookup"><span data-stu-id="1be64-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="1be64-199">このチュートリアルでは、 [Sendgrid](http://sendgrid.com/)を使用して電子メールを送信します。</span><span class="sxs-lookup"><span data-stu-id="1be64-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="1be64-200">`Identity.Samples` パッケージによって、使用するコードがインストールされます。</span><span class="sxs-lookup"><span data-stu-id="1be64-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="1be64-201">[SSL を使用するようにプロジェクトを](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)設定します。</span><span class="sxs-lookup"><span data-stu-id="1be64-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="1be64-202">アプリを実行し、 **[登録]** リンクを選択して、登録フォームを投稿することで、ローカルアカウントの作成をテストします。</span><span class="sxs-lookup"><span data-stu-id="1be64-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="1be64-203">電子メールの確認をシミュレートするデモ用電子メールのリンクを選択します。</span><span class="sxs-lookup"><span data-stu-id="1be64-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="1be64-204">サンプルからデモ用電子メールリンクの確認コードを削除します (アカウントコントローラーの `ViewBag.Link` コード)。</span><span class="sxs-lookup"><span data-stu-id="1be64-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="1be64-205">`DisplayEmail` と `ForgotPasswordConfirmation` のアクションメソッドと razor ビュー) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="1be64-206">このサンプルのセキュリティ設定を変更した場合、生産アプリは、行われた変更を明示的に呼び出すセキュリティ監査を受ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="1be64-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="1be64-207">App\_Start\IdentityConfig.cs のコードを確認する</span><span class="sxs-lookup"><span data-stu-id="1be64-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="1be64-208">このサンプルでは、アカウントを作成し、*管理者*ロールに追加する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="1be64-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="1be64-209">サンプルの電子メールは、管理者アカウントに使用する電子メールに置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="1be64-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="1be64-210">管理者アカウントを作成するための最も簡単な方法は、プログラムで `Seed` 方法です。</span><span class="sxs-lookup"><span data-stu-id="1be64-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="1be64-211">ユーザーとロールを作成および管理するためのツールを今後用意する予定です。</span><span class="sxs-lookup"><span data-stu-id="1be64-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="1be64-212">サンプルコードを使用すると、ユーザーとロールを作成および管理できますが、ロールとユーザー管理ページを実行するには、まず管理者アカウントが必要です。</span><span class="sxs-lookup"><span data-stu-id="1be64-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="1be64-213">このサンプルでは、DB がシード処理されるときに管理者アカウントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="1be64-214">パスワードを変更し、電子メール通知を受信できるアカウントに名前を変更します。</span><span class="sxs-lookup"><span data-stu-id="1be64-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="1be64-215">セキュリティ-機密データをソースコードに格納しません。</span><span class="sxs-lookup"><span data-stu-id="1be64-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="1be64-216">前に説明したように、startup クラスの `app.CreatePerOwinContext` 呼び出しは、アプリケーション DB コンテンツ、ユーザーマネージャー、およびロールマネージャークラスの `Create` メソッドにコールバックを追加します。</span><span class="sxs-lookup"><span data-stu-id="1be64-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="1be64-217">OWIN パイプラインは、各要求に対してこれらのクラスの `Create` メソッドを呼び出し、各クラスのコンテキストを格納します。</span><span class="sxs-lookup"><span data-stu-id="1be64-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="1be64-218">アカウントコントローラーは、HTTP コンテキスト (OWIN コンテキストを含む) からユーザーマネージャーを公開します。</span><span class="sxs-lookup"><span data-stu-id="1be64-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="1be64-219">ユーザーがローカルアカウントを登録すると、`HTTP Post Register` メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="1be64-220">上記のコードでは、モデルデータを使用して、入力された電子メールとパスワードを使用して新しいユーザーアカウントを作成します。</span><span class="sxs-lookup"><span data-stu-id="1be64-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="1be64-221">データストアに電子メールエイリアスが含まれている場合、アカウントの作成は失敗し、フォームが再び表示されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="1be64-222">`GenerateEmailConfirmationTokenAsync` メソッドは、セキュリティで保護された確認トークンを作成し、ASP.NET Identity データストアに格納します。</span><span class="sxs-lookup"><span data-stu-id="1be64-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="1be64-223">[Url. Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)メソッドは、`UserId` と確認トークンを含むリンクを作成します。</span><span class="sxs-lookup"><span data-stu-id="1be64-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="1be64-224">その後、このリンクはユーザーに電子メールで送信され、ユーザーは電子メールアプリ内のリンクを選択してアカウントを確認することができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="1be64-225">電子メールの確認を設定する</span><span class="sxs-lookup"><span data-stu-id="1be64-225">Set up email confirmation</span></span>

<span data-ttu-id="1be64-226">[Azure SendGrid のサインアップページ](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)にアクセスし、無料アカウントに登録します。</span><span class="sxs-lookup"><span data-stu-id="1be64-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="1be64-227">SendGrid を構成するには、次のようなコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="1be64-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="1be64-228">電子メールクライアントは、テキストメッセージのみを頻繁に受け入れます (HTML は使用しません)。</span><span class="sxs-lookup"><span data-stu-id="1be64-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="1be64-229">メッセージはテキストと HTML で提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="1be64-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="1be64-230">上記の SendGrid サンプルでは、上記の `myMessage.Text` と `myMessage.Html` コードを使用してこれを行います。</span><span class="sxs-lookup"><span data-stu-id="1be64-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="1be64-231">次のコードは、 [send-mailmessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)クラスを使用して電子メールを送信する方法を示しています。ここで `message.Body` はリンクのみを返します。</span><span class="sxs-lookup"><span data-stu-id="1be64-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="1be64-232">セキュリティ-機密データをソースコードに格納しません。</span><span class="sxs-lookup"><span data-stu-id="1be64-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="1be64-233">アカウントと資格情報は appSetting に格納されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="1be64-234">Azure では、これらの値を Azure portal の [ **[構成](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** ] タブに安全に格納できます。</span><span class="sxs-lookup"><span data-stu-id="1be64-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="1be64-235">[ASP.NET と Azure にパスワードやその他の機密データをデプロイするためのベストプラクティス](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="1be64-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="1be64-236">SendGrid の資格情報を入力し、アプリを実行して、電子メールのエイリアスで登録します。電子メールの [確認] リンクを選択できます。</span><span class="sxs-lookup"><span data-stu-id="1be64-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="1be64-237">[Outlook.com](http://outlook.com)の電子メールアカウントでこれを行う方法については、 [ C# Outlook.Com smtp Host の John の smtp 構成に関する](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)記事 ASP.NET Identity と「[2.0: アカウントの検証と2要素認証](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)の投稿の設定」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="1be64-238">ユーザーが**登録**ボタンを選択すると、検証トークンを含む確認メールが電子メールアドレスに送信されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="1be64-239">ユーザーには、アカウントの確認トークンを含む電子メールが送信されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="1be64-240">コードを調べる</span><span class="sxs-lookup"><span data-stu-id="1be64-240">Examine the code</span></span>

<span data-ttu-id="1be64-241">次のコードは `POST ForgotPassword` メソッドを示します。</span><span class="sxs-lookup"><span data-stu-id="1be64-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="1be64-242">ユーザーの電子メールが確認されていない場合、メソッドはサイレントモードで失敗します。</span><span class="sxs-lookup"><span data-stu-id="1be64-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="1be64-243">無効な電子メールアドレスに対してエラーがポストされた場合、悪意のあるユーザーがその情報を使用して、攻撃対象の有効なユーザー Id (電子メールエイリアス) を見つけることができます。</span><span class="sxs-lookup"><span data-stu-id="1be64-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="1be64-244">次のコードは、ユーザーが送信された電子メールで確認リンクを選択したときに呼び出される account controller の `ConfirmEmail` メソッドを示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="1be64-245">忘れたパスワードトークンが使用されると、無効になります。</span><span class="sxs-lookup"><span data-stu-id="1be64-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="1be64-246">`Create` メソッド ( *App\_Start\IdentityConfig.cs*ファイル内) の次のコード変更により、トークンの有効期限が3時間に設定されます。</span><span class="sxs-lookup"><span data-stu-id="1be64-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="1be64-247">上記のコードでは、忘れたパスワードと電子メール確認トークンの有効期限が3時間で切れます。</span><span class="sxs-lookup"><span data-stu-id="1be64-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="1be64-248">既定の `TokenLifespan` は1日です。</span><span class="sxs-lookup"><span data-stu-id="1be64-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="1be64-249">次のコードは、電子メールの確認方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="1be64-250">アプリのセキュリティを強化するために、ASP.NET Identity では2要素認証 (2FA) がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="1be64-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="1be64-251">「 [ASP.NET Identity 2.0: アカウントの検証の設定」と「John の規則による2要素認証の設定](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1be64-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="1be64-252">ログインパスワードの試行に失敗したときにアカウントのロックアウトを設定することはできますが、この方法を使用すると、ログインが[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)ロックアウトの影響を受けやすくなります。</span><span class="sxs-lookup"><span data-stu-id="1be64-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="1be64-253">アカウントロックアウトは、2FA でのみ使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="1be64-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="1be64-254">その他の技術情報</span><span class="sxs-lookup"><span data-stu-id="1be64-254">Additional resources</span></span>

- [<span data-ttu-id="1be64-255">ASP.NET Identity のカスタム ストレージ プロバイダーの概要</span><span class="sxs-lookup"><span data-stu-id="1be64-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="1be64-256">[Facebook、Twitter、LinkedIn、Google OAuth2 サインオンを使用した MVC 5 アプリで](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)は、ユーザーテーブルにプロファイル情報を追加する方法についても説明しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="1be64-257">[ASP.NET MVC And Identity 2.0: John の基本を理解](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)しています。</span><span class="sxs-lookup"><span data-stu-id="1be64-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="1be64-258">ASP.NET Identity 入門</span><span class="sxs-lookup"><span data-stu-id="1be64-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="1be64-259">Pranav Rastogi による[ASP.NET Identity 2.0.0 の RTM を発表](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx)します。</span><span class="sxs-lookup"><span data-stu-id="1be64-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
