---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: 空または既存の Web フォームプロジェクトへの ASP.NET Identity の追加-ASP.NET 4.x
author: raquelsa
description: このチュートリアルでは、ASP.NET Identity (ASP.NET のメンバーシップシステム) を ASP.NET アプリケーションに追加する方法について説明します。 新しい Web フォームまたは MVC を作成する場合
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8e82951d57f0b8052ee3f6530a7470be7d030206
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471976"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="8cea4-104">ASP.NET Identity を空または既存の Web フォーム プロジェクトに追加する</span><span class="sxs-lookup"><span data-stu-id="8cea4-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>

> <span data-ttu-id="8cea4-105">このチュートリアルでは、ASP.NET (の新しいメンバーシップシステム) を ASP.NET アプリケーションに[ASP.NET Identity](introduction-to-aspnet-identity.md)追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="8cea4-106">個々のアカウントを使用して Visual Studio 2017 RTM で新しい Web フォームまたは MVC プロジェクトを作成すると、Visual Studio は必要なすべてのパッケージをインストールし、必要なすべてのクラスを追加します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="8cea4-107">このチュートリアルでは、既存の Web フォームプロジェクトまたは新しい空のプロジェクトに ASP.NET Identity サポートを追加する手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="8cea4-108">ここでは、インストールする必要があるすべての NuGet パッケージと、追加する必要があるクラスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="8cea4-109">ここでは、ユーザー管理と認証の主要なエントリポイント Api をすべて強調表示しながら、新しいユーザーを登録してログインするためのサンプル Web フォームを使用します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="8cea4-110">このサンプルでは、Entity Framework 上に構築された SQL データストレージに ASP.NET Identity 既定の実装を使用します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="8cea4-111">このチュートリアルでは、SQL database に LocalDB を使用します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="8cea4-112">ASP.NET Identity を使ってみる</span><span class="sxs-lookup"><span data-stu-id="8cea4-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="8cea4-113">まず、 [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/)をインストールして実行します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="8cea4-114">スタートページで **[新しいプロジェクト]** を選択するか、メニューを使用して **[ファイル]** 、 **[新しいプロジェクト]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="8cea4-115">左側のウィンドウで、 **[ビジュアルC# ]** を展開し、 **[web]** 、 **[ASP.NET web Application (.net Framework)]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="8cea4-116">プロジェクトに "WebFormsIdentity" という名前を指定し、[ **OK]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="8cea4-117">**[New ASP.NET Project]** ダイアログボックスで、**空**のテンプレートを選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="8cea4-118">**[認証の変更]** ボタンは無効になっており、このテンプレートでは認証がサポートされていないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="8cea4-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="8cea4-119">Web フォーム、MVC、および Web API テンプレートを使用すると、認証方法を選択できます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="8cea4-120">アプリに Id パッケージを追加する</span><span class="sxs-lookup"><span data-stu-id="8cea4-120">Add Identity packages to your app</span></span>

<span data-ttu-id="8cea4-121">ソリューションエクスプローラーで、プロジェクトを右クリックし、 **[NuGet パッケージの管理]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="8cea4-122">**Microsoft .net framework**パッケージを検索してインストールします。</span><span class="sxs-lookup"><span data-stu-id="8cea4-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="8cea4-123">このパッケージは依存関係パッケージをインストールすることに注意してください。**Entityframework**と**Microsoft ASP.NET Identity Core**。</span><span class="sxs-lookup"><span data-stu-id="8cea4-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="8cea4-124">ユーザーを登録するための web フォームを追加する</span><span class="sxs-lookup"><span data-stu-id="8cea4-124">Add a web form to register users</span></span>

1. <span data-ttu-id="8cea4-125">**ソリューションエクスプローラー**で、プロジェクトを右クリックし、 **[追加]** 、 **[Web フォーム]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="8cea4-126">**[項目の名前の指定]** ダイアログボックスで、新しい Web フォーム**Register**という名前を入力し、 **[OK]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="8cea4-127">生成された*login.aspx*ファイルのマークアップを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="8cea4-128">コードの変更が強調表示されています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="8cea4-129">これは、新しい ASP.NET Web フォームプロジェクトを作成するときに作成される、 *default.aspx*ファイルの簡略化されたバージョンです。</span><span class="sxs-lookup"><span data-stu-id="8cea4-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="8cea4-130">上のマークアップは、フォームフィールドと、新しいユーザーを登録するボタンを追加します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="8cea4-131">*Register.aspx.cs*ファイルを開き、ファイルの内容を次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="8cea4-132">上記のコードは、新しい ASP.NET Web フォームプロジェクトを作成するときに作成される*Register.aspx.cs*ファイルの簡略化されたバージョンです。</span><span class="sxs-lookup"><span data-stu-id="8cea4-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="8cea4-133">既定の*entityframework*クラスは、 *iuser*インターフェイスの既定の entityframework 実装です。</span><span class="sxs-lookup"><span data-stu-id="8cea4-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="8cea4-134">*Iuser*インターフェイスは ASP.NET Identity コアのユーザーのための最小限のインターフェイスです。</span><span class="sxs-lookup"><span data-stu-id="8cea4-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="8cea4-135">*Userstore*クラスは、ユーザーストアの既定の entityframework の実装です。</span><span class="sxs-lookup"><span data-stu-id="8cea4-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="8cea4-136">このクラスは、ASP.NET Identity コアの最小インターフェイスを実装します。*IUserStore*、 *IUserLoginStore*、 *IUserClaimStore* 、および*IUserRoleStore*。</span><span class="sxs-lookup"><span data-stu-id="8cea4-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="8cea4-137">*Usermanager*クラスは、ユーザーに関連する api を公開します。これにより、自動的に*usermanager*に変更が保存されます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="8cea4-138">Id 操作の結果を表す、id の*結果*クラス。</span><span class="sxs-lookup"><span data-stu-id="8cea4-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="8cea4-139">**ソリューションエクスプローラー**で、プロジェクトを右クリックし、 **[追加]** 、 **[ASP.NET フォルダーの追加]** 、[**アプリ\_データ**] の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="8cea4-140">*Web.config ファイルを*開き、ユーザー情報を格納するために使用するデータベースの接続文字列エントリを追加します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="8cea4-141">データベースは、Entity Framework によって Id エンティティに対して実行時に作成されます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="8cea4-142">接続文字列は、新しい Web フォームプロジェクトを作成するときに作成されるものと似ています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="8cea4-143">強調表示されたコードは、追加する必要があるマークアップを示しています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="8cea4-144">Visual Studio 2015 以降の場合は、接続文字列で `(localdb)\v11.0` を `(localdb)\MSSQLLocalDB` に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="8cea4-145">プロジェクトの file *Register .aspx*を右クリックし、 **[スタートページとして設定]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="8cea4-146">Ctrl キーを押しながら F5 キーを押して、web アプリケーションをビルドして実行します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="8cea4-147">新しいユーザー名とパスワードを入力し、 **[Register]** \ (登録 \) を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="8cea4-148">ASP.NET Identity は検証をサポートしており、このサンプルでは、Id コアパッケージから取得されたユーザーとパスワードの検証コントロールの既定の動作を確認できます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="8cea4-149">User (`UserValidator`) の既定の検証コントロールには、既定値が `true`に設定された `AllowOnlyAlphanumericUserNames` プロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="8cea4-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="8cea4-150">パスワードの既定の検証 (`MinimumLengthValidator`) では、パスワードが6文字以上であることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="8cea4-151">これらの検証コントロールは、カスタム検証を行う場合にオーバーライドできる `UserManager` のプロパティです。</span><span class="sxs-lookup"><span data-stu-id="8cea4-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="8cea4-152">LocalDb Id データベースと、によって生成されたテーブルを確認し Entity Framework</span><span class="sxs-lookup"><span data-stu-id="8cea4-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="8cea4-153">**[表示]** メニューの **[サーバーエクスプローラー]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="8cea4-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="8cea4-154">**Defaultconnection (WebFormsIdentity)** を展開し、 **[テーブル]** を展開します。次に、 **[AspNetUsers]** を右クリックし、 **[テーブルデータの表示]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="8cea4-155">OWIN 認証用にアプリケーションを構成する</span><span class="sxs-lookup"><span data-stu-id="8cea4-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="8cea4-156">この時点で、ユーザーを作成するためのサポートが追加されました。</span><span class="sxs-lookup"><span data-stu-id="8cea4-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="8cea4-157">ここでは、ユーザーのログインに認証を追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="8cea4-158">ASP.NET Identity は、フォーム認証に Microsoft OWIN Authentication ミドルウェアを使用します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="8cea4-159">OWIN Cookie 認証は、 [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx)または IIS でホストされている任意のフレームワークで使用できる cookie と要求ベースの認証メカニズムです。</span><span class="sxs-lookup"><span data-stu-id="8cea4-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="8cea4-160">このモデルでは、ASP.NET MVC や Web フォームを含む複数のフレームワークで同じ認証パッケージを使用できます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="8cea4-161">プロジェクト Katana と、ホストに依存しないミドルウェアを実行する方法の詳細については[、Katana プロジェクト](https://msdn.microsoft.com/magazine/dn451439.aspx)でのはじめにに関する説明を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8cea4-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="8cea4-162">アプリケーションへの認証パッケージのインストール</span><span class="sxs-lookup"><span data-stu-id="8cea4-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="8cea4-163">ソリューションエクスプローラーで、プロジェクトを右クリックし、 **[NuGet パッケージの管理]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="8cea4-164">***Owin***パッケージを検索してインストールします。</span><span class="sxs-lookup"><span data-stu-id="8cea4-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="8cea4-165">***Owin***パッケージを検索してインストールします。</span><span class="sxs-lookup"><span data-stu-id="8cea4-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="8cea4-166">**Owin**パッケージには、ASP.NET Identity コアパッケージによって使用される Owin 認証ミドルウェアを管理および構成するための Owin 拡張クラスのセットが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="8cea4-167">**Owin**パッケージには、ASP.NET 要求パイプラインを使用して Owin ベースのアプリケーションを IIS で実行できるようにする Owin サーバーが含まれています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="8cea4-168">詳細について[は、「OWIN ミドルウェア in THE IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8cea4-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="8cea4-169">OWIN のスタートアップと認証の構成クラスを追加する</span><span class="sxs-lookup"><span data-stu-id="8cea4-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="8cea4-170">**ソリューションエクスプローラー**で、プロジェクトを右クリックし、 **[追加]** 、 **[新しい項目の追加]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="8cea4-171">[検索テキストボックス] ダイアログボックスで、「*owin*」と入力します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="8cea4-172">クラスに "*Startup*" という名前を指定し、 **[追加]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="8cea4-173">Startup.cs ファイルで、下の強調表示されているコードを追加して、OWIN cookie 認証を構成します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="8cea4-174">このクラスには、OWIN startup クラスを指定するための `OwinStartup` 属性が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="8cea4-175">すべての OWIN アプリケーションには、アプリケーションパイプラインのコンポーネントを指定する startup クラスがあります。</span><span class="sxs-lookup"><span data-stu-id="8cea4-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="8cea4-176">このモデルの詳細については、「 [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) 」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8cea4-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="8cea4-177">ユーザーを登録してサインインするための web フォームを追加する</span><span class="sxs-lookup"><span data-stu-id="8cea4-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="8cea4-178">*Register.aspx.cs*ファイルを開き、登録が成功したときにユーザーにサインインする次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="8cea4-179">ASP.NET Identity と OWIN Cookie 認証はクレームベースのシステムであるため、フレームワークでは、アプリ開発者がユーザーの[ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx)を生成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8cea4-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="8cea4-180">ClaimsIdentity には、ユーザーが属するロールなど、ユーザーのすべての要求に関する情報が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="8cea4-181">この段階で、ユーザーに対する要求をさらに追加することもできます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="8cea4-182">OWIN から AuthenticationManager を使用して `SignIn` を呼び出して、上記のように ClaimsIdentity に渡すことによって、ユーザーをサインインさせることができます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="8cea4-183">このコードは、ユーザーにサインインし、cookie も生成します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="8cea4-184">この呼び出しは、 [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)モジュールで使用される[Formauthentication](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)に似ています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="8cea4-185">**ソリューションエクスプローラー**で、プロジェクトを右クリックし、 **[追加]** 、 **[Web フォーム]** の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="8cea4-186">Web フォームに**ログイン**名を指定します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="8cea4-187">*Login.aspx*ファイルの内容を次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="8cea4-188">*Login.aspx.cs*ファイルの内容を次の内容に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="8cea4-189">`Page_Load` は現在のユーザーの状態を確認し、`Context.User.Identity.IsAuthenticated` の状態に基づいてアクションを実行するようになりました。</span><span class="sxs-lookup"><span data-stu-id="8cea4-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >   <span data-ttu-id="8cea4-190">**ログインしたユーザー名を表示**する:Microsoft ASP.NET Identity Framework には、ログインしているユーザーの `UserName` と `UserId` を取得できるようにするための拡張メソッドが追加され[ました。](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx)</span><span class="sxs-lookup"><span data-stu-id="8cea4-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="8cea4-191">これらの拡張メソッドは、`Microsoft.AspNet.Identity.Core` アセンブリで定義されています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="8cea4-192">これらの拡張メソッドは、 [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx)の代わりに使用されます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="8cea4-193">サインイン方法: `This` メソッドは、このサンプルの前の `CreateUser_Click` メソッドを置き換え、ユーザーが正常に作成された後にユーザーをサインインさせるようになりました。</span><span class="sxs-lookup"><span data-stu-id="8cea4-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="8cea4-194">Microsoft OWIN Framework では、`IOwinContext`への参照を取得するための拡張メソッドが `System.Web.HttpContext` に追加されました。</span><span class="sxs-lookup"><span data-stu-id="8cea4-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="8cea4-195">これらの拡張メソッドは `Microsoft.Owin.Host.SystemWeb` アセンブリで定義されています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="8cea4-196">`OwinContext` クラスは、現在の要求で使用できる認証ミドルウェア機能を表す `IAuthenticationManager` プロパティを公開します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="8cea4-197">OWIN から `AuthenticationManager` を使用し、`SignIn` を呼び出して、前述のように `ClaimsIdentity` に渡すことによって、ユーザーにサインインできます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="8cea4-198">ASP.NET Identity と OWIN Cookie 認証はクレームベースのシステムであるため、フレームワークでは、ユーザーの `ClaimsIdentity` を生成するためにアプリが必要です。</span><span class="sxs-lookup"><span data-stu-id="8cea4-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="8cea4-199">`ClaimsIdentity` には、ユーザーが属するロールなど、ユーザーのすべての要求に関する情報が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="8cea4-200">この段階で、ユーザーに対する要求をさらに追加することもできます。このコードはユーザーにサインインし、cookie も生成します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="8cea4-201">この呼び出しは、 [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)モジュールで使用される[Formauthentication](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)に似ています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="8cea4-202">`SignOut` メソッド: OWIN から `AuthenticationManager` への参照を取得し、`SignOut`を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="8cea4-203">これは、 [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)モジュールで使用される[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx)メソッドに似ています。</span><span class="sxs-lookup"><span data-stu-id="8cea4-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="8cea4-204">Ctrl キーを押し**ながら F5**キーを押して、web アプリケーションをビルドして実行します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="8cea4-205">新しいユーザー名とパスワードを入力し、 **[Register]** \ (登録 \) を選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="8cea4-206">メモ:この時点で、新しいユーザーが作成され、ログインされます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="8cea4-207">**[ログアウト]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="8cea4-207">Select the **Log out** button.</span></span> <span data-ttu-id="8cea4-208">ログインフォームにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="8cea4-209">無効なユーザー名またはパスワードを入力し、 **[ログイン]** ボタンを選択します。</span><span class="sxs-lookup"><span data-stu-id="8cea4-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="8cea4-210">`UserManager.Find` メソッドは、null とエラーメッセージを返します。"*ユーザー名またはパスワードが無効です*"が表示されます。</span><span class="sxs-lookup"><span data-stu-id="8cea4-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
