---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: Azure Active Directory を使用した ASP.NET アプリの開発-ASP.NET 4.x
author: Rick-Anderson
description: Azure Active Directory 用の Microsoft ASP.NET ツールを使用すると、Azure でホストされている web アプリケーションの認証を簡単に有効にすることができます。 Azure 事前を使用できます...
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 28425ea8d1312dfc6e14df9677396f2cbcf6f16d
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456726"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="90479-104">Azure Active Directory を使った ASP.NET アプリの開発</span><span class="sxs-lookup"><span data-stu-id="90479-104">Developing ASP.NET Apps with Azure Active Directory</span></span>

<span data-ttu-id="90479-105">[Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="90479-105">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="90479-106">Azure Active Directory 用の Microsoft ASP.NET ツールを使用すると、 [Azure](https://www.windowsazure.com/home/features/web-sites/)でホストされている web アプリの認証を簡単に行うことができます。</span><span class="sxs-lookup"><span data-stu-id="90479-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="90479-107">Azure 認証を使用すると、社内の Active Directory、または独自のカスタム Azure Active Directory ドメインで作成されたユーザーから同期された会社のアカウントで、組織からの Office 365 ユーザーを認証できます。</span><span class="sxs-lookup"><span data-stu-id="90479-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="90479-108">Windows Azure 認証を有効にすると、単一の[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)テナントを使用してユーザーを認証するようにアプリケーションが構成されます。</span><span class="sxs-lookup"><span data-stu-id="90479-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="90479-109">このチュートリアルでは、 [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD) を使用したサインオン用に構成された ASP.NET アプリケーションを作成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="90479-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="90479-110">また、Graph API を呼び出して、現在サインインしているユーザーに関する情報を取得する方法と、Azure にアプリケーションをデプロイする方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="90479-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="90479-111">前提条件</span><span class="sxs-lookup"><span data-stu-id="90479-111">Prerequisites</span></span>

1. <span data-ttu-id="90479-112">Web または[Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013)[の Visual Studio Express 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) 。</span><span class="sxs-lookup"><span data-stu-id="90479-112">[Visual Studio Express 2013 for Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) or [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span></span>
2. <span data-ttu-id="90479-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) -Update 3 以降が必要です。</span><span class="sxs-lookup"><span data-stu-id="90479-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="90479-114">Azure アカウント。</span><span class="sxs-lookup"><span data-stu-id="90479-114">An Azure account.</span></span> <span data-ttu-id="90479-115">まだアカウントをお持ちでない場合は、無料試用版を[クリックし](https://azure.microsoft.com/pricing/free-trial/)てください。</span><span class="sxs-lookup"><span data-stu-id="90479-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="90479-116">Active Directory にグローバル管理者を追加する</span><span class="sxs-lookup"><span data-stu-id="90479-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="90479-117">[Azure 管理ポータル](https://manage.windowsazure.com/)にサインインします。</span><span class="sxs-lookup"><span data-stu-id="90479-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="90479-118">すべての Azure アカウントには**既定のディレクトリ**が含まれています。これをクリックし、ページの上部にある **[ユーザー]** タブをクリックします (下図を参照)。</span><span class="sxs-lookup"><span data-stu-id="90479-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="90479-119">[Add User] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-119">Click Add User.</span></span>
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="90479-120">**グローバル管理者**ロールを持つ新しいユーザーを作成します。</span><span class="sxs-lookup"><span data-stu-id="90479-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="90479-121">上部のメニューの **[ユーザー]** をクリックし、コマンドバーの **[ユーザーの追加]** ボタンをクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="90479-122">**[ユーザーの追加]** ダイアログボックスで、新しいユーザーの名前を入力し、右矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="90479-123">ユーザー名を入力し、ロールを **[グローバル管理者]** に設定します。</span><span class="sxs-lookup"><span data-stu-id="90479-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="90479-124">グローバル管理者には、パスワードの回復のために連絡用電子メールアドレスが必要です。</span><span class="sxs-lookup"><span data-stu-id="90479-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="90479-125">終了したら、右矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-125">After you're finished, click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="90479-126">ダイアログの次のページで、 **[作成]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="90479-127">新しいユーザーの一時パスワードが作成され、ダイアログに表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   <span data-ttu-id="90479-128">パスワードを保存します。最初のログイン後にパスワードを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="90479-129">次の図は、新しい管理者アカウントを示しています。</span><span class="sxs-lookup"><span data-stu-id="90479-129">The following image shows the new admin account.</span></span> <span data-ttu-id="90479-130">このページに示されている Microsoft アカウントではなく、アプリにログインするには Azure Active Directory を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="90479-131">ASP.NET アプリケーションを作成する</span><span class="sxs-lookup"><span data-stu-id="90479-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="90479-132">次の手順では、 [Web 用に 2013 Visual Studio Express](https://www.microsoft.com/download/details.aspx?id=40747)を使用し、 [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)が必要です。</span><span class="sxs-lookup"><span data-stu-id="90479-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="90479-133">Visual Studio で、 **[ファイル]** 、 **[新しいプロジェクト]** の順にクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="90479-134">**[新しいプロジェクト]** ダイアログで、左側のC#メニューから Visual Web プロジェクト を選択し、 **[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="90479-135">また、アプリケーションの機能を必要としない場合は、[ **Application Insights をプロジェクトに追加**する] チェックボックスをオフにすることもできます。</span><span class="sxs-lookup"><span data-stu-id="90479-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="90479-136">**[New ASP.NET プロジェクト]** ダイアログボックスで **[MVC]** を選択し、 **[認証の変更]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="90479-137">**[認証の変更]** ダイアログで、 **[組織アカウント]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="90479-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="90479-138">これらのオプションを使用すると、アプリケーションを自動的に Azure AD に登録できるだけでなく、アプリケーションを Azure AD と統合するように自動的に構成することもできます。</span><span class="sxs-lookup"><span data-stu-id="90479-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="90479-139">**[認証の変更]** ダイアログボックスを使用してアプリケーションを登録および構成する必要はありませんが、これははるかに簡単になります。</span><span class="sxs-lookup"><span data-stu-id="90479-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="90479-140">たとえば、Visual Studio 2012 を使用している場合は、アプリケーションを Azure 管理ポータルに手動で登録し、その構成を Azure AD と統合するように更新することもできます。</span><span class="sxs-lookup"><span data-stu-id="90479-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>
   <span data-ttu-id="90479-141">ドロップダウンメニューで、 **[クラウド-単一組織]** と [**シングルサインオン]** を選択し、[ディレクトリデータの読み取り] を選択します。</span><span class="sxs-lookup"><span data-stu-id="90479-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="90479-142">Azure AD ディレクトリのドメイン (次の図を参照) *aricka0yahoo.onmicrosoft.com*を入力し、[ **OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="90479-143">ドメイン名は、azure portal の既定のディレクトリの [ドメイン] タブから取得できます (次の図を参照)。</span><span class="sxs-lookup"><span data-stu-id="90479-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   <span data-ttu-id="90479-144">次の図は、Azure portal のドメイン名を示しています。</span><span class="sxs-lookup"><span data-stu-id="90479-144">The following image shows the domain name from the Azure portal.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > <span data-ttu-id="90479-145">必要に応じて、[**その他のオプション]** をクリックして Azure AD に登録されるアプリケーション ID URI を構成することもできます。</span><span class="sxs-lookup"><span data-stu-id="90479-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="90479-146">アプリ ID URI は、アプリケーションの一意の識別子であり、Azure AD に登録され、アプリケーションが Azure AD との通信時に自身を識別するために使用します。</span><span class="sxs-lookup"><span data-stu-id="90479-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="90479-147">アプリ ID URI および登録済みアプリケーションのその他のプロパティの詳細については、[このトピック](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="90479-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="90479-148">[アプリ ID URI] フィールドの下にあるチェックボックスをオンにすると、同じアプリ ID URI を使用する Azure AD の既存の登録を上書きすることもできます。</span><span class="sxs-lookup"><span data-stu-id="90479-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="90479-149">**[OK]** をクリックすると、サインインダイアログが表示され、(サブスクリプションに関連付けられている Microsoft アカウントではなく) グローバル管理者アカウントを使用してサインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="90479-150">以前に新しい管理者アカウントを作成した場合は、パスワードを変更してから、新しいパスワードを使用してもう一度サインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="90479-151">認証が正常に完了すると、**新しい [ASP.NET プロジェクト**] ダイアログボックスに、認証の選択 (**組織**) と、新しいアプリケーションを登録するディレクトリ (下の図の*aricka0yahoo.onmicrosoft.com* ) が表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="90479-152">この情報の下にある **[クラウド内のホスト]** チェックボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="90479-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="90479-153">このチェックボックスをオンにすると、プロジェクトは Azure web アプリとしてプロビジョニングされ、後で簡単に発行できるようになります。</span><span class="sxs-lookup"><span data-stu-id="90479-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="90479-154">**[OK]** をクリックすると、</span><span class="sxs-lookup"><span data-stu-id="90479-154">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="90479-155">自動生成されたサイト名とリージョンを使用して、 **[Azure Web サイトの構成]** ダイアログボックスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="90479-156">また、ダイアログで現在サインインしているアカウントにも注意してください。</span><span class="sxs-lookup"><span data-stu-id="90479-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="90479-157">このアカウントが、Azure サブスクリプションがアタッチされているアカウント (通常は Microsoft アカウント) であることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="90479-158">このプロジェクトにはデータベースが必要です。</span><span class="sxs-lookup"><span data-stu-id="90479-158">This project requires a database.</span></span> <span data-ttu-id="90479-159">既存のデータベースのいずれかを選択するか、新しいデータベースを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="90479-160">データベースは、少数の認証構成データを格納するためにローカルデータベースファイルが既に使用されているため、必要です。</span><span class="sxs-lookup"><span data-stu-id="90479-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="90479-161">アプリケーションを Azure Web サイトにデプロイする場合、このデータベースはデプロイでパッケージ化されていないため、クラウドでアクセス可能なデータベースを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="90479-162">**[OK]** をクリックすると、</span><span class="sxs-lookup"><span data-stu-id="90479-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="90479-163">プロジェクトが作成され、認証オプションと web アプリのオプションがプロジェクトで自動的に構成されます。</span><span class="sxs-lookup"><span data-stu-id="90479-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="90479-164">このプロセスが完了したら、 **^ F5**キーを押してプロジェクトをローカルで実行します。</span><span class="sxs-lookup"><span data-stu-id="90479-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="90479-165">組織のアカウントを使用してサインインする必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="90479-166">前の手順で作成したアカウントのユーザー名とパスワードを入力し、 **[サインイン]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="90479-167">サインインに成功すると、ASP.NET サイトには、ページの右上隅にユーザー名が表示され、認証済みであることが示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   <span data-ttu-id="90479-168">エラーが発生した場合: 値を null または空にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="90479-168">If you get the error: Value cannot be null or empty.</span></span> <span data-ttu-id="90479-169">パラメーター名: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="90479-169">Parameter name: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span></span>

   <span data-ttu-id="90479-170">チュートリアルの最後にある「[デバッグ](#dbg)」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="90479-170">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="90479-171">Graph API の基礎</span><span class="sxs-lookup"><span data-stu-id="90479-171">Basics of the Graph API</span></span>

<span data-ttu-id="90479-172">[Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx)は、Azure AD ディレクトリ内のオブジェクトに対して CRUD などの操作を実行するために使用されるプログラムインターフェイスです。</span><span class="sxs-lookup"><span data-stu-id="90479-172">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="90479-173">Visual Studio 2013 で新しいプロジェクトを作成するときに認証に組織アカウントオプションを選択した場合、アプリケーションは Graph API を呼び出すように既に構成されています。</span><span class="sxs-lookup"><span data-stu-id="90479-173">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="90479-174">このセクションでは、Graph API のしくみを簡単に説明します。</span><span class="sxs-lookup"><span data-stu-id="90479-174">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="90479-175">実行中のアプリケーションで、ページの右上にあるサインインしているユーザーの名前をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-175">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="90479-176">これにより、[ユーザープロファイル] ページが表示されます。これは、Home コントローラーのアクションです。</span><span class="sxs-lookup"><span data-stu-id="90479-176">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="90479-177">このテーブルには、前に作成した管理者アカウントに関するユーザー情報が含まれていることがわかります。</span><span class="sxs-lookup"><span data-stu-id="90479-177">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="90479-178">この情報はディレクトリに格納され、ページが読み込まれるときにこの情報を取得するために Graph API が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="90479-178">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="90479-179">Visual Studio に戻り、 **Controllers**フォルダーを展開して、 **HomeController.cs**ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="90479-179">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="90479-180">トークンを取得してから Graph API を呼び出すためのコードを含む**UserProfile ()** アクションが表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-180">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="90479-181">このコードは次のように重複しています。</span><span class="sxs-lookup"><span data-stu-id="90479-181">This code is duplicated below:</span></span>

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="90479-182">Graph API を呼び出すには、最初にトークンを取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-182">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="90479-183">トークンを取得するときは、その文字列値を、Graph API への後続のすべての要求の Authorization ヘッダーに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="90479-183">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="90479-184">上記のコードのほとんどは、トークンを取得するための Azure AD 認証の詳細を処理し、トークンを使用して Graph API を呼び出し、その応答をビューに表示できるように変換します。</span><span class="sxs-lookup"><span data-stu-id="90479-184">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="90479-185">説明の最も関連性の高い部分は、次の強調表示されている行を `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`です。</span><span class="sxs-lookup"><span data-stu-id="90479-185">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="90479-186">この行は、JSON 応答から逆シリアル化され、ビューに表示されるユーザーの名前を表します。</span><span class="sxs-lookup"><span data-stu-id="90479-186">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="90479-187">HttpClient を使用して Graph API を呼び出し、生データを自分で処理することができますが、簡単な方法は、 [NuGet から入手できる Graph クライアントライブラリ](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)を使用する方法です。</span><span class="sxs-lookup"><span data-stu-id="90479-187">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="90479-188">クライアントライブラリは、未加工の HTTP 要求と返されたデータの変換を処理し、.NET 環境での Graph API の操作をより簡単にします。</span><span class="sxs-lookup"><span data-stu-id="90479-188">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="90479-189">GitHub の関連 Graph API コードサンプルを参照してください[。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="90479-189">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="90479-190">Azure にアプリケーションをデプロイする</span><span class="sxs-lookup"><span data-stu-id="90479-190">Deploy the Application to Azure</span></span>

<span data-ttu-id="90479-191">次の手順は、アプリケーションを Azure にデプロイする方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="90479-191">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="90479-192">前の手順では、新しいプロジェクトを Azure の web アプリに接続しました。そのため、いくつかの手順で発行することができます。</span><span class="sxs-lookup"><span data-stu-id="90479-192">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="90479-193">Visual Studio で、プロジェクトを右クリックし、 **[発行]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="90479-193">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="90479-194">各設定が既に構成されている場合は、 **[Web の発行]** ダイアログボックスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-194">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="90479-195">**[次へ]** ボタンをクリックして、 **[設定]** ページに戻ります。</span><span class="sxs-lookup"><span data-stu-id="90479-195">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="90479-196">認証を求めるメッセージが表示される場合があります。前に作成した組織アカウントではなく、Azure サブスクリプションアカウント (通常は Microsoft アカウント) を使用して認証するようにしてください。</span><span class="sxs-lookup"><span data-stu-id="90479-196">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="90479-197">**[組織の認証を有効にする]** オプションをオンにします。</span><span class="sxs-lookup"><span data-stu-id="90479-197">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="90479-198">**[ドメイン]** フィールドに、ディレクトリのドメインを入力します。</span><span class="sxs-lookup"><span data-stu-id="90479-198">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="90479-199">**[アクセスレベル]** ドロップダウンで、[**シングルサインオン]、[ディレクトリデータの読み取り**] の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="90479-199">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="90479-200">以前に使用したデータベースは、 **[データベース]** セクションに既に設定されていることがわかります。</span><span class="sxs-lookup"><span data-stu-id="90479-200">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="90479-201">**[発行]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="90479-201">Click **Publish**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="90479-202">Web サイトのデプロイが開始され、新しいブラウザーウィンドウが表示されます。</span><span class="sxs-lookup"><span data-stu-id="90479-202">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="90479-203">ディレクトリに対してもう一度認証を求めるメッセージが表示される場合があります。</span><span class="sxs-lookup"><span data-stu-id="90479-203">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="90479-204">認証が完了すると、Azure で新しく公開された web サイトにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="90479-204">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="90479-205">アプリのデバッグ</span><span class="sxs-lookup"><span data-stu-id="90479-205">Debugging the app</span></span>

<span data-ttu-id="90479-206">次のエラーが表示される場合: 値を null または空にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="90479-206">If you get the following error: Value cannot be null or empty.</span></span> <span data-ttu-id="90479-207">パラメーター名: linkText</span><span class="sxs-lookup"><span data-stu-id="90479-207">Parameter name: linkText</span></span>

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)

<span data-ttu-id="90479-208">*Views\Shared\\_LoginPartial*ファイル内のコードを次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="90479-208">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="90479-209">アプリを実行した後、ログインしているユーザーに "Null ユーザー" と表示されている場合は、サインアウトし、前に作成した Active Directory アカウントを使用してもう一度サインインします。</span><span class="sxs-lookup"><span data-stu-id="90479-209">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="90479-210">このチュートリアルでは、Rick Rainey の詳細について説明します。 [Azure AD を使用した Azure Websites と組織認証](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)です。</span><span class="sxs-lookup"><span data-stu-id="90479-210">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="90479-211">詳細</span><span class="sxs-lookup"><span data-stu-id="90479-211">More Information</span></span>

- [<span data-ttu-id="90479-212">詳細: Azure AD を使用した Azure Websites と組織認証</span><span class="sxs-lookup"><span data-stu-id="90479-212">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="90479-213">Azure AD Graph API の概要</span><span class="sxs-lookup"><span data-stu-id="90479-213">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="90479-214">Azure AD での認証シナリオ</span><span class="sxs-lookup"><span data-stu-id="90479-214">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="90479-215">GitHub の Azure AD コードサンプル</span><span class="sxs-lookup"><span data-stu-id="90479-215">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
