---
uid: identity/overview/getting-started/aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider
title: 'ASP.NET Identity: EntityFramework MySQL プロバイダーで MySQL ストレージを使用するC#()-ASP.NET 4.x'
author: maumar
description: このチュートリアルでは、ASP.NET Identity の既定のデータストレージ機構を EntityFramework (SQL クライアントプロバイダー) に置き換えて、MySQL プロバイダーに置き換える方法について説明します。
ms.author: riande
ms.date: 12/10/2013
ms.assetid: 15253312-a92c-43ba-908e-b5dacd3d08b8
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider
msc.type: authoredcontent
ms.openlocfilehash: e89ed139657c5ce9ddcc56879946c62038919483
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471874"
---
# <a name="aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider-c"></a><span data-ttu-id="ccaad-103">ASP.NET Identity:EntityFramework MySQL プロバイダーで MySQL ストレージを使用する (C#)</span><span class="sxs-lookup"><span data-stu-id="ccaad-103">ASP.NET Identity: Using MySQL Storage with an EntityFramework MySQL Provider (C#)</span></span>

<span data-ttu-id="ccaad-104">[Maurycy Markowski](https://github.com/maumar)、 [Raquel Soares De Almeida](https://github.com/raquelsa)、 [Robert mcmurray](https://github.com/rmcmurray)</span><span class="sxs-lookup"><span data-stu-id="ccaad-104">by [Maurycy Markowski](https://github.com/maumar), [Raquel Soares De Almeida](https://github.com/raquelsa), [Robert McMurray](https://github.com/rmcmurray)</span></span>

> <span data-ttu-id="ccaad-105">このチュートリアルでは、 [**ASP.NET Identity**](introduction-to-aspnet-identity.md)の既定のデータストレージ機構を entityframework (SQL クライアントプロバイダー) に置き換える方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-105">This tutorial shows you how to replace the default data storage mechanism for [**ASP.NET Identity**](introduction-to-aspnet-identity.md) with EntityFramework (SQL client provider) with a MySQL provider.</span></span>

<span data-ttu-id="ccaad-106">このチュートリアルでは、次のトピックについて説明します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-106">The following topics will be covered in this tutorial:</span></span>

- <span data-ttu-id="ccaad-107">Azure での MySQL データベースの作成</span><span class="sxs-lookup"><span data-stu-id="ccaad-107">Creating a MySQL database on Azure</span></span>
- <span data-ttu-id="ccaad-108">Visual Studio 2013 MVC テンプレートを使用した MVC アプリケーションの作成</span><span class="sxs-lookup"><span data-stu-id="ccaad-108">Creating an MVC application using Visual Studio 2013 MVC template</span></span>
- <span data-ttu-id="ccaad-109">MySQL データベースプロバイダーを使用するための EntityFramework の構成</span><span class="sxs-lookup"><span data-stu-id="ccaad-109">Configuring EntityFramework to work with a MySQL database provider</span></span>
- <span data-ttu-id="ccaad-110">アプリケーションを実行して結果を確認する</span><span class="sxs-lookup"><span data-stu-id="ccaad-110">Running the application to verify the results</span></span>

<span data-ttu-id="ccaad-111">このチュートリアルの最後には、Azure でホストされている MySQL データベースを使用する ASP.NET Identity ストアを含む MVC アプリケーションが作成されます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-111">At the end of this tutorial, you will have an MVC application with the ASP.NET Identity store that is using a MySQL database that is hosted in Azure.</span></span>

## <a name="creating-a-mysql-database-instance-on-azure"></a><span data-ttu-id="ccaad-112">Azure での MySQL データベースインスタンスの作成</span><span class="sxs-lookup"><span data-stu-id="ccaad-112">Creating a MySQL database instance on Azure</span></span>

1. <span data-ttu-id="ccaad-113">[Azure Portal](https://go.microsoft.com/fwlink/?linkid=529715&amp;clcid=0x409) にログインします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-113">Log in to the [Azure Portal](https://go.microsoft.com/fwlink/?linkid=529715&amp;clcid=0x409).</span></span>
2. <span data-ttu-id="ccaad-114">ページの下部にある **[新規]** をクリックし、 **[ストア]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-114">Click **NEW** at the bottom of the page, and then select **STORE**:</span></span>

    [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image2.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image1.png)
3. <span data-ttu-id="ccaad-115">**選択とアドオン**ウィザードで、 **[ClearDB MySQL Database]** を選択し、フレームの下部にある**次へ進む**矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-115">In the **Choose and Add-on** wizard, select **ClearDB MySQL Database**, and then click the **Next** arrow at the bottom of the frame:</span></span>

   <span data-ttu-id="ccaad-116">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-116">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-117">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image4.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-117">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image4.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image3.png)</span></span>
4. <span data-ttu-id="ccaad-118">既定の**Free**プランをそのまま使用し、**名前**を「**識別子**」に変更し、最も近いリージョンを選択して、フレームの下部にある**次へ進む**矢印をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-118">Keep the default **Free** plan, change the **NAME** to **IdentityMySQLDatabase**, select the region that is nearest to you, and then click the **Next** arrow at the bottom of the frame:</span></span>

   <span data-ttu-id="ccaad-119">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-119">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-120">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image6.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-120">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image6.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image5.png)</span></span>
5. <span data-ttu-id="ccaad-121">**[購入]** チェックマークをクリックして、データベースの作成を完了します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-121">Click the **PURCHASE** checkmark to complete the database creation.</span></span>

   <span data-ttu-id="ccaad-122">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-122">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-123">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image8.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-123">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image8.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image7.png)</span></span>
6. <span data-ttu-id="ccaad-124">データベースが作成されたら、管理ポータルの **[アドオン]** タブから管理できます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-124">After your database has been created, you can manage it from the **ADD-ONS** tab in the management portal.</span></span> <span data-ttu-id="ccaad-125">データベースの接続情報を取得するには、ページの下部にある [**接続**情報] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-125">To retrieve the connection information for your database, click **CONNECTION INFO** at the bottom of the page:</span></span>

   <span data-ttu-id="ccaad-126">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-126">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-127">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image10.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-127">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image10.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image9.png)</span></span>
7. <span data-ttu-id="ccaad-128">**[CONNECTIONSTRING]** フィールドの [コピー] ボタンをクリックして接続文字列をコピーし、保存します。この情報は、このチュートリアルの後半で MVC アプリケーションに使用します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-128">Copy the connection string by clicking on the copy button by the **CONNECTIONSTRING** field and save it; you will use this information later in this tutorial for your MVC application:</span></span>

   <span data-ttu-id="ccaad-129">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-129">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-130">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image12.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-130">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image12.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image11.png)</span></span>

## <a name="creating-an-mvc-application-project"></a><span data-ttu-id="ccaad-131">MVC アプリケーションプロジェクトの作成</span><span class="sxs-lookup"><span data-stu-id="ccaad-131">Creating an MVC application project</span></span>

<span data-ttu-id="ccaad-132">チュートリアルのこのセクションの手順を完了するには、最初に Web 用または[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)[用の Visual Studio Express 2013](https://go.microsoft.com/fwlink/?LinkId=299058)をインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-132">To complete the steps in this section of the tutorial, you will first need to install [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="ccaad-133">Visual Studio をインストールしたら、次の手順に従って、新しい MVC アプリケーションプロジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-133">Once Visual Studio has been installed, use the following steps to create a new MVC application project:</span></span>

1. <span data-ttu-id="ccaad-134">Visual Studio 2103 を開きます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-134">Open Visual Studio 2103.</span></span>
2. <span data-ttu-id="ccaad-135">**スタート**ページで **[新しいプロジェクト]** をクリックするか、 **[ファイル]** メニューの **[新しいプロジェクト]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-135">Click **New Project** from the **Start** page, or you can click the **File** menu and then **New Project**:</span></span>

   <span data-ttu-id="ccaad-136">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-136">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-137">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image2.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image1.jpg)</span><span class="sxs-lookup"><span data-stu-id="ccaad-137">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image2.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image1.jpg)</span></span>
3. <span data-ttu-id="ccaad-138">**[新しいプロジェクト]** ダイアログボックスが表示されたら、テンプレートの一覧で **[ビジュアルC# ]** を展開し、 **[web]** をクリックして、 **[ASP.NET Web Application]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-138">When the **New Project** dialog box is displayed, expand **Visual C#** in the list of templates, then click **Web**, and select **ASP.NET Web Application**.</span></span> <span data-ttu-id="ccaad-139">プロジェクトに「**識別子**」という名前を入力し、[ **OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-139">Name your project **IdentityMySQLDemo** and then click **OK**:</span></span>

   <span data-ttu-id="ccaad-140">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-140">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-141">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image14.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-141">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image14.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image13.png)</span></span>
4. <span data-ttu-id="ccaad-142">**[New ASP.NET プロジェクト]** ダイアログボックスで、既定のオプションを使用して**MVC**テンプレートを選択します。これにより、**個々のユーザーアカウント**が認証方法として構成されます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-142">In the **New ASP.NET Project** dialog, select the **MVC** templatewith the default options; this will configure **Individual User Accounts** as the authentication method.</span></span> <span data-ttu-id="ccaad-143">**[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-143">Click **OK**:</span></span>

   <span data-ttu-id="ccaad-144">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-144">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-145">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image16.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-145">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image16.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image15.png)</span></span>

## <a name="configure-entityframework-to-work-with-a-mysql-database"></a><span data-ttu-id="ccaad-146">MySQL データベースを使用するように EntityFramework を構成する</span><span class="sxs-lookup"><span data-stu-id="ccaad-146">Configure EntityFramework to work with a MySQL database</span></span>

### <a name="update-the-entity-framework-assembly-for-your-project"></a><span data-ttu-id="ccaad-147">プロジェクトの Entity Framework アセンブリを更新する</span><span class="sxs-lookup"><span data-stu-id="ccaad-147">Update the Entity Framework assembly for your project</span></span>

<span data-ttu-id="ccaad-148">Visual Studio 2013 テンプレートから作成された MVC アプリケーションには[Entityframework 6.0.0](http://www.nuget.org/packages/EntityFramework)パッケージへの参照が含まれていますが、このアセンブリのリリース以降、大幅なパフォーマンスの改善が行われています。</span><span class="sxs-lookup"><span data-stu-id="ccaad-148">The MVC application that was created from the Visual Studio 2013 template contains a reference to the [EntityFramework 6.0.0](http://www.nuget.org/packages/EntityFramework) package, but there have been updates to that assembly since its release which contain significant performance improvements.</span></span> <span data-ttu-id="ccaad-149">アプリケーションでこれらの最新の更新プログラムを使用するには、次の手順を使用します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-149">In order to use these latest updates in your application, use the following steps.</span></span>

1. <span data-ttu-id="ccaad-150">Visual Studio で MVC プロジェクトを開きます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-150">Open your MVC project in Visual Studio.</span></span>
2. <span data-ttu-id="ccaad-151">**[ツール]** 、 **[NuGet パッケージマネージャー]** 、 **[パッケージマネージャーコンソール]** の順にクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-151">Click **Tools**, then click **NuGet Package Manager**, and then click **Package Manager Console**:</span></span>

   <span data-ttu-id="ccaad-152">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-152">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-153">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image18.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-153">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image18.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image17.png)</span></span>
3. <span data-ttu-id="ccaad-154">**パッケージマネージャーコンソール**は、Visual Studio の下部セクションに表示されます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-154">The **Package Manager Console** will appear in the bottom section of Visual Studio.</span></span> <span data-ttu-id="ccaad-155">「&quot;**更新-Package EntityFramework**&quot;」と入力し、enter キーを押します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-155">Type &quot;**Update-Package EntityFramework**&quot; and press Enter:</span></span>

   <span data-ttu-id="ccaad-156">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-156">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-157">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image20.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-157">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image20.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image19.png)</span></span>

### <a name="install-the-mysql-provider-for-entityframework"></a><span data-ttu-id="ccaad-158">EntityFramework 用の MySQL プロバイダーをインストールする</span><span class="sxs-lookup"><span data-stu-id="ccaad-158">Install the MySQL provider for EntityFramework</span></span>

<span data-ttu-id="ccaad-159">EntityFramework を MySQL database に接続するには、MySQL プロバイダーをインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-159">In order for EntityFramework to connect to MySQL database, you need to install a MySQL provider.</span></span> <span data-ttu-id="ccaad-160">これを行うには、**パッケージマネージャーコンソール**を開き、「&quot;**Install-package-Pre**&quot;」と入力して、enter キーを押します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-160">To do so, open the **Package Manager Console** and type &quot;**Install-Package MySql.Data.Entity -Pre**&quot;, and then press Enter.</span></span>

> [!NOTE]
> <span data-ttu-id="ccaad-161">これは、アセンブリのプレリリースバージョンであり、バグが含まれている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-161">This is a pre-release version of the assembly, and as such it may contain bugs.</span></span> <span data-ttu-id="ccaad-162">実稼働環境では、プレリリース版のプロバイダーを使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="ccaad-162">You should not use a pre-release version of the provider in production.</span></span>

<span data-ttu-id="ccaad-163">[次の画像をクリックして展開します。]</span><span class="sxs-lookup"><span data-stu-id="ccaad-163">[Click the following image to expand it.]</span></span>

[![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image22.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image21.png)

### <a name="making-project-configuration-changes-to-the-webconfig-file-for-your-application"></a><span data-ttu-id="ccaad-164">アプリケーションの web.config ファイルに対するプロジェクト構成の変更</span><span class="sxs-lookup"><span data-stu-id="ccaad-164">Making project configuration changes to the Web.config file for your application</span></span>

<span data-ttu-id="ccaad-165">このセクションでは、インストールしたばかりの MySQL プロバイダーを使用するように Entity Framework を構成し、MySQL プロバイダーファクトリを登録して、Azure から接続文字列を追加します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-165">In this section you will configure the Entity Framework to use the MySQL provider that you just installed, register the MySQL provider factory, and add your connection string from Azure.</span></span>

> [!NOTE]
> <span data-ttu-id="ccaad-166">次の例には、MySql の特定のアセンブリバージョンが含まれています。</span><span class="sxs-lookup"><span data-stu-id="ccaad-166">The following examples contain a specific assembly version for MySql.Data.dll.</span></span> <span data-ttu-id="ccaad-167">アセンブリのバージョンが変更された場合は、正しいバージョンを使用して適切な構成設定を変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-167">If the assembly version changes, you will need to modify the appropriate configuration settings with the correct version.</span></span>

1. <span data-ttu-id="ccaad-168">Visual Studio 2013 でプロジェクトの web.config ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-168">Open the Web.config file for your project in Visual Studio 2013.</span></span>
2. <span data-ttu-id="ccaad-169">次の構成設定を見つけて、Entity Framework の既定のデータベースプロバイダーとファクトリを定義します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-169">Locate the following configuration settings, which define the default database provider and factory for the Entity Framework:</span></span>

    [!code-xml[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample1.xml)]
3. <span data-ttu-id="ccaad-170">これらの構成設定を次のように置き換えます。これにより、MySQL プロバイダーを使用するように Entity Framework が構成されます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-170">Replace those configuration settings with the following, which will configure the Entity Framework to use the MySQL provider:</span></span>

    [!code-xml[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample2.xml)]
4. <span data-ttu-id="ccaad-171">&lt;connectionStrings&gt; セクションを見つけ、次のコードに置き換えます。これにより、Azure でホストされている MySQL データベースの接続文字列が定義されます (providerName 値も元のものから変更されていることに注意してください)。</span><span class="sxs-lookup"><span data-stu-id="ccaad-171">Locate the &lt;connectionStrings&gt; section and replace it with the following code, which will define the connection string for your MySQL database that is hosted on Azure (note that providerName value has also been changed from the original):</span></span>

    [!code-xml[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample3.xml?highlight=3-4)]

### <a name="adding-custom-migrationhistory-context"></a><span data-ttu-id="ccaad-172">カスタム MigrationHistory コンテキストの追加</span><span class="sxs-lookup"><span data-stu-id="ccaad-172">Adding custom MigrationHistory context</span></span>

<span data-ttu-id="ccaad-173">Entity Framework Code First では、モデルの変更を追跡し、データベーススキーマと概念スキーマ間の一貫性を確保するために、 **MigrationHistory**テーブルを使用します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-173">Entity Framework Code First uses a **MigrationHistory** table to keep track of model changes and to ensure the consistency between the database schema and conceptual schema.</span></span> <span data-ttu-id="ccaad-174">ただし、このテーブルは、既定では、主キーが大きすぎるため、MySQL では機能しません。</span><span class="sxs-lookup"><span data-stu-id="ccaad-174">However, this table does not work for MySQL by default because the primary key is too large.</span></span> <span data-ttu-id="ccaad-175">この状況を解決するには、そのテーブルのキーサイズを縮小する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-175">To remedy this situation, you will need to shrink the key size for that table.</span></span> <span data-ttu-id="ccaad-176">そのためには、次の手順を実行してください。</span><span class="sxs-lookup"><span data-stu-id="ccaad-176">To do so, use the following steps:</span></span>

1. <span data-ttu-id="ccaad-177">このテーブルのスキーマ情報は、他の**dbcontext**として変更できる**履歴コンテキスト**でキャプチャされます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-177">The schema information for this table is captured in a **HistoryContext**, which can be modified as any other **DbContext**.</span></span> <span data-ttu-id="ccaad-178">これを行うには、 **MySqlHistoryContext.cs**という名前の新しいクラスファイルをプロジェクトに追加し、その内容を次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-178">To do so, add a new class file named **MySqlHistoryContext.cs** to the project, and replace its contents with the following code:</span></span>

    [!code-csharp[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample4.cs)]
2. <span data-ttu-id="ccaad-179">次に、既定の設定ではなく、変更された**履歴コンテキスト**を使用するように Entity Framework を構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-179">Next you will need to configure Entity Framework to use the modified **HistoryContext**, rather than default one.</span></span> <span data-ttu-id="ccaad-180">これは、コードベースの構成機能を利用して行うことができます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-180">This can be done by leveraging code-based configuration features.</span></span> <span data-ttu-id="ccaad-181">これを行うには、 **MySqlConfiguration.cs**という名前の新しいクラスファイルをプロジェクトに追加し、その内容を次のように置き換えます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-181">To do so, add new class file named **MySqlConfiguration.cs** to your project and replace its contents with:</span></span>

    [!code-csharp[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample5.cs)]

### <a name="creating-a-custom-entityframework-initializer-for-applicationdbcontext"></a><span data-ttu-id="ccaad-182">ApplicationDbContext のカスタム EntityFramework 初期化子を作成しています</span><span class="sxs-lookup"><span data-stu-id="ccaad-182">Creating a custom EntityFramework initializer for ApplicationDbContext</span></span>

<span data-ttu-id="ccaad-183">このチュートリアルで紹介されている MySQL プロバイダーは、現在 Entity Framework の移行をサポートしていません。そのため、データベースに接続するには、モデル初期化子を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-183">The MySQL provider that is featured in this tutorial does not currently support Entity Framework migrations, so you will need to use model initializers in order to connect to the database.</span></span> <span data-ttu-id="ccaad-184">このチュートリアルでは Azure で MySQL インスタンスを使用しているため、カスタム Entity Framework 初期化子を作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-184">Because this tutorial is using a MySQL instance on Azure, you will need to create a custom Entity Framework initializer.</span></span>

> [!NOTE]
> <span data-ttu-id="ccaad-185">Azure 上の SQL Server インスタンスに接続している場合や、オンプレミスでホストされているデータベースを使用している場合は、この手順は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="ccaad-185">This step is not required if you are connecting to a SQL Server instance on Azure or if you are using a database that is hosted on premises.</span></span>

<span data-ttu-id="ccaad-186">MySQL のカスタム Entity Framework 初期化子を作成するには、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="ccaad-186">To create a custom Entity Framework initializer for MySQL, use the following steps:</span></span>

1. <span data-ttu-id="ccaad-187">**MySqlInitializer.cs**という名前の新しいクラスファイルをプロジェクトに追加し、その内容を次のコードに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-187">Add a new class file named **MySqlInitializer.cs** to the project, and replace it's contents with the following code:</span></span>

    [!code-csharp[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample6.cs?highlight=23)]
2. <span data-ttu-id="ccaad-188">**[モデル]** ディレクトリにあるプロジェクトの**IdentityModels.cs**ファイルを開き、その内容を次のように置き換えます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-188">Open the **IdentityModels.cs** file for your project, which is located in the **Models** directory, and replace it's contents with the following:</span></span>

    [!code-csharp[Main](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/samples/sample7.cs)]

## <a name="running-the-application-and-verifying-the-database"></a><span data-ttu-id="ccaad-189">アプリケーションを実行してデータベースを確認する</span><span class="sxs-lookup"><span data-stu-id="ccaad-189">Running the application and verifying the database</span></span>

<span data-ttu-id="ccaad-190">前のセクションの手順を完了したら、データベースをテストする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccaad-190">Once you have completed the steps in the preceding sections, you should test your database.</span></span> <span data-ttu-id="ccaad-191">そのためには、次の手順を実行してください。</span><span class="sxs-lookup"><span data-stu-id="ccaad-191">To do so, use the following steps:</span></span>

1. <span data-ttu-id="ccaad-192">Ctrl キーを押し**ながら F5**キーを押して、web アプリケーションをビルドして実行します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-192">Press **Ctrl + F5** to build and run the web application.</span></span>
2. <span data-ttu-id="ccaad-193">ページの上部にある **[登録]** タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-193">Click the **Register** tab on the top of the page:</span></span>

   <span data-ttu-id="ccaad-194">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-194">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-195">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image4.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image3.jpg)</span><span class="sxs-lookup"><span data-stu-id="ccaad-195">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image4.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image3.jpg)</span></span>
3. <span data-ttu-id="ccaad-196">新しいユーザー名とパスワードを入力し、[Register] \ (**登録**\) をクリックします。</span><span class="sxs-lookup"><span data-stu-id="ccaad-196">Enter a new user name and password, and then click **Register**:</span></span>

   <span data-ttu-id="ccaad-197">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-197">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-198">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image24.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-198">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image24.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image23.png)</span></span>
4. <span data-ttu-id="ccaad-199">この時点で、ASP.NET Identity テーブルが MySQL データベースに作成され、ユーザーが登録されてアプリケーションにログインされます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-199">At this point the ASP.NET Identity tables are created on the MySQL Database, and the user is registered and logged into the application:</span></span>

   <span data-ttu-id="ccaad-200">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-200">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-201">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image6.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image5.jpg)</span><span class="sxs-lookup"><span data-stu-id="ccaad-201">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image6.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image5.jpg)</span></span>

### <a name="installing-mysql-workbench-tool-to-verify-the-data"></a><span data-ttu-id="ccaad-202">MySQL ワークベンチツールをインストールしてデータを検証する</span><span class="sxs-lookup"><span data-stu-id="ccaad-202">Installing MySQL Workbench tool to verify the data</span></span>

1. <span data-ttu-id="ccaad-203">Mysql の[ダウンロードページ](http://dev.mysql.com/downloads/windows/installer/)から**mysql ワークベンチ**ツールをインストールする</span><span class="sxs-lookup"><span data-stu-id="ccaad-203">Install the **MySQL Workbench** tool from the [MySQL downloads page](http://dev.mysql.com/downloads/windows/installer/)</span></span>
2. <span data-ttu-id="ccaad-204">インストールウィザードの **[機能の選択]** タブで、 **[アプリケーション]** セクションの **[MySQL ワークベンチ]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-204">In the installation wizard: **Feature Selection** tab, select **MySQL Workbench** under **applications** section.</span></span>
3. <span data-ttu-id="ccaad-205">このチュートリアルの懇願で作成した Azure MySQL データベースの接続文字列データを使用して、アプリを起動し、新しい接続を追加します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-205">Launch the app and add a new connection using the connection string data from the Azure MySQL database you created at the begging of this tutorial.</span></span>
4. <span data-ttu-id="ccaad-206">接続を確立した後、**識別子 Tymysqldatabase**で作成された**ASP.NET Identity**テーブルを調べます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-206">After establishing the connection, inspect the **ASP.NET Identity** tables created on the **IdentityMySQLDatabase.**</span></span>
5. <span data-ttu-id="ccaad-207">次の図に示すように、すべての ASP.NET Identity 必要なテーブルが作成されます。</span><span class="sxs-lookup"><span data-stu-id="ccaad-207">You will see that all ASP.NET Identity required tables are created as shown in the image below:</span></span>

   <span data-ttu-id="ccaad-208">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-208">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-209">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image8.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image7.jpg)</span><span class="sxs-lookup"><span data-stu-id="ccaad-209">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image8.jpg)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image7.jpg)</span></span>
6. <span data-ttu-id="ccaad-210">インスタンスの**aspnetusers**テーブルを調べて、新しいユーザーを登録するときにエントリがあるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-210">Inspect the **aspnetusers** table for instance to check for the entries as you register new users.</span></span>

   <span data-ttu-id="ccaad-211">[次の画像をクリックして展開します。</span><span class="sxs-lookup"><span data-stu-id="ccaad-211">[Click the following image to expand it.</span></span> <span data-ttu-id="ccaad-212">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image26.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="ccaad-212">] [![](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image26.png)](aspnet-identity-using-mysql-storage-with-an-entityframework-mysql-provider/_static/image25.png)</span></span>
